<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting the character LCD to the board from WD MyBook Live on AppliedMicro APM82181. Ending</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! Let's continue working with the NAS WesternDigital MyBook Live board and the LCD indicator connected to it. So, in the previous part, we fou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting the character LCD to the board from WD MyBook Live on AppliedMicro APM82181. Ending</h1><div class="post__text post__text-html js-mediator-article">  Good day!  Let's continue working with the NAS WesternDigital MyBook Live board and the LCD indicator connected to it.  So, in the previous part, we found a place on the board to connect to the I2C bus, connected a port expander with an indicator, made sure everything worked.  Today we will display the status of the system. <br><table><tbody><tr><td><img src="https://habrastorage.org/files/3d6/41a/718/3d641a718dd04cd8bf2569f25726499d.gif" alt="image"><br></td><td><img src="https://habrastorage.org/files/3e9/ae6/4fc/3e9ae64fcb1f429aaec4bbca9d9728dd.jpg" alt="image"></td></tr></tbody></table><a name="habracut"></a>  The beginning was here: <a href="https://habrahabr.ru/post/315912/">Connecting a character LCD to the WD MyBook Live board on AppliedMicro APM82181</a> <br><br>  Content of the first part: <br><br><blockquote>  1. Connecting the console <br>  2. Boot without disk <br>  3. Compile in LEDE <br>  4. Port management (via LuCI and console) <br>  5. Connection to the I2C bus <br>  6. Connecting the PCF8574 port extender </blockquote><br>  Today we consider: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  7. Initializing HD44780 via i2cset <br>  8. Character device for writing data to the I2C bus <br>  9. Adding HD44780 driver to the kernel <br>  10. Adding processing of necessary VT100 commands to HD44780 driver <br>  11. Adding a display with some VT100 commands to LCD4Linux <br>  12. Adding a character generator programming command to the HD44780 driver <br>  13. Optimization of data transmission on the I2C bus </blockquote><br>  As before, additions and comments are welcome. <br><br>  So, by this moment the port extender is connected to the system, which we can control.  A symbol LCD indicator on the clone of the HD44780 controller is attached to the expander.  Theoretically, we can manage it by turning on all the ports on the output and knowing their purpose.  It was already possible to flash the backlight, pulling the third port. <br><br><h4>  7. Initializing HD44780 via i2cset </h4><br>  The connection between the HD44780 controller and the port expander is organized as follows: <br><br><blockquote>  RS - P0 <br>  R / W - P1 <br>  E - P2 <br>  BL - P3 <br>  D4 - P4 <br>  D5 - P5 <br>  D6 - P6 <br>  D7 - P7 </blockquote><br>  This is one of the meeting options.  The controller is translated and operates in 4-bit mode, and the byte is transmitted in parts. <br><br>  Having all the ports of the expander available, it is possible to output data to it bit by bit and thus control the display.  I think you will agree that this is not very convenient. <br><br>  Let's try to directly control via the I2C bus.  A simple option to test this possibility is to use the I2C-tools toolkit.  In LEDE, they are in the Utilites section.  The set includes i2cdetect, i2cdump, i2cget, i2cset.  We are interested in the latter and a little first (for diagnostics). <br><br>  Using i2cdetect, you can detect devices connected to the bus and determine their address. <br><br><div class="spoiler">  <b class="spoiler_title">In our case, only the address 0x27 is occupied:</b> <div class="spoiler_text"><pre><code class="bash hljs">root@lede: i2cdetect 0 WARNING! This program can confuse your I2C bus, cause data loss and worse! I will probe file /dev/i2c-0. I will probe address range 0x03-0x77. Continue? [Y/n] y 0 1 2 3 4 5 6 7 8 9 abcdef 00: -- -- -- -- -- -- -- -- -- -- -- -- -- 10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 20: -- -- -- -- -- -- -- 27 -- -- -- -- -- -- -- -- 30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 70: -- -- -- -- -- -- -- --</code> </pre> <br></div></div><br>  The i2cset utility is used to output data to a device with a given address on the I2C bus. <br>  Knowing the initialization sequence for your LCD, you can easily perform it and display characters on the screen. <br><br>  In order not to reinvent the wheel, I recommend downloading it from here: <a href="http://cyber-place.ru/showthread.php%3Ft%3D2164">I2C hd44780 module on PCF8574 expander</a> "i2c lcd testilku".  Here is the <a href="http://cyber-place.ru/showpost.php%3Fp%3D30991%26postcount%3D13">direct link</a> .  Inside the archive is a shell script that works with the indicator via the i2cset command and displays the characters alternately on the screen.  The only thing to use is to comment or delete the lines at the beginning of the file: <br><br><pre> <code class="bash hljs">insmod i2c-dev insmod i2c-gpio-custom bus0=0,<span class="hljs-variable"><span class="hljs-variable">$sda_gpio</span></span>,<span class="hljs-variable"><span class="hljs-variable">$scl_gpio</span></span></code> </pre><br>  They create the I2C software port on any free I / O ports, and we already have a hardware one.  Well, and besides, it is designed for an indicator with a dimension of 4 * 40, but to test the functionality and understanding of the use of the i2cset utility, this does not hurt much. <br><br>  Result: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7c4/f1d/96a/7c4f1d96a344490993aa54b0112cfa39.jpg" alt="image"></div><br>  A little explanation on its implementation.  The write_CMD and print_LCD procedures display, respectively, a command or data on the indicator.  It depends on the RS signal, which in our case is on the zero bit. <br><br>  The init_LCD procedure sequentially issues commands to initialize the indicator according to its datasheet widely used on the Internet.  For example, <a href="http://datasheet-pdf.com/datasheet-download.php%3Fid%3D507176">here</a> .  Further on, various symbols are displayed on the screen. <br><br><h4>  8. Character device for writing data to the I2C bus </h4><br>  Everything is fine, but I would like to get away from using utilities, and to have a character device, bringing to which bytes, they would fall directly on the I2C bus, of course, with a given address. <br><br>  Unfortunately, I could not find such a driver for the I2C bus in LEDE.  Therefore, with experimental objectives, it was decided to remake one of the existing ones.  It is clear that if you want to use it further, it was necessary not to redo it, but at least create a new one on its basis. <br><br>  EEPROM driver for I2C bus turned out to be suitable for experiments.  The kmod-eeprom-at24 driver was connected to the LEDE core. After updating the system, an attempt was made to add a device: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 24c00 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 24c00 0x27 &gt; [ 33.335472] at24 0-0027: 16 byte 24c00 EEPROM, writable, 1 bytes/write [ 33.342102] i2c i2c-0: new_device: Instantiated device 24c00 at 0x27</code> </pre><br>  Successfully connected.  Now, if you bring something to the device: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"1111"</span></span> &gt; /sys/bus/i2c/devices/i2c-0/0-0027/eeprom</code> </pre> <br>  then on the bus we will see the following sequence of bytes: <br><br><pre> <code class="hljs">0x4e-0x00-0x31 0x4e-0x01-0x31 0x4e-0x02-0x31 0x4e-0x03-0x31 0x4e-0x04-0x0a</code> </pre> <br>  The first byte in each triple is the device address, multiplied by 2 (0x27 x 2).  The second is the cell address in the EEPROM, the third is the data.  The driver is quite suitable for transferring data to the LCD, with the exception of issuing a cell address. <br><br>  To remove this, we fix the driver build_dir / target-powerpc_464fp_musl-1.1.15 / linux-apm821xx_sata / linux-4.4.21 / drivers / misc / eeprom / at24.c driver file.  Comment out a few lines in the at24_eeprom_write (335-337) procedure: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//if (at24-&gt;chip.flags &amp; AT24_FLAG_ADDR16) // msg.buf[i++] = offset &gt;&gt; 8; //msg.buf[i++] = offset;</span></span></code> </pre> <br>  Compile-update, add device, view output <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 24c00 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device [ 2708.782356] at24 0-0027: 16 byte 24c00 EEPROM, writable, 1 bytes/write [ 2708.788891] i2c i2c-0: new_device: Instantiated device 24c00 at 0x27 root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"1111"</span></span> &gt; /sys/bus/i2c/devices/i2c-0/0-0027/eeprom</code> </pre><br>  That's right, output without a cell address, just what we need: <br><br><img src="https://habrastorage.org/files/8ab/156/bf7/8ab156bf7ef742ca994c56719bdacd48.jpg" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Now you can remake the test program by removing the i2cset utility call from there:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh i2c_adres=0x27 i2c_dev=/sys/bus/i2c/devices/i2c-0/0-0027/eeprom led=8 ansi=0 to_octal () { hh3=$(($hh / 64)) hh1=$(($hh - $hh3 * 64)) hh2=$(($hh1 / 8)) hh1=$(($hh1 - $hh2 * 8)) } write_CMD () { : $((hb = $c &amp; 240)) : $((lb = ($c &lt;&lt; 4) &amp; 240 )) hh=$((4 + $hb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((0 + $hb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((4 + $lb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((0 + $lb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev } print_LCD () { : $((hb = $c &amp; 240)) : $((lb = ($c &lt;&lt; 4) &amp; 240 )) hh=$((5 + $hb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((1 + $hb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((5 + $lb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev hh=$((1 + $lb + $led)) to_octal echo -e -n \\$hh3$hh2$hh1 &gt;&gt; $i2c_dev } ########## init LCD ##################### init_LCD () { if [[ ! -w $i2c_dev ]] then echo 24c00 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device sleep 0.5 fi sleep 0.5 c=3 write_CMD c=3 write_CMD c=2 write_CMD c=40 #28 write_CMD c=44 #2C write_CMD c=44 #2C write_CMD c=12 #0C write_CMD c=1 write_CMD sleep 0.2 c=6 write_CMD c=2 write_CMD } ############################### init_LCD c=0x80 # stroka - 1 write_CMD for i in `seq 32 63`; do if [ "$i" == 48 ]; then c=0xC0 # stroka - 2 write_CMD fi c=$(($i + $ansi)) print_LCD done sleep 3 c=0x80 # stroka - 1 write_CMD for i in `seq 64 95`; do if [ "$i" == 80 ]; then c=0xC0 # stroka - 2 write_CMD fi c=$(($i + $ansi)) print_LCD done sleep 3 c=0x80 # stroka - 1 write_CMD for i in `seq 96 127`; do if [ "$i" == 112 ]; then c=0xC0 # stroka - 2 write_CMD fi c=$(($i + $ansi)) print_LCD done</span></span></code> </pre><br></div></div><br>  At the same time, now the program is designed only for our screen geometry - 2x16 characters.  It is clear that changing the source in the build_dir directory, we should expect that in the near future the file will be restored from the original packages during the build.  To create permanent fixes, you should use the possibility of applying patches at the assembly stage. <br><br><h4>  9. Adding HD44780 driver to the kernel </h4><br>  After examining the issue of the performance of this LCD connection option, it was decided to try to assign some functionality to the indicator.  For example, displaying some part of the state of the operating system. <br><br>  Such a package already exists and is even included in LEDE.  This is <a href="https://lcd4linux.bulix.org/wiki">LCD4Linux</a> .  It allows you to get the necessary information about the components of the OS and place it on the indicator in the right place.  Naturally, the update in real time. <br><br>  However, using it with our indicator on the I2C bus caused some difficulties. <br>  Display connection on HD44780-I2C from LCD4Linux kit <br><br><div class="spoiler">  <b class="spoiler_title">in the file \ etc \ lcd4linux.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">Display HD44780-I2C { Driver <span class="hljs-string"><span class="hljs-string">'HD44780'</span></span> Model <span class="hljs-string"><span class="hljs-string">'generic'</span></span> Bus <span class="hljs-string"><span class="hljs-string">'i2c'</span></span> Port <span class="hljs-string"><span class="hljs-string">'/dev/i2c-0'</span></span> Device <span class="hljs-string"><span class="hljs-string">'0x27'</span></span> Bits <span class="hljs-string"><span class="hljs-string">'4'</span></span> Size <span class="hljs-string"><span class="hljs-string">'16x2'</span></span> asc255bug 0 Icons 1 Wire { RW <span class="hljs-string"><span class="hljs-string">'DB1'</span></span> RS <span class="hljs-string"><span class="hljs-string">'DB0'</span></span> ENABLE <span class="hljs-string"><span class="hljs-string">'DB2'</span></span> GPO <span class="hljs-string"><span class="hljs-string">'GND'</span></span> } }</code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">caused an error:</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@lede: /usr/bin/lcd4linux -v -F LCD4Linux 0.11.0-SVN-1193 starting HD44780: <span class="hljs-variable"><span class="hljs-variable">$Rev</span></span>: 1202 $ HD44780: using model <span class="hljs-string"><span class="hljs-string">'generic'</span></span> HD44780: using I2C bus HD44780: using 1 Controller(s) HD44780: using 4 bit mode udelay: using gettimeofday() delay loop Segmentation fault</code> </pre> <br></div></div><br>  Almost all possible displays from the package were also tried, including the use of a character device based on the EEPROM driver made in the previous chapter.  It did not work. <br><br>  Then it was decided to go another way.  Add the driver of this indicator to the system, accepting symbols and control commands for display, and then add a new display using this driver in LCD4Linux, since it has a manual for this. <br><br>  So, we take the ready driver for the HD44780 on the I2C from here: <a href="https://github.com/gorskima/hd44780-i2c">Linux driver for Hitachi HD44780 LCD through I / O bus via PCF8574 I / O expander</a> .  The driver was tested on the Raspberry Pi, understands a couple of control commands of the VT100 terminal, is configured for different indicator geometry, and is able to display, extinguish and blink with the cursor.  It remains to integrate it into LEDE and slightly modify it. <br>  Download, unpack in the package / hd44780 / src folder. <br><br><div class="spoiler">  <b class="spoiler_title">Tree</b> <div class="spoiler_text"><pre> <code class="bash hljs">ls -l -rw-r--r-- 1 root root 18092 Feb 21 2016 LICENSE -rw-r--r-- 1 root root 60 Nov 9 06:17 Makefile -rw-r--r-- 1 root root 1945 Feb 21 2016 README.md -rw-r--r-- 1 root root 10316 Nov 16 04:33 hd44780-dev.c -rw-r--r-- 1 root root 7756 Feb 21 2016 hd44780-i2c.c -rw-r--r-- 1 root root 1122 Nov 16 03:28 hd44780.h -rw-r--r-- 1 root root 235 Feb 21 2016 make.sh</code> </pre> <br></div></div><br>  Leaving in the Makefile only this: <br><br><pre> <code class="hljs go">obj-m := hd44780.o hd44780-y := hd44780-i2c.o hd44780-dev.o</code> </pre> <br>  And we create a new Makefile, only the folder above, in package / hd44780, by analogy with files in other LEDE packages: <br><br><div class="spoiler">  <b class="spoiler_title">package / hd44780 / Makefile</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(TOPDIR)/rules.mk <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(INCLUDE_DIR)/kernel.mk <span class="hljs-symbol"><span class="hljs-symbol">PKG_NAME:</span></span>=hd4478<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">PKG_RELEASE:</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> PKG_BUILD_DIR <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(BUILD_DIR)/$(PKG_NAME) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(INCLUDE_DIR)/package.mk define KernelPackage/hd4478<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">SUBMENU:</span></span>=Other modules <span class="hljs-symbol"><span class="hljs-symbol">TITLE:</span></span>=I2C HD4478<span class="hljs-number"><span class="hljs-number">0</span></span> driver <span class="hljs-symbol"><span class="hljs-symbol">FILES:</span></span>=$(PKG_BUILD_DIR)/hd4478<span class="hljs-number"><span class="hljs-number">0</span></span>.ko <span class="hljs-symbol"><span class="hljs-symbol">AUTOLOAD:</span></span>=$(call AutoLoad,<span class="hljs-number"><span class="hljs-number">70</span></span>,hd4478<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">KCONFIG:</span></span>= endef define Package/hd4478<span class="hljs-number"><span class="hljs-number">0</span></span>/description Big comments.... ... endef <span class="hljs-symbol"><span class="hljs-symbol">MAKE_OPTS:</span></span>= \ ARCH=<span class="hljs-string"><span class="hljs-string">"$(LINUX_KARCH)"</span></span> \ CROSS_COMPILE=<span class="hljs-string"><span class="hljs-string">"$(TARGET_CROSS)"</span></span> \ SUBDIRS=<span class="hljs-string"><span class="hljs-string">"$(PKG_BUILD_DIR)"</span></span> \ EXTRA_CFLAGS=<span class="hljs-string"><span class="hljs-string">"$(EXTRA_CFLAGS)"</span></span> define Build/Prepare mkdir -p $(PKG_BUILD_DIR) $(CP) ./src/* $(PKG_BUILD_DIR)/ endef define Build/Compile $(MAKE) -C <span class="hljs-string"><span class="hljs-string">"$(LINUX_DIR)"</span></span> \ $(MAKE_OPTS) \ modules endef $(eval $(call KernelPackage,hd4478<span class="hljs-number"><span class="hljs-number">0</span></span>))</code> </pre> <br></div></div><br>  You can add a startup string (AUTOLOAD: = $ (call AutoLoad, 70, hd44780)) later when the driver is tested.  Now when calling the configurator LEDE <br><br><pre> <code class="bash hljs">make menuconfig</code> </pre> <br>  The driver will appear in the kernel modules (kmod-hd44780), and you can add it to the configuration: <br><br><div class="spoiler">  <b class="spoiler_title">LEDE Configuration</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/182/5b8/9fb/1825b89fbb3b403faa4e9c1f45f4f20b.jpg" alt="image"><br></div></div><br>  After compiling, updating and reloading, if the autoloading of the module is not enabled, then we try to load, see the result: <br><br><pre> <code class="bash hljs">root@lede: insmod hd44780 root@lede: lsmod |grep 44780 hd44780 5450 0</code> </pre><br>  We try to add a device: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> hd44780 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device [ 9463.913178] i2c i2c-0: new_device: Instantiated device hd44780 at 0x27</code> </pre> <br>  On the indicator, as laid down in the driver, when initialized, the address of the created device is issued: "/ dev / lcd0", with a flashing cursor at the end. <br><br>  On this device, you can send characters that will be displayed on the indicator: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n 123 &gt; /dev/lcd0</code> </pre> <br>  You can also control the operating modes via sysfs (/ sys / class / hd44780 / lcd0).  This path has the following file names: backlight, cursor_display, geometry, cursor_blink.  Through them you can customize the geometry of the screen, control the cursor modes and backlight.  For example, to turn off the flashing cursor, just give the command <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n 0 &gt; /sys/class/hd44780/lcd0/cursor_blink</code> </pre> <br>  In addition, two VT100 terminal commands are supported, this is clearing the screen and setting the cursor to the starting position.  You can submit them as follows: <br><br><pre> <code class="bash hljs">root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n -e <span class="hljs-string"><span class="hljs-string">'\x1b'</span></span>[2J &gt; /dev/lcd0 root@lede: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n -e <span class="hljs-string"><span class="hljs-string">'\x1b'</span></span>[H &gt; /dev/lcd0</code> </pre> <br>  Installation of the necessary modes can also be made when booting the OS.  To do this, add the file target / linux / apm821xx / base-files / etc / board.d / 03_lcd to LEDE with the contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo hd44780 0x27 &gt; /sys/bus/i2c/devices/i2c-0/new_device echo -n 16x2 &gt; /sys/class/hd44780/lcd0/geometry echo -n 0 &gt; /sys/class/hd44780/lcd0/cursor_display echo -n 0 &gt; /sys/class/hd44780/lcd0/cursor_blink echo -n -e '\x1b'[2JHello! &gt; /dev/lcd0 exit 0</span></span></code> </pre><br>  Now the board will greet you every time you boot the system. <br><br><h4>  10. Adding processing of necessary VT100 commands to HD44780 driver </h4><br>  So, the driver works, but for use in LCD4Linux it must be able to place characters in any position on the screen.  According to the list of terminal commands, select the desired one: <br><br>  <i>Esc [Line; ColumnH - Move cursor to screen location v, h</i> <br><br>  Find the package / hd44780 / src / hd44780-dev.c file and add detection and execution of a new command.  It is necessary to refine the procedure for processing esc-sequences: <br><br><div class="spoiler">  <b class="spoiler_title">Original:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_handle_esc_seq_char</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prev_row, prev_col; lcd-&gt;esc_seq_buf.buf[lcd-&gt;esc_seq_buf.length++] = ch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[2J"</span></span>)) { prev_row = lcd-&gt;pos.row; prev_col = lcd-&gt;pos.col; hd44780_clear_display(lcd); hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (lcd-&gt;geometry-&gt;start_addrs[prev_row] + prev_col)); hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[H"</span></span>)) { hd44780_write_instruction(lcd, HD44780_RETURN_HOME); lcd-&gt;pos.row = <span class="hljs-number"><span class="hljs-number">0</span></span>; lcd-&gt;pos.col = <span class="hljs-number"><span class="hljs-number">0</span></span>; hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lcd-&gt;esc_seq_buf.length == ESC_SEQ_BUF_SIZE) { hd44780_flush_esc_seq(lcd); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Modified version:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_handle_esc_seq_char</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prev_row, prev_col; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hd44780_geometry</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geo</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lcd</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class">;</span></span> lcd-&gt;esc_seq_buf.buf[lcd-&gt;esc_seq_buf.length++] = ch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[2J"</span></span>)) { prev_row = lcd-&gt;pos.row; prev_col = lcd-&gt;pos.col; hd44780_clear_display(lcd); hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (lcd-&gt;geometry-&gt;start_addrs[prev_row] + prev_col)); hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[H"</span></span>)) { hd44780_write_instruction(lcd, HD44780_RETURN_HOME); lcd-&gt;pos.row = <span class="hljs-number"><span class="hljs-number">0</span></span>; lcd-&gt;pos.col = <span class="hljs-number"><span class="hljs-number">0</span></span>; hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((lcd-&gt;esc_seq_buf.buf[<span class="hljs-number"><span class="hljs-number">0</span></span>]==<span class="hljs-string"><span class="hljs-string">'['</span></span>) &amp;&amp; (lcd-&gt;esc_seq_buf.buf[<span class="hljs-number"><span class="hljs-number">4</span></span>]==<span class="hljs-string"><span class="hljs-string">'H'</span></span>) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// Esc[ Line ; Column H (lcd-&gt;esc_seq_buf.buf[2]==';' ) &amp;&amp; (lcd-&gt;esc_seq_buf.length == 5)) { lcd-&gt;pos.row = lcd-&gt;esc_seq_buf.buf[1] % geo-&gt;rows; lcd-&gt;pos.col = lcd-&gt;esc_seq_buf.buf[3] % geo-&gt;cols; hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (geo-&gt;start_addrs[lcd-&gt;pos.row] + lcd-&gt;pos.col)); hd44780_leave_esc_seq(lcd); } else if (lcd-&gt;esc_seq_buf.length == ESC_SEQ_BUF_SIZE) { hd44780_flush_esc_seq(lcd); } }</span></span></code> </pre> </div></div><br>  And it is necessary to change the length of the buffer for accumulation and analysis of esc-sequences.  Find the line in the hd44780.h file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ESC_SEQ_BUF_SIZE 4</span></span></code> </pre> <br>  And correct the value from 4 to 6. You can compile and check.  Only one package from LEDE can be compiled. <br><br><pre> <code class="bash hljs">root@debian:/apm82181-lede-master<span class="hljs-comment"><span class="hljs-comment"># make package/hd44780/compile make[1] package/hd44780/compile make[2] -C package/hd44780 compile</span></span></code> </pre> <br>  If there are no errors, then compile the whole project, update, reboot.  Checking: <br><br><pre> <code class="bash hljs">root@lede:/ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n -e <span class="hljs-string"><span class="hljs-string">'\x1b[1;6H'</span></span> &gt; /dev/lcd0</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The cursor moves to the second line and 7th position (numbering from scratch):</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/482/05b/f52/48205bf52bd34c008b9c89ef9a23a443.jpg" alt="image"></div></div><br><br><h4>  11. Adding a display with some VT100 commands to LCD4Linux </h4><br>  The LCD driver performs its functionality.  Now it can be used in the LCD4Linux package to display the system status.  However, I did not find a display in it that works with the driver using the terminal protocol. <br><br>  So we write our own.  According to the instructions <a href="https://lcd4linux.bulix.org/wiki/driver_howto">How to write new display drivers</a> . <br>  Source files can be taken in the build_dir / target-powerpc_464fp_musl-1.1.15 / lcd4linux-custom / lcd4linux-r1203 directory, or from the dl / lcd4linux-r1203.tar.bz2 package. <br><br>  Just like in the manual: <br><br><ol><li>  From the drv_Sample.c file, drv make a copy of drv_vt100.c </li><li>  Edit drv_vt100.c, delete everything related to the graphics mode, with GPIO </li><li>  Add new driver to drv.c </li><li>  Add to Makefile.am <br><br></li><li><div class="spoiler">  <b class="spoiler_title">Add to drivers.m4</b> <div class="spoiler_text"><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$VT100</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"yes"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> TEXT=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> I2C=<span class="hljs-string"><span class="hljs-string">"yes"</span></span> DRIVERS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DRIVERS</span></span></span><span class="hljs-string"> drv_vt100.o"</span></span> AC_DEFINE(WITH_VT100,1,[vt100 driver]) <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> </div></div><br></li><li>  Add to Makefile.am </li></ol><br>  Next, we write our procedures in the drv_vt100.c file. <br><br><div class="spoiler">  <b class="spoiler_title">drv_vt100_open:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv_vt100_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *section)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> f = <span class="hljs-number"><span class="hljs-number">-1</span></span>; s = cfg_get(section, <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || *s == <span class="hljs-string"><span class="hljs-string">'\0'</span></span> || <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(s) &gt; <span class="hljs-number"><span class="hljs-number">80</span></span>) { error(<span class="hljs-string"><span class="hljs-string">"%s: no '%s.Port' entry from %s"</span></span>, Name, section, cfg_source()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(Port, s); f = open(Port, O_WRONLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { error(<span class="hljs-string"><span class="hljs-string">"open(%s) failed: %s"</span></span>, Port, strerror(errno)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } close (f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">drv_vt100_send:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv_vt100_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> f; f = open(Port, O_WRONLY); write (f, data, len); close (f); }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">drv_vt100_clear:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv_vt100_clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cmd[<span class="hljs-number"><span class="hljs-number">4</span></span>]; cmd[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1B</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ESC cmd[1] = '['; // [ cmd[2] = '2'; // 2 cmd[3] = 'J'; // J drv_vt100_send(cmd, 4); cmd[2] = 'H'; // H drv_vt100_send(cmd, 3); }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">drv_vt100_write:</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv_vt100_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> col, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cmd[<span class="hljs-number"><span class="hljs-number">6</span></span>]; cmd[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1B</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ESC cmd[1] = '['; // [ cmd[2] = row &amp; 0xff; // Line cmd[3] = ';'; // ; cmd[4] = col &amp; 0xff; // Column cmd[5] = 'H'; // H drv_vt100_send(cmd, 6); }</span></span></code> </pre> </div></div><br>  drv_vt100_close leave empty. <br><br>  We edit and create files in a separate folder from the LEDE project.  Then, since the LCD4linux files are updated from the archive when the project is compiled, changing them in the build_dir / ... folder is pointless.  It is necessary to use the opportunity to apply patches.  The patches for LCD4Linux are located in the feeds / packages / utils / lcd4linux / patches folder.  You need to place your own, adding a new VT100 display driver right there. <br><br>  To create a patch, we make next two folders.  In one (let 1 /) we place original files, in another (let 2 /) the same, but changed.  Then run the diff command: <br><br><pre> <code class="bash hljs">diff -Naur ./1 ./2 &gt; 180-vt100.patch</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">As a result, we have a file 180-vt100.patch with approximately the following content:</b> <div class="spoiler_text"><pre> <code class="diff hljs">diff -Naur ./vt100/Makefile.am ./vt100-f/Makefile.am --- ./vt100/Makefile.am 2016-11-28 11:01:56.000000000 +0000 +++ ./vt100-f/Makefile.am 2016-11-14 07:33:41.000000000 +0000 @@ -125,6 +125,7 @@ drv_USBHUB.c \ drv_USBLCD.c \ drv_vnc.c \ +drv_vt100.c \ drv_WincorNixdorf.c \ drv_X11.c \ \ diff -Naur ./vt100/drivers.m4 ./vt100-f/drivers.m4 --- ./vt100/drivers.m4 2016-11-14 11:54:41.000000000 +0000 +++ ./vt100-f/drivers.m4 2016-11-14 07:37:00.000000000 +0000 @@ -39,7 +39,7 @@ [ Newhaven, Noritake, NULL, Pertelian, PHAnderson,] [ PICGraphic, picoLCD, picoLCDGraphic, PNG, PPM, RouterBoard,] [ Sample, SamsungSPF, serdisplib, ShuttleVFD, SimpleLCD, st2205, T6963,] - [ TeakLCM, TEW673GRU, Trefon, ULA200, USBHUB, USBLCD, VNC, WincorNixdorf, X11], + [ TeakLCM, TEW673GRU, Trefon, ULA200, USBHUB, USBLCD, VNC, vt100, WincorNixdorf, X11], drivers=$withval, drivers=all ) @@ -114,6 +114,7 @@ USBHUB="yes" USBLCD="yes" VNC="yes" + VT100="yes" WINCORNIXDORF="yes" X11="yes" ;; @@ -279,6 +280,9 @@ VNC) VNC=$val ;; + vt100) + VT100=$val + ;; WincorNixdorf) WINCORNIXDORF=$val ;; @@ -869,6 +873,13 @@ fi fi +if test "$VT100" = "yes"; then + TEXT="yes" + I2C="yes" + DRIVERS="$DRIVERS drv_vt100.o" + AC_DEFINE(WITH_VT100,1,[vt100 driver]) +fi + if test "$WINCORNIXDORF" = "yes"; then TEXT="yes" SERIAL="yes"</code> </pre></div></div><br>  One patch is created for all files.  If you look at patches that are already in the feeds / packages / utils / lcd4linux / patches folder, there are no lines inside the files that show the ‚Äúdiff -Naur ...‚Äù command being executed.  We bring our patch in the same state and copy it to the folder. <br>  Go to the configurator LEDE. <br><br><div class="spoiler">  <b class="spoiler_title">We see the appearance of our display driver in LCD4Linuc-custom:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/7d3/25a/223/7d325a22352743a0adebc19acc57a5ed.jpg" alt="image"><br></div></div><br>  We include it in the project, save the settings, compile, update, reload.  We connect our driver in the configuration file: <br><br><div class="spoiler">  <b class="spoiler_title">lcd4linux.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">Variables { tick 500 tack 100 minute 60000 } Display VT100 { Driver <span class="hljs-string"><span class="hljs-string">'vt100'</span></span> Size <span class="hljs-string"><span class="hljs-string">'16x2'</span></span> Port <span class="hljs-string"><span class="hljs-string">'/dev/lcd0'</span></span> } Widget Test { class <span class="hljs-string"><span class="hljs-string">'Text'</span></span> expression <span class="hljs-string"><span class="hljs-string">'1234567890123456'</span></span> width 16 } Layout Test { Row01.Col1 <span class="hljs-string"><span class="hljs-string">'Test'</span></span> Row02.Col1 <span class="hljs-string"><span class="hljs-string">'Test'</span></span> } Display <span class="hljs-string"><span class="hljs-string">'VT100'</span></span> Layout <span class="hljs-string"><span class="hljs-string">'Test'</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Checking:</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@lede:/<span class="hljs-comment"><span class="hljs-comment"># /usr/bin/lcd4linux -v -F LCD4Linux 0.11.0-SVN-1193 starting vt100: $Rev: 001 $ initializing layout 'Test' Creating new timer group (1000 ms) widget 'Test': Class 'text', Parent '&lt;root&gt;', Layer 1, Row 0, Col 0 (to 0,16) widget 'Test': Class 'text', Parent 'Test', Layer 1, Row 1, Col 0 (to 1,16)</span></span></code> </pre> <br></div></div><br>  On the indicator, we see, as planned in the config, numbers. <br><br><img src="https://habrastorage.org/files/f74/e6c/89e/f74e6c89ec574df1be0753204ccc2baf.jpg" alt="image"><br><br><h4>  12. Adding character generator programming commands to HD44780 and VT100 drivers </h4><br>  The indicator based on the HD44780 controller has a wired Latin alphabet with numbers and signs and freely 8 programmable characters (there are sometimes Russian characters, but not in this case).  Changing the display of programmable characters you can get a simple animation.  Its variants are presented in the example of the LCD4Linux config, but as long as our drivers do not support this function, we cannot use them. <br><br>  There is nothing difficult in this, it‚Äôs necessary to take 8 bytes in one driver and send it to the character generator with the command, send them in the other. <br><br>  Fix again <br><div class="spoiler">  <b class="spoiler_title">hd44780_handle_esc_seq_char procedure in hd44780-dev.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_handle_esc_seq_char</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prev_row, prev_col; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hd44780_geometry</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geo</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lcd</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lcd-&gt;is_in_set_char == <span class="hljs-number"><span class="hljs-number">0</span></span>) { lcd-&gt;esc_seq_buf.buf[lcd-&gt;esc_seq_buf.length++] = ch; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[2J"</span></span>)) { prev_row = lcd-&gt;pos.row; prev_col = lcd-&gt;pos.col; hd44780_clear_display(lcd); hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (lcd-&gt;geometry-&gt;start_addrs[prev_row] + prev_col)); hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(lcd-&gt;esc_seq_buf.buf, <span class="hljs-string"><span class="hljs-string">"[H"</span></span>)) { hd44780_write_instruction(lcd, HD44780_RETURN_HOME); lcd-&gt;pos.row = <span class="hljs-number"><span class="hljs-number">0</span></span>; lcd-&gt;pos.col = <span class="hljs-number"><span class="hljs-number">0</span></span>; hd44780_leave_esc_seq(lcd); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((lcd-&gt;esc_seq_buf.buf[<span class="hljs-number"><span class="hljs-number">0</span></span>]==<span class="hljs-string"><span class="hljs-string">'['</span></span>) &amp;&amp; (lcd-&gt;esc_seq_buf.buf[<span class="hljs-number"><span class="hljs-number">4</span></span>]==<span class="hljs-string"><span class="hljs-string">'H'</span></span>) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// Esc[ Line ; Column H (lcd-&gt;esc_seq_buf.buf[2]==';' ) &amp;&amp; (lcd-&gt;esc_seq_buf.length == 5)) { lcd-&gt;pos.row = lcd-&gt;esc_seq_buf.buf[1] % geo-&gt;rows; lcd-&gt;pos.col = lcd-&gt;esc_seq_buf.buf[3] % geo-&gt;cols; hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (geo-&gt;start_addrs[lcd-&gt;pos.row] + lcd-&gt;pos.col)); hd44780_leave_esc_seq(lcd); } else if (!strcmp(lcd-&gt;esc_seq_buf.buf, "(S")) { // Esc(S code matrix(8) lcd-&gt;is_in_set_char = 1; } else if (lcd-&gt;esc_seq_buf.length == ESC_SEQ_BUF_SIZE) { hd44780_flush_esc_seq(lcd); } } else if (lcd-&gt;is_in_set_char == 1) { // start set CGRAM code hd44780_write_instruction(lcd, HD44780_CGRAM_ADDR | 8 * (ch &amp; 0x07)); lcd-&gt;is_in_set_char++; } else { hd44780_write_data(lcd, ch &amp; 0x1f); // set 8 bytes CGRAM code lcd-&gt;is_in_set_char++; if (lcd-&gt;is_in_set_char == 10){ // go to DDRAM mode hd44780_write_instruction(lcd, HD44780_DDRAM_ADDR | (geo-&gt;start_addrs[lcd-&gt;pos.row] + lcd-&gt;pos.col)); hd44780_leave_esc_seq(lcd); } } }</span></span></code> </pre> </div></div><br>  Add to it the mode of receiving 8 bytes of the character generator and writing them to CGRAM (character generator).  Since in VT100 I did not find the ESC-sequence of character programming, I had to think of something.  Let it be Esc (S 8 bytes, that is, the ESC code, then the opening parenthesis, the Latin letter S and 8 bytes of the matrix. In our case, if the familiarity size is 8 * 5, only 5 low bits of each byte will be used. <br><br>  In the hd44780_write procedure, add a reset to the character generator reception mode (line lcd-&gt; is_in_set_char = 0). <br><br><div class="spoiler">  <b class="spoiler_title">hd44780_write</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">case</span></span></span><span class="hljs-function"> '\e': lcd-&gt;is_in_esc_seq </span></span>= <span class="hljs-literal"><span class="hljs-literal">true</span></span>; lcd-&gt;is_in_set_char = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: hd44780_write_char(lcd, ch); ...</code> </pre></div></div><br>  And we describe this structure field (is_in_set_char) in the header file hd44780.h. <br><br><div class="spoiler">  <b class="spoiler_title">struct hd44780</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hd44780</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cdev</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cdev</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c_client</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c_client</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hd44780_geometry</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> col; } pos; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE]; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[ESC_SEQ_BUF_SIZE]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length; } esc_seq_buf; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_in_esc_seq; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> is_in_set_char; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> backlight; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> cursor_blink; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> cursor_display; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> dirty; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lock</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list_head</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">;</span></span> };</code> </pre> </div></div><br>  Now add this functionality to the LCD4Linux display driver.  The drv_vt100_defchar function of the drv_vt100.c file: <br><br><div class="spoiler">  <b class="spoiler_title">drv_vt100_defchar</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drv_vt100_defchar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ascii, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *matrix)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> cmd[<span class="hljs-number"><span class="hljs-number">12</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-comment"><span class="hljs-comment">/* call the 'define character' function */</span></span> cmd[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1B</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ESC cmd[1] = '('; // ( cmd[2] = 'S'; // S cmd[3] = ascii &amp; 0x07; // code /* send bitmap to the display */ for (i = 0; i &lt; 8; i++) { cmd[i + 4] = (*matrix++) &amp; 0x1f; } drv_vt100_send(cmd, 12); }</span></span></code> </pre></div></div><br>  Compile, update, reboot.  We change again the LCD4linux config. <br><br><div class="spoiler">  <b class="spoiler_title">lcd4linux.conf</b> <div class="spoiler_text"><pre> <code class="cpp hljs">Variables { tick <span class="hljs-number"><span class="hljs-number">500</span></span> tack <span class="hljs-number"><span class="hljs-number">100</span></span> minute <span class="hljs-number"><span class="hljs-number">60000</span></span> } Display VT100 { Driver <span class="hljs-string"><span class="hljs-string">'vt100'</span></span> Size <span class="hljs-string"><span class="hljs-string">'16x2'</span></span> Port <span class="hljs-string"><span class="hljs-string">'/dev/lcd0'</span></span> Icons <span class="hljs-number"><span class="hljs-number">1</span></span> } Widget RAM { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meminfo</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemFree</span></span></span><span class="hljs-class">')/1024 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">postfix</span></span></span><span class="hljs-class"> ' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MB</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RAM</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> 11 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">precision</span></span></span><span class="hljs-class"> 0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">align</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tick</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Busy</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">proc_stat</span></span></span><span class="hljs-class">:</span></span>:cpu(<span class="hljs-string"><span class="hljs-string">'busy'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>) prefix <span class="hljs-string"><span class="hljs-string">'Busy'</span></span> postfix <span class="hljs-string"><span class="hljs-string">'%'</span></span> width <span class="hljs-number"><span class="hljs-number">9</span></span> precision <span class="hljs-number"><span class="hljs-number">1</span></span> align <span class="hljs-string"><span class="hljs-string">'R'</span></span> update tick } Widget Uptime { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uptime</span></span></span><span class="hljs-class">('%</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">days</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class">:</span></span>%M:%S') width <span class="hljs-number"><span class="hljs-number">20</span></span> align <span class="hljs-string"><span class="hljs-string">'R'</span></span> prefix <span class="hljs-string"><span class="hljs-string">'Up '</span></span> update <span class="hljs-number"><span class="hljs-number">1000</span></span> } Widget Uptime { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Up</span></span></span><span class="hljs-class"> '.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uptime</span></span></span><span class="hljs-class">('%</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class">:</span></span>%M:%S') width <span class="hljs-number"><span class="hljs-number">16</span></span> align <span class="hljs-string"><span class="hljs-string">'L'</span></span> update <span class="hljs-number"><span class="hljs-number">1000</span></span> } # Icons Widget Timer { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Icon</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">speed</span></span></span><span class="hljs-class"> 83 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bitmap</span></span></span><span class="hljs-class"> {</span></span> Row1 <span class="hljs-string"><span class="hljs-string">'.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|'</span></span> Row2 <span class="hljs-string"><span class="hljs-string">'.***.|.*+*.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.+++.|.+*+.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|'</span></span> Row3 <span class="hljs-string"><span class="hljs-string">'*****|**+**|**++*|**+++|**++.|**++.|**+++|**+++|**+++|**+++|**+++|+++++|+++++|++*++|++**+|++***|++**.|++**.|++***|++***|++***|++***|++***|*****|'</span></span> Row4 <span class="hljs-string"><span class="hljs-string">'*****|**+**|**+**|**+**|**+++|**+++|**+++|**+++|**+++|**+++|+++++|+++++|+++++|++*++|++*++|++*++|++***|++***|++***|++***|++***|++***|*****|*****|'</span></span> Row5 <span class="hljs-string"><span class="hljs-string">'*****|*****|*****|*****|*****|***++|***++|**+++|*++++|+++++|+++++|+++++|+++++|+++++|+++++|+++++|+++++|+++**|+++**|++***|+****|*****|*****|*****|'</span></span> Row6 <span class="hljs-string"><span class="hljs-string">'.***.|.***.|.***.|.***.|.***.|.***.|.**+.|.*++.|.+++.|.+++.|.+++.|.+++.|.+++.|.+++.|.+++.|.+++.|.+++.|.+++.|.++*.|.+**.|.***.|.***.|.***.|.***.|'</span></span> Row7 <span class="hljs-string"><span class="hljs-string">'.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|'</span></span> Row8 <span class="hljs-string"><span class="hljs-string">'.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|'</span></span> } } Layout L16x2 { Row1 { Col1 <span class="hljs-string"><span class="hljs-string">'Uptime'</span></span> col16 <span class="hljs-string"><span class="hljs-string">'Timer'</span></span> } Row2 { Col1 <span class="hljs-string"><span class="hljs-string">'Busy'</span></span> Col11 <span class="hljs-string"><span class="hljs-string">'RAM'</span></span> } } Display <span class="hljs-string"><span class="hljs-string">'VT100'</span></span> Layout <span class="hljs-string"><span class="hljs-string">'L16x2'</span></span></code> </pre></div></div><br>  Checking: <br><br><pre> <code class="bash hljs">root@lede: /usr/bin/lcd4linux -v -F LCD4Linux 0.11.0-SVN-1193 starting vt100: <span class="hljs-variable"><span class="hljs-variable">$Rev</span></span>: 001 $ vt100: reserving 1 of 8 user-defined characters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> icons initializing layout <span class="hljs-string"><span class="hljs-string">'L16x2'</span></span> Creating new timer group (1000 ms) widget <span class="hljs-string"><span class="hljs-string">'Uptime'</span></span>: Class <span class="hljs-string"><span class="hljs-string">'text'</span></span>, Parent <span class="hljs-string"><span class="hljs-string">'&lt;root&gt;'</span></span>, Layer 1, Row 0, Col 0 (to 0,16) Creating new timer group (83 ms) widget <span class="hljs-string"><span class="hljs-string">'Timer'</span></span>: Class <span class="hljs-string"><span class="hljs-string">'icon'</span></span>, Parent <span class="hljs-string"><span class="hljs-string">'&lt;root&gt;'</span></span>, Layer 1, Row 0, Col 15 (to 1,16) Creating new timer group (500 ms) widget <span class="hljs-string"><span class="hljs-string">'Busy'</span></span>: Class <span class="hljs-string"><span class="hljs-string">'text'</span></span>, Parent <span class="hljs-string"><span class="hljs-string">'&lt;root&gt;'</span></span>, Layer 1, Row 1, Col 0 (to 1,9) widget <span class="hljs-string"><span class="hljs-string">'RAM'</span></span>: Class <span class="hljs-string"><span class="hljs-string">'text'</span></span>, Parent <span class="hljs-string"><span class="hljs-string">'&lt;root&gt;'</span></span>, Layer 1, Row 1, Col 10 (to 1,21)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On the screen, we see the time of the board's work from the last boot, system boot, free memory, and the animation symbol in the form of a filling and clearing disk. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3d6/41a/718/3d641a718dd04cd8bf2569f25726499d.gif" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> By adding the LCD4Linux config fix to the patch 180-vt100.patch, we will get the same kind of indicator right at boot: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">180-vt100.patch</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs">--- a/lcd4linux.conf.sample <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span><span class="hljs-number"><span class="hljs-number">-15</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">46.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span> +++ af/lcd4linux.conf.sample <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">22.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0000</span></span> @@ <span class="hljs-number"><span class="hljs-number">-567</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">567</span></span>,<span class="hljs-number"><span class="hljs-number">14</span></span> @@ HttpPort <span class="hljs-string"><span class="hljs-string">'5800'</span></span> } - +Display VT100 { + Driver <span class="hljs-string"><span class="hljs-string">'vt100'</span></span> + Size <span class="hljs-string"><span class="hljs-string">'16x2'</span></span> + Port <span class="hljs-string"><span class="hljs-string">'/dev/lcd0'</span></span> + Icons <span class="hljs-number"><span class="hljs-number">1</span></span> +} + + Display FutabaVFD { Driver <span class="hljs-string"><span class="hljs-string">'FutabaVFD'</span></span> Port <span class="hljs-string"><span class="hljs-string">'/dev/parport0'</span></span> @@ <span class="hljs-number"><span class="hljs-number">-674</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">681</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ Widget RAM { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meminfo</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemTotal</span></span></span><span class="hljs-class">')/1024 + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">meminfo</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemFree</span></span></span><span class="hljs-class">')/1024 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">postfix</span></span></span><span class="hljs-class"> ' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MB</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RAM</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">width</span></span></span><span class="hljs-class"> 11 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">precision</span></span></span><span class="hljs-class"> 0 @@ -828,6 +835,14 @@ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class"> 1000 } +</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Uptime</span></span></span><span class="hljs-class"> {</span></span> + <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">' + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Up</span></span></span><span class="hljs-class"> '.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uptime</span></span></span><span class="hljs-class">('%</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">H</span></span></span><span class="hljs-class">:</span></span>%M:%S') + width <span class="hljs-number"><span class="hljs-number">16</span></span> + align <span class="hljs-string"><span class="hljs-string">'L'</span></span> + update <span class="hljs-number"><span class="hljs-number">1000</span></span> +} + Widget mpris_TrackPosition_bar { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bar</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expression</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mpris_dbus</span></span></span><span class="hljs-class">:</span></span>:method_PositionGet(<span class="hljs-string"><span class="hljs-string">'org.kde.amarok'</span></span>) @@ <span class="hljs-number"><span class="hljs-number">-1015</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">1030</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ Widget Timer { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Icon</span></span></span><span class="hljs-class">' - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">speed</span></span></span><span class="hljs-class"> 50 + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">speed</span></span></span><span class="hljs-class"> 83 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bitmap</span></span></span><span class="hljs-class"> {</span></span> Row1 <span class="hljs-string"><span class="hljs-string">'.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|.....|'</span></span> Row2 <span class="hljs-string"><span class="hljs-string">'.***.|.*+*.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.*++.|.+++.|.+*+.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|.+**.|'</span></span> @@ <span class="hljs-number"><span class="hljs-number">-1225</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> +<span class="hljs-number"><span class="hljs-number">1240</span></span>,<span class="hljs-number"><span class="hljs-number">17</span></span> @@ } } +Layout L16x2<span class="hljs-number"><span class="hljs-number">-2</span></span> { + Row1 { + Col1 <span class="hljs-string"><span class="hljs-string">'Uptime'</span></span> + col16 <span class="hljs-string"><span class="hljs-string">'Timer'</span></span> + } + Row2 { + Col1 <span class="hljs-string"><span class="hljs-string">'Busy'</span></span> + Col11 <span class="hljs-string"><span class="hljs-string">'RAM'</span></span> + } +} + Layout L20x2 { Row1 { Col1 <span class="hljs-string"><span class="hljs-string">'CPUinfo'</span></span> @@ <span class="hljs-number"><span class="hljs-number">-1323</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">1349</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ -Display <span class="hljs-string"><span class="hljs-string">'ACool'</span></span> +#Display <span class="hljs-string"><span class="hljs-string">'ACool'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'SerDispLib'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'LCD-Linux'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'LCD2041'</span></span> @@ <span class="hljs-number"><span class="hljs-number">-1354</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> +<span class="hljs-number"><span class="hljs-number">1380</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ #Display <span class="hljs-string"><span class="hljs-string">'IRLCD'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'USBLCD'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'BWCT'</span></span> -#Display <span class="hljs-string"><span class="hljs-string">'Image'</span></span> +Display <span class="hljs-string"><span class="hljs-string">'Image'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'TeakLCD'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'Trefon'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'LCD2USB'</span></span> @@ <span class="hljs-number"><span class="hljs-number">-1363</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">1389</span></span>,<span class="hljs-number"><span class="hljs-number">17</span></span> @@ #Display <span class="hljs-string"><span class="hljs-string">'ctinclud'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'picoLCD'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'VNC'</span></span> +Display <span class="hljs-string"><span class="hljs-string">'VT100'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'FutabaVFD'</span></span> #Display <span class="hljs-string"><span class="hljs-string">'GLCD2USB'</span></span> -#Layout <span class="hljs-string"><span class="hljs-string">'Default'</span></span> -Layout <span class="hljs-string"><span class="hljs-string">'TestLayer'</span></span> +Layout <span class="hljs-string"><span class="hljs-string">'Default'</span></span> +#Layout <span class="hljs-string"><span class="hljs-string">'TestLayer'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'TestImage'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'L8x2'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'L16x1'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'L16x2'</span></span> +Layout <span class="hljs-string"><span class="hljs-string">'L16x2-2'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'L20x2'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'L40x2'</span></span> #Layout <span class="hljs-string"><span class="hljs-string">'Test'</span></span></code> </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13. Optimization of data transmission on the I2C bus </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now that everything is working as planned, a little bit about the data transfer rate. </font><font style="vertical-align: inherit;">I want to draw attention to two points. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the data on the I2C bus is transmitted by very small blocks, and specifically one byte. </font><font style="vertical-align: inherit;">And each block is added the address of the slave. </font><font style="vertical-align: inherit;">It is logical to assume that the transfer of the device address with a larger unit will increase the utilization of the bus and reduce the transfer time.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how the transmission looks like individual bytes.</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/8ab/156/bf7/8ab156bf7ef742ca994c56719bdacd48.jpg" alt="image"><br>     ‚Äî   (0x4E). <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will carry out partial optimization. </font><font style="vertical-align: inherit;">To do this, we recall how one byte of data is transmitted to the indicator. </font><font style="vertical-align: inherit;">LCD works in 4-bit mode, i.e. </font><font style="vertical-align: inherit;">gets a half a byte at a time. </font><font style="vertical-align: inherit;">These half-bytes should be confirmed by issuing an ‚ÄúEnable‚Äù signal. </font><font style="vertical-align: inherit;">As a result, to transfer one byte from the processor to the indicator via the I2C bus, there are 6 bytes:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Older half-byte without ‚ÄúEnable‚Äù signal </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Senior half bytes with the ‚ÄúEnable‚Äù signal </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Older half-byte without ‚ÄúEnable‚Äù signal </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Junior half a byte without the ‚ÄúEnable‚Äù signal </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Junior half a byte with the signal "Enable" </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Junior half a byte without the ‚ÄúEnable‚Äù signal </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And since each is accompanied by an address, this is actually 12 bytes, with a bus speed of 100 KHz, this is 1.2 ms. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is proposed to transmit the same 6 bytes, but in one block, with one address byte, i.e. </font><font style="vertical-align: inherit;">7 bytes instead of 12. Original data transfer procedures from the HD44780 driver.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hd44780_write_data, hd44780_write_nibble, pcf8574_raw_write from hd44780-dev.c</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pcf8574_raw_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, u8 data)</span></span></span><span class="hljs-function"> </span></span>{ i2c_smbus_write_byte(lcd-&gt;i2c_client, data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_write_nibble</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, dest_reg reg, u8 data)</span></span></span><span class="hljs-function"> </span></span>{ data = (data &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reg == DR) data |= RS; data = data | (RW &amp; <span class="hljs-number"><span class="hljs-number">0x00</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lcd-&gt;backlight) data |= BL; pcf8574_raw_write(lcd, data); pcf8574_raw_write(lcd, data | E); pcf8574_raw_write(lcd, data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_write_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, u8 data)</span></span></span><span class="hljs-function"> </span></span>{ u8 h = (data &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; u8 l = data &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; hd44780_write_nibble(lcd, DR, h); hd44780_write_nibble(lcd, DR, l); udelay(<span class="hljs-number"><span class="hljs-number">37</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>); }</code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The procedure of the driver HD44780, corrected for packet data. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hd44780_write_data from hd44780-dev.c</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hd44780_write_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct hd44780 *lcd, u8 data)</span></span></span><span class="hljs-function"> </span></span>{ u8 h = (data &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; u8 l = data &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; u8 buf[<span class="hljs-number"><span class="hljs-number">5</span></span>]; h = (h &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF0</span></span>; l = (l &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF0</span></span>; h |= RS; l |= RS; h = h | (RW &amp; <span class="hljs-number"><span class="hljs-number">0x00</span></span>); l = l | (RW &amp; <span class="hljs-number"><span class="hljs-number">0x00</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lcd-&gt;backlight){ h |= BL; l |= BL; } buf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = h | E; buf[<span class="hljs-number"><span class="hljs-number">1</span></span>] = h; buf[<span class="hljs-number"><span class="hljs-number">2</span></span>] = l; buf[<span class="hljs-number"><span class="hljs-number">3</span></span>] = l | E; buf[<span class="hljs-number"><span class="hljs-number">4</span></span>] = l; i2c_smbus_write_i2c_block_data(lcd-&gt;i2c_client, h, <span class="hljs-number"><span class="hljs-number">5</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> u8 *)(&amp;buf[<span class="hljs-number"><span class="hljs-number">0</span></span>])); udelay(<span class="hljs-number"><span class="hljs-number">37</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>); }</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the transfer byte 0x1F</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b74/3c6/053/b743c6053f5948d8b06bf09107ba4fea.jpg" alt="image"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And takes 0.67 ms. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly, the default bus speed is 100 KHz, which is not the maximum. </font><font style="vertical-align: inherit;">Of course, this is the speed recommended for the port extender on the LCD. </font><font style="vertical-align: inherit;">But at the same time, many developers are talking about uninterrupted operation at 400 KHz. </font><font style="vertical-align: inherit;">Of course, the use of non-standard mode is justified, if necessary, and thorough testing for the absence of failures, and I can only say how to do it and what happens. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information on the Internet about the inclusion of the mode could not be found, it was necessary to revise the source code LEDE. </font><font style="vertical-align: inherit;">As a result, there are two options for enabling fast mode, i.e. </font><font style="vertical-align: inherit;">400 kHz.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first is to pass a parameter to the kernel module. </font><font style="vertical-align: inherit;">The module is i2c-ibm_iic. </font><font style="vertical-align: inherit;">The parameter is iic_force_fast. </font><font style="vertical-align: inherit;">As a result, it is necessary to add i2c-ibm_iic.iic_force_fast = 1 to the kernel parameters at startup. </font><font style="vertical-align: inherit;">This can be done in the U-boot bootloader for example:</font></font><br><br><pre> <code class="bash hljs">setenv addmisc <span class="hljs-string"><span class="hljs-string">'setenv bootargs ${bootargs} i2c-ibm_iic.iic_force_fast=1'</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After booting the system we have: </font></font><br><br><pre> <code class="bash hljs"> root@lede: dmesg | grep i2c [ 0.000000] Kernel <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> line: root=/dev_nfs rw nfsroot=192.168.1.10:/nfs/debian_ppc/rootfs ip=dhcp console=ttyS0,115200 i2c-ibm_iic.iic_force_fast=1 [ 4.770923] i2c /dev entries driver [ 4.774742] ibm-iic 4ef600700.i2c: using fast (400 kHz) mode [ 10.456041] i2c i2c-0: new_device: Instantiated device hd44780 at 0x27</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The second is to specify the bus mode in the device tree (apollo3g.dtsi, fast-mode parameter): </font></font><br><br><pre> <code class="hljs objectivec">IIC0: i2c@ef600700 { compatible = <span class="hljs-string"><span class="hljs-string">"ibm,iic"</span></span>; reg = &lt;<span class="hljs-number"><span class="hljs-number">0xef600700</span></span> <span class="hljs-number"><span class="hljs-number">0x00000014</span></span>&gt;; interrupt-parent = &lt;&amp;<span class="hljs-built_in"><span class="hljs-built_in">UIC0</span></span>&gt;; interrupts = &lt;<span class="hljs-number"><span class="hljs-number">0x2</span></span> <span class="hljs-number"><span class="hljs-number">0x4</span></span>&gt;; fast-mode; <span class="hljs-meta"><span class="hljs-meta">#address-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1&gt;</span></span></span><span class="hljs-meta">; #size-cells = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;0&gt;</span></span></span><span class="hljs-meta">; };</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After compiling, do not forget to update the device tree on the TFTP server. </font><font style="vertical-align: inherit;">And the result:</font></font><br><br><pre> <code class="bash hljs">root@lede: dmesg | grep i2c [ 4.774585] i2c /dev entries driver [ 4.778396] ibm-iic 4ef600700.i2c: using fast (400 kHz) mode [ 10.464396] i2c i2c-0: new_device: Instantiated device hd44780 at 0x27 root@lede: ls -al /proc/device-tree/plb/opb/i2c@ef600700 -r--r--r-- 1 root root 4 Nov 18 04:13 <span class="hljs-comment"><span class="hljs-comment">#address-cells -r--r--r-- 1 root root 4 Nov 18 04:13 #size-cells drwxr-xr-x 2 root root 0 Nov 18 04:13 . drwxr-xr-x 12 root root 0 Nov 18 04:13 .. -r--r--r-- 1 root root 8 Nov 18 04:13 compatible -r--r--r-- 1 root root 0 Nov 18 04:13 fast-mode -r--r--r-- 1 root root 4 Nov 18 04:13 interrupt-parent -r--r--r-- 1 root root 8 Nov 18 04:13 interrupts -r--r--r-- 1 root root 4 Nov 18 04:13 name -r--r--r-- 1 root root 8 Nov 18 04:13 reg</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the transfer rate of byte is 0.19 ms: </font></font><br><br><img src="https://habrastorage.org/files/d8e/64d/f10/d8e64df108a442b09c15397f34965ef0.jpg" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Which is almost an order of magnitude better than the original. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a conclusion, we can say that as a result of the work done, we were able to use the board with a poorly documented processor in open sources in projects where we use Linux (LEDE). </font><font style="vertical-align: inherit;">The main Ethernet interface, storage on SATA, management through I2C and several ports provide ample opportunities for developers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, to duplicate the above, the files from LEDE, according to the directory structure (like everything remembered) are available </font></font><a href="https://yadi.sk/d/McvSlL8mzoFnA"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div><p>Source: <a href="https://habr.com/ru/post/316100/">https://habr.com/ru/post/316100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316088/index.html">Small code for big data or Apache Spark in 3 days</a></li>
<li><a href="../316090/index.html">Riot.js 3.0 released</a></li>
<li><a href="../316092/index.html">As we came up with and made our first game on Android. Part 2: Levels</a></li>
<li><a href="../316094/index.html">What discounts are hosters on this Black Friday</a></li>
<li><a href="../316098/index.html">Inside NetBeans. Prologue</a></li>
<li><a href="../316102/index.html">Banana Pi - backup server</a></li>
<li><a href="../316104/index.html">How IT professionals work. Anton Petrochenko, Panasonic Russia</a></li>
<li><a href="../316106/index.html">A boring one-line calculator on sed</a></li>
<li><a href="../316108/index.html">Trello Clone on Phoenix and React. Parts 10-12. Long Term Finish</a></li>
<li><a href="../316110/index.html">‚ÄúLead me better‚Äù: What will make the work of a novice programmer more effective</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>