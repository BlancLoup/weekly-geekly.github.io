<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex cloud platform: read more about Elliptics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I started telling about Elliptics on Habr√© - our fault-tolerant key-value distributed storage (by the way, free and distributed under th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex cloud platform: read more about Elliptics</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I <a href="http://habrahabr.ru/company/yandex/blog/200080/">started telling about Elliptics on Habr√©</a> - our fault-tolerant key-value distributed storage (by the way, free and distributed under the GPL-license).  Then I described the Elliptics device in general: about the architecture and the basic principles of operation, due to which the reliability of the system is achieved, how the system can be expanded, and how it behaves when it fails. <br><br>  Starting from this article, let's try to dive deeper into Elliptics: I want to tell you about the internal architecture and various supported features. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/209882/"><img src="https://habrastorage.org/getpro/habr/post_images/959/c9e/935/959c9e93599dfc8fa861404a668331ac.jpg" alt="image"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today - about the network and software architecture of Elliptics and some of its features.  I will also tell you in detail about the cache and our low-level library for local data storage - <a href="http://reverbrain.com/eblob/">Eblob</a> . <br><a name="habracut"></a><br><h4>  Vocabulary </h4><br>  To begin with, we introduce a small set of concepts for a better understanding of each other: <br><ul><li>  node - one of the nodes in the network Elliptics; </li><li>  group - one of the DHT-rings, each node belongs to one of the groups; </li><li>  id - the unique key of the item in Elliptics; </li><li>  server - server node; </li><li>  client - client node. </li></ul><br><br><h4>  Network architecture </h4><br>  As mentioned in the last article, in Elliptics, each node is responsible for some range of keys in its group.  But at the same time, each node is aware of the range for which all of them are responsible.  In Elliptics, this knowledge is called the query routing table.  It is thanks to her and the peer-to-peer technology, in which all nodes connect to all, you can make any request for O (1) network operations. <br><br>  Elliptics was originally created as a truly reliable data storage system that will not be architecturally afraid of shutting down machines, data centers, or entire countries.  Therefore, it was important to build a system without using a master node, which is fairly simple and easily reacting to any changes in the network configuration. <br><br>  The Elliptics routing table is maintained up to date in a very simple way: each node asks for the first node from each group to return its routing table once a certain amount of time.  This allows you to timely respond to any changes in the network, to learn about the appearance of new or loss of existing machines. <br><br>  If the client's routing table has fallen behind the real situation, then the server may receive a request for an identifier for which it is not responsible.  In this case, the request will be forwarded by the server to that node, which, in its opinion, is responsible for this range. <br><br>  For communication between nodes, Elliptics uses its extensible asynchronous binary protocol with multiplexing support.  Each package has a header and, possibly, a request or response body. <br><br>  In the header are: <br><ul><li>  key for which the request was made; </li><li>  command status (represents errno); </li><li>  transaction number; </li><li>  team number (identifier); </li><li>  a set of flags common to all commands; </li><li>  size of request / response body. </li></ul><br>  The total header is 96 bytes, the body of the request and response is specific to the command and, from the point of view of the network engine, is simply a set of bytes.  This protocol allows you to abstract the actual network interaction between nodes from the logic of the server - data storage.  Due to this, we can say that Elliptics is no longer just a data storage system, but a distributed command execution system. <br><br><h4>  What makes Elliptics different? </h4><br>  In large networks, problems arise with the prioritization of network flows; there are several ways to solve it. <br><br>  First, you can ‚Äúpaint‚Äù traffic using the TOS (Type of Service) field in the ip-package.  In this case, you can prioritize requests from the client to the server and between servers.  Elliptics uses server_net_prio and client_net_prio options for this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec2/78c/56f/ec278c56f00e757be61542e262579a9f.jpg" alt="image"><br><br>  Secondly, you can start up different traffic on different networks, for this Elliptics has support for several interfaces.  At the same time, each interface needs to specify the class (number, identifier) ‚Äã‚Äãof the network, so we will have our own routing table for each network, this allows some customers to go on a faster, but, for example, less reliable network, and on other customers slower but reliable.  Due to this, you can run the recovery procedure on a faster network without affecting requests from the outside world that are currently running. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/94e/c66/fee/94ec66fee1fcf842b50af786ab525257.jpg" alt="image"><br><br>  In Elliptics there is support for regionality, the data will always try to give from that machine on the network that is closer to the client.  This allows you to have caching copies of data in data centers around the world without having to send each request to Moscow.  For example, for Yandex.Music it is possible to store the most popular compositions in data centers of a specific region. <br><br>  Due to the way Elliptics stores data on a disk (which will be discussed below), it is possible to stream data directly from servers, without intermediate proxying.  To do this, the client finds out where the data nearest to him are located, and redirects the user's HTTP request directly to the server, where the data is physically located.  At the same time, the request already contains information about the file containing the necessary data block, as well as the size and coordinates of this block relative to the beginning of the file.  This allows you to use one of the best solutions for today to return statics over HTTP - nginx.  To protect against access to "alien" data, such requests include simple private key authentication. <br><br>  It is no secret that from time to time data is lost for reasons beyond our control - disks are piling up, servers are burning down, hurricanes leave data centers without electricity, for political reasons they turn off the Internet in the country.  In this case, it is important that the data continue to be stored in the correct number of copies.  Therefore, Elliptics has a procedure called read recovery.  If during the reading it is found that the file is not on all the necessary groups, then upon receipt of the data, the client on these groups restores it.  This allows you to maintain the system even without a long start of global data recovery procedures. <br><br>  In addition to read recovery, we also have data recovery systems both inside and between the data center.  The first way is well suited if we add new machines to the groups ‚Äî the added machines immediately begin to respond to all requests.  Recording will be done successfully, but the new nodes will not be able to give them, because they are still on the ‚Äúold‚Äù servers, although the corresponding ranges are already serving the ‚Äúnew‚Äù ones.  Merge recovery transports data from one server group to another.  Inter-center recovery is needed in case of accidents or planned exercises, when we lose part of the data on one or several groups.  Missing (or newer) data will be copied from other replicas. <br><br><h4>  Server architecture </h4><br>  The server itself in its device resembles a layer cake.  At the very top is the network layer, which is responsible only for maintaining connections between the nodes, as well as for reading and sending packets over the network.  At the same level, the routing table is kept up to date. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/603/f89/eef/603f89eef2ed5f2a760ab7648365b45b.jpg" alt="image"><br><br>  Below is a layer for processing commands.  All incoming requests are distributed to the appropriate handlers: cache, secondary indexes, counters, srw, backend, service commands. <br><br>  I / O operations with the corresponding flags fall into the cache.  They will get to the backend only if the cache does not have enough data to process the request, or by timeout (by default, data is synchronized from cache to disk once every 30 seconds).  For example, all append requests will be accumulated in the cache to minimize the number of disk operations.  The exception is the iteration and range requests, they are immediately sent to the backend.  You can generally prohibit working with the disk (enabled by a special flag in the command) - in this case, all operations will be performed only with the memory of the cache. <br><br>  Secondary indexes run on top of the existing Elliptics infrastructure.  To implement them, it was enough to add several new commands, as well as to be able to call already existing methods for writing and reading files, which in turn will pass through the cache.  Secondary indexes in Elliptics allow you to mark any files with tags, and also subsequently to find the necessary files by them. <br><br>  In addition, Elliptics has a data processing system - srw (unfortunately, no one remembers how it is decrypted and what it means in general).  Srw allows you to perform various tasks on Elliptics servers.  To run applications and monitor the consumption of their resources using our cloud platform <a href="http://habrahabr.ru/company/yandex/blog/209324/">Cocaine</a> .  In general, the principle of operation is as follows: <br><br><ol><li>  The client sends a request to the server to perform the task, the request contains the name of the application, the name of the event and the binary data - the event arguments; </li><li>  The server through Cocaine sends the request to the desired application; </li><li>  Cocaine, if necessary, launches a new instance of the application, monitors their lifetime and load; </li><li>  The application processes the request, if necessary, sends further messages to other applications (which can also be on other machines).  Each application can send some data to the client. </li><li>  The last application informs the client about the completion of the task. </li></ol><br>  The data will be received by the ‚Äúcopy‚Äù of the application that is running directly on the machine responsible for storing the key being processed - thus, high locality of data and handlers is implemented. <br>  It is possible to roughly represent the server code as a trigger for an operation in the database.  On top of this system is built <a href="http://reverbrain.com/grape/">Grape</a> - our Open Source system for processing data flow in real time. <br><br><h4>  Cache </h4><br>  Elliptics cache appeared in August 2012 to reduce the load on the disk.  Initially it was <a href="http://ru.wikipedia.org/wiki/%25C0%25EB%25E3%25EE%25F0%25E8%25F2%25EC%25FB_%25EA%25FD%25F8%25E8%25F0%25EE%25E2%25E0%25ED%25E8%25FF">LRU-</a> cache, which, with special flags, saved a copy of the read or write data to the cache, so that next time it would not go to disk.  In fact, there are only 16 caches in each node (of course, their number can be changed), each of which is responsible for its own range of keys.  In this way, better support for multi-core systems is achieved. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01f/201/ad4/01f201ad4fc102fc8e8ddd264fca93eb.jpg" alt="image"><br><br>  Subsequently, support for timeouts was added to it, after which the data is removed from the cache.  Delayed write to the disk was also added, this allows you to ‚Äústick together‚Äù several I / O operations with a key into one - this is very noticeable if there are many append records at the end of files, for example, in the case of storing logs. <br><br>  More recently, the LRU cache has been replaced with a <a href="http://ru.wikipedia.org/wiki/%25C0%25EB%25E3%25EE%25F0%25E8%25F2%25EC%25FB_%25EA%25FD%25F8%25E8%25F0%25EE%25E2%25E0%25ED%25E8%25FF">Segmented LRU</a> cache; it behaves much better with hot data.  We came to this idea after learning about the <a href="https://www.facebook.com/notes/facebook-engineering/flashcache-at-facebook-from-2010-to-2013-and-beyond/10151725297413920/">Facebook experience</a> .  Segmented LRU stores hot data in a separate list, so they are not pushed out of the cache by keys that were accessed once. <br><br>  In total, the cache needs to support 4 data structures - LRU-lists (per page per page in SLRU), a binary search tree by keys, a queue with priorities for timeouts and a queue with priorities for sync-to-disk.  However, the last 3 structures are quite well placed on top of a Cartesian tree - a binary tree above the keys and a heap above the ‚Äúevents‚Äù, where the ‚Äúevent‚Äù is the time of a sync or key swelling.  But at the same time, contrary to standard practice, when balancing is achieved due to random weights in a heap, we get a tree balanced by ‚Äúrandom‚Äù keys.  And we can consider keys as random due to the fact that they are the result of cryptographic hashing by the sha512 function. <br><br><h4>  Backend </h4><br>  In conclusion, I will briefly tell you about our main backend - <a href="http://reverbrain.com/eblob/">Eblob</a> .  In the entire history of Elliptics, many different libraries have been tested, for example, Google LevelDB, Tokyo / Kyoto Cabinet, Oracle BerkeleyDB, file system.  For our tasks, Eblob turned out to be the best local system for storing medium (more than one kilobyte) and large (tens of gigabytes) data volumes. <br><br>  So, Eblob is our low-level Open Source append-only library for storing data in <a href="http://en.wikipedia.org/wiki/Binary_large_object">blobs</a> . <br><br>  In each blob can be millions of files and its size can reach hundreds of gigabytes, all these parameters can be configured.  At each time point, the record goes only to the last, ‚Äúopen‚Äù blob.  As soon as the blob reaches a limit on the size or number of files, it ‚Äúcloses‚Äù and a new one opens.  After this, the files in the ‚Äúclosed‚Äù blobs will never change, the maximum that can happen is to mark the file as deleted if it is deleted or a new version is recorded in the new blob. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6f/f53/8f1/f6ff538f12cb59967e15b570a6a168c5.jpg" alt="image"><br><br>  Some time after the closure of the blob, or as soon as the keys more than the threshold value are deleted from it, the sorting procedure starts (it is defragmentation).  This can be done either manually by an external utility, or by a timeout or range specified in the ebloba config.  During the sorting / defragmentation, all empty places will be deleted from the blob, and an index file will be created that contains only data headers (key, internal eblob flags, size and indent from the beginning of the data in the "big" blob).  Due to the need to smooth the load on the disk, the defragmentation operation can be postponed to the future in order to perform it during the least load on the system. <br><br>  To search for a blob in which the key lies, several techniques are used: <br><ul><li>  All indices of the not yet sorted blobs are in memory; </li><li>  By sorted blobs built on <a href="http://ru.wikipedia.org/wiki/%25D4%25E8%25EB%25FC%25F2%25F0_%25C1%25EB%25F3%25EC%25E0">Bloom Filter</a> for each blob, and also builds a tree of ranges for every 40 (default) keys in the blob. <br><ul><li>  If Bloom Filter says that the key may be on the disk, then the binary tree is searched for a range in which the requested key should be. </li><li>  The piece of the index file corresponding to the found range is read from the disk, then a binary search is performed on it. </li><li>  If the key is found in the index file, then a request is already being made to a large blob on the exact coordinates. </li></ul><br></li></ul><br><h4>  Conclusion </h4><br>  In the following articles we will talk about how to raise Elliptics at home and examples of its use, more about the Eblob device (believe us, we have something interesting to tell about it), data streaming, secondary indexes and much more. </div><p>Source: <a href="https://habr.com/ru/post/209882/">https://habr.com/ru/post/209882/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209870/index.html">UNIX_TIMESTAMP, ROUND and other DQL queries via queryBuilder in Symfony 2</a></li>
<li><a href="../209874/index.html">Facebook expands its ‚Äúarctic‚Äù data center in Lulea</a></li>
<li><a href="../209876/index.html">How can you make java better</a></li>
<li><a href="../209878/index.html">Women's view on Just5 Spacer: 5-inch smartphone with two covers for 5,250 rubles</a></li>
<li><a href="../209880/index.html">Unbearable programming complexity</a></li>
<li><a href="../209886/index.html">Official launch of email alerts</a></li>
<li><a href="../209894/index.html">Which HDD is more reliable? Backblaze statistics on 27134 drives for 4 years of work</a></li>
<li><a href="../209898/index.html">With regards to points</a></li>
<li><a href="../209902/index.html">Hello, I am error 217 and I will not tell you anything</a></li>
<li><a href="../209906/index.html">DMMR: radio control via USB- "whistle"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>