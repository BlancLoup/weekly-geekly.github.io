<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to study source codes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I was (not very successfully) reading errors and typos in the previous post, bobry offered to discuss how to make a story in the console (which i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to study source codes</h1><div class="post__text post__text-html js-mediator-article">  When I was (not very successfully) reading errors and typos in the previous post, <a href="https://habrahabr.ru/users/bobry/" class="user_link">bobry</a> offered to discuss how to make a story in the console (which is Shift-PgUp). <br><br>  The obvious way to do something related to the terminals is to look at what others have done and do the same.  In the process of studying this, we noticed an interesting feature: some programs, showing the contents, restore the screen before launching the application (mc, vim, nano, less, etc.).  In addition, when they start, the scroll bar disappears (in xterm / gnome-terminal). <br><br>  To study ‚Äúhow‚Äù it was decided to focus on MC, as the oldest (and independent of ncurses) application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next comes the romatic story of how mc makes toggle_panel () with a lot of quotes from the source code. <br><br>  At the same time, the reader will be able to see what the ‚Äúlook in the source‚Äù process looks like. <br><a name="habracut"></a><br>  So, the source code is MC.  It is known that the screen "behind" can be seen on Ctrl-O.  The combination of buttons appeared in the old Norton Commander, from which all subsequent NC console clones borrowed it: Dos Navigator, Volkov Commander, Far Navigator, etc. <br><br>  They downloaded raw materials (apt-get source mc), looked inside. <br><br>  Pretty quickly, we found the keybind.c file, where it was easy to see that the Ctrl-letter combinations were encoded as ‚ÄúCL‚Äù (in our case, ‚ÄúCo‚Äù).  A simple array of enums (or is it definees? Not important), the required line: <br><br><pre>     {XCTRL ('o'), CK_ShowCommandLine, "Co"},
</pre><br>  Next (we don‚Äôt know, MC architecture, and don‚Äôt really want to know), we simply use the <em>grep</em> utility to find where this function is: <code>grep CK_ShowCommandLine -A3 -B3 -r *</code> <br><br>  Required file - main.c <br><br><pre> main.c: case CK_ShowCommandLine:
 main.c- view_other_cmd ();
 main.c- break;
</pre><br>  and near: <br><br><pre> viewer / actions_cmd.c: case CK_ShowCommandLine:
 viewer / actions_cmd.c- view_other_cmd ();
 viewer / actions_cmd.c- break;
</pre><br>  And the viewer.  and mc itself use the same function: view_other_cmd.  Similar grep, is the file cmd.c with the desired function: <br><br><pre> void
 view_other_cmd (void)
 {
     static int message_flag = TRUE;

     if (! xterm_flag &amp;&amp;! console_flag &amp;&amp;! use_subshell &amp;&amp;! output_starts_shell) {
         if (message_flag)
             message (D_ERROR, MSG_ERROR,
                      _ ("Not an xterm or Linux console; \ n"
                        "the panels cannot be toggled."));
         message_flag = FALSE;
     } else {
         toggle_panels ();
     }
 }
</pre><br>  The eye cuts the old style of text formatting a little, but ... <br><br>  So, <ol><li>  The sought toggle_pannels () function.  In fact, we immediately rushed to watch it, but now we will be more consistent and carefully read the error case (note the elegant emulation of closures in C - using static in a variable in order to display an error message only once programs). </li><li>  The error is displayed if ... if we have NOT xterm and NOT console.  The part related to the subshell does not interest us, but about a separate xterm check we tick the box. </li></ol><br>  We are looking for toggle_pannels ().  File execute.c.  The function is large, I will quote an interesting place. <br><br><pre>     tty_reset_screen ();
     do_exit_ca_mode ();
     tty_raw_mode ();
     if (console_flag)
         handle_console (CONSOLE_RESTORE);
</pre><ol><li>  tty_reset_screen - let's say </li><li>  do_exit_ca_mode - oh interesting </li><li>  tty_raw_mode is just a switch of character input modes </li><li>  Interestingly, if we have a console, then a handle_console is made ... </li></ol><br><br>  What is ca_mode?  Minor hitch (file not in src, but in lib), tty / win.c.  next to it is the opposite do_enter_ca_mode: <br><pre> void
 do_enter_ca_mode (void)
 {
     if (xterm_flag) {
         fprintf (stdout, / * ESC_STR ") 0" * / ESC_STR "7" ESC_STR "[? 47h");
         fflush (stdout);
     }
 }

 void
 do_exit_ca_mode (void)
 {
     if (xterm_flag) {
         fprintf (stdout, ESC_STR "[? 47l" ESC_STR "8" ESC_STR "[m");
         fflush (stdout);
     }
 }
</pre><br>  Total - switching of the strange mode which we do not know.  Associate with xterm.  Quickgun suggests that this is "Use Alternate Screen Buffer": <br><br><blockquote>  Xterm maintains two screen buffers.  The normal screen buffer is saved by the saveLines resource.  This screen contains no additional saved lines.  When you alternate screen buffer is active, you can‚Äôt scroll back to view saved lines.  Xterm provides control sequences and menu entries for switching between the two. <br></blockquote><br><br>  OK.  Clear.  Xterm has a special esc code. <br><br>  And linux?  Go to the linux console (real, Ctrl-Alt-F1), try vim - when you exit, we see the previous contents on the screen.  less ... see.  nano ... see.  That is, linux (according to console_codes) does not support this.  I see.  And mc?  And mc works, asshole!  How?  Why?  Go back to the mc source code, see ... And what does the handle_console do? <br><br>  We are looking for ... (cons.handler.c): <br><pre>
 void
 handle_console (unsigned char action)
 {
     (void) action;

     if (look_for_rxvt_extensions ())
         return;

 #ifdef __linux__
     handle_console_linux (action);
 #elif defined (__FreeBSD__)
     handle_console_freebsd (action);
 #endif
</pre><br>  Hmm ... It turns out that in linux and in FreeBSD this is handled differently.  (But what about solaris? There is no more your solaris, Oracle threw the boots onto the remote.) <br><br>  We look handle_console_linux, through it console_save.  What do we see?  MC forks a separate process called cons.saver, which does ioctl, reading and writing to strange / dev / vcsa * devices.  What kind of devices? <br><br><h1>  Oh, new, wonderful world </h1><br>  It turns out that linux has pseudo-devices that correspond to the CGA (VGA) memory of the adapter in text mode, where the data is stored as an array <br><br>  struct { <br>  char char; <br>  char Attrib; <br>  } <br><br>  Yes, yes, that old long forgotten DOS, with direct access to video memory.  We check - indeed, hexdump files completely show us the contents of the screen.  Note that to access the device, you must have the rights to it.  This is usually done in the following way: they put a group on the device file, put the owner of this group on the file, and set the sgid-bit to it. <br><br>  In Debian, cons.saver has sgid bits for the tty group (common group for accessing pseudo-terminals), and in centos for the special group vcsa.  In principle, agree with the approach of RHEL / CentOS, it is more secure. <br><br>  So, a special file ... That is, the MC with the help of a cunning hack reads the contents of the screen, and when necessary, writes it back ... <br><br>  But the virtual machine console is not on the VGA-adapter!  This is a clean serial port.  And a simple check is suspicious - on all virtual machines vcsa is pristine clean, because we do not have a VGA adapter.  I mean, video cards. <br><br>  What to do?  Well, for starters, check out what mc will do in a serial port situation.  As we know, there is no difference between a UNIX98 pseudo-terminal and a serial port.  We go back to the real linux (console), log in via ssh to any server, start mc, and, voila - not supported. <br><br>  Thus, we, making the console on the serial port, in principle, cannot provide an analogue of vcsa - and the hack in mc about ctrl-o cannot work.  Basically. <br><br><h1>  What about xterm? </h1><br>  Implementing an esc code for xterm would be easy.  But ... We do not have access to the contents of the virtual machines, we can not change the environment of the users - and therefore, by default, linux expects that on the serial port it has the terminal type linux (TERM = linux) and does not implement xterm / xrvt functions meaning - they still will not use. <br><br>  Just in case, we check how mc learns about the existence of xterm extensions ... <br><br><pre>     const char * termvalue;

     termvalue = getenv ("TERM");
</pre><br><br>  Alas, the environment variable (and I was hoping for a query string).  Well, definitely not.  Alas. <br><br>  By the way, exactly the same hack (but adjusted for architectural features) is used in FreeBSD.  Alas. <br><br><h1>  Morality? </h1><br>  We will not fully work Ctrl-O in our wonderful console in Linux.  Alas, never.  And the rest was interesting. <br><br>  ... By the way, if you have a live server and it is alive, you can remotely see what's happening on consoles there - cat / dev / vcsa *.  And special fans can watch and watch others work on consoles. </div><p>Source: <a href="https://habr.com/ru/post/122027/">https://habr.com/ru/post/122027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../122020/index.html">Spaces - the main enemy of Linux</a></li>
<li><a href="../122021/index.html">School of data analysis Yandex: graduation again</a></li>
<li><a href="../122022/index.html">How to count other people's money</a></li>
<li><a href="../122025/index.html">iPad ‚Üí iPADrom - S03E07. IPad software review</a></li>
<li><a href="../122026/index.html">Android slider from LG with two screens</a></li>
<li><a href="../122028/index.html">IPO for dummies. Part V: Life after IPO</a></li>
<li><a href="../122029/index.html">We learn bash-scripts, we write Xonix</a></li>
<li><a href="../122030/index.html">Choosing a microcontroller together</a></li>
<li><a href="../122031/index.html">Interview Mark Shuttleworth: in Ubuntu, the default browser will be Google Chrome</a></li>
<li><a href="../122033/index.html">Kinect for Windows SDK beta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>