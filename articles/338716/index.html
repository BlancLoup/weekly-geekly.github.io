<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As we celebrated 256 day of the year and drew pixels through the API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="September 13, Contour Day was celebrated in Contour. In the largest development office, they played Pac-Man and tried to eat 280 pizza boxes . At the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As we celebrated 256 day of the year and drew pixels through the API</h1><div class="post__text post__text-html js-mediator-article"><p>  September 13, Contour Day was celebrated in Contour.  In the largest development office, <a href="https://www.instagram.com/p/BY-x5gsBbqq/%3Ftaken-by%3Dskbkontur">they played Pac-Man</a> and tried to eat <a href="https://www.facebook.com/ovchinnikov.fedor/posts/10214112926318313%3Fpnref%3Dstory">280 pizza boxes</a> .  At the same time, fifteen hundred people were drawing pixels online.  In this post, four developers tell how the holiday was done. </p><br><p><img src="https://habrastorage.org/web/79b/2cc/d3f/79b2ccd3fe4c4fd0ab180aadd8bbf6ea.png"></p><br><h2 id="chast-1-rasskazyvaet-igor-green_hippo-kotoryy-styril-ideyu-na-reddit">  Part 1. Igor <a href="https://habrahabr.ru/users/green_hippo/" class="user_link">says green_hippo</a> , who stole the idea on Reddit </h2><br><p>  The day of the programmer is celebrated by the entire company, not just the developers.  Therefore, an idea was needed for an online game in which everyone can participate.  I remembered that in April, <a href="https://www.reddit.com/r/place/">Reddit Place</a> was a social experiment on collective drawing on a canvas of 1000 √ó 1000 pixels, in which a million people participated. </p><br><p>  I decided that I had to make my Place, with a timelapse and an API. </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/XnRCZK3KjUY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  On Reddit, a million people painted on a canvas the size of one megapixel.  Everyone could paint no more than one pixel every 5‚Äì20 minutes.  If you make a festive canvas of 256 √ó 256 pixels (15 times less) and consider that we have not a million employees (but 200 times less), then the delay between the pixels should also be about 10 times less. </p><br><p>  Therefore, for our field of 256 √ó 256 pixels, I chose a delay from 2:56 to 0:32.  And after that he talked about the idea to colleagues who agreed to help. </p><br><h2 id="chast-2-rasskazyvaet-veronika-aminopyrodin-kotoraya-poborola-sebya-i-tormoznoy-canvas">  Part 2. Veronica <a href="https://habrahabr.ru/users/aminopyrodin/" class="user_link">aminopyrodin</a> , who overcame herself and the inhibitory canvas </h2><br><p>  I immediately realized that the front would need a canvas, a palette and a zoom.  But the designers (Vladimir <a href="https://habrahabr.ru/users/dzekh/" class="user_link">dzekh</a> and Yuliya <a href="https://habrahabr.ru/users/krasilnikovayu/" class="user_link">krasilnikovayu</a> ) turned out to be more cunning and came up with another rewind, statistics, leaderboard and screenshots. </p><br><p><img src="https://habrastorage.org/web/4eb/5e6/cc9/4eb5e6cc937e4940aa72e16b5986fff9.jpg"></p><br><p>  By the way, at first there were fewer colors in the palette, but then the guys added brown in order not to limit anyone's creative impulses. </p><br><p>  In the meantime, as a modern fender, I began to reflexively think about setting up a Webpack, Babel and Autoprefixer.  And when I woke up, I learned that the backend developer had already done everything.  And it even worked.  Crooked, askew, but it worked: dots on the canvas were set, zoom was zooming.  I sawed off from the beautiful design all unnecessary and beautifully laid out. </p><br><p>  There are two problems: Edge and Safari. </p><br><p><img src="https://habrastorage.org/web/313/cf5/7e3/313cf57e3a694b0eb5ad673550a38e9e.png"></p><br><p> In Safari, everything really slowed down with terrible force.  First I discovered that canvas is not rendered into a separate composite layer.  Therefore, the browser redraws the entire document every time the canvas is updated.  Added <code>transition: translateZ(0)</code> canvas, and everything began to slow down faster.  Then refactored the rest of the Bakder code, got rid of a dozen redraws.  The interface flew on the first spacecraft. </p><br><p>  I didn‚Äôt care about IE right away, because I knew that players would use normal browsers.  The trouble came from an older brother.  If you ask Edge to draw a square, he flatly refuses.  Says: "But smooth transitions are better!" - and blurs the entire picture. </p><br><p><img src="https://habrastorage.org/web/c86/e20/4de/c86e204dec9b4042beb71fc640b16e92.png"></p><br><p>  <a href="https://redditblog.com/2017/04/13/how-we-built-rplace/">The same problem</a> was the guys from Reddit.  At first I solved it using the <code>image-rendering</code> CSS property and the <code>CanvasRenderingContext2D.imageSmoothingEnabled</code> flag.  But before the launch, it turned out that Edge was messing up with the server through web sockets.  Therefore, I declared him an abnormal browser. </p><br><p>  I am proud that I tried to bring React, Webpack, Babel, LESS and Autoprefixer to code three times, but I was able to defeat myself.  As a result, everything is written on pure ES6 + and CSS, but with trendy grids, web sockets and fetch. </p><br><h2 id="chast-3-rasskazyvaet-ivan-vansel-kotoryy-poproboval-novuyu-klassnuyu-biblioteku-i-ne-rad-etomu">  Part 3. Tells Ivan <a href="https://habrahabr.ru/users/vansel/" class="user_link">vansel</a> , who tried a new cool library and is not happy about it. </h2><br><p>  I did not want to write everything from scratch, so I looked for something ready.  The original Place <a href="https://github.com/reddit/reddit-plugin-place-opensource">is on Github</a> , but there is too much code.  I took a <a href="https://github.com/josephg/sephsplace">simple clone</a> for NodeJS and walked a file through it.  That is why, when Veronica took over, the interface was already working somehow.  In general, there are <a href="https://www.reddit.com/r/OpenPlace/">lots of clones</a> , choose for yourself any. </p><br><p>  In the code of the selected clone, we had to fix vulnerabilities and add the missing ones: a timer, an expanded palette, rewind online, collecting statistics, drawing via web sockets instead of REST requests, logging through the Passport (our internal authenticator). </p><br><p><img src="https://habrastorage.org/web/599/e97/883/599e97883dc24e579db80151649efd3b.png"></p><br><p>  The architecture was as follows: the user put a pixel in the browser, the browser sent a message through a web socket to the server, the server sent a message about changing the canvas to the queue (Apache Kafka).  Then the servers took data from the queue and sent it to all clients.  Above is the original scheme from the author of the clone, in which clients still communicate with the server using REST requests. </p><br><p>  We were planning to rewind, so I decided to cache the canvas snapshots with versions.  At startup, the server should have taken the last snapshot from the cache, rather than building it from scratch.  The same snapshot was received by the client when connected to the server, which caused the loading of the canvas to be almost instantaneous.  It was possible to send a client a snapshot of any version and thus organize rewind.  The new snapshot was saved after changing every hundred pixels. </p><br><p>  About a day after the start of the game an incident happened.  I fixed the bug and restarted the server.  And users saw that some of the drawn points were gone. </p><br><p><img src="https://habrastorage.org/web/122/c79/8b0/122c798b04d5493fb423304ff92a215a.png"></p><br><p>  The fact was that when connecting to the server, the client requested a specific version of the canvas.  Therefore, after the start, the server took from the cache not the last snapshot, but some old version that was requested by one of the clients.  Users did not see the fresh pixels and began to draw in a new way, and the server continued to add data to the queue. </p><br><p>  When I realized what was happening, I cleared the cache.  The server reloaded the data from the queue and generated the current version of the canvas.  It turned out to be a funny effect: new user patterns were superimposed on previous ones, since everything lost was returned and new changes were added.  The fix was fast, so nothing messed up: </p><br><p><img src="https://habrastorage.org/web/996/2ef/b78/9962efb7843945ddb47634873f33ca61.png"></p><br><p>  In general, it is not for nothing that they say that invalidation of caches is one of the <a href="https://martinfowler.com/bliki/TwoHardThings.html">two most difficult tasks</a> in computer science. </p><br><p>  It's funny that I, while repairing the cache, accidentally turned off authentication.  There was also a kolhaker colleague who filled out a few thousand pixels with a script in a couple of minutes.  I rolled out a fix, but the green bar remained: </p><br><p><img src="https://habrastorage.org/web/7f5/389/643/7f5389643b7c4b8fb9ac700da443d22f.png"></p><br><p>  I also wanted after the end of the game to make a good time-lapse and count the statistics.  For this, I decided to start a database and save the coordinates, color, date and time, as well as the user ID for each point drawn in it. </p><br><p>  The server was under NodeJS, so I chose <a href="http://lokijs.org/">LokiJS</a> .  This database was praised for its simplicity and speed of work, because all data is stored in memory and automatically written to disk at specified intervals.  For my task fit. </p><br><p>  I set up saving once every 1 minute.  Tested locally, including under load - everything worked like a clock.  And on the battlefield, something paranormal was happening.  The data was not saved to the disk according to a schedule, but of its own accord.  For example, for several hours they were not saved even once.  For three days I did not find the reasons for this behavior.  As a result, a lot of statistics were lost during server restarts. </p><br><p>  However, I was ready for this from the very beginning, because timelaps were very necessary.  Every minute I saved the canvas as an image to a file.  It turned out a few gigabytes of pictures, but a video with a time-lapse was recorded and voiced by a couple of commands: </p><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ ffmpeg -pattern_type glob </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-i "*.png" </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-c:v libx264 </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">-vf format=yuv420p </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span></span><span class="hljs-formula">timelapse.mp4 $</span></span> ffmpeg -i timelapse.mp4 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-i sci-fi.mp3 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>256.mp4</code> </pre> <br><h2 id="chast-4-rasskazyvaet-pavel-xoposhiy-kotoryy-zagnul-radugu-i-zapustil-raketu-cherez-api">  Part 4. Paul <a href="https://habrahabr.ru/users/xoposhiy/" class="user_link">tells xoposhiy</a> , who bent the rainbow and launched a rocket through the API </h2><br><p>  After the start of the game, everyone quickly realized that one was not a warrior in the field.  Self-organization began in Staff, our internal social network: </p><br><p><img src="https://habrastorage.org/web/7fe/bb3/d5a/7febb3d5a6f54a8bbb50d797fd77b958.png"></p><br><p>  I also participated in this: </p><br><p><img src="https://habrastorage.org/web/93f/94c/812/93f94c812c9c4a81891eafa51e7a8744.png"></p><br><p>  But even with the team it was not interesting to draw a large-scale image.  I figured it out after the first seven pixels of the rainbow.  Not even pleased that colleagues have done a bunch of useful tools: </p><br><div class="spoiler">  <b class="spoiler_title">mesh for error-free drawing pictures</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/web/d0e/12a/55e/d0e12a55ea74446ea99ec464eb193d27.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">browser bot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/web/8a3/927/47f/8a392747fade48f2b123690da7b84fe5.png"></p></div></div><br><p>  I expected more from the Programmer‚Äôs Day.  And I waited - on the second day, Igor published the following code snippet in Staffa and began distributing API keys to those who wanted to: </p><br><p><img src="https://habrastorage.org/web/808/14a/5c1/80814a5c1c3d4d9b9c02a34f6a2ae786.png"></p><br><p>  It was already something! </p><br><p>  To warm up, I wrote a bot who drew a given picture.  It was not very fun.  Then he came up with the idea to create a picture algorithmically.  The result was a bot that bent a perfectly round rainbow.  But it was also boring. </p><br><p>  I realized that a non-boring bot should not just draw pixels, but interact with the outside world and other people's creativity.  But it was necessary to avoid vandalism, because the bot is a force, and responsibility must come with force. </p><br><p>  You could draw a clock with the current time.  Or a moving picture that crawls across a canvas and overwrites other people's drawings ... in order to restore them later.  And then I came up with a plot that combined these two ideas. </p><br><p>  The clock became a countdown timer, the moving picture - a rocket taking off.  In addition, a rocket is very convenient to draw - first you lengthen the upper part by a pixel, then you shorten the lower part by a pixel.  This not only looks good, but also saves pixels, because the delay in drawing through the API has not been canceled. </p><br><p>  This was supposed to be the slowest flight of a rocket in the history of mankind.  With the current delay for a couple of hours, I could move the rocket just a few pixels.  It was necessary either to reduce the rocket, or to move it in jumps, or to accept the fact that it would fly for a day.  He shared the agony of choice with Igor, and he with the words ‚ÄúDo good!‚Äù Suddenly dumped nearly 50 keys for the API.  With so many keys, a rocket could reach a speed of one pixel per second! </p><br><p><img src="https://habrastorage.org/web/ce6/16d/688/ce616d6883d849f6a08c6e98421b16dc.jpg"></p><br><p>  It remains a little: choose the design of the rocket and write all the code.  I dropped the cartoon rockets and chose the Vostok carrier rocket.  It immediately became clear that the rocket‚Äôs flight should end with the launch of the Vostok-1 spacecraft into orbit. </p><br><p>  Why "East"?  Because right now a lot of engineers from Kontur are working on a secret project with the code name <a href="https://github.com/vostok">Vostok</a> .  I wanted the guys to be nice. </p><br><p>  I set up the bot, started the countdown timer, called the viewers through Staff.  The rocket took off.  And then I realized how ridiculous the rocket looks in space with unseparated accelerating blocks and the first stage.  Miraculously I found 10 free minutes to add a branch to the stage and restart the bot.  So it was not only the slowest flight of a rocket in the history of mankind, but also the first flight of a rocket, in the middle of which its structure was changed. </p><br><p>  It was nice to see how colleagues erased a copy of the rocket, because of the bug left on the launch pad.  They draw a one-pixel man in the window of the rocket.  Rework the word "go" in the "ponafeh".  In general, it was pleasing that everyone behaved culturally, despite the absence of rules.  Even when the place on the canvas is over: </p><br><p><img src="https://habrastorage.org/web/87e/a14/b58/87ea14b58f2d4b6a839fa531ed297068.png"><br><img src="https://habrastorage.org/web/0ab/36e/40c/0ab36e40c1924da5a977f75ac5ffd4c6.png"></p><br><p>  By the way, without NSFW-content has not done.  Someone from the word TRON painted by my first boring bot stubbornly made the word PRON. </p><br><div class="spoiler">  <b class="spoiler_title">There were more interesting pictures.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/web/62e/2db/1bc/62e2db1bc48b4ac78f1ada1886eae8ba.jpg"></p></div></div><br><p>  Vanya later said that on September 13, 1,630 people and a dozen bots, that is, about a third of all company employees, were simultaneously drawing on canvas.  On average, 440 clients were connected to the servers, and during the daytime hours - 840. </p><br><p>  As a result, we got this picture: </p><br><p><img src="https://habrastorage.org/web/b72/68e/24d/b7268e24dbda46c795e91f9e337e7b6f.png"></p><br><p>  And such a time-lapse.  My rocket takes off at 27 seconds: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D9r4c0sw_UY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Do you program on holidays and for holidays?  Tell us in the comments. </p><br><p>  PS If you are interested in what we do not tell on Habr√©, subscribe to our <a href="https://t.me/KonturTech">channel in Telegram</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338716/">https://habr.com/ru/post/338716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338702/index.html">"Open Sunday" at the partner seminar "1C"</a></li>
<li><a href="../338704/index.html">On the classification of Fourier transform methods by examples of their software implementation by means of Python</a></li>
<li><a href="../338710/index.html">Energy efficient data center: familiarity with international experience</a></li>
<li><a href="../338712/index.html">Kali Linux: system protection and monitoring exercises</a></li>
<li><a href="../338714/index.html">How to get to ITMO University Technopark</a></li>
<li><a href="../338718/index.html">Understanding the new sync.Map in Go 1.9</a></li>
<li><a href="../338720/index.html">Use PubNub: Emotional Talking Chat Do It Yourself</a></li>
<li><a href="../338722/index.html">The second version of the Air Quality Monitor</a></li>
<li><a href="../338724/index.html">How to build a self-managed business: formulating the ‚Äúlaws of robotics‚Äù Hamster Marketplace</a></li>
<li><a href="../338730/index.html">IT events digest for October</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>