<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Looking under the hood of the new Gmail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Half a year ago, Google introduced an updated version of its email service. Despite the fact that many users were unhappy with the redesign, including...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Looking under the hood of the new Gmail</h1><div class="post__text post__text-html js-mediator-article"><p>  Half a year ago, Google <a href="https://www.theverge.com/2018/4/25/17277360/gmail-redesign-live-features-google-update">introduced an</a> updated version of its email service.  Despite the fact that many users were unhappy with the redesign, including <a href="https://habr.com/post/429018/">on Habr√©</a> , this is now the main interface for users. </p><br><p>  Among other shortcomings, people complain about the deterioration of the performance of the new version, especially on weak computers.  Let's see why this is happening and what could be so heavy in the mail interface.  In this article, we‚Äôll use Google Chrome‚Äôs developer tools, so this article will also be a reminder of what features are there. </p><a name="habracut"></a><br><h2 id="ishodnye-dannye">  Initial data </h2><br><p>  First, you need to understand what we are dealing with.  Google Chrome Devtools has a built-in <a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> tool that builds a simple and clear report on the performance of your site.  In it, Gmail gets a deuce for performance (out of a maximum of 100 points!) </p><br><p><img src="https://habrastorage.org/webt/yu/zg/lp/yuzglprkqo7bjwn7ddfbcdxz8k0.png"></p><br><p>  To be honest, this is not the result that you expect from a Google product.  Nevertheless, we will look at this situation in more detail.  Disable the cache, and load the Gmail interface with devtools enabled.  All requests made to download this page will be displayed on the Network tab.  It turned out 6.9 MB.  This is an impressive size, considering that even Youtube, another recently updated service, downloads only 2 MB of resources. </p><br><blockquote>  It‚Äôs still worth noting that modern services, and Gmail among them, use <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Workers</a> for improved caching of resources.  Therefore, for accurate measurements of a cold start, a single <a href="https://stackoverflow.com/a/7000899/1297743">cache shutdown is</a> not enough, you also need to <a href="https://github.com/GoogleChromeLabs/sw-precache/issues/340">reset Service Workers</a> , who also hold resources.  Only after that the number of download from scratch will be real. </blockquote><p>  Now try to look at loading the page in slow motion.  The <a href="https://developers.google.com/web/tools/chrome-devtools/network-performance/">Google Chrome documentation</a> explains how to do this.  We get a set of screenshots from different stages of loading the page: </p><br><p><img src="https://habrastorage.org/webt/2j/tw/ao/2jtwaofovrdv_ytxy6vjd6dnzrm.png"></p><br><p>  Here you can see that the page is more or less loaded by the 9th second. </p><br><p>  With reloading when using the cache, the situation is better.  The page makes only 250 Kb of requests, however it does not make it faster, we still see the splash screen for almost 10 seconds.  The point is clearly not in the number of requests, something else makes the page slower. </p><br><h2 id="blokiruem-resursy">  We lock resources </h2><br><p>  Now look at the list of downloadable scripts: </p><br><p><img src="https://habrastorage.org/webt/md/2l/qw/md2lqwcqm3bl9l5frwa4-c3qpqi.png"></p><br><p>  Perhaps some of them are not so necessary for the normal operation of the interface?  Let's try to turn them off in turn and test the page without them.  This is easily done with the <a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes">built-in devtools functionality</a> . </p><br><p> It was experimentally found out that requests for <code>https://mail.google.com/_/scs/*</code> are critical for the interface, but you can block the following requests: </p><br><ul><li>  <code>www.gstatic.com/og/*</code> - <a href="https://developers.google.com/api-client-library/">Google API Client Library</a> , library for queries to Google services </li><li>  <code>ssl.gstatic.com/inputtools/*</code> - <a href="https://www.google.com/inputtools/">Google Input Tools</a> - <code>ssl.gstatic.com/inputtools/*</code> -Screen Keyboard Widget </li><li>  <code>hangouts.google.com</code> - responsible for the handgouts widget </li></ul><br><blockquote>  In addition to these requests, the AdBlock installed by me has already blocked requests for <code>https://play.google.com/log</code> , we do not take them into account, since they were not made before the start of experiments with locks. </blockquote><p>  Add these scripts to the blacklist and see that the page started loading in 4 seconds, but you can still read and write letters. </p><br><h2 id="smotrim-v-profayler">  We look in the profiler </h2><br><p>  So, we minimized the loading of resources as best we could, but the page still loads for a long time.  We need to see what happens during these 4 seconds.  Here we will come to the aid of the <a href="https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/reference">profiler built into Chrome</a> .  He shows us this picture: </p><br><p><img src="https://habrastorage.org/webt/nf/df/5f/nfdf5fyvr7vgproydoxpqjo4zgo.png"></p><br><p>  Here you can see that throughout this time the browser was busy executing Javascript.  It is interesting that such an important and heavy occurs in this code.  Fortunately, Javascript is loaded into the browser almost unchanged, and you can read it. </p><br><h2 id="rassmatrivaem-ostavshiysya-kod">  Consider the remaining code </h2><br><p>  Let's read the available Javascript code.  Here comes the opportunity to <a href="https://developers.google.com/web/tools/chrome-devtools/javascript/reference">format the minified code</a> to make it more readable. </p><br><p>  Following the results of the review the following was found: </p><br><ul><li>  The code is very obfuscated.  Most likely, Google Closure Compiler was used in <a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Advanced Mode</a> .  That is, the developers of Gmail squeezed the most out of modern technologies of minification. </li><li>  The code collects performance metrics, so developers should be aware of how slow the user interface loads. </li><li>  Sources contain polyfills for Promise, Map, Set and other modern APIs that might not be loaded into modern browsers. </li><li>  Gmail Code written in <a href="https://github.com/google/closure-library">Google Closure Libary</a> </li></ul><br><p>  At the last point stands stop in more detail.  The Closure Library is an interface development framework that appeared in 2009 and has changed little since then.  For example, there is still supported <a href="https://github.com/google/closure-library/blob/master/closure/goog/net/xml">Ajax through ActiveXObject</a> : which is needed only for IE6 and below, although the current Gmail <a href="https://support.google.com/mail/answer/6557%3Fco%3DGENIE.Platform%253DDesktop%26hl%3Den">officially supports</a> only IE 10+. </p><br><p>  In addition, Closure UI-part is based on the <a href="https://google.github.io/closure-library/source/closure/goog/demos/">class hierarchy</a> in the "best" traditions of GWT - approach, with a large number of verbose abstractions, which, obviously, affect the rendering performance.  Modern UI frameworks (React or Vue, for example) offer much more lightweight abstractions ‚Äî components ‚Äî that are much cheaper than rendering. </p><br><p>  Hence the long initialization: thousands of classes are created in the code and many abstractions are initialized before we actually render the Gmail interface. </p><br><p>  Thus, despite the updated appearance, Gmail pulls in itself the legacy of old technologies, the severity of which cannot be hidden behind the outer shell. </p><br><h2 id="vyvody">  findings </h2><br><p>  I hope after this review it will be a little clearer why Gmail is slowing down.  Unfortunately, it is not in our power to force Google to speed up the work of their service, but you can at least learn a few lessons for your applications: </p><br><ul><li>  In Legacy projects, there is usually unnecessary code, for example, hacks for outdated browsers.  Review your source code and get rid of those things that have become irrelevant. </li><li>  Abstractions are not free.  If you want to solve a problem using an elegant architectural pattern, first think, and if this is not a very heavy tool, maybe there is a simpler option. </li><li>  Do not load non-essential items on the page initially.  In this case, the Hangouts widget could not block the channel, making it difficult to load the main Gmail resources, but loaded in the background, after the main functionality was drawn. </li><li>  Do not neglect modern technology.  They can be fundamentally new solutions for your tasks, more productive and convenient.  It is strange to see in 2018 a redesign of the service from Google, which does not use <a href="https://developers.google.com/web/fundamentals/web-components/">web components</a> for which Google so actively <a href="https://www.youtube.com/watch%3Fv%3D7CUO7PyD5zA">drowns at conferences</a> . </li><li>  Well, do not forget to pay attention <a href="https://developers.google.com/web/fundamentals/performance/audit/tools">to performance measurements</a> for your projects.  For this, there are now many handy tools, both browser-based and for <a href="https://github.com/ebidel/lighthouse-ci">launching in CI</a> . </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/429506/">https://habr.com/ru/post/429506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429496/index.html">Self-made laser installation "Lightsaber": as it were. Part 2</a></li>
<li><a href="../429498/index.html">4 causes of procrastination (text)</a></li>
<li><a href="../429500/index.html">"It's time to do business" finally flew</a></li>
<li><a href="../429502/index.html">Is it worth developing cross-competences</a></li>
<li><a href="../429504/index.html">How to call audio methods vk</a></li>
<li><a href="../429508/index.html">Summary of the report "How to become a cool specimen for database" (HL2018, Data Egret, Ilya Kosmodemyansky)</a></li>
<li><a href="../429510/index.html">ArduPilot for beginners. Installation and configuration on BeagleBone Blue</a></li>
<li><a href="../429512/index.html">Digital events in Moscow from 12 to 18 November</a></li>
<li><a href="../429514/index.html">Microsoft told how to solve the problem of data security on SSD with "leaky" hardware encryption</a></li>
<li><a href="../429522/index.html">Designing a service robot. Problem statement, solution architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>