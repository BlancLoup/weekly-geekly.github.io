<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modern MVot-based Kotlin architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past two years, Android developers at Badoo have come a long, thorny path from MVP to a completely different approach to application architec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modern MVot-based Kotlin architecture</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/xn/qq/rv/xnqqrv1mzljdp6cmqtxjpx66ciw.png"><br><br>  Over the past two years, Android developers at Badoo have come a long, thorny path from MVP to a completely different approach to application architecture.  <a href="https://habr.com/users/anublo/" class="user_link">ANublo</a> and <a href="https://habr.com/users/anublo/" class="user_link">I</a> want to share a translation of the article by our colleague <a href="https://badootech.badoo.com/%40zsolt.kocsi">Zsolt Kocsi</a> , describing the problems we have encountered and their solution. <br><br>  This is the first of several articles devoted to the development of modern MVI architecture at Kotlin. <br><a name="habracut"></a><br><h2>  Let's start from the beginning: problems of states </h2><br>  At each moment in time, the application has a certain state that determines its behavior and what the user sees.  If you focus only on a pair of classes, this state includes all the values ‚Äã‚Äãof variables - from simple flags to individual objects.  Each of these variables lives its own life and is controlled by different parts of the code.  You can determine the current state of the application only by checking them all one by one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Working on the code, we create an existing model of the system in our head.  We easily realize the ideal cases when everything goes according to plan, but completely unable to calculate all possible problems and conditions of the application.  And sooner or later, one of the states that we have not foreseen will overtake us, and we will encounter a bug. <br><br>  Initially, the code is written in accordance with our ideas about how the system should work.  But later, going through <a href="">five stages of debugging</a> , you have to painfully redo everything, changing the existing model in your head at the same time.  It remains to hope that sooner or later an understanding of what went wrong will come to us and the bug will be fixed. <br><br>  But so luck is not always.  The more complex the system, the more likely it is to encounter any unforeseen condition, which debugging will still be a nightmare for a long time. <br><br>  In Badoo, all applications are essentially asynchronous - not only because of the extensive functionality available to the user through the UI, but also because of the possibility of one-way sending data by the server.  A lot affects the state and behavior of the application - from changing the payment status to new matches and verification requests. <br><br>  As a result, in our chat module, we came across several strange and hard-to-reproduce bugs, which spoiled a lot of blood.  Sometimes testers managed to write them down, but they did not repeat on the developer‚Äôs device.  Due to the asynchronous code, the repetition of the full extent of this or that chain of events was extremely unlikely.  And since the application did not fall, we didn‚Äôt even have a stack trace that would show where to start the search. <br><br>  Clean Architecture ( <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">pure architecture</a> ) also could not help us.  Even after we rewrote the chat module, the A / B tests revealed small but significant inconsistencies in the number of messages from users who used the new and old modules.  We decided that this was due to the hard reproducibility of bugs and the state of the race.  The discrepancy persisted after checking all other factors.  The interests of the company suffered, developers had a hard time maintaining the code. <br><br>  It is impossible to release a new component, if it works worse than the existing one, but it is also impossible not to release it - since an update was required, it means that there was a reason.  So, it is necessary to figure out why in a system that looks completely normal and does not crash, the number of messages drops. <br><br>  Where to start the search? <br><br>  Spoiler: this is not the fault of Clean Architecture - the human factor, as always, is to blame.  In the end, of course, we fixed these bugs, but spent a lot of time and effort on this.  Then we thought: Is there an easier way to avoid these problems? <br><br><h2>  The light at the end of the tunnel ... </h2><br>  Fashionable terms like Model-View-Intent and ‚Äúunidirectional data flow‚Äù are well known to us.  If in your case this is not the case, I advise them to google it - there are many articles on the Internet on these topics.  Android developers especially recommend the <a href="http://hannesdorfmann.com/android/mosby3-mvi-1">Hannes Dorfman material in eight parts</a> . <br><br>  We started playing with these ideas from web development back in early 2017.  Approaches like Flux and Redux have proven very useful - they helped us cope with many problems. <br><br>  First of all, it is very useful to contain all state elements (variables that affect the UI and trigger various actions) in one object - <b>State</b> .  When everything is stored in one place, the overall picture is better visible.  For example, if you want to submit data loading using this approach, then you will need <i>payload</i> and <i>isLoading</i> fields.  Looking at them, you will see when the data is received ( <i>payload</i> ) and whether an animation ( <i>isLoading</i> ) is shown to the user. <br><br>  Further, if we move away from the parallel execution of the code with callbacks and express the state changes of the application in the form of a series of transactions, we will get a single entry point.  We present you the <b>Reducer</b> , which arrived to us from functional programming.  It takes the current state and data about further actions ( <b>Intent</b> ) and creates from them a new state: <br><br> <code>Reducer = (State, Intent) -&gt; State</code> <br> <br>  Continuing with the previous example of loading data, we get the following actions: <br><br><ul><li>  <b>Startedloading</b> <br></li><li>  <b>FinishedWithSuccess</b> <br></li></ul><br><br>  Then you can create a Reducer with the following rules: <br><br><ol><li>  In the case of <b>StartedLoading,</b> create a new <b>State</b> object by copying the old one, and set the <i>isLoading</i> value to true. <br></li><li>  In the case of <b>FinishedWithSuccess,</b> create a new <b>State</b> object by copying the old one, in which the <i>isLoading</i> value will be set to false and the <i>payload</i> value will be <br>  match loaded. <br></li></ol><br>  If we put the resulting <b>State</b> series into a log, we see the following: <br><br><ol><li>  State ( <i>payload</i> = null, <i>isLoading</i> = false) - initial state. <br></li><li>  State ( <i>payload</i> = null, <i>isLoading</i> = true) - after StartedLoading. <br></li><li>  State ( <i>payload</i> = data, <i>isLoading</i> = false) - after FinishedWithSuccess. <br></li></ol><br>  By connecting these states to the UI, you will see all the stages of the process: first, a blank screen, then the boot screen, and finally the required data. <br><br>  This approach has many advantages. <br><br><ul><li>  First, by changing the state centrally with a series of transactions, we do not allow the state of the race and the many imperceptible annoying bugs. <br></li><li>  Secondly, after examining a series of transactions, we can understand what happened, why it happened and how it affected the state of the application.  In addition, with Reducer it is much easier to present all state changes even before the first launch of an application on a device. <br></li><li>  Finally, we have the ability to create a simple interface.  Since all states are stored in one place (Store), which takes into account intentions (Intents), makes changes with the help of Reducer and visually demonstrates a chain of states, it means you can put all business logic in the Store and use the interface to launch intentions and deduce states. <br></li></ul><br><br>  Or not? <br><br><h2>  ... can be a train rushing at you </h2><br>  One Reducer is not enough.  How to deal with asynchronous tasks with different results?  How to respond to the push from the server?  How to deal with the launch of additional tasks (for example, clearing the cache or loading data from the local database) after changing the state?  It turns out that either we do not include all this logic in the Reducer (that is, a good half of the business logic will not be covered, and those who decide to use our component will have to take care of it), or force the Reducer to do everything at once. <br><br><h2>  Requirements for the MVI framework </h2><br>  Of course, we would like to conclude all the business logic of a separate feature in a separate component, with which developers from other teams could easily work by simply creating its copy and subscribing to its state. <br><br>  Besides: <br><br><ul><li>  it should easily interact with other components of the system; <br></li><li>  there should be a clear division of responsibilities within its internal structure; <br></li><li>  all internal parts of the component must be fully deterministic; <br></li><li>  The basic implementation of such a component should be simple and complicated only when it is necessary to connect additional elements. <br></li></ul><br>  We did not immediately switch from Reducer to the solution we use today.  Each team faced problems using different approaches, and developing a universal solution that would suit everyone seemed unlikely. <br><br>  And yet, the current state of affairs suits everyone.  We are glad to present you MVICore!  The source code of the library is open and available on <a href="https://github.com/badoo/MVICore">GitHub</a> . <br><br><h2>  What is MVICore good about </h2><br><ul><li>  Easy way to implement business features in the style of reactive programming with unidirectional data flow. <br></li><li>  Scaling: the basic implementation only includes a Reducer, and in more complex cases, you can use additional components. <br></li><li>  The solution for working with events that you do not want to include in the state ( <a href="https://github.com/googlesamples/android-architecture-components/issues/63">SingleLiveEvent problem</a> ). <br></li><li>  A simple API to bind features (and other reactive components of your system) to the UI and to each other with support for the Android life cycle (and not only). <br></li><li>  Middleware support (about this below) for each component of the system. <br></li><li>  Ready logger and the possibility of time travel debaga for each component. <br></li></ul><br><br><h2>  A quick introduction to the feature </h2><br>  Since step-by-step instructions have already been posted on GitHub, I‚Äôll omit the detailed examples and focus on the main components of the framework. <br><br>  <b>Feature</b> is the central element of the framework containing the entire business logic of the component.  Feature is defined by three parameters: <i>interface Feature &lt;Wish, State, News&gt;</i> <br><br>  <b>Wish</b> corresponds to Intent from Model-View-Intent - these are the changes that we want to see in the model (since the term Intent has its meaning in the Android developer environment, we had to find another name).  Wish is the entry point for Feature. <br><br>  <b>State</b> is, as you already understood, the state of the component.  State is immutable: we cannot change its internal values, but we can create new States.  This is the output: every time we create a new state, we transfer it to the Rx stream. <br><br>  <b>News</b> - a component for processing signals that should not be in the State;  News is used once at creation ( <a href="https://github.com/googlesamples/android-architecture-components/issues/63">problem SingleLiveEvent</a> ).  Using News is optional (you can use Nothing from Kotlin in the Feature signature). <br><br>  Also in the Feature must be present <b>Reducer</b> . <br><br>  Feature may contain the following components: <br><br><ul><li>  Actor - performs asynchronous tasks and / or conditional state modifications based on the current state (for example, form validation).  Actor binds Wish to a certain number of Effect, and then passes it to the Reducer (in the absence of this, Actor Reducer receives the Wish directly). <br></li><li>  NewsPublisher - called when Wish becomes any Effect that gives a result in the form of a new State.  According to this data, he decides whether to create News. <br></li><li>  PostProcessor - also called after creating a new State and also knows what effect led to its creation.  It launches certain additional actions (Actions).  Action is ‚Äúinternal wishes‚Äù (for example, clearing the cache) that cannot be started from the outside.  They are executed in Actor, which leads to a new chain of Effects and States. <br></li><li>  Bootstrapper is a component that can run actions on its own.  Its main function is to initialize the Feature and / or correlate external sources with the Action.  These external sources can be News from another Feature or server data, which must modify State without user interaction. <br></li></ul><br><br>  The layout might look simple: <br><img src="https://habrastorage.org/webt/mi/ed/e-/miede-fbfldwuqzgreeogizadww.png"><br><br>  or include all the additional components listed above: <br><img src="https://habrastorage.org/webt/0l/qy/my/0lqymyebiyer8saxybkbw_jzgdw.png"><br><br>  The very same Feature, containing all the business logic and ready to use, looks easier nowhere: <br><br><img src="https://habrastorage.org/webt/gt/p2/ww/gtp2wwiqcxsrvavsrndirvt0_dg.png"><br><br><h2>  What else? </h2><br>  Feature, the foundation stone of the framework, works at a conceptual level.  But the library has much more to offer. <br><br><ul><li>  Since all Feature components are deterministic (with the exception of Actor, which is not fully deterministic because it interacts with external data sources, but even so, the branch it performs is determined by the input data, and not by external conditions), each of them can be wrapped in Middleware.  At the same time, the library already contains ready-made solutions for logging and <a href="https://badootech.badoo.com/time-travel-debug-everything-droidconuk-2018-lightning-talk-445217258401">time travel debug</a> . </li><li>  Middleware is applicable not only to Feature, but also to any other objects that implement the Consumer &lt;T&gt; interface, which makes it an indispensable tool for debugging. </li><li>  When using a debugger for debugging when moving in the opposite direction, you can implement the <a href="https://github.com/palaima/DebugDrawer">DebugDrawer</a> module. </li><li>  The library includes an IDEA plugin that can be used to add templates for the most common implementations of Feature, which saves a lot of time. </li><li>  There are helper classes to support Android, but the library itself is not tied to Android. </li><li>  There is a ready-made solution for linking components to the UI and to each other through an elementary API (we will talk about it in the next article). </li></ul><br>  We hope you try our <a href="https://github.com/badoo/MVICore">library</a> and its use will give you as much joy as we do - its creation! <br><br><blockquote>  November 24 and 25, you can try your hand and join us!  We will hold a mobile hiring event: in one day, it will be possible to go through all the stages of selection and get an offer.  My colleagues from iOS- and Android-teams will come to communicate with candidates to Moscow.  If you are from another city, Badoo charges you for travel expenses.  To get an invitation, pass the qualifying test <a href="https://events.badoo.com/mvi1">on the link</a> .  Good luck! </blockquote></div><p>Source: <a href="https://habr.com/ru/post/429728/">https://habr.com/ru/post/429728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429716/index.html">5 best games on the PC for learning English</a></li>
<li><a href="../429718/index.html">I want everything at once! We study the memory HyperX Predator DDR4 RGB, with a frequency of 4000 MHz</a></li>
<li><a href="../429720/index.html">As a novice developer to survive the interview and not go crazy at work</a></li>
<li><a href="../429722/index.html">How we made payment via Google Pay at Yandex.Cash [updated]</a></li>
<li><a href="../429724/index.html">Useful review. 28 books that influenced my thinking, inspired or made better</a></li>
<li><a href="../429730/index.html">Large supercomputer to be built on Elbrus processors in Russia</a></li>
<li><a href="../429732/index.html">You Gonna Hate This, or a Tale of How a Good Code Should Look</a></li>
<li><a href="../429734/index.html">Dream to fly with electrotechnical bias</a></li>
<li><a href="../429736/index.html">Hogweed Sosnowski. In MO introduced fines for distribution</a></li>
<li><a href="../429738/index.html">The optimal location of shards in a petabyte cluster Elasticsearch: linear programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>