<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multithreading (concurrency) in Swift 3. GCD and Dispatch Queues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It must be said that multithreading (oncurrency) in iOS is always included in the questions asked in interviews with developers of iOS applications , ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multithreading (concurrency) in Swift 3. GCD and Dispatch Queues</h1><div class="post__text post__text-html js-mediator-article"> It must be said that <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Multithreading/Introduction/Introduction.html">multithreading</a> (oncurrency) in iOS is always included in the questions asked in <a href="https://medium.com/cocoaacademymag/25-ios-interview-questions-and-answers-for-junior-developers-19bfe6e99b0">interviews with developers of iOS applications</a> , as well as among the <a href="https://www.toptal.com/ios/top-ios-development-mistakes">top errors</a> that programmers make when developing iOS applications.  Therefore, it is important to own this tool perfectly. <br>  So, you have an application, it works on <code>main thread</code> (main thread), which is responsible for executing the code that displays your user interface ( <code>UI</code> ).  As soon as you start adding such time-consuming pieces of code to your application as loading data from the network or processing images on <code>main thread</code> (main thread), your <code>UI</code> starts to slow down a lot and can even cause it to freeze completely. . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d6b/e2f/372/d6be2f372083452f922723c9c934e811.png" width="400" height="233"></div><br><br>  How can I change the architecture of the application so that such problems do not arise?  In this case, multithreading ( <code>oncurrency</code> ) comes to the rescue, which allows you to simultaneously perform two or more independent tasks ( <code>tasks</code> ): calculations, downloading data from a network or from a disk, image processing, etc. <br><a name="habracut"></a><br>  The processor at any given time can perform one of your tasks and the corresponding thread is allocated for it. <br>  In the case of a single-core processor (iPhone and iPad), multithreading ( <code>oncurrency</code> ) is achieved by multiple short-term switching between ‚Äúthreads‚Äù ( <code>threads</code> ) on which tasks are performed, creating a reliable idea of ‚Äã‚Äãthe simultaneous execution of tasks on a single-core processor.  On a multi-core processor (Mac), multithreading is achieved by the fact that each ‚Äúthread‚Äù associated with a task is provided with its own kernel for running tasks.  Both of these technologies use the general concept of multithreading ( <code>oncurrency</code> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A kind of fee for introducing multithreading in your application is the difficulty of ensuring safe execution of code on different threads ( <code>thread safety</code> ).  As soon as we allow tasks to work in parallel, problems arise because different tasks will want to access the same resources, for example, they will want to change the same variable in different threads, or they will want to access to resources that are already blocked by other tasks.  This can lead to the destruction of the resources used by tasks on other threads. <br><br>  In iOS programming, multi-threading is provided to developers in the form of several tools: <a href="https://developer.apple.com/reference/foundation/thread">Thread</a> , <a href="https://developer.apple.com/reference/dispatch">Grand Central Dispatch</a> (GCD for short) and <a href="https://developer.apple.com/reference/foundation/operation">Operation</a> - and is used to increase the performance and responsiveness of the user interface.  We will not consider <code>Thread</code> , since this is a low-level mechanism, and focus on <code>GCD</code> in this article and <code>Operation</code> (object-oriented <code>API</code> built on top of <code>GCD</code> ) in further publication. <br><br>  I must say that before <code>Swift 3</code> such a powerful framework as <code>Grand Central Dispatch (GCD</code> ) had an <code>API</code> based on C, which at first glance seems like a book of spells, and it is not immediately clear how to mobilize its ability to perform useful user tasks. <br>  In <code>Swift 3</code> everything changed dramatically.  <code>GCD</code> has a completely <code>Swift</code> syntax that is very easy to use.  If you are at least a little familiar with the old <code>API GCD</code> , then the whole new syntax will seem just a cakewalk;  if not, then you just have to learn another ordinary programming section on <code>iOS</code> .  The new <code>GCD</code> framework works in <code>Swift 3</code> on all <code>Apple</code> devices, starting with <code>Apple Watch</code> , including all <code>iOS</code> devices, and ending with <code>Apple TV</code> and <code>Mac</code> . <br><br>  Another <a href="https://developer.apple.com/videos/play/wwdc2016/213/">good news</a> is that since <code>Xcode 8</code> , you can use such a powerful and visual tool as <code>Playgroud</code> to learn <code>GCD</code> and <code>Operation</code> .  In <code>Xcode 8</code> a new auxiliary class <code><font color="#0000FF">PlaygroudPage</font></code> , which has a function that allows <code>Playgroud</code> to live for an unlimited time.  In this case, the <code><font color="#0000FF">DispatchQueue</font></code> queue may work until the work is completed.  This is especially important for network requests.  In order to use the <code><font color="#0000FF">PlaygroudPage</font></code> class, you need to import the <code><font color="#0000FF">PlaygroudSupport</font></code> module.  This module also allows you to access the <code>run loop</code> , display the live <code>UI</code> , and perform asynchronous operations on <code>Playgroud</code> .  Below we will see how this setting looks like in the work.  This new <code>Playground</code> feature in <code>Xcode 8</code> makes learning to use multithreading in <code>Swift 3</code> very simple and intuitive. <br><br>  For a better understanding of multithreading ( <code>concurrency</code> ), <code>Apple</code> introduced some abstract concepts with which both tools operate - <code>GCD</code> and <code>Operation</code> .  The basic concept is the <code>queue</code> .  Therefore, when we talk about multithreading in <code>iOS</code> from the point of view of an <code>iOS</code> application developer, we are talking about queues.  Queues are the usual queues in which people line up to buy, for example, a cinema ticket, but in our case closures are lined up ( <code>closure</code> ‚Äî anonymous code blocks).  The system simply executes them according to the queue, ‚Äúpulling out‚Äù the next in turn and starting it up for execution in the thread corresponding to this queue.  Queues follow the <code>FIFO</code> pattern ( <code>First In, First Out</code> ), which means that the one who was first put in the queue will be the first to be sent.  You can have multiple queues ( <code>queues</code> ) and the system ‚Äúpulls‚Äù the closures one at a time from each queue and starts them to run in their own threads.  So you get multithreading. <br><br>  But this is just a general idea of ‚Äã‚Äãhow multithreading ( <code>oncurrency</code> ) works in <code>iOS</code> .  The intrigue lies in the fact that they represent these queues in the sense of performing tasks in relation to each other (serial or parallel) and with the help of which function (synchronous or asynchronous) these tasks are placed in the queue, thereby blocking or not blocking the current queue. <br><br><h1>  Serial ( <code>serial</code> ) and parallel ( <code>concurrent</code> ) queues </h1><br>  Queues can be ‚Äú <code>serial</code> ‚Äù (consecutive) when a task (closure) that is at the top of the queue is pulled out by iOS and works until it ends, then the next item is pulled from the queue, etc.  This is a <code>serial queue</code> or serial queue.  Queues can be ‚Äúc <code>oncurrent</code> ‚Äù (multi-threaded) when the system ‚Äúpulls‚Äù the closure located at the top of the queue and starts it to run on a specific thread.  If the system still has resources, then it takes the next element from the queue and starts it to run on another thread while the first function is still running.  And so the system can extend a range of functions.  In order not to confuse the general concept of multithreading with <code>"concurrent queues"</code> (multi-threaded queues), we will call the <code>"concurrent queue"</code> parallel queue, meaning the order of execution of tasks on it relative to each other, without going into the technical implementation of this parallelism. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cba/064/d50/cba064d50117484a92217b48d556cafd.png" width="500" height="407"></div><br><br>  We see that on the <code>serial</code> (sequential) queue, the completion of closures occurs strictly in the order in which they arrived at execution, while on the <code>concurrent</code> (parallel) queue, the tasks end in an unpredictable way.  In addition, you can see that the total execution time of a certain group of tasks on the <code>serial</code> queue is much greater than the time to complete the same group of tasks on a <code>concurrent</code> queue.  On the <code>serial</code> (serial) queue at any current time, only one task is executed, and on a <code>concurrent</code> (parallel) queue, the number of tasks at any current time can vary. <br><br><h1>  Synchronous and asynchronous execution of tasks </h1><br>  Once the <code>queue</code> created, the task can be placed on it using two functions: <code><font color="#0000FF">sync</font></code> - synchronous execution with respect to the current queue and <code><font color="#0000FF">async</font></code> - asynchronous execution with respect to the current queue. <br><br>  The <code><font color="#0000FF">sync</font></code> function returns control to the current queue only after the task has completed, thereby blocking the current queue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/49f/da3/3d3/49fda33d32be4a6ebb511bf0530a8854.png" width="600" height="293"></div><br><br>  The <code><font color="#0000FF">async</font></code> function, in contrast to the <code><font color="#0000FF">sync</font></code> function, returns control to the current queue immediately after starting the job for execution in another queue, without waiting for it to complete.  Thus, the async function <code><font color="#0000FF">async</font></code> does not block the execution of tasks on the current queue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c32/c59/7b6/c32c597b60d24ae69f5fffe4ca155d9c.png" width="600" height="310"></div><br><br>  In the case of asynchronous execution as a sequential ( <code>serial</code> ) queue, the ‚Äúother queue‚Äù may be: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cfc/0fb/700/cfc0fb700a034acbab2cc25fc6e14f17.png" width="600" height="199"></div><br><br>  and parallel ( <code>concurrent</code> ) queue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/391/9fb/1ff/3919fb1ff81747dca78feabb45e3a9de.png" width="600" height="238"></div><br><br>  The task of the developer is only to select the queue and add the task (usually the closure) to this queue synchronously using the <code><font color="#0000FF">sync</font></code> function or asynchronously using the <code><font color="#0000FF">async</font></code> function, then <code>iOS</code> only works. <br><br>  Returning to the task presented at the very beginning of this post, we will switch the task of receiving data from the Data from Network to another queue: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/07b/a52/95c/07ba5295c1b540fb8fa2c0bb3d8da835.png" width="500" height="293"></div><br><br>  After getting the <code><font color="#0000FF">Data</font></code> from the network to another <code><font color="#0000FF">Dispatch Queue</font></code> , we send it back to the <code><b>Main thread</b></code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d3e/85e/84a/d3e85e84a6034f58aa0b4ae8d977d3c6.png" width="500" height="294"></div><br><br>  When we receive <code><font color="#0000FF">Data</font></code> data from the network on another Queue <code><font color="#0000FF">DispatchQueue</font></code> , <code><b>Main thread</b></code> is free and serves all events that occur on the <code>UI</code> .  Let's see what the real code looks like for this case: <br><br><img src="https://habrastorage.org/files/3c2/63f/1c5/3c263f1c570a4c35a4d22e56dbabf264.png"><br><br>  To load the imageURL <code><font color="#0000FF">imageURL</font></code> , which can take considerable time and block the <code><b>Main queue</b></code> , we ASINCHRONOUSLY switch the execution of this resource-intensive task to a global parallel queue with <code><font color="#0000FF">qos</font></code> quality of service equal to <code><font color="#0000FF">.utility</font></code> (more on this later): <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageURL: URL = URL(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>: <span class="hljs-string"><span class="hljs-string">"http://www.planetware.com/photos-large/F/france-paris-eiffel-tower.jpg"</span></span>)! <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> queue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(qos: .utility) queue.<span class="hljs-keyword"><span class="hljs-keyword">async</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? Data(contentsOf: imageURL){ DispatchQueue.main.<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> { image.image = UIImage(data: data) print(<span class="hljs-string"><span class="hljs-string">"Show image data"</span></span>) } print(<span class="hljs-string"><span class="hljs-string">"Did download image data"</span></span>) } }</code> </pre><br><br>  After receiving the <code><font color="#0000FF">data</font></code> we return to the <code><b>Main queue</b></code> again to update our <code>UI</code> <code><font color="#0000FF">image1.image</font></code> with this data. <br>  You see how easy it is to execute a switching chain to another queue in order to ‚Äúdivert‚Äù the execution of ‚Äúexpensive‚Äù tasks from the <code><b>Main queue</b></code> , and then return to it again.  The code is on the <a href="https://github.com/BestKora/GCD-Swift3">EnvironmentPlayground.playground on Github</a> . <br><br>  Notice that switching cost jobs from the <code><b>Main queue</b></code> to another thread is always <u>ASYNCHRONOUS</u> . <br>  You need to be very careful with the <code><font color="#0000FF">sync</font></code> method for queues, because the ‚Äúcurrent thread‚Äù has to wait for the job to complete on another queue.  <u><b>NEVER</b> call the <code><font color="#0000FF">sync</font></code> method on the <code><b>Main queue</b></code> , because it will cause your application to <code>deadlock</code></u> !  (more on that below) <br><br><h1>  Global queues </h1><br>  In addition to custom queues that need to be specifically created, the <code>iOS</code> system provides the developer with ready-made ( <code>out-of-the-box</code> ) global queues ( <code>queues</code> ).  Their 5: <br><br>  1.) a sequential <b><code>Main queue</code></b> in which all operations with the user interface ( <code>UI</code> ) take place: <br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> main = <span class="hljs-type"><span class="hljs-type">DispatchQueue</span></span>.main</code> </pre><br>  If you want to perform a function or closure that does something with a user interface ( <code>UI</code> ), with a <code><font color="#0000FF">UIButton</font></code> or with a <code><font color="#0000FF">UI--</font></code> , you must put this function or closure on the <b><code>Main queue</code></b> .  This queue has the highest priority among global queues. <br><br>  2.) 4 background <code>concurrent</code> (parallel) global queues with different quality of service <code><font color="#0000FF">qos</font></code> and, of course, different priorities: <br><pre> <code class="hljs pgsql">//   let userInteractiveQueue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(qos: .userInteractive) let userInitiatedQueue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(qos: .userInitiated) let utilityQueue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(qos: .utility) //    let backgroundQueue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>(.background) //   let defaultQueue = DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>()</code> </pre><br>  <code>Apple</code> awarded each of these lines with an abstract ‚Äúquality of service‚Äù <code><font color="#0000FF">qos</font></code> (abbreviation for <code>Quality of Service</code> ), and we must decide what it should be for our assignments. <br><br>  Below are the various <code><font color="#0000FF">qos</font></code> and explains what they are for: <br><br><ul><li>  <code><font color="#0000FF">.userInteractive</font></code> - for tasks that interact with the user at the moment and take very little time: animation, performed instantly;  the user does not want to do this in the <b><code>Main queue</code></b> , but this should be done as quickly as possible, since the user is interacting with me right now.  You can imagine a situation where a user runs a finger across the screen, and you need to calculate something related to intensive image processing, and you place the calculation in this queue.  The user continues to drive his finger across the screen, he does not immediately see the result, the result is a little behind the finger position on the screen, as the calculations take some time, but at least the <b><code>Main queue</code></b> still ‚Äúlistens‚Äù to our fingers and reacts to them.  This queue has a very high priority, but lower than that of the <b><code>Main queue</code></b> . </li><li>  <code><font color="#0000FF">.userInitiated</font></code> - for tasks that are initiated by the user and require feedback, but this is not inside an interactive event, the user is waiting for feedback to continue the interaction;  may take a few seconds;  has a high priority, but lower than the previous queue, </li><li>  <code><font color="#0000FF">.utulity</font></code> - for tasks that take some time to complete and do not require immediate feedback, for example, loading data or clearing a certain database.  Something is being done that the user is not asking for, but this is necessary for this application.  A task can take from a few seconds to a few minutes;  priority is lower than the previous queue, </li><li>  <code><font color="#0000FF">.background</font></code> - for tasks not related to visualization and not critical to the time of execution;  for example, <code>backups</code> or synchronization with a <code>web</code> service.  This is what usually runs in the background, only happens when no one wants any maintenance.  Just a background task that takes considerable time from minutes to hours;  has the lowest priority among all global queues. </li></ul><br>  There is also the Global <code>concurrency</code> default <code><font color="#0000FF">.default</font></code> , which reports a lack of information about the ‚Äúquality of service‚Äù <code><font color="#0000FF">qos</font></code> .  It is created using the operator: <br><pre> <code class="hljs cs">DispatchQueue.<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>()</code> </pre><br>  If it is possible to determine <code><font color="#0000FF">qos</font></code> information from other sources, then it is used; if not, then <code><font color="#0000FF">qos</font></code> used between <code><font color="#0000FF">.userInitiated</font></code> and <code><font color="#0000FF">.utility</font></code> . <br><br>  It is important to understand that all these global queues are <u>SYSTEM</u> global queues and our tasks are not the only tasks in this queue!  It is also important to know that all global queues, except one, are <code>concurrent</code> (parallel) queues. <br><br><h1>  Global Serial Queue for the user interface - Main queue </h1><br>  Apple provides us with a single GLOBAL <code>serial</code> (SERIAL) queue - this is the <b><code>Main queue</code></b> mentioned above.  It is undesirable to perform resource-intensive operations (for example, downloading data from the network) that are not related to changing the <code>UI</code> on this queue so as not to freeze the <code>UI</code> for the duration of this operation and to preserve the responsiveness of the user interface to user actions at any time, for example on gestures. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/947/064/a21/947064a217b2454a8b1b629eaad4057c.png" width="600" height="160"></div><br><br>  It is strongly recommended to ‚Äúdivert‚Äù such resource-intensive operations to other threads or queues: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/253/e8a/99b/253e8a99b42c46aba8c17af901618fc7.png" width="600" height="226"></div><br><br>  There is one more rigid requirement - ONLY on the <b><code>Main queue</code></b> we can change <code>UI</code> elements. <br><br>  This is because we want the <b><code>Main queue</code></b> be not only ‚Äúresponsive‚Äù to actions with the <code>UI</code> (yes, this is the main reason), but we also want the user interface to be protected from ‚Äúdebugging‚Äù in a multithreaded environment, that is, a reaction to user actions would be performed strictly sequentially in an orderly manner.  If we allow our <code>UI</code> elements to perform their actions in different queues, then it may happen that drawing will occur at different speeds and actions will intersect, which will lead to complete unpredictability on the screen.  We use the <b><code>Main queue</code></b> as a kind of ‚Äúsynchronization point‚Äù, to which everyone who wants to ‚Äúdraw‚Äù on the screen returns. <br><br><h1>  Multithreading problems </h1><br>  As soon as we allow tasks to work in parallel, there are problems related to the fact that different tasks will want to gain access to the same resources. <br>  There are three main problems: <br><br><ul><li>  <b><code>race condition</code></b> - an error in the design of a multi-threaded system or application in which the operation of the system or application depends on the order in which the parts of the code are executed </li><li>  <b><code>priority inversion</code></b> </li><li>  <b><code>deadlock</code></b> - a situation in a multi-threaded system in which several threads are in a state of infinite waiting for resources occupied by these threads themselves </li></ul><br><br><h2>  Race condition </h2><br>  We can reproduce the simplest case of <code>race condition</code> if we change the <code><font color="#0000FF">value</font></code> variable asynchronously to a <code>private</code> queue, and show the <code><font color="#0000FF">value</font></code> on the current thread: <br><br><img src="https://habrastorage.org/files/625/51a/fc7/62551afc7c57436eaeab7a4a67dfc9b2.png"><br><br>  We have the usual <code><font color="#0000FF">value</font></code> variable and the usual <code><font color="#0000FF">changeValue</font></code> function to change it, and deliberately we did it with the help of the <code><font color="#0000FF">sleep(1)</font></code> operator so that changing the value variable takes a considerable amount of time.  If we run the <code><font color="#0000FF">changeValue</font></code> function <code><font color="#0000FF">changeValue</font></code> using <code><font color="#0000FF">async</font></code> , then before it comes to placing the changed value in the <code><font color="#0000FF">value</font></code> variable, the <code><font color="#0000FF">value</font></code> variable on the current stream can be reset to a different value, this is the <code>race condition</code> .  This code corresponds to the seal in the form: <br><br><img src="https://habrastorage.org/files/588/996/d03/588996d0319646c4ad766285485fa0ea.png" width="600" height="69"><br><br>  and a diagram that clearly shows the phenomenon called " <code>race condition</code> ": <br><br><img src="https://habrastorage.org/files/4e9/ddb/5de/4e9ddb5deb494edabfc975da717f7958.png"><br><br>  Let's replace the <code><font color="#0000FF">async</font></code> method with <code><font color="#0000FF">sync</font></code> : <br><br><img src="https://habrastorage.org/files/75e/608/5ea/75e6085ea469425395705e93e0bf3bf6.png"><br><br>  Both print and result have changed: <br><br><img src="https://habrastorage.org/files/940/871/63a/94087163acb44a83906be79f57ba44fb.png" width="600" height="70">  &lt;img <br><br>  and a diagram that lacks a phenomenon called " <code>race condition</code> ": <br><br><img src="https://habrastorage.org/files/cfe/487/2d8/cfe4872d84724dc6a5d6dea169957456.png"><br><br>  We see that although it is necessary to be very attentive with the <code><font color="#0000FF">sync</font></code> method for queues, because the ‚Äúcurrent thread‚Äù has to wait for the completion of a task on another queue, the <code><font color="#0000FF">sync</font></code> method turns out to be very useful in order to avoid race conditions.  The code for simulating the " <code>race condition</code> " phenomenon can be viewed on the <a href="https://github.com/BestKora/GCD-Swift3">firstPlayground.playground on Github</a> .  Later we will show the real " <code>race condition</code> " when forming a string from characters received on different streams.  An elegant way of forming a string using ‚Äúbarriers‚Äù will also be proposed, which will allow to avoid ‚Äú <code>race conditions</code> ‚Äù and make the string being thread-safe. <br><br><h2>  Priority inversion </h2><br>  The concept of <code> </code> is closely related to resource locking: <br><br><img src="https://habrastorage.org/files/2a4/081/574/2a40815749274c3897e581524cc2f539.png" width="600" height="256"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose there are two tasks in the system with low (A) and high (B) priority. At time T1, task (A) locks the resource and starts servicing it. At time T2, task (B) crowds out the low-priority task (A) and tries to seize the resource at time T3. But since the resource is locked, task (B) is transferred to the waiting, and task (A) continues execution. At time T4, task (A) completes the maintenance of the resource and unlocks it. Since the resource is awaiting task (B), it immediately starts execution. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The time interval (T4-T3) is called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limited priority inversion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this interval, there is a logical inconsistency with the rules of planning - a task with a higher priority is pending while a low priority task is being performed.</font></font><br><br>      .      :  (),    ()   (): <br><br><img src="https://habrastorage.org/files/011/044/6fb/0110446fbda54b8aa59534af9b0a8f78.png" width="600" height="224"><br><br>     (),     (),      ‚Äî   .  ,   ()  (),    ()    .  ()     ,          (T5-T4).  ,  ()       ,    (),   ().    (T6-T3)    .      . <br><br>        ,        ,  .      ¬´¬ª    . <br><br>   ,     <code><font color="#0000FF">DispatchWorkItem</font></code>        . <br><br><h2>   (deadlock) </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mutual blocking is an emergency state of the system, which can occur when nested resource locks. Suppose there are two tasks in the system with low (A) and high (B) priority, which use two resources - X and Y: </font></font><br><br><img src="https://habrastorage.org/files/9d8/3a9/844/9d83a98445554b0486486c287d07b16d.png" width="600" height="225"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At time T1, task (A) blocks resource X. Then, at time T2, task (A) displaces more priority task (B), which, at time T3, blocks resource Y. If task (B) attempts to block resource X (T4) without releasing resource Y, it will be transferred to the idle state, and task (A) will continue. If at time T5, task (A) attempts to block resource Y without releasing X, a deadlock state will occur ‚Äî none of tasks (A) and (B) will be able to get control.</font></font><br><br>     ,      ()    .    ,    ,       . <br>    ,    ,        ,      main queue  sync,       ( <code>deadock</code> ). <br><br> <b><u><font color="#FF0000">  </font></u></b>  <code><font color="#0000FF">sync</font></code>  <code>main queue</code> ,        ( <code>deadlock</code> )  ! <br><br><h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the experiments, we will use the </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module </font></font><code><font color="#0000FF">PlaygroundSupport</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the class </font><font style="vertical-align: inherit;">that is configured for an infinite amount of time using the module </font></font><code><font color="#0000FF">PlaygroudPage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that we can complete all the tasks placed in the queue and get access to </font></font><b><code>main queue</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We can stop waiting for some event on the </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c using the command </font></font><code><font color="#0000FF">PlaygroundPage.current.finishExecution()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another cool opportunity to </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the ability to interact with the "live" </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the command</font></font><br><pre> <code class="hljs">PlaygroundPage.liveView = viewController</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and Editor's Assistant ( </font></font><code>Assistant Editor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">If, for example, you create </font></font><code><font color="#0000FF">viewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in order to see yours </font></font><code><font color="#0000FF">viewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you just need to configure </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for unlimited code execution and enable the Editor Assistant ( </font></font><code>Assistant Editor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">You have to comment out the command </font></font><code><font color="#0000FF">PlaygroundPage.current.finishExecution()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and stop it </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manually. </font></font><br><br><img src="https://habrastorage.org/files/4df/034/dfc/4df034dfc92c49aeafe1b0865d2ee172.png"><br><br> <code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the experimental environment pattern code, it has the name </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EnvironmentPlayground.playground and is on Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. First experiment. </font><font style="vertical-align: inherit;">Global queues and tasks</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with simple experiments. </font><font style="vertical-align: inherit;">We also define a number of global queues: one consistent </font></font><code><font color="#0000FF">mainQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- it is </font></font><b><code>main queue</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and four parallel ( </font></font><b><code>concurrent</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><b><code>queues</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code><font color="#0000FF">userInteractiveQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">userQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code><font color="#0000FF">utilityQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">backgroundQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">You can set </font></font><b><code>concurrent queue</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the default - </font></font><code><font color="#0000FF">defautQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/7c2/c04/586/7c2c0458682a4b6195365c69f9abae0f.png" width="600" height="503"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a job, </font></font><code><font color="#0000FF">task</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">choose to print any ten identical characters and the priority of the current queue. </font></font><code><font color="#0000FF">taskHIGH</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will launch </font><font style="vertical-align: inherit;">another task </font><font style="vertical-align: inherit;">, which will print one character, with high priority:</font></font><br><br><img src="https://habrastorage.org/files/eeb/a88/223/eeba8822320940a4b55ae0547d9cdcdb.png" width="600" height="212"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. The second experiment will apply to </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">synchronously</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronously</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the global queue</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once you have a global queue, for example, </font></font><code><font color="#0000FF">userQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can perform tasks on it either </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SYNCHRONOUS</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , using the method </font></font><code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASYNCHRONNO</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the method </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><img src="https://habrastorage.org/files/1be/bd5/993/1bebd59937b946f0994e23de7e096359.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the case of synchronous </font></font><code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execution, we see that all tasks start sequentially, one after another, and the next one clearly waits for the completion of the previous one. Moreover, as an optimization, the sync function can trigger a closure on the current thread, if possible, and the priority of the global queue will not matter. This is what we see. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the case of asynchronous </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execution, we see that tasks </font></font><br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start without waiting for the tasks to complete </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the priority of the global queue</font></font><code><font color="#0000FF">userQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">higher priority code execution on </font></font><code>Playground</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, tasks </font></font><code><font color="#0000FF">userQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are performed more often.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. The third experiment. </font><font style="vertical-align: inherit;">Private serial queues</font></font></h3><br>        <code>Private</code>      <code><font color="#0000FF">DispatchQueue</font></code> : <br><br><img src="https://habrastorage.org/files/415/932/073/4159320735f842c2bab1a2d3dd346772.png" width="600" height="64"><br><br> ,       , ‚Äî    <code><font color="#0000FF">label</font></code> ,  <code>Apple</code>      <code>DNS</code>  ( <code>‚Äúcom.bestkora.mySerial‚Äù</code> ),          .   ,  ,      ,     .          <code><font color="#0000FF">label</font></code>   <code>Private</code> ,      ( <code><font color="#0000FF">.serial</font></code> ) .    ,      ,       . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at how user </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sequential queues work </font></font><code><font color="#0000FF">mySerialQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when using </font></font><code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">methods: </font></font><br><br><img src="https://habrastorage.org/files/633/9f8/1cd/6339f81cd8f34041a240082f0545db47.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the case of </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">synchronous,</font></font></u> <code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we see the same situation as in experiment 3 ‚Äî the type of queue does not matter, because as an optimization, the function </font></font><code><font color="#0000FF">sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can trigger a closure on the current flow. </font><font style="vertical-align: inherit;">This is what we see. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What happens if we use the </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method and allow the serial queue </font></font><code><font color="#0000FF">mySerialQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to execute jobs </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronously with respect to the current queue? </font><font style="vertical-align: inherit;">In this case, the execution of the program does not stop and does not wait until this task is completed in the queue </font></font><code><font color="#0000FF">mySerialQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">management will immediately proceed to the execution of tasks</font></font><br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and will perform them at the same time as the tasks </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><br><h3> 4.      QoS   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's assign our </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sequential queue the </font></font><code><font color="#0000FF">serialPriorityQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quality of service qos, equal to .userInitiated, and put asynchronously into this queue first tasks </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and then </font></font><br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This experiment will convince us that our new queue is </font></font><code><font color="#0000FF">serialPriorityQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indeed consistent, and despite using the </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method, the tasks are performed sequentially in the order of receipt: </font></font><br><br><img src="https://habrastorage.org/files/0ab/fbc/7c0/0abfbc7c06ff46aca33529e91cdee03c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, for multi-threaded code execution it is not enough to use the method </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you need to have a lot of threads either due to different queues, or due to the fact that the queue itself is I am parallel ( </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Below in experiment 5 with parallel ( </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) queues we will see a similar experiment with Private parallel ( </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) queue</font></font><code><font color="#0000FF">workerQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but there will be a completely different picture, when we put the same tasks in this queue. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's use sequential </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queues with different priorities for asynchronous setting of tasks in this queue </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then </font></font><br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue of </font><font style="vertical-align: inherit;">tasks </font></font><code><font color="#0000FF">serialPriorityQueue1</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code><font color="#0000FF">qos .userInitiated</font></code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue </font></font><code><font color="#0000FF">serialPriorityQueue2</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code><font color="#0000FF">qos .background</font></code> <br><br><img src="https://habrastorage.org/files/3a9/45e/00a/3a945e00a4d34d3d8d93d4dba5678ad9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, multithreaded tasks are executed, and tasks are more often executed on queues </font></font><code><font color="#0000FF">serialPriorityQueue1</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a higher priority quality of service </font></font><code><font color="#0000FF">qos: .userIniatated</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can delay the execution of tasks on any queue </font></font><code><font color="#0000FF">DispatchQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a specified time, for example, by </font></font><code><font color="#0000FF">now() + 0.1</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the function </font></font><code><font color="#0000FF">asyncAfter</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and also change the quality of service </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/files/5d1/c46/136/5d1c4613699e4c3a92c7025ad92abce5.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. The fifth experiment will concern private parallel (concurrent) queues. </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to initialize the </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parallel ( </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) queue, it is sufficient to specify the argument </font></font><code><font color="#0000FF">attributes</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value equal </font><font style="vertical-align: inherit;">to when initializing the Private queue </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If you do not specify this argument, the </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue will be sequential ( </font></font><code><font color="#0000FF">.serial</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The argument is </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also not required and can be skipped without any problems. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's assign our parallel queue a </font></font><code><font color="#0000FF">workerQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quality of service </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal to </font></font><code><font color="#0000FF">.userInitiated</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and set tasks asynchronously into this queue first </font></font><br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then </font></font><br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our new parallel queue is </font></font><code><font color="#0000FF">workerQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indeed parallel, and the tasks in it are executed simultaneously, although everything we did compared with the fourth experiment (one consistent turn</font></font><code><font color="#0000FF">serialPriorityQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), this set the argument to be </font></font><code><font color="#0000FF">attributes</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/a7c/8ef/137/a7c8ef1377424a3b8484f5f9cb62daf1.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The picture is completely different compared to one consecutive queue. If there all tasks are performed strictly in the order in which they are submitted for execution, then for our parallel (multi-threaded) queue </font></font><code><font color="#0000FF">workerQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which can be ‚Äúsplit‚Äù into several threads, the tasks are actually executed in parallel: some tasks with the symbol </font></font><br><img src="https://habrastorage.org/files/442/d34/28b/442d3428bf8744dfb4054f328f5c9d63.png" width="400" height="29"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">being later queued </font></font><code><font color="#0000FF">workerQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, run faster on parallel thread. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's use parallel </font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queues with different priorities: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue </font></font><code><font color="#0000FF">workerQueue1</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code><font color="#0000FF">qos .userInitiated</font></code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue </font></font><code><font color="#0000FF">workerQueue2</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c </font></font><code><font color="#0000FF">qos .background</font></code> <br><br><img src="https://habrastorage.org/files/ae9/4b8/e9f/ae94b8e9f74847efb5b85c4291013e2a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the same picture as with different consecutive</font></font><code>Private</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bursts in the second experiment. </font><font style="vertical-align: inherit;">We see that tasks are more often executed on the waiting list </font></font><code><font color="#0000FF">workerQueue1</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which has a higher priority. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can create queues with deferred execution using an argument </font></font><code><font color="#0000FF">attributes</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then activate the execution of tasks on it at any suitable time using the method </font></font><code><font color="#0000FF">activate()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/files/603/0b6/7be/6030b67be5ac4c53a3a1160f02c9b4c7.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. The sixth experiment involves the use of DispatchWorkItem objects. </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to have additional capabilities for managing the execution of various tasks on the </font></font><code>Dispatch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queues, you can create </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for which you can set the quality of service </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and it will affect its implementation: </font></font><br><br><img src="https://habrastorage.org/files/faa/3f3/be0/faa3f3be05b34eaa9757c7499b708d2f.png" width="600" height="134"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting the flag </font></font><code><font color="#0000FF">[.enforceQoS]</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">during the preparation </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we get a higher priority for the task </font></font><code><font color="#0000FF">highPriorityItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">before the other tasks on that the same queue: </font></font><br><br><img src="https://habrastorage.org/files/b3e/019/897/b3e0198976ff4937a39e423f2545574c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This allows you to forcibly increase the priority of a specific task for a </font></font><code><font color="#0000FF">Dispatch Queue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certain quality of service </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and, thus, to deal with the phenomenon of ‚Äúpriority inversion‚Äù. We see that despite the fact that the two tasks </font></font><code><font color="#0000FF">highPriorityItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start the most recent, they are performed at the very beginning thanks to the flag </font></font><code><font color="#0000FF">[.enforceQoS]</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the priority increase to</font></font><code><font color="#0000FF">.userInteractive</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In addition, the task </font></font><code><font color="#0000FF">highPriorityItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be run multiple times on different queues. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we remove the flag </font></font><code><font color="#0000FF">[.enforceQoS]</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/c2f/83f/136/c2f83f1360724da2b015cb7532bfd7e8.png" width="600" height="93"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the tasks </font></font><code><font color="#0000FF">highPriorityItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will take the quality of service </font></font><code><font color="#0000FF">qos</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is set for the queue on which they are launched: </font></font><br><br><img src="https://habrastorage.org/files/1f3/d71/861/1f3d718618e04d438a14aaa209e7b465.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But still, they get to the very beginning of the corresponding queues. The code for all of these experiments is on </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firstPlayground.playground on Github.</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The class </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has a property </font></font><code><font color="#0000FF">isCancelled</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and a number of methods: </font></font><br><br><img src="https://habrastorage.org/files/93f/5b4/a92/93f5b4a921ea45fb98d25370c5841a23.png" width="550" height="292"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the presence of a method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font><code><font color="#0000FF">DispatchWorkItem</font></code> <code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it still does not allow removing closures that have already started on a particular queue. What we can currently do is mark </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as ‚Äúdeleted‚Äù using the method </font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If the method call</font></font><code><font color="#0000FF">cancel()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">happens before it </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is queued using the method </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will not be executed. One of the reasons why it is sometimes necessary to use a mechanism </font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rather than </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is that it </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not know how to remove closures that started on a particular queue. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use the class </font></font><code><font color="#0000FF">DispatchWorkItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and its method </font></font><code><font color="#0000FF">notify (queue:, execute:)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as well as the class instance method</font></font><code><font color="#0000FF">DispatchQueue</font></code> <br><br><pre> <code class="hljs lisp">async(<span class="hljs-name"><span class="hljs-name">execute</span></span> workItem: DispatchWorkItem)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to solve the problem given at the very beginning of the post - downloading images from the network: </font></font><br><br><img src="https://habrastorage.org/files/6de/817/317/6de8173174d74a5b997d631e6af28e49.png" width="600" height="386"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We form a synchronous task in the form of a </font></font><code><font color="#0000FF">workItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class </font><font style="vertical-align: inherit;">instance </font></font><code><font color="#0000FF">DispatchWorlItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which consists in receiving data </font></font><code><font color="#0000FF">data</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the "network" at a given </font></font><code><font color="#0000FF">imageURL</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">address. </font><font style="vertical-align: inherit;">Perform an asynchronous job </font></font><code><font color="#0000FF">workItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on a parallel global queue </font></font><code><font color="#0000FF">queue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with quality of service </font></font><code><font color="#0000FF">qos: .utility</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the function</font></font><br><pre> <code class="hljs cs">queue.<span class="hljs-keyword"><span class="hljs-keyword">async</span></span>(execute: workItem)</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using the function </font></font><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">workItem</span></span>.notify(queue: <span class="hljs-type"><span class="hljs-type">DispatchQueue</span></span>.main) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageData = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eiffelImage</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">image</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UIImage</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imageData</span></span></span><span class="hljs-class">)} }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we are waiting for notification of the end of data loading in </font></font><code><font color="#0000FF">data</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Once this happens, we update the image of the element </font></font><code>UI</code> <code><font color="#0000FF">eiffelImage</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/a0d/c93/2d7/a0dc932d7c854e16a2c0cc62b7d93417.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is on the </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadImage.playground on Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 1. Code options for downloading images from the network </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have two synchronous tasks: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retrieving data from the network</font></font><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">let</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = try? </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contentsOf</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imageURL</span></span></span><span class="hljs-class">)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and update based on </font></font><code><font color="#0000FF">data</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user interface data ( </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">eiffelImage</span></span>.image = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">: </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a typical pattern, performed using multi-threading mechanisms </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, when you need to do some work in the background thread, and then return the result to the main thread for display, as components </font></font><code>UIKit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can work exclusively from the main thread. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This can be done either in the classical way: </font></font><br><br><img src="https://habrastorage.org/files/fe2/485/e6b/fe2485e6b0a445b6b798414564999dd6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">either using the ready asynchronous API, using </font></font><code><font color="#0000FF">URLSession</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/a86/b5d/d93/a86b5dd93d19429aa658ccc5a884f36a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or using </font></font><code><font color="#0000FF">DispatchWorlItem</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/541/3c2/28a/5413c228ae3a46f7a26d7bde29233ca9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, we can always ‚Äúwrap‚Äù our synchronous puzzle into the asynchronous ‚Äúshell‚Äù and execute it: </font></font><br><br><img src="https://habrastorage.org/files/3e9/e50/ef0/3e9e50ef07434833b9c6f0ab5d48216f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code for this pattern is on </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadImage.playground on github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 2. Features of downloading images from the network for Table View and Collection View using GCD </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider as an example a very simple application consisting of only one </font></font><code>Image Table View Controller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose table cells contain only images downloaded from the Internet and an activity indicator that shows the loading process: </font></font><br><br><img src="https://habrastorage.org/files/2db/570/d4f/2db570d4f4f14f29977724fa12bf2f4e.png" width="400" height="341"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here‚Äôs what the class </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that serves the screen fragment </font><font style="vertical-align: inherit;">looks like </font></font><code>Image Table View Controller</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/c11/188/96e/c1118896ee43493eacd783e83e67b83d.png" width="600" height="383"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the class </font></font><code><font color="#0000FF">ImageTableViewCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the table cell that is loaded image: The </font></font><br><br><img src="https://habrastorage.org/files/a21/015/ab4/a21015ab487f4bb8931db44a1a07eeed.png" width="500" height="377"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image is loaded in the usual classical way. </font><font style="vertical-align: inherit;">The model for the class </font></font><code><font color="#0000FF">ImageTableViewController</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an array of 8 </font></font><code>URLs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Eiffel Tower </font></font></li><li>  Venice </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scottish castle </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Satellite Cassini - loaded from the network much longer than the rest </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Eiffel Tower </font></font></li><li>  Venice </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scottish castle </font></font></li><li>  Arctic </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we launch the application and start scrolling down quickly enough to see all 8 images, we will find that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Cassini Satellite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will not load until we leave the screen. Obviously, it takes significantly longer to load than all the others. </font></font><br><br><img src="https://habrastorage.org/files/e31/90f/380/e3190f38002d4450b3fe892d3a083e0d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, having scrolled to the end and having seen ‚ÄúArctic‚Äù in the most recent cell, we suddenly find that after some very short time it will be replaced with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassini Satellite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><img src="https://habrastorage.org/files/4a5/067/031/4a50670314b94b65980d9a41ef15b151.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the incorrect functioning of such a simple application.</font></font> What is the matter?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact is that the cells in the tables are reusable due to the method </font></font><code><font color="#0000FF">dequeueReusableCell</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Each time a cell (new or reused) gets into the screen, the image is launched asynchronously from the network (the ‚Äúwheel‚Äù is spinning), as soon as the download is completed and the image is received, </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this cell </font><font style="vertical-align: inherit;">is updated </font><font style="vertical-align: inherit;">. But we do not wait for the image to load, we continue to scroll the table and the cell ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassini</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) leaves the screen without updating its own </font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, a new image should appear at the bottom and the same cell left on the screen will be reused, but for a different image (‚ÄúArctic‚Äù), which will quickly load and update</font></font><code>UI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. At this time, the Cassini download launched in this cell will return and update the screen, which is wrong. This is because we are launching different things that work with the network in different streams. They return at different times: </font></font><br><br><img src="https://habrastorage.org/files/154/a74/14a/154a7414aec94714b8c0a7e3e5d17b5c.png" width="600" height="461"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can we remedy the situation? Within the mechanism, </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we cannot cancel the loading of an image of a cell that has left the screen, but we can, when we come </font></font><code><font color="#0000FF">imageData</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the network, check </font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which caused the download of this data </font></font><code><font color="#0000FF">url</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and compare it with what the user wants to have in this cell at the moment </font></font><code><font color="#0000FF">imageURL</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><img src="https://habrastorage.org/files/c53/603/880/c536038803064446abf239b6d34ad445.png" width="500" height="372"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now everything will work correctly. </font><font style="vertical-align: inherit;">Thus, multi-threaded programming requires non-standard imagination. </font><font style="vertical-align: inherit;">The fact is that some things in multithreaded programming are carried out in a different order than the written code. </font><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCDTableViewController</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application </font><font style="vertical-align: inherit;">is on </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pattern 3. Using DispatchGroup groups </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have several tasks that need to be performed asynchronously and wait for them to complete, then a group is applied </font></font><code><font color="#0000FF">DispatchGroup</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is very easy to create:</font></font><br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageGroup = <span class="hljs-type"><span class="hljs-type">DispatchGroup</span></span>()</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose we need to load 4 different images ‚Äúfrom the network‚Äù: </font></font><br><br><img src="https://habrastorage.org/files/0bf/bc9/693/0bfbc9693dd84808b7ffa384cae062e7.png" width="400" height="350"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code><font color="#0000FF">queue.async(group: imageGroup)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to add any task (synchronous) to a group that is executed on any queue </font></font><code><font color="#0000FF">queue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/d0f/a06/f93/d0fa06f933f947d79efbb1fc014d7042.png" width="600" height="406"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create a group </font></font><code><font color="#0000FF">imageGroup</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and place </font></font><code><font color="#0000FF">async (group: imageGroup)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two tasks for asynchronous loading of images into the global parallel queue </font><font style="vertical-align: inherit;">using this method </font></font><code><font color="#0000FF">DispatchQueue.global()</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and two tasks of asynchronous loading of images into a global parallel queue </font></font><code><font color="#0000FF">DispatchQueue.global(qos:.userInitiated)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with quality of service </font></font><code><font color="#0000FF">.userInitiated</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is important that tasks functioning on different queues can be added to the same group. When all the tasks in the group are completed, the function </font></font><code><font color="#0000FF">notify</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font><font style="vertical-align: inherit;">called </font><font style="vertical-align: inherit;">- this is a kind of callback block for the whole group, which places all the images on the screen at the same time:</font></font><br><br><img src="https://habrastorage.org/files/3d3/15b/0df/3d315b0df6eb4cbeb5b15edf19ad4343.png" width="650" height="235"><br><br>   -  ,            <code><font color="#0000FF">async (group: imageGroup)</font></code> .  -  ,        ,           .         <a href="https://github.com/BestKora/GCD-Swift3">Playground GroupSyncTasks.playground  Github</a> . <br><br>         ,   ,      :  <code><font color="#0000FF">enter()</font></code>  ,   <code><font color="#0000FF">leave()</font></code> .           <a href="https://github.com/BestKora/GCD-Swift3">Playground GroupAsyncTasks.playground  Github</a> .             . <br><br><img src="https://habrastorage.org/files/8dc/606/902/8dc606902dd449c0985938b06eaf2322.png" width="650" height="540"><br><br>            ,   ,   ,     .                  :          ,        ,    <code><font color="#0000FF">asyncGroup ()</font></code>  <code><font color="#0000FF">asyncUsual ()</font></code>    : <br><br><img src="https://habrastorage.org/files/e1e/bc2/058/e1ebc205827843aa9e40c0fd504c5ae7.png" width="600" height="363"><br><br>      :   : <br><br><img src="https://habrastorage.org/files/2f8/380/97b/2f838097b5ae4de0af9e0e9e1bd84111.png" width="600" height="620"><br><br>    . <br><br><h3>  4. - (thread-safe) .   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's go back to our first experiment with bursts </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>Swift 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and try to maintain a chronological (vertical) sequence of tasks in a row, and thereby present the user with the result of the tasks on different lines in a horizontal way: </font></font><br><br><img src="https://habrastorage.org/files/b71/39e/908/b7139e908bf94316a945bac9307eca06.png" width="500" height="405"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have to say that I used to store the results as a normal </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NEpotochno- safe</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><code>Swift 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">string </font></font><code><font color="#0000FF">usualString: String</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as well as thread-safe string </font></font><code><font color="#0000FF">safeString: ThreadSafeString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> safeString = <span class="hljs-type"><span class="hljs-type">ThreadSafeString</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usualString = <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The purpose of this section is to show how the in-safe string in should be arranged </font></font><code>Swift 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so more about that later. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All experiments with a stream-safe string will occur on the </font></font><a href="https://github.com/BestKora/GCD-Swift3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Playground GCDPlayground.playground on Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will slightly change the tasks in order to accumulate information in both lines </font></font><code><font color="#0000FF">usualString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><font color="#0000FF">safeString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/ac0/abd/a30/ac0abda30db941f998a8196fa161b04e.png" width="600" height="248"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In </font></font><code>Swift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">any variable declared with a keyword, it </font></font><code><font color="#0000FF">let</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is constant, and therefore thread safe ( </font></font><code>thread-safe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). A declaration of a variable with a keyword </font></font><code><font color="#0000FF">var</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">makes the variable mutable ( </font></font><code>mutable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and non-cloud safe (</font></font><code>thread-safe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) until it is designed in a special way. </font><font style="vertical-align: inherit;">If two threads start changing the same memory block at the same time, damage to this memory block may occur. </font><font style="vertical-align: inherit;">In addition, if you read a variable on one thread while it is updating its value on another thread, then you risk reading the ‚Äúold value‚Äù, that is, there is a race condition ( </font></font><code>race condition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ideal for thread-safety would be the case when</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reads happen synchronously and multithreading </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> records must be asynchronous and must be the only task that is currently working with this variable </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortunately, it </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provides us with an elegant way to solve using barriers ( </font></font><code>barrier</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and isolation queues:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb5/76f/612/cb576f61217b4578a9d80ba2870e4a6a.png" width="600" height="322"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Barriers </font></font><code>GCD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do one interesting thing - they are waiting for the moment when the queue will be completely empty, before making its closure. As soon as the barrier begins to execute its closure, it ensures that the queue does not perform any other closures during this time and essentially works as a synchronous function. As soon as the barrier closure ends, the queue returns to its normal operation, providing a guarantee that no recording will be carried out simultaneously with reading or other writing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see what the thread-safe class will look like </font></font><code><font color="#0000FF">ThreadSafeString</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><br><img src="https://habrastorage.org/files/cce/777/b6d/cce777b6db6a4af191494b44ed5ee959.png" width="600" height="378"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function </font></font><code><font color="#0000FF">isolationQueue.sync</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will send a ‚Äúread‚Äù closure </font></font><code><font color="#0000FF">{result = self.internalString}</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to our isolation queue </font></font><code><font color="#0000FF">isolationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and wait for the end, before returning the execution result</font></font><code><font color="#0000FF">result</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After that we will have the result of reading. If you do not make a call synchronous, then you need to introduce a callback block. Due to the fact that the queue is </font></font><code><font color="#0000FF">isolationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parallel ( </font></font><code><font color="#0000FF">.concurrent</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), such synchronous reads can be performed on several pieces simultaneously. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function </font></font><code><font color="#0000FF">isolationQueue.async (flags: .barrier)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will send a ‚Äúrecord‚Äù, ‚Äúadd‚Äù or ‚Äúinitialization‚Äù closure to the isolation queue </font></font><code><font color="#0000FF">isolationQueue</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The function </font></font><code><font color="#0000FF">async</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">means that control will be returned before the ‚Äúrecord‚Äù, ‚Äúadd‚Äù or ‚Äúinitialization‚Äù closure is actually executed. The barrier part </font></font><code><font color="#0000FF">(flags: .barrier)</font></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">means that the closure will not be executed until each closure in the queue has completed its execution. Other closures will be placed after the barrier one and executed after the barrier is completed.</font></font><br>    <code><font color="#0000FF">DispatchQueues</font></code> ,  - ( <code>thread-safe</code> )  <code><font color="#0000FF">safeString: ThreadSafeString</font></code>    <code><font color="#0000FF">usualString: String</font></code> ,    <a href="https://github.com/BestKora/GCD-Swift3">Playground GCDPlayground.playground  Github</a> . <br><br>    . <br><br> 1.  <code><font color="#0000FF">sync</font></code>     <code><font color="#0000FF">DispatchQueue.global(qos: .userInitiated)</font></code>    <code>Playground</code> : <br><br><img src="https://habrastorage.org/files/5b6/71a/9a6/5b671a9a6f0945188497cb7bab6584f9.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b></b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 2.  <code><font color="#0000FF">async</font></code>     <code><font color="#0000FF">DispatchQueue.global(qos: .userInitiated)</font></code>    <code>Playground</code> : <br><br><img src="https://habrastorage.org/files/7a5/8f4/edb/7a58f4edbdc8404998d4550a546f5fe0.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 3.  <code><font color="#0000FF">sync</font></code>  <code>Private</code>   <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial")</font></code>    Playground: <br><br><img src="https://habrastorage.org/files/d9d/8e9/d59/d9d8e9d597e640a5a29b4f09b6c2d18f.png"><br><br>     -  <code><font color="#0000FF">usualString</font></code> , <b></b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 4.  <code><font color="#0000FF">async</font></code>  <code>Private</code>   <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial")</font></code>    <code>Playground</code> : <br><br><img src="https://habrastorage.org/files/009/08d/c07/00908dc0791a4192bd2517af0123bb52.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 5.  <code><font color="#0000FF">async</font></code>   <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br>  <code>Private</code>   <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial", qos : .userInitiated)</font></code> : <br><br><img src="https://habrastorage.org/files/f15/016/125/f150161255004ed8bf0b28a906a7a226.png"><br><br>     -  <code><font color="#0000FF">usualString</font></code> , <b></b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 6.  <code><font color="#0000FF">async</font></code>   <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br>   <code>Private</code>   <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial", qos : .userInitiated)</font></code>  <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial", qos : .background)</font></code> : <br><br><img src="https://habrastorage.org/files/862/f80/3d3/862f803d306441809b432fb23072c4b7.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 7.  <code><font color="#0000FF">async</font></code>   <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br>  <code>Private</code>   <code><font color="#0000FF">DispatchQueue (label: "com.bestkora.mySerial", qos : .userInitiated, attributes: .concurrent)</font></code> : <br><br><img src="https://habrastorage.org/files/0f8/fb3/d84/0f8fb3d8462641abb5dac4c97ba1ab34.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 8.  <code><font color="#0000FF">async</font></code>   <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br>   <code>Private</code>    <code><font color="#0000FF">qos : .userInitiated</font></code>  <code><font color="#0000FF">qos : .background</font></code> : <br><br><img src="https://habrastorage.org/files/f65/fbe/1f2/f65fbe1f2ae244499f4e8988533e71b0.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 9.  <code><font color="#0000FF">asyncAfter (deadline: .now() + 0.0, qos: .userInteractive)</font></code> c  : <br><br><img src="https://habrastorage.org/files/d81/24c/668/d8124c6682e84ef99ab04c3e64779e65.png"><br><br>    -  <code><font color="#0000FF">usualString</font></code> , <b> </b>    -  <code><font color="#0000FF">safeString</font></code> . <br><br> 10.  <code><font color="#0000FF">asyncAfter (deadline: .now() + 0.1, qos: .userInteractive)</font></code> c  : <br><br><img src="https://habrastorage.org/files/ed2/11c/24b/ed211c24b2144dba8576feac5b45ed13.png"><br><br>     -  <code><font color="#0000FF">usualString</font></code> , <b></b>    -  <code><font color="#0000FF">safeString</font></code> ,    <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br> <b>  </b> . <br> ,      <br><img src="https://habrastorage.org/files/01a/499/a93/01a499a9300e49d6ada90f665225560d.png" width="450" height="33"><br>  and <br><img src="https://habrastorage.org/files/1cc/369/457/1cc369457f1c4804b1c13f653a404e75.png" width="400" height="33"><br>     ,   ,   ( <code><font color="#0000FF">.concurrent</font></code> ) ,      <code><font color="#0000FF">usualString</font></code>  -  <code><font color="#0000FF">safeString</font></code> . <br><br>  -  <code><font color="#0000FF">safeString</font></code>         sync  async,  , ¬´   ¬ª,      : <br><br><img src="https://habrastorage.org/files/0ef/0ea/0d9/0ef0ea0d969a4773944a1aa349db246e.png" width="500" height="418"><br><br>     <code>Playground</code> ,  ,   <code>Xcode 8</code>    <code>Thread Sanitizer</code>   <code>race condition</code> . <code>Thread Sanitizer</code>     .       ( <code>Scheme</code> ): <br><br><img src="https://habrastorage.org/files/dac/d23/58e/dacd2358ebd943b98c43ba37ff659e91.png" width="600" height="577"><br><br>    race condition   .   <b>Tsan</b>   <a href="https://github.com/BestKora/GCD-Swift3">Github</a> . <br><br> . <br><br>      <code>GCD</code>       <code>Swift 3</code> .       <code>Operations</code>      <code>Swift 3</code> . <br><br> <b>PS</b>    <code>GCD API</code>    ,       .    <code>Swift 3</code>        .   <code>Swift</code>                <code>Swift 5</code> (2018 .),   / 2017 .,  " <b>manifesto</b> "   2017.. <br><br>    <a href="http://researcher.watson.ibm.com/researcher/files/us-lmandel/lattner.pdf%3Futm_campaign%3DThis%252BWeek%252Bin%252BSwift%26utm_medium%3Demail%26utm_source%3DThis_Week_in_Swift_115">    IBM</a> ,       <code>GCD API</code>  <code><font color="#0000FF">async</font></code>    ¬´ ¬ª ( <b>pyramid of doom</b> ),       ,  / ¬´¬ª  <code>Dispatch Queue</code>   ,    : <br><br><img src="https://habrastorage.org/files/dae/7f5/438/dae7f54383334d2a85182a41c0cc4c76.png" width="600" height="170"><br><br>       ‚Äî   <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BE%25D0%25B4%25D0%25B5%25D0%25BB%25D1%258C_%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B2"> </a> ( <b>actor models</b> ).  <code><font color="#0000FF">actor</font></code> ‚Äî , , <code><font color="#0000FF">DispatchQueue</font></code> + <u></u> ,    , + <u></u> ,    : <br><br><img src="https://habrastorage.org/files/16e/979/4d8/16e9794d819342358fff64df5586ee4c.png" width="600" height="191"><br><br>        . <a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20160725/025676.html%3Futm_campaign%3DiOS%252BDev%252BWeekly%26utm_medium%3Demail%26utm_source%3DiOS_Dev_Weekly_Issue_284"></a>  <code><font color="#0000FF">actors</font></code> , <code><font color="#0000FF">async/await</font></code> , <b>atomicity</b> , <b>memory models</b>      .   ,    ¬´ ¬ª     ,    . <br><br>   <code>Swift</code>    <a href="https://apple.github.io/swift-evolution/"></a> . <br><br>      ,   iOS   Swift c  <a href="http://bestkora.com/IosDeveloper/ios-10-swift-3/">  CS193p Winter 17 (  iOS 10  Swift 3)</a> ,    <a href="https://itunes.apple.com/ru/course/developing-ios-10-apps-with-swift/id1198467120%3Fl%3Den">iTunes</a> ,      . <br><br><h3>  Links </h3><br> <a href="https://developer.apple.com/videos/play/wwdc2016/720/">WWDC 2016. Concurrent Programming With GCD in Swift 3 (session 720)</a> <br> <a href="https://developer.apple.com/videos/play/wwdc2016/213/">WWDC 2016. Improving Existing Apps with Modern Best Practices (session 213)</a> <br> <a href="https://developer.apple.com/videos/play/wwdc2015/718/">WWDC 2015. Building Responsive and Efficient Apps with GCD.</a> <br> <a href="http://www.appcoda.com/grand-central-dispatch/">Grand Central Dispatch (GCD) and Dispatch Queues in Swift 3</a> <br> <a href="https://videos.raywenderlich.com/courses/ios-concurrency-with-gcd-and-operations/lessons/11">iOS Concurrency with GCD and Operations</a> <br> <a href="http://khanlou.com/2016/04/the-GCD-handbook/">The GCD Handbook</a> <br> <a href="http://mrdekk.ru/2016/05/19/gcd-handbook/">  GCD</a> <br> <a href="">Modernize libdispatch for Swift 3 naming conventions</a> <br> <a href="http://dduraz.com/2016/10/26/gcd/">GCD</a> <br> <a href="http://dduraz.com/2016/07/07/gcd-beta/">GCD ‚Äì Beta</a> <br> <a href="https://blog.metova.com/concurrency-in-ios/">CONCURRENCY IN IOS</a> <br> <a href="https://www.uraimo.com/2017/05/07/all-about-concurrency-in-swift-1-the-present/">www.uraimo.com/2017/05/07/all-about-concurrency-in-swift-1-the-present</a> <br> <a href="https://www.uraimo.com/2017/05/07/all-about-concurrency-in-swift-1-the-present/">All about concurrency in Swift ‚Äî Part 1: The Present</a> </div><p>Source: <a href="https://habr.com/ru/post/320152/">https://habr.com/ru/post/320152/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320136/index.html">Cases: development of specifications and guidelines (web ui kit)</a></li>
<li><a href="../320140/index.html">Classical labyrinth generation algorithms. Part 1: introduction</a></li>
<li><a href="../320142/index.html">What if in games to use a video card for physics, not for graphics</a></li>
<li><a href="../320148/index.html">Alcatel Lucent - setting dect-phone</a></li>
<li><a href="../320150/index.html">We break Android. How deep is the rabbit hole?</a></li>
<li><a href="../320156/index.html">Logging VPN Connections on the Cisco ASA</a></li>
<li><a href="../320158/index.html">Areas of flexibility</a></li>
<li><a href="../320160/index.html">Vulnerable Highways and Energy Infrastructure: Recent Major Failures</a></li>
<li><a href="../320164/index.html">Caution: HSTS</a></li>
<li><a href="../320166/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ246 (January 16 - 22, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>