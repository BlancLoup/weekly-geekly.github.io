<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search on Drupal 7 using Apache Solr Part 3 - learn to add your own fields and options to the index</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In previous articles, I told you how to install and configure Apache Solr to organize a search on Drupal. In addition, we learned how to add fields an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search on Drupal 7 using Apache Solr Part 3 - learn to add your own fields and options to the index</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/getpro/habr/post_images/b40/a18/047/b40a1804748810d21d6fdd55d0c96bcc.png"><br>  In previous articles, I told you how to install and configure Apache Solr to organize a search on Drupal.  In addition, we learned how to add fields and search index settings.  In this article I will talk about how to add your own fields and settings, if the standard is not enough. <br>  For those who have not read the previous parts, I recommend reading them for a better understanding of the material. <br><a name="habracut"></a><br><ul><li>  <a href="http://habrahabr.ru/post/175527/">Search on Drupal 7 with Apache Solr Part 1 - Basic Setup</a> </li><li>  <a href="http://habrahabr.ru/post/177509/">Search on Drupal 7 using Apache Solr Part 2 - learn how to customize the index</a> </li><li>  Search on Drupal 7 using Apache Solr Part 3 - learn to add your own fields and options to the index </li><li>  <a href="http://habrahabr.ru/post/180083/">Search on Drupal 7 using Apache Solr Part 4 - faceted filters</a> </li><li>  <a href="http://habrahabr.ru/post/182820/">Search on Drupal 7 using Apache Solr Part 5 - widgets for facet filters</a> </li><li>  <a href="http://habrahabr.ru/post/189840/">Search on Drupal 7 using Apache Solr Part 6 - configure apache solr + tomcat</a> </li><li>  <a href="http://habrahabr.ru/post/213085">Search on Drupal 7 using Apache Solr Part 7 - full-text search in Russian</a> </li></ul><br><br><h4>  Fields </h4><br>  So let's start by adding fields.  Suppose the nodes that you index have reference to a dictionary with geolocation data.  Its structure looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eef/b2b/bcf/eefb2bbcf45adb88e8ec41309b307dff.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The task is to index only the values ‚Äã‚Äãof the first level, i.e.  areas to which the node belongs.  If we add the corresponding field to the index, all terms will be indexed, regardless of the level.  Therefore, we need to add our own field.  For this we need two functions.  The first is entity_property_info_alter hook.  In this hook you can add new fields for the entity.  So, add a new field for the node. <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Implements hook_entity_property_info_alter. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_search_entity_property_info_alter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$info)</span></span></span><span class="hljs-function"> </span></span>{ $info[<span class="hljs-string"><span class="hljs-string">'node'</span></span>][<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][<span class="hljs-string"><span class="hljs-string">'geo_first_level'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; t(<span class="hljs-string"><span class="hljs-string">'Geo 1 level'</span></span>), <span class="hljs-string"><span class="hljs-string">'getter callback'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'test_search_geo_first_level_getter_callback'</span></span>, ); }</code> </pre> <br><br>  The second function is getter callback, in this case test_search_geo_first_level_getter_callback.  It should return the value for our field at the time of the node's indexing.  This value will be stored in the index. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Getter callback. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_search_geo_first_level_getter_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($geo = field_get_items(<span class="hljs-string"><span class="hljs-string">'node'</span></span>, $item, <span class="hljs-string"><span class="hljs-string">'field_geo'</span></span>)) { $parents = taxonomy_get_parents($geo[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'tid'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($parents)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($term = taxonomy_term_load($geo[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'tid'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $term-&gt;name; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; }</code> </pre><br><br>  As $ item the indexed entity will be passed, in our case it is the node object.  We do a small check on whether this node contains, the term of the 1st level or not, and return the name of the term as an index value. <br><br>  Now go to the index settings and select the Fields tab. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6fe/3e5/d19/6fe3e5d19eb5f72447a430284bf83062.png"><br><br>  Our new field is already available for indexing.  Do not forget to add it to the list of fields by which you can search in the view settings. <br><br>  Sometimes it may be necessary to index multiple values ‚Äã‚Äãfor a field.  To do this, in the entity_property_info_alter hook specify 'type' =&gt; 'list', and in the getter callback you will need to return an array of values. <br>  For example, <code>return array('', '-', '');</code> <br><br><h4>  Filters </h4><br>  Now we will try to add a filter by which it will be possible to select nodes for indexing.  The filter will perform a similar function - allow indexing only those nodes that have a reference to the first-level term from the geo dictionary.  To do this, in the search_api_alter_callback_info hook, we will declare our filter. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Implements hook_search_api_alter_callback_info(). */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_search_search_api_alter_callback_info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $callbacks[<span class="hljs-string"><span class="hljs-string">'search_api_alter_geo_level'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; t(<span class="hljs-string"><span class="hljs-string">'Filter by level of geo'</span></span>), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; t(<span class="hljs-string"><span class="hljs-string">'Index only nodes with first level of term from vocabulary geo'</span></span>), <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'SearchApiAlterGeoLevelFilter'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// Filters should be executed first. 'weight' =&gt; -10, ); return $callbacks; }</span></span></code> </pre><br><br>  I placed the file with the filter class in the includes folder of the test_search module.  Do not forget to connect it in the .info file of your module.  For example: <code>files[] = includes/callback_geo_level.inc</code> <br>  Below is the code of the filter itself. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Search API data alteration callback that adds an URL field for all items. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchApiAlterGeoLevelFilter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchApiAbstractAlterCallback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alterItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$items)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $id =&gt; $item) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($geo = field_get_items(<span class="hljs-string"><span class="hljs-string">'node'</span></span>, $item, <span class="hljs-string"><span class="hljs-string">'field_geo'</span></span>)) { $parents = taxonomy_get_parents($geo[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'tid'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// If term has parents. if (!empty($parents)) { unset($items[$id]); } } } } public function supportsIndex(SearchApiIndex $index) { return $index-&gt;item_type === 'node'; } }</span></span></code> </pre><br><br>  In the alterItems function, we simply exclude elements that have terms not of the first level.  These items will not be indexed. <br>  To enable the filter, you need to clean the cache and go to the workflow tab in the index settings. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f20/d29/051/f20d2905154be7a1d40c8b01d7d3f53f.png"><br><br>  After you enable the filter, you must re-index the content again.  Now only those nodes that have the term of the first level dictionary will get into the index. </div><p>Source: <a href="https://habr.com/ru/post/178285/">https://habr.com/ru/post/178285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178269/index.html">How we organized the Ural rehearsal of ACM ICPC WORLD FINALS</a></li>
<li><a href="../178271/index.html">The era of octal numbers ends with a leading zero in JavaScript</a></li>
<li><a href="../178273/index.html">How to release a great iOS application that someone needs</a></li>
<li><a href="../178275/index.html">‚ÄúInternet in Russian‚Äù (Computerra, March 1997)</a></li>
<li><a href="../178283/index.html">HabraCitizen - a new android application for Habrahabr with a dark theme and swipe navigation</a></li>
<li><a href="../178287/index.html">Google is preparing a netbook on Android for $ 200</a></li>
<li><a href="../178289/index.html">The results of an independent study of the market of information security systems</a></li>
<li><a href="../178297/index.html">The next winners of the Microsoft BizSpark startups story contest</a></li>
<li><a href="../178299/index.html">Customization of scrollbars in the browser: a compromise between html, css, js technologies and usability</a></li>
<li><a href="../178301/index.html">This capricious eigrp on DMVPN tunnels</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>