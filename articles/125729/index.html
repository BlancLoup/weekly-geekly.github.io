<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storing hierarchical data flat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For example, storing the tree comments. 

 Many probably faced with the problem of storing comments, at least thought about it. The obvious solution "...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storing hierarchical data flat</h1><div class="post__text post__text-html js-mediator-article"> For example, storing the tree comments. <br><br>  Many probably faced with the problem of storing comments, at least thought about it.  The obvious solution "in the forehead" is a link to the parental comment and, as a result, recursive calls if necessary to display a tree.  Modern DBMSs support hierarchical queries, but it seems to me that this is just a transfer of the problem out of scope, maybe I'm wrong.  In any case, I wrote for Google Application Engine, there is no talk about hierarchical queries at all. <br><br>  I really didn‚Äôt like the perspective of recursion and a lot of small queries to the database, so I began to invent some way to get all the comments with one simple query.  And this way I quickly invented.  I interviewed several acquaintances, it turned out that very few people thought about this topic, so I will take the liberty to describe what I realized. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  So, the main requirement is to get all comments at once in the right order in one request.  Accordingly, I have to store 1) the display order 2) the nesting level. <br><br>  The first paragraph says that the answers to the first comment should be displayed before the second comment, regardless of the time they were added. <br><br>  To solve these two tasks, it is proposed to enter a certain field, sorting by which will give the desired order of comments. <br><br>  Below is a small comment tree with examples of hash. <br><br> <code>000000   1   <br> 000100     1.1     <br> 000101       1.1.1 ... <br> 000102       1.1.2 ... <br> 000103       1.1.3 ... <br> 000104       1.1.4 ... <br> 000200     1.2 <br> 000300     1.3 <br> 010000   2   <br> 010100     2.1     <br> 010200     2.2 ... <br> 020000   3   <br></code> <br><br>  Here, the numbers like ‚Äú1.1.x‚Äù are just part of the comment, not part of the hash, as the classic ‚Äúmaterialized way‚Äù suggests. <br><br>  The proposed hash stands at the beginning of each line.  In this case, the hash contains, as it were, three two-digit digits: zero-level comments are numbered in the first two digits, the second in the second two, and so on.  I think the calculation of this field is quite obvious from the picture. <br><br>  Two limitations follow automatically: <br>  1) the number of comments at each level is limited. <br>  2) the number of levels is limited. <br><br>  <i>The comments kindly suggest that the obviousness of the second restriction when switching to symbolic hashes is no longer so obvious</i> . <br><br>  In fact, I decided that you can close your eyes to both of these limitations.  In the case of storing comments and their number and nesting is quite possible to limit.  In addition, I went to a little trick and "allowed" to add a comment to the 4th level, but in fact I am making it as a third-level comment and also display it.  This is done in order not to limit the discussion of two enthusiastic commentators. <br><br>  <b>Implementation details</b> <br>  Developing this idea, I decided to abandon the digital field in favor of the text field.  In this case, I lose a little in efficiency, but then I‚Äôm not at all limited by the length of the hash.  Instead of numbers, I use the characters AZ and ax, that is, I actually use numbers with a base of 50 (a five-system system). <br><br>  In a fifty-decimal system, I single out one 50 digits at once, two - already 2500, this is enough for my purposes.  The nesting levels I use are 8. Both of these parameters change easily, but this can only be done once, before use. <br><br>  In order to calculate the hash for each record except for its nesting level, I also keep the number of child records, so that when adding a new record, you do not have to make unnecessary requests (google data storage, in fact, does not know how to perform select count (*)). <br><br>  The calculation of the hash, or rather, the update of the counter of child records must be performed within the transaction.  You can add the comment itself beyond the scope of the transaction, since the hash value does not depend on anything. <br><br>  By the way, just in case, I keep a link to the parent element.  If I suddenly decide to change everything - I will have all the initial data to restore the picture. <br><br>  <b>findings</b> <br>  easy discomfort due to the presence of restrictions; <br>  some difficulties in calculating this service field; <br>  instant delivery of all results in one flat query without unnecessary server load. <br><br>  In my opinion, it is worth bearing in mind this or a similar way of storing hierarchical data, sometimes it is quite applicable and gives good results. <br><br>  For example, <a href="http://dgwnpgnd.appspot.com/blog/00002.html">here</a> you can see how it all looks and works. <br><br>  PS Oh, yes, if someone prompts classic names or implementations of the solution to this problem, it will be great. </div><p>Source: <a href="https://habr.com/ru/post/125729/">https://habr.com/ru/post/125729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125723/index.html">Survival Guide on Black Hat and Defcon conferences: how to escape from hackers</a></li>
<li><a href="../125725/index.html">You have added a block of functionality (method, class, module). Your actions:</a></li>
<li><a href="../125726/index.html">Examples of successful SMM campaigns in runet. Part 1</a></li>
<li><a href="../125727/index.html">Likbez on vulnerabilities in web applications, as well as the most frequent mistakes of developers</a></li>
<li><a href="../125728/index.html">Free WiFi for all residents of London (512 Kbps)</a></li>
<li><a href="../125730/index.html">Canobuvosti, 103rd edition</a></li>
<li><a href="../125731/index.html">Several patents. Part 2. Microsoft</a></li>
<li><a href="../125733/index.html">Job Digest: Media Companies</a></li>
<li><a href="../125734/index.html">3G hole</a></li>
<li><a href="../125735/index.html">Around Yandex in 59 days</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>