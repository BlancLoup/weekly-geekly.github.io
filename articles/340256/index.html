<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BlackOasis APT: a new campaign with a new zerodem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We at Kaspersky Lab work closely with third-party software developers. As soon as we find another vulnerability, we immediately inform the manufacture...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BlackOasis APT: a new campaign with a new zerodem</h1><div class="post__text post__text-html js-mediator-article">  We at Kaspersky Lab work closely with third-party software developers.  As soon as we find another vulnerability, we immediately inform the manufacturer to close the hole in hot pursuit.  And on October 10, 2017, our system to counter the exploit discovered a new zerodey for Adobe Flash, which was used to attack our customers. <br><br>  The exploit was delivered to the victim through a Microsoft Office document, and its ultimate goal was to install the latest version of the FinSpy Trojan.  We reported a bug in Adobe, which assigned it the index CVE-2017-11292 and just yesterday rolled out the <a href="https://helpx.adobe.com/security/products/flash-player/apsb17-32.html">patch</a> . <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c54a17f3724084135.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So far, we have seen only one use of the exploit against our clients, from which we can conclude that it is used in piece target attacks. <br><br>  After analyzing the malware involved in this attack, we discovered its clear connection with the group we call BlackOasis.  We are confident that this team is behind attacks using another zerodey (CVE-2017-8759), discovered by FireEye in September 2017.  The FinSpy Trojan, involved in the new attack via CVE-2017-11292, accesses the same control server as the Trojan downloaded via CVE-2017-8759. <br><a name="habracut"></a><br><h3>  BlackOasis History </h3><br>  For the first time, BlackOasis activity was recorded by us in May 2016, during the study of another zerodey for Adobe Flash.  On May 10, Adobe <a href="https://helpx.adobe.com/security/products/flash-player/apsa16-02.html">announced</a> a CVE-2016-4117 vulnerability affecting Flash Player version 21.0.0.226 and earlier versions for Windows, Macintosh, Linux and Chrome OS.  As it turned out, this hole was actively used by hackers. <br><br>  Our researchers have found a sample that exploits this vulnerability.  The caught sample was downloaded to the multiscanner service on May 8, 2016.  The sample, in the form of an RTF file, used CVE-2016-4117 to download and install the program from a remote server.  And on the server of this program is no longer there, but there were many installers FinSpy. <br><br>  After digging into the data from the Kaspersky Security Network, our analysts identified two similar use cases of the exploit group (at that time - zerodeev) applied by BlackOasis in June 2015.  These are CVE-2015-5119 and CVE-2016-0984, which were patched in June 2015 and February 2016, respectively.  They also led to the installation of FinSpy. <br><br>  Having discovered the network of exploits created by BlackOasis, we began to monitor their activities in order to better understand tactics and the choice of targets.  Since then, we have seen a couple dozen attacks from this group. <br><br>  Here are some documents used as bait, for example: <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c54deef2486913006.png"><br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c53e142d127447679.png"><br><br>  As a result, we observed how BlackOasis applied at least 5 zerodeev since June 2015: <br><br><ul><li>  CVE-2015-5119 - June 2015 </li><li>  CVE-2016-0984 - July 2015 </li><li>  CVE-2016-4117 - May 2016 </li><li>  CVE-2017-8759 - September 2017 </li><li>  CVE-2017-11292 - October 2017 </li></ul><br><h3>  Attacks using CVE-2017-11292 </h3><br>  The attack begins with delivery to the victim of the Office document, in this case, presumably via email.  The document contains an ActiveX object containing an exploit for Flash. <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c538d44c947946006.png"><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c53c44cd582173527.png"><br>  <i>Flash object in .docx file saved in uncompressed format</i> <br><br>  The Flash object contains ActionScript, which extracts the exploit using a self-made wrapper. <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c53e8df4163918482.png"><br>  <i>Unpacking procedures for SWF-exploit</i> <br><br>  The exploit exploits a memory corruption vulnerability found in the class ‚Äúcom.adobe.tvsdk.mediacore.BufferControlParameters‚Äù.  If the exploit worked, it gets read and write access to the memory, which allows you to run the shellcode for the second stage of the attack. <br><br>  The first stage shell code contains an interesting set of NOP instructions, interspersed with other instructions.  Most likely, this is done in order to avoid antivirus detection, which is triggered by large blocks of NOP instructions inside flash files. <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c542f961833645991.png"><br>  <i>NOP array of instructions 0x90 and 0x91</i> <br><br>  The primary task of the initial shell code is to download the second stage shell code from the server hxxp: //89.45.67 [.] 107 / rss / 5uzosoff0u.iaf. <br><br><img src="https://habrastorage.org/webt/59/e5/1c/59e51c5427fc4344947296.png"><br>  <i>Shell code of the second stage</i> <br><br>  Shell code of the second stage of the attack performs the following actions: <br><ol><li>  Downloads FinSpy at hxxp: //89.45.67 [.] 107 / rss / mo.exe </li><li>  From the same IP downloads the bait document. </li><li>  Runs the Trojan and displays the document. </li></ol><br><br><h3>  Malicious load mo.exe </h3><br>  As already mentioned, inside mo.exe (MD5: 4a49135d2ecc07085a8b7c5925a36c0a) is the latest version of the FinSpy Trojan from Gamma International.  It is usually sold to government agencies and is used to legally monitor suspects.  The latest version is filled with anti-analytic tricks, including a homemade packer and a virtual machine for executing code, which makes analysis very difficult. <br><br>  The virtual machine P-code is packed using aPLib. <br><br><img src="https://habrastorage.org/webt/59/e5/af/59e5af7682beb984865386.png"><br>  <i>Part of the packaged P-code</i> <br><br><img src="https://habrastorage.org/webt/59/e5/b2/59e5b28d6b7fe936725692.png"><br>  <i>Uncompressed P-code</i> <br><br>  After unpacking the virtual machine, the P-code is decrypted: <br><br><img src="https://habrastorage.org/webt/59/e5/b2/59e5b2c2850dc389409766.png"><br>  <i>Decrypted P-code</i> <br><br>  The virtual machine used in the Trojan supports 34 instructions: <br><img src="https://habrastorage.org/webt/59/e5/b2/59e5b2f49414f290164172.png"><br>  <i>An example of an interpreted P-code</i> <br><br>  In this example, the instruction ‚Äú1b‚Äù starts the native code placed in the parameter field. <br><br>  As soon as the malware is successfully launched, it continues to copy files along these paths: <br><br><ul><li>  C: \ ProgramData \ ManagerApp \ AdapterTroubleshooter.exe </li><li>  C: \ ProgramData \ ManagerApp \ 15b937.cab </li><li>  C: \ ProgramData \ ManagerApp \ install.cab </li><li>  C: \ ProgramData \ ManagerApp \ msvcr90.dll </li><li>  C: \ ProgramData \ ManagerApp \ d3d9.dll </li></ul><br>  ‚ÄúAdapterTroubleshooter.exe‚Äù ‚Äîa completely legitimate binary that is used for an attack like Search Order Highjacking ‚Äî slips a maliciously crafted DLL module with the name of the present.  ‚ÄúD3d9.dll‚Äù is a malicious module that injects FinSpy into the Winlogon process. <br><br><img src="https://habrastorage.org/webt/59/e5/b3/59e5b32feab70849400226.png"><br>  <i>Part of the code embedded in the winlogon process</i> <br><br>  The malware then accesses the three management servers for new instructions and for sending the extracted data.  Two of them have already been used before when using FinSpy.  One - most recently, in September, in the attack described by FireEye, using CVE-2017-8759.  The IP addresses of these servers and the malware samples are closely related to the part of BlackOasis that is tied to using FinSpy. <br><br><h3>  BlackOasis Victims and Goals </h3><br>  The interests of BlackOasis are very broad - the group is interested in figures involved in Middle Eastern politics and organizations that have weight in this region.  Among their goals are prominent UN figures, opposition bloggers, political activists and regional journalists.  In 2016, we also noted BlackOasis‚Äôs particular interest in Angola.  This was clearly visible from the bait documents used in the attacks: they were intended for purposes allegedly related to oil, money laundering and other illegal activities.  In addition, BlackOasis was interested in international activists and research centers. <br><br>  The geography of interests of BlackOasis is very extensive.  Their victims are in Russia, Iraq, Afghanistan, Nigeria, Libya, Jordan, Tunisia, Saudi Arabia, Iran, the Netherlands, Bahrain, Great Britain and Angola. <br><br><h3>  findings </h3><br>  We believe that the attack on HackingTeam in mid-2015 led to a shortage of surveillance tools in the market, and this gap is now being filled by other companies.  One of them is Gamma International, which offers customers a package of FinFisher tools.  However, Gamma International itself was also hacked in 2014 by the same hacker named Phineas Fisher, although then the consequences were not as serious as in the case of the Hacking Team.  In addition, Gamma International had two years to recover from the attack.  Apparently, the number of attacks using FinFisher and zero-day vulnerabilities will continue to grow. <br><br>  How to do and how to protect against such attacks? <br><br>  In the case of CVE-2017-11292 and similar vulnerabilities, it is possible at the level of your organization to use the <a href="https://answers.microsoft.com/en-us/windows/forum/windows_8-update/flashplayer-updates/cd258a3f-cd87-4ea9-bdb6-074d06ad491e%3Fauth%3D1">Killbit technology</a> to block Flash elements in specific applications.  Unfortunately, it‚Äôs not so simple to do this at the system level: potentially Flash objects can be loaded via applications that Killbit cannot stop.  In addition, sometimes quite necessary tools depend on Flash, which as a result of blocking can also become inoperative.  In addition, there are no guarantees that BlackOasis will not switch to the use of exploits for other software products. <br><br>  It is best to apply a multi-level approach using access policies, antiviruses, network monitoring, and white lists.  Our products detect BlackOasis tools as PDM: Exploit.Win32.Generic, HEUR: Exploit.SWF.Generic and HEUR: Exploit.MSOffice.Generic. <br><br>  Infection Indicators: <br>  4a49135d2ecc07085a8b7c5925a36c0a <br>  89.45.67 [.] 107 <br><br>  Many thanks to the Adobe Product Security Incident Response Team (PSIRT) for helping to analyze the vulnerability and fix it quickly. </div><p>Source: <a href="https://habr.com/ru/post/340256/">https://habr.com/ru/post/340256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340246/index.html">PHP page navigation</a></li>
<li><a href="../340248/index.html">Creating distributions for different operating systems in Java 9 and 10</a></li>
<li><a href="../340250/index.html">In simple words: smart contracts, Ethereum, ICO</a></li>
<li><a href="../340252/index.html">China is a digital power. Impressions of Huawei Connect 2017</a></li>
<li><a href="../340254/index.html">Jinja2 Extensions Guide</a></li>
<li><a href="../340258/index.html">Hacking visual system: 11 optical illusions in graphic design</a></li>
<li><a href="../340262/index.html">Recommender system on the knee as a means against existential crisis</a></li>
<li><a href="../340264/index.html">8 key decisions in development on React</a></li>
<li><a href="../340266/index.html">What you need to know the head of the IT department?</a></li>
<li><a href="../340268/index.html">The philosophy of static code analysis: we have 100 programmers, the analyzer found few errors, is it useless?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>