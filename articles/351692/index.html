<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Disruption of a large-scale hacker attack on Windows users in Russia: part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More recently, we have prevented a massive attack using the Dofoil Trojan , the goal of which was to install malware for mining cryptocurrency on hund...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Disruption of a large-scale hacker attack on Windows users in Russia: part 2</h1><div class="post__text post__text-html js-mediator-article">  More recently, we have prevented a <a href="https://habrahabr.ru/company/microsoft/blog/351356">massive attack using the Dofoil Trojan</a> , the goal of which was to install malware for mining cryptocurrency on hundreds of thousands of computers.  With the help of behavioral monitoring, machine learning models and a multi-level protection system, Windows Defender antivirus software was able to effectively detect and block an attack within a few milliseconds. <br><br>  Today, we will tell you more about the attack itself, the ways of infection and share the time scale.  Look under the cat! <br><br><img src="https://habrastorage.org/webt/b2/rx/fd/b2rxfd3rvo53yoev8xulnjuim3q.jpeg"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Immediately after detecting the attack, we were able to determine where exactly a huge number of attempts were made to install malware.  As a rule, <a href="https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description%3FName%3DTrojanDownloader:Win32/Dofoil.AB">Dofoil</a> Trojan (also known as Smoke Loader) is distributed in a variety of ways, including spam messages and exploit kits.  For the attack, which began on March 6, another scheme was used: most of the malicious files were created by the process mediaget.exe. <br><br>  This process relates to MediaGet, a BitTorrent client, which corresponds to the classification of families of <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/detect-block-potentially-unwanted-apps-windows-defender-antivirus">potentially unwanted applications</a> .  Users often use the MediaGet application to search and download programs and multimedia files from sites with a dubious reputation.  Using such file sharing applications increases the risk of downloading malware. <br><br>  However, after studying the attack, we came to the conclusion that the infection with Dofoil crypto-miner is not associated with downloading torrent files.  Previously, we did not observe such a scheme in other file-sharing applications.  The mediaget.exe process has always written Dofoil samples in the% TEMP% folder named my.dat.  The most common source of infection was the% LOCALAPPDATA% \ MediaGet2 \ mediaget.exe file (SHA-1: 3e0ccd9fa0a5c40c2abb40ed6730556e3d36af3c). <br><br>  <b>Recommended materials</b> : statistics on the attack, useful information and data on the response of Windows Defender, see the article <a href="https://habrahabr.ru/company/microsoft/blog/351356/">Disrupting a massive hacker attack on Windows users in Russia</a> . <br><br><h2>  Attack Timeline </h2><br>  A comprehensive study of the Dofoil attack, launched on March 6, revealed that it had been a carefully planned campaign that had been prepared by attackers from mid-February.  To accomplish this, the attackers first spread the virus through an update to the MediaGet program, which users installed on their computers.  The timeline below shows the main events as part of the Dofoil attack. <br><br><img src="https://habrastorage.org/webt/pt/82/y3/pt82y3b4x5l5kdif90k2jzrarqk.png"><br>  <i>Fig.</i>  <i>1. The timeline of the attack through MediaGet</i> <br><br><h2>  Infecting MediaGet software update </h2><br>  The infection infection process for MediaGet, which eventually led to a massive attack, is described in the following diagram.  The trusted mediaget.exe application downloads the update.exe executable file and runs it on the computer to install the new mediaget.exe instance.  A new instance of the mediaget.exe application has all the same functions as the authentic one, but it also provides a loophole. <br><br><img width="300" src="https://habrastorage.org/webt/jn/mk/n9/jnmkn9qjlazyrbrzmmvnfoahshk.png"><br>  <i>Fig.</i>  <i>2. Procedure for infecting an update file</i> <br><br>  The whole process of installing an infected update file is monitored by the Windows Defender ATP service.  The following process tree shows how the mediaget.exe process injects an infected signed update.exe file. <br><br><img src="https://habrastorage.org/webt/sh/j9/m_/shj9m_tuhmyzkqh-pjqjbhlyk5u.png"><br>  <i>Fig.</i>  <i>3. Detection of the malicious update process in Windows Defender ATP</i> <br><br><h2>  Infected update.exe file </h2><br>  Downloaded <i>update.exe</i> is an InnoSetup SFX batch file with the trojan-infected mediaget.exe embedded in it.  When launched, this executable file injects an unsigned version of the <i>mediaget.exe</i> application infected with a trojan. <br><br><img src="https://habrastorage.org/webt/rv/0x/nl/rv0xnlmymt5y-lkod6x9yyqyncu.png"><br>  <i>Fig.</i>  <i>4. Certificate data of the infected update.exe file</i> <br><br>  Update.exe is signed by a third-party software developer not affiliated with MediaGet (it is likely that this company is a victim of intruders).  The executable file contains code signed by another certificate whose task is to simply transfer the same signature confirmation requirement as in the original mediaget.exe file.  The update code verifies the certificate data, confirming that it is valid and properly signed.  If the certificate is signed, it checks whether the hash value matches the value received from the hash server in the mediaget.com infrastructure.  The following illustration shows a code snippet that checks for valid signatures for the update.exe file. <br><br><img src="https://habrastorage.org/webt/zy/gj/c3/zygjc3v6xhuvab_vioxymywzotm.png"><br>  <i>Fig.</i>  <i>5. Update code mediaget.exe</i> <br><br><h2>  Trojan-infected mediaget.exe </h2><br>  The trojan-infected mediaget.exe file, recognized by Windows Defender AV as Trojan: Win32 / Modimer.A, performs the same functions as the source file, however, it is not signed and has a loophole.  This malicious binary code is 98% identical to the original MediaGet binary code.  According to the following PE data, other PDB data and a different file path are indicated in the executable file. <br><br><img src="https://habrastorage.org/webt/rx/73/ij/rx73ijhtz5pop06wy1zgcqun4ti.png"><br>  <i>Fig.</i>  <i>6. Comparison of the PDB paths of the executable file signed by the Trojan and infected</i> <br><br>  When launching a malicious program, a list of management and control servers (C &amp; C) is created. <br><br><img src="https://habrastorage.org/webt/j0/il/q8/j0ilq8hcdcweltpelipl265hnqw.png"><br>  <i>Fig.</i>  <i>7. List of C &amp; C Servers</i> <br><br>  Regarding the built-in C &amp; C list, it is important to note that the top-level domain .bit is not an ICANN approved domain and is supported by the NameCoin infrastructure.  NameCoin is a distributed system of alternative root DNS servers in which the blockchain model principle is implemented.  This system provides anonymous domains.  Since .bit domain names are not resolved by standard DNS servers, malware builds a list of 71 IPv4 addresses that are used as NameCoin DNS servers. <br><br>  The malware then uses NameCoin servers for DNS search in .bit domains.  From this point on, these names are placed in the computer's DNS cache and all future lookups are resolved without specifying NameCoin DNS servers. <br><br>  The first call to the C &amp; C server occurs one hour after the launch of the program. <br><br><img src="https://habrastorage.org/webt/7b/zk/oi/7bzkoi9vj48ptdewu8kqhu2ivem.png"><br>  <i>Fig.</i>  <i>8. Timer start connecting to C &amp; C server.</i> <br><br>  The malware selects one of four C &amp; C servers.  The program uses the HTTP protocol to exchange management and control data. <br><br><img src="https://habrastorage.org/webt/6e/q9/9n/6eq99nb9tcj1k1boe_qlmgnwgci.png"><br>  <i>Fig.</i>  <i>9. Connecting to a C &amp; C server</i> <br><br>  The loophole code collects information about the system and sends it to the C &amp; C server via a POST request. <br><br><img src="https://habrastorage.org/webt/ao/2s/io/ao2sioa85fahelmh6ivkrh64ons.png"><br>  <i>Fig.</i>  <i>10. System Information</i> <br><br>  The C &amp; C server returns various commands to the client.  The following answer contains the HASH, IDLE, and OK commands.  The IDLE command sets the process to wait for a certain period (in seconds, for example, 7200 seconds = 2 hours) before re-accessing the C &amp; C server. <br><br><img src="https://habrastorage.org/webt/u5/fq/wr/u5fqwrtv9zjewwood2c7lkue3gg.png"><br>  <i>Fig.</i>  <i>11. Management and control teams</i> <br><br>  One of the loophole commands is RUN, which gets the URL from the command line of the C &amp; C server.  Then the malware downloads the file from the URL, saves it to the% TEMP% \ my.dat folder and launches it. <br><br><img src="https://habrastorage.org/webt/pu/hi/fk/puhifkrk4akkcrudgzyrjesdsbk.png"><br>  <i>Fig.</i>  <i>12. RUN command processing code</i> <br><br>  This RUN command has been used to spread the Dofoil Trojan since March 1, and as part of an attack launched on March 6.  The Windows Defender ATP alert process tree demonstrates the exchange of data between the malicious process mediaget.exe and goshan.online, one of the confirmed C &amp; C servers.  After that, the program injects and runs the file my.dat (Dofoil), which eventually leads to the CoinMiner component. <br><br><img src="https://habrastorage.org/webt/s5/-z/fu/s5-zfulpixdict25hxb9v-efbsy.png"><br>  <i>Fig.</i>  <i>13. Dofoil, the process of loading and running CoinMiner</i> <br><br><img src="https://habrastorage.org/webt/ph/kl/jr/phkljrldrby3hxlf4v42uow4xqg.png"><br>  <i>Fig.</i>  <i>14. Windows Defender ATP alert system process tree</i> <br><br>  As part of the attack, the Dofoil Trojan was used to deliver CoinMiner, a malicious program whose task is to use the resources of users' computers to mine cryptocurrencies in favor of attackers.  The Dofoil trojan used sophisticated techniques for introducing malicious code into the address space of processes, the mechanisms for ensuring sustainability, and detection evasion techniques.  Windows Defender ATP successfully detects this behavior at all stages of infection. <br><br><img src="https://habrastorage.org/webt/y5/jk/xg/y5jkxgkjrrr0y_zkoszlbslv1ik.png"><br>  <i>Fig.</i>  <i>15. Detection of the implementation of the Dofoil process in Windows Defender ATP</i> <br><br>  We reported the results of our research to MediaGet developers to help them competently analyze the incident. <br><br>  We also told the certificate holders about how their code signing certificate is used by attackers in the update.exe file (fingerprint: 5022EFCA9E0A9022AB0CA6031A78F66528848568). <br><br><h2>  Protection against real-time virus attacks </h2><br>  A carefully planned and well-prepared campaign using Dofoil, discovered on March 6, is a prime example of multi-level viral cyber attacks that are becoming more common today.  When making typical cybercrimes, now more and more sophisticated techniques are used that were previously associated with more sophisticated cyber attacks.  Windows Defender Advanced Threat Protection (Windows Defender ATP) provides an advanced set of new-generation security tools that protect clients in real time against a wide variety of attacks. <br><br>  Corporate clients using Windows Defender AV antivirus, which activated <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/detect-block-potentially-unwanted-apps-windows-defender-antivirus">protection against potentially unreliable applications</a> , were protected from MediaGet software infected with a trojan that turned out to be the source of a virus attack on March 6. <br><br>  <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/windows-defender-antivirus-in-windows-10%3Focid%3Dcx-blog-mmpc">Windows Defender AV has</a> provided reliable protection for customers against attacks using Dofoil.  Behavioral monitoring and analysis technologies revealed an unusual Dofoil endurance mechanism and immediately sent the appropriate signal to the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-antivirus/utilize-microsoft-cloud-protection-windows-defender-antivirus">cloud protection service</a> , where numerous machine learning models instantly blocked most of the detected threats as they appeared. <br><br>  A comprehensive analysis of the attack also revealed that the advanced detection libraries in <a href="https://www.microsoft.com/en-us/WindowsForBusiness/windows-atp%3Focid%3Dcx-blog-mmpc">Windows Defender ATP</a> tagged Dofoil malicious behavior at all stages of infection.  Malicious behavior can include code injection, methods of protection against detection and the introduction of components for mining cryptocurrencies.  Security professionals can use the Windows Defender ATP platform to detect attacks and effectively respond to them.  Windows Defender ATP also provides built-in protection tools for Windows Defender AV, Windows Defender Exploit Guard and Windows Defender Application Guard, ensuring flawless security management at all levels. <br><br><h2>  Compromise Indicators (IOCs) </h2><br><table><tbody><tr><th width="130">  File name </th><th width="100">  SHA-1 </th><th width="140">  Description </th><th>  Signatory </th><th>  date of signing </th><th width="150">  The name of the detected malware </th></tr><tr><td> mediaget.exe </td><td>  1038d32974969a1cc7a79c3fc7b7a5ab8d14fd3e </td><td>  Official executable mediaget.exe </td><td>  GLOBAL MICROTRADING PTE.  LTD. </td><td>  2:04 PM 10/27/2017 </td><td>  PUA: Win32 / MediaGet </td></tr><tr><td>  mediaget.exe </td><td>  4f31a397a0f2d8ba25fdfd76e0dfc6a0b30dabd5 </td><td>  Official executable mediaget.exe </td><td>  GLOBAL MICROTRADING PTE.  LTD. </td><td>  4:24 PM 10/18/2017 </td><td>  PUA: Win32 / MediaGet </td></tr><tr><td>  update.exe </td><td>  513a1624b47a4bca15f2f32457153482bedda640 </td><td>  Trojan infected executable update file </td><td>  DEVELTEC SERVICES SA DE CV </td><td>  - </td><td>  Trojan: Win32 / Modimer.A </td></tr><tr><td>  mediaget.exe </td><td>  3e0ccd9fa0a5c40c2abb40ed6730556e3d36af3c, <br>  fda5e9b9ce28f62475054516d0a9f5a799629ba8 </td><td>  Trojan-infected mediaget.exe executable </td><td>  Not signed </td><td>  - </td><td>  Trojan: Win32 / Modimer.A </td></tr><tr><td>  my.dat </td><td>  d84d6ec10694f76c56f6b7367ab56ea1f743d284 </td><td>  Embedded Malicious Executable File </td><td>  - </td><td>  - </td><td>  TrojanDownloader: Win32 / Dofoil.AB </td></tr><tr><td>  wuauclt.exe </td><td>  88eba5d205d85c39ced484a3aa7241302fd815e3 </td><td>  CoinMiner implemented </td><td>  - </td><td>  - </td><td>  Trojan: Win32 / CoinMiner.D </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/351692/">https://habr.com/ru/post/351692/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351682/index.html">Graal: how to use the new JIT JIT compiler in real life</a></li>
<li><a href="../351684/index.html">In google with no work experience. Programmer from Silicon Valley about Russian diplomas, interviews and work in the US</a></li>
<li><a href="../351686/index.html">Big clump of dirt</a></li>
<li><a href="../351688/index.html">The sysadmin needs long hands</a></li>
<li><a href="../351690/index.html">Useful to the designer and developer. Fresh utilities and tools to speed up work. Issue number 10</a></li>
<li><a href="../351694/index.html">Java 10 General Availability</a></li>
<li><a href="../351696/index.html">Why pay a reputation manager</a></li>
<li><a href="../351698/index.html">The most common questions on the interview programmer graphics</a></li>
<li><a href="../351700/index.html">Trends in outsourcing. Forecast for 2020</a></li>
<li><a href="../351704/index.html">History of ES6 Modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>