<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FluentMigrator - Version Migration System</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. What are migrations and why they are needed are well described in the article Version migration of database structure: main approaches . 
 I wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FluentMigrator - Version Migration System</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/d44ea050/eefcef44/47e01893/e2a05732.gif" align="right"><br>  Hello.  What are migrations and why they are needed are well described in the article <a href="http://habrahabr.ru/blogs/sql/121265/">Version migration of database structure: main approaches</a> . <br>  I want to tell you about the versioned migration system: FluentMigrator.  Why do I like this particular project?  Because of the nice migration syntax and support for various DBMS.  Interested?  Welcome under cat. <br><a name="habracut"></a><br><h4>  The content of the article </h4><br>  about the project <br>  Briefly about the possibilities <br>  Components of the system <br>  How it works <br>  Subtleties <br>  Conclusion <br><br><h4>  about the project </h4><br>  The project itself is based on GitHub: <a href="http://github.com/schambers/fluentmigrator">github.com/schambers/fluentmigrator</a> <br>  My fork: <a href="http://github.com/tabushi/fluentmigrator">github.com/tabushi/fluentmigrator</a> <br>  The history of repository changes begins from 17.12.2008 <br>  Distributed under the license: Apache License 2.0 <br>  Written in C # under .Net Framework 3.5 <br><br><h4>  Briefly about the possibilities </h4><br><h5>  Supported DBMS </h5><ul><li>  Jet </li><li>  Mysql </li><li>  Oracle </li><li>  PostgreSQL </li><li>  Sqlite </li><li>  Microsoft SQL Server </li></ul><h5>  Supported operations </h5><ul><li>  Creating, deleting tables </li><li>  Adding, deleting, modifying columns </li><li>  Creating, deleting primary, foreign keys, indexes </li><li>  Insert, update, delete data (rather modest in scope) </li><li>  Check for the existence of schemas, tables, columns, indexes in the database </li><li>  Execution of arbitrary sql, sql script from a resource or from an external file (when all previous is not enough) </li></ul><h5>  Components of the system </h5><ul><li>  <b>FluentMigrator</b> is the core of the program itself, it implements the entire migration syntax </li><li>  <b>FluentMigrator.Console</b> - a console application for starting migrations, has a large number of parameters </li><li>  <b>FluentMigrator.MSBuild</b> - start migrations for MSBuild </li><li>  <b>FluentMigrator.NAnt</b> - Launch Migrations for NAnt </li><li>  <b>FluentMigrator.Runner</b> - the core of the script installers, is the basis for the previous three projects, which are essentially small shells in a 1 .cs file.  It contains all the logic for performing migrations and converting migrations into sql under the required DBMS.  Using it is very easy to write your runner with <s>blackjack</s> with beautiful windows and the required functionality. </li><li>  <b>FluentMigrator.SchemaDump</b> - I personally did not use it, but I looked at it especially for this article.  It is designed to save the database structure in the sql file.  Implemented only for MS SQL Server </li><li>  <b>FluentMigrator.Tests</b> - tests, where do without them.  Uses NUnit </li></ul><h4>  How it works </h4><br>  And now let's take a closer look at the migration file.  So, the migration file can contain the following: <ul><li>  migration </li><li>  profiles </li><li>  description of the version table </li><li>  sql scripts as embedded resources </li><li>  maybe something else that I have not yet encountered </li></ul><h5>  Learn more about these entities. </h5><br>  Consider the <b>migration</b> using the following example: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> FluentMigrator; <br> <br> <font color="#0000ff">namespace</font> ExampleDatabaseMigrations <br> { <br> [Migration(2011091900)] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> ExampleMigration : Migration <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Up() <br> { <br> <font color="#0000ff">if</font> (!Schema.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ).Exists()) <br> { <br> Create.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ) <br> .WithColumn( <font color="#A31515">"ID"</font> ).AsInt16().NotNullable().PrimaryKey( <font color="#A31515">"PK_EXAMTABL_ID"</font> ) <br> .WithColumn( <font color="#A31515">"NAME"</font> ).AsAnsiString(100).NotNullable() <br> .WithColumn( <font color="#A31515">"SHORT_NAME"</font> ).AsAnsiString(50).Nullable() <br> .WithColumn( <font color="#A31515">"START_DATE"</font> ).AsDate().NotNullable() <br> .WithColumn( <font color="#A31515">"END_DATE"</font> ).AsDate().Nullable(); <br> Insert.IntoTable( <font color="#A31515">"IDX_EXAMTABL_NAME"</font> ) <br> .Row( <font color="#0000ff">new</font> {Id = 1, Name = <font color="#A31515">"TEST"</font> , Start_Date = <font color="#0000ff">new</font> <font color="#2B91AF">DateTime</font> (2011, 9, 19)}); <br> } <br> <font color="#0000ff">if</font> (!Schema.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ).Index( <font color="#A31515">"IDX_EXAMTABL_NAME"</font> ).Exists()) <br> { <br> Create.Index( <font color="#A31515">"IDX_EXAMTABL_NAME"</font> ) <br> .OnTable( <font color="#A31515">"EXAMPLE_TABLE"</font> ) <br> .OnColumn( <font color="#A31515">"NAME"</font> ).Ascending(); <br> } <br> <font color="#0000ff">if</font> (!Schema.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ).Index( <font color="#A31515">"IDX_EXAMTABL_STARDATE_ENDDATE"</font> ).Exists()) <br> { <br> Create.Index( <font color="#A31515">"IDX_EXAMTABL_STARDATE_ENDDATE"</font> ) <br> .OnTable( <font color="#A31515">"EXAMPLE_TABLE"</font> ) <br> .OnColumn( <font color="#A31515">"START_DATE"</font> ).Ascending() <br> .OnColumn( <font color="#A31515">"END_DATE"</font> ).Ascending(); <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Down() <br> { <br> <font color="#0000ff">if</font> (Schema.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ).Exists()) <br> Delete.Table( <font color="#A31515">"EXAMPLE_TABLE"</font> ); <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In the example, I did not indicate anywhere the scheme for creating a table \ index, but of course there is such a possibility. <br>  The numbering of migrations should go in ascending order, which is logical.  But simply to order it seemed to us not convenient, so the numbering was taken as follows: yyyyMMddxx, where: yyyy is the year, MM is the month, dd is the day, xx is the number in the order from 00 to 99. Thus, the order is observed and the numbering says about the creation of the migration. <br>  This example gives an approximate idea of ‚Äã‚Äãhow the migration looks, and we‚Äôll stop there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Profile template </h5><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> FluentMigrator; <br> <br> <font color="#0000ff">namespace</font> ExampleDatabaseMigrations <br> { <br> [Profile( <font color="#A31515">"Example"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> ExampleProfile : Migration <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Up() <br> { <br> <font color="#008000">//do something</font> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Down() <br> { <br> <font color="#008000">//empty, not used</font> <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  As you can see, the profile is also inherited from the Migration class, but is marked with the Profile attribute.  In the profile, only the Up method is executed (although in the example in the github documentation, the Down method is also filled, maybe it was also executed once).  A migration file can contain an unlimited number of profiles with different names. <br><br>  What is the difference between a profile and a migration other than attributes?  That: <ol><li>  a profile is executed only if it is explicitly set, indicating its name when performing migrations; </li><li>  the profile is always executed after successful migration, if there was nothing to install from the migrations, the profile is still executed. </li></ol>  Thus, the profile can be used for any service functions.  Collect statistics or something.  We use it to start the procedures for recompiling invalid database objects that have become such due to changes in the structure. <br><br>  Most recently, on a githab was a request for adding a hybrid profile and migrations ‚Äî profiles that have a migration number.  The fact is that a person used a profile to fill in test data in the developers database when necessary, and since the database structure changed when adding migrations, he had to change the profile every time.  This is an example of unsuccessful use of the profile.  He was advised to use for this migration, within which through if to check some condition, such as an environment variable, since  command line options in the migration, of course, are not available. <br><br><h5>  Version table </h5><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> FluentMigrator.VersionTableInfo; <br> <br> <font color="#0000ff">namespace</font> ExampleDatabaseMigrations <br> { <br> [VersionTableMetaData] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> ExampleVersionInfo : IVersionTableMetaData <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> SchemaName { <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#A31515">"EXAMPLE_SCHEMA"</font> ; } } <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> TableName { <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#A31515">"EXAMPLE_VERSION_TABLE"</font> ; } } <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ColumnName { <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#A31515">"EXAMPLE_VERSION_COLUMN"</font> ; } } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Thus, even in one scheme, you can have several different tables with versions for different projects, or keep the table with versions separately from the scheme with a project. <br>  that will be if to set an empty line instead of a name of the scheme it is written above. <br><br><h5>  Embedded Scripts </h5><br>  Embedded scripts are ordinary sql scripts whose files are connected to the project and having the property ‚ÄúBuild Action‚Äù = ‚ÄúEmbedded Resource‚Äù.  I don‚Äôt need to talk more about them. <br><br><h4>  How it works </h4><br>  Next, suppose that we are migrating up, i.e.  Install the latest version of the database structure. <br><br><h5>  Work algorithm </h5><ol><li>  The program (Runner) is passed parameters containing, if briefly, data about the database, the migration file and the task itself (in fact, there are many parameters, and what I have indicated above is given by more than three parameters). </li><li>  Runner connects to the database and selects the maximum number in the version table, scans the migration file and performs the migration. </li><li>  In case of an error, the runner rolls back the migration on which it stumbled (with some exceptions, about which later in the <i>subtleties</i> section). </li></ol><h5>  Perform one migration </h5><br>  Migration is divided into 2 stages. <ol><li>  Execution of the Up () method (or Down (), in case of setting downward migrations), which adds expressions to the list of expressions </li><li>  Converting expressions to sql and sending to execution in the database </li></ol><h4>  Subtleties </h4><br>  Changes are not always rolled back, since not all DBMSs support rolling back DDL operations.  For such DBMS, migration is desirable to do as small as possible, from a single operation.  If this one operation is not established, then it will not need to be rolled back. <br><br>  It seems that the project was originally conceived for writing migrations once for all supported DBMS (and for basic simple operations it works).  But nevertheless, it is worth admitting that the DBMS features and syntax are very different (for example, some DBMSs use auto-increment fields, and others have sequences), so recently a function with a speaker named IfDatabase has become available within migrations. <br><br><h4>  Conclusion </h4><br>  The project is open source, so you should not expect miracles from it.  Check what happened on the required DBMS, as it may happen that something is not implemented for this DBMS.  Describe the bugs - fix it, or help them fix it yourself. <br><br>  PS: I want to ask you to speak about what else you would be interested to know.  I will write about it. </div><p>Source: <a href="https://habr.com/ru/post/129242/">https://habr.com/ru/post/129242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129236/index.html">Interfaces: Simplify the search engine (or why we don‚Äôt)</a></li>
<li><a href="../129237/index.html">Dojo-do-it-yourself widget</a></li>
<li><a href="../129239/index.html">Start Motivate Clock: ‚ÄúDo not think about seconds down‚Äù</a></li>
<li><a href="../129240/index.html">Tuning for the Public folder in Dropbox</a></li>
<li><a href="../129241/index.html">Development of RvaToRaw and RawToRva features</a></li>
<li><a href="../129243/index.html">Web-to-Print technology: designer to himself</a></li>
<li><a href="../129244/index.html">BMW autopilot drove along the Munich-Nuremberg highway</a></li>
<li><a href="../129246/index.html">Work with last.fm API on JavaScript</a></li>
<li><a href="../129247/index.html">Evolution of understanding the PLO</a></li>
<li><a href="../129249/index.html">Best Asterisk CRM System</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>