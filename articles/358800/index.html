<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>White spots in work with SSH</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SSH is a very powerful and flexible tool, but, as practice shows, not everyone understands how it works and uses it correctly. The word Secure is incl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>White spots in work with SSH</h1><div class="post__text post__text-html js-mediator-article">  SSH is a very powerful and flexible tool, but, as practice shows, not everyone understands how it works and uses it correctly.  The word Secure is included in the SSH abbreviation and is one of the key aspects of the protocol, but it is often security that receives insufficient attention.  In this article I want to talk about a few common mistakes when working with SSH, as well as moments that are often forgotten. <br><br><img src="https://habrastorage.org/webt/9v/cw/lq/9vcwlqgr22w_e61wvfd_voxnuhy.png" alt="image"><br><a name="habracut"></a><br>  There are several ways to authenticate a user: <br><br><ol><li>  <b>By password</b> - the standard mechanism, but not the most reliable, I will not focus on it </li><li>  <b>Key by key</b> is the most reliable authentication method, but it is provided that it is used correctly. </li><li>  <b>By IP address</b> - compatibility mode.  I cite just for reference, I doubt that someone will use it in a sober mind. </li></ol><br><h2>  Asymmetric encryption </h2><br>  SSH uses asymmetric encryption, the essence of which lies in the fact that there are two keys: public and private.  You can encrypt a message with a public key and decrypt it with a private one.  The private key is kept safe, and the public key is accessible to everyone.  In addition, you can sign the message with a private key, and check this signature with an open one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The diagram shows that after exchanging public keys, two nodes can communicate securely with each other over an insecure Internet. <br><br>  In addition, user authentication can be performed using this same key pair. <br><br>  The user public key must be added to the <i>$ HOME / .ssh / authorized_keys</i> file <br>  There may be several public keys in this file - they will all work. <br><br><img src="https://habrastorage.org/webt/ue/pk/n9/uepkn9eebfxvishyznpnn36flw4.png" alt="image"><br><br><h2>  MITM Attack Protection </h2><br>  MITM-attack is a type of attack in cryptography, when an attacker secretly retransmits and, if necessary, changes the connection between two parties, who believe that they directly communicate with each other.  It is a method of compromising a communication channel in which a hacker, having connected to a channel between contractors, interferes with the transfer protocol, deleting or distorting information. <br><br>  One of the main innovations in the second version of the protocol was the built-in protection against MITM attacks. <br><br><img src="https://habrastorage.org/webt/bs/gh/wc/bsghwcxpko8apqcyuhgrelesnck.png" alt="image"><br><br>  The essence of the defense lies in the fact that each side must make sure that on the other side is exactly the one who is expected, and not the attacker. <br><br>  For MITM protection on the client side (i.e., to determine that you are connecting to your server), the <b>StrictHostKeyChecking</b> parameter and the <b>known_hosts</b> file are <b>responsible.</b> <br><br>  Public keys of servers are stored in files: <br>  <i>$ HOME / .ssh / known_hosts</i> - user file, <br>  <i>/ etc / ssh / ssh_known_hosts</i> - system file. <br><br>  Each entry in known_hosts is a string containing fields and using a space as a separator: <br><br><ol><li>  one or more server names or comma-separated IP addresses </li><li>  key type </li><li>  public key </li><li>  any additional comments </li></ol><br>  This is where the "identification" server <br><br><pre><code class="bash hljs">StrictHostKeyChecking=no|ask|yes</code> </pre> <br>  Values ‚Äã‚Äãcan be the following: <br><br><ul><li>  <b>no</b> - the connection will occur in any case, the maximum we will receive a warning that the connection is unsafe.  You can often find in all sorts of automatic scripts such as autotests and auto-warmups, here lies the main problem - if the script runs fine, then the user (administrator) will not notice something was wrong, and infection / compromise will occur. </li><li>  <b>ask</b> - ask for a new connection (default value), if the record is not already in known_hosts, and, in case of agreement with the connection, a new record is added </li><li>  <b>yes</b> - always perform the scan, the safest option, which I strongly recommend using in automated systems.  Connection is made only if there is an entry in known_hosts </li></ul><br>  What it gives us: <br><br><ol><li>  During the first connection, we can determine if the attacker presented the server </li><li>  Ensuring that subsequent connections to the server will not replace the respectable server by the attacker </li></ol><br>  If everything is clear with the second item, then what about the first one? <br><br>  Here you can select at least three options: <br><br><ol><li>  Trust the occasion and agree to add a new server key </li><li>  Add a <i>VisualHostKey = key</i> flag, while the client displays a visual representation of the server's public key, this representation is unique and will make it easier to remember the key </li><li>  A flash drive or open source: this is an option for paranoids, however, if the compromise of the system can cost tens of thousands of dollars, it is not superfluous. </li></ol><br><img src="https://habrastorage.org/webt/lo/te/er/loteerefc8y8ia38hkkxofbv9cs.png" alt="image"><br>  <i>Using public key visualization</i> <i><br></i> <br><img src="https://habrastorage.org/webt/ch/wf/hk/chwfhkp5_iqja60_3rdihrpq7zi.png" alt="image"><br>  <i>If the public key has changed</i> <i><br></i> <br>  The message about the change of key can occur for several reasons: <br><br><ol><li>  Server address changed </li><li>  The server key has changed, for example, when reinstalling the system </li><li>  MITM attack </li></ol><br>  From my practice, 1 and 2 options in the amount tend to 100%, but paragraph 3 can not be excluded, too. <br><br>  Here is an example of life hacking that combines web and ssh approaches. <br><br><pre> <code class="bash hljs">curl https://server.com/ssh_fingerprint | tee -a ~/.ssh/known_hosts</code> </pre> <br>  At first glance, this is not very safe, however, this information can be obtained using the command <br><br><pre> <code class="bash hljs">ssh-keyscan example.com</code> </pre> <br>  However, in the first version, we additionally verify the authenticity of the received key using HTTPS. <br><br>  In critical CI / CD combination use <br><br><pre> <code class="bash hljs">ssh-keyscan example.com &gt;&gt; ~/.ssh/known_hosts</code> </pre> <br>  during initialization together with <br><br><pre> <code class="bash hljs">StrictHostKeyChecking=yes</code> </pre> <br>  will reliably protect against MITM attacks. <br><br><h2>  Many keys </h2><br>  You can often find this picture: <br><br><img src="https://habrastorage.org/webt/f7/hy/eo/f7hyeosyaw35rdoib4dpw19uxmo.png" alt="image"><br><br>  For each server on the client generated their key pairs, and in <i>$ HOME / .ssh /</i> creates a complete mess. <br><br>  On the one hand, it is safer than using one pair of client keys ‚Äî if one key is compromised, only one system becomes compromised, and not all that the user worked with. <br><br>  However, as practice shows, users are guided by this last, often they simply follow all the instructions step by step: <br><br><pre> <code class="bash hljs">ssh-keygen ... ...</code> </pre><br>  Sometimes I observed a situation where some keys were rubbed off by others without any thought in my head. <br><br><img src="https://habrastorage.org/webt/lg/di/dc/lgdidcy2mpvtwyegh2qvypappqy.png" alt="image"><br><br>  Let me remind you: if you pursue paranoid security, it is enough to have one pair of keys, but at the same time it must be properly protected. <br><br><h2>  Speaking of key protection </h2><br><img src="https://habrastorage.org/webt/lp/hq/ct/lphqctzrmf346nw_eh3isssi_-m.png" alt="image"><br><br>  Regard your private SSH-key as the key to the apartment where the money is.  I did not see a more careless attitude to SSH keys.  If users are more or less aware of the seriousness of saving passwords, then units think about the fact that no one should be given access to a private key. <br><br>  What can be distinguished here: <br><br><ol><li>  Keep the key in a safe place, ideally it is encrypted storage. </li><li>  Not to give anyone access to the key, a compromised key compromises all systems where access is allowed on it </li><li>  Encrypting a private key increases security because  If you lose the key, you also need to get a password to decrypt it, or spend time and computing power on hacking it. </li><li>  Do not forget to install the correct permissions on the key file 400, by the way, this is a common mistake when the client refuses to use the key </li></ol><br>  You can change or add a password using the command <br><br><pre> <code class="bash hljs">ssh-keygen -p</code> </pre> <br><h2>  Ssh-agent </h2><br>  But often there is a situation when you need to go to the server with your key and already use it there.  There are three solutions to this problem: <br><br><ol><li>  Copy your private key to the server </li><li>  Generate a new key pair and set it as an access option. </li><li>  Use ssh-agent </li></ol><br>  From my practice, users in 90% of cases choose the first two options, and, as we have said, there is nothing more terrible than compromising a key. <br><br>  I recommend using the third method. <br><br><img src="https://habrastorage.org/webt/ij/oc/d1/ijocd1ztk67lvvde3tex3wv0cb4.png" alt="image"><br><br>  SSH-agent stores secret keys and, when necessary, uses them.  A program (for example, ssh), when it needs to use a secret key, does not do it itself, but refers to the ssh-agent 's, which, in turn, already uses only the data about the secret keys known to it.  Thus, the secret keys are not disclosed to anyone, even programs owned by the user. <br><br>  The ssh-agent command creates a socket file named /tmp/ssh-XXXXXXXX/agent.ppid, through which the interaction with the agent is performed.  All child agent processes using the environment variables SSH_AUTH_SOCK (in which the name of the socket file is stored) and SSH_AGENT_PID (in which the agent process identifier is stored) provide information on how to communicate with it. <br><br>  The agent provides information in a form suitable for use by the command interpreter. <br><br><pre> <code class="bash hljs">SSH_AUTH_SOCK=/tmp/ssh-XXt4pHNr/agent.5087; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> SSH_AUTH_SOCK; SSH_AGENT_PID=5088; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> SSH_AGENT_PID; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Agent pid 5088;</code> </pre> <br>  When specifying the -c option, the agent uses the C Shell syntax.  By default (and when explicitly specifying the -s option), the Bourne Shell syntax is used.  These variables should be set in the current shell, so usually the ssh-agent call is combined with the eval command. <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> `ssh-agent` Agent pid 5088</code> </pre> <br>  The agent works until it is explicitly terminated by a signal or a call. <br><br><pre> <code class="bash hljs">$ ssh-agent -k</code> </pre> <br>  The list of secret keys known to the agent can be viewed with the same ssh-add command with the -l command line key.  The team will report and fingerprint for each key. <br><br><pre> <code class="bash hljs">$ ssh-add -l 1024 46:88:64:82:a7:f9:aa:ea:3b:21:9e:aa:75:be:35:80 /home/user/.ssh/id_rsa (RSA)</code> </pre> <br>  An example of working with ssh-agent can be seen below. <br><br><img src="https://habrastorage.org/webt/gn/pi/nw/gnpinw2ubgdbjfe8ozz54hvaoww.png" alt="image"><br><br>  In addition, the agent solves another problem: if you encrypt a private key, then when you access it, you will not be asked for a password each time.  If you use an agent, then the password will need to be entered only when adding a key to the agent. <br><br><h2>  Local config </h2><br>  Had every time I watched typing a string like <br><br><pre> <code class="bash hljs">ssh -p 2022 user@server.com -o StrictHostKeyChecking=yes -i ~/.ssh/server.pem</code> </pre> <br>  I was given a ruble, I would have lived in Sochi a long time ago. <br><br>  On the local machine, you can find the file <i>$ HOME / .ssh / config</i> <br><br><pre> <code class="hljs pgsql">Host <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> root HostName <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> IdentityFile ~/.ssh/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.pem Host example.com <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> IdentityFile ~/.ssh/production.pem</code> </pre><br>  Accordingly, you can register most of the parameters for the host in this file and not enter it every time. <br><br><h2>  How else can security be improved? </h2><br>  1. When using key authentication, do not forget that there is still a password, and no matter how you protect your private key, an attacker can pick up your qwerty password and log in without needing to steal the key <br><br>  There are several solutions: <br><br><ul><li>  Set a very complex password that will be difficult to pick up and store it in a protected place.  This will allow you to have an alternative way to log in. </li><li>  Delete the password completely, but then there may be problems with sudo and other things. </li><li>  To prohibit password authentication on the server, in fact, as a rule, this is forbidden for the root user.  It remains to ban for all users. </li></ul><br>  <b>PasswordAuthentication no</b> in <i>/ etc / ssh / sshd_config</i> <br><br>  2. You can also disable the use of ssh v1 <br>  <b>Protocol 2</b> in <i>/ etc / ssh / sshd_config</i> <br><br>  3. And be sure to close access to SSH for unreliable sources on the firewall <br><br>  4. Previously, I would advise you to change the port from the standard 22 to another, but watching how many attempts to log in on non-standard ports happen can I say unequivocally: this is not a protection against hacking. <br><br>  5. If you are already considering the selection of a password, then it will not be superfluous to configure <b>fail2ban</b> in order to limit attempts at selecting a password. <br><br>  6. The protocol and libraries periodically find problems and vulnerabilities, the poem here works a universal approach - watch for software updates and try to regularly install at least security patches. <br><br>  7. ssh-agent is safer than just copying files, however, it can also be hacked, for example, the root user on the server.  Therefore, it is recommended to include forvarding only when necessary. <br><br><h2>  findings </h2><br>  Read the documentation, everything is written in it, however it may sound. <br>  SSH is a very secure protocol, but often the human factor is the main source of problems - watch for security. <br><br>  Used materials <br>  <a href="https://www.securitylab.ru/analytics/216377.php">Security with SSH keys</a> <a href="https://www.securitylab.ru/analytics/216377.php"><br></a>  <a href="http://xgu.ru/wiki/%25D0%25A3%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B0%25D0%25BC%25D0%25B8_SSH_%25D1%2581_%25D0%25BF%25D0%25BE%25D0%25BC%25D0%25BE%25D1%2589%25D1%258C%25D1%258E_%25D0%25B0%25D0%25B3%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B0">SSH key management with agent</a> </div><p>Source: <a href="https://habr.com/ru/post/358800/">https://habr.com/ru/post/358800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358788/index.html">Holidays in the world of telecommunications</a></li>
<li><a href="../358790/index.html">Finding the number of commissions that "draw" integer turnout values ‚Äã‚Äãin the presidential election of the Russian Federation in 2018</a></li>
<li><a href="../358794/index.html">Mitapa in May: blockchain in Moscow and testing in St. Petersburg</a></li>
<li><a href="../358796/index.html">Remote control of the heating system</a></li>
<li><a href="../358798/index.html">Inverse kinematics in two-dimensional space</a></li>
<li><a href="../358802/index.html">USB3Vision and GenICam. View from the inside. I</a></li>
<li><a href="../358804/index.html">Protocol-Oriented Programming</a></li>
<li><a href="../358806/index.html">Red Hat Summit: The best moments of the main open source conference in 30 minutes</a></li>
<li><a href="../358808/index.html">Promise guide for those who want to understand them</a></li>
<li><a href="../358810/index.html">‚ÄúLife after Java 10‚Äù: what changes Java 11 will bring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>