<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hardware protection against piracy on Windows RT 8.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reading a small note on a well-known news resource, I saw a funny introduction: ‚Äú New Microsoft tablets seem to be created in order not to buy them .‚Äù...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hardware protection against piracy on Windows RT 8.1</h1><div class="post__text post__text-html js-mediator-article">  Reading a small note on a well-known news resource, I saw a funny introduction: ‚Äú <i>New Microsoft tablets seem to be created in order not to buy them</i> .‚Äù  The doubtful, in my opinion, statement is still supported by the difficult fate of the first version of the Surface RT and the amazing similarity of the new Surface 2 to it. However, our company has always been primarily about customers. <br><img src="https://habrastorage.org/getpro/habr/post_images/aa9/9af/5e0/aa99af5e0dd85ce25e21c4295935e909.png" alt="image"><br>  The essence of this article, which may seem a bit provocative to Habr's readers, is as follows: at the end of 2013, we will introduce a new Guardant Code micro electronic key to protect applications on Windows RT from piracy.  Someone, perhaps, is already twisting his finger at his temple, but we do offer developers serious (!) Windows RT applications to protect their software with a hardware key. <br><br>  In the article you will learn: <br>  1. Why did we need Windows RT 8.1 and why the first Windows RT is bad in terms of our tasks <br>  2. How the whole structure works <br>  3. How the limited architecture did not allow us to provide support for the electronic key in the form of a microSD card <br>  4. ... and what crutches can I get around <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  First contact </h4><br>  Even before the release of Surface, we discussed the possibility of expanding the list of our target platforms on Windows RT.  Yet a certain faith in Microsoft was present, besides, they have money.  With money and the right approach, you can unleash anything on the market ‚Äî although so far they haven't really got it.  At the same time, Android also became the king of the smartphone market not in one day - so time will show the correctness of the MS strategy.  In any case, we got the first version of the Surface a year ago, studied it closely and decided not to do anything.  It is dangerous to climb into a non-existent market with our products - it was necessary to wait for the results of Surface sales for a couple of quarters and evaluate the interest of our category of customers. <br><br>  We waited, made conclusions - and put Surface in the far drawer of the table. <br><br>  This status of the project lasted until mid-summer of 2013, when Microsoft [apparently out of hopelessness] decided to give impetus to its product and began distributing it almost free of charge to the field of education (I exaggerate, of course), and also made a price-drop for everyone else.  And in the field of education, in fact, there are serious products and there is piracy.  So, the input data for July 2013: there is a ‚Äúpromising‚Äù platform, there are interested customers, there is a ready-made base in the form of the Guardant Mobile project (focused on Android with microSD and USB keys).  Getting to work. <br><br><h4>  Unsuccessful attempt </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/841/2a1/02e/8412a102ecb6fc2e5672aaa646716aa9.png" alt="image"><br><br>  We started with our youngest and very niche product: Guardant SD.  It is a microSD card with a microcontroller (hardware accelerated cryptography) and 4GB of general-purpose memory.  This thing allows you to load into yourself and execute on board applets in Java using a very simple API.  Architecturally, everything is very similar to our Guardant Code key, and is sharpened for application protection.  Expensive business applications, for example, ‚ÄúMobile Waiter‚Äù on Android tablets.  The meaning is this: we place an important part of Java code into an applet, embed calls to our API in place of the cut code - and everything, part of the code is now executed on the map, the application, in addition to a set of bytes, receives an uncopyable hardware artifact and piracy says absolutely no.  It works on Android, Windows, Linux and we tried to make it work on Windows RT. <br><br>  Did not work out.  The setup came from, let's say, the partial limitation of Windows RT. <br><br>  It all started with the fact that wonderful, convenient and user-oriented Windows RT categorically refuses to see files with the "hidden" flag.  In principle, why do they need a competitor iPad.  Lyrical digression: the exchange with the key occurs through a regular file on the card, which by default is created by the microcontroller as hidden.  Actually, forcing Surface to see this file turned out to be virtually impossible. <br><br>  However, in reality this is avoidable.  If you carry out the pre-sale preparation of the card on any other platform - you can forcibly create this file unhidden, and the microcontroller will not touch this flag.  Of course, the very first formatting of the card or deleting a file will make the key inoperable, but you can always recreate this file. <br><br>  The real problem came from another place, even though it‚Äôs nearby.  It all happened this way: we sported the main part of the code (the base of the low-level library implementing the exchange protocol with the card), tried to send the APDU to the card ‚Äî and we cannot move beyond the first command.  The feeling that the microcontroller simply does not want to give us the answers.  In general, we did not have long to rummage through the Internet and torment the manufacturer of the microcontroller: in Windows RT, non-switchable read buffering was discovered.  Those.  You can send a request to the card and flush the record, but you can not read the answer - it takes it from the buffer.  Obviously, Windows RT cannot assume that the file on the card can be changed <i>from within</i> it, in our case, by the microcontroller.  A hundred man-hours of expensive development, although it was practically flushed down the toilet, but allowed us to better explore the platform. <br><br>  Naturally, we rummaged through all the documentation and the Internet, talked to representatives of Microsoft, but got a line on the hands and left this project - it is impossible, it is impossible. <br><br>  However, our engineering minds were not ready to give up so easily.  It was hard to believe that there would not be a pair of crutches to circumvent this limitation.  They found.  Here is a two-step recipe: <br><br>  1. Create a file on the card for the exchange of 400 MB. <br>  2. We force the firmware to write the microcontroller's answers sequentially, and not all the time to the beginning of the file. <br><br>  And here it is, unreliable and crooked - but a working solution.  With this file size, Windows RT does not decide to cache it for reading completely, and since the answer is always written to a new address in the exchange file, it is perfectly readable.  Slowly - due to the size of the file - but read. <br><br>  Despite the solution found, it did not go into production due to the following concerns: <br><br>  ‚Ä¢ A significant increase in RAM in future Surfaces may allow Windows RT to still cache this file for reading in its entirety (or at least in significant parts) <br>  ‚Ä¢ We eat off a significant part of the 4GB flash memory card (and the slot for microSD in the tablet only) <br>  ‚Ä¢ When 400MB runs out, the answers need to loop and write to the beginning of the file - and there already something can be cached <br>  ‚Ä¢ It all works rather slowly. <br><br>  Of course, we were pleased with our ingenuity, but decided to try to adapt Guardant Code micro USB to the tablet.  Fortunately, the USB port is guaranteed there and the micro-key doesn‚Äôt interfere much (see the picture at the beginning of the article). <br><br><h4>  Second failed attempt </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/3bf/c3d/726/3bfc3d7263421f4197b419aabc9e546d.png" alt="image"><br>  Deciding that with a USB key we would not run into these problems, we rushed into battle.  Translated the key into the HID mode, stuck into the tablet - the key was determined, the LED is on.  You can start sharing data. <br><br>  We were again disappointed.  In the WinRT API, there was not a single way to send something to a custom USB device, even despite our honest support for HID.  Microsoft, of course, designed Windows RT as a closed ecosystem (operating system, hardware, single application store) - but this is shameless closeness. <br><br>  By the end of July, the situation was as follows: hands are falling, our devices do not adapt to Surface, it's time to tell customers a decisive and reasonable "no." <br><br>  And here we pay attention to the announced Windows RT 8.1, and already available Preview version. <br><br><h4>  The third attempt, successful </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/0ea/a62/edb/0eaa62edbbb8b18a55ab88ad648cdc5d.png" alt="image"><br>  On Windows RT (in particular, on Surface) a rather compulsory Windows Update is implemented.  Thus, it can be assumed that the majority of Surface users (no matter how small their number may seem) will not take long to upgrade to 8.1.  At the same time, in the new version, a pleasant surprise awaited us: support for working with arbitrary HID devices.  As mentioned earlier, our modern dongles can work with a proprietary protocol that requires a driver, or in the HID mode.  Work without a driver slightly reduces the speed and security of the exchange, but does not create any critical situation.  Since for mobile platforms we support only Code, security still depends on the code that the client will transfer from the application to execute it on board the key. <br><br>  The development process for Windows 8.1 was predictably successful.  The new APIs from MS were excellent, even in the Preview version, and we didn‚Äôt face any significant difficulties.  And finally, on the third attempt, we had a product for protection against piracy on Windows RT. <br><br>  In fact, the developed library allows you to split the application into two parts: <br><br>  1. Application for Windows Store <br>  2. The key intellectual part rendered to the Code key (up to 50,000 lines of C code). <br><br>  The code is called by a single CodeRun function, with an input and output buffer and a selector (to make a switch inside and select the desired code fragment for execution).  Of course, you can create arbitrarily cunning logic using buffers to maximize the difficulty of analysis. <br><br>  In fact, we get two things ‚Äúfor the price of one‚Äù: with a successful choice of a downloadable code, we have protection from analysis and modification (an important code inside the key), and, of course, we get an uncopyable entity in the form of a hardware key, which is an integral part of the application. <br><br>  And a few important things in the end: <br><br>  ‚Ä¢ In the application manifest, you need to manually add lines to allow work with dongle <br>  ‚Ä¢ Even the most innocuous access to the key requires confirmation via the GUI dialog, so with the unit test library without a GUI, this is not even tested - there will be an exception <br>  ‚Ä¢ You can not access the key from the main program thread <br><br>  On this note, my story about Windows RT and copyright, I finish.  As far as the hardware keys of protection are needed and appropriate at the end of 2013 on a platform that has not yet been spun, time will tell.  At least MS was able to bail out $ 400 million from Surface sales in the last quarter, which is already a good sign, especially after writing off $ 900 million the year before last. </div><p>Source: <a href="https://habr.com/ru/post/199016/">https://habr.com/ru/post/199016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199006/index.html">The Government of the Russian Federation has prepared the text of the decision on the petition to cancel the 187-FZ (# Law against Internet)</a></li>
<li><a href="../199008/index.html">Font Awesome 4 released</a></li>
<li><a href="../199010/index.html">Growth Hacking - what is it for, what it is eaten with or ‚Äúhow SEO died‚Äù</a></li>
<li><a href="../199012/index.html">DSL to JavaScript for C ++ or code generator - it's easy!</a></li>
<li><a href="../199014/index.html">About gdemvd.ru</a></li>
<li><a href="../199018/index.html">Firmware update for Sony Xperia Z1 and Z Ultra</a></li>
<li><a href="../199020/index.html">"Union" lost a lawsuit to "Vkontakte"</a></li>
<li><a href="../199026/index.html">Development of cross-platform mobile applications in Delphi # 1</a></li>
<li><a href="../199028/index.html">Webasyst Blogging Blog Review</a></li>
<li><a href="../199032/index.html">Seized in the UK part of the "first in the country of printed weapons" were spare parts for a 3D printer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>