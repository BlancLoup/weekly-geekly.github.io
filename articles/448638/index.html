<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Buildroot - part 1. General information, building a minimal system, setting through the menu</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 In this series of articles, I want to consider the buildroot distribution system build system and share its customization experience....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Buildroot - part 1. General information, building a minimal system, setting through the menu</h1><div class="post__text post__text-html js-mediator-article"><h2 id="vvedenie">  Introduction </h2><br><p>  In this series of articles, I want to consider the buildroot distribution system build system and share its customization experience.  There will be practical experience in creating a small OS with a graphical interface and minimal functionality. </p><br><p>  First of all, do not confuse the build system and distribution.  Buildroot can build a system from a set of packages that have been offered.  Buildroot is built on makefiles and therefore has great customization capabilities.  Replace the package with another version, add your package, change the package building rules, customize the file system after installing all the packages?  All this can buildroot. </p><br><p>  In Russia, buildroot is used, but in my opinion there is little Russian-language information for beginners. </p><br><p>  The purpose of the work is to build a distribution with live-download, icewm interface and browser.  The target platform is virtualbox. </p><br><p>  Why build your distribution?  Often you need limited functionality with limited resources.  More often in automation you need to create firmware.  Adapting a general-purpose distribution kit, cleaning out extra packages and turning it into a firmware path is more laborious than building a new distribution kit.  Using Gentoo also has its limitations. </p><br><p>  Buildroot is a very powerful system, but it does nothing for you.  It can only enable and automate the assembly process. </p><br><p>  Alternative build systems (yocto, open build system and others) are not considered or compared. </p><a name="habracut"></a><br><h2 id="gde-vzyat-i-kak-nachat">  Where to get and how to start </h2><br><p>  Project site - <a href="https://buildroot.org/">buildroot.org</a> .  Here you can download the latest version and read the manual.  You can also contact the community, there is a bugtracker, mail-lists and irc-channel. </p><br><p>  Buildroot uses defconfig for target build boards.  Defconfig is a configuration file that stores in itself only options that have no default values.  It is he who determines what and how will be collected.  In this case, you can separately configure the configs of busybox, linux-kernel, uClibc, boot loaders u-boot and barebox, but they will all be tied to the target board. <br>  After unpacking the downloaded archive or cloning from git, we get a buildroot ready for work.  Details on the directory structure can be found in the manual, tell you about the most important: </p><br><p>  <strong>board</strong> - directory with files specific to each board.  These can be scripts for forming system images (iso, sdcart, cpio, etc.), the overlay directory, the kernel config, etc. <br>  <strong>configs</strong> is the board defconfig itself.  Defconfig is an incomplete board configuration.  Only parameters other than default settings are stored in it. <br>  <strong>dl</strong> - directory with downloaded source codes / files to build <br>  <strong>output / target</strong> - collected OS file system.  Further images are created from it for download / installation. <br>  <strong>output / host</strong> - host utilities for building <br>  <strong>output / build</strong> - <strong>build</strong> packages </p><br><p>  Build configuration is done via KConfig.  The same system is used to build the linux kernel.  The list of the most frequently used commands (run in the buildroot directory): </p><br><ul><li>  make menuconfig - call the build setup.  You can also use the GUI (make nconfig, make xconfig, make gconfig) </li><li>  make linux-menuconfig - call the kernel configuration. </li><li>  make clean - clean build results (all that is stored in output) </li><li>  make - build the system.  This does not rebuild already collected processes. </li><li>  make defconfig_name - switch configuration to a specific defconfig </li><li>  make list-defconfigs - show a list of defconfigs </li><li>  make source - only download the installation files, without assembly. </li><li>  make help - display a list of possible commands. </li></ul><br><h3 id="vazhnye-zamechaniya-i-poleznye-sovety">  Important notes and helpful tips </h3><br><p>  Buildroot does not reassemble the already assembled packages!  Therefore, a situation may arise when a complete reassembly is required. </p><br><p>  You can rebuild a separate package with the <strong>make packagename-rebuild</strong> command <strong>.</strong>  For example, you can rebuild the linux kernel: </p><br><pre><code class="bash hljs">make linux-rebuild</code> </pre> <br><p>  Buildroot stores the state of any package by creating .stamp files in the output / build / $ packagename directory: </p><br><p><img src="https://habrastorage.org/webt/us/iu/f3/usiuf3l_-ics3e8gdbnzebjszzs.png"></p><br><p>  Therefore, you can rebuild root-fs and images without rebuilding the packages: </p><br><pre> <code class="bash hljs">rm output/build/host-gcc-final-*/.stamp_host_installed;rm -rf output/target;find output/ -name <span class="hljs-string"><span class="hljs-string">".stamp_target_installed"</span></span> |xargs rm -rf ; make</code> </pre> <br><h4 id="poleznye-peremennye">  Useful variables </h4><br><p>  Buildroot has a set of variables for easy configuration. </p><br><ul><li>  $ TOPDIR - buildroot root directory </li><li>  $ BASEDIR - OUTPUT Directory </li><li>  $ HOST_DIR, $ STAGING_DIR, $ TARGET_DIR ‚Äî host fs build directories, staging fs, target fs directories. </li><li>  $ BUILD_DIR - directory with unpacked and assembled packages </li></ul><br><h4 id="vizualizaciya">  Visualization </h4><br><p>  Buildroot has the ability to visualize. You can build a dependency diagram, build timeline, schedule of packages in the final system.  The results are in the form of pdf files (there is a choice of svn, png) in the output / graph directory. </p><br><p>  Examples of visualization commands: </p><br><ul><li>  <code>make graph-depends</code> build dependency tree </li><li>  <code>make &lt;pkg&gt;-graph-depends</code> to build a dependency tree for a specific package </li><li>  <code>BR2_GRAPH_OUT=png make graph-build</code> build timeline with output to PNG </li><li>  <code>make graph-size</code> build a packet size chart </li></ul><br><h4 id="poleznye-skripty">  Useful scripts </h4><br><p>  In the buildroot directory there is a <strong>utils</strong> subdirectory with useful scripts.  For example, there is a script that checks the correctness of the package description.  This can be useful when adding your packages (I will do this later).  In the file utils / readme.txt there is a description of these scripts. </p><br><h2 id="soberem-ctokovyy-distributiv">  Let's collect stock distribution </h2><br><p>  <em>It is important to remind that all operations are conducted on behalf of a regular user, not root.</em> <br>  All commands are executed in the root buildroot.  The buildroot delivery already has a set of configurations for many common boards and virtualization. </p><br><p>  See the list of configurations: </p><br><p><img src="https://habrastorage.org/webt/us/iu/f3/usiuf3l_-ics3e8gdbnzebjszzs.png"></p><br><p>  Switching to the qemu_x86_64_defconfig config </p><br><pre> <code class="bash hljs">make qemu_x86_64_defconfig</code> </pre> <br><p>  And run the build </p><br><pre> <code class="bash hljs">make</code> </pre> <br><p>  The build is completed successfully, we look at the results: </p><br><p><img src="https://habrastorage.org/webt/pb/2v/sb/pb2vsbi3oe_repbvq6f0bkqf7ee.png"></p><br><p>  Buildroot has collected images that can be run in Qemu and make sure they work. </p><br><pre> <code class="bash hljs">qemu-system-x86_64 -kernel output/images/bzImage -hda \ output/images/rootfs.ext2 -append <span class="hljs-string"><span class="hljs-string">"root=/dev/sda rw"</span></span> -s -S</code> </pre> <br><p>  The result is a system running in qemu: </p><br><p><img src="https://habrastorage.org/webt/wz/m7/ua/wzm7uardoe4pbefa1ni8fij4pui.png"></p><br><h2 id="sozdanie-konfiguracii-sobstvennoy-platy">  Creating your own board configuration </h2><br><h3 id="dobavlenie-faylov-platy">  Adding board files </h3><br><p>  See the list of configurations: </p><br><p><img src="https://habrastorage.org/webt/om/em/sx/omemsxpgtlfovmawbojohn5ma_a.png"></p><br><p>  In the list we see pc_x86_64_efi_defconfig.  We will create our board by copying it from the configuration: </p><br><pre> <code class="bash hljs">cp configs/pc_x86_64_bios_defconfig configs/my_x86_board_defconfig</code> </pre> <br><p>  Immediately create a board directory to store your scripts, rootfs-overlay and other necessary files: </p><br><pre> <code class="bash hljs">mkdir board/my_x86_board</code> </pre> <br><p>  Switch to this defconfig: </p><br><pre> <code class="bash hljs">make my_x86_board_defconfig</code> </pre> <br><p>  Thus, now the build configuration (stored in .config in the root directory of the buildroot) corresponds to the target x86-64 legacy (bios) machine by loading. </p><br><p>  Copy the linux-kernel configuration (useful later): </p><br><pre> <code class="bash hljs">cp board/pc/linux.config board/my_x86_board/</code> </pre> <br><h3 id="nastroyka-parametrov-sborki-cherez-kconfig">  Setting build options via KConfig </h3><br><p>  Run the setup: </p><br><pre> <code class="bash hljs">make menuconfig</code> </pre> <br><p>  The KConfig window opens.  It is possible to configure with a graphical interface (make nconfig, make xconfig, make gconfig): </p><br><p><img src="https://habrastorage.org/webt/ai/6d/ub/ai6dub6beukqket6qcz3ezc9c5i.png"></p><br><p>  We enter the first section Target Options.  Here you can select the target architecture under which the assembly will be conducted. </p><br><p><img src="https://habrastorage.org/webt/pu/jl/v2/pujlv2tlusbnnenf9gstmsosyf4.png"></p><br><p>  Build options - there are various build options.  You can specify directories with source codes, the number of build threads, mirrors for downloading source codes, and other settings.  Leave the default settings. </p><br><p>  Toolchain - here the assembly toolkit is configured.  More about him. </p><br><p><img src="https://habrastorage.org/webt/mb/-e/gy/mb-egyihomze0cx9vriprqph1ly.png"></p><br><p>  Toolchain type - the type of toolchain used.  This can be either built into the buildroot or an external toolchain (you can specify the directory with the already built or the url to download).  For different architectures there are additional options.  For example, for arm, you can simply select the version of Linaro external toolchain. </p><br><p>  C library - choice of library C. The work of the whole system depends on it.  Usually glibc is used, which supports all possible functionality.  But it may be too big for the embedded system, so often choose uClibc or musl.  We will select glibc (later this will be required to use systemd). </p><br><p>  Kernel Headers and Custom Kernel Headers series - must match the version of the kernel that will be in the assembled system.  For kernel headers, you can also specify the path to the tarball or git repository. </p><br><p>  GCC COMPILER VERSIONS - select the compiler version that will be used to build <br>  Enable C ++ support - choose to build with support for c ++ libraries in the system.  In the future, it will be useful to us. </p><br><p>  Additional gcc options - you can set additional compiler options.  We needlessly for now. </p><br><p>  System configuration allows you to set future parameters of the created system: </p><br><p><img src="https://habrastorage.org/webt/3y/kk/fu/3ykkfukfm4ptl2iiiqs2bhvbn_0.png"></p><br><p>  Most of the points are clear from the title.  Pay attention to the following points: <br>  Path to the users tables - a table with created users ( <a href="https://buildroot.org/downloads/manual/manual.html">https://buildroot.org/downloads/manual/manual.html#makeuser-syntax</a> ). </p><br><p>  Sample file.  A user will be created with the password admin, automatically gid / uid, / bin / sh shell, default user group, root group member, comment Foo user </p><br><pre> <code class="bash hljs">[alexey@alexey-pc buildroot ]$ cat board/my_x86_board/users.txt user -1 user -1 =admin /home/user /bin/sh root Foo user</code> </pre> <br><p>  Root filesystem overlay directories is a directory overlaid on the compiled target-fs.  Adds new files and replaces existing ones. </p><br><p>  Custom scripts to run before creating filesystem images - Scripts executed just before the file system collapses into images.  The script itself is left empty </p><br><p>  Go to the Kernel section </p><br><p><img src="https://habrastorage.org/webt/_u/-m/ic/_u-micbjjhq3dg_hoawyozkkqgk.png"></p><br><p>  Here are the kernel settings.  The kernel itself is configured via make linux-menuconfig. <br>  You can set the kernel version in different ways: choose from the suggested ones, enter the version manually, specify the repository or the finished tarball. </p><br><p>  Kernel configuration - the path to the kernel configuration.  You can choose the default configuration for the selected architecture or defocnfig from Linux.  The Linux source has a set of defconfigs for different target systems.  You can find the right one by <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch">looking directly at the source here</a> .  For example, you can <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/arm/configs/omap2plus_defconfig%3Fid%3Dv4.13">select a config</a> for the beagle bone black board. </p><br><p>  The Target packages section allows you to choose which packages will be installed on the build system.  For now, leave it unchanged.  Later we will add our packages to this list. <br>  Filesystem images - a list of filesystem images to be collected.  Add an iso image </p><br><p><img src="https://habrastorage.org/webt/ne/gz/o-/negzo-lbw2ci9i-hnj7pzg9tm88.png"></p><br><p>  Bootloaders - the choice of collected loaders.  Choose isolinix </p><br><p><img src="https://habrastorage.org/webt/ax/nb/qy/axnbqyxbxffyyyqz7qgle5ectgu.png"></p><br><h3 id="konfigurirovanie-systemd">  Configuring Systemd </h3><br><p>  Systemd becomes one of the linux posts, along with kernel and glibc.  Therefore, I made its setting in a separate item. </p><br><p>  It is configured via make menuconfig, then Target packages ‚Üí System tools ‚Üí systemd.  Here you can specify which systemd services will be installed and started at system startup. </p><br><p><img src="https://habrastorage.org/webt/_3/nk/sk/_3nkskizxu-lxd5pvq4fr9dqn5c.png"></p><br><h3 id="sohranenie-konfiguracii-sistemy">  Saving system configuration </h3><br><p>  We save this config via KConfig. </p><br><p>  Then save our defconfig: </p><br><pre> <code class="bash hljs">make savedefconfig</code> </pre> <br><h3 id="konfigurirovanie-yadra-linux">  Configuring the Linux kernel </h3><br><p>  Configuring the linux kernel is invoked with the following command: </p><br><pre> <code class="bash hljs">make linux-menuconfig</code> </pre> <br><p>  Add support for Virtualbox </p><br><p><img src="https://habrastorage.org/webt/xg/tx/2x/xgtx2xqc52qpvqhzhpojpk3tebs.png"></p><br><p>  Add Virtualbox Guest integration support </p><br><p><img src="https://habrastorage.org/webt/uy/vu/f0/uyvuf00a4y_ulkpvqjwmzi4but8.png"></p><br><p>  Save and exit.  <strong>IMPORTANT</strong> : the configuration will be saved in output / build / linux- $ version / config, but not in board / my_x86_board / linux.config </p><br><p><img src="https://habrastorage.org/webt/wp/qy/dm/wpqydmxqz1j3ttq_5vcom1uv38q.png"></p><br><p>  Therefore, you need to manually copy the config to the storage location: </p><br><pre> <code class="bash hljs">cp output/build/linux-4.19.25/.config board/my_x86_board/linux.config</code> </pre> <br><p>  With this command, I copy the FULL kernel configuration, which is not always necessary.  A better way is to save the kernel defconfig: </p><br><pre> <code class="bash hljs">linux-update-defconfig</code> </pre> <br><p>  After that, we will perform a complete reassembly of the entire system.  Since buildroot does not reassemble already assembled, then you must manually specify the packages for reassembly.  In order not to waste time and nerves, it‚Äôs easier to rebuild a small system entirely): </p><br><pre> <code class="bash hljs">make clean;make</code> </pre> <br><p>  When the build is completed, we start VirtualBox (tested on version 5.2 and 6.0) with booting from a cd-disk. System parameters: </p><br><p><img src="https://habrastorage.org/webt/mi/_-/pb/mi_-pb0m79dbqf1tpg8x72hk9vk.png"></p><br><p>  Run from compiled iso: </p><br><p><img src="https://habrastorage.org/webt/ai/uq/uw/aiuquwkxe2-ac9hom0h5vdpnjve.png"></p><br><h2 id="spisok-ispolzovannyh-materialov">  List of materials used </h2><br><ol><li>  Buildroot manual </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/448638/">https://habr.com/ru/post/448638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448626/index.html">DDoS to help: how we conduct stress and stress tests</a></li>
<li><a href="../448628/index.html">Soviet technical aesthetics and technology</a></li>
<li><a href="../448632/index.html">Is Java now paid? Dispel rumors (or not?)</a></li>
<li><a href="../448634/index.html">Ukrainian lessons</a></li>
<li><a href="../448636/index.html">Hackaday case for retrocomputer badge</a></li>
<li><a href="../448642/index.html">Mandatory distribution model of rights in FreeBSD</a></li>
<li><a href="../448644/index.html">Applicative regular expressions as a free alternative functor</a></li>
<li><a href="../448648/index.html">How to spread all on science and not to turn the office into a hotbed of hatred</a></li>
<li><a href="../448652/index.html">Mozilla WebThings on Raspberry Pi - Getting Started</a></li>
<li><a href="../448654/index.html">Mozilla WebThings - gateway setup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>