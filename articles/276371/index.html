<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Digital Rain" for Windows in 314 bytes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to the recent topic, a discussion has arisen: to what size can you shrink the Windows EXE typing in the ‚ÄúHello, World!‚Äù Console? Answe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Digital Rain" for Windows in 314 bytes</h1><div class="post__text post__text-html js-mediator-article">  In the comments to the <a href="https://habrahabr.ru/post/275861/">recent topic,</a> a discussion has arisen: to what size can you shrink the Windows EXE typing in the ‚ÄúHello, World!‚Äù Console? <a href="https://habrahabr.ru/post/275861/">Answer: 268 bytes,</a> smaller Windows files simply refuse to load. <br><br>  If ‚ÄúHello, World!‚Äù Has already reached the limit of possible contractions, then I wondered to what extent a program can be compressed that does at least something more interesting. <br><br>  First, I boast about the result: my program is only 46 bytes more than the theoretical minimum! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://hsto.org/files/28d/49c/4c3/28d49c4c317d4944b3fc065d0bcba275.gif"><br><br><div class="spoiler">  <b class="spoiler_title">base64</b> <div class="spoiler_text"><pre>  TVprZXJuZWwzMgAAUEUAAEwBAQC4AwABAPdlEIlFEMN4AA8BCwEFDL0UEEAAjXyNAFfraD
 gQAAAzyesoDAAAAAAAQAAAEAAAAAIAAAAAAAACAgoCBAAAAAAAAAAQAAAAAIAALFQ68AD
 AAAAEgEAAAAAAABABABAAAAAFAFAQADAAAAAAAAAAAAAAAoEQAAKAAAAAAAAAAAAAAAA / 9
 Wr4vvrEQAAMAAAABAAADkBAAABAAAAi / df6wMAAAAzybFQV4sHgPwZdygPttyNHJvB4waN
 HItQweAYwegei0RFOIhEMwKIpDPC / v /// 9WIJDNY / sSA / GR8Av / Vq + LFjUVcUFH / dWhWZZ
 tBMItAEP9wHP9VWOuiV3JpdGVDb25zb2xlT3V0cHV0QQBsEAAAAAAAAAAAAAACAAAAAbBA = </pre><br>  (If there is a volunteer to kill these 314 bytes, I will add a link here.) </div></div><br><br><a name="habracut"></a> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9a7/5d8/376/9a75d8376677a2e46f1bb16902097582.gif"></a> <br><br>  Previous enthusiasts have found that the smallest program for Win2000 and WinXP occupies <a href="http://www.phreedom.org/research/tinype/">133 bytes</a> ;  The smallest 32-bit program for Windows x64 is <a href="http://www.bigmessowires.com/2015/10/08/a-handmade-executable-file/">268 bytes</a> .  The last limitation is tightly wired into the Windows x64 bootloader: if from the beginning of the PE header to the end of the file is less than <code>IMAGE_NT_HEADERS64</code> = 0x108 bytes, then Windows refuses to load the file.  The PE header cannot start earlier than at offset 4, therefore the program content, which occupies ( <a href="http://www.alex-ionescu.com/%3Fp%3D211">in the minimum possible version</a> ) even less than 268 bytes, has to be finished with zeros to the minimum acceptable size. <br><br>  Existing examples of programs of 268 bytes do not contain any sections, and in fact, they are entirely placed inside the PE header, for which Windows allocates one page of memory (4KB) for loading.  But for ‚ÄúDigital Rain‚Äù you need to keep a screen buffer (80 columns √ó 25 lines √ó 4 bytes per character = 8000 bytes), so you cannot do without a section in the program.  This is not so wasteful: the section header is only 0x28 bytes, of which more than half are not used, so they can be occupied with code.  In fact, ‚Äúinside‚Äù of the section - after its header - in my program are part of the executable code, the name of the function being imported, and part of the import table (the last 0x16 of its bytes are zero, and are not stored in the file).  The import table and the subsequent 8KB of memory during operation are used to store data (state array and screen buffer).  All initialized data, part of the service information (import chain and library name), and part of the code are pushed through the headers.  ‚ÄúDouble up‚Äù the following: Headers <code>PointerToRelocations, PointerToLinenumbers, NumberOfRelocations, NumberOfLinenumbers</code> and <code>Characteristics</code> .  For the <code>Characteristics</code> field (section flags) it was enough that the MSB was set ( <code>IMAGE_SCN_MEM_WRITE</code> );  Restrictions are also imposed on the values ‚Äã‚Äãof some other fields ‚Äî for example, <code>SizeOfStackCommit</code> and <code>SizeOfHeapReserve</code> should be placed in memory.  The value of the <code>PointerToLinenumbers</code> field is mistakenly taken by the system for the size of the debugging information table, and if there is a value larger than the program size in memory (0x4000), the program crashes upon loading. <br><br>  In the previous "minimal" programs, the values <code>FileAlignment</code> = 4 and <code>SectionAlignment</code> = 4 were used.  In a file without sections, Windows x64 allows this;  but if at least one section is declared, then <code>FileAlignment</code> must be at least 0x200, and <code>SectionAlignment</code> must be 0x1000.  Therefore, it is impossible to create a program of 268 bytes in size that would have a section: the overlap of <code>e_lfanew</code> = 4 and <code>SectionAlignment</code> unacceptable.  Move the PE header by 4 bytes a little, because <code>ImageBase</code> must be a multiple of 0x1000.  It turns out that the minimum possible size of a program with a section is 276 bytes, with overlapping <code>e_lfanew</code> = 0xC and <code>BaseOfData</code> .  In other words, my program is 38 bytes more than the minimum possible, which would use&gt; 4K of memory. <br><br>  I tested the performance of my program on Win7 and Win2008.  On WinXP, my program, unfortunately, does not work ( <b>edit: it</b> works, but after a time) - it refuses to load programs that have less than 0xD entries in the directory.  If in the ‚ÄúHello, World!‚Äù Program all the code is 0x10 bytes, and they don‚Äôt mind typing 0x50 zero bytes into the file for WinXP compatibility, I felt sorry for inflating the program a quarter of a size for this.  I apologize to all lovers of vintage OS. </div><p>Source: <a href="https://habr.com/ru/post/276371/">https://habr.com/ru/post/276371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276361/index.html">Census Analyzer 1.0: A New Data Analysis Tool</a></li>
<li><a href="../276363/index.html">How to sell an application that does not make a profit? And how much does it cost?</a></li>
<li><a href="../276365/index.html">How the Zeptolab Game Designer Challenge was created</a></li>
<li><a href="../276367/index.html">Pitfalls of Consciousness: How researchers cheat themselves</a></li>
<li><a href="../276369/index.html">Machine learning from Octave \ Matlab to Python</a></li>
<li><a href="../276373/index.html">Social CRM. Collecting the interest of Internet users</a></li>
<li><a href="../276377/index.html">Reducing the size of a thin disk in ESXi</a></li>
<li><a href="../276381/index.html">Who should live and who should die: priorities of processes in Android</a></li>
<li><a href="../276383/index.html">Habra graph, community and where did all the karma go</a></li>
<li><a href="../276385/index.html">Hyper-scale server farm Amazon, Apple, Google, Switch, Toyota</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>