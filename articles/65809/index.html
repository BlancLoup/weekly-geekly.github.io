<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cache HTML Blocks with nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's no secret that users love when content on the site is updated more often than once a year. This love of users for dynamic pages is shared by sear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cache HTML Blocks with nginx</h1><div class="post__text post__text-html js-mediator-article"> It's no secret that users love when content on the site is updated more often than once a year.  This love of users for dynamic pages is shared by search engines.  Google, for example, can detect the presence of updated blocks on a page and adds some karma to it (read PR). <br><br>  However, dynamic content is quite poorly combined with large loads.  For a web server, returning a static page is a much simpler task than running code that generates this page dynamically.  In some cases, the pregeneration of all possible page options may help, but it will not save if there are too many of them, or the page is updated too often. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A simple example - suppose you had a wonderful static HTML that was given to nginx at a speed of 2000 times per second (this is achievable without any problems).  And here the good designer drew a new version of the page, where for logged-in users there is a small block containing a login, first name, and, for example, an avatar. <br><br>  Everything has arrived.  You can't get away with static here, which means running PHP (Perl / Python) for each request, checking the session, crawling over the file system (or, even worse, the database) in order to find a login using SID and other information about the user.  Performance sags tenfold.  Or not.  :) <br><br>  This problem can be solved quite easily if you use two useful features provided by the nginx web server. <br><br>  The feature number that has been in it since time immemorial is SSI.  In order to use it, we make a small script that can receive a session ID from a cookie, and give only that small block with information about the user.  That is, a request of the form <code>GET /get_user_info.php</code> gives an HTML fragment, like &lt;div class = "login"&gt; Hello, Vasily Pupkin &lt;/ div&gt;. <br><br>  Accordingly, in the page itself we write SSI-include: <code>&lt;!--# include virtual="/get_user_info/" --&gt;</code> . <br><br>  In order for this construction to work, the corresponding location must be described in the nginx config file: <br><br> <code><a href="http://127.0.0.1/"></a> location /get_user_info/ { <br> proxy_pass 127.0.0.1:12345/get_user_info.php; <br> proxy_pass_header Cookie; #   sid  Cookie <br> } <br></code> <br><br>  However, as you have probably already noticed, such a construction does not solve the problems with the performance of the code, but only allows to bring the dynamic part into a separate script.  Ok, this is exactly what feature number two is needed for - caching proxy requests.  In the production-branch, it appeared relatively recently, but it allows you to do a lot.  :) <br><br>  So, for a start, let's say nginx, where we want to store our cache. <br> <code>proxy_cache_path /var/nginx/cache <br> levels=1:2 keys_zone=my_cache:64m max_size=1024m <br> inactive=1d; <br></code> <br><br>  This line means that we are creating a new zone for the cache called my_cache, the cache files will be in / var / nginx / cache, taking up no more than 1 gigabyte, and stored for no more than 1 day. <br><br>  Now let's say nginx that we want to cache requests for our location. <br><br> <code><a href="http://127.0.0.1/"></a> location /get_user_info/ { <br> proxy_pass 127.0.0.1:12345/get_user_info.php; <br> proxy_pass_header Cookie; #   sid  Cookie <br> <br> proxy_cache my_cache; <br> proxy_cache_valid 200 3h; #          :) <br> proxy_cache_valid any 0; #   500  400  <br> proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504 http_404; #        ,    ,   ,      <br> proxy_cache_key "$scheme$proxy_host$uri$is_args$args$cookie_sid"; <br> } <br></code> <br><br>  Pay attention to the last line.  It will allow us to give each individual user the correct version of the cached block.  More precisely, its last parameter is important - the $ cookie_sid variable, the value of which will always be equal to the value of the cookie with the name ‚Äúsid‚Äù, which the user must give you. <br><br>  Everything.  Now nginx itself will, as necessary, access your script and cache the result of its work.  At the same time, the performance will almost never fail, and the load on the server will not increase very much. <br><br>  All those who are interested in the details, I send to the site of the author nginx for the documentation: <a href="http://sysoev.ru/nginx/docs/">sysoev.ru/nginx/docs</a> . <br><br>  UPD: Understood with the settings, transferred to the blog nginx. </div><p>Source: <a href="https://habr.com/ru/post/65809/">https://habr.com/ru/post/65809/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65798/index.html">Lambda expressions are now in C ++</a></li>
<li><a href="../65801/index.html">Full bowl: work at home, with his wife and small child</a></li>
<li><a href="../65802/index.html">Now iPhone maniacs can also create traffic jams</a></li>
<li><a href="../65803/index.html">‚ÄúSpend the summer with benefits‚Äù - SQL Server Training Offer</a></li>
<li><a href="../65807/index.html">Mobile unlimited from Megaphone</a></li>
<li><a href="../65810/index.html">Free second higher education</a></li>
<li><a href="../65811/index.html">Happy holiday dear% username%</a></li>
<li><a href="../65812/index.html">Google Wave Address Exchange</a></li>
<li><a href="../65814/index.html">Video review of the game "Ghostbusters: The Video Game"</a></li>
<li><a href="../65815/index.html">FAQ: ‚ÄúWhy do I use Blackberry?‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>