<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About search video say a word</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, on this fine spring day, I want to write not only about video search, but also about technical 
 Implementing work with Sphinxsearch in a loade...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About search video say a word</h1><div class="post__text post__text-html js-mediator-article"><p>  Today, on this fine spring day, I want to write not only about video search, but also about technical <br>  Implementing work with Sphinxsearch in a loaded Django project. </p><br><p><img src="https://habrastorage.org/files/7a1/94d/9e1/7a194d9e141642758b1c61ee8a365d14.png" alt="Search"></p><br><p>  It is worth starting, perhaps, with setting a business problem: </p><br><ul><li>  Search for <em>relevant</em> videos by title, description and other textual data. </li><li>  For each video you should look for <em>similar</em> videos. </li><li>  It is necessary that the <em>necessary</em> videos were shown in issuing the <em>necessary</em> requests in the <em>right</em> places. </li></ul><br><p>  And non-functional requirements: </p><br><ul><li>  Django-project with dofig views and constant updates of video descriptions </li><li>  Encapsulation of work with the search engine in the library and compatibility with other libraries on the site (first of all, Django REST Framework) </li></ul><br><p>  About how sphinxsearch is used in Rutube and there will be a given story. </p><a name="habracut"></a><br><h2>  About the relevance of video and mathematics </h2><br><p> When they talk about searching on the Internet, it usually means looking for textual information.  In the case of the video is much worse.  Usually, a person has in mind a very specific visual image, which itself translates into the text of the request.  Other people who uploaded videos to the site translated the contents of the video into the title and description of the video, and it‚Äôs good if it isn‚Äôt "test", "sdfsdf" or "111".  In any case, only a minimum of textual information is available, and sometimes some metadata provided by the editors and partner users.  So if you are a search programmer, the questions ‚Äúwhy, on request,‚Äú rp ‚Äùare not searched,‚Äú Real Guys ‚Äùwill haunt you at night. A special test utility helps us to answer such questions. <br>  This is a page that, by a search query, returns not only videos with all the fields in the index, but also information from the rancher with the values ‚Äã‚Äãof all the characteristics for each document.  For this, <code>PACKEDFACTORS()</code> , <code>SNIPPETS()</code> and <code>CALL KEYWORDS</code> requested.  Data from this page is usually enough to mathematically substantiate what is called <em>irrelevant</em> (here it is, this is a magic word that only programmers understand in a mathematical sense, and all the rest - in a spiritual one!) ... So, to justify why the <em>irrelevant</em> video turned out above <em>relevant</em> . </p><br><h2>  Django-backend search database </h2><br><p>  Since Sphinxsearch supports a mysql client, then why not take a backend for Django, which would build the necessary search queries, and then return the results as Django models?  I do not suggest everyone to try to do <em>this</em> , but it really is not so scary.  And for those who are still scared, or just not interested, we suggest moving directly to the next section. </p><br><p>  As usual, there is something useful on the githaba.  The same <a href="https://github.com/smartfile/django-sphinx-db">django-sphinx-db</a> , for example, helped get started with the engine directly from django models.  In Django-1.8, the private part of the implementation of database backends was greatly changed, which made <code>django-sphinx-db</code> transfer problematic.  As a result, the <a href="https://github.com/rutube/django_sphinxsearch">django-sphinxsearch</a> project appeared, which lacks a bit of attention from the side of development, but which is already used in production.  Here, by the way, is an example of the difficulties with backend support: a new version of Django is coming out, and everything is falling apart, because "my guts are changing, I want."  So you have to start from the beginning. </p><br><p>  It looks like this: </p><br><ol><li>  Looking for PEP-0249-compatible connector to the database.  MySQL-python, psycopg, python_monetdb - depends on what Django is screwed to. </li><li>  The most congenial backend is taken and inherited.  In the case of sphinxsearch, this is MySQL, also <code>django.db.backends.mysql</code> as <code>django.db.backends.mysql</code> . </li><li>  The most difficult thing is to teach <code>SQLCompiler</code> generate code that is compatible with the base under which the backend is written.  This concerns the use of quotes, the ability to specify table names without specifying the schema, the LIMIT / OFFSET syntax, and so on.  Here I want to say a separate "fe" to the developers of Django for the fact that the <code>SQLCompiler.as_sql</code> method, collecting a string from the QuerySet.query, is a monolith of almost 100 rows;  as a result, in order to change <code>LIMIT OFFSET</code> to <code>LIMIT start, end</code> has to be run regularly on the result of calling the base class method. </li><li>  QuerySet methods are added that provide search-specific functionality.  For example, <code>SphinxQuerySet.match</code> adds to self.query a self.match structure containing the data necessary to build an SphinxQL expression.  The match field is cloned, modified in the QuerySet, and finally used in <code>SphinxWhereNode.make_atom</code> to generate part of the query string.  Nothing complicated, you just need to write tests and have a good debugger on hand. </li></ol><br><h2>  Ranking search results </h2><br><p>  Search results are usually sorted by how they match the search query.  How to calculate it?  For example, you can take the number of words that are simultaneously present in the document and the query.  The more words at the intersection, the more accurately the result fits this query.  You can not just take the number of matching words, but also take into account their sequence.  And if for each word to take into account its ‚Äúrarity‚Äù, it is generally great: the presence of prepositions and conjunctions in the query and in the document will no longer affect the issue.  There <a href="http://sphinxsearch.com/docs/current.html">are a</a> lot of different, useful and not so invented such <a href="http://sphinxsearch.com/docs/current.html">characteristics</a> , so in the general case it is reasonable to use a weighted sum of the values ‚Äã‚Äãof all the characteristics that the engine considers. </p><br><p>  In addition to the characteristics that associate a specific document with a search query, you can, regardless of the query, add additional weight to documents with certain characteristics.  For example, to increase the issuance of videos loaded in good quality.  Or add weight to fresher or more watched videos. </p><br><p>  So add to the request </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> weight() + a * view_count + b * age <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> my_weight, ... <span class="hljs-keyword"><span class="hljs-keyword">OPTION</span></span> ranker=expr(<span class="hljs-string"><span class="hljs-string">'...'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> my_weight <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p>  and the sorting order of the issue is under your complete control. </p><br><p>  So uncomplicated wound: </p><br><ul><li>  general view of the ranking formula </li><li>  the weights of individual fields (title is 10 times more important than description) </li><li>  weight of individual characteristics </li><li>  additional bonuses to the results that "match" on the search query </li></ul><br><h2>  QuerySet.iterator () </h2><br><p><img src="https://habrastorage.org/files/e77/82c/d1c/e7782cd1cf134047ad3d90b3575e9ccb.jpeg" alt="(c) Soyuzmultfilm"><br>  (the editors hint that these "twists" are not enough for them) </p><br><p>  If the tuning of the search query is not enough, you can nail the results with nails.  For some queries, this is generally a critical functional, so if you want, you do not want it, but you have to implement mechanisms for manipulating search results. </p><br><ol><li>  We are looking for whether there are videos for the current query that the editors would like to see in the search results;  we get the positions that they are occupied. </li><li>  We are requesting a search, with the exception of the "nail" results. </li><li>  We change the <code>QuerySet.iterator()</code> method so that the one in the "normal" state produces results from sphinxsearch, and in some places the same "nailed" clips (for example, we have an episode from ‚ÄúReal Boys. ‚ÄùNo comments). </li><li>  If absolutely search for <em>irrelevant</em> results gives, you can, for example, instead of similar clips to issue something from the database, for example, a list of the series of the same series.  For this, it is enough that the main Video model matches the fields with the SearchVideo search result model. </li></ol><br><h2>  Technical limitations </h2><br><p>  Talk a little about the fact that you can not do in sphinxsearch.  The strangest, and at the same time, explainable "it is impossible": it is impossible to issue all issuance except for one or several documents.  Just fullscan can be done, and fullscan <code>WHERE MATCH('~document_id')</code> is impossible.  Software prohibits, they say, inefficiently. </p><br><p>  There are two limits on the limits: first, <code>SELECT *</code> without specifying LIMIT returns 20 results, approximately as <code>repr(queryset)</code> ;  the second, to find the 100,500th element, you need to add to the query <code>OPTION max_matches=100500</code> .  Inside the engine, a partial sort, the default window size of which is 1000. As a result, a request for a larger offset is an error. </p><br><p>  There are many strange restrictions on numeric operations with attributes.  For example, you can write <code>float_field &lt;&gt; 3.1415</code> in <code>SELECT</code> , but not in <code>WHERE</code> .  What can you do, especially the parser.  Struggling through <code>QuerySet.extra()</code> . </p><br><p>  The most annoying "no": you can not rely on the search does not crash in the most unpleasant moment.  We had a case when searchd restarted immediately after receiving a request containing the number "13".  This is especially unpleasant on a page where search results are not the main content.  We managed the generator, which in the case of OperationalError quietly and peacefully returns an empty response. </p><br><h2>  Under load </h2><br><p>  In a situation where there is a lot of data on the site and they change very often, you cannot just take and index the entire site every 5 minutes.  You have to be smarter.  For those who have "eaten a dog" in the search, this section will not be very interesting, since things are mostly well-known, but I will describe it briefly and to the point: </p><br><ol><li><p>  main + delta + killlist.  main - the main index, contains the entire site, updated once a day.  delta - contains only documents that have been updated since the last indexing of the main index.  killlist - a list of documents to exclude from the <em>previous</em> index. </p><br><pre> <code class="hljs kotlin">#  IP   sql_query_pre = <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-meta"><span class="hljs-meta">@ip</span></span> = substring_index(user(), <span class="hljs-string"><span class="hljs-string">'@'</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>); #  delta-  KILL-  # ,    delta- + # ,     main  sql_query_killlist = select id from ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ... and last_updated_ts &gt; <span class="hljs-meta"><span class="hljs-meta">@last_index_ts</span></span></code> </pre> <br></li><li>  global_idf.  If there are several local indexes, the global_idf = 1 parameter should be specified;  otherwise, the Inverse Document Frequency will be counted separately for each index, as a result of which ‚Äúrare‚Äù words from the ‚Äúdelta‚Äù will push up the results that should not be there. </li><li>  Multiple search engines.  We didn‚Äôt get tricky with replicating search engine index files, just each server indexes the database separately.  Out of sync data happens, and even a more stable solution was invented, but so far the hands have not reached.  Solution: RT-index, which is updated simultaneously on all search engines when a message is received about a change in a document.  Pros: instant indexing, no data rassinchron in the normal state;  cons: wildly complex code initiation of sending messages, because  The document in the search contains data about 15 database tables, the need for message handlers on each search server. </li><li>  The load on the server.  Of course, it is better not to bring up to 100% CPU Load, but if this has become the norm, then there is the <code>max_predicted_time</code> option, which limits the theoretical query execution time.  Relevance suffers, but you can cut off some of the problems.  It is possible, but not necessary, since "God sees everything."  God is the editorial board, and everything is the appearance, for example, of very strange "similar" ones on the page.  To combat temporary overloads, it makes sense to put <code>CONN_TIMEOUT</code> in the Django connection so that the search does not slow down everything else. </li><li>  Administration of lists of synonyms and exceptions.  We decompose on WebDAV and apply at the next indexation (with the rotation of indexes). </li></ol><br><h2>  About changing RT-indexes </h2><br><p>  Still, sphinxsearch is not a database.  But the possibility of changing the data in it. </p><br><ul><li>  <code>UPDATE</code> allows you to update attributes that have a fixed length.  By the way, even for "on-disk" indices. </li><li>  In other cases, <code>REPLACE</code> used, which places the old version of the document deleted, and adds a new one to the end. </li><li>  Hence the difficulty for the developers of the backend for Django: first, <code>queryset.update(field=value)</code> works only for numeric attributes, <code>REPLACE</code> should be formatted as bulk insert;  secondly, <code>REPLACE</code> is more similar in syntax to <code>INSERT</code> , and therefore it is necessary to generate it using <code>SQLInsertCompiler</code> .  In general, there is something to think about. </li></ul><br><p>  After three years of using sphinxsearch in production, the entire search team loved him and loved it with all my heart.  Perhaps this is the only project in which all the problems are so strange and entertaining :) </p><br><ul><li>  DSPH-146 Child and windowsill </li><li>  DSPH-115 Hamster broke (search results) </li><li>  DSPH-129 Agreed to remove similar clips from similar ones </li><li>  DSPH-118 Bad looking, very bad </li><li>  DSPH-131 Again similar and again it is disgusting </li></ul><br><p>  And still sphinxsearch in our Rutube is used for storing and processing logs in the Kibana cycling counterpart - by the way, it works quite quickly.  There will be time - we will tell about it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/281653/">https://habr.com/ru/post/281653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281641/index.html">I do not know how to do that! Honestly</a></li>
<li><a href="../281643/index.html">Patterns and antipatterns Cucumber BDD</a></li>
<li><a href="../281647/index.html">10 steps to create a startup based on 1C: Enterprise and Asp.Net MVC</a></li>
<li><a href="../281649/index.html">Unusual users at easla.com</a></li>
<li><a href="../281651/index.html">Introduction to Riemann: Event Monitoring and Analysis</a></li>
<li><a href="../281655/index.html">Posted by Blackhole exploit kit set for seven years</a></li>
<li><a href="../281657/index.html">Break me completely ... is it about Scrum?</a></li>
<li><a href="../281659/index.html">9 secrets of online payments. Part 4: the correct payment form - the key to successful payment</a></li>
<li><a href="../281661/index.html">VolgaCTF: summing up the first round</a></li>
<li><a href="../281663/index.html">How to fix a ‚Äúbroken‚Äù VDS server on Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>