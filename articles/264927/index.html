<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate MS SQL backup configuration using .NET application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I matured a long time to write this article and post my application. I hope you will be interested. 

 What is this article about 
 It describes the w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate MS SQL backup configuration using .NET application</h1><div class="post__text post__text-html js-mediator-article">  I matured a long time to write this article and post my application.  I hope you will be interested. <br><br><h4>  What is this article about </h4><br>  It describes the way in which, using the .NET application I developed, you can distribute a backup plan and carry out all the necessary settings over the database using DBMS tools, notifying the administrator of the completion of tasks. <br><br>  To the maximum I will try to describe the nuances that I had to face during the development of the application and database configuration. <br>  For the tasks described below, you can use the <a href="http://tavalik.ru/sozdanie-plana-obsluzhivaniya-v-microsoft-sql-server-200-r2/">master maintenance plans</a> , but I liked this approach more.  The main advantage of the method I described is that this method can be applied to all versions of MS SQL (except Express, there is a slightly different approach).  The maintenance plan <a href="http://mssqltrek.com/2011/08/27/how-to-transfercopy-maintenance-plans-from-one-server-to-other/">can be migrated</a> , but you must have the corresponding MS SQL version and a Job will still be created to launch the maintenance plan. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Compare MS SQL editions and their functionality <a href="https://www.microsoft.com/sqlserver/ru/ru/product-info/compare.aspx">here</a> . <br>  <b>Beware</b> : perfectionists may experience burning and pain when viewing the code of my application, since  it was written in haste and sharpened for a specific task. <br><br>  <b>To whom this article is suitable:</b> <br><ul><li>  Those who have MS SQL Express and can‚Äôt run tasks with Job </li><li>  Those who are planning to switch from MS SQL 2008 to a newer version in the near future and do not want to set up database mirroring, but set up <a href="https://msdn.microsoft.com/ru-ru/library/hh510230.aspx">AlwaysOn</a> on the new version right away </li><li>  Those who do not have the means to raise more backup servers and have to do with what they have. </li><li>  Who has no tight deadlines at the time of recovery of the database.  The main thing is the result </li><li>  Who is too lazy to do something </li><li>  Just curious people. </li></ul><br><br>  <b>Table of contents:</b> <br><br>  <a href="https://habr.com/ru/post/264927/">Backup Theory</a> <br><ol><li>  <a href="https://habr.com/ru/post/264927/">Transaction log</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Differential copy of the database</a> </li><li>  <a href="https://habr.com/ru/post/264927/">System databases</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Backup plan</a> </li><li>  <a href="https://habr.com/ru/post/264927/">General backup guidelines</a> </li></ol><br>  <a href="https://habr.com/ru/post/264927/">We use the application</a> <br><ol><li>  <a href="https://habr.com/ru/post/264927/">Admin Notification Setup</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Additional notifications for admin</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Troubleshooting DatabaseMail Settings</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Configuring backup using SQL Standart application</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Configuring backup using SQL Express application</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Deleting tasks from the database</a> </li><li>  <a href="https://habr.com/ru/post/264927/">Deleting database copies</a> </li></ol><br>  <a href="https://habr.com/ru/post/264927/">How to restore backups</a> <br><br><a name="habracut"></a><br>  <b>The list of articles of habr which I used</b> <br><ol><li>  <a href="http://habrahabr.ru/post/177085/">Creating and storing backup copies of databases in MS SQL.</a>  <a href="http://habrahabr.ru/post/177085/">Practical advice</a> </li><li>  <a href="http://habrahabr.ru/post/154907/">Building a recovery chain for MS SQL databases</a> </li><li>  <a href="http://habrahabr.ru/post/132902/">Setting up Database Mail in MS SQL Server 2005 and later</a> </li><li>  <a href="http://habrahabr.ru/post/131300/">SQL Server 2008: back it up wisely.</a>  <a href="http://habrahabr.ru/post/131300/">Part 1: Theory</a> </li><li>  <a href="http://habrahabr.ru/post/162497/">All that you were shy to ask about backups of Microsoft SQL Server</a> </li></ol><br>  <a href="https://github.com/kinglamer/AutobackupPlan">Sources on github</a> for MS SQL Standart and for MS SQL Express <br>  If you want to add your thoughts to the code, I accept the pull request.  Ready to listen to constructive criticism and finalize the application, if it is really necessary for someone. <br><br><a name="theory"></a><br><h4>  Backup Theory </h4><br>  All that is described in theory, you can find yourself.  Configurations that are described in this section will be automatically performed by my application when setting up a backup. <br>  MS SQL Server supports 3 backup models. <br><ol><li>  <a href="https://technet.microsoft.com/ru-ru/library/ms191164(v%3Dsql.105).aspx">Simple</a> </li><li>  <a href="https://technet.microsoft.com/ru-ru/library/ms190217(v%3Dsql.105).aspx">Full recovery</a> model </li><li>  The <a href="https://technet.microsoft.com/ru-ru/library/ms190692(v%3Dsql.105).aspx">incomplete</a> full recovery model </li></ol><br>  I chose a full recovery model for the application, since  I needed to be able to always restore the latest version of the database after any operation and I did not have single-step bulk data insertion operations.  If you're just starting out and don't know how to choose the right one, this Microsoft <a href="https://technet.microsoft.com/ru-ru/library/ms175987(v%3Dsql.105).aspx">article</a> can help you. <br>  To enable this mode, you must run the following script <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECOVERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>;</code> </pre> <br><br>  When switching the recovery model to full, we will have the following features: <br><ol><li>  The DBMS will stop automatically clearing the <a href="https://msdn.microsoft.com/ru-ru/library/ms190925.aspx">transaction log</a> .  The log will grow until a backup copy is made.  This is an important point; the DBA needs to consider the issue of a backup plan and a log cleanup plan.  UPD: thanks for the help <a href="http://habrahabr.ru/users/yggaz/" class="user_link">Yggaz</a> </li><li>  Creating a <a href="https://msdn.microsoft.com/ru-ru/library/ms175526.aspx">differential backup</a> </li><li>  Create <a href="https://msdn.microsoft.com/ru-ru/library/ms186289.aspx">full backup</a> </li></ol><br>  Below will be described some of the nuances associated with the backup transaction logs and differential copies.  I have no comments on the full copy, just do it periodically and everything will be fine with you <br><br><a name="log"></a><br><h5>  1. Transaction log </h5><br>  The transaction log is a critical component of the database, and in the event of a system failure, it may be necessary to bring the database into a consistent state. <br><br>  Advantages when restoring a database using the transaction log: <br><ol><li>  recovery of individual transactions; </li><li>  restore all pending transactions when SQL Server starts; </li><li>  roll forward of the restored database, file, filegroup or page until the crash, etc. </li></ol><br>  <b>Recommendations</b> <br><ol><li>  Move to a fast hard drive so that with a large workflow there are no delays during the recording. </li><li>  You need to make backups of the transaction log at least every hour. </li><li>  After creating a full (differential) copy of the database, all old logs can be deleted, because  they lose their relevance. </li><li>  Carefully monitor the size of the disk on which transaction logs are stored, if it runs out, it will be impossible to write new data to the database until the size of the transaction log is reduced or a new additional transaction file is added. </li><li>  The transaction log should be regularly truncated to avoid overflowing it.  <b>UPD:</b> As <a href="http://habrahabr.ru/users/kolu4iy/" class="user_link">kolu4iy</a> said <a href="http://habrahabr.ru/users/kolu4iy/" class="user_link">,</a> this truncation operation is slightly questionable in terms of performance, since  When backing up, the transaction log is cleared inside and the DBMS starts writing a new one in it.  However, you may have a situation that I described in my <a href="http://habrahabr.ru/post/264927/">commentary</a> and then this may be useful to you. </li><li>  A situation is possible when it is impossible to immediately truncate the log.  They are described in this <a href="https://msdn.microsoft.com/ru-ru/library/ms190925.aspx">article.</a> </li><li>  To obtain information about the state of the database, use the following query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,log_reuse_wait, log_reuse_wait_desc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.databases</code> </pre> <br></li><li>  If necessary, you can get information about the latest open transactions. <pre> <code class="sql hljs">DBCC OPENTRAN (  ) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TABLERESULTS</code> </pre></li></ol><br>  Sample SQL script to perform a transaction log backup and then truncate the file. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK = N<span class="hljs-string"><span class="hljs-string">'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL\MSSQL\Backup\[ ].bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NOFORMAT, NOINIT, <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> = N<span class="hljs-string"><span class="hljs-string">'   '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SKIP</span></span>, NOREWIND, NOUNLOAD, STATS = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> DBCC SHRINKFILE (N<span class="hljs-string"><span class="hljs-string">'   '</span></span> , <span class="hljs-number"><span class="hljs-number">25</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  The same operations can be done using <a href="https://msdn.microsoft.com/ru-ru/library/ms179478.aspx">SSMS</a> <br><br><a name="diff"></a><br><h5>  2.Raznostnaya copy of the database </h5><br>  Differential backups are based on the most recent previous full backup of data.  Only changes that have been made since the last full backup were saved in the differential backup. <br>  <b>Recommendations:</b> <br><ol><li>  Use differential database copies if creating a full database copy takes a long time </li><li>  Periodically make a full copy of the database to reduce the amount of differential copies created. </li><li>  After creating a complete copy of the database, all previous differential copies lose their relevance. </li></ol><br>  More details about the frequency recommendations for creating differential backups can be found <a href="https://technet.microsoft.com/ru-ru/library/ms181092(v%3Dsql.105).aspx">here</a> . <br><br>  I will give a small example from practice, why we began to use a differential copy.  Over time, our client has grown the database to such an extent that creating a full backup took 8 hours, a few more months, and perhaps by the beginning of the working day it would not have time to complete this operation.  After transferring to a differential backup, we reduced the time from 8 hours to 2-4 minutes (depending on the day of the week).  Once a week we made a complete copy of the database. <br><br>  Sample SQL to create a backup differential database with a copy checked upon completion (different from a full copy with the <i>DIFFERENTIAL</i> flag, <i>use NOFORMAT</i> instead). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @pathBackup <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">55</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @pathBackup = N<span class="hljs-string"><span class="hljs-string">'C:\Backup\[  ]_'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>(), <span class="hljs-number"><span class="hljs-number">104</span></span>),<span class="hljs-string"><span class="hljs-string">'.'</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>) + <span class="hljs-string"><span class="hljs-string">'.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK = @pathBackup <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> DIFFERENTIAL, NOFORMAT, INIT, <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> = N<span class="hljs-string"><span class="hljs-string">'    '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SKIP</span></span>, NOREWIND, NOUNLOAD, STATS = <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @backupSetId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @pathBackup <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">55</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @pathBackup = N<span class="hljs-string"><span class="hljs-string">'C:\Backup\[  ]_'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>(), <span class="hljs-number"><span class="hljs-number">104</span></span>),<span class="hljs-string"><span class="hljs-string">'.'</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>) + <span class="hljs-string"><span class="hljs-string">'.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @backupSetId = <span class="hljs-keyword"><span class="hljs-keyword">position</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb..backupset <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> database_name=N<span class="hljs-string"><span class="hljs-string">'[  ]'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> backup_set_id=(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(backup_set_id) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb..backupset <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> database_name=N<span class="hljs-string"><span class="hljs-string">'[  ]'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @backupSetId <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> raiserror(N<span class="hljs-string"><span class="hljs-string">' .        "[  ]"  .'</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> VERIFYONLY <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK = @pathBackup <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span> = @backupSetId, NOUNLOAD, NOREWIND <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br><br><a name="systemdb"></a><br><h5>  3.System databases </h5><br>  In addition to the main database and its associated files, I strongly recommend making copies and system databases.  Let's start with the fact that we consider which databases exist in MS SQL.  There are only 5 of them: <br><br><table border="1"><tbody><tr><td>  <strong>Title</strong> <br></td><td>  <strong>Description</strong> <br></td></tr><tr><td>  Master database <br></td><td>  This database stores all system-level data for an instance of SQL Server. <br></td></tr><tr><td>  Msdb database <br></td><td>  Used by SQL Server Agent to schedule alerts and tasks. <br></td></tr><tr><td>  Model database <br></td><td>  Used as a template for all databases created in an instance of SQL Server.  Changing the size, collation, recovery model and other parameters of the model database leads to a change in the corresponding parameters of all databases created after the change. <br></td></tr><tr><td>  Resource database <br></td><td>  Database read only.  Contains system objects that are included with SQL Server.  System objects are physically stored in the Resource database, but are logically displayed in the sys schema of any database. <br></td></tr><tr><td>  Tempdb database <br></td><td>  Workspace for temporary objects or interaction of result sets. <br></td></tr></tbody></table><br>  You can read more about them <a href="https://msdn.microsoft.com/ru-ru/library/ms178028.aspx">here</a> and <a href="http://tavalik.ru/sistemnye-bd-ms-sql-server-2012-2008/">here</a> . <br><br>  I chose to reserve only 2 system databases: <br><ol><li>  msdb - because, there are stored customized tasks and other </li><li>  master - all SQL Server settings are stored. </li></ol><br>  This information is still not very critical and can be restored by hand, but why waste time when you can simply take it from a backup. <br><br><a name="plan"></a><br><h5>  4. Backup plan </h5><br>  Based on the above, we will create our backup data backup plan.  It may differ from what you need, it all depends on the requirements for restoring the database.  When I was preparing a plan, I had to consider that it was necessary to restore the data as much as possible and the loss of data was no more than one hour. <br><br>  We will make the following backups: <br><ul><li>  A full copy of the main database, more than once a week is not necessary </li><li>  Difference copy of the main database every day </li><li>  Copies of the transaction log of the main database, every hour </li><li>  A copy of the master database system, once a week </li><li>  A copy of the system database msdb, once a week </li></ul><br>  As a result, we have the following backup data plan: <br><br><table border="1"><tbody><tr><td>  <strong>Day of the week</strong> <br></td><td>  <strong>Time</strong> <br></td><td>  <strong>Actions</strong> <br></td><td>  <strong>Frequency</strong> <br></td><td>  <strong>Description</strong> <br></td></tr><tr><td>  Monday Friday <br></td><td>  From 8-00 to 21-00 <br></td><td rowspan="2">  Backups <br><br>  Transaction Log <br></td><td rowspan="2">  Every hour <br></td><td rowspan="2">  After performing a backup copy of the database, the transaction log is compressed and truncated <br></td></tr><tr><td>  Saturday Sunday <br></td><td>  From 8-00 to 18-00 <br></td></tr><tr><td>  Monday Sunday <br></td><td>  22-00 <br></td><td>  Differential copy of the main database <br></td><td>  1 per day <br></td><td>  After successful execution of a differential copy, all old copies of the transaction log are deleted. <br></td></tr><tr><td>  Saturday <br></td><td>  12-00 <br></td><td>  DB check <br></td><td>  1 per day <br></td><td>  DB check Case for integrity. <br></td></tr><tr><td>  Saturday <br></td><td>  18-00 <br></td><td>  Creating a complete copy of the database <br></td><td>  1 per day <br></td><td>  Upon completion of this operation is notified by mail. <br><br><br><br>  If the backup is successful, it is deleted. <br><br><ul><li>  old full backup </li><li>  all old differential copies </li><li>  all old transaction logs </li></ul><br></td></tr><tr><td>  Monday Sunday <br></td><td>  23-30 <br></td><td>  Create a copy of the system master database <br></td><td>  1 per day <br></td><td>  Only the latest copy of the database is always stored. <br></td></tr><tr><td>  Sunday <br></td><td>  12-30 <br></td><td>  Create a copy of the msdb system database <br></td><td>  1 time per month <br></td><td>  Only the latest copy of the database is always stored. <br></td></tr></tbody></table><br><br><a name="recomend"></a><br><h5>  5. General backup guidelines </h5><br><ol><li>  Use the option <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span></code> </pre> <br>  to make sure everything went well.  The disadvantage of this solution is that for large databases, checksum verification can seriously load the system. </li><li>  Do not back up files to the same physical disk on which the database or transaction protocol is stored. </li><li>  If you use MS SQL 2008 or higher, I recommend that you use backup compression using SQL tools.  The following code will enable default compression: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>; GO EXEC sp_configure '<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> compression <span class="hljs-keyword"><span class="hljs-keyword">default</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'; RECONFIGURE WITH OVERRIDE;</span></span></code> </pre> </li><li>  keep backups for several days in case one of them gets corrupted - an old backup is better than none. </li><li>  Use <i>DBCC CHECKDB</i> to check each database before copying, this will prompt you in the time of impending problems. <pre> <code class="sql hljs">DBCC CHECKDB ('  ') <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NO_INFOMSGS, ALL_ERRORMSGS;</code> </pre>  <b>Note:</b> for practice, we used this check only before performing a full backup. </li><li>  Periodically update statistics and reorganize database indexes </li></ol><br><br><a name="useapp"></a><br><h4>  We use the application </h4><br>  Several nuances on the application: <br><ul><li>  All texts and requests in the code are placed in the resources, it was easier for me </li><li>  When entering connection parameters and other settings, they are saved to a file.  For Express and Standart, different files (dbStandart, udExpress) are used. They contain the class UserData </li><li>  Some operations may require administrator privileges. </li><li>  At the moment, the connection to the database under the domain account does not work </li><li>  The program does not have a super-beautiful interface. </li></ul><br><br><a name="notify"></a><br><h5>  1. Setting up administrator notification </h5><br>  I was too lazy to go to the server every time and check if the task worked or if some kind of error occurred.  Yes, and I wanted to be able to receive other notifications, not only about the completion of tasks. <br><br>  For this purpose, <a href="https://technet.microsoft.com/ru-ru/library/ms175887(v%3Dsql.105).aspx">DatabaseMail</a> MS SQL is used (for the Standard version and higher) <br>  In my application, I made a special section to automate this task. <br><br><img src="https://habrastorage.org/files/5e1/704/4f0/5e17044f010641219a648d44335600c3.png"><br><br>  When clicked, a form will appear to fill in the information necessary to create a mailing list: <br><br><img src="https://habrastorage.org/files/4f0/ca7/dfb/4f0ca7dfb80348dba60c70065aaa3582.png"><br><br>  The application is automatically configured to the standard 25 SMTP port for the address from which the letters are sent.  If necessary, it can be changed in the <a href="https://msdn.microsoft.com/en-us/library/ms182804.aspx">sysmail_add_account_sp</a> procedure <br>  User and password are required in case the mail service has authentication configured. <br><br>  The name of the operator in the system is indicated in order for us to properly create a DatabaseMail profile.  Write any name that will be clear to you.  Below is an example of a completed form. <br><br><img src="https://habrastorage.org/files/14e/414/22f/14e41422f2404b4bb3ba56ee3f20de6d.png"><br><br>  Further, from this mailbox from the specified operator, we will receive notifications about the successful execution of operations. <br>  Actions performed at this stage: <br><ol><li>  Change the system parameters MS SQL. </li><li>  DatabaseMail <a href="https://technet.microsoft.com/en-us/library/ms189879(v%3Dsql.105).aspx">Profile is created</a> </li><li>  Activated in SQL Agente profile </li><li>  DatabaseMail <a href="https://technet.microsoft.com/en-us/library/ms188668(v%3Dsql.105).aspx">Account is created</a> </li><li>  DatabaseMail Account is added to Database Mail Profile </li><li>  DatabaseMail Operator is created </li></ol><br>  Described in more detail in the next <a href="http://habrahabr.ru/post/179819/">article</a> and, in part, I took <a href="http://sqlblog.com/blogs/jonathan_kehayias/archive/2010/01/25/setting-up-database-mail-to-use-gmail-account-for-presentations.aspx">from here</a> .  Naturally, these actions can be performed using <a href="http://blogs.msdn.com/b/suhde/archive/2009/07/12/how-to-configure-sql-server-database-mail-to-send-email-using-your-windows-live-mail-account-or-your-gmail-account.aspx">SSMS</a> . <br><br><a name="notify2"></a><br><h5>  2. Additional notifications for admin </h5><br>  The program has 2 tasks applied to the database: <br><ol><li>  check the integrity of the database.  The standard <a href="https://msdn.microsoft.com/ru-ru/library/ms176064.aspx">DBCC CHECKDB</a> procedure was used to check the database. </li><li>  informing about free space in file groups. </li><li>  The second task was implemented using a query to the <a href="https://msdn.microsoft.com/en-us/library/ms178009.aspx">dbo.sysfiles</a> system table <a href="https://msdn.microsoft.com/en-us/library/ms178009.aspx">.</a> </li><li>  Here is an example of this request, which was executed to the database: </li></ol><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>(a.NAME,<span class="hljs-number"><span class="hljs-number">15</span></span>), a.FILEID, [FILE_SIZE_MB] = <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(a.size/<span class="hljs-number"><span class="hljs-number">128.000</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)), [SPACE_USED_MB] = <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(fileproperty(a.name,<span class="hljs-string"><span class="hljs-string">'SpaceUsed'</span></span>)/<span class="hljs-number"><span class="hljs-number">128.000</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)), [FREE_SPACE_MB] = <span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">round</span></span>((a.size-fileproperty(a.name,<span class="hljs-string"><span class="hljs-string">'SpaceUsed'</span></span>))/<span class="hljs-number"><span class="hljs-number">128.000</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)) , FILENAME = a.FILENAME <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> dbo.sysfiles a</code> </pre><br>  The answer from the server comes to the administrator's mail in the form of html markup.  This syntax is possible due to the following standard MS SQL <a href="https://msdn.microsoft.com/ru-ru/library/ms190922.aspx">FOR XML</a> function. <br><br>  Just as I was looking for how to convert the result of query execution into html text into a returned one, I came across the next <a href="https://www.virtualobjectives.com.au/sqlserver/saving_to_html.htm">page</a> where a person created a whole procedure for this purpose. <br>  These operations can be configured using the corresponding item in the program menu: <br><br><img src="https://habrastorage.org/files/3d4/9fc/868/3d49fc8689b24720a0dc115903fa2d3b.png"><br><br>  A window appears to specify the mailbox to which you want to send html report text: <br><br><img src="https://habrastorage.org/files/ed2/6e6/0a7/ed26e60a76264a8183c03588576c5a9b.png"><br><br><a name="mailfix"></a><br><h5>  3. Solving problems when setting up DatabaseMail </h5><br>  In MS SQL 2008, I encountered a problem when setting up a SQL Server Agent.  Symptoms are the following; after tuning, it is impossible to start the SQL Agent.  Basically, this is solved by installing the update on the SQL server. <br><br>  Make sure that <a href="http://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D26727">sp1 is</a> installed, and then you can already install the <a href="http://support.microsoft.com/kb/2926028">update</a> . <br><br>  If these updates do not help, you need to download fix.  It can be found on this <a href="http://support.microsoft.com/select/default.aspx%3Ftarget%3Dassistance">site</a> I can‚Äôt specify the final link now, in order to get to the fix package, I‚Äôll need to answer a number of questions. <br>  If there are problems with the DatabaseMail module.  After configuring this module using the application, you need to go to the SQL Agent and view the event log.  If there are errors "it is impossible to connect to the mailbox".  So there is a problem, even if an email is sent through the check. <br><br>  <b>This is corrected by the following manipulations:</b> <br><ol><li>  Management Studio - SQL Server Agent - Properties. </li><li>  Alert system </li><li>  Uncheck the box with Enable mail profile </li><li>  Click OK </li><li>  Log in again and check the box. </li><li>  Reboot the SQL Server Agent. </li></ol><br>  Check account for SQL Agent service.  If this is a domain account, change it to the system account or vice versa.  Everything has to earn. <br><br><a name="standart"></a><br><h5>  4. We configure backup using the SQL Standart application: </h5><br>  Select the version of Standart.  Customize notifications.  (see section, notification settings): <br><br><img src="https://habrastorage.org/files/a13/996/f9f/a13996f9fecf4202a888745dae041894.png"><br><br>  We connect to the database by filling in the data for the connection and specify the database for which the Job will be applied: <br><br><img src="https://habrastorage.org/files/b5f/1e0/e88/b5f1e0e8851f4355827af25c69541dca.png"><br><br>  Choose a backup setting: <br><br><img src="https://habrastorage.org/files/414/75c/ef1/41475cef121d46408b29e406648a63df.png"><br><br>  Specify the path to save copies of the database.  If the specified folders do not exist, the program will try to create them (we need the appropriate rights). <br><br><img src="https://habrastorage.org/files/9be/d79/da4/9bed79da463644f8a513d07196fefc15.png"><br><br>  We click to save and the corresponding tasks are configured.  It is advisable to configure different folders for each backup, because  deleting will delete all files with bak extension.  (see <i>section deleting database copies</i> ) <br><br><img src="https://habrastorage.org/files/3bf/fa1/374/3bffa1374ea249958353f8f66ec50e6e.png"><br><br><a name="express"></a><br><h5>  5. We configure backup using the application for SQL Express: </h5><br>  Since SQL Express is missing the SQL Agent, the task of automating backup had to be solved in another way.  In the folder specified by the user, a bat file is created in which the SQL query is described, which is responsible for creating a backup.  If necessary, you can edit it directly.  In addition to this, the standard Windows scheduler should work, it creates a task that will run once a day at a specified time. <br><br>  To do this, run the application.  Choose MS SQL Express: <br><br><img src="https://habrastorage.org/files/692/0f2/f27/6920f2f27a2b460d919fb6915a0d9492.png"><br><br>  A form for filling the parameters appears: <br><br><img src="https://habrastorage.org/files/0ea/15d/cff/0ea15dcff6194f03840f88cd958f2067.png"><br><br>  Specify where our copy will be saved, and also where the bat file will be located to create a copy of the database (you do not need to specify the file name, it will be set automatically).  Next, specify the connection settings and the time when you need to run the task. <br><br>  The only disadvantage of this approach is that you have to store the password for connecting to the database in clear text. <br><br><a name="deletejob"></a><br><h5>  6. Removal of tasks from the database. </h5><br>  If you need to delete all tasks from the database (for example, you wanted to change the paths to save the database).  To do this, use the appropriate item in the program menu.  All tasks with a certain initial prefix (in my case King) will be deleted from the SQL Agent: <br><br><img src="https://habrastorage.org/files/c70/a52/751/c70a52751d604578add2c6837890e878.png"><br><br><a name="deletedb"></a><br><h5>  7. Deleting database copies </h5><br>  In some tasks, the deletion of old copies of the database is configured.  For this, I use the procedure master.dbo.xp_delete_file.  Example of use: Removes all files with the bak extension from the specified folder, the creation date of which exceeds 14 days. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> master.dbo.xp_delete_file <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"E:\backups"</span></span>,N<span class="hljs-string"><span class="hljs-string">'bak'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(d,<span class="hljs-number"><span class="hljs-number">-14</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()),<span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  And here is another more detailed <a href="http://www.patrickkeisler.com/2012/11/how-to-use-xpdeletefile-to-purge-old.html">example</a> and information about what parameters this <a href="http://stackoverflow.com/questions/24582996/sql-server-xp-delete-file-parameters">function</a> takes. <br><br><a name="restore"></a><br><h4>  How to restore backups </h4><br>  Due to lack of time, the recovery module has not yet been implemented, maybe in the future I will add it, but for now just briefly describe how you can restore the database. <br><br>  Using SQL script.  To restore the database, use the <a href="https://msdn.microsoft.com/ru-ru/library/ms186858.aspx">RESTORE</a> command. <br><br>  If you just need to restore the database from a full copy, then just run the following script: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK = <span class="hljs-string"><span class="hljs-string">'Z:\SQLServerBackups\back.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span></code> </pre><br>  If it is necessary to restore sequentially, first a full copy, differential copies and transaction logs, then you need to write the following SQL script. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> TEST_DB ‚Äì   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_db_full <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY; GO <span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> TEST_DB ‚Äì   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_db_diff <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, NORECOVERY; GO <span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> TEST_DB ‚Äì   ‚Ññ<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_db_tran_1 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY; GO <span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOG</span></span> TEST_DB ‚Äì   ‚Ññ<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test_db_tran_2 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> NORECOVERY; GO <span class="hljs-keyword"><span class="hljs-keyword">RESTORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> TEST_DB <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECOVERY</span></span>; GO</code> </pre><br>  You can also use <a href="https://support.managed.com/kb/a1788/how-to-manually-restore-an-mssql-database-management-studio.aspx">SSMS</a> to restore the database. </div><p>Source: <a href="https://habr.com/ru/post/264927/">https://habr.com/ru/post/264927/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264913/index.html">Where in the ZX Spectrum System Monitor? Mystery PC Duet</a></li>
<li><a href="../264915/index.html">Feature selection methods</a></li>
<li><a href="../264919/index.html">Java bytecode "Hello world"</a></li>
<li><a href="../264921/index.html">What problems do we face when introducing and operating Microsoft Exchange and how to solve them effectively?</a></li>
<li><a href="../264923/index.html">Joint editing. Part 1</a></li>
<li><a href="../264929/index.html">What can SED outside the office: the automation of the treasury</a></li>
<li><a href="../264931/index.html">Low Cost 10GbE Cluster Infrastructure</a></li>
<li><a href="../264933/index.html">UX-strategy in practice. Part 3 - Platform Thinking</a></li>
<li><a href="../264935/index.html">Last 2 days of sales of Early Bird MBLTdev conference tickets</a></li>
<li><a href="../264937/index.html">Improving communication between the client and the UX: how to avoid a damaged phone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>