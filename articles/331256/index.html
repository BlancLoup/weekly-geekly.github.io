<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of the unexpected "scorching" and restore one smartphone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began with the fact that as a result of unsuccessful experiments with the Samsung Galaxy Ace 2 smartphone core (aka GT-I8160, aka codina), ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of the unexpected "scorching" and restore one smartphone</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/ce0/224/c53/ce0224c53c674700a6b946a234aecd8a.png"><br><br>  This story began with the fact that as a result of unsuccessful experiments with the Samsung Galaxy Ace 2 smartphone core (aka GT-I8160, aka codina), leading to the device reboots, it turned out that the EFS section was no longer readable.  Actually, the experiments themselves have nothing to do with this issue - perhaps, somehow, I will come to them, but this is beyond the scope of this article.  Although the EFS section is one of the most important on this smartphone, killing this section does not in itself lead to catastrophic consequences, since it can still be restored, for example, from another phone, after which, if desired, change the WIFI MAC and BT MAC.  On this device, IMEI is not stored on the EFS partition, but CSPSA (Crash Safe Parameter Storage Area, literally translated as ‚ÄúCrash Resistant Parameter Storage Area‚Äù).  Now, if something goes wrong with this section, it will not be so fun anymore, this will be discussed further.  Who are interested, please under the cat. <br><a name="habracut"></a><br>  After the failure of the EFS partition, I, first of all, took its dump and tried to raise it with the help of e2fsck.  Failure - the EXT4 superblock is damaged, and indeed everything looked as if the contents of the section had turned into stuffing.  It was time to look for a backup, but, what a carelessness (!), At the most inopportune moment it was not found either on the computer or on the flash drive.  All further sufferings could have been avoided only if I had timely backups.  It was late in the evening, having begun to look for dumps of this section on the Internet and having found one on a foreign resource, I immediately began to flash it.  Probably one of the worst things that can happen when using the <code>dd</code> utility is a typo or an error when typing the path to the partition.  Now I can only wonder at my own carelessness (or curvature, call it what you want), but this is exactly what happened ... The EFS partition on this device is / dev / block / mmcblk0p7, but for some reason I didn‚Äôt have any doubt at that moment that it supposedly should be / dev / block / mmcblk0p6.  Actually, the further does not require special explanations, I already understood about the catastrophicity of what happened only when dd brought out a message stating that the end of the section had been reached during the recording.  It seems that not the first year I have been using the device and am one of the few remaining developers for this god-forgotten device.  How could I find myself in such a way I didn‚Äôt look at the stupid situation?  Do not ask me, I would like to know myself ... So the phone with a light hand became, if not a ‚Äúbrick‚Äù, then an ‚Äúinvalid‚Äù for sure. <br><br><h1>  CSPSA Section Study </h1><br>  So, the EFS partition was killed by the crash during the active recording on the disk, while the CSPSA partition, which is resistant to crashes, did not stand up to my rashness.  If I went to the SC, even there they probably would have shrugged.  CSPSA firmware from another device will also not fix the case, because  IMEI, obviously, is stored somewhere besides this section and is compared with what is in CSPSA.  Yes, and the article is not about changing IMEI, but about its restoration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The situation is hopeless, no matter how you look, I thought.  I found myself embroiled in something I clearly did not plan to do, pick up the insides of the CSPSA section.  It turned out that among <a href="http://www.xperiablog.net/2014/01/27/st-ericsson-novathor-u8500-chipset-source-code-leaks-gives-hope-to-xperia-go-p-sola-and-u-owners/">the sources for the ST-Ericsson Novathor U8500 chipset in 2014</a> there are source codes for <a href="https://github.com/XMelancholy/android_vendor/tree/master/st-ericsson/storage/parameter_storage/cspsa">utilities</a> that allow working with this section: <br><br><pre> <code class="bash hljs">root@:/ <span class="hljs-comment"><span class="hljs-comment"># cd ramdisk root@:/ramdisk # ./cspsa-cmd [CSPSA]: open CSPSA0 [CSPSA]: &lt;CSPSA_Open('CSPSA0').&gt; [CSPSA]: &lt;Result 'T_CSPSA_RESULT_OK'&gt; [CSPSA]: ls Key Size 0 4 1 96 2 96 3 96 1000 38 66048 497 -8192 41 -4 4 -3 4 -2 4 -1 4 Number of keys in CSPSA : 11 Total size of all values: 884 [CSPSA]: read_to_file 3e8 /sdcard/1000.bin [CSPSA]: &lt;Read (000003e8) to file '/sdcard/1000.bin'&gt; [CSPSA]: CSPSA_GetSizeOfValue(000003e8): T_CSPSA_RESULT_OK [CSPSA]: &lt;CSPSA_Read(000003e8).&gt; [CSPSA]: &lt;CSPSA_ReadValue(000003e8, 38): T_CSPSA_RESULT_OK&gt; [CSPSA]: &lt;38 bytes written to file '/sdcard/1000.bin'.&gt; [CSPSA]: write_from_file 3e8 /sdcard/1000.bin [CSPSA]: &lt;Write (000003e8) from file '/sdcard/1000.bin'&gt; [CSPSA]: &lt;38 bytes read from file '/sdcard/1000.bin'.&gt; [CSPSA]: &lt;CSPSA_WriteValue(000003e8, 38).&gt; [CSPSA]: &lt;CSPSA_WriteValue(000003e8, 38): T_CSPSA_RESULT_OK&gt;</span></span></code> </pre><br>  The ‚Äúopen CSPSA0‚Äù command opens the CSPSA0 socket, thus connecting to the cspsa-server process.  As you can see, the ls command displays the parameters stored in CSPSA and their size. <br><br>  Further, using the read_to_file command, you can write a parameter (here it is 1000, specified in HEX, - 3e8) to a file, and also write a parameter from a file to a section with the command write_from_file. <br><br>  It is of course great that I managed to find such a utility, but did not give me any clues as to what was supposed to be in these parameters in order for IMEI to read normally again.  In fact, the utility could "hide" part of the truth, giving out not all the parameters, and hiding the one in which the IMEI is stored.  In order to understand what could be in these parameters, it was necessary to have several such different sections of the CSPSA, but in fact, I can‚Äôt ask someone to merge the section with such private information.  On the Internet, there were two different sections of CSPSA, but a comparison of parameters read through cspsa-cmd produced too much difference, about 512-768 bytes in total when comparing them with each other.  Even with all the sources, it could have been a while before I figured it out (if I figured it out at all).  The idea of ‚Äã‚Äãrebuilding CSPSA "in the forehead" had to be abandoned, looking at other parts of the merged source that could help restore the phone. <br><br>  I stumbled upon another <a href="">utility</a> that looked promising. <br><br>  The link is a list of commands supported by this utility. <br><br><pre> <code class="hljs cpp">(...) <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str; <span class="hljs-keyword"><span class="hljs-keyword">cops_return_code_t</span></span> (*func)(<span class="hljs-keyword"><span class="hljs-keyword">cops_context_id_t</span></span> *ctx, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *argc, <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **argv[]); } api_funcs[] = { {<span class="hljs-string"><span class="hljs-string">"read_imei"</span></span>, cmd_read_imei}, {<span class="hljs-string"><span class="hljs-string">"bind_properties"</span></span>, cmd_bind_properties}, {<span class="hljs-string"><span class="hljs-string">"read_data"</span></span>, cmd_read_data}, {<span class="hljs-string"><span class="hljs-string">"get_nbr_of_otp_rows"</span></span>, cmd_get_nbr_of_otp_rows}, {<span class="hljs-string"><span class="hljs-string">"read_otp"</span></span>, cmd_read_otp}, {<span class="hljs-string"><span class="hljs-string">"write_otp"</span></span>, cmd_write_otp}, {<span class="hljs-string"><span class="hljs-string">"authenticate"</span></span>, cmd_authenticate}, {<span class="hljs-string"><span class="hljs-string">"deauthenticate"</span></span>, cmd_deauthenticate}, {<span class="hljs-string"><span class="hljs-string">"get_challenge"</span></span>, cmd_get_challenge}, {<span class="hljs-string"><span class="hljs-string">"modem_sipc_mx"</span></span>, cmd_modem_sipc_mx}, {<span class="hljs-string"><span class="hljs-string">"unlock"</span></span>, cmd_simlock_unlock}, {<span class="hljs-string"><span class="hljs-string">"lock"</span></span>, cmd_simlock_lock}, {<span class="hljs-string"><span class="hljs-string">"ota_ul"</span></span>, cmd_ota_simlock_unlock}, {<span class="hljs-string"><span class="hljs-string">"get_status"</span></span>, cmd_simlock_get_status}, {<span class="hljs-string"><span class="hljs-string">"key_ver"</span></span>, cmd_verify_simlock_control_keys}, {<span class="hljs-string"><span class="hljs-string">"get_device_state"</span></span>, cmd_get_device_state}, {<span class="hljs-string"><span class="hljs-string">"verify_imsi"</span></span>, cmd_verify_imsi}, {<span class="hljs-string"><span class="hljs-string">"bind_data"</span></span>, cmd_bind_data}, {<span class="hljs-string"><span class="hljs-string">"verify_data_binding"</span></span>, cmd_verify_data_binding}, {<span class="hljs-string"><span class="hljs-string">"verify_signed_header"</span></span>, cmd_verify_signed_header}, {<span class="hljs-string"><span class="hljs-string">"calcdigest"</span></span>, cmd_calcdigest}, {<span class="hljs-string"><span class="hljs-string">"lock_bootpartition"</span></span>, cmd_lock_bootpartition}, {<span class="hljs-string"><span class="hljs-string">"init_arb_table"</span></span>, cmd_init_arb_table}, {<span class="hljs-string"><span class="hljs-string">"write_secprofile"</span></span>, cmd_write_secprofile}, {<span class="hljs-string"><span class="hljs-string">"change_simkey"</span></span>, cmd_change_simkey}, {<span class="hljs-string"><span class="hljs-string">"write_rpmb_key"</span></span>, cmd_write_rpmb_key}, {<span class="hljs-string"><span class="hljs-string">"get_product_debug_settings"</span></span>, cmd_get_product_debug_settings} }; (...)</code> </pre><br>  As in the previous case, with cspsa-cmd, cops_cmd is connected to the server process, copsdaemon (COPS stands for COre Platform Security). <br><br>  This very copsdaemon binary on the device turned out to be different from the fact that in the source code (or I didn‚Äôt manage to configure Android.mk correctly), anyway, collected from the source code refused to work.  However, it seems that the cops_cmd utility was compatible with the rest of the proprietary software and ran normally. <br><br>  The first thing I tried to do was to run the <code>cops_cmd read_imei</code> ‚Äî I don‚Äôt remember exactly now, it <code>cops_cmd read_imei</code> something like ‚Äúerror 13, device is tampered‚Äù.  Yeah, of course, what else could you expect, with a bogus section of the CSPSA.  A short reading of the source led to the ‚Äúbind_properties‚Äù command: <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> cops_return_code_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmd_bind_properties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">cops_context_id_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">cops_return_code_t</span></span> ret_code; <span class="hljs-keyword"><span class="hljs-keyword">cops_imei_t</span></span> imei; (...) usage: (...) <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">"Usage: bind_properties imei &lt;imei&gt; (15 digits)\n"</span></span> <span class="hljs-string"><span class="hljs-string">"Usage: bind_properties keys &lt;k1 k2 k3 k4 k5&gt; (keys are space delimited)\n"</span></span> <span class="hljs-string"><span class="hljs-string">"Usage: bind_properties auth_data &lt;auth_number&gt; &lt;auth data file name&gt;\n"</span></span> <span class="hljs-string"><span class="hljs-string">"Usage: bind_properties data &lt;data file name&gt; &lt;optional don't merge flag 0, otherwise merge will occur&gt;\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> COPS_RC_ARGUMENT_ERROR; }</code> </pre><br>  As you can see from the sources, the function is intended to write IMEI to the device.  But here's the ill luck, just before the recording, it is necessary to perform authentication using the private key, which I obviously do not have.  It remained only to continue to pick copsdaemon, in order to try to avoid the need for authentication, fortunately, everything went without it. <br><br><h1>  Looking for ideas </h1><br>  It took several days in search and reflection.  After talking with one of my acquaintances with xda-developers, I learned that for the GT-I8160 variant with the NFC chip, the GT-I8160P, there is a firmware with some default, ‚Äúsemi-empty‚Äù section of the CSPSA, and that firmware of this ROM on this device the fact that IMEI is ‚Äúreset‚Äù, that is, all 15 digits of IMEI become zeros (I don‚Äôt remember exactly if this happens in the case of a CSPSA partition or whether or not it is).  First of all I downloaded this firmware and flashed the CSPSA section - to no avail.  A colleague offered partial firmware (i.e., firmware of separate partitions, not including such ‚Äúdangerous‚Äù ones as bootloader and others) of this ROM.  A rather unpromising activity, it could finally ‚Äúwry‚Äù the device.  Finally, after a couple more days, while I was busy with the source code above, a colleague with the XDA made a truly incredible and priceless find: <br><br><pre> <code class="hljs mel">#TA Loader to write <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> IMEI service ta_load /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/bin/ta_loader recovery user root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> radio oneshot</code> </pre><br>  This is a clipping of the contents of the ramdisk init.samsungcodina.rc file from the stock firmware Android 4.1.2, where it is directly stated in the comments that this is a service for restoring IMEI to default. <br>  Without thinking, I launched from the terminal: <br><br><pre> <code class="bash hljs">/system/bin/ta_loader recovery</code> </pre><br>  The device rebooted into recovery mode, then another manual reboot into the system, and voila!  IMEI is not already displayed as ‚Äúnull‚Äù, but set to zero, online registration is available, progress, however.  The mystery of the "zeroed" IMEI has been revealed. <br><br>  But, of course, it‚Äôs not at all cool to walk here with such a default IMEI.  It was enough just a short search to look at the ta_loader binary in the HEX editor (there were no more sources for this tool) and replace the zero IMEI with your command of the type: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s,&lt;15_zeroes&gt;,&lt;IMEI&gt;,"</span></span> /ramdisk/ta_loader sed -i <span class="hljs-string"><span class="hljs-string">"s,&lt;IMEI&gt;0,&lt;16_zeroes&gt;,"</span></span> /ramdisk/ta_loader</code> </pre><br>  Why is the sed command called twice?  In the binary there is a sequence of more than 15 zeros, not related to IMEI, therefore, to return an undesired change, you must call the command a second time.  I hasten to assure you, trying to write down the ‚Äúleft‚Äù IMEI in this way is useless, the utility works in such a way that you can only write IMEI from the box (or default).  Another reboot in the recovery, then to the system, and, lo and behold - IMEI is in place!  I described the recovery process in more detail on the <a href="https://forum.xda-developers.com/galaxy-ace/ace-2-develop/guide-how-to-recover-imei-backups-t3448335">XDA Developers forum</a> .  Such are the cases, lucky that the manufacturer left a loophole to restore the original IMEI.  If there were no misadventures above, it would probably have occurred to me not to poke around in all this, but on the other hand, there would not be the whole story. </div><p>Source: <a href="https://habr.com/ru/post/331256/">https://habr.com/ru/post/331256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331236/index.html">Overview of animation with codepen for site download pages</a></li>
<li><a href="../331240/index.html">Automating file systems with systemd</a></li>
<li><a href="../331248/index.html">Translation of the Appium Essentials book. Chapter 2</a></li>
<li><a href="../331250/index.html">Malta as a new direction for IT professionals</a></li>
<li><a href="../331254/index.html">A brief description of BPMN with an example</a></li>
<li><a href="../331258/index.html">Atmosphere at InfoWatch</a></li>
<li><a href="../331260/index.html">CocoaHeads Russia in Tutu.ru office</a></li>
<li><a href="../331262/index.html">How can PVS-Studio help in finding vulnerabilities?</a></li>
<li><a href="../331264/index.html">Analytical tools: a review of lucrative offers</a></li>
<li><a href="../331266/index.html">Hosting provider paid a million dollars to ransomware hackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>