<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Zones on Solaris 11.3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 My first acquaintance with container virtualization was with jail on FreeBSD, this approach allows you to isolate various services in a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Zones on Solaris 11.3</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  My first acquaintance with container virtualization was with <a href="https://ru.wikipedia.org/wiki/FreeBSD_Jail">jail</a> on FreeBSD, this approach allows you to isolate various services in a secure environment.  The disadvantage of jail is that it is not possible to create its own network subsystem, in contrast to <a href="https://ru.wikipedia.org/wiki/Solaris_Containers">Zones</a> Solaris.  This publication will consider the creation of a zone with its own network subsystem, as well as without it. <br><a name="habracut"></a><br><h2>  Firewall </h2><br>  As a ‚Äúfirewall‚Äù, the packet filter from OpenBSD will be used.  Using packet filter, nat will be implemented from the zone with its own network subsystem, as well as restrictions of the global zone network.  To install the packet filter and run, run the following commands: <br><br><pre><code class="hljs sql">pkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> firewall svcadm <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> firewall</code> </pre> <br>  Next, open the file with the future rules: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nano</span></span> /etc/firewall/pf.conf</code> </pre><br>  Add the following lines to the nano editor: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">table</span></span> &lt;good&gt; {<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span>,<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> &lt;nat&gt; {<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>} pass quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> lo0 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> state pass quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic0 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> &lt;nat&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> nat-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> (net0) pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span> port <span class="hljs-number"><span class="hljs-number">80</span></span> rdr-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> &lt;good&gt; port=<span class="hljs-number"><span class="hljs-number">22</span></span> flags S/SA modulate state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> &lt;good&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> port {<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">53</span></span>} flags S/SA modulate state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto udp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> &lt;good&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> port=<span class="hljs-number"><span class="hljs-number">53</span></span> keep state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto icmp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> &lt;good&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> block <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> fragment block <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> block <span class="hljs-keyword"><span class="hljs-keyword">all</span></span></code> </pre><br>  Specify which file to use in the packet filter: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">pfctl</span></span> -f /etc/firewall/pf.conf</code> </pre><br>  In this rule file there are two tables with a list of ip addresses: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">table</span></span> &lt;good&gt; {<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span>,<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> &lt;nat&gt; {<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span>}</code> </pre><br>  The good table lists the ip addresses of the global zone and the zone that does not have its own network subsystem; if you plan to use several such zones, specify a list of ip addresses separated by commas.  Outgoing traffic will be allowed to ip addresses, and it will be possible to connect via ssh.  If you plan to organize, for example, a web server in the global zone, or in a zone without a network subsystem, in this case you need to add the following line: <br><br><pre> <code class="hljs pgsql">pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span> port=<span class="hljs-number"><span class="hljs-number">80</span></span> flags S/SA modulate state</code> </pre><br>  Or a group of ports: <br><br><pre> <code class="hljs pgsql">pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span> port {<span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">22</span></span>} flags S/SA modulate state</code> </pre><br>  In such cases, it is possible to connect using http, https, ftp, ssh. <br><br>  The nat table shows a subnet zone with its own network subsystem; if you plan several such networks, specify them separated by commas.  In the line below, ‚Äúnate‚Äù through net0 all subnets from the nat table. <br><br><pre> <code class="hljs pgsql">pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> &lt;nat&gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> nat-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> (net0)</code> </pre><br>  The zone with its own network subsystem can be used as a <a href="https://ru.wikipedia.org/wiki/DMZ_(%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8)">DMZ</a> , but for this it is necessary to forward the necessary ports, the next line forwards the web server port 80 to the zone, ie all calls to ip 192.168.1.105 (global zone) will be redirected to ip 192.168.0.2: <br><br><pre> <code class="hljs pgsql">pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> net0 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.105</span></span> port <span class="hljs-number"><span class="hljs-number">80</span></span> rdr-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre><br>  You also need to pay attention to the line: <br><br><pre> <code class="hljs pgsql">pass quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic0 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span></code> </pre><br>  This line allows any traffic on the virtual interface vnic0, this interface will act as a gateway.  The ip address of this interface is 192.168.0.1, this interface will be active in the global zone, so you need to specify it in the rules file.  If several gateways are planned for different subnets, in this case you need to add a similar line with the name of the virtual interface.  For example, if you are planning another subnet 192.168.2.0/24 and assigned the adapter vnic5 ip (how it will be written in the next chapter) address 192.168.2.1, then the line will look like this: <br><br><pre> <code class="hljs pgsql">pass quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic5 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span></code> </pre><br>  Virtual interfaces that are created for a non-global zone do not need to be specified. <br><br><h2>  Zone creation </h2><br>  This chapter can be started with the creation of virtual interfaces, and it is also necessary to allow packets to go between the interfaces net0 and vnic0: <br><br><pre> <code class="hljs pgsql">dladm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-vnic -l net0 vnic0 dladm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-vnic -l net0 vnic1 ipadm <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-ifprop -p forwarding=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -m ipv4 net0 ipadm <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-ifprop -p forwarding=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> -m ipv4 vnic0</code> </pre><br>  After creation, it is necessary to create an ip address for vnic0: <br><br><pre> <code class="hljs sql">ipadm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-ip vnic0 ipadm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-addr -T <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> -a <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> vnic0/v4</code> </pre><br>  This completes the virtual interfaces, unless of course you need to create several more subnets. <br><br>  The next step is to create a zfs pool for storing zones, create a pool from an image file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mkfile</span></span> <span class="hljs-number"><span class="hljs-number">10g</span></span> /disk</code> </pre><br>  This command will create a file of 10 gigabytes in size (you must specify the size you need), create a pool with the command: <br><br><pre> <code class="hljs pgsql">zpool <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> zones /disk</code> </pre><br>  Create two partitions for future zones and assign each quota of 5 gigabytes: <br><br><pre> <code class="hljs sql">zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> zones/zone1 zfs <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> zones/zone2 zfs <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quota</span></span>=<span class="hljs-number"><span class="hljs-number">5</span></span>g zones/zone1 zfs <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quota</span></span>=<span class="hljs-number"><span class="hljs-number">5</span></span>g zones/zone2</code> </pre><br>  At the time of this writing, the version of Solaris 11.4 was a beta version, this version adds the ability to restrict (not applicable to version 11.3) the reading and writing to the zfs section: <br><br><pre> <code class="hljs swift">zfs <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> writelimit=50mb zones/zone1 zfs <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> readlimit=50mb zones/zone2</code> </pre><br>  Let us proceed directly to the creation of the zone, initially create a zone without its own network subsystem, enter the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zonecfg</span></span> -z zone1</code> </pre><br>  After you create the main parameters with the create command, the next step is to remove the anet parameter (contains the network name, mac address, mtu, and so on): <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">remove</span></span> anet</code> </pre><br>  Next, we specify the path for the future zone, set the autorun zone and the type of ip address: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> zonepath=/zones/zone1 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> autoboot=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">shared</span></span></code> </pre><br>  Next, you need to create a network for the zone: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> net</code> </pre><br>  The next step is to specify the physical interface and ip address for the zone, and exit the network settings (end): <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span>=net0 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.106</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Save the changes and exit zonecfg with the commands: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre><br>  Setting the zone occurs after the execution of the command: <br><br><pre> <code class="hljs sql"> zoneadm -z zone1 <span class="hljs-keyword"><span class="hljs-keyword">install</span></span></code> </pre><br>  If the speed of access to the Internet is large enough, then the whole process will take no more than 5 minutes.  After the zone is installed, you need to start it and perform the initial configuration (hostname, dns, domen search, root password, create an account), the configuration is the same as during the installation of the system.  Execute the following commands sequentially (for starting the zone and initial setup): <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zoneadm</span></span> -z zone1 boot zlogin -C zone1</code> </pre><br>  Wait until the "setup wizard" appears.  In the future, it is possible to connect to the zone with the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zlogin</span></span> zone1</code> </pre><br>  This completes the setup and installation of the zone.  Setting up a zone with its own network subsystem is not much different from creating a normal zone, you only need to specify the type of ip address, specify the virtual adapter vnic1 (for which the ip address was not created) as the physical interface, and also not create the ip address for the zone network, ip address will be created when you first connect to the zone (zlogin -C zone2).  In order for everything to work correctly, according to this publication, you must specify the ip address 192.168.0.2. <br><br><pre> <code class="hljs sql">zonecfg -z zone2 <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> remove anet <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> zonepath=/zones/zone2 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> autoboot=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=exclusive <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> net <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span>=vnic1 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> zoneadm -z zone2 <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> zoneadm -z zone2 boot zlogin -C zone2</code> </pre><br>  After the initial configuration is complete, install apache, nano and packet filter, and run apache and packet filter <br><br><pre> <code class="hljs sql">pkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> apache<span class="hljs-number"><span class="hljs-number">-24</span></span> pkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> firewall pkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> nano svcadm <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> apache24 svcadm <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> firewall</code> </pre><br>  Edit pf.conf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nano</span></span> /etc/firewall/pf.conf</code> </pre><br>  In nano, add the lines: <br><br><pre> <code class="hljs cs">ip=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> pass <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic1 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> any to $ip port <span class="hljs-number"><span class="hljs-number">80</span></span> flags S/SA modulate state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic1 proto tcp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $ip to any port {<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span>,<span class="hljs-number"><span class="hljs-number">21</span></span>,<span class="hljs-number"><span class="hljs-number">53</span></span>} flags S/SA modulate state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic1 proto udp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $ip to any port=<span class="hljs-number"><span class="hljs-number">53</span></span> keep state pass <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> quick <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> vnic1 proto icmp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $ip to any block <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> any to any fragment block <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> any to any block all</code> </pre><br>  Specify which file to use in the packet filter: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">pfctl</span></span> -f /etc/firewall/pf.conf</code> </pre><br>  In this example, the $ ip variable is used, if you specified a different ip address, then it is enough to change the first line to the correct address. <br><br><h2>  Additionally </h2><br>  The final chapter discusses zone restrictions, folder mounting, and extended zone powers.  Suppose you need to mount a directory from the global zone, to do this, select the required zone: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zonecfg</span></span> -z zone1</code> </pre><br>  Next, add the file system: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fs</code> </pre><br>  Specify the directory in the global zone (for example, the / test directory): <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> special=/<span class="hljs-keyword"><span class="hljs-keyword">test</span></span></code> </pre><br>  Specify where to mount it: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> dir=/usr/<span class="hljs-keyword"><span class="hljs-keyword">test</span></span></code> </pre><br>  The file system type is loopback: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=lofs</code> </pre><br>  We set the rights to the read-only directory (if necessary, specify rw for writing, or do not add this parameter at all): <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> [ro,nodevices]</code> </pre><br>  Exit the file system settings and save the changes: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre><br>  You can also mount the zfs partition: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dataset <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=rpool/export/home <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span></code> </pre><br>  Restart the zone: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zoneadm</span></span> -z zone1 reboot</code> </pre><br>  Now let's limit the RAM, swap and CPU usage, select the necessary zone: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">zonecfg</span></span> -z zone1</code> </pre><br>  Add memory limits: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> capped-memory</code> </pre><br>  Let's limit the RAM to 1 gigabyte, and swap to 500 megabytes: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">physical</span></span>=<span class="hljs-number"><span class="hljs-number">1024</span></span>m <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> swap=<span class="hljs-number"><span class="hljs-number">500</span></span>m <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span></code> </pre><br>  We limit the use of each processor core to 30 percent: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> capped-cpu <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ncpus=<span class="hljs-number"><span class="hljs-number">.30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span></code> </pre><br>  The final touch, add the default privilege zone, a list of all privileges can be viewed by running the command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ppriv</span></span> -l -v</code> </pre><br>  You can familiarize yourself with the privileges that are used by default (and which can be added if necessary) in this <a href="https://docs.oracle.com/cd/E19044-01/sol.containers/817-1592/z.admin.ov-18/index.html">guide</a> .  You can add privileges with the following command (from zonecfg): <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> limitpriv=<span class="hljs-string"><span class="hljs-string">"default,sys_time"</span></span></code> </pre><br>  As indicated in this <a href="https://docs.oracle.com/cd/E19044-01/sol.containers/817-1592/z.conf.start-85/index.html">guide</a> , this line will set the privileges by default, and also allow you to change the system time from a non-global zone.  In my opinion, it is better for the zone not to add additional privileges, since a zone with a small amount of privileges is more limited in functionality, and therefore more protected. <br><br><h3>  Conclusion </h3><br>  As can be seen from this publication, the zones are quite simple to configure, but at the same time they provide a high level of protection (especially zones with their own network subsystem) in conjunction with the packet filter configured for the policy ‚Äúeverything is not allowed is not allowed‚Äù.  Setup and deployment takes a minimum of effort in time. <br><br>  List of sources that helped me write this publication. <br><br>  <a href="https://docs.oracle.com/cd/E19044-01/sol.containers/817-1592/z.conf.start-85/index.html">Zones</a> <br><br>  <a href="https://www.openbsd.org/faq/pf/filter.html">Packet filter</a> </div><p>Source: <a href="https://habr.com/ru/post/349146/">https://habr.com/ru/post/349146/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349134/index.html">Rust: We get acquainted with the language on the example of "Guess-ki"</a></li>
<li><a href="../349136/index.html">Universal React + Express Applications (continued)</a></li>
<li><a href="../349138/index.html">Comparison: Docker swarm, Kubernetes, Rancher and D2C</a></li>
<li><a href="../349140/index.html">Ramda Thinking: Partial Application (Currying)</a></li>
<li><a href="../349144/index.html">TOP-10. Analysis of the best reports in the public domain. Heisenbug 2017 Moscow</a></li>
<li><a href="../349148/index.html">Answers to common questions about the render prop template</a></li>
<li><a href="../349150/index.html">How to get to the top of Product Hunt</a></li>
<li><a href="../349154/index.html">11 more useful tools for developers and designers with Product Hunt</a></li>
<li><a href="../349156/index.html">Observer, object, stream, environment</a></li>
<li><a href="../349158/index.html">Check Point DEMO or how to quickly see the control interface</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>