<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Personal recommendations in ivi: Hydra</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the ivi online cinema tens of thousands of pieces of content and the task of ‚Äúchoosing what to watch‚Äù becomes nontrivial. 


 We wrote about the re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Personal recommendations in ivi: Hydra</h1><div class="post__text post__text-html js-mediator-article">  In the ivi online cinema tens of thousands of pieces of content and the task of ‚Äúchoosing what to watch‚Äù becomes nontrivial. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/gw/zf/zagwzf2gnpjhmjgmuqomc_xhvug.jpeg"></div><br>  We wrote about the recommendation system in ivi, which deals with the selection of content based on user interests (the internal name is <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B8%25D0%25B4%25D1%2580%25D0%25B0_(Marvel_Comics)">Hydra</a> ) <a href="https://habrahabr.ru/company/ivi/blog/232843/">here</a> and <a href="https://habrahabr.ru/company/ivi/blog/247813/">here</a> .  Much time has passed and the project code has changed significantly: the offline part has moved to Spark, the online part has adapted to high loads, Hydra has started using another recommender model - all these changes will be covered in the article. <br><a name="habracut"></a><br><h2>  <font color="#fd004c">Hydra Architecture</font> </h2><br>  Back in 2014, Hydra was created as a Python application: the data for the recommender model was loaded by a separate script ‚Äî the ‚Äúoffline part‚Äù ‚Äîfrom external sources (Vertica, Mongo, Postgres).  The script was preparing user-item matrix dimension <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.872ex" height="1.937ex" viewBox="0 -728.2 4250.5 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-74" x="1128" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="1490" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="1835" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-65" x="2714" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-73" x="3180" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="3650" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> m \ times n </script>  , where m is the number of users in the training sample, and n is the size of the catalog (the number of unique content units), you can read more about item-based personal recommendations in articles by <a href="https://habrahabr.ru/company/surfingbird/blog/139518/">Sergey Nikolenko</a> . <br><br>  The history of viewing the user is a vector of dimension <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.455ex" viewBox="0 -520.7 600.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> n </script>  in which for each content with which the user interacted (looked, rated), there are units, the remaining elements are zero.  Since each user interacts with dozens of content units, and the size of the directory is thousands of units, we get a sparse row vector in which there are a lot of zeros and the user-item matrix consists of such vectors.  The online cinema ivi collects rich feedback from users - content views, ratings (on a ten-point scale), onboarding results (binary preferences ‚Äúlike - dislike‚Äù, here is a presentation with <a href="https://www.useronboard.com/how-netflix-onboards-new-users/%3Fslide%3D64">an example from Netflix</a> ) - the model is trained on this data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The classic memory-based algorithm was used to issue recommendations - Hydra ‚Äúmemorized‚Äù the training sample and stored a matrix of user views (and ratings) in memory.  With the growth of the service audience in proportion to the growth and size of the matrix user-item.  The architecture of the reference service at the time looked like this: <br><br><img src="https://habrastorage.org/webt/4t/l3/md/4tl3mdzztwi-k_flyczyrn-zqyq.jpeg"><br><br><h2>  <font color="#fd004c">Disadvantages of Hydra</font> </h2><br>  As can be seen in the diagram, feedback from users (views, content ratings, onboarding marks) is stored in fast key-value repositories (MongoDB and Redis) and in Vertica - column data repository.  Data is vertically fed incrementally using special ETL procedures. <br><br>  The offline part is launched daily by crown: it downloads data, trains the model, saves it as textual and binary files (sparse matrices, python-objects in the .pkl format).  The online part generates recommendations based on the model and history of the user's targeted actions ‚Äî views, ratings, content purchases (read user feedback from Redis / Mongo).  Recommendations are issued using dozens of python processes running on each server (there are a total of 8 servers in the Hydra cluster). <br><br>  This architecture gave rise to several problems: <br><br><ul><li>  Hydra is a bundle of python processes, each of which picks up its own set of files from the offline part into memory - this leads to the fact that memory consumption grows over time (the file size grows with the number of users), which makes it difficult to scale the system.  In addition, when starting the service, each process must read files from the disk - this is slow; </li><li>  there are more and more users; data collection starts to take a lot of time; </li><li>  Hydra was a monolithic application: data preparation became more and more complex, it didn‚Äôt use the rest of ivi microservices - because of this it was necessary to develop various auxiliary scripts. </li></ul><br><h2>  <font color="#fd004c">Hydra: revival</font> </h2><br>  The system in this form (with constant modifications and improvements) survived until February 2017.  Time to download data in offline parts grew algorithm of the model remained unchanged.  At the beginning of 2017, we decided to move from a memory-based reference model to a more recent ALS algorithm (on the Coursera there is a video about <a href="https://ru.coursera.org/learn/unsupervised-learning/lecture/xYpnf/sgd-i-als">this model</a> ). <br><br>  In short, the algorithm tries to present our huge sparse user-item matrix. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>U</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.783ex" height="2.057ex" viewBox="0 -780.1 767.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-55" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>U</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> U </script>  in the form of a product of two "dense" matrices: user matrices and content matrices: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>U</mi><mo>=</mo><mi>X</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><msup><mi>Y</mi><mi>T</mi></msup><mo>;</mo><mi>U</mi><mtext>&amp;#xA0;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>m</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></mrow></msup><mo>,</mo><mi>X</mi><mtext>&amp;#xA0;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>m</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>k</mi></mrow></msup><mo>;</mo><mi>Y</mi><mtext>&amp;#xA0;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>n</mi><mtext>&amp;#xA0;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>k</mi></mrow></msup></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="60.284ex" height="2.901ex" viewBox="0 -987.6 25955.4 1249" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-55" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3D" x="1045" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-58" x="2101" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-74" x="3204" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="3565" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="3911" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-65" x="4789" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-73" x="5256" y="0"></use><g transform="translate(5725,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-59" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-54" x="1157" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3B" x="7141" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-55" x="7587" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="8604" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="8950" y="0"></use><g transform="translate(9550,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-52" x="0" y="0"></use><g transform="translate(759,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-74" x="1232" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="1593" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="1939" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-65" x="2817" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-73" x="3284" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="3753" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-2C" x="13488" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-58" x="13933" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="15036" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="15381" y="0"></use><g transform="translate(15982,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-52" x="0" y="0"></use><g transform="translate(759,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-74" x="1232" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="1593" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="1939" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-65" x="2817" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-73" x="3284" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6B" x="3753" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3B" x="19864" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-59" x="20310" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="21323" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="21669" y="0"></use><g transform="translate(22269,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-52" x="0" y="0"></use><g transform="translate(759,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6E" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-74" x="954" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="1315" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="1661" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-65" x="2539" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-73" x="3006" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6B" x="3475" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>U</mi><mo>=</mo><mi>X</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><msup><mi>Y</mi><mi>T</mi></msup><mo>;</mo><mi>U</mi><mtext>&nbsp;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>n</mi></mrow></msup><mo>,</mo><mi>X</mi><mtext>&nbsp;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>k</mi></mrow></msup><mo>;</mo><mi>Y</mi><mtext>&nbsp;</mtext><mi>i</mi><mi>n</mi><msup><mi>R</mi><mrow class="MJX-TeXAtom-ORD"><mi>n</mi><mtext>&nbsp;</mtext><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>k</mi></mrow></msup></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-4"> U = X \ times Y ^ T; U \ in R ^ {m \ times n}, X \ in R ^ {m \ times k}; Y \ in R ^ {n \ times k} </script></p><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u1/te/h9/u1teh9ksjb63euvsnbw9iqcvlfi.png"></div><br>  ALS allows you to train for each user. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>u</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-75" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>u</mi></math></span></span><script type="math/tex" id="MathJax-Element-5"> u </script>  vector <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mi>u</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.502ex" height="1.817ex" viewBox="0 -520.7 1077.3 782.1" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-75" x="809" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>x</mi><mi>u</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-6"> x_u </script>  dimensions <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.211ex" height="2.057ex" viewBox="0 -780.1 521.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6B" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi></math></span></span><script type="math/tex" id="MathJax-Element-7"> k </script>  - so-called  "Hidden factors" of the user.  Each content unit <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>i</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="1.937ex" viewBox="0 -728.2 345.5 834" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>i</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> i </script>  matches vector <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>y</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.939ex" height="1.817ex" viewBox="0 -520.7 834.8 782.1" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-79" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-69" x="693" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>y</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-9"> y_ {i} </script>  the same dimension, "hidden factors" of content.  Wherein <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;lt;&amp;lt;</mo><mi>m</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.158ex" height="2.057ex" viewBox="0 -780.1 3512.6 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6B" x="0" y="0"></use><g transform="translate(799,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3C"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3C" x="778" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6D" x="2634" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>&lt;&lt;</mo><mi>m</mi></math></span></span><script type="math/tex" id="MathJax-Element-10"> k << m </script>  , the dimension of the space of hidden factors is much smaller than the size of the directory, each user describes a dense vector of low dimension (usually <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><mo>&amp;lt;</mo><mn>100</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.797ex" height="2.057ex" viewBox="0 -780.1 3357.1 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMATHI-6B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-3C" x="799" y="0"></use><g transform="translate(1855,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ivi/blog/351176/&amp;xid=17259,15700023,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhicpXJeKYUZhA0n_Rbsr36HCg0UQA#MJMAIN-30" x="1001" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><mo>&lt;</mo><mn>100</mn></math></span></span><script type="math/tex" id="MathJax-Element-11"> k <100 </script>  ). <br><br>  The product of the vector of the user by the vector of the content is the relevance of the content to the user: the higher it is, the more chances the film has to get to the issue.  The ALS exhaust is ground in the business rules grinder, because besides the ‚Äúshow content that a user will like‚Äù task, the recommender system has a number of tasks related to content monetization, service positioning, etc.  Business rules slightly distort the vector of recommendations - this fact must be taken into account, for example, when conducting an offline assessment of the model. <br><br><h2>  <font color="#fd004c">New architecture</font> </h2><br>  Much work has been done on redesigning the service, the results of which are as follows: <br><br><img src="https://habrastorage.org/webt/2r/f1/ix/2rf1ixqenijiw7bqrsubqicwhs0.jpeg"><br><br><ul><li>  Data preparation for training models was transferred to Spark - instead of appeals to Vertica we read from Hadoop-repository Hive.  Vertika is a very fast database, but with the growth of data volumes it takes a long time to transfer them over the network, and Spark allows you to perform computations distributed, on the nodes of the cluster.  In addition, Spark implements an ALS model for implicit feedback (the model is trained on data about the duration of content viewing by the user); </li><li>  the data from the offline parts, which had previously been raised in memory of each process, moved to Redis.  Now, instead of duplicating objects in memory, Hydra accesses the Redis-storage - we get one instance of data for all processes on the server, memory consumption has decreased by 2 times.  Time to restart the service was reduced from half an hour to 6 minutes - wait until several dozen processes read the data from the files for a long time, and now the data is already in Redis, at the time of the restart Hydra just checks their availability <br><br><img src="https://habrastorage.org/webt/nz/pw/u2/nzpwu2j5jad4korcfydqhehe77o.jpeg"></li><li>  Hydra recalculated the recommendations in response to each user‚Äôs transition between the application screens ‚Äî even if the user didn‚Äôt perform targeted actions that could change his recommendations (looked at the content, rated it).  To produce a huge amount of calculations turned out to be very expensive for processor resources.  In the depths of the method of obtaining recommendations on the ALS model, we use a bit of linear algebra from numpy (for example, <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.linalg.solve.html">numpy.linalg.solve</a> ), with each python process using several cores to read faster - this greatly loads the CPU.  As can be seen in the picture, after the implementation of the recommendatory model, the ALS Response Time system increased with each passing day (this is due to the fact that the AB test of the new model captured all new users).  To avoid linear dependence of the load on the number of users, the system of caching the vector of recommendations was developed: the cache was dropped (and the recommendations were recalculated) only after a new ‚Äútarget action‚Äù of the user: viewing or evaluation. <br><br><img src="https://habrastorage.org/webt/3k/vq/le/3kvqle8ephngzbv1oxho747cbdc.jpeg"></li><li>  For the formation of the vector of user recommendations began to use a hybrid model.  Earlier in the business rules of the recommendatory system (and we have a lot of business rules) there was a so-called  ‚ÄúPersonalization boundary‚Äù: if the user has less than 5 views, the recommendations were top popular content, and after the 5th viewing, the user began to receive personal recommendations - this led to a situation where the user recommendations changed dramatically after the fifth viewing.  In the formation of recommendations, the information that is popular on the service at the moment and the user's personal recommendations are combined: the more feedback from the user has accumulated, the less popular becomes in the top and the more personal ‚Äî the user receives (some) personalized issue after the first view. </li><li>  The diagram has an arrow from client applications immediately in Hive - this is data from the <a href="https://habrahabr.ru/company/ivi/blog/236253/">groot event analytics</a> system, the data from which (user clicks, local time of the client application) Hydra began to use more actively: for example, we ran tests of context-sensitive recommendations when the same user the vector of recommendations adapted under a context - for example, viewing time (morning or evening, weekdays or the weekend). </li><li>  Previously, the result of the work of the offline part was a bundle of files that were raised by each Hydra process into memory at the time of the service restart.  Now the data gets to Redis from offline parts directly, bypassing intermediate files.  This scheme greatly accelerates the restart of the service - no need to read anything from the disk, the data is already in memory and ready for use. </li></ul><br><h2>  <font color="#fd004c">Conclusion</font> </h2><br>  Hydra for the year has changed a lot both in architectural terms and in the algorithmic part.  More details about these changes will be discussed in a series of articles. </div><p>Source: <a href="https://habr.com/ru/post/351176/">https://habr.com/ru/post/351176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351166/index.html">Guide to background work in Android. Part 3: Executors and EventBus</a></li>
<li><a href="../351168/index.html">Understanding redux-saga: From action generators to sagas</a></li>
<li><a href="../351170/index.html">How Red Hat killed its main product and became a multi-billion dollar corporation</a></li>
<li><a href="../351172/index.html">Modbus protocol extension options: polling acceleration and a bit of security</a></li>
<li><a href="../351174/index.html">Oculus Rift helmets did not work for almost a day due to an overdue code signature certificate.</a></li>
<li><a href="../351178/index.html">How we adopted the Khan Academy experience and made our course for testers</a></li>
<li><a href="../351180/index.html">JetBrains Open Day in Moscow</a></li>
<li><a href="../351182/index.html">Hosting PCI DSS: what you need to know</a></li>
<li><a href="../351184/index.html">How to adapt the game on Unity for iPhone X to April</a></li>
<li><a href="../351188/index.html">What is the program between the lines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>