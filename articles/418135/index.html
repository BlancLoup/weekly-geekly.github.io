<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to organize your own repository of Node.js modules with blackjack and versioning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The ISPsystem currently has three front-end teams developing three major projects: ISPmanager for managing web servers, VMmanager for working with vir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to organize your own repository of Node.js modules with blackjack and versioning</h1><div class="post__text post__text-html js-mediator-article">  The <a href="https://www.ispsystem.ru/">ISPsystem</a> currently has three front-end teams developing three major projects: ISPmanager for managing web servers, VMmanager for working with virtualization, and BILLmanager for automating hosters' business.  The teams work simultaneously, in the mode of short deadlines, so it‚Äôs impossible to do without optimization.  To save time, we apply uniform decisions and we carry out the general components in separate projects.  Such projects have their own repositories that are supported by members of all teams.  On the device of these repositories, as well as work with them, and this article will be. <br><br><img src="https://habrastorage.org/webt/mg/iy/6q/mgiy6qrobuyeayjea76m8redbww.gif"><br><a name="habracut"></a><br><h2>  How repositories of common projects are arranged </h2><br>  We use our own server with <a href="https://about.gitlab.com/">GitLab</a> to store remote repositories.  For us it was important to keep the usual working environment and to be able to work with common modules in the process of their development.  Therefore, we refused to publish in the private repositories of <a href="https://www.npmjs.com/">npmjs.com</a> .  Benefit Node.js modules can be installed not only from NPM, but also from <a href="https://docs.npmjs.com/cli/install">other sources</a> , including git-repositories. <br><br>  We write in TypeScript, which is subsequently compiled into JavaScript for later use.  But nowadays, unless a lazy fronder does not compile your JavaScript.  Therefore, we need different repositories for the source code and the compiled project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After going through the thorns of long discussions, we have developed the following concept.  There should be two separate repositories for the source and for the compiled version of the module.  And the second repository should be a mirror of the first. <br><br>  This means that when developing, a feature should be published until the moment of release in a branch with the exact same name as that of the branch in which the development is being carried out.  Thus, we have the opportunity to use the experimental version of the module, installing it from a specific branch.  The one in which we are developing is very convenient to test it in action. <br><br>  Plus, for each publication we create a label that preserves the status of the project.  The label name corresponds to the version specified in package.json.  When installing from a git repository, the label is indicated after the grid, for example: <br><br><pre><code class="bash hljs">npm install git+ssh://[url ]<span class="hljs-comment"><span class="hljs-comment">#1.0.0</span></span></code> </pre> <br>  Thus, we can fix the used version of the module and not worry that someone will change something. <br><br>  Labels are also created for unstable versions, however, a reduced hash of the commit is added to them in the source repository from which the publication was made.  Here is an example of such a label: <br><br><pre> <code class="hljs css">1<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0_e5541dc1</span></span></code> </pre> <br>  This approach allows you to achieve unique tags, as well as link them to the source repository. <br><br>  Since we started talking about stable and unstable versions of the module, here‚Äôs how we distinguish them: if the publication is run from the master or develop branch, the version is stable, otherwise it‚Äôs not. <br><br><h2>  How is work with common projects organized? </h2><br>  All our arrangements would not make sense if we could not automate them.  In particular, automate the process of publishing.  Below, I will show how work is organized with one of the common modules - a utility for testing user scripts. <br><br>  Using the <a href="https://github.com/GoogleChrome/puppeteer">puppeteer</a> library, this utility prepares the Chromium browser for use in docker containers and runs tests using <a href="https://mochajs.org/">Mocha</a> .  Members of all teams can modify the utility without fear of breaking something from each other. <br><br>  The following command is written in the package.json utility file for testing: <br><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"publish:git"</span></span>: <span class="hljs-string"><span class="hljs-string">"ts-node ./scripts/publish.ts"</span></span></code> </pre> <br>  It runs the next lying script: <br><br><div class="spoiler">  <b class="spoiler_title">Complete Publishing Script Code</b> <div class="spoiler_text"><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { spawnSync } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'child_process'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { mkdirSync, existsSync } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { join } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> chalk <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'chalk'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *      * @param cwd -    * @param stdio -  / */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getSpawnOptions = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cwd = process.cwd(</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdio</span></span></span><span class="hljs-function"> = '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">inherit</span></span></span><span class="hljs-function">') =&gt;</span></span> ({ cwd, <span class="hljs-attr"><span class="hljs-attr">shell</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, stdio, }); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rootDir = join(__dirname, <span class="hljs-string"><span class="hljs-string">'../'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isDiff = !!spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'diff'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>)).stdout.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isDiff) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chalk.red(<span class="hljs-string"><span class="hljs-string">'There are uncommitted changes'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> build = spawnSync(<span class="hljs-string"><span class="hljs-string">'npm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'run'</span></span>, <span class="hljs-string"><span class="hljs-string">'build'</span></span>], getSpawnOptions(rootDir)); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (build.status === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tempDir = join(rootDir, <span class="hljs-string"><span class="hljs-string">'temp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existsSync(tempDir)) { spawnSync(<span class="hljs-string"><span class="hljs-string">'rm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-rf'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span>], getSpawnOptions(rootDir)); } mkdirSync(tempDir); <span class="hljs-comment"><span class="hljs-comment">/*    package.json */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { name, version, repository } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(join(rootDir, <span class="hljs-string"><span class="hljs-string">'package.json'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> originUrl = repository.url.replace(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string">-source`</span></span>, name); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'init'</span></span>], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'add'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, originUrl], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> branch = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'symbolic-ref'</span></span>, <span class="hljs-string"><span class="hljs-string">'--short'</span></span>, <span class="hljs-string"><span class="hljs-string">'HEAD'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buildBranch = branch === <span class="hljs-string"><span class="hljs-string">'develop'</span></span> ? <span class="hljs-string"><span class="hljs-string">'master'</span></span> : branch; <span class="hljs-comment"><span class="hljs-comment">/*       ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> shortSHA = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'rev-parse'</span></span>, <span class="hljs-string"><span class="hljs-string">'--short'</span></span>, <span class="hljs-string"><span class="hljs-string">'HEAD'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tag = buildBranch === <span class="hljs-string"><span class="hljs-string">'master'</span></span> ? version : <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${version}</span></span></span><span class="hljs-string">_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${shortSHA}</span></span></span><span class="hljs-string">`</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isTagExists = !!spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'ls-remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, <span class="hljs-string"><span class="hljs-string">`refs/tags/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tag}</span></span></span><span class="hljs-string">`</span></span>], getSpawnOptions(tempDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isTagExists) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chalk.red(<span class="hljs-string"><span class="hljs-string">`Tag </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tag}</span></span></span><span class="hljs-string"> already exists`</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isBranchExits = !!spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'ls-remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'--exit-code'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isBranchExits) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'fetch'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, buildBranch], getSpawnOptions(tempDir)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*    master */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'fetch'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span>], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span>], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, <span class="hljs-string"><span class="hljs-string">'-b'</span></span>, buildBranch], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'commit'</span></span>, <span class="hljs-string"><span class="hljs-string">'--allow-empty'</span></span>, <span class="hljs-string"><span class="hljs-string">'-m'</span></span>, <span class="hljs-string"><span class="hljs-string">'"Initial commit"'</span></span>], getSpawnOptions(tempDir)); } <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> spawnSync( <span class="hljs-string"><span class="hljs-string">'rm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-rf'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'package.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'package-lock.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'README.md'</span></span>], getSpawnOptions(tempDir) ); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'cp'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-r'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp/lib'</span></span>], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'cp'</span></span>, [<span class="hljs-string"><span class="hljs-string">'package.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp/package.json'</span></span>], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'cp'</span></span>, [<span class="hljs-string"><span class="hljs-string">'package-lock.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp/package-lock.json'</span></span>], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'cp'</span></span>, [<span class="hljs-string"><span class="hljs-string">'README.md'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp/README.md'</span></span>], getSpawnOptions(rootDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, <span class="hljs-string"><span class="hljs-string">'--all'</span></span>], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastCommitMessage = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'log'</span></span>, <span class="hljs-string"><span class="hljs-string">'--oneline'</span></span>, <span class="hljs-string"><span class="hljs-string">'-1'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = buildBranch === <span class="hljs-string"><span class="hljs-string">'master'</span></span> ? version : lastCommitMessage; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'commit'</span></span>, <span class="hljs-string"><span class="hljs-string">'-m'</span></span>, <span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message}</span></span></span><span class="hljs-string">"`</span></span>], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'tag'</span></span>, tag], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'push'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'push'</span></span>, <span class="hljs-string"><span class="hljs-string">'--tags'</span></span>], getSpawnOptions(tempDir)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chalk.green(<span class="hljs-string"><span class="hljs-string">'Published successfully!'</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'rm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-rf'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span>], getSpawnOptions(rootDir)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(chalk.red(<span class="hljs-string"><span class="hljs-string">`Build was exited exited with code </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${build.status}</span></span></span><span class="hljs-string">`</span></span>)); } } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-comment"><span class="hljs-comment">// space</span></span></code> </pre><br></div></div><br>  In turn, this code through the Node.js module <a href="https://nodejs.org/api/child_process.html">child_process</a> executes all the necessary commands. <br><br><h3>  Here are the main stages of his work: </h3><br>  <b>1. Check for uncommitted changes</b> <br><br><pre> <code class="hljs erlang-repl">const isDiff = !!spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'diff'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>)).stdout.toString().trim();</code> </pre> <br>  Here we check the output of the <a href="https://git-scm.com/docs/git-diff">git diff command</a> .  It is not good if the publication includes changes that are not in the source code.  In addition, it will break the link between unstable versions and commits. <br><br>  <b>2. Build utility</b> <br><br><pre> <code class="hljs lisp">const build = spawnSync('npm', ['run', 'build'], getSpawnOptions(<span class="hljs-name"><span class="hljs-name">rootDir</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  The build constant is the result of the build.  If everything went well, the status parameter will be 0. Otherwise, nothing will be published. <br><br>  <b>3. Expanding the compiled versions repository</b> <br><br>  The entire publishing process is nothing more than sending changes to a specific repository.  Therefore, the script creates in our project a temporary directory in which it initializes the git repository and links it to the remote assembly repository. <br><br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> const tempDir = <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(rootDir, <span class="hljs-string"><span class="hljs-string">'temp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existsSync(tempDir)) { spawnSync(<span class="hljs-string"><span class="hljs-string">'rm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-rf'</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span>], getSpawnOptions(rootDir)); } mkdirSync(tempDir); <span class="hljs-comment"><span class="hljs-comment">/*    package.json */</span></span> const { <span class="hljs-type"><span class="hljs-type">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>, repository } = require(<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(rootDir, <span class="hljs-string"><span class="hljs-string">'package.json'</span></span>)); const originUrl = repository.url.replace(`${<span class="hljs-type"><span class="hljs-type">name</span></span>}-source`, <span class="hljs-type"><span class="hljs-type">name</span></span>); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'init'</span></span>], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'add'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, originUrl], getSpawnOptions(tempDir));</code> </pre> <br>  This is a standard process using <a href="https://git-scm.com/docs/git-init">git init</a> and <a href="https://git-scm.com/docs/git-remote">git remote</a> . <br><br>  <b>4. Generating a tag name</b> <br><br>  First, we find out the name of the branch from which we are publishing, using the <a href="https://git-scm.com/docs/git-symbolic-ref">git symbolic-ref</a> command.  And we set the name of the branch to which the changes will be uploaded (there is no develop branch in the assembly repository). <br><br><pre> <code class="hljs vala"><span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> branch = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'symbolic-ref'</span></span>, <span class="hljs-string"><span class="hljs-string">'--short'</span></span>, <span class="hljs-string"><span class="hljs-string">'HEAD'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).<span class="hljs-keyword"><span class="hljs-keyword">stdout</span></span>.toString().trim(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> buildBranch = branch === <span class="hljs-string"><span class="hljs-string">'develop'</span></span> ? <span class="hljs-string"><span class="hljs-string">'master'</span></span> : branch;</code> </pre> <br>  Using the <a href="https://git-scm.com/docs/git-rev-parse">git rev-parse</a> command, we get the shortened hash of the last commit in the branch we are in.  You may need it to generate the label name of the unstable version. <br><br><pre> <code class="hljs mel">&lt;<span class="hljs-keyword"><span class="hljs-keyword">source</span></span> lang=<span class="hljs-string"><span class="hljs-string">"typescript"</span></span>&gt;<span class="hljs-comment"><span class="hljs-comment">/*       ,       */</span></span> const shortSHA = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'rev-parse'</span></span>, <span class="hljs-string"><span class="hljs-string">'--short'</span></span>, <span class="hljs-string"><span class="hljs-string">'HEAD'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().<span class="hljs-keyword"><span class="hljs-keyword">trim</span></span>();</code> </pre> <br>  Well, actually make up the name of the label. <br><br><pre> <code class="hljs javascript"><span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tag = buildBranch === <span class="hljs-string"><span class="hljs-string">'master'</span></span> ? version : <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${version}</span></span></span><span class="hljs-string">_</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${shortSHA}</span></span></span><span class="hljs-string">`</span></span>;</code> </pre> <br>  <b>5. Check for the absence of the exact same label in the remote repository.</b> <br><br><pre> <code class="hljs javascript"><span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isTagExists = !!spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'ls-remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, <span class="hljs-string"><span class="hljs-string">`refs/tags/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tag}</span></span></span><span class="hljs-string">`</span></span>], getSpawnOptions(tempDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim();</code> </pre><br>  If a similar label was created earlier, the result of the <a href="https://git-scm.com/docs/git-ls-remote">git ls-remote command</a> will not be empty.  The same version should be published only once. <br><br>  <b>6. Creating the appropriate branch in the build repository</b> <br><br>  As I said earlier, the repository of compiled versions of the utility is a mirror of the repository with the sources.  Therefore, if the publication is not from a master or develop branch, we must create a corresponding branch in the assembly repository.  Well, or at least make sure it exists <br><br><pre> <code class="hljs vala"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isBranchExits = !!spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'ls-remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'--exit-code'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).<span class="hljs-keyword"><span class="hljs-keyword">stdout</span></span>.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isBranchExits) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'fetch'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, buildBranch], getSpawnOptions(tempDir)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*    master */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'fetch'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span>], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, <span class="hljs-string"><span class="hljs-string">'master'</span></span>], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'checkout'</span></span>, <span class="hljs-string"><span class="hljs-string">'-b'</span></span>, buildBranch], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'commit'</span></span>, <span class="hljs-string"><span class="hljs-string">'--allow-empty'</span></span>, <span class="hljs-string"><span class="hljs-string">'-m'</span></span>, <span class="hljs-string"><span class="hljs-string">'"Initial commit"'</span></span>], getSpawnOptions(tempDir)); }</code> </pre> <br>  If the branch was absent earlier, we initialize with an empty commit using the <a href="https://git-scm.com/docs/git-commit">--allow-empty</a> flag. <br><br>  <b>7. File preparation</b> <br><br>  First you need to delete everything that could be in the expanded repository.  After all, if we use a previously existing branch, it contains the previous version of the utility. <br><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> spawnSync( <span class="hljs-string"><span class="hljs-string">'rm'</span></span>, [<span class="hljs-string"><span class="hljs-string">'-rf'</span></span>, <span class="hljs-string"><span class="hljs-string">'lib'</span></span>, <span class="hljs-string"><span class="hljs-string">'package.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'package-lock.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'README.md'</span></span>], getSpawnOptions(tempDir) );</code> </pre> <br>  Next, transfer the updated files required for publication, and add them to the repository index. <br><br><pre> <code class="hljs vhdl"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-symbol"><span class="hljs-symbol">'cp</span></span>', ['-r', <span class="hljs-symbol"><span class="hljs-symbol">'lib</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'temp</span></span>/lib'], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-symbol"><span class="hljs-symbol">'cp</span></span>', [<span class="hljs-symbol"><span class="hljs-symbol">'package</span></span>.json', <span class="hljs-symbol"><span class="hljs-symbol">'temp</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">package</span></span>.json'], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-symbol"><span class="hljs-symbol">'cp</span></span>', [<span class="hljs-symbol"><span class="hljs-symbol">'package</span></span>-lock.json', <span class="hljs-symbol"><span class="hljs-symbol">'temp</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">package</span></span>-lock.json'], getSpawnOptions(rootDir)); spawnSync(<span class="hljs-symbol"><span class="hljs-symbol">'cp</span></span>', [<span class="hljs-symbol"><span class="hljs-symbol">'README</span></span>.md', <span class="hljs-symbol"><span class="hljs-symbol">'temp</span></span>/README.md'], getSpawnOptions(rootDir)); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> spawnSync(<span class="hljs-symbol"><span class="hljs-symbol">'git</span></span>', [<span class="hljs-symbol"><span class="hljs-symbol">'add</span></span>', '<span class="hljs-comment"><span class="hljs-comment">--all'], getSpawnOptions(tempDir));</span></span></code> </pre> <br>  After this manipulation, git recognizes well the changes made by file lines.  This way we get a consistent change history even in the compiled versions repository. <br><br>  <b>8. Commit and submit changes.</b> <br><br>  As a commit message in the build repository, we use the label name for stable versions.  And for unstable, a commit message from the source repository.  Thus supporting our idea of ‚Äã‚Äãstorage mirror. <br><br><pre> <code class="hljs kotlin"><span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastCommitMessage = spawnSync( <span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'log'</span></span>, <span class="hljs-string"><span class="hljs-string">'--oneline'</span></span>, <span class="hljs-string"><span class="hljs-string">'-1'</span></span>], getSpawnOptions(rootDir, <span class="hljs-string"><span class="hljs-string">'pipe'</span></span>) ).stdout.toString().trim(); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = buildBranch === <span class="hljs-string"><span class="hljs-string">'master'</span></span> ? version : lastCommitMessage; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'commit'</span></span>, <span class="hljs-string"><span class="hljs-string">'-m'</span></span>, `<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message}</span></span></span><span class="hljs-string">"</span></span>`], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'tag'</span></span>, tag], getSpawnOptions(tempDir)); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'push'</span></span>, <span class="hljs-string"><span class="hljs-string">'origin'</span></span>, buildBranch], getSpawnOptions(tempDir)); spawnSync(<span class="hljs-string"><span class="hljs-string">'git'</span></span>, [<span class="hljs-string"><span class="hljs-string">'push'</span></span>, <span class="hljs-string"><span class="hljs-string">'--tags'</span></span>], getSpawnOptions(tempDir));</code> </pre> <br>  <b>9. Delete temporary directory</b> <br><br><pre> <code class="hljs lisp">spawnSync('rm', ['-rf', 'temp'], getSpawnOptions(<span class="hljs-name"><span class="hljs-name">rootDir</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><h2>  Review of updates in shared projects </h2><br>  One of the most important processes after making changes to common projects becomes review.  Despite the fact that the developed technology allows you to create completely isolated versions of modules, no one wants to have dozens of different versions of the same utility.  Therefore, each of the common projects should follow a single path of development.  It is worth negotiating between the teams. <br><br>  A review of updates in shared projects is conducted by members of all teams as far as possible.  This is a difficult process, as each team lives on its own sprint and has a different workload.  Sometimes the transition to the new version may be delayed. <br><br>  Here you can only recommend not to neglect and not to delay with this process. </div><p>Source: <a href="https://habr.com/ru/post/418135/">https://habr.com/ru/post/418135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418123/index.html">Atomic memory: 8-bit alphabet and 192-bit tune from the game Mario</a></li>
<li><a href="../418125/index.html">Adventure operator pipeline in babel @ 7</a></li>
<li><a href="../418127/index.html">True and False Face Recognition Systems</a></li>
<li><a href="../418131/index.html">Cross-Cloud Programming with Go Cloud</a></li>
<li><a href="../418133/index.html">In defense of OOP. 7 untenable arguments of his opponents</a></li>
<li><a href="../418137/index.html">Bloodlust: an interview with the founder of DonorSearch</a></li>
<li><a href="../418139/index.html">Numerical solution of mathematical models of objects given by systems of differential equations</a></li>
<li><a href="../418141/index.html">RE: Gata / AFR Beginner Skipper Race</a></li>
<li><a href="../418143/index.html">PVS-Studio as SAST solution</a></li>
<li><a href="../418145/index.html">The first lawsuit against Roskomnadzor from the company that suffered while blocking Telegram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>