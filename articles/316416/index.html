<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Global objects and their habitats</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Global objects are widely used because of their ease of use. They store settings, game entities and in general any data that may be needed anywhere in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Global objects and their habitats</h1><div class="post__text post__text-html js-mediator-article">  Global objects are widely used because of their ease of use.  They store settings, game entities and in general any data that may be needed anywhere in the code.  Passing to the function all the necessary arguments can inflate the list of parameters to a very large size.  In addition to convenience, there are also disadvantages: the order of initialization and destruction, additional dependencies, the complexity of writing unit tests.  Many biased programmers believe that global variables are used only by beginners and this is the level of student labs.  However, in large projects like CryEngine, UDK, OGRE, global objects also apply.  The only difference is in the level of ownership of this tool. <br><br> <a href="https://habrahabr.ru/company/playrix/blog/316416/"><img src="https://habrastorage.org/getpro/habr/post_images/b66/e83/9a4/b66e839a415c4d4c95a9c177cf846e6a.png"></a> <br><br>  So, what kind of beast is this <i>global object,</i> how to tame it and use the facilities, minimizing the disadvantages?  Let's figure it out together. <br><a name="habracut"></a><br>  There are many ways to create a global object.  The easiest way is to declare an <i>extern</i> variable in the header file and create its instance in cpp: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs vhdl">// header <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> extern Foo g_foo; // cpp <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> Foo g_foo;</code> </pre> <br>  A more abstract approach is the <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25BE%25D1%2587%25D0%25BA%25D0%25B0_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">singleton pattern</a> . <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PrepareFoo</span></span>(...) { <span class="hljs-attribute"><span class="hljs-attribute">FooManager</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">getInstance</span></span>().Initialize (); }</code> </pre> <br>  What is good about this decision, that he gets so much attention?  It allows you to use the object anywhere in the program.  Very convenient, and the temptation to do so is very great.  Problems begin when it is necessary to replace a part of the system without disrupting the work of the rest, or to test the code.  In the latter case, we will have to initialize almost all global variables that are used by the method we are interested in.  Moreover, the difficulties listed above make it very difficult to replace the behavior of an object with a desired one for tests.  There is also no control over the order of creation and deletion, which can lead to undefined behavior or program crashes.  For example, when referring to a not yet created or already deleted global object. <br><br>  In general, it is preferable to use local variables instead of global ones.  For example, if you need to draw a certain object and there is a global Renderer, then it is better to transfer it directly to the <code>void Draw(Renderer&amp; render_instance)</code> method <code>void Draw(Renderer&amp; render_instance)</code> , rather than using the global <code>Render::Instance</code> ().  More examples and rationales why you should not use singleton can be read in the <a href="https://blog.molecular-matters.com/2011/11/11/singleton-is-an-anti-pattern/">post</a> . <br><br>  However, it is difficult to do without global objects.  If you need access to settings or prototypes, then you will not attach all the necessary containers, factories and other parameters to each object.  This case we will consider. <br><br>  To begin with, setting the task: <br><br><ol><li>  The object must be accessible from any part of the program. </li><li>  All recyclable global objects must be stored centrally - for ease of support. </li><li>  The ability to add and / or replace global objects, depending on the context, is a real launch or test. </li></ol><br>  To consider the implementation successful, it is important to fulfill all the indicated conditions. <br><br>  An interesting solution was peeped in the <a href="">depths of</a> CryEngine (see <code>SSystemGlobalEnvironment</code> ).  Global objects are wrapped in one structure and are pointers to abstract entities that are initialized at the right time in the right place in the program.  No extra overhead, no extra add-ons, type control during compilation - beauty! <br><br>  CryEngine is a rather old project that has been grinded over the years, where all the interfaces have settled down, and the new one is screwed similar to what exists at the moment.  Therefore, there is no need to invent additional wrappers or ways of working with global objects.  There is another option - a young and rapidly developing project, where there are no strict interfaces, where the functionality is constantly changing, which makes it necessary to make changes to the interfaces quite often.  I want to have a solution that will help in old projects to refactor, and in new ones, where global access is still needed, minimize the disadvantages of using.  To search for an answer, you can try to go up a level and look at the problem from a different angle ‚Äî create a repository of global objects inherited from <code>GlobalObjectBase</code> .  Using the shell will add operations at runtime, so be sure to pay attention to performance after changes. <br><br>  First you need to create a base class, the heirs of which can be placed in the storage object. <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GlobalObjectBase</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">public</span></span>: virtual ~<span class="hljs-built_in"><span class="hljs-built_in">GlobalObjectBase</span></span>() {} };</code> </pre><br>  Now the storage itself.  To access from any part of the program, an object of this class must be made global using one of the standard methods, which you will like more. <br><br><div class="spoiler">  <b class="spoiler_title">Storage class</b> <div class="spoiler_text"><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalObjectsStorage</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ObjPtr = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;GlobalObjectBase&gt;; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ObjPtr&gt; m_dynamic_globals; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-function">GlobalObjectBase* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">unique_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;GlobalObjectBase&gt; ip_object)</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: GlobalObjectsStorage() {} <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AddGlobalObjectImpl(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;ObjectType&gt;()); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-function">ObjectType* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;ObjectType*&gt;(GetGlobalObjectImpl(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(ObjectType).hash_code()); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> RemoveGlobalObject() { RemoveGlobalObjectImpl(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(ObjectType).hash_code()); } };</code> </pre> </div></div><br>  To work with this kind of objects, their type is sufficient, so the <code>GlobalObjectsStorage</code> interface <code>GlobalObjectsStorage</code> methods that transfer the necessary implementation data. <br><br>  So, the first test drive works! <br><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooManager</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GlobalObjectBase { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GlobalObjectsStorage g_storage; <span class="hljs-comment"><span class="hljs-comment">//    void Test() { //   "" g_storage.AddGlobalObject&lt;FooManager&gt;(); //  g_storage.GetGlobalObject&lt;FooManager&gt;()-&gt;Initialize(); //   g_storage.RemoveGlobalObject&lt;FooManager&gt;(); }</span></span></code> </pre> <br>  But that's not all - you cannot substitute objects for different contexts.  We correct by adding a parent class for the repository, transferring the template methods there, and making the virtual implementation methods. <br><br><div class="spoiler">  <b class="spoiler_title">Base storage class</b> <div class="spoiler_text"><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseObject&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectStorageBase</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> BaseObject* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">unique_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;BaseObject&gt; ip_object)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~ObjectStorageBase() {} <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AddGlobalObjectImpl(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;ObjectType&gt;()); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-function">ObjectType* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;ObjectType*&gt;(GetGlobalObjectImpl(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(ObjectType).hash_code())); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RemoveGlobalObjectImpl(<span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(ObjectType).hash_code()); } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;BaseObject*&gt; GetStoredObjects() = <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameGlobalObject</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GlobalObjectBase { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~GameGlobalObject() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dt)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultObjectsStorage</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectStorageBase&lt;GameGlobalObject&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ObjPtr = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;GameGlobalObject&gt;; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ObjPtr&gt; m_dynamic_globals; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> GameGlobalObject* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">unique_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;GameGlobalObject&gt; ip_object)</span></span></span><span class="hljs-function"> override </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveGlobalObjectImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i_type_code)</span></span></span><span class="hljs-function"> override </span></span>{ ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: DefaultObjectsStorage() {} <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;GameGlobalObject*&gt; GetStoredObjects() override { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_cache_objects; } }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;ObjectStorageBase&lt;GameGlobalObject&gt;&gt; gp_storage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultObjectsStorage()); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   "" gp_storage-&gt;AddGlobalObject&lt;ResourceManager&gt;(); //  gp_storage-&gt;GetGlobalObject&lt;ResourceManager&gt;()-&gt;Initialize(); //   gp_storage-&gt;RemoveGlobalObject&lt;ResourceManager&gt;(); }</span></span></code> </pre> </div></div><br>  Often, global objects need different manipulations during creation or deletion.  In our projects, this reads data from the disk (for example, the settings file for the subsystem), updates the player data that occurs when the application is loaded and after a certain time interval during the game, and updating the in-game cycle.  Other programs may have additional or completely different actions.  Therefore, the final base type will be determined by the class user and will allow to avoid multiple invocation of the same methods. <br><br><pre> <code class="hljs lisp">for (<span class="hljs-name"><span class="hljs-name">auto</span></span> p_object : g_storage-&gt;GetStoredObjects()) p_object-&gt;Init()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><h2>  Is everything good in the end? </h2><br>  It is clear that the performance of such a wrapper will be worse than using a global object directly.  For the test, ten different types were created.  First, they were used as a global object without our changes, then through <code>DefaultObjectsStorage</code> .  Result for <i>1,000,000</i> calls. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f4/ef9/de1/1f4ef9de180dd32ac43e6440757f1540.png"></div><br>  The current code runs almost 18 times slower than a regular global object!  Profiler suggests that <code>typeid(*obj).hash_code()</code> takes the most time.  Since the extraction of data about the types during execution spends a lot of CPU time, you need to get around it.  The easiest way to do this is to store a type hash in the base global object class ( <code>GlobalObjectBase</code> ). <br><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalObjectBase</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_hash_code; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ... <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> GetTypeHashCode() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_hash_code; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RecalcHashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_hash_code = <span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).hash_code(); } };</code> </pre> <br>  It is also worth changing the <code>ObjectStorageBase::AddGlobalObject  DefaultObjectsStorage:: GetGlobalObjectImpl</code> .  Additionally, we statically store type data in the template function of the parent class <code>ObjectStorageBase::GetGlobalObject</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Storage Optimization</b> <div class="spoiler_text"><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseObject&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectStorageBase</span></span></span><span class="hljs-class"> {</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> p_object = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;ObjectType&gt;(); p_object-&gt;RecalcHashCode(); AddGlobalObjectImpl(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(p_object)); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ObjectType&gt; <span class="hljs-function"><span class="hljs-function">ObjectType* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGlobalObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> type_hash = <span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(ObjectType).hash_code()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;ObjectType*&gt;(GetGlobalObjectImpl(type_hash); } ‚Ä¶ }; class DefaultObjectsStorage : <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectStorageBase&lt;GameGlobalObject&gt; { ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> GlobalObjectBase* GetGlobalObjectImpl(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i_type_code) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> override { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> it = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::find_if(m_dynamic_globals.begin(), m_dynamic_globals.end(), [i_type_code](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjPtr&amp; obj) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj-&gt;GetTypeHashCode() == i_type_code; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it == m_dynamic_globals.end()) { <span class="hljs-comment"><span class="hljs-comment">//      ,  -    return nullptr; } return it-&gt;get(); } ‚Ä¶ };</span></span></code> </pre> </div></div><br>  The above changes can significantly reduce the search time of the desired object, and the difference will no longer be 18 times, and 1.25 - this is quite acceptable in most cases. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fc7/120/48d/fc712048db3281e1b4be58d97db283cb.png"></div><br>  In addition, in order not to change the whole repository for tests, you can override the <code>GlobalObjectBase::RecalcHashCode</code> and selectively replace only the necessary objects.  To replace the main class, it is necessary to make the methods necessary for the test and the test class inheritor virtual. <br><br><div class="spoiler">  <b class="spoiler_title">Replacement example</b> <div class="spoiler_text"><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GlobalObjectBase { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ x = rand()%<span class="hljs-number"><span class="hljs-number">1</span></span>; } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooTest</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Foo { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ x = <span class="hljs-number"><span class="hljs-number">5</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RecalcHashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ m_hash_code = <span class="hljs-keyword"><span class="hljs-keyword">typeid</span></span>(First).hash_code(); } }; g_getter.AddGlobalObject&lt;FooTest&gt;(); g_getter.GetGlobalObject&lt;Foo&gt;()-&gt;SetX();</code> </pre> </div></div><br>  <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.playrix.fishdomdd.gplay">Fishdom</a> was a pioneer in introducing this approach, where several objects were used through this wrapper.  This made it possible to remove dependencies, cover part of the code with tests, and make more convenient the monotonous work of calling methods (Init, Release, Update) in the right places. <br><br>  Under the <a href="https://github.com/Playrix/playrix-public/tree/master/GlobalObjects">link</a> you can find the final shell code and the tests described. </div><p>Source: <a href="https://habr.com/ru/post/316416/">https://habr.com/ru/post/316416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316404/index.html">How to write notes if you are a programmer</a></li>
<li><a href="../316406/index.html">"Great leveler" or a way to solve the problem of leveling</a></li>
<li><a href="../316408/index.html">As I recalled the school geometry course</a></li>
<li><a href="../316412/index.html">Remote backup of VMware cloud resources via self-service portal</a></li>
<li><a href="../316414/index.html">Grep all you can</a></li>
<li><a href="../316418/index.html">We search and analyze errors in the Orchard CMS code.</a></li>
<li><a href="../316420/index.html">CTFzone write-ups - Shall I reverse it?</a></li>
<li><a href="../316422/index.html">8 tools for creating personal or business chat bot</a></li>
<li><a href="../316426/index.html">Quick Guide how to become a Google Certified Associate Android Developer</a></li>
<li><a href="../316428/index.html">Demo database for PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>