<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New life for XMPP. Making an instant messenger that fails to block</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea to make an instant messenger independent of P2P corporations is not new, but the development of a new protocol and client applications for it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New life for XMPP. Making an instant messenger that fails to block</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/_6/r8/3z/_6r83zc147s5n5_ckq5vdmakl24.jpeg"></p><br><p>  The idea to make an instant messenger independent of P2P corporations is not new, but the development of a new protocol and client applications for it is quite an expensive and long process.  And what if you use the good old <a href="https://en.wikipedia.org/wiki/XMPP">XMPP</a> , in which everything has been thought out and filed long ago? </p><br><p>  But this is not a real peer-to-peer, you say, for XMPP to work, you need your own server and domain.  This is true, but we can start the server on a local host, and use a hidden service in <a href="https://en.wikipedia.org/wiki/I2P">the I2P virtual network</a> to communicate with the servers of other users.  Using I2P will save us from having to pay for a domain with hosting, as well as protect our communications from <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BA%25D0%25BE%25D0%25BD_%25D0%25AF%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B9">criminal online surveillance</a> . </p><br><p>  Thus, we get: </p><br><ul><li>  Hybrid P2P messenger, which can be run on user devices, and on a full server. </li><li>  Features that other P2P messengers lack: offline messages, contact storage and history in the cloud, work of several clients with one account. </li><li>  Ready client applications for every taste. </li><li>  Due to the use of I2P, invulnerable for various * supervision (litter for mat). </li></ul><br><p>  Let's start the implementation ... </p><a name="habracut"></a><br><h1 id="ustanovka-i2p-i-sozdanie-servernogo-tonnelya">  Installing I2P and creating a server tunnel </h1><br><p>  In this guide, we will use the lightweight C ++ client <a href="https://github.com/PurpleI2P/i2pd">i2pd</a> as an I2P router.  Installation instructions are in the <a href="https://i2pd.readthedocs.io/en/latest/user-guide/install/">documentation</a> . </p><br><p>  After installation, we create a server I2P tunnel - this is the virtual address where our XMPP server will be available for the rest of the world.  In the <a href="https://i2pd.readthedocs.io/en/latest/user-guide/tunnels/">tunnels.conf</a> file <a href="https://i2pd.readthedocs.io/en/latest/user-guide/tunnels/">we</a> add the following lines: </p><br><pre><code class="hljs pgsql">[prosody-s2s] <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> host=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port=<span class="hljs-number"><span class="hljs-number">5269</span></span> inport=<span class="hljs-number"><span class="hljs-number">5269</span></span> keys=prosody.dat [prosody-c2s] <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> host=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port=<span class="hljs-number"><span class="hljs-number">5222</span></span> inport=<span class="hljs-number"><span class="hljs-number">5222</span></span> keys=prosody.dat</code> </pre> <br><p>  If you plan to use only on localhost, the prosody-c2s section can be not added.  Restart i2pd to apply the settings.  We are looking for the I2P address of the created tunnel in the web console <a href="http://127.0.0.1:7070/">http://127.0.0.1:7070/</a> on the <code>I2P tunnels</code> page. </p><br><p><img src="https://habrastorage.org/webt/9w/cs/ct/9wcsctrhsufhijv8vcs0ch7e0x0.png"></p><br><p>  You can also find out the b32 address of the new tunnel by logging: </p><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> <span class="hljs-string"><span class="hljs-string">"New private keys file"</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/i2pd/i2pd.log | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -Eo <span class="hljs-string"><span class="hljs-string">"([a-z0-9]+).b32.i2p"</span></span> | tail -n1</code> </pre> <br><p>  Save this xxx.b32.i2p address, this will be the domain for your XMPP server. </p><br><h1 id="ustanovka-i-nastroyka-xmpp-servera">  Install and configure the XMPP server </h1><br><p>  We will use <a href="https://prosody.im/">prosody</a> as the XMPP server, it is the easiest and under it there is a ready-made module for working via I2P.  The installation is described in the official <a href="https://prosody.im/download/start">documentation</a> , in Ubuntu <code>apt install prosody</code> is done elementary. </p><br><p>  For <code>mod_darknet</code> to work, <code>mod_darknet</code> need the <code>mod_darknet</code> lua library.  If you have a lua version less than 5.2 (most likely), do <code>apt install lua-bit32</code> . </p><br><p>  Install the <code>mod_darknet</code> module.  It is needed for prosody to make outgoing connections via Socks5 i2pd server.  Download <a href="">this file</a> to the prosody modules directory, usually <code>/usr/lib/prosody/modules</code> . </p><br><p>  Now we edit the config /etc/prosody/prosody.cfg.lua.  Replace <code>xxx.b32.i2p</code> with your address: </p><br><pre> <code class="hljs vbscript">interfaces = { <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span> }; admins = { <span class="hljs-string"><span class="hljs-string">"admin@xxx.b32.i2p"</span></span> }; modules_enabled = { <span class="hljs-string"><span class="hljs-string">"roster"</span></span>; <span class="hljs-string"><span class="hljs-string">"saslauth"</span></span>; <span class="hljs-string"><span class="hljs-string">"tls"</span></span>; <span class="hljs-string"><span class="hljs-string">"dialback"</span></span>; <span class="hljs-string"><span class="hljs-string">"disco"</span></span>; <span class="hljs-string"><span class="hljs-string">"posix"</span></span>; <span class="hljs-string"><span class="hljs-string">"private"</span></span>; <span class="hljs-string"><span class="hljs-string">"vcard"</span></span>; <span class="hljs-string"><span class="hljs-string">"ping"</span></span>; <span class="hljs-string"><span class="hljs-string">"register"</span></span>; <span class="hljs-string"><span class="hljs-string">"admin_adhoc"</span></span>; <span class="hljs-string"><span class="hljs-string">"darknet"</span></span>; }; modules_disabled = {}; allow_registration = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; darknet_only = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; c2s_require_encryption = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; s2s_secure_auth = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; authentication = <span class="hljs-string"><span class="hljs-string">"internal_plain"</span></span>; -- <span class="hljs-keyword"><span class="hljs-keyword">On</span></span> Debian/Ubuntu daemonize = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; pidfile = <span class="hljs-string"><span class="hljs-string">"/var/run/prosody/prosody.pid"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> = <span class="hljs-string"><span class="hljs-string">"/var/log/prosody/prosody.err"</span></span>; <span class="hljs-string"><span class="hljs-string">"*syslog"</span></span>; } certificates = <span class="hljs-string"><span class="hljs-string">"certs"</span></span>; VirtualHost <span class="hljs-string"><span class="hljs-string">"xxx.b32.i2p"</span></span>; ssl = { key = <span class="hljs-string"><span class="hljs-string">"/etc/prosody/certs/xxx.b32.i2p.key"</span></span>; certificate = <span class="hljs-string"><span class="hljs-string">"/etc/prosody/certs/xxx.b32.i2p.crt"</span></span>; }</code> </pre> <br><p>  The last step in setting up prosody is the generation of encryption certificates.  In Nix, this is done like this: </p><br><pre> <code class="hljs cs">openssl genrsa -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /etc/prosody/certs/xxx.b32.i2p.key <span class="hljs-number"><span class="hljs-number">2048</span></span> openssl req -<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> -x509 -key /etc/prosody/certs/xxx.b32.i2p.key -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /etc/prosody/certs/xxx.b32.i2p.crt -days <span class="hljs-number"><span class="hljs-number">3650</span></span> chown root:prosody /etc/prosody/certs<span class="hljs-comment"><span class="hljs-comment">/*.b32.i2p.{key,crt} chmod 640 /etc/prosody/certs/*.b32.i2p.{key,crt}</span></span></code> </pre> <br><p>  Restart the prosody server to apply the settings. </p><br><p>  Here you need a small digression.  In an I2P network, any connections are encrypted with end-to-end encryption and, it would seem, additional encryption is unnecessary here.  But, in practice, it turned out to be easier to generate keys than to try to configure all the programs to use plain text.  You can try, but I warned you. </p><br><h1 id="sozdanie-akkauntov-i-podklyuchenie-klientov">  Creating accounts and connecting customers </h1><br><p>  Add admin account: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">prosodyctl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adduser</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">admin</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">xxx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">b32</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">i2p</span></span></code> </pre> <br><p>  Now we are setting up an XMPP client (for example, <a href="https://pidgin.im/">Pidgin</a> ). </p><br><p><img src="https://habrastorage.org/webt/9q/rs/pn/9qrspnexmf7c76xxudtbyq5gywy.png"></p><br><p>  If you are connecting to a local host, then in the client settings we specify the connection to the server 127.0.0.1 port 5222. </p><br><p><img src="https://habrastorage.org/webt/ch/aq/yu/chaqyudpt9_klboqzh8js266qvq.png"></p><br><p>  If you connect to the server remotely via I2P, then specify in the proxy settings Socks5 127.0.0.1:4447. </p><br><p><img src="https://habrastorage.org/webt/th/o1/mi/tho1mild7peimdh1hznm9botvzs.png"></p><br><p>  If everything is done correctly, you can add other users to I2P federation and correspond with them.  It is also possible to set up your already working server on the regular Internet for correspondence with servers inside I2P.  To do this, all other users will have to add prosody mapping for your domain to their config.  For example, this is how I did it to communicate with the <code>i2p.rocks</code> server: </p><br><pre> <code class="hljs objectivec">darknet_map = { [<span class="hljs-string"><span class="hljs-string">"i2p.rocks"</span></span>] = <span class="hljs-string"><span class="hljs-string">"ynkz7ebfkllljitiodcq52pa7fgqziomz4wa7tv4qiqldghpx4uq.b32.i2p"</span></span>; [<span class="hljs-string"><span class="hljs-string">"muc.i2p.rocks"</span></span>] = <span class="hljs-string"><span class="hljs-string">"ynkz7ebfkllljitiodcq52pa7fgqziomz4wa7tv4qiqldghpx4uq.b32.i2p"</span></span>; }</code> </pre> <br><p>  That's all.  Happy chatting! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351936/">https://habr.com/ru/post/351936/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351924/index.html">What do we know about the terrain loss of machine learning?</a></li>
<li><a href="../351926/index.html">Welcome to Front-end MeetUp in Raiffeisenbank. UPD: Broadcast Mitap</a></li>
<li><a href="../351928/index.html">Conference DEFCON 22. "Mass scanning of the Internet through open ports." Robert Graham, Paul McMillan, Dan Tantler</a></li>
<li><a href="../351930/index.html">How to stay in the TOP when changing search algorithms (a guide for novice SEOs)</a></li>
<li><a href="../351932/index.html">Installing Debian with a root on an encrypted ZFS mirror</a></li>
<li><a href="../351938/index.html">Video Streaming with Azure and .NET</a></li>
<li><a href="../351940/index.html">Marvin Minsky "The Emotion Machine": Chapter 2 "Conscience, Values ‚Äã‚Äãand Own Ideals"</a></li>
<li><a href="../351942/index.html">Why putting the most selective columns in the composite index prefix is ‚Äã‚Äãnot always good</a></li>
<li><a href="../351944/index.html">Creating a chatbot using Q & A Maker and Microsoft Graph</a></li>
<li><a href="../351946/index.html">Arduino controller with temperature sensor and Python interface for dynamic identification of control objects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>