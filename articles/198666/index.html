<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IndexedDB - unlimited data storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear community. 
 For those who do not know what IndexedDB is and what it is eaten with, you can read here . 

 And we go further. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IndexedDB - unlimited data storage</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear community. <br>  For those who do not know what IndexedDB is and what it is eaten with, you can read <a href="http://habrahabr.ru/post/117473/">here</a> . <br><br>  And we go further. <br><br><h2>  Unlimited </h2><br>  In the office in which I work, it became necessary to use an indexed local database on the client side and the choice immediately fell on IndexedDB. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But as always there is one ‚ÄúBUT‚Äù, this is the ‚ÄúBUT‚Äù - the limitation of the size of the database on the user's machine in the amount of 5 MB, which did not suit us at all.  Since this technology was planned to be used in the admin panel of our project and all users used Google Chrome as the default browser, it was decided to search for a circumvention of the restriction through the proxy extension.  Shooting a lot of information, we concluded that the limit on the size of the database can be removed using special flags in the manifest of our extension: <br><a name="habracut"></a><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"unlimitedStorage"</span></span>, <span class="hljs-string"><span class="hljs-string">"unlimited_storage"</span></span> ],</code> </pre> <br><habracut><br><br><h2>  Posting site extension site </h2><br>  We go further.  We dealt with unlimited data storage, but now it became necessary to work with that unlimited database directly from the site itself.  For this purpose, sending messages between the site and the extension was used (the extension acted as a proxy, between the site and the unlimited database).  To this end, the following flags were added to the manifest of our extension: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"externally_connectable"</span></span>: { <span class="hljs-string"><span class="hljs-string">"matches"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"*://localhost/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"____URL "</span></span> ] }</code> </pre><br><br>  It turned out that the following URLs are considered valid: *: //google.com/* and http: //*.chromium.org/*, and, http: // * / *, *: / / *.  Com / are not. <br>  More information about externally_connectable can be found <a href="http://developer.chrome.com/extensions/manifest/externally_connectable.html">here</a> . <br><br>  We go further. <br><br>  The stage of writing the very ‚Äúbridge‚Äù between the site and the extension to access the database has begun. <br>  The main library for working with IndexedDB on the extension side was db.js, which you can find <a href="http://aaronpowell.github.io/db.js/">here</a> . <br><br>  In order not to reinvent the wheel, it was decided to use the access syntax on the site side, which is implemented in db.js. <br><br><h3>  Expansion </h3><br>  And so we went, we create background.js, which we will listen to incoming messages, and respond to them.  The code listing is below: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server; chrome.runtime.onMessageExternal.addListener( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, sender, sendResponse</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = request.cmd, params = request.params; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"getUsageAndQuota"</span></span>: navigator.webkitPersistentStorage.queryUsageAndQuota(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">u,q</span></span></span><span class="hljs-function">)</span></span>{ sendResponse({<span class="hljs-string"><span class="hljs-string">"usage"</span></span>: u,<span class="hljs-string"><span class="hljs-string">"quota"</span></span>:q}); }); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"open"</span></span>: db.open(params).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s</span></span></span><span class="hljs-function">) </span></span>{ server = s; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exclude = <span class="hljs-string"><span class="hljs-string">"add close get query remove update"</span></span>.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tables = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> table <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> server){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(exclude.indexOf(table)==<span class="hljs-number"><span class="hljs-number">-1</span></span>){ tables.push(table); } } sendResponse(tables); }); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"close"</span></span>: server.close(); sendResponse({}); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"get"</span></span>: server[request.table].get(params).done(sendResponse) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"add"</span></span>: server[request.table].add(params).done(sendResponse); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"update"</span></span>: server[request.table].update(params).done(sendResponse); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"remove"</span></span>: server[request.table].remove(params).done(sendResponse); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"execute"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp_server = server[request.table]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = tmp_server.query.apply(tmp_server, obj2arr(request.query)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; request.filters.length; i++) { flt = request.filters[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flt.type == <span class="hljs-string"><span class="hljs-string">"filter"</span></span>) { flt.args = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>(<span class="hljs-string"><span class="hljs-string">"item"</span></span>, flt.args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } query = query[flt.type].apply(query, obj2arr(flt.args)); } query.execute().done(sendResponse); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error.name != <span class="hljs-string"><span class="hljs-string">"TypeError"</span></span>) { sendResponse({<span class="hljs-attr"><span class="hljs-attr">RUNTIME_ERROR</span></span>: error}); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; });</code> </pre><br><br>  But here we were in for a surprise, namely, on the execution of the code segment: <br><br><pre> <code class="javascript hljs">flt.args = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Function</span></span>(<span class="hljs-string"><span class="hljs-string">"item"</span></span>, flt.args[<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre> <br><br>  we get an exception: <br><br> <code>Refused to evaluate a string as JavaScript because 'unsafe-eval' is not an allowed source of script in the following Content Security Policy directive: "script-src 'self' chrome-extension-resource:".</code>  . <br><br>  To resolve this problem, add another line to the manifest, which allows user js to run on the extension side. <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"content_security_policy"</span></span>: <span class="hljs-string"><span class="hljs-string">"script-src 'self' 'unsafe-eval'; object-src 'self'"</span></span></code> </pre> <br><br>  We also had to implement the auxiliary function of driving an object to an array, in order to pass it as function arguments. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj2arr = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> obj == <span class="hljs-string"><span class="hljs-string">'object'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp_args = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> obj) { tmp_args.push(obj[k]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp_args; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [obj]; } }</code> </pre><br><br>  Full listing manifest.json <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"manifest_version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"exDB"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"This extension give proxy access to indexdb from page."</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"background"</span></span>: { <span class="hljs-string"><span class="hljs-string">"page"</span></span>: <span class="hljs-string"><span class="hljs-string">"background.html"</span></span> }, <span class="hljs-string"><span class="hljs-string">"content_security_policy"</span></span>: <span class="hljs-string"><span class="hljs-string">"script-src 'self' 'unsafe-eval'; object-src 'self'"</span></span>, <span class="hljs-string"><span class="hljs-string">"externally_connectable"</span></span>: { <span class="hljs-string"><span class="hljs-string">"matches"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"*://localhost/*"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"unlimitedStorage"</span></span>, <span class="hljs-string"><span class="hljs-string">"unlimited_storage"</span></span> ], <span class="hljs-string"><span class="hljs-string">"icons"</span></span>: { <span class="hljs-string"><span class="hljs-string">"16"</span></span>: <span class="hljs-string"><span class="hljs-string">"icons/icon_016.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"48"</span></span>: <span class="hljs-string"><span class="hljs-string">"icons/icon_048.png"</span></span> } }</code> </pre><br><br><h3>  Customer </h3><br>  With the extension figured out, now let's start writing a client library to work with our proxy extension. <br>  The first thing you need to do when sending a message from a client is to indicate to which extension we want to send it; for this, we specify its id: <br><br><pre> <code class="javascript hljs">chrome.runtime.sendMessage(<span class="hljs-string"><span class="hljs-string">"ID_"</span></span>, data, callback);</code> </pre> <br><br>  Full listing of the client library: <br><br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">window, undefined</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-string"><span class="hljs-string">"use strict"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exDB</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.extensionId = <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] || <span class="hljs-string"><span class="hljs-string">"eojllnbjkomphhmpcpafaipblnembfem"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.filterList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._table; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._query; self.sendMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, callback</span></span></span><span class="hljs-function">) </span></span>{ chrome.runtime.sendMessage(self.extensionId, data, callback); }; self.open = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">params, callback</span></span></span><span class="hljs-function">) </span></span>{ self.sendMessage({<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>: <span class="hljs-string"><span class="hljs-string">"open"</span></span>, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: params}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tn; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt; r.length;i++) tn = r[i]; self.__defineGetter__(tn,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ self._table = tn; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }); callback(); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }; self.close = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ self.sendMessage({<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>: <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: {}}, callback); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } self.table = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ self._table = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }; self.query = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self._query = <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; }; self.execute = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ self.sendMessage({<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>: <span class="hljs-string"><span class="hljs-string">"execute"</span></span>, <span class="hljs-string"><span class="hljs-string">"table"</span></span>: self._table, <span class="hljs-string"><span class="hljs-string">"query"</span></span>: self._query, <span class="hljs-string"><span class="hljs-string">"filters"</span></span>: self.filterList}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &amp;&amp; result.RUNTIME_ERROR) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(result.RUNTIME_ERROR.message); result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } callback(result); }); self._query = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; self.filterList = []; }; self.getUsageAndQuota = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">)</span></span>{ self.sendMessage({<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>: <span class="hljs-string"><span class="hljs-string">"getUsageAndQuota"</span></span>},callback); }; <span class="hljs-string"><span class="hljs-string">"add update remove get"</span></span>.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>).forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ self[fn] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item, callback</span></span></span><span class="hljs-function">) </span></span>{ self.sendMessage({<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>: fn, <span class="hljs-string"><span class="hljs-string">"table"</span></span>: self._table, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: item}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &amp;&amp; result.RUNTIME_ERROR) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(result.RUNTIME_ERROR.message); result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } callback(result); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } }); <span class="hljs-string"><span class="hljs-string">"all only lowerBound upperBound bound filter desc distinct keys count"</span></span>.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>).forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ self[fn] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self.filterList.push({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: fn, <span class="hljs-attr"><span class="hljs-attr">args</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } }); } <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.exDB = exDB; })(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>, <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>);</code> </pre><br><br>  At this stage, our complex for working with unlimited indexDB is ready.  Below are examples of use. <br><br><h5>  Connection </h5><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> exDB(); db.open({ <span class="hljs-attr"><span class="hljs-attr">server</span></span>: <span class="hljs-string"><span class="hljs-string">'my-app'</span></span>, <span class="hljs-attr"><span class="hljs-attr">version</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">schema</span></span>: { <span class="hljs-attr"><span class="hljs-attr">people</span></span>: { <span class="hljs-attr"><span class="hljs-attr">key</span></span>: { <span class="hljs-attr"><span class="hljs-attr">keyPath</span></span>: <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-attr"><span class="hljs-attr">autoIncrement</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-comment"><span class="hljs-comment">// Optionally add indexes indexes: { firstName: { }, answer: { unique: true } } } } }, function () {});</span></span></code> </pre><br><h5>  Connection closure </h5><br><pre> <code class="javascript hljs">db.close();</code> </pre><br><h5>  Adding record </h5><br><pre> <code class="javascript hljs">db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).add({ <span class="hljs-attr"><span class="hljs-attr">firstName</span></span>: <span class="hljs-string"><span class="hljs-string">'Aaron'</span></span>, <span class="hljs-attr"><span class="hljs-attr">lastName</span></span>: <span class="hljs-string"><span class="hljs-string">'Powell'</span></span>, <span class="hljs-attr"><span class="hljs-attr">answer</span></span>: <span class="hljs-number"><span class="hljs-number">142</span></span>},<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ });</code> </pre> <br><br><h5>  Record Update </h5><br><pre> <code class="javascript hljs"> db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).update({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">firstName</span></span>: <span class="hljs-string"><span class="hljs-string">'Aaron'</span></span>, <span class="hljs-attr"><span class="hljs-attr">lastName</span></span>: <span class="hljs-string"><span class="hljs-string">'Powell'</span></span>, <span class="hljs-attr"><span class="hljs-attr">answer</span></span>: <span class="hljs-number"><span class="hljs-number">1242</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) </span></span>{});</code> </pre> <br><br><h5>  Deleting records by ID </h5><br><pre> <code class="javascript hljs">db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).remove(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">)</span></span>{});</code> </pre> <br><br><h5>  Getting record by ID </h5><br><pre> <code class="javascript hljs">db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).get(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(r); });</code> </pre><br><br><h5>  Sampling / Sorting </h5><br><pre> <code class="javascript hljs">db.people.query(<span class="hljs-string"><span class="hljs-string">"firstName"</span></span>).only(<span class="hljs-string"><span class="hljs-string">"Aaron2"</span></span>).execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"GETTER"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).all().desc().execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"all"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).only(<span class="hljs-number"><span class="hljs-number">12642</span></span>).count().execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"only"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).bound(<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-number"><span class="hljs-number">45</span></span>).execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"bound"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).lowerBound(<span class="hljs-number"><span class="hljs-number">50</span></span>).keys().execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"lowerBound"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).upperBound(<span class="hljs-number"><span class="hljs-number">43</span></span>).execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"upperBound"</span></span>,r); }); db.table(<span class="hljs-string"><span class="hljs-string">"people"</span></span>).query(<span class="hljs-string"><span class="hljs-string">"answer"</span></span>).filter(<span class="hljs-string"><span class="hljs-string">"return item.answer==42 &amp;&amp; item.firstName=='Aaron'"</span></span>).execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"filter"</span></span>,r); });</code> </pre><br><h5>  Obtaining database size (used / maximum size) </h5><br><pre> <code class="javascript hljs">db.getUsageAndQuota(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"used"</span></span>, r.usage); <span class="hljs-comment"><span class="hljs-comment">//bytes console.log("quota", r.quota); //bytes });</span></span></code> </pre><br><br><h2>  Conclusion </h2><br>  At the moment, this decision is actively used on one of our projects, I will be grateful for constructive criticism and suggestions.  Since this is my first article on Habr√©, please do not judge much. <br><br>  You can familiarize with source codes on <a href="https://github.com/andrusender/idb.proxy">github</a> . </habracut></div><p>Source: <a href="https://habr.com/ru/post/198666/">https://habr.com/ru/post/198666/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198648/index.html">Orthodox Twitter from schoolchildren from the Samara region</a></li>
<li><a href="../198656/index.html">FRP (functional reactive programming) on ‚Äã‚ÄãBacon.js</a></li>
<li><a href="../198660/index.html">3G Internet at a distance from the base station using a dish and a coffee can</a></li>
<li><a href="../198662/index.html">Preparing Servers with Chef Solo</a></li>
<li><a href="../198664/index.html">Squeak: Simulation of Queuing Systems</a></li>
<li><a href="../198668/index.html">QIWI and the new REST protocol in the examples</a></li>
<li><a href="../198672/index.html">How to start making the engine control unit from scratch</a></li>
<li><a href="../198674/index.html">Budget TimeLapse Slider do it yourself</a></li>
<li><a href="../198680/index.html">Pavel Durov's speech at the GMIC conference in San Francisco - the first public appearance of the VK founder and Telegram in Silicon Valley</a></li>
<li><a href="../198682/index.html">Aho-Korasik Algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>