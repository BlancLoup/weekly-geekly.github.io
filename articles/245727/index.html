<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Concurrency structure in .net. ConcurrentDictionary from the inside</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with a single interview, which prompted me to write this article. Quite a large number of developers on the .Net platform do not unders...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Concurrency structure in .net. ConcurrentDictionary from the inside</h1><div class="post__text post__text-html js-mediator-article">  It all started with a single interview, which prompted me to write this article.  Quite a large number of developers on the .Net platform do not understand basic things, although they use them on a daily basis, for example, they lock all methods using ConcurrentDictionary with a lock, although it would be possible to do with an ordinary Dictionary &lt;&gt;. <br><br>  In science, there are 3 main ways to implement competitive data structures: <br>  ‚Ä¢ Lock-free data structures; <br>  ‚Ä¢ Fine-grained lock; <br>  ‚Ä¢ Transactional memory implementation (transactional memory); <br><br>  ConcurrentDictionary &lt;TKey, TValue&gt; is a thread-safe analogue of Dictionary &lt;TKey, TValue&gt;.  It is based on the so-called Fine-grained lock. <br><a name="habracut"></a><br><h4>  general information </h4><br>  There are 2 main parameters for setting: <br>  ‚Ä¢ <b>capacity</b> - the initial number of elements.  The default is 31. <br>  ‚Ä¢ <b>concurrencyLevel</b> - estimated number of streams per write.  Default is set to = 4 * number of processors 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I propose to consider these parameters in more detail in order to understand their true essence. <br><br><h5>  Capacity </h5><br>  This parameter is similar to that used in the usual ‚Äúdictionary‚Äù Dictionary &lt;TKey, TValue&gt; is the initial size of the array for storing elements. <br>  If we look at the sources, we will see the line: <br><pre><code class="hljs xml">ConcurrentDictionary<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TKey,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TValue</span></span></span><span class="hljs-tag">&gt;</span></span>.Node[] buckets = new ConcurrentDictionary<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TKey,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TValue</span></span></span><span class="hljs-tag">&gt;</span></span>.Node[capacity];</code> </pre> <br>  As you know, Dictionary is a classic hash table, so a hash value is used to store elements, which in .Net is calculated using the GetHashCode () function and is of type int.  The values ‚Äã‚Äãof the hashes are exactly in the buckets above, the desired bucket is calculated: <br><pre> <code class="hljs objectivec">bucketNo = (hashcode &amp; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue) % bucketCount;</code> </pre><br>  From here it turns out the access speed - O (1). <br>  In case of overflow, the array with the buckets is increased (newLength = oldLength * 2 + 1) and all elements are redistributed. <br><br><h5>  ConcurrencyLevel </h5><br>  Estimated number of threads per write.  From the definition, the question immediately arises - why should a ‚Äúdictionary‚Äù know about the number of threads.  In fact, everything is simple.  This is nothing but the number of independent locks (pool of locks), i.e.  This is the maximum number of threads that can "write" to the "dictionary" at the same time.  In fact, each lock is ‚Äúgiven‚Äù about the same set of buckets, in which it ensures the synchronization of the write streams. <br><br><h4>  ConcurrentDictionary operations. </h4><br>  The main operations on the dictionary can be divided into 3 groups: <br><ul><li>  completely unlockable; </li><li>  blocking one item from the lock pool; </li><li>  lock the entire dictionary; </li></ul><br><br>  <i>The fully non-blocking operations include:</i> <br><ul><li>  ContainsKey </li><li>  TryGet </li><li>  this [] </li><li>  GetEnumerator - operation does not ensure data integrity (does not use snapshots), i.e.  data during the operation of the function may change. </li></ul><br>  All read operations (Get / ContainsKey) have approximately the same operation algorithm: <br><ul><li>  calculation of a key hash with GetHashCode () </li><li>  calculation of the bucket in which our element lies </li><li>  comparing the value of the key in the bucket with the one we have </li><li>  reading the value using Volatile.Read </li></ul><br><br>  <i>The operations with blocking of one element from the pool of locks include:</i> <br><ul><li>  TryAdd </li><li>  TryUpdate </li><li>  TryRemove </li></ul><br>  Below is an approximate algorithm of work: <br><ol><li>  Calculate the hash key of the new item </li><li>  Calculate the bucketNo bucket to which the item will be added, and the block numbers from the pool <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">bucketNo</span></span> = (hashcode &amp; int.MaxValue) % bucketCount; <span class="hljs-attribute"><span class="hljs-attribute">lockNo</span></span> = bucketNo % lockCount;</code> </pre><br></li><li>  Lock bucketNo via Monitor.Enter </li><li>  Write an element using Volatile.Write </li><li>  Release Lock Monitor.Exit </li></ol><br><br>  <i>The most inefficient operations that block the entire dictionary include:</i> <br><ul><li>  Count, IsEmpty.  Yes, these operations require complete dictionary locking.  If you need to save the number of elements in the log file, you can use GetEnumerator and LINQ. </li><li>  Keys, Values ‚Äã‚Äã- getting a list of keys and a list of values, respectively.  By the way, here you get complete data - snapshots. </li><li>  CopyTo - explicit ICollection </li><li>  Clear, ToArray </li></ul><br><br><h5>  Methods AddOrUpdate, GetOrAdd </h5><br>  These methods are quite interesting in that they use atomic Add / Get / Update operations, but they themselves are not atomic, they do not use a lock on the entire operation.  Here is the implementation of AddOrUpdate: <br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!TryGetValue(key, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> comparisonValue)) { TValue obj = addValueFactory(key); TValue resultingValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TryAddInternal(key, obj, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> resultingValue)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resultingValue; } newValue = updateValueFactory(key, comparisonValue); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!TryUpdate(key, newValue, comparisonValue)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue;</code> </pre><br><br>  MSDN: <br><blockquote>  Also, though not all methods are thread-safe, not all methods are specifically GetOrAdd and AddOrUpdate.  The user has a lock.  (This is done to prevent all threads from blocking all threads.) <br></blockquote><br>  Usage example: <br><pre> <code class="hljs coffeescript"> items.AddOrUpdate(srcKey, srcValue, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key, existingVal)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcValue != existingVal) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"..."</span></span>);</code> </pre><br><br><h5>  In the end, I want to note the complexity of the methods: </h5><br><ol><li>  TryAdd, TryUpdate, TryRemove, - O (1) </li><li>  Get / Contains, Item [] by key - O (1) </li><li>  ContainsValue, ToArray (), Keys, Values ‚Äã‚Äã- O (n) </li></ol><br><br>  Ps In this article I wanted to draw attention to the subtleties of using ConcurrentDictionary and the main points in its implementation. </div><p>Source: <a href="https://habr.com/ru/post/245727/">https://habr.com/ru/post/245727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245709/index.html">From math to generalized programming</a></li>
<li><a href="../245713/index.html">Hell Visualization 1.1 - Book 1: Overview</a></li>
<li><a href="../245717/index.html">WiFi Pineapple Mark V: black box for wireless interception</a></li>
<li><a href="../245719/index.html">Obfuscation of lines at compile time</a></li>
<li><a href="../245721/index.html">If the customer is a revision</a></li>
<li><a href="../245729/index.html">CPU vs GPU. Distance field</a></li>
<li><a href="../245731/index.html">Expressive JavaScript: Forms and Form Fields</a></li>
<li><a href="../245735/index.html">Search for the best sequence of viewing the list of 250 best movies using the Wolfram Language (Mathematica)</a></li>
<li><a href="../245737/index.html">Web Design Books</a></li>
<li><a href="../245739/index.html">Japanese startup attracted $ 90 million for advertising on the moon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>