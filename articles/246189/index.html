<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protection of Microsoft service accounts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Protection of user accounts in the corporate network based on the MS Windows domain is a typical and simple task. Everything is already implemented an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protection of Microsoft service accounts</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/3e1/417/6c6/3e14176c6c4f422db9ddaecca975c3e1.png" align="right">  Protection of user accounts in the corporate network based on the MS Windows domain is a typical and simple task.  Everything is already implemented and regulated (for example, in <a href="http://technet.microsoft.com/en-us/library/cc784090">MS TechNet Password Best practices</a> or in <a href="http://fstec.ru/rss-lenta/53-deyatelnost/normotvorcheskaya/akty/prikazy/702-prikaz-fstek-rossii-ot-11-fevralya-2013-g-n-17">17/21 orders of the FSTEC</a> ): <br><br><ul><li>  The use of complex and long password; </li><li>  Temporary blocking of the user in case of incorrect password entry; </li><li>  Periodic mandatory password change by the user. </li></ul><br>  But what to do with "service" technology accounts? <br>  Such records are in any corporate network and are used, for example, for: <br><ul><li>  the operation of programs and services on servers; </li><li>  communication programs with the DBMS (with domain authorization in the DBMS); </li><li>  create service mailboxes in Exchange. </li></ul><br>  We also assign to this list administrator accounts, if they are used for the above tasks. <br>  We will continue to talk about the features of the protection of service accounts. <br><a name="habracut"></a><br><h5>  Why do you need to "special" to protect service accounts? </h5><br>  Because it is impossible to apply the same security policies to them as to ordinary user entries, namely: <br><ul><li>  Temporary blocking of the user in case of incorrect password entry. <br>  It is impossible to block the service record, otherwise the service, in which this record is involved, will cease to function for all users of the network.  Such blocking can occur due to an employee error, targeted sabotage, or brute-force password activity (for example, Net-Worm.Win32.Kido). <br></li><li>  Periodic mandatory password change by the user. <br>  You cannot set a periodic mandatory password change for a service account, otherwise the system will request a password change and block the record, and the service using it will, again, stop functioning. </li></ul><br>  It turns out that the network has a lot of service accounts that are not protected from brute force and over the years non-removable password.  And if we consider that during the operation of the service, not one engineer could attach to his service, we consider the password known to a wide circle of people. <br>  Protection for service accounts is lower than that of user accounts, and using them you can do anything on the network, especially since they are often endowed with extended privileges. <br>  The following are techniques to minimize the risk of unauthorized use of service accounts.  All of them have been tested and implemented in the corporate network. <br><br><img src="https://habrastorage.org/files/3a9/286/fc5/3a9286fc57d04fb7af1cdc972b7daea8.png" align="right"><h4>  Auto unlock and alert </h4><br>  Disabling account lockout policies in case of entering the wrong password is fraught with a complete lack of protection against password guessing. <br>  You can apply the following solution: <br><ul><li>  The policy of blocking accounts to extend to all, including service accounts; </li><li>  in case of blocking a service account, to unblock it immediately and notify the security administrator of the fact of blocking, indicating the computer on which the password was entered incorrectly. </li></ul><br>  As a result, although we do not stop trying to find a password, we notify the administrator, giving him the opportunity to quickly respond to the incident. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Implementation: <br>  On the domain controller in the event scheduler, configure the task triggered by the lock event of a specific service account: <br>  <i>Event properties -&gt; Tab: Triggers -&gt; Create -&gt; Assign date: At event -&gt; Parameters: Custom -&gt; Create event filter ... -&gt; Tab: XML -&gt;</i> <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">QueryList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Query</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Security"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Security"</span></span></span><span class="hljs-tag">&gt;</span></span>*[System[(EventID=4740)]] and *[EventData[Data[@Name='TargetUserName'] and (Data='[USERNAME]')]] and *[EventData[Data[@Name='SubjectDomainName'] and (Data='[DOMAIN NAME]')]]<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Query</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">QueryList</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Where: <br>  <i>[USERNAME]</i> - the name of the controlled account; <br>  <i>[DOMAIN NAME]</i> - domain name. <br><br>  Next, set up an action for this event ‚Äî launching a script that takes the name of an account as an argument, removes the lock from it, and sends an e-mail notification. <br>  In our case, this is a powershell script, run with arguments: <br><br><pre> <code class="bash hljs">-ExecutionPolicy RemoteSigned -Command <span class="hljs-string"><span class="hljs-string">"&amp; {C:\Scripts\Unlock.ps1 -user [USERNAME] }"</span></span></code> </pre><br>  The basis of the script are the commands: <br><pre> <code class="bash hljs">Import-Module ActiveDirectory //    Unlock-ADAccount <span class="hljs-variable"><span class="hljs-variable">$user</span></span> //      Get-EventLog -LogName <span class="hljs-string"><span class="hljs-string">'Security'</span></span> -newest 10000 | Where-Object {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.EventID -eq 4740 -and <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.ReplacementStrings[0] -eq <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$user</span></span></span><span class="hljs-string">"</span></span>} | Select-Object -first 1 //   ,        Net.Mail //  .</code> </pre><br>  This event in the task scheduler must be duplicated for each service account under control.  If there are too many such records, then it makes sense to upgrade the solution to: <br><ul><li>  the task in the scheduler was triggered when any account was blocked (event 4740 in the security log); </li><li>  searched for each blocked account in the domain group "service accounts" (for example); </li><li>  if the account is in a group, it is unlocked and notified to the administrator. </li></ul><br><img src="https://habrastorage.org/files/715/cc9/b7d/715cc9b7d8904326b715cfd4e8e0881d.png" align="right"><h4>  Lock full work </h4><br>  Most of the service accounts are used to run specific services or to work on servers.  So, for them, you can disable all the extra features.  For example, to prohibit the possibility of local access to computers on the network. <br>  Microsoft proposes to do this with the appropriate policy located here: <i>Security Settings \ Local Policies \ User Rights Assignment \ Local Login</i> .  But sometimes using this policy is difficult, then you can use the following method: <br><ul><li>  create a domain group "service accounts" and add all accounts to it, which need not be able to log on to computers on the network; </li><li>  create a domain group policy that applies to the created group and includes the only rule - to start at the% SystemRoot% \ System32 \ logoff.exe login. </li></ul><br>  As a result, even if the account password is compromised, it will be problematic to log into the network computers with it. <br><br><img src="https://habrastorage.org/files/999/4c7/8a7/9994c78a7c99491dbae1cbfdee46d6bd.png" align="right"><h4>  Suspicious Activity Monitoring </h4><br>  If an account is created for working with a database or authorizing an application, then it has nothing to do on file servers or a domain controller.  Of course, with properly configured access rights, it will not go there, but who will give a guarantee?  Therefore, it is necessary to conduct various kinds of monitoring of suspicious activity on the part of official accounts.  For these purposes you can use: <br><ul><li>  task schedulers and scripts; </li><li>  various SIEM solutions; </li><li>  DLP system. </li></ul><br>  Describe the monitoring options on the example of specific protection systems in this article will be superfluous, given that they have their own in each network, I will cite only events that it makes sense to ‚Äúcatch‚Äù: <br><ul><li>  authorization on computers and servers (including unsuccessful authorization attempts); </li><li>  calling on file servers, creating and changing files on them; </li><li>  calls to the domain controller; </li><li>  launching applications that are not needed by this account. </li></ul><br><h4>  Summing up </h4><br>  Compromising and subsequent unauthorized use of service accounts are a serious threat to any corporate network and when building a protection system, greater attention should be paid to their protection and control.  Using generic policies for service accounts is not suitable.  It is necessary to understand what functionality can be blocked, and what needs to be put under control. </div><p>Source: <a href="https://habr.com/ru/post/246189/">https://habr.com/ru/post/246189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246175/index.html">Trojan Stealing Steam Items</a></li>
<li><a href="../246177/index.html">Build library packages for rpm-based Linux distributions</a></li>
<li><a href="../246179/index.html">A story about how I found logs with the help of logs</a></li>
<li><a href="../246181/index.html">How to increase conversion and traffic online store only through internal optimization</a></li>
<li><a href="../246187/index.html">New FSTEK certificate for Kerio Control Appliance 8.2</a></li>
<li><a href="../246191/index.html">Home accounting on the platform CUBA. Part 2</a></li>
<li><a href="../246193/index.html">About firewall certification</a></li>
<li><a href="../246195/index.html">6 games in 6 weeks - the second game</a></li>
<li><a href="../246197/index.html">Security scanners: automatic validation of vulnerabilities using fuzzy sets and neural networks</a></li>
<li><a href="../246199/index.html">We use standard ListFragment elements for their intended purpose.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>