<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network microsegmentation in examples: how this cleverly twisted thing reacts to different attacks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Previously, when it was necessary to differentiate something (for example, servers with payment processing and user office terminals), they simply bui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network microsegmentation in examples: how this cleverly twisted thing reacts to different attacks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/867/dc0/029/867dc00294034beabf7dca698eddae53.jpeg"><br><br>  Previously, when it was necessary to differentiate something (for example, servers with payment processing and user office terminals), they simply built two independent networks with a bridge-firewall in the middle.  It is simple, reliable, but expensive and not always convenient. <br><br>  Later, other types of segmentation appeared, in particular, on rights based on a transaction map.  Simultaneously, role schemes developed, in which a machine, person, or service is assigned its specific rights.  The next logical step is microsegmentation in virtual infrastructures, when a DMZ is placed around each machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Russia, while there are single implementations of such defensive constructions, but soon there will definitely be more of them.  And then we may not even understand how it was possible to live without this.  Let's look at attack scenarios for such a network and how it reacts to it. <a name="habracut"></a><br><br><h2>  What is microsegmentation </h2><br>  Microsegmentation is a security method that allows you to assign security micro-policies to data center applications, right down to the workload level.  In a more applied application, this is a data center security model.  Network security policies are enforced by firewalls integrated into hypervisors that are already present in the data center.  This provides ubiquity of protection.  In addition, security policies can be conveniently modified, including automatically, and dynamically adapted to reflect changes in workloads. <br><br><h2>  As it was before </h2><br>  Here is the "stone age" of modern networks - unmanaged networks: <br><br><img src="https://habrastorage.org/web/605/a39/319/605a39319e70441e9b2828ac1c049da0.png"><br><br>  More precisely, it would have been a stone age if the networks were generally physically separated by the absence of links.  But here they are connected by a router and protected by hardware firewalls at the intersection site.  This is a good option exactly as long as you do not fall into the real world. <br><br>  Here is the next step in the evolution of protection: <br><br><img src="https://habrastorage.org/web/b43/d8d/bbb/b43d8dbbbd1f407590f328b90830149f.jpg"><br><br>  Today, most companies use server clusters to spin their entire infrastructure.  Here is <a href="https://habrahabr.ru/company/croc/blog/306674/">an example of Aeroexpress</a> - there, in fact, one cluster and two virtual subnets - for sales offices (regular users) and for banking, that is, ticket settlements.  Before the introduction, there was only one network, and in theory, the cashier could trite the server with the issuance of tickets.  The next logical step after such a separation is still greater virtualization and the construction of microsegments, but not at the level of hardware, but at the level of flexible service rights.  This greatly simplifies administration compared to the classic task of finely-divided 2-3 machines each, and greatly simplifies life in terms of the reliability of protection in a cluster.  Each microsegment looks at the neighboring one as the outside world, and not as a deliberately trusted one. <br><br>  This is one of the simplest schemes, where, depending on the tasks, intersections of different perimeters are used.  It may look like the diagram below. <br><br><img src="https://habrastorage.org/web/337/89d/962/33789d9622f6487da99a58cbcdccc0a1.png"><br><br>  In this scheme, as you can see, solved problems of scaling network components (produced by deploying new VMs), it is possible to use any network equipment, it is possible to control the horizontal propagation of VM traffic, VLANs are replaced by VxLANs, which are limited to about 16 million interfaces.  Moreover, if you look at the color delimitation of the scheme, you can see the following scenarios on the example of the Personal Account - 1: <br><br><ol><li>  Application servers located at different physical sites are located in the same logical network P6 (orange ovals); </li><li>  At the same time, Web servers of the same Personal Account - 1 are already in different logical networks (green ovals P4 and P5); </li><li>  All servers that implement Personal Account - 1, in turn, are located in a single logical network P10 (zone marked with a dotted line). </li></ol><br>  Perhaps you have already understood everything and now you want to know how difficult it is to support it.  So, in new versions of hypervisors such structures are supported out of the box. <br><br>  The main theme of such micro-segmentation implementations is the protection of critical services in the context of cluster and personal cloud technologies. <br><br>  <b>Example</b> : there is an accountant‚Äôs work machine where, during normal daily work, policies such as ‚ÄúAWS Accounting‚Äù are applied, with which you can access the Internet and general infrastructure services.  When you start the client bank, the policies will immediately take priority in processing the rules related specifically to the bank client traffic, and their traffic will be allowed only to the specified IP / DNS server of the bank, while always passing this traffic through additional information protection tools (for example, the DPI server).  Bank-client is closed - again becomes the "AWS Accounting". <br><br><h2>  What does one of the NSX microsegmentation platforms consist of? </h2><br>  Here are the main components: <br><table><tbody><tr><td width="200"><br><p>  Switching </p><br></td><td><br><p>  A logical overlay of Level 2 is provided across the entire Level 3 switched matrix inside and outside the data center.  VXLAN based network overlay support. </p><br></td></tr><tr><td><br><p>  Routing </p><br></td><td><br><p>  Dynamic routing between virtual networks is performed by the kernel of the hypervisor distributed, supported by horizontal scaling with active-active failover to physical routers.  Both static and dynamic routing protocols (OSPF, BGP) are supported. </p><br></td></tr><tr><td><br><p>  Distributed firewall </p><br></td><td><br><p>  Stateful distributed firewall services built into the hypervisor core, with up to 20 Gbps throughput per hypervisor server.  Active Directory support and action monitoring.  In addition, NSX provides a vertical firewall using the NSX Edge. </p><br></td></tr><tr><td><br><p>  Load balancing </p><br></td><td><br><p>  Load balancing for levels <nobr>4‚Äì7 with</nobr> SSL load transfer and pass-through, server health check and application rules provide programming and traffic manipulation capabilities. </p><br></td></tr><tr><td><br><p>  VPN </p><br></td><td><br><p>  Remote access via VPN and VPN environment-environment VPN, unmanaged VPN for cloud gateway services. </p><br></td></tr><tr><td><br><p>  NSX Gateway </p><br></td><td><br><p>  Supporting bridges between VXLANs and VLANs provides optimal connectivity to physical workloads.  This component is built into the NSX platform, and is also supported by the super-rack switches supplied by ecosystem partners. </p><br></td></tr><tr><td><br><p>  NSX API </p><br></td><td><br><p>  REST-based APIs are supported for integration with any cloud management or user platform. </p><br></td></tr></tbody></table><br>  And now we will consider scenarios of various threatening events so that it will become completely clear. <br><br><h2>  Scenario 1: Malvar </h2><br>  Ways of penetration and infection in large companies are about the same: phishing, targeted attacks, "road apples" in the form of thrown flash drives.  As a rule, the malware infects one of the workstations (for example, coming with a letter), and then inside the perimeter it can do anything before it is detected.  I recently saw a situation in the bank.  I must say, they have serious people and serious security, but the situation inside the network was such that the deployed test malware (without payload) ‚Äúbroke through‚Äù the test environment and infected several branches before the protection system saw it.  In some, the user segment is not at all separated from the critical one, and users happily hang malicious programs on 1C servers, on machines with financial transactions, on a web server, update server, and so on. <br><br>  In our paradigm, the protection is as follows: microsegmentation at the level of servers, services, users.  Separate each group by perimeters (as in the picture above).  One virtual machine is usually infected, which is detected by an antivirus running from the height of the hypervisor.  A machine with an atypical activity is immediately placed in quarantine - a special segment where all those who do something not quite normal fall into. <br><br>  Standard measures such as a typical sandbox can also be screwed to this. <br><br>  Modern malware subsides on a single workstation, sends a very small signal to the management server, or deploys the second block, which already carries the ‚Äúuseful‚Äù load.  In which case, it is the second generation of the malware that is detected - the first one that has ‚Äúcalmed down‚Äù remains in the system.  Antivirus, maybe, zadetektit and even kill both blocks, if lucky, but most likely, it will happen on the border of the networks, and after that you have to do a great job of tracking damage.  And the integration of antivirus without a hypervisor level is somewhat more complicated. <br><br>  On March 17, 2017, Kaspersky updated ‚Äúagentless protection‚Äù for the NSX. <br><br><h2>  Scenario 2: directed attack on a critical service </h2><br>  The attack on especially critical computers and servers (accounting, machines with access to SWIFT, processing servers) most often begins as DDoS, continues with the malicious code "on the sly."  It is solved simply: one more is created (two, three, how many) DMZ inside your server group for a complete cutoff.  Of course, this need to think in advance. <br><br>  In a normal admin, of course, the networks are already divided, just maintaining it without holes for years is more difficult.  Well, without centralization.  And when transferring a network or virtuals, holes may appear, and in the case of microsegmentation, the probability is much less. <br><br><h2>  Scenario 3: Random Incorrect Migration or Simplified Network Initialization </h2><br>  Only a third of data loss is related to the actions of intruders.  The rest is a banal oversight or just idiocy.  A striking example is the very frequent changes in the network, for example, the migration of a machine or a group of machines from one subnet to another (from a more secure to less protected one, due to which the migrated machine is ‚Äúnaked‚Äù in front of threats). <br><br>  The solution is microsegmentation and profile assignment to a machine or group of machines.  Thus, the security settings and all the necessary firewalls (implemented by the hypervisor) will remain on the VM, regardless of how and where it is migrated. <br><br>  My favorite example is that in one retail network risks were incorrectly assessed.  Cashier migrated to the user area (or rather, user rights have changed in six months).  Someone forgot something at the next patch - and they put a bare database out. <br><br><h2>  Scenario 4: especially successful pentest </h2><br>  This is really a separate scenario, because for such shoals it is very painful to hit the hands.  Especially in the financial sector.  I saw a very simple story: the bank ordered the penetration of a certain VM group (in the test environment).  Pentesters took the flag, but got a little carried away, digged into the test environment, went into the main segment and put the ABS server for a day.  This is just a paragraph! <br><br>  In general, microsegmentation helps to make sure that the networks ‚Äúphysically‚Äù do not see each other, as if they were not connected at all.  They still won't go to the hypervisor level (well, at least without a world-class 0-day).  If suddenly something gets admin admin rights and will be distributed - the hypervisor will catch.  And virtual machines are much easier to roll back. <br><br><h2>  Scenario 5: Attacking an outward-looking service, leading to internal network problems </h2><br>  In retail there is a web server.  The front stands, and between the front and the web are open ports. <br>  Fiddled him, at the same time eventually the line of cashiers fell.  Admin is looking for a new job the next day.  In general, the essence of the attack - the attacker exploits the vulnerability of an application server or a web server accessible from the Internet and gains access inside the corporate infrastructure to critical servers and databases.  Well, or just puts everything inside didos. <br><br>  In the paradigm, microsegmentation of each server of the service is assumed in such a way that for each server that performs its role, there will be certain security settings.  Configured with profiles. <br><br><h2>  Other scenarios </h2><br>  In general, other scenarios are worked out in a similar way.  For example, from our point of view, an insider is just an infected AWP.  It doesn‚Äôt matter whether he himself acts, or simply has his uchyotku increased.  Atypical activity - quarantine - investigation and subsequent rollback of the affected VM. <br><br><h2>  How to move </h2><br>  Let's tell on the example of one of the practical cases: <br><br><ol><li>  Conducted a survey.  The survey recorded the network topology, the virtual infrastructure architecture, the types of deployed systems and services.  At this stage, all information flows (user, service, control traffic, monitoring and updating traffic) are determined and recorded. </li><li>  The analysis and design of changes in the virtual infrastructure, including the network one, is carried out, taking into account the groups of services on criticality and functions provided that were identified at the survey stage. </li><li>  The initial configuration of profiles (VM groups, roles, security settings, ITU settings, user group access settings) is made for the VM test group. </li><li>  Formed profiles are applied, work is monitored.  If necessary, adjustments are made.  The zero-trust model is in place when introducing microsegmentation.  With this model, we initially do not trust anything, and allow only proven and trusted interaction. </li><li>  The solution is scaled to the entire infrastructure. </li></ol><br>  Further, the entire infrastructure is maintained and managed centrally from a single console with a minimum number of personnel involved.  Groups and profiles are formed, their appointment is made fairly quickly.  Assigned profiles work everywhere within a single virtual infrastructure.  In addition to managing the ITU and security settings, the processes of migration, updating, input and output of servers and services are also centrally controlled. <br><br>  Important points specifically for the NSX solution mentioned: <br><br><ul><li>  The need to replace the Cisco ASA 5520 firewall. </li><li>  The ability to split the data center into separate segments, regardless of the subnet and VLAN. </li><li>  Applying policies to the VM in accordance with the OS and its name. </li><li>  IPsec solution support for communication with remote branches. </li></ul><br>  There was such a network: <br><br><img src="https://habrastorage.org/web/844/b2c/6d6/844b2c6d66144c439978a184ce7d69cc.png"><br><br>  Before implementation, we conducted an audit to understand how traffic ‚Äúflows‚Äù in a virtual data center using the VMware vRealize Network Insight utility.  It just helps to set up rules for micro-segmentation.  It turns out something like this: <br><br><img src="https://habrastorage.org/web/08f/30d/710/08f30d71058147d7880e04fe07a00347.png"><br>  <a href="https://www.vmguru.com/2016/08/you-want-micro-segmentation-vrealize-network-insight-is-your-friend/">A source</a> <br><br>  And they compared the customer‚Äôs parameters (for example, one of the tasks was to replace the VPN): <br><br><table><tbody><tr><td></td><td><br><p>  Cisco ASA 5520 </p><br></td><td><br><p>  Cisco ASA <nobr>5515-X</nobr> </p><br></td><td><br><p>  Cisco ASA 1000V </p><br></td><td><br><p>  Cisco ASA <nobr>5555-X</nobr> </p><br></td><td><br><p>  VMware NSX Edge <nobr>(X-Large)</nobr> </p><br></td></tr><tr><td><br><p>  Type of </p><br></td><td><br><p>  Physical device </p><br></td><td><br><p>  Physical device </p><br></td><td><br><p>  Virtual machine </p><br></td><td><br><p>  Physical device </p><br></td><td><br><p>  Virtual machine </p><br></td></tr><tr><td><br><p>  Maximum firewall throughput (max.) </p><br></td><td><br><p>  0.4 Gbit / s </p><br></td><td><br><p>  1.2 Gbit / s </p><br></td><td><br><p>  1.2 Gbit / s </p><br></td><td><br><p>  4 Gbps </p><br></td><td><br><p>  9 Gbps </p><br></td></tr><tr><td><br><p>  Maximum simultaneous sessions </p><br></td><td><br><p>  280,000 </p><br></td><td><br><p>  245,000 </p><br></td><td><br><p>  200,000 </p><br></td><td><br><p>  1,000,000 </p><br></td><td><br><p>  1,000,000 </p><br></td></tr><tr><td><br><p>  Maximum connections per second </p><br></td><td><br><p>  N / A </p><br></td><td><br><p>  6000 </p><br></td><td><br><p>  10,000 </p><br></td><td><br><p>  50,000 </p><br></td><td><br><p>  131,000 </p><br></td></tr><tr><td><br><p>  VPN bandwidth </p><br></td><td><br><p>  250 Mbps </p><br></td><td><br><p>  250 Mbps </p><br></td><td><br><p>  200 Mbps </p><br></td><td><br><p>  700 Mbps </p><br></td><td><br><p>  2 Gbps </p><br></td></tr><tr><td><br><p>  Maximum number of IPsec tunnels </p><br></td><td><br><p>  750 </p><br></td><td><br><p>  250 </p><br></td><td><br><p>  750 </p><br></td><td><br><p>  5,000 </p><br></td><td><br><p>  6,000 </p><br></td></tr><tr><td><br><p>  Maximum number of SSL tunnels </p><br></td><td><br><p>  750 </p><br></td><td><br><p>  250 </p><br></td><td><br><p>  750 </p><br></td><td><br><p>  5,000 </p><br></td><td><br><p>  6,000 </p><br></td></tr></tbody></table><br>  In parallel, they built a network diagram of physical equipment.  The key for us is to understand the traffic flow inside the data center to configure policies.  It was removed, apply immediately.  If something will be cut - just add later.  A week or two is enough to build a good map and identify all services. <br><br>  We had a fairly simple installation, and we placed it on 2 blades.  Expenses: <br><br><table><tbody><tr><td><br><p>  Component </p><br></td><td><br><p>  Qty </p><br></td><td><br><p>  ‚àë RAM (GB) </p><br></td><td><br><p>  ‚àëvCPU </p><br></td><td><br><p>  ‚àëHDD (GB) </p><br></td></tr><tr><td><br><p>  NSX Manager </p><br></td><td><br><p>  one </p><br></td><td><br><p>  sixteen </p><br></td><td><br><p>  four </p><br></td><td><br><p>  60 </p><br></td></tr><tr><td><br><p>  NSX Controller </p><br></td><td><br><p>  3 </p><br></td><td><br><p>  12 </p><br></td><td><br><p>  12 </p><br></td><td><br><p>  60 </p><br></td></tr><tr><td><br><p>  NSX DLR </p><br></td><td><br><p>  2 </p><br></td><td><br><p>  four </p><br></td><td><br><p>  eight </p><br></td><td><br><p>  3 </p><br></td></tr><tr><td><br><p>  NSX Edge </p><br></td><td><br><p>  one </p><br></td><td><br><p>  2 </p><br></td><td><br><p>  four </p><br></td><td><br><p>  2 </p><br></td></tr></tbody></table><br>  The customer already had a VMware vSphere virtualization environment, so we just bought licenses for the NSX.  At that time there were no NSX editions, they appeared almost a month after the purchase of licenses.  The product itself is licensed per socket. <br><br>  We divided the machines into groups and assigned tags to them, transferred the firewall rules from the ASA to the distributed firewall and checked again vRealize Network Insight. That we correctly indicated the traffic flows and did not forget anything. <br><br>  PROFIT! <br><br><h2>  Links </h2><br><ul><li>  <a href="http://www.vmware.com/products/nsx/technology-partners.html">Official</a> </li><li>  <a href="http://www.kaspersky.ru/about/news/product/2017/Update-VMware-NSX">Integration with Kaspersky anti-virus product</a> </li><li>  <a href="http://networkinferno.net/nsx-compendium">A very good English-language article</a> on what VMware NSX consists of and how it works. </li><li>  <a href="https://habrahabr.ru/company/croc/blog/253835/">Educational program</a> about not quite well-known solutions for protecting the IT infrastructure of a business </li><li>  My mail for questions is afeoktistov@croc.ru </li></ul></div><p>Source: <a href="https://habr.com/ru/post/328958/">https://habr.com/ru/post/328958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328942/index.html">Ruby on Rails agreement. Part 2</a></li>
<li><a href="../328946/index.html">Kotlin is the official development language for Android. We understand the intricacies of the language on Stepik</a></li>
<li><a href="../328952/index.html">Implementing drag & drop functionality in an iOS application</a></li>
<li><a href="../328954/index.html">Creating a Web API application using. NET Core + MongoDB. NET Driver</a></li>
<li><a href="../328956/index.html">Register for the webinar "From WannaCry to WannaSaveU". Attack visibility and recovery</a></li>
<li><a href="../328960/index.html">Ionic 2 vs React Native: a comparison of frameworks for creating corporate mobile applications</a></li>
<li><a href="../328962/index.html">Android and architecture</a></li>
<li><a href="../328964/index.html">Analysis of errors in the seller</a></li>
<li><a href="../328966/index.html">How are developed industry and specialized solutions for 1C: ERP</a></li>
<li><a href="../328970/index.html">Building a modular architecture of the application on Forwarding decorators (author's translation)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>