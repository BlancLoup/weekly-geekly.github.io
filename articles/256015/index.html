<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Xcode: plugins plugins</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Interested in publishing "Writing your Xcode plugin" decided to write a simple time tracker for Xcode. The process I went through is the essence of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Xcode: plugins plugins</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/89d/dce/cc7/89ddcecc7068494f94418449c64b2af8.png"><br><br>  Interested in publishing <a href="http://habrahabr.ru/post/163795/">"Writing your Xcode plugin"</a> decided to write a simple time tracker for Xcode.  The process I went through is the essence of this article.  In it, we will analyze a few plugins that will help write other plugins faster and more efficiently. <br><br>  The main idea of ‚Äã‚Äãany plug-in with the interface is that it integrates into the Xcode UI and looks as native as possible.  But as soon as we look at the Xcode window, the question immediately arises: ‚ÄúHow to understand where is the object and how can we integrate into the one we need?‚Äù So the first plugin appears on our way.  We will write a simple plugin that will be loaded into Xcode and say where the object is located. <br><a name="habracut"></a><br><h3>  First plugin </h3><br>  First, install the <a href="https://github.com/kattrali/Xcode-Plugin-Template">template for the plugins</a> and create the plugin.  Then everything is simple: in order to understand what Xcode consists of, it is necessary to output its objects to the log.  To do this, you can write logs to a file or display them in dialogs and close them each time.  Oh, how it would be convenient to display this information directly to the Xcode console, you say?  Well, nothing, we will solve this problem with our second plugin, but more on that a little bit later.  In the meantime, in order not to understand the location of the objects from the logs, we will take a screenshot of the Xcode window with the filled area of ‚Äã‚Äãobjects and save it all to a file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our first plugin will consist of only one method, which will run through all the 'NSView', color them and make a screenshot of the current window.  It sounds simple, but in practice there is one small nuance: some of the 'NSView' objects in Xcode can have nothing but a single 'contentView' and we cannot add our own to it.  But it does not matter, we will simply ignore such objects and delve into them. <br><br><div class="spoiler">  <b class="spoiler_title">Method text</b> <div class="spoiler_text"><pre><code class="hljs pgsql">- (<span class="hljs-type"><span class="hljs-type">void</span></span>)viewSnap:(NSView *)<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> { static <span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-type"><span class="hljs-type">text</span></span> field    NSTextField *<span class="hljs-type"><span class="hljs-type">name</span></span> = [[NSTextField alloc] initWithFrame:<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.bounds]; <span class="hljs-type"><span class="hljs-type">name</span></span>.backgroundColor = [NSColor colorWithDeviceRed:rand()%<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">255.</span></span>f green:rand()%<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">255.</span></span>f blue:rand()%<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">255.</span></span>f alpha:<span class="hljs-number"><span class="hljs-number">0.3</span></span>]; <span class="hljs-type"><span class="hljs-type">name</span></span>.textColor = [NSColor blackColor]; NSString *string = <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.className?:NSStringFromClass(<span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>); <span class="hljs-type"><span class="hljs-type">name</span></span>.stringValue = string?:@"unknown"; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> respondsToSelector:@selector(contentView)]) {//    <span class="hljs-type"><span class="hljs-type">text</span></span> field? [<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> addSubview:<span class="hljs-type"><span class="hljs-type">name</span></span>]; //      NSImage *captureImage = [[NSImage alloc] initWithData:[[NSApp keyWindow].contentView dataWithPDFInsideRect:[[NSApp keyWindow].contentView bounds]]]; [[captureImage TIFFRepresentation] writeToFile:[NSString stringWithFormat:@"%@%d.png", self.dirPath, i++] atomically:YES]; [<span class="hljs-type"><span class="hljs-type">name</span></span> removeFromSuperview]; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (NSView *v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>.subviews) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([v respondsToSelector:@selector(contentView)]) { NSView *vv = [v performSelector:@selector(contentView) withObject:nil]; [self viewSnap:vv]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [self viewSnap:v]; } } }</code> </pre> <br><br>  And the method call: <br><pre> <code class="hljs objectivec">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)doMenuAction { <span class="hljs-built_in"><span class="hljs-built_in">NSWindow</span></span> * window = [<span class="hljs-built_in"><span class="hljs-built_in">NSApp</span></span> keyWindow]; srand(time(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> viewSnap:window.contentView]; }</code> </pre><br></div></div><br>  After that, you can open the folder where you saved the pictures and admire.  It is worth playing around with the size of the text depending on the size of the 'NSView'. <br><br>  Here is the result: <br><br><img src="https://habrastorage.org/files/fb5/4ca/3ee/fb54ca3ee7cb4f1985af98d9e9bf656d.jpg"><br><img src="https://habrastorage.org/files/dd8/37f/63c/dd837f63c6a74a36bd925400d0fd8b5e.jpg"><br><br>  But the results are more beautiful and after manual processing: <br><br><div class="spoiler">  <b class="spoiler_title">Some pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e2a/95f/c7a/e2a95fc7a396428295c3d65722982d74.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/cbd/1dc/a66/cbd1dca668754bc38c43b27932b46e93.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/28b/537/992/28b537992a734e9bb3b6db8be657eee6.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/f91/2b4/d8e/f912b4d8edca43a997654d2ab37d499f.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/31e/b08/10e/31eb0810eb8543e68dded9ef1615f6c5.png" alt="image" width="600"><br><br><img src="https://habrastorage.org/files/35d/0cf/bd8/35d0cfbd81504ee6920641e1685db80f.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/b31/531/e13/b31531e13d8d47108b269bb89e0566e2.png" alt="image" width="600"><br><img src="https://habrastorage.org/files/3ad/a67/c55/3ada67c5592741af8991071c55a2c962.png" alt="image" width="600"><br></div></div><br>  Immediately proceed to the second plugin.  We will display information from the plugins in the Xcode console. <br><br><h3>  Second plugin </h3><br>  From the first plugin, we learned that the console in Xcode is the 'IDEConsoleTextView' class.  But what kind of class is it and what methods does it have?  To learn this, there are several ways: <br>  1. Write a plugin that finds the console in the window and displays all its methods in a file. <br>  2. Using <a href="http://stevenygard.com/projects/class-dump/">class-dump,</a> pull all the drivers from private frameworks and try to find this class there. <br>  3. Go to the page of the project <a href="https://github.com/XVimProject/XVim">XVim</a> and take all private headers there. <br><br>  Absolutely no matter which way you go, the main thing is that you find out that the console is a subclass from 'NSTextView' and that it contains the following methods: <b>insertText:,</b> <b>insertNewLine:.</b>  Great, now we can find the console in the window and write down the lines of information we need there. <br><br>  Now we need to add a button that is responsible for the logging mode and get information from other plugins. <br><br>  After the first plug-in, we know that next to the console there is a 'DVTScopeBarView' containing the controls.  There we put our button.  We look at the 'DVTScopeBarView' header and see that the class contains the <b>addViewOnRight:</b> method.  Very good, so we can add our button to the bar and not worry about the position of other elements. <br><br><div class="spoiler">  <b class="spoiler_title">Search IDEConsoleTextView and DVTScopeBarView</b> <div class="spoiler_text"><pre> <code class="hljs objectivec">- (IDEConsoleTextView *)consoleViewInMainView:(<span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *)mainView { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *childView <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mainView.subviews) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([childView isKindOfClass:<span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"IDEConsoleTextView"</span></span>)]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IDEConsoleTextView *)childView; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *v = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> consoleViewInMainView:childView]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([v isKindOfClass:<span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"IDEConsoleTextView"</span></span>)]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IDEConsoleTextView *)v; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } - (DVTScopeBarView *)scopeBarViewInView:(<span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *)view { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *childView <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> view.subviews) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([childView isKindOfClass:<span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"DVTScopeBarView"</span></span>)]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (DVTScopeBarView *)childView; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *v = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> scopeBarViewInView:childView]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([v isKindOfClass:<span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"DVTScopeBarView"</span></span>)]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (DVTScopeBarView *)v; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)someMethod { <span class="hljs-built_in"><span class="hljs-built_in">NSWindow</span></span> *window = [<span class="hljs-built_in"><span class="hljs-built_in">NSApp</span></span> keyWindow]; <span class="hljs-built_in"><span class="hljs-built_in">NSView</span></span> *contentView = window.contentView; IDEConsoleTextView *console = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> consoleViewInMainView:contentView];<span class="hljs-comment"><span class="hljs-comment">//  DVTScopeBarView *scopeBar = nil; NSView *parent = console.superview; while (!scopeBar) { if (!parent) break; scopeBar = [self scopeBarViewInView:parent]; parent = parent.superview; } //...     }</span></span></code> </pre><br></div></div><br>  Now we have added a button to the bar and we can find a console on the window.  It remains to somehow get information from other plugins and display it.  The easiest option: use 'NSNotificationCenter'.  Since plugins are loaded on Xcode and I can catch notifications from it, you can send and catch them between plugins.  Just subscribe to the notifications we need and tell the console to display the log.  To do this, we create a function in client files (files that other plugins will use) that will send the notifications we need and catch them in our plugin. <br><br><div class="spoiler">  <b class="spoiler_title">Log functions and console display</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PluginLogWithName(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *pluginName, <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *format, ...) { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *name = <span class="hljs-string"><span class="hljs-string">@""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pluginName.length) { name = pluginName; } va_list argumentList; va_start(argumentList, format); <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *string = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%@ Plugin Console %@: "</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">NSDate</span></span> date], name]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* msg = [[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> alloc] initWithFormat:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%@%@"</span></span>,string, format] arguments:argumentList]; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableAttributedString</span></span> *logString = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableAttributedString</span></span> alloc] initWithString:msg attributes:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [logString setAttributes:[<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> dictionaryWithObject:[<span class="hljs-built_in"><span class="hljs-built_in">NSFont</span></span> fontWithName:<span class="hljs-string"><span class="hljs-string">@"Helvetica-Bold"</span></span> size:<span class="hljs-number"><span class="hljs-number">15.</span></span>f] forKey:<span class="hljs-built_in"><span class="hljs-built_in">NSFontAttributeName</span></span>] range:<span class="hljs-built_in"><span class="hljs-built_in">NSMakeRange</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, string.length)]; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] postNotificationName:PluginLoggerShouldLogNotification object:logString]; va_end(argumentList); } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addLog:(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span> *)notification {<span class="hljs-comment"><span class="hljs-comment">//  for (NSWindow *window in [NSApp windows]) {//     NSView *contentView = window.contentView; IDEConsoleTextView *console = [self consoleViewInMainView:contentView];//  console.logMode = 1;//     [console insertText:notification.object];//  [console insertNewline:@""];//     } }</span></span></code> </pre><br>  As you can see, the log can be output in absolutely any font. <br></div></div><br><br>  So the second plugin is ready.  Full source code can be viewed <a href="https://github.com/AlexIzh/PluginConsole">here</a> .  The plugin looks like this: <br><br><img src="https://habrastorage.org/files/c14/1f1/fe0/c141f1fe02394ac799952ab616a68a9e.png" width="600"><br><br><h3>  Third plugin </h3><br>  Eh, it would be nice if the plugins were near and access to them was the same as the sections in the left pane of Xcode ... <br>  Let's add our own panel in Xcode so that anyone can add their own plugin without thinking about integrating the plugin with the Xcode window. <br><br>  Both previous plugins will be useful here.  At least they were useful to me.  You do not have to suffer with logs, catch endless crashes, understand them and delve into the endless files of headers.  I'll just tell you about the results. <br><br>  We have a window 'NSToolbar', where we will add a button.  The most difficult thing is that the toolbar does not have methods to directly add an element.  Its elements are the "taxis" delegate, which we, of course, cannot override.  The only method that has a toolbar is to add items: <b>insertItemWithItemIdentifier: atIndex:,</b> but the item itself generates a delegate.  The only way out is to see who is the delegate.  Maybe there are some approaches to it?  We deduce the delegate class and get the class 'IDEToolbarDelegate'.  Ok, now we go to private leaders, which we received by class-dump or from XVim, and we are looking for this class there.  Immediately we see the properties of interest to us in this class: <b>toolbarItemProviders</b> and <b>allowedItemIdentifiers</b> .  Presumably, our delegate contains a dictionary of objects that provide the elements.  Print the current content of toolbarItemProviders in the logs and see something like this dictionary: <br><br><pre> <code class="hljs ruby">{ <span class="hljs-string"><span class="hljs-string">"some_id"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:&lt;IDEToolbarItemProxy</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt;, "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">some_other_id</span></span></span><span class="hljs-class">":&lt;IDEToolbarItemProxy </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">&gt;, }</span></span></code> </pre><br>  Great, now we have another clue - this is the 'IDEToolbarItemProxy' class.  We also look at its interface in the header and see that it is initialized with an identifier (most likely the element identifier in 'NSToolbar') and has the <b>providerClass</b> property.  But what kind of <b>providerClass</b> and how do we implement it?  To understand what a given class should contain, there are two ways: <br>  1. Derive these classes and their methods from all providers from the dictionary <b>toolbarItemProviders</b> ; <br>  2. To write an empty class, add it to the dictionary and catch the crashes from Xcode, telling us which methods are missing. <br><br>  I went the second way, although the first, I think more correct.  But when I wrote this plugin, for some reason this idea did not come to me. <br><br>  So, create a class and add it to our delegate: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs ruby">IDEToolbarDelegate *delegate = (IDEToolbarDelegate *)window.toolbar.delegate;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([delegate <span class="hljs-symbol"><span class="hljs-symbol">isKindOfClass:</span></span>NSClassFromString(@<span class="hljs-string"><span class="hljs-string">"IDEToolbarDelegate"</span></span>)]) { IDEToolbarItemProxy * proxy = [[NSClassFromString(@<span class="hljs-string"><span class="hljs-string">"IDEToolbarItemProxy"</span></span>) alloc] <span class="hljs-symbol"><span class="hljs-symbol">initWithItemIdentifier:</span></span>PluginButtonIdentifier];<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      proxy.providerClass = [PluginButtonProvider <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">];</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/    ( ) NSMutableDictionary *d = [NSMutableDictionary dictionaryWithDictionary:delegate.toolbarItemProviders];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    [d setObject:proxy forKey:proxy.toolbarItemIdentifier];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   delegate.toolbarItemProviders = d;/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   NSMutableArray *ar = [NSMutableArray arrayWithArray:delegate.allowedItemIdentifiers];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     [ar addObject:proxy.toolbarItemIdentifier]; delegate.allowedItemIdentifiers = ar; [window.toolbar insertItemWithItemIdentifier:PluginButtonIdentifier atIndex:window.toolbar.items.count];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      }</span></span></code> </pre><br></div></div><br>  Install the plugin, restart Xcode and immediately catch the crash.  We look at the logs and understand that our class needs the <b>+ (id) itemForItemIdentifier method: (id) arg1 forToolbarInWindow: (id) arg2</b> .  This method is described in the 'IDEToolbarItemProvider' protocol.  Remove the plugin, run Xcode and add this method.  By the name of the method, it is clear that at the entrance we get an identifier and a window, and at the output we must receive an object.  By similar manipulations, namely by trial and error, through the N-th number of kreshy and Xcode restarts, you can find out that this is an object of the class 'DVTViewControllerToolbarItem'.  And it in turn is initialized with the class 'DVTGenericButtonViewController'.  The object 'DVTGenericButtonViewController' itself has this initialization: <br>  Prior to version 6 of Xcode: <b>initWithButton: actionBlock: itemIdentifier: window:</b> <br>  From the 6th version: <b>initWithButton: actionBlock: setupTeardownBlock: itemIdentifier: window:</b> <br>  By the name of the method it is clear that he needs a button, a block that is called when it is pressed, an identifier and a window. <br><br>  Create a simple button and initialize the controllers we need: <br><br><div class="spoiler">  <b class="spoiler_title">Code droplet</b> <div class="spoiler_text"><pre> <code class="hljs objectivec">DVTGenericButtonViewController *bvc = [(DVTGenericButtonViewController*)[<span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"DVTGenericButtonViewController"</span></span>) alloc] initWithButton:button actionBlock:^(<span class="hljs-built_in"><span class="hljs-built_in">NSButton</span></span> *sender){} setupTeardownBlock:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> itemIdentifier:PluginButtonIdentifier window:arg2]; DVTViewControllerToolbarItem *c = [ <span class="hljs-built_in"><span class="hljs-built_in">NSClassFromString</span></span>(<span class="hljs-string"><span class="hljs-string">@"DVTViewControllerToolbarItem"</span></span>) toolbarItemWithViewController:bvc];</code> </pre><br></div></div><br>  Install the plugin and restart Xcode.  Now our button is added to Xcode.  It remains to write a handler for our button.  When you click on a button, we want the right panel to open if it is not open, and our object is added to this panel.  Open the right panel and run our first plugin.  After viewing its results, it will become clear that the panel is a 'DVTSplitView' object.  In addition, it is necessary to determine how to programmatically open the right panel, if it is hidden.  To do this, output all 'NSToolbarItem' from the toolbar of our window to the log.  We know that the object that we need is the last one (if our button has not yet been added).  We take the required 'NSToolbarItem' and see who controls it, that is, we look at the 'target' property.  The target of our 'NSToolbarItem' is an object of the class '_IDEWorkspacePartsVisibilityToolbarViewController'.  We do not need to look at its interface, since we only need it in order to find the necessary 'NSToolbarItem' in the window in the future (all of a sudden they will be placed in another sort or someone will add an item to us).  All preparations are ready, now we can display the right panel, find it in the window and add our object to it. <br><br><div class="spoiler">  <b class="spoiler_title">Button processing</b> <div class="spoiler_text"><pre> <code class="hljs ruby">NSWindow *window = arg2; NSToolbarItem *item = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (NSToolbarItem *it <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [[window toolbar] items]) {<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([it.target <span class="hljs-symbol"><span class="hljs-symbol">isMemberOfClass:</span></span>NSClassFromString(@<span class="hljs-string"><span class="hljs-string">"_IDEWorkspacePartsVisibilityToolbarViewController"</span></span>)]) { item = it; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } NSSegmentedControl *control = (NSSegmentedControl *)item.view;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([sender state] == NSOnState) {<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![control <span class="hljs-symbol"><span class="hljs-symbol">isSelectedForSegment:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>]) {<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    [control <span class="hljs-symbol"><span class="hljs-symbol">setSelected:</span></span>YES <span class="hljs-symbol"><span class="hljs-symbol">forSegment:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>];<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     [item.target <span class="hljs-symbol"><span class="hljs-symbol">performSelector:</span></span>item.action <span class="hljs-symbol"><span class="hljs-symbol">withObject:</span></span>control];<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   } DVTSplitView *splitView = [PluginButtonProvider <span class="hljs-symbol"><span class="hljs-symbol">splitViewForWindow:</span></span>window];<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   PanelView *myView = [[PluginPanel sharedPlugin] <span class="hljs-symbol"><span class="hljs-symbol">myViewForWindow:</span></span>window];<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>/     myView.frame = splitView.bounds;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  [myView <span class="hljs-symbol"><span class="hljs-symbol">setAutoresizingMask:</span></span>NSViewWidthSizable <span class="hljs-params"><span class="hljs-params">| NSViewHeightSizable]; </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params"> (NSView *sub </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span><span class="hljs-params"> splitView.subviews) {//      [sub setHidden:YES]; } [splitView addSubview:myView];//   } </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> { DVTSplitView *splitView = [PluginButtonProvider splitViewForWindow:window];//  PanelView *myView = [[PluginPanel sharedPlugin] myViewForWindow:window];///   [myView removeFromSuperview];//     </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params"> (NSView *sub </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span><span class="hljs-params"> splitView.subviews) {//      [sub setHidden:NO]; } }</span></span></code> </pre><br></div></div><br>  Our object will be the object 'NSView', which will contain 'DVTChooserView' and the usual 'NSView', to which the content of the plugin will be added.  Why 'DVTChooserView'?  I would like the panel to be as close as possible to the Xcode window.  To do this, run the first plugin, look at the left panel and find that 'DVTChooserView' is just what we need.  'DVTChooserView' contains 'NSMatrix' with buttons and a good delegate that allows us to determine when this or that button was turned on / off.  Also, this object accepts 'DVTChoice' objects as input and manipulates them.  This is most convenient, given that 'DVTChoice' contains an icon, a signature and an object that will process this object. <br><br><div class="spoiler">  <b class="spoiler_title">Our object and adding items</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">//   DVTChooserView _chooserView = [[NSClassFromString(@"DVTChooserView") alloc] initWithFrame:NSZeroRect]; _chooserView.allowsEmptySelection = <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>; _chooserView.allowsMultipleSelection = <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span>; _chooserView.delegate = self; //  - (<span class="hljs-type"><span class="hljs-type">void</span></span>)chooserView:(DVTChooserView *)<span class="hljs-keyword"><span class="hljs-keyword">view</span></span> userWillSelectChoices:(NSArray *)choices { DVTChoice *choice = [choices lastObject];//   self.contentView = [[choice representedObject] <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>];//   } // DVTChoice    DVTChoice *plugin = note.<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>;//    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (plugin) { NSWindow *<span class="hljs-keyword"><span class="hljs-keyword">window</span></span> = [[note userInfo] objectForKey:PluginPanelWindowNotificationKey];//     PanelView *panel = [self myViewForWindow:<span class="hljs-keyword"><span class="hljs-keyword">window</span></span>];//     [panel.chooserView.mutableChoices addObject:plugin];//   DVTChooserView <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!panel.contentView) { panel.contentView = [[[[panel.chooserView mutableChoices] lastObject] representedObject] <span class="hljs-keyword"><span class="hljs-keyword">view</span></span>];//   ,    } }</code> </pre><br></div></div><br>  That's all.  We walked through the most interesting places of our third plugin.  All sources are <a href="https://github.com/AlexIzh/PluginPanel">here</a> . <br><br><h3>  Add a plugin to our panel </h3><br>  We have just added a whole panel to Xcode.  Now let's fill it up with something. <br><br>  Due to the fact that we do not need to understand the intricacies of Xcode, we can add our plugin to the panel with just three lines of code. <br><br><div class="spoiler">  <b class="spoiler_title">Three magic lines</b> <div class="spoiler_text"><pre> <code class="hljs lua">NSImage *image = <span class="hljs-string"><span class="hljs-string">[[NSImage alloc] initWithContentsOfFile:[[NSBundle bundleForClass:[self class]] pathForImageResource:@"plugin_icon"]]</span></span>;//     // ,    . <span class="hljs-number"><span class="hljs-number">1</span></span>-  TPViewController *c = <span class="hljs-string"><span class="hljs-string">[[TPViewController alloc] initWithNibName:@"TPView" bundle:[NSBundle bundleForClass:self.class]]</span></span>; // DVTChoice    . <span class="hljs-number"><span class="hljs-number">2</span></span>-  DVTChoice *choice = <span class="hljs-string"><span class="hljs-string">[[NSClassFromString(@"DVTChoice") alloc] initWithTitle:@"Time" toolTip:@"Time management plugin" image:image representedObject:c]; //   ,        . 3-  PluginPanelAddPlugin(choice, [[note userInfo] objectForKey:PluginPanelWindowNotificationKey]);</span></span></code> </pre><br></div></div><br>  Now we have our own panel in the Xcode window and we can add any plugin to it.  Now part of the plug-ins can be located in one place. <br><br>  Finally - an example of using the panel - a simple time tracker for Xcode. <br><br>  <a href="https://github.com/AlexIzh/TimePlugin">Timeplugin</a> <br><br><img src="https://habrastorage.org/files/75a/3bc/695/75a3bc695fb344ac8d635765903b6689.png"></div><p>Source: <a href="https://habr.com/ru/post/256015/">https://habr.com/ru/post/256015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256001/index.html">Work with error messages - git</a></li>
<li><a href="../256005/index.html">Big Data Week Moscow 2015: learn about the big data industry from the inside</a></li>
<li><a href="../256009/index.html">New life shooting gallery</a></li>
<li><a href="../256011/index.html">Character LCD display (Video Lesson 1)</a></li>
<li><a href="../256013/index.html">Why did PayPal replace VMware with OpenStack?</a></li>
<li><a href="../256017/index.html">Super anthill on ClojureCLR</a></li>
<li><a href="../256021/index.html">What is the HL7 Continuity of Care Document (CCD)</a></li>
<li><a href="../256023/index.html">The task of the sages. Decision</a></li>
<li><a href="../256027/index.html">Cut and copy to buffer using javascript</a></li>
<li><a href="../256029/index.html">Report by Alexey Bragin at the Russian Open Source Summit 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>