<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Billing in SaaS applications on Ruby on Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developers are faced with the question of subscription implementation, as was the case with us when developing LPCloud , many use ready-made solu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Billing in SaaS applications on Ruby on Rails</h1><div class="post__text post__text-html js-mediator-article">  When developers are faced with the question of subscription implementation, as was the case with us when developing <a href="https://lpcloudapp.com/">LPCloud</a> , many use ready-made solutions, such as <a href="https://recurly.com/">recurly.com</a> , <a href="https://chargify.com/">chargify.com</a> , <a href="https://spreedly.com/">spreedly.com</a> , etc. They have, of course, their pros and cons, but we could not find a suitable service that would satisfy us on all factors and we decided to write our own system of regular payments.  We chose <a href="http://cloudpayments.ru/">cloudpayments.ru</a> as the processing of maps <a href="http://cloudpayments.ru/">.</a> <br><br>  For the convenience of working with payment by cards, we started the well-known gem <a href="http://github.com/Shopify/active_merchant">activemerchant</a> from Shopify, but faced such a dilemma - activemerchant did not support cloudpayments.  We quickly solved this problem by finishing the heme, it is available on our <a href="http://github.com/softeamco/active_merchant">githaba</a> account. <br><br><h4>  In short </h4><br>  We needed a system that would have the following capabilities: <br><ul><li>  The ability to bind user cards </li><li>  Monthly / annual billing </li><li>  Customized trial period for users </li><li>  The ability to update the tariff by the client at any time </li></ul><br><a name="habracut"></a><br>  We do not store our clients' card data, but instead, on the side of cloudpayments, their tokens are created, which are stored in the <code>Account</code> model.  These tokens are useless without our public_id and secret password in cloudpayments 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      app / models / account.rb <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Account</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mongoid::Document</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mongoid::Timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Enumerize</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># associations belongs_to :user, index: true # fields field :card_first_six, type: String field :card_last_four, type: String field :card_type, type: String field :issuer_bank_country, type: String field :token, type: String field :card_exp_date, type: String # validations validates :card_first_six, :card_last_four, :card_type, :user, presence: true end</span></span></span></span></code> </pre><br><br><h4>  Save the map </h4><br>  Cloudpayments do not transmit card data to the server, you must first generate a card cryptogram on the client, with which you can later make a payment and receive a <code>token</code> card in the response to the result of the payment. <br><br><h5>  View </h5><br>  To make our own card entry form, we used the Cloudpay <a href="http://cloudpayments.ru/Docs/Checkout">checkout</a> script.  Just follow the documentation ... <br><br>  We connect the js file to the page: <br><pre> <code class="javascript hljs">&lt;script src=<span class="hljs-string"><span class="hljs-string">"https://widget.cloudpayments.ru/bundles/checkout"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  Create a form for entering card data, you can customize the appearance of the form <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"paymentFormSample"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autocomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-cp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cardNumber"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-cp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-cp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"expDateMonthYear"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-cp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cvv"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Card data entry fields must be marked with attributes: <br><pre> <code class="html hljs xml">data-cp="cardNumber" ‚Äî     data-cp="name" ‚Äî     data-cp="expDateMonthYear" ‚Äî       MMYY data-cp="expDateMonth" ‚Äî      data-cp="expDateYear" ‚Äî      data-cp="cvv" ‚Äî    CVV</code> </pre><br><br>  This is how our form looks like. <br><img src="https://habrastorage.org/files/5a2/f9a/4e8/5a2f9a4e8fad46d3b5975eab8a015d58.jpg"><br><br>  To protect the user from entering incorrect data, we recommend using the plugin <a href="https://github.com/stripe/jquery.payment">jquery.payment</a> from Stripe. <br><br>  Next, you need to register a script that generates a cryptogram of the card and sends it to the server for making the first payment.  The algorithm of actions is as follows: first, we send the cryptogram to the server and make the first payment, in a successful response we receive the token cards and write it in the Account, then use this token for subsequent payments. <br><br><pre> <code class="javascript hljs">createCryptogram = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = checkout.createCryptogramPacket(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.success) { cryptogram = result.packet <span class="hljs-comment"><span class="hljs-comment">//  ,        purchase,    success,   ,    3ds } }; $(function () { /*  checkout */ checkout = new cp.Checkout( // public id    "test_api_00000000000000000000001", // ,     document.getElementById("paymentFormSample")); });</span></span></code> </pre><br><br><h5>  Controller </h5><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">purchase</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_user</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">account</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">present?</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">options</span></span></span><span class="hljs-function"> = { :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IpAddress</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ip</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AccountId</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_user</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Name</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">params</span></span></span><span class="hljs-function">[:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-function">], :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JsonData</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">params</span></span></span><span class="hljs-function">[:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function">], </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updating_card</span></span></span><span class="hljs-function"> }.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_json</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Currency</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_subscription</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currency</span></span></span><span class="hljs-function">, :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Description</span></span></span><span class="hljs-function"> =</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">&gt;</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Storing</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">details</span></span></span><span class="hljs-function">" } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current_subscription</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plan</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Plan</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(params[</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:plan</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> params[<span class="hljs-symbol"><span class="hljs-symbol">:plan</span></span>].present? amount = updating_card ? <span class="hljs-number"><span class="hljs-number">1</span></span> : current_subscription.amount response = gateway.purchase(params[<span class="hljs-symbol"><span class="hljs-symbol">:cryptogram</span></span>], amount, options, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-comment"><span class="hljs-comment"># making response as action controller params </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment"> = parametrize(response.params) if response.success? resp = { json: success_transaction(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">) } else # if 3d-secure needed if </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment"> and </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">['PaReq'].present? resp = { json: { response: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@params</span></span></span><span class="hljs-comment">, type: '3ds' }, status: 422 } else resp = { json: { response: response, type: 'error' }, status: 422 } end end render resp end private def gateway ActiveMerchant::Billing::CloudpaymentsGateway.new(public_id: configatron.cloudpayments.public_id, api_secret: configatron.cloudpayments.api_secret) end</span></span></code> </pre><br>  This method is the first payment or update of billing information.  If this is the first payment, the money will be written off according to the tariff, if the user simply updates the card, then we authorize 1 ruble on his account (if the operation is successful, then the ruble will be released immediately).  In both cases, we receive new card data in the response about the operation, including the token, expiration date and the first 6 and last 4 digits of the card number and write it to the user. <br><br><h4>  Recurrent part </h4><br>  The subscription information of the user is stored in the Subscription model.  This model has an important field <code>next_payment_due</code> , which stores the date of the next payment. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mongoid::Document</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mongoid::Timestamps</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AASM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extend</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Enumerize</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">belongs_to</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_many</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transactions</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dependent</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">restrict</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_scope</span></span></span><span class="hljs-class"> -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">order_by</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aasm_state</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_charge_error</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_payment_due</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Date</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trial_due</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Date</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">failed_transactions_number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">: 0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">successful_transactions_number</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">: 0 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">field</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan_duration</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enumerize</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan_duration</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in</span></span></span><span class="hljs-class">: [:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">month</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">year</span></span></span><span class="hljs-class">], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">month</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">predicates</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">billable</span></span></span><span class="hljs-class">, -&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">or</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aasm_state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">active</span></span></span><span class="hljs-class">'}, {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aasm_state</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">past_due</span></span></span><span class="hljs-class">'}) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">billable_on</span></span></span><span class="hljs-class">, -&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_payment_due</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trial_due_on</span></span></span><span class="hljs-class">, -&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trial_due</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan_duration</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">presence</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># callbacks before_validation :set_trial, on: :create # [...] def gateway ActiveMerchant::Billing::CloudpaymentsGateway.new(public_id: configatron.cloudpayments.public_id, api_secret: configatron.cloudpayments.api_secret) end #     ,         def amount if plan_duration.year? user.language.ru? ? plan.clear_price(plan.year_price_rub) : plan.clear_price(plan.year_price_usd) else user.language.ru? ? plan.clear_price(plan.price_rub) : plan.clear_price(plan.price_usd) end end def account user.account end #   def renew! opts = {:Currency =&gt; currency, :AccountId =&gt; user.email} response = gateway.purchase(account.token, amount, opts) update_subscription! response end def currency user.language.ru? ? 'RUB' : 'USD' end def update_subscription!(response) if response.success? activate_subscription! else logger.error "****Subscription Error****" logger.error response.message self.next_payment_due = self.next_payment_due + configatron.retry_days_number #       n- self.last_charge_error = response.message self.failed_transactions_number += 1 #   n   ‚Äì ,  n+1  ‚Äì    ,     if self.failed_transactions_number &lt; configatron.retry_number self.past_due! || self.save! else self.to_pending! do UserMailer.delay.subscription_cancelled(self.user.id) end end end record_transaction!(response.params) end #  ,  ,      (,       1 .   , ..   ) def activate_subscription!(plan=nil, params=nil) record_transaction!(params) if params.present? self.plan = Plan.find(plan) if plan.present? self.last_charge_error = nil self.next_payment_due = next_billing_date(next_payment_due) self.failed_transactions_number = 0 self.successful_transactions_number += 1 self.activate! # Saves next_payment_due too end #     def next_billing_date(date=Date.today) date ||= Date.today period = plan_duration.month? ? 1.month : 1.year date + period end #     def self.renew! billable.billable_on(Date.today).each do |subscription| subscription.renew! end end #    trial   pending    ,     ‚Äì   active def self.pending! trial.trial_due_on(Date.today).each do |subscription| subscription.to_pending! do UserMailer.delay.trial_over(subscription.user.id) end end end private def set_trial self.trial_due = Date.today + configatron.trial end def record_transaction!(params) transactions.create! cp_transaction_attrs(params) end def cp_transaction_attrs(attrs) attrs = ActionController::Parameters.new attrs p = attrs.permit(:TransactionId, :Amount, :Currency, :DateTime, :IpAddress, :IpCountry, :IpCity, :IpRegion, :IpDistrict, :Description, :Status, :Reason, :AuthCode).transform_keys!{ |key| key.to_s.underscore rescue key } p[:status] = p[:status].underscore if p[:status].present? p[:reason] = p[:reason].titleize if p[:reason].present? p[:date_time] = DateTime.parse(attrs[:CreatedDateIso]) if attrs[:CreatedDateIso].present? p end end</span></span></span></span></code> </pre><br><br>  As you probably expected in the center of recurrent payments lies cron (or the like).  With the help of a great <a href="https://github.com/javan/whenever">gem whenever</a> we set up a launch task, which checks who should pay for the subscription today and who has the trial period ending today.  If such subscriptions are found, the system sends an email stating that the trial period is over, and if the card is linked to LPCloud, the system makes a payment. <br><br>  config / schedule.rb <br><pre> <code class="ruby hljs">every <span class="hljs-symbol"><span class="hljs-symbol">:day</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">at:</span></span> <span class="hljs-string"><span class="hljs-string">'0:00 am'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> runner <span class="hljs-string"><span class="hljs-string">"Subscription.renew!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> every <span class="hljs-symbol"><span class="hljs-symbol">:day</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">at:</span></span> <span class="hljs-string"><span class="hljs-string">'0:00 am'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> runner <span class="hljs-string"><span class="hljs-string">"Subscription.pending!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><h4>  Interface </h4><br>  Obviously, when it comes to money, you need to be transparent.  We display information about payments to the user: status, amount, date and previous payments. <br><br><img src="//habrastorage.org/files/5aa/593/f8e/5aa593f8e8654100b20338c2105fb4dd.png"><br><br>  We also display information about the linked card and the ability to pump or lower the tariff. <br><br><img src="//habrastorage.org/files/ca8/791/788/ca8791788f0f458da31696d1a5fe8c3b.png"><br><br>  If the client changes the tariff, then on the next billing day the price of the new tariff will be charged to the customer. <br><br><h4>  Conclusion </h4><br>  The most difficult moment of implementation was architecture design, since  We did this for the first time.  Our implementation is not perfect and will not suit everyone, but we hope that this article will give you a couple of ideas when developing your own recurring payment system.  We did not touch upon the topic of 3ds authorization - we promise to tell about it in the next article.  We will be happy if you share your experiences in the comments. </div><p>Source: <a href="https://habr.com/ru/post/236453/">https://habr.com/ru/post/236453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236439/index.html">How to use color psychology to increase conversion</a></li>
<li><a href="../236441/index.html">Choosing a static site generator</a></li>
<li><a href="../236447/index.html">Problems finding memory leaks in a web app using Chrome DevTools</a></li>
<li><a href="../236449/index.html">Legacy phobia</a></li>
<li><a href="../236451/index.html">Scripts for the editor in Unity3D</a></li>
<li><a href="../236455/index.html">Hours on Bezier curves</a></li>
<li><a href="../236459/index.html">How is it? Leapmotion</a></li>
<li><a href="../236461/index.html">Retro gadget of the late 80s helped parents to force children to learn</a></li>
<li><a href="../236465/index.html">Innovation, security and personal computer</a></li>
<li><a href="../236467/index.html">Yesterday's powerful solar flare could trigger northern lights in mid-latitudes.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>