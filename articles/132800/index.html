<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fakeroot, XCode and PackageMaker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share my experience in adapting fakeroot for use on a Mac in conjunction with Xcode. Fakeroot runs programs in a special environment that em...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fakeroot, XCode and PackageMaker</h1><div class="post__text post__text-html js-mediator-article">  I want to share my experience in adapting <a href="http://man.cx/fakeroot(1)">fakeroot</a> for use on a Mac in conjunction with Xcode.  Fakeroot runs programs in a special environment that emulates a super-user session.  Root rights may be required when building the installer using PackageMaker. <br><br><a name="habracut"></a>  Historically, UNIX-like systems, including Mac OS X, have developed a certain approach to the distribution of software.  At the core of any <i>package</i> , be it deb, rpm or macOS pkg, is an archive that is deployed directly to the target file system.  For example, if the package litware.pkg is deployed to the / usr / local / bin folder, and the archive contains the executable file lit with the access mask 0755 and the owner / group root: wheel, then the program will appear / usr / local / bin / lit (mask access 0755, owner / group root: wheel, ie the same as in the archive). <br><br>  The package is created using special utilities (on Mac OS X, this is the console <a href="http://www.manpagez.com/man/1/packagemaker/">packagemaker</a> ).  The utility puts into the package the contents of the folder that is specified at startup.  The contents of the folder are included in the package as is.  In particular, to make the correct litware.pkg, you must set the lit file by the owner root: wheel.  Unfortunately, the success of this operation requires super user rights. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Linux, this problem is bypassed using fakeroot.  In fact, the programs are launched on behalf of the current user, but due to the interception of a number of system calls, the appearance of working as root is created.  For example, chown and stat are intercepted.  Chown successfully changes the owner: group file, and instead of actually modifying these fields on the file system (which would require a real root), the faked daemon remembers the information.  The captured stat silently modifies the file parameters received from the file system based on the stored information about previous chown calls. <br><br><h4>  Fakeroot-mini </h4><br>  <a href="https://github.com/mackyle/fakeroot">Fakeroot</a> supports MacOS X up to version 10.7 inclusive.  Unfortunately, fakeroot is missing from both popular port managers for Mac OS X ( <a href="http://www.macports.org/">MacPorts</a> , <a href="http://www.finkproject.org/">Fink</a> ).  For correct work installation is necessary.  In addition, classic fakeroot is inconvenient in conjunction with Xcode, since it is not possible to combine all scripts that require fakeroot into one fakeroot session.  Different fakeroot sessions are completely independent: changes made in one session are not visible in another. <br><br>  Based on the fakeroot code, I made a modified version of <a href="https://github.com/mejedi/fakeroot-mini">fakeroot-mini</a> with the following key features: <br><ol><li>  Does not require installation.  The only dynamic library is distributed.  This library can be put directly into the repository, which removes the need to install additional software for building the project. </li><li>  Stores information in extended file system attributes.  This solution fixes the problem of independent fakeroot sessions. </li></ol><br>  The principle of operation remains unchanged - a dynamic library that intercepts system calls is introduced into the programs being launched.  The introduction of the library into the process is the regular feature of the dynamic loader, which is activated using the DYLD_INSERT_LIBRARIES environment variable: <br><br><pre><code class="hljs xml">/usr/bin/env DYLD_INSERT_LIBRARIES=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">-</span></span></span><span class="hljs-tag">&gt;</span></span> command [args]</code> </pre> <br><br><h4>  Demo Xcode project </h4><br>  Under the <a href="">link</a> you can download a demo project for Xcode.  The project builds a simple console application + installer. <br><br><img src="https://habrastorage.org/storage1/04cffb9e/9c00a4bd/82fbd586/9e7dd619.png"><br><br>  Project Settings: <br><br><pre> <code class="hljs objectivec">DEPLOYMENT_LOCATION=<span class="hljs-literal"><span class="hljs-literal">YES</span></span> DEPLOYMENT_POSTPROCESSING=<span class="hljs-literal"><span class="hljs-literal">YES</span></span> INSTALL_OWNER=root INSTALL_GROUP=wheel STRIP_INSTALLED_PRODUCT=<span class="hljs-literal"><span class="hljs-literal">NO</span></span> CHOWN=$(SRCROOT)/chown LIBFAKER=$(SRCROOT)/libfakermini<span class="hljs-number"><span class="hljs-number">-1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.dylib PACKAGE=$(BUILT_PRODUCTS_DIR)/litware.pkg</code> </pre> <br>  <code>DEPLOYMENT_LOCATION=YES</code> forces Xcode to decompose files by installation paths.  For example, for the program lit, the installation path is / usr / local / bin / lit.  With the DEPLOYMENT_LOCATION setting turned on, Xcode will put lit on the path $ (DSTROOT) / usr / local / bin / lit.  The value of $ (DSTROOT) is configured, by default it is /tmp/&lt;project name&gt;.dst.  The following file tree will be built in the temporary folder: <br><br><pre> <code class="hljs pgsql">/tmp/litware.dst/ ‚îî‚îÄ‚îÄ usr    ‚îú‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>    ‚îÇ   ‚îî‚îÄ‚îÄ bin    ‚îÇ       ‚îî‚îÄ‚îÄ lit    ‚îî‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">share</span></span>        ‚îî‚îÄ‚îÄ man            ‚îî‚îÄ‚îÄ man1                ‚îî‚îÄ‚îÄ lit<span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre> <br>  <code>DEPLOYMENT_POSTPROCESSING=YES</code> includes additional file processing in $ (DSTROOT).  Among other things, the owner of the $ (INSTALL_OWNER) and group $ (INSTALL_GROUP) files are set. <br><br>  <code>STRIP_INSTALLED_PRODUCT=NO</code> disables the removal of debug information in the collected binaries.  Due to an error in Xcode, sometimes when rebuilding a project, debugging information is copied after it has completed strip and deleted everything. <br><br>  <code>CHOWN=$(SRCROOT)/chown</code> tells Xcode to use the script in the project source folder instead of the standard utility / usr / sbin / chown.  The script sets up the fakeroot environment and calls the standard chown. <br><br>  The variables LIBFAKER and PACKAGE are defined for convenience, they do not affect the behavior of Xcode. <br><br>  The installer is made using the following script: <br><br><pre> <code class="bash hljs">/usr/bin/env <span class="hljs-string"><span class="hljs-string">"DYLD_INSERT_LIBRARIES=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${LIBFAKER}</span></span></span><span class="hljs-string">"</span></span> \    /usr/sbin/mtree -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SRCROOT}</span></span></span><span class="hljs-string">/mtree.spec"</span></span> -p <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DSTROOT}</span></span></span><span class="hljs-string">"</span></span> -U &amp;&amp; \ rm -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${PACKAGE}</span></span></span><span class="hljs-string">"</span></span> &amp;&amp; \ /usr/bin/env <span class="hljs-string"><span class="hljs-string">"DYLD_INSERT_LIBRARIES=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${LIBFAKER}</span></span></span><span class="hljs-string">"</span></span> \    /Developer/usr/bin/packagemaker --id org.example.litware \    --root <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DSTROOT}</span></span></span><span class="hljs-string">"</span></span> --no-recommend --target 10.5 \    --out <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${PACKAGE}</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br>  First, <a href="http://developer.apple.com/library/mac/">mtree is</a> launched in the fakeroot environment to configure the access mask and the owner / group for folders in $ (DSTROOT).  This is necessary because although Xcode configures the access mask and owner / group for $ (DSTROOT) / usr / local / bin / lit, intermediate folders (ex: $ (DSTROOT) / usr / local / bin) are not processed. <br><br>  For some unknown reason, packagemaker does not overwrite existing files when generating an installer.  Therefore, we explicitly delete the existing installer file, if present, before running packagemaker in a fakeroot environment. <br><br><h4>  Conclusion </h4><br>  The described technology allows you to create installers directly in XCode, with a minimum of settings and without installing additional software.  A number of tasks in the manufacture of the installer requires superuser rights.  Fakeroot allows you to successfully perform these tasks to an unprivileged user. <br><br>  Information may be useful to developers of system utilities and daemons for MacOS.  The installer for regular user applications can usually be built without fakeroot. <br><br><h5>  Links </h5><ol><li>  Demo <a href="">project</a> for Xcode </li><li>  Original <a href="https://github.com/mackyle/fakeroot">fakeroot</a> </li><li>  <a href="https://github.com/mejedi/fakeroot-mini">Fakeroot-mini</a> </li><li>  <a href="http://robnapier.net/blog/build-system-1-build-panel-360">Using</a> xcconfig files in Xcode </li><li>  <a href="http://habrahabr.ru/blogs/macosxdev/115558/">Interception of</a> system calls in Mac OS X </li></ol><br></div><p>Source: <a href="https://habr.com/ru/post/132800/">https://habr.com/ru/post/132800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132794/index.html">Five ways to speed up Facebook API requests in practice</a></li>
<li><a href="../132795/index.html">Another ardent greetings to the masters of the pirate</a></li>
<li><a href="../132796/index.html">Introducing Evernote Clearly: reading from the screen is now convenient</a></li>
<li><a href="../132798/index.html">Quality Monitor - Increase Development Pleasure</a></li>
<li><a href="../132799/index.html">"Classic" friendly url in ASP.NET MVC</a></li>
<li><a href="../132801/index.html">BrandMaker at Commerzbank - working with corporate style</a></li>
<li><a href="../132802/index.html">Personal messages in MODx Revolution</a></li>
<li><a href="../132803/index.html">In Sheremetyevo via Skype</a></li>
<li><a href="../132804/index.html">Questions for Nikon</a></li>
<li><a href="../132805/index.html">Processing a user-filled form: how to reduce code complexity?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>