<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C #: Internal structure of array initializers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely almost everyone who dealt with C #, is known for a similar construction: 



int[] ints = new int[3] { 1,2,3 };// ,   
 It was quite logical to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C #: Internal structure of array initializers</h1><div class="post__text post__text-html js-mediator-article">  Surely almost everyone who dealt with C #, is known for a similar construction: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] { <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> };<span class="hljs-comment"><span class="hljs-comment">//       ,      </span></span></code> </pre> <br>  It was quite logical to expect that this construction would turn into something like this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; ints[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; ints[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; ints[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre><br>  Alas, in fact, the nut is much more wrinkled than it seems at first glance, and there are some subtleties that will be indicated later.  And until then, put on a worn ‚ÄúIL freak‚Äù jersey (who has one) and dive into the depths of implementation. <br><a name="habracut"></a><br>  Ultimately, the first construction will turn the compiler into such a squiggle: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/063/43e/dfe/06343edfed6d4b05ae24a3547c895bdc.png"><br><br>  What a miracle in my garden?  What is this <b>blablabla bullshit &lt;PrivateImplementationDetails&gt;</b> ?  Before I explain what's what, let's take a look at <b>Q</b> :: <b>Main</b> , where I indicated a value at the top of the stack before each line of code: <br><br><pre> <code class="hljs pgsql">.<span class="hljs-keyword"><span class="hljs-keyword">method</span></span> private hidebysig static <span class="hljs-type"><span class="hljs-type">void</span></span> Main() cil managed { .entrypoint // Code size <span class="hljs-number"><span class="hljs-number">20</span></span> (<span class="hljs-number"><span class="hljs-number">0x14</span></span>) .maxstack <span class="hljs-number"><span class="hljs-number">3</span></span> .locals init (int32[] V_0) IL_0000: nop // {} IL_0001: ldc.i4<span class="hljs-number"><span class="hljs-number">.3</span></span> // {<span class="hljs-number"><span class="hljs-number">3</span></span>} IL_0002: newarr [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Int32 // {&amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]} IL_0007: dup // {&amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>], &amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]} IL_0008: ldtoken field valuetype <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>/<span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>::<span class="hljs-string"><span class="hljs-string">'$$method0x6000001-1'</span></span> // {&amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>], &amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>], #<span class="hljs-string"><span class="hljs-string">'$$method0x6000001-1'</span></span>} IL_000d: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.CompilerServices.RuntimeHelpers::InitializeArray(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>, valuetype [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.RuntimeFieldHandle) // {&amp;<span class="hljs-type"><span class="hljs-type">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]} IL_0012: stloc<span class="hljs-number"><span class="hljs-number">.0</span></span> // {} IL_0013: ret } // <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> Q::Main</code> </pre><br>  Let's now perform line-by-line analysis: <br>  <i>IL_0001</i> and <i>IL_0002</i> - a new array of type <b>System.Int32</b> and dimension 3 is created. <br>  On <i>IL_0007,</i> we come across the first surprise in the form of a duplicate array reference.  Why?  Suppose that the <i>array</i> is initialized on <i>IL_0008</i> and <i>IL_0009</i> (very soon we will return to this place).  And now let's look at <i>IL_0012</i> , where the value at the top of the stack ‚Äî again the array ‚Äî is assigned to a local variable with index 0, i.e.  variable <b>ints</b> .  What if we assign the value of the <b>ints</b> variable to <i>IL_0007</i> ?  And this is what will happen: <br><br><pre> <code class="hljs pgsql">ldc.i4<span class="hljs-number"><span class="hljs-number">.3</span></span> newarr [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Int32 stloc<span class="hljs-number"><span class="hljs-number">.0</span></span> //  ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> //  ldtoken field valuetype <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>/<span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>::<span class="hljs-string"><span class="hljs-string">'$$method0x6000001-1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.CompilerServices.RuntimeHelpers::InitializeArray(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>, valuetype [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.RuntimeFieldHandle)</code> </pre><br>  The assignment will no longer be atomic: from now on, the external observer will notice the array in the uninitialized state, without elements.  This is exactly what the <i>IL_0008</i> and <i>IL_0009</i> lines <i>do</i> .  So  The code given at the very beginning is <u>not equivalent to the</u> construction: <br><br><pre> <code class="hljs cs">nt[] ints = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; ints[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; ints[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; ints[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre><br>  But rather is something like this: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; t[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; t[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; t[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ints = t;</code> </pre><br>  Although the implementation avoids creating two local variables.  This moves us to two abstruse lines of code: <br><br><pre> <code class="hljs pgsql"> IL_0008: ldtoken field valuetype <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>/<span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>::<span class="hljs-string"><span class="hljs-string">'$$method0x6000001-1'</span></span> IL_000d: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.CompilerServices.RuntimeHelpers::InitializeArray(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>, valuetype [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.RuntimeFieldHandle)</code> </pre><br>  But there is nothing difficult and / or terrible about it.  In essence, we observe a call to <a href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.runtimehelpers.initializearray%2528v%3Dvs.110%2529.aspx">RuntimeHelpers.InitializeArray</a> , which fills the field, the token of which is <i>pushed</i> onto the stack on <i>IL_0008</i> , with an array referenced at the top of the stack after executing <i>IL_0007</i> .  The value of the token corresponds to the picture below: <br><br><img src="https://habrastorage.org/files/fda/f46/65f/fdaf4665faa24b598195afc13081457f.png"><br><br>  In fact, the leased line is a static field in a private and, obviously, generated by the compiler, a class with an obviously unpronounceable name.  A couple of points to pay attention to.  First, this class has a nested class called <b>__StaticArrayInitTypeSize = 12</b> .  It is an array of actual size of <u>12 bytes</u> (4 bytes for each <b>System.Int32</b> element, the size of each is 4 bytes, a total of 12).  Secondly, it should be noted that the type inherits <b>System.ValueType</b> (I seriously hope that readers are familiar with the fate of instances of significant types after they are created on the stack, so let's not get stuck on it - <i>note the author.</i> ).  But how does the type get those 12 bytes?  Obviously, just slipping the name is not enough for clr to allocate the necessary amount of memory, so if you look at the implementation through ILDASM you will see this: <br><br><pre> <code class="hljs pgsql">.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> private auto ansi <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span> extends [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> { .custom instance <span class="hljs-type"><span class="hljs-type">void</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.CompilerServices.CompilerGeneratedAttribute::.ctor() = ( <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ) .<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> explicit ansi sealed nested private <span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> extends [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.ValueType { .pack <span class="hljs-number"><span class="hljs-number">1</span></span> .size <span class="hljs-number"><span class="hljs-number">12</span></span> //    } // <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> .field static assembly valuetype <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span>/<span class="hljs-string"><span class="hljs-string">'__StaticArrayInitTypeSize=12'</span></span> <span class="hljs-string"><span class="hljs-string">'$$method0x6000001-1'</span></span> at I_00002050 } // <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-9303FE2DD066}'</span></span></code> </pre><br>  The <b>.size</b> directive tells both us and clr that it is necessary to allocate a block of memory of 12 bytes at the time of the creation of an instance of this type.  If you are curious about the role of the <b>.pack</b> directive, then the essence is simple: this directive indicates alignment with the specified power of two (only values ‚Äã‚Äãfrom 2 to 128 are supported (obviously, there is no alignment with 1 meaning - <i>approx. Trans</i> )).  Required for COM compatibility.  Let's return to the field: <br><br><pre> <code class="hljs 1c">.field static assembly valuetype '&lt;PrivateImplementationDetails&gt;{8C802ECE-B24C-4A20-AE34-<span class="hljs-number"><span class="hljs-number">9303</span></span>FE2DD066}'/'__StaticArrayInitTypeSize=12' '$$method0x<span class="hljs-number"><span class="hljs-number">600000</span></span>1-1' at I_00002050</code> </pre><br><br>  The type is rather simple, despite the fact that the name is rather long due to the type nesting.  In our case, <b>$$ method0x6000001-1</b> is the name of the field.  But the fun begins after the " <b>at</b> ".  This is the so-called.  <b>The data label</b> , which, in turn, is a piece of data somewhere in the PE file at a given offset.  Directly in ILADSM you will see something like this: <br><br><pre> <code class="hljs haskell">.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> cil </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I_00002050</span></span></span><span class="hljs-class"> = bytearray ( 01 00 00 00 02 00 00 00 03 00 00 00)</span></span></code> </pre><br>  This is the <b>data label</b> advertisement, which is, as already seen, the byte sequence of the final array in little-endian.  Now we need to understand how <a href="http://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.runtimehelpers.initializearray%2528v%3Dvs.110%2529.aspx">InitailizeArray</a> works: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Runtime</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.CompilerServices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.RuntimeHelpers</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::InitializeArray(class</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Array</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">valuetype</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.RuntimeFieldHandle</span></span>)</code> </pre><br>  An instance of the array is transmitted (we have already created it with the commands <i>IL_0001</i> , <i>IL_0002</i> ) and a pointer to the field specified after the keyword " <b>at</b> ", into which the array data is wrapped.  So  runtime is able to calculate the required number of bytes to read at a given address, thus constructing an array.  In turn, the meaning of the value <b>I_0000 <u>2050</u></b> does not constitute any mystery - it is the most ordinary <a href="http://en.wikipedia.org/wiki/COFF">RVA</a> .  You can verify this using dumpbin: <br><br><img src="https://habrastorage.org/files/101/4a2/0dc/1014a20dc8a6402da4464d30122cde7c.png" align="left">  But there is an equally interesting detail: the compiler re- <b>uses the</b> type <b>__StaticArrayInitTypeSize</b> when arrays take up the same amount of memory space.  So  listing: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ints = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>[] longs = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">29</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span> };</code> </pre><br>  Makes the compiler use the same type, because all arrays in memory occupy 32 bytes each: <br><br><pre> <code class="hljs 1c">.field static assembly valuetype '&lt;PrivateImplementationDetails&gt;{AA6C9D77-5FAD-47E0-8B55-1D<span class="hljs-number"><span class="hljs-number">873907</span></span>4F1F}'/'__StaticArrayInitTypeSize=32' '$$method0x<span class="hljs-number"><span class="hljs-number">600000</span></span>1-1' at I_00002050 .field static assembly valuetype '&lt;PrivateImplementationDetails&gt;{AA6C9D77-5FAD-47E0-8B55-1D<span class="hljs-number"><span class="hljs-number">873907</span></span>4F1F}'/'__StaticArrayInitTypeSize=32' '$$method0x<span class="hljs-number"><span class="hljs-number">600000</span></span>1-2' at I_00002070 .field static assembly valuetype '&lt;PrivateImplementationDetails&gt;{AA6C9D77-5FAD-47E0-8B55-1D<span class="hljs-number"><span class="hljs-number">873907</span></span>4F1F}'/'__StaticArrayInitTypeSize=32' '$$method0x<span class="hljs-number"><span class="hljs-number">600000</span></span>1-3' at I_00002090 .data cil I_00002050 = bytearray ( <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>) .data cil I_00002070 = bytearray ( <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>) .data cil I_00002090 = bytearray ( <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>A <span class="hljs-number"><span class="hljs-number">0</span></span>B <span class="hljs-number"><span class="hljs-number">0</span></span>C <span class="hljs-number"><span class="hljs-number">0</span></span>D <span class="hljs-number"><span class="hljs-number">0</span></span>E <span class="hljs-number"><span class="hljs-number">0</span></span>F <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>A <span class="hljs-number"><span class="hljs-number">1</span></span>B <span class="hljs-number"><span class="hljs-number">1</span></span>C <span class="hljs-number"><span class="hljs-number">1</span></span>D <span class="hljs-number"><span class="hljs-number">1</span></span>E <span class="hljs-number"><span class="hljs-number">1</span></span>F <span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre><br>  Also, for arrays with sizes of 1 and 2 <u>elements</u> , this IL code will generate: <br><pre> <code class="hljs ruby">.method private hidebysig static void Main() cil managed { .entrypoint /<span class="hljs-regexp"><span class="hljs-regexp">/ Code size 19 (0x13) .maxstack 3 .locals init (int32[] V_0, int32[] V_1) IL_0000: nop IL_0001: ldc.i4.2 IL_0002: newarr [mscorlib]System.Int32 IL_0007: stloc.1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ V_1[0] = 1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ IL_0008: ldloc.1 IL_0009: ldc.i4.0 IL_000a: ldc.i4.1 IL_000b: stelem.i4 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ V_1[1] = 2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ IL_000c: ldloc.1 IL_000d: ldc.i4.1 IL_000e: ldc.i4.2 IL_000f: stelem.i4 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ V_0 = V_1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ IL_0010: ldloc.1 IL_0011: stloc.0 IL_0012: ret } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ end of method Q::Main</span></span></code> </pre><br>  And here, in fact, that very focus with two local variables: one of them is temporary, into which values ‚Äã‚Äãare placed as the array is filled, after which the reference to the array is transferred to the main variable.  The reasons for this approach (with a separate method for filling the array) are obvious: in the case of a naive implementation, we would have 4 commands for each element, which would increase the amount of array building code linearly in proportion to the size of the array, instead the code size is constant. <br><br>  ps The article describes the behavior of the compilers C # 2.0 and 3.0 versions from Microsoft.  The behavior of code generated by compilers of other versions or third-party compilers (for example, Mono) may differ from the one given in the article. </div><p>Source: <a href="https://habr.com/ru/post/247047/">https://habr.com/ru/post/247047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247031/index.html">TorrentLocker - a new modification of the FileCoder cryptographer, part 2</a></li>
<li><a href="../247033/index.html">Hacker's guide to neural networks. Chapter 2: Machine Learning. More traditional approach: Loss functions</a></li>
<li><a href="../247039/index.html">How Iceland becomes a data center paradise</a></li>
<li><a href="../247041/index.html">VNC Roulette. Srsly?</a></li>
<li><a href="../247045/index.html">Plotter based on the Makeblock constructor</a></li>
<li><a href="../247049/index.html">em-dosbox and 50 gifts for the new year</a></li>
<li><a href="../247053/index.html">Sorting on a single-linked list in O (nlogn) time, at worst, with O (1) additional memory</a></li>
<li><a href="../247055/index.html">Adventures Tyzh-programmer. New Year's Eve Mood Post</a></li>
<li><a href="../247057/index.html">Samsung Introduces SE790C - Ultra WQHD 34-inch Curved Monitor</a></li>
<li><a href="../247059/index.html">Drupal - choosing a business consultant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>