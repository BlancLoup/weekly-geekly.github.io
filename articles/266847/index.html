<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik: small utility. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to share the small finds and devices that I managed to find and implement in RouterOS. Everything that will be written below is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik: small utility. Part 1</h1><div class="post__text post__text-html js-mediator-article">  <i>In this article I want to share the small finds and devices that I managed to find and implement in RouterOS.</i>  <i>Everything that will be written below is verified and works on the Mikrotik RB 951 series.</i> <br><br>  Today I will share the following things in the RouterOS environment: <br>  1) Semi-automatic updating of firmware of Mikrotik devices, notification by e-mail and / or SMS <br>  2) Automatically copy settings between devices <br>  3) Blocking traffic, turning it to another gateway <br><br>  Interesting?  Then I ask for cat. <br><a name="habracut"></a><br><h3>  Item 1: Semi-automatic Mikrotik device firmware update, email and / or SMS notification </h3><br>  As many know, the firmware for Mikrotik comes out regularly, with every update a bunch of fixes.  You need to update the device, it does not go away.  But not only do you need to update ROS, you also need to update the FW of the device itself. <br>  Honestly, I'm too lazy to follow the updates.  I am subscribed to news on the Mikrotik website, but already 3 months with this news is all very bad (there are simply no letters).  And everything would be fine, but I have 3 devices at home and 2 in the enterprise. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, a little theory: my case is 3 951 series devices, each connected to each VPN.  One of the points is the master, the rest take the necessary updates from the master through the internal channel.  The wizard checks for updates via the Internet, automatically downloads them and sends a notification by mail and SMS. <br>  But there is one thing: by default, update files are added to the root of the Files, only from there Mikrotik can be updated upon reboot.  Immediately after the update files are deleted.  For my scheme, this is critical, so you need to put the files in one of the folders, there they will not be deleted and other points will see them. <br><br>  <u>What you need</u> : <br>  need an FTP server on the wizard. <br>  optional - customized Email and SMS branches <br><br>  <u>How to: Master</u> <br>  Only a script is needed, the necessary variables are at the top. <br><div class="spoiler">  <b class="spoiler_title">Update script for version &lt;6.32.2</b> <div class="spoiler_text"><pre><code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> email " email" :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> " " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pass " " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> folder "   " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> phone "    +" ##### /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-updates :delay <span class="hljs-number"><span class="hljs-number">3</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> installed-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>] = [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> latest-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /tool e-mail send <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>=$email subject=" Mikrotik" body="  RouterOS!   - $[/system package update get latest-version].   - http://www.mikrotik.com/download" /tool sms send usb1 channel=<span class="hljs-number"><span class="hljs-number">2</span></span> "$phone" message="New RouterOS version is available!" /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> download :delay <span class="hljs-number"><span class="hljs-number">20</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/file find <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> package-version=[/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> latest-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> address=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> src-<span class="hljs-type"><span class="hljs-type">path</span></span>="$[/file get number="$i" name]" dst-<span class="hljs-type"><span class="hljs-type">path</span></span>="$folder/$[/file get number="$i" name]" <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$pass mode=ftp } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Update script for version&gt; = 6.32.2</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> email " email" :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> " " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pass " " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> folder "   " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> phone "    +" ##### :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> status] != "Downloaded, please reboot router to upgrade it" ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-updates :delay <span class="hljs-number"><span class="hljs-number">3</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> installed-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>] != [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> latest-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> download :delay <span class="hljs-number"><span class="hljs-number">20</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/file find <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> package-version=[/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> package <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> latest-<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> address=<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> src-<span class="hljs-type"><span class="hljs-type">path</span></span>="$[/file get number="$i" name]" dst-<span class="hljs-type"><span class="hljs-type">path</span></span>="$folder/$[/file get number="$i" name]" <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$pass mode=ftp } /tool e-mail send <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>=$email subject=" Mikrotik" body="  RouterOS!   - $[/system package update get latest-version].   - http://www.mikrotik.com/download" /tool sms send usb1 channel=<span class="hljs-number"><span class="hljs-number">2</span></span> "$phone" message="New RouterOS version is available!" } }</code> </pre><br></div></div><br>  The script for version 6.32.2+ includes checking for already downloaded updates.  Also note that even if updates are downloaded, check-for-updates sets the status to "New version is available". <br>  Depending on your Internet channel, you need to set the corresponding second delay. <br>  In the schedule, set the desired check interval.  My choice is every 12 hours. <br><br>  <i>Note: starting from version 6.32.1 there were problems with the encoding of e-mail messages.</i> <br><br>  <u>How to make: Slave</u> <br>  Required setup and 2 scripts. <br><div class="spoiler">  <b class="spoiler_title">Target Master Point</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> upgrade upgrade-package-source <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> address=xxx.xxx.xxx.xxx <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span></code> </pre><br>  And enter the password of the remote user. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">RouterOS update script</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> upgrade <span class="hljs-keyword"><span class="hljs-keyword">refresh</span></span> :delay <span class="hljs-number"><span class="hljs-number">5</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> upgrade download-<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reboot-<span class="hljs-keyword"><span class="hljs-keyword">after</span></span>-download=yes</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">FW update script</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> routerboard <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span>-firmware] &lt; [/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> routerboard <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> upgrade-firmware] ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> routerboard upgrade /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> reboot }</code> </pre><br></div></div><br>  In my case, the scripts are executed 1 time per day, the interval between them is 10 minutes. <br>  The second script in the schedule can be installed on the startup system.  If someone does not know, startup means starting 3 seconds after the device starts. <br><br>  ‚ÄúWhy not fetch files straight to the slave point?‚Äù You ask.  Because on the points can be installed different packages.  Better, the slaves themselves will decide what to swing and what not. <br><br>  If you have one Mikrotik device, then you can build scripts for fully automated software updates. <br><br><h3>  Item 2: Automatically copy settings between devices </h3><br>  As I said, laziness is my middle name.  And I have an open guest Wi-Fi on each of the devices only ‚Äúfor my own people‚Äù, according to the MAC.  Therefore, a volitional decision was made to have the same list of permitted devices at all points.  The base is located on one of the points (Master) and will be copied once a day to the necessary devices.  You need FTP servers at points where you need to copy the settings. <br><br>  So, there are 2 options: simple and correct. <br>  <u>Plain:</u> <br>  It consists in the sequential sending of 2 files. <br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ip "IP ,     " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> "" :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> "" ##### /interface wireless <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list export compact file=address :delay <span class="hljs-number"><span class="hljs-number">1</span></span> /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> upload=yes address=$ip mode=ftp src-<span class="hljs-type"><span class="hljs-type">path</span></span>=address_flush.rsc dst-<span class="hljs-type"><span class="hljs-type">path</span></span>=address_flush.auto.rsc <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> :delay <span class="hljs-number"><span class="hljs-number">1</span></span> /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> upload=yes address=$ip mode=ftp src-<span class="hljs-type"><span class="hljs-type">path</span></span>=address.rsc dst-<span class="hljs-type"><span class="hljs-type">path</span></span>=address.auto.rsc <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">password</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The contents of the file address_flush.rsc</b> <div class="spoiler_text"><pre> <code class="hljs cmake">/interface wireless access-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">remove</span></span> [/interface wireless access-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> find]</code> </pre><br></div></div><br>  <u>Right:</u> <br>  The previous version does not take into account the possible disconnection between fetches.  If this situation occurs, the access-list will be empty with all the consequences.  Therefore, we need to check for the presence of a file with the settings, and after that we need to clear the current contents of the sheet.  The last action of the script is to delete the file.  Namely: <br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">:<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ip "IP ,     " :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> "" :<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> "" ##### /interface wireless <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list export compact file=wifi2_mac :delay <span class="hljs-number"><span class="hljs-number">1</span></span> /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> upload=yes address=$ip mode=ftp src-<span class="hljs-type"><span class="hljs-type">path</span></span>=wifi2_mac.rsc dst-<span class="hljs-type"><span class="hljs-type">path</span></span>=wifi2_mac.rsc <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> :delay <span class="hljs-number"><span class="hljs-number">1</span></span> /tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> upload=yes address=$ip mode=ftp src-<span class="hljs-type"><span class="hljs-type">path</span></span>=address_proc.rsc dst-<span class="hljs-type"><span class="hljs-type">path</span></span>=address_proc.auto.rsc <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> :delay <span class="hljs-number"><span class="hljs-number">10</span></span> /file remove [/file find <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=wifi2_mac.rsc]</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The contents of the file address_proc.rsc</b> <div class="spoiler_text"><pre> <code class="hljs swift">#<span class="hljs-number"><span class="hljs-number">2015.09</span></span>.<span class="hljs-number"><span class="hljs-number">11</span></span> - <span class="hljs-type"><span class="hljs-type">AcidVenom</span></span> - <span class="hljs-type"><span class="hljs-type">Copy</span></span> <span class="hljs-type"><span class="hljs-type">MAC</span></span> to extertnal <span class="hljs-type"><span class="hljs-type">Script</span></span> :delay <span class="hljs-number"><span class="hljs-number">5</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [/file <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> name=wifi2_mac.rsc] != <span class="hljs-string"><span class="hljs-string">""</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /interface wireless access-list remove [/interface wireless access-list <span class="hljs-built_in"><span class="hljs-built_in">find</span></span>] /<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wifi2_mac.rsc :delay 1 /file remove [/file find where name=wifi2_mac.rsc] }</code> </pre><br></div></div><br>  Strictly speaking, the address_flush.rsc and address_proc.rsc files can have arbitrary names and extensions, but their output in the dst-path should be * .auto.rsc. <br><br>  In the image and likeness you can copy the settings you need almost "on the fly." <br><br><h3>  Point 3: Blocking traffic, turning it to another gateway </h3><br>  On the topic of blocking a certain traffic of the article googling, so I will be brief - Layer7 Protocol. <br>  For example, blocking telemetry Microsoft: <br><pre> <code class="hljs pgsql">/ip firewall layer7-protocol <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=telemetry regexp=^.+(data.microsoft.com|telemetry.microsoft.com).*$ /ip firewall <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=forward protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> layer7-protocol=telemetry action=reject reject-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>=tcp-<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> /ip firewall <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=forward protocol=tcp <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-interface=bridge-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> layer7-protocol=telemetry action=reject reject-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>=tcp-<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span></code> </pre><br>  Read more about L7 on the <a href="http://l7-filter.sourceforge.net/protocols">project</a> website. <br><br>  The next moment is turning the traffic of individual machines to another gateway, which is not the default. <br><pre> <code class="hljs pgsql">/ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=prerouting src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dst-address=!<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> action=mark-routing <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=another_gateway passthrough=yes /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=unicast distance=<span class="hljs-number"><span class="hljs-number">1</span></span> routing-mark=another_gateway</code> </pre><br>  Distance should be lower than the default gateway.  If necessary, instead of the source subnet, you can specify a single IP or address list. <br>  Thus, you can wrap all outgoing traffic to the gateway 192.168.1.1.  I strongly advise you to specify the gateway via IP, otherwise if you break the rule in the Route List is simply erased. <br><br>  Well, the last trick for today is turning of only certain sites to the non-default gateway.  This is very useful if you have a proxy not in the territory of the Russian Federation, but you want and / or need to visit the blocked RKN site. <br>  This is a little more difficult, because  L7 works when the connection is already established.  Therefore, we will use the address lists. <br>  For example, let's take forum.mikrotik.com, for which my main IP was in the spam range. <br><pre> <code class="hljs pgsql">/ip firewall layer7-protocol <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>=forum.mikrotik regexp=^.+(forum.mikrotik.com).*$ /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=prerouting src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dst-address=!<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> layer7-protocol=forum.mikrotik action=<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-dst-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-address-list address-list=forum.mikrotik.ip address-list-timeout=<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> chain=prerouting src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dst-address=!<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">16</span></span> dst-address-list=forum.mikrotik.ip action=mark-routing <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-routing-mark=forum.mikrotik.rm passthrough=yes /ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>-gateway=ping <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=unicast distance=<span class="hljs-number"><span class="hljs-number">1</span></span> routing-mark=forum.mikrotik.rm</code> </pre><br>  The disadvantage of this solution is that the first connection will end in error, but the subsequent ones will go through the required gateway. <br><br>  PS: updated 10/20/2015.  Added update script for version 6.32.2+ <br><br>  PPS: With the release of version 6.32.3, they fixed the email newsletter.  I would like to think that this article was promoted to repair. <br><br>  PPPS: Updated 11/09/2015. <br>  With the release of version 6.33, it turned out to be a nuisance: the microtic cannot compare versions of different orders, i.e.  6.32.3 and 6.33. <br>  Therefore, the script is modified to reflect this incident.  Also, notifications are postponed below for sending to the last turn. </div><p>Source: <a href="https://habr.com/ru/post/266847/">https://habr.com/ru/post/266847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266835/index.html">Inventing servers - Open Compute Project</a></li>
<li><a href="../266837/index.html">Testing on Android: Robolectric + Jenkins + Ja–°o–°o</a></li>
<li><a href="../266839/index.html">Working with lighting in Unity - theory and practice</a></li>
<li><a href="../266843/index.html">Preparing Nexus Player (FUGU) for working with SoCWatch</a></li>
<li><a href="../266845/index.html">Armory 1.2: Workspaces and switching between projects</a></li>
<li><a href="../266849/index.html">Book about viruses</a></li>
<li><a href="../266851/index.html">Start loving go</a></li>
<li><a href="../266853/index.html">Return fix and other improvements in Vivaldi 1.0.275.3 fix</a></li>
<li><a href="../266857/index.html">FAS has recognized Google as violator of antitrust laws</a></li>
<li><a href="../266859/index.html">Non-intersecting sets and mysterious function of Ackermann</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>