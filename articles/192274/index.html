<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Channel balancing - two providers, AS, BGP, NAT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thanks to Habra, I found a lot of useful things for myself. I think it's time to "pay off debts." 
 I want to describe an algorithm that has been work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Channel balancing - two providers, AS, BGP, NAT</h1><div class="post__text post__text-html js-mediator-article">  Thanks to Habra, I found a lot of useful things for myself.  I think it's time to "pay off debts." <br>  I want to describe an algorithm that has been working for more than a year on my gateway for balancing channels (Gbit traffic, 8k clients, 2 providers, AS to 1k addresses, most clients are for NAT).  Perhaps someone will come in handy.  In any case, I did not see anything like that, and when I specifically looked for it, I did not find it.  So completely my brainchild. <br>  All that came across on the Internet, allowed to reserve one of the channels.  And outgoing to regulate - there are many descriptions.  But to regulate the incoming traffic (i.e., to ensure a uniform load of several channels) did not come across. <br>  Of course, this algorithm can not be considered universal, suitable only in suitable conditions. <br><br>  <b>So, the original</b> : <br>  - Gateway to Linux (Debian 6).  Used package quagga (former zebra). <br>  - Two providers (let it be TTK and RTK).  Each gives a channel of a certain thickness, the "extra" cuts. <br>  - AS to 1k addresses (let it be 1.1.144.0/22).  AS0000. <br>  - Most clients have gray addresses (let it be 192.168.0.0/16), ‚Äúclient‚Äù networks 192.168.1-99.0 / 24, they will get tense on the gateway. <br>  - A small part of clients have white addresses in the space of my AS. <br><br>  <b>Task</b> : <br>  Ensure uniform loading of TTK and RTK channels with incoming traffic to avoid channel overload. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Simplify <br>  I will not talk here about the settings of the shaper.  We assume that it is already configured and working.  At the same time, the common channel is shaped, excluding TTC / RTK. <br>  We will not balance outgoing.  In most cases, this is not relevant (the outgoing is much less), and it is solved quite simply. <br><br>  <b>Theory</b> <br>  1. BGP allows you to control probability (preference).  Those.  Specify the preferred inbound route for a specific network.  An artificial ‚Äúlengthening‚Äù of the route is used for this ‚Äî when announcing your route to a neighbor, you can repeat the number of your AS several times.  In this case, each neighbor can "lengthen" the route in different ways.  A shorter route is preferred. <br>  2. BGP allows you to make descriptions of individual parts of AS.  Those.  in the RIPE our AS is described as 1.1.144.0/22, no one bothers to describe (i.e., announce) 1.1.144.0/24, 1.1.145.0/24, 1.1.146.0/24 and 1.1.147.0/24 in BGP. <br>  <i>Council - do not remove the announcement of the whole AS (1.1.144.0/22).</i>  <i>Some gateways do not accept routes with mask 24. It is better to slightly lengthen the general route.</i> <br>  3. I recall the route selection algorithm for BGP routing from several available. <br>  - A route with a larger mask is selected.  If not selected, then next. <br>  - A shorter route is selected (less than intermediate AS).  If not selected, then next. <br>  - The route announced earlier is selected (it is considered more reliable).  If not selected, then next. <br>  - Unambiguous pseudo-random selection. <br><br>  A drop of tar. <br>  Unfortunately, ‚Äúpreference management‚Äù does not mean ‚Äúprobability management‚Äù at all.  In fact, it turns out that almost all traffic begins to follow the preferred route.  Those.  using lengthening routes, <b>smoothly</b> adjust the flow will not work.  It is rather a ‚Äúswitch‚Äù than a ‚Äúregulator‚Äù. <br><br>  <b>Idea</b> <br>  Most of our customers have gray IP.  Accordingly, on our gateway natit.  And this is the main traffic.  Well, how to natit them (i.e. what external IP to set) is in our power. <br>  All our AS can be divided into 4 parts (1.1.144.0/24, 1.1.145.0/24, 1.1.146.0/24 and 1.1.147.0/24) and use them in different ways.  For example, the first two are for customers with ‚Äúwhite‚Äù IP, the third is RTK preference and the fourth is TTC preference.  That is what I have done. <br>  At the iptables level, decide which addresses to use for NAT. <br>  If the client‚Äôs address is 192.168.1- <b>N</b> .0 / 24, then for NAT use 1.1.146.0/24.  Otherwise - 1.1.147.0/24. <br>  Thus, by changing N, you can <b>smoothly</b> balance the incoming traffic of the two channels. <br><br>  <b>Implementation</b> . <br>  <i>Please consider this implementation just as an example.</i>  <i>Not everything is optimal here, it is more convenient for someone to do it on a pearl / python, it is more convenient for someone to organize it as a single demon.</i>  <i>The main goal of this example is to show the possibility of implementing an idea.</i>  <i>Well, its performance.</i> <br><br>  1. To verify that the client IP belongs to 192.168.1- <b>N</b> .0 / 24, in iptables, use the ipset module, in the rules, further the ‚Äúrtk‚Äù set. <br>  Chain "NAT_AS", which I have natit: <br><blockquote>  : NAT_AS - [0: 0] <br>  # For old connections, so as not to "throw" them from one external to another <br>  -A NAT_AS -m state -s 192.168.0.0/16 --state ESTABLISHED, RELATED -j SNAT --to-source 91.235.146.0-91.235.147.255 --persistent <br>  # For new compounds, choose how to natit. <br>  # RTK <br>  -A NAT_AS -m state -m set --set rtk src --state NEW -j SNAT --to-source 1.1.146.0-1.1.146.255 --persistent <br>  # TTK <br>  -A NAT_AS -m state -m set!  --set rtk src --state NEW -j SNAT --to-source 1.1.147.0-1.1.147.255 --persistent </blockquote><br>  Note that -j SNAT is used with the --persistent option.  This is for the client to use a permanent external IP.  Without this, the client may have problems on many services on the Internet. <br>  Well, somewhere in NAT / POSTROUTING <br><blockquote>  # eth1, eth3 - interfaces that ‚Äúlook‚Äù on TTC and RTK <br>  -A POSTROUTING -s 192.168.0.0/16 -o eth1 -j NAT_AS <br>  -A POSTROUTING -s 192.168.0.0/16 -o eth3 -j NAT_AS </blockquote><br><br>  2. Prepare a set of ipset "rtk" <br>  The file in which I store all the parameters (used in several scripts) <br>  cat param_rtk_set: <br><blockquote>  # Client subnets to be managed <br>  export rtk_start = 1 <br>  export rtk_min = 1 <br>  export rtk_max = 99 <br><br>  # Maximum traffic (what the provider gave, or rather what can be obtained from it without loss).  It is selected. <br>  # RTK <br>  export shp_rtk_max = 547 <br>  # TTK <br>  export shp_ttk_max = 535 <br><br>  # Relative regulation accuracy <br>  export scale = 50 <br><br>  # file where the current value of N is stored. Better somewhere on tmpfs. <br>  export f_set_end = / lib / init / rw / rtk_set_end </blockquote><br>  Directly create and update the rtk kit.  You can (and should) run regularly. <br>  cat create_rtk_set <br><blockquote>  #!  / bin / sh <br><br>  # If does not exist, then rtk set is created <br>  / usr / sbin / ipset -N rtk nethash -q <br>  # Temporary dialing.  To "hot" not to change the working set <br>  / usr / sbin / ipset -N temp_rtk nethash -q <br>  / usr / sbin / ipset -F temp_rtk -q <br><br>  .  ./param_rtk_set <br><br>  # In some versions of sh, the variable must be declared before the loop or condition.  To then use. <br>  rtk_set_end = 0 <br><br>  # If this is the first run (there is no old N value, then we will create an average of min and max. And save. <br>  if [-f $ f_set_end];  then <br>  read rtk_set_end &lt;$ f_set_end <br>  else <br>  rtk_set_end = $ (($ rtk_min + $ rtk_max)) <br>  rtk_set_end = $ (($ rtk_set_end / 2)) <br>  echo $ rtk_set_end&gt; $ f_set_end <br>  fi <br><br>  # fill in the temporary set <br>  net = $ rtk_start <br>  while [$ net -lt $ rtk_set_end];  do <br>  / usr / sbin / ipset -A temp_rtk 192.168. $ {net} .0 / 24 -q <br>  net = $ (($ net + 1)) <br>  done <br><br>  # copy the temporary set to work <br>  / usr / sbin / ipset -W temp_rtk rtk <br>  # remove the temporary set <br>  / usr / sbin / ipset -X temp_rtk -q </blockquote><br><br>  OK, there is a ‚Äúcontrol action‚Äù.  Those.  changing N (my value is stored in / lib / init / rw / rtk_set_end), you can smoothly change the ratios of incoming traffic of the TTC and RTK.  Now it remains to configure the automation. <br><br>  <b>Automation</b> . <br>  cat rtk-ttk: <br><blockquote>  # Get the current values ‚Äã‚Äãof the counters on the interfaces <br>  ttk = $ (/ sbin / ifconfig eth1 | grep -Eo "RX bytes: [0-9] *" | grep -Eo "[0-9] *") <br>  if ["$ ttk" = ""];  then <br>  echo "No TTK ifconfig" <br>  exit <br>  fi <br>  rtk = $ (/ sbin / ifconfig eth3 | grep -Eo "RX bytes: [0-9] *" | grep -Eo "[0-9] *") <br>  if ["$ rtk" = ""];  then <br>  echo "No RTK ifconfig" <br>  exit <br>  fi <br><br>  # Directory where we will store past values <br>  work_dir = "/ lib / init / rw /" <br><br>  # Find the difference, save the current value, if the current is less than the past, then the output. <br>  read ttk_old &lt;$ {work_dir} shp_ttk_old <br>  read rtk_old &lt;$ {work_dir} shp_rtk_old <br><br>  echo $ ttk&gt; $ {work_dir} shp_ttk_old <br>  echo $ rtk&gt; $ {work_dir} shp_rtk_old <br><br>  if [$ ttk -le $ ttk_old];  then <br>  echo "TTK RX smoll" <br>  exit <br>  fi <br><br>  if [$ rtk -le $ rtk_old];  then <br>  echo "TTK RX smoll" <br>  exit <br>  fi <br><br>  ttk_cur = $ (($ ttk - $ ttk_old + 1)) <br>  rtk_cur = $ (($ rtk - $ rtk_old + 1)) <br><br>  # read parameters <br>  .  ./param_rtk_set <br><br>  # Maximum change in N for one iteration.  It is selected. <br>  max_delta = 5 <br><br>  # Find the deviation. <br>  p = $ (echo "scale = 10; $ scale * ($ shp_rtk_max / $ shp_ttk_max) / ($ rtk_cur / $ ttk_cur) + 100.5" | / usr / bin / bc) <br>  p = $ {p %%. *} <br>  p = $ (($ p - 100)) <br><br>  # Increase N <br>  n_for = 1 <br>  while [$ scale -lt $ p];  do <br>  #echo "$ p add" <br>  p = $ (($ p - 1)) <br>  n_for = $ (($ n_for + 1)) <br>  if [$ max_delta -lt $ n_for];  then <br>  break <br>  fi <br>  ./add_rtk <br>  done <br><br>  # Decrease N <br>  n_for = 1 <br>  while [$ p -lt $ scale];  do <br>  #echo "$ p del" <br>  p = $ ((1 + $ p)) <br>  n_for = $ (($ n_for + 1)) <br>  if [$ max_delta -lt $ n_for];  then <br>  break <br>  fi <br>  ./del_rtk <br>  done <br><br>  # apply new N value <br>  ./create_rtk_set <br></blockquote><br><br>  It remains to make scripts add_rtk to increase N and del_rtk to reduce.  These scripts should read the current N from / lib / init / rw / rtk_set_end, decrease / increase, check the occurrence in the interval [min - max] and save.  I will not give them, it's easy. <br><br>  <b>BGP setup</b> . <br>  In order for all of this to be able to control incoming traffic, BGP must be prepared. <br><br>  An example of my bgp.conf (of course, the real IP and numbers are changed under the original data: <br><blockquote> ! <br>  hostname AS0000 <br>  password **** <br>  enable password **** <br>  log file /var/log/quagga/bgpd.log <br>  ! <br>  router bgp 0000 <br>  no synchronization <br>  bgp router-id [our any external IP] <br>  network 1.1.144.0/22 <br>  network 1.1.144.0/24 <br>  network 1.1.145.0/24 <br>  network 1.1.146.0/24 <br>  network 1.1.147.0/24 <br>  ! <br>  neighbor [RTC gateway IP] remote-as [AS RTC (only a number, for example 12345)] <br>  neighbor [RTC Gateway IP] update-source [our external IP RTC] <br>  neighbor [RTC gateway IP] route-map MY-OUT-RTK out <br>  neighbor [RTC gateway IP] route-map INTER_NET in <br>  ! <br>  neighbor [TTK gateway IP] remote-as [AS TTK (only a number, for example 12345)] <br>  neighbor [TTK gateway IP] update-source [our external IP TTK] <br>  neighbor [TTK gateway IP] route-map MY-OUT-TTK out <br>  neighbor [TTK gateway IP] route-map INTER_NET in <br>  ! <br>  ip prefix-list upstream-out seq 10 permit 1.1.144.0/22 <br>  ! <br>  ip prefix-list up144 seq 10 permit 1.1.144.0/24 <br>  ! <br>  ip prefix-list up145 seq 10 permit 1.1.145.0/24 <br>  ! <br>  ip prefix-list up146 seq 10 permit 1.1.146.0/24 <br>  ! <br>  ip prefix-list up147 seq 10 permit 1.1.147.0/24 <br>  ! <br>  ! ========================= <br>  ! --- MY-OUT-TTK <br>  route-map MY-OUT-TTK permit 10 <br>  match ip address prefix-list up144 <br>  ! set as-path prepend 0000 0000 <br>  ! <br>  route-map MY-OUT-TTK permit 20 <br>  match ip address prefix-list up145 <br>  ! set as-path prepend 0000 0000 <br>  ! <br>  route-map MY-OUT-TTK permit 30 <br>  match ip address prefix-list up146 <br>  set as-path prepend 0000 <br>  ! <br>  route-map MY-OUT-TTK permit 40 <br>  ! match ip address prefix-list up147 <br>  ! set as-path prepend 0000 0000 <br>  ! <br>  ! route-map MY-OUT-TTK deny 200 <br>  ! ========================= <br>  ! <br>  route-map MY-OUT-TTK permit 100 <br>  match ip address prefix-list upstream-out <br>  ! set as-path prepend 0000 0000 0000 <br>  ! <br>  route-map MY-OUT-TTK deny 200 <br>  ! <br>  ! --- the end of MY-OUT-TTK <br>  ! ========================= <br>  ! --- MY-OUT-RTK <br>  route-map MY-OUT-RTK permit 10 <br>  match ip address prefix-list up144 <br>  set as-path prepend 0000 <br>  ! <br>  route-map MY-OUT-RTK permit 20 <br>  match ip address prefix-list up145 <br>  set as-path prepend 0000 <br>  ! <br>  route-map MY-OUT-RTK permit 30 <br>  match ip address prefix-list up146 <br>  ! set as-path prepend 0000 0000 0000 <br>  ! <br>  route-map MY-OUT-RTK permit 40 <br>  match ip address prefix-list up147 <br>  set as-path prepend 0000 <br>  ! <br>  ! ========================= <br>  ! <br>  route-map MY-OUT-RTK permit 100 <br>  match ip address prefix-list upstream-out <br>  set as-path prepend 0000 0000 <br>  ! <br>  route-map MY-OUT-RTK deny 200 <br>  ! <br>  ! --- the end of MY-OUT-RTK <br>  ! ========================= <br>  ! ---- Local nets <br>  ip prefix-list local_ seq 15 permit 192.168.0.0/16 <br>  ip prefix-list local_ seq 18 permit 0.0.0.0/8 <br>  ip prefix-list local_ seq 19 permit 127.0.0.0/8 <br>  ip prefix-list local_ seq 20 permit 10.0.0.0/8 <br>  ip prefix-list local_ seq 21 permit 172.16.0.0/12 <br>  ip prefix-list local_ seq 22 permit 169.254.0.0/16 <br>  ip prefix-list local_ seq 23 permit 224.0.0.0/4 <br>  ip prefix-list local_ seq 24 permit 240.0.0.0/4 <br>  !  Here you need to add your "white" network <br>  ! <br>  route-map INTER_NET deny 10 <br>  match ip address prefix-list local_ <br>  ! <br>  ! <br>  route-map INTER_NET permit 200 <br>  set local-preference 500 <br>  ! <br>  line vty <br>  ! </blockquote><br>  Let me remind you that here "0000" is the number of my AS, "1.1." Is the beginning of my IP.  Everything else is signed. <br><br>  <b>Tuning, tuning</b> . <br>  First, you need to configure all the ‚Äúset as-path prepend‚Äù in bgp.conf. <br>  The task is to get everything outgoing 1.1.146.0/24 (this is conditional, of course), then to get a big bias towards the RTK. <br>  And vice versa, if everything goes outgoing 1.1.147.0/24, then get a strong bias towards the TTK. <br><br>  Secondly, it is necessary to specify the maximum-available traffic from the TTC and RTK in the param_rtk_set file (shp_rtk_max and shp_ttk_max).  I do not recommend to specify the value "from the contract."  Indicate the maximum you have ever received.  Keep in mind that this is where you specify the desired ratio of incoming traffic. <br><br>  Third. <br>  Specify the desired control accuracy (‚Äúscale‚Äù value in the parameters).  The larger, the smaller the ‚Äúdead zone‚Äù, the stronger the control action (the more N changes).  Too much value may cause a ‚Äúbeating‚Äù (resonance). <br><br>  Fourth. <br>  Specify the maximum N change in one iteration.  Too much of a value can cause beats, i.e.  resonance.  This happens because the response to the control action does not appear immediately, but with some delay.  Well, too little value will not keep up with the realities of life. <br><br>  Well that's all.  It remains to do the task in cron, to perform rtk-ttk every minute.  Or make some kind of daemon that rtk-ttk will run periodically. <br><br>  I will add that this algorithm has been working for me for more than a year.  Sometimes you have to intervene - correct BGP settings (set as-path prepend).  Something on the Internet is changing, you have to react. <br><br>  I will accept any comments or advice, I will answer in the comments. </div><p>Source: <a href="https://habr.com/ru/post/192274/">https://habr.com/ru/post/192274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192262/index.html">GWT-Platform basics of working with presenters</a></li>
<li><a href="../192266/index.html">Perfect migration using Catch-> Evernote</a></li>
<li><a href="../192268/index.html">Gradle and Automation Solution</a></li>
<li><a href="../192270/index.html">If programming languages ‚Äã‚Äãwere child constructors</a></li>
<li><a href="../192272/index.html">Calculation of the intersection area of ‚Äã‚Äãthe circles by the Monte Carlo method</a></li>
<li><a href="../192276/index.html">Electronic libraries at work and at home</a></li>
<li><a href="../192280/index.html">Spiceworks. Part 1: Online Inventory</a></li>
<li><a href="../192282/index.html">Google Chrome Anniversary - 5 years</a></li>
<li><a href="../192284/index.html">"Boost.Asio C ++ Network Programming". Chapter 1: Getting Started with Boost.Asio</a></li>
<li><a href="../192286/index.html">Automation testing software systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>