<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing Hello World on FASM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One languid Friday evening got a crazy idea in my head: why don't I think up my brain and write HelloWorld in assembler. However, it seemed too simple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing Hello World on FASM</h1><div class="post__text post__text-html js-mediator-article">  One languid Friday evening got a crazy idea in my head: why don't I think up my brain and write HelloWorld in assembler.  However, it seemed too simple.  And let's not build the x86 program, but the java class?  No sooner said than done. <br><a name="habracut"></a><br>  First we find <a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html">the JVM specification</a> .  As we can see, the Java class file consists of: <br><br><ul><li>  Magic number, it is always 0xCAFEBABE </li><li>  Minor and major versions, for Java 7, they are 0 and 51, respectively. </li><li>  The number of constant pool elements and the elements themselves are described below. </li><li>  Access flags, the number of the constant indicating the current class, the number of the constant indicating the parent class. </li><li>  The number of implemented interfaces and the array of numbers of their descriptors in the pool. </li><li>  Number of fields, array of field descriptors. </li><li>  The number of methods, an array of method descriptors. </li><li>  Number of attributes, array of attributes. </li></ul><br>  In Java, the order is big endian, while FASM is an assembler under x86, where little endian is adopted, so we will immediately write macros to convert numbers from one order to another: <br><br><pre><code class="hljs kotlin">u1 equ db ; u1 - <span class="hljs-number"><span class="hljs-number">1</span></span> ,   macro u2 [<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>] { ; u2 - <span class="hljs-number"><span class="hljs-number">2</span></span>  forward ;       ,  u2 <span class="hljs-number"><span class="hljs-number">0x1234</span></span>, <span class="hljs-number"><span class="hljs-number">0x5678</span></span> ;       u1 (((<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) shr <span class="hljs-number"><span class="hljs-number">8</span></span>) and <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) ;    u1 ((<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) and <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) ;   } macro u4 [<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>] { ; u4 - <span class="hljs-number"><span class="hljs-number">4</span></span> ,    u2 forward u2 (((<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) shr <span class="hljs-number"><span class="hljs-number">16</span></span>) and <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>) u2 ((<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) and <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span>) }</code> </pre> <br>  In general, the macro language FASM is so powerful that you can write another language in it, and not in one way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A constant pool is quite intricate, one descriptor refers to another, it is the third, but you can figure it out - it's all the same people wrote. <br><br>  Elements of the constant pool in the general case look like this: <br><br><pre> <code class="cpp hljs">cp_info { u1 tag; u1 info[]; }</code> </pre><br>  A full list of tags is given in the documentation, I will not describe them in detail.  I will describe the trick that I used to automatically calculate the size of the pool (as well as methods, fields, etc.). <br><br>  The construction of the form const # name - sticks together the text const and the value from the constant name.  The construction is similar to that of the C macros. <br><br><pre> <code class="hljs pgsql">const_count = <span class="hljs-number"><span class="hljs-number">0</span></span> macro const <span class="hljs-type"><span class="hljs-type">name</span></span>* { ;   const_#<span class="hljs-type"><span class="hljs-type">name</span></span>: const_count = const_count + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> = const_count ;   (FASM )      }</code> </pre> <br>  Although in FASM terminology, constants are called constants, in fact they behave as variables, and many manipulations can be made with them. <br><br>  Then we declare macros for the beginning and for the end: <br><br><pre> <code class="hljs 1c">macro ConstantPool { u2 const_count_end + <span class="hljs-number"><span class="hljs-number">1</span></span> ;      ; +<span class="hljs-number"><span class="hljs-number">1</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,     }</code> </pre><br>  But after all such variable does not exist, you will tell.  And you will be right.  Does not exist yet.  FASM is a multi-pass assembler, and what was not found on the first pass, it will remember and connect on the second or further. <br><pre> <code class="hljs cs">macro ConstantPoolEnd { UTF8 code_attr, <span class="hljs-string"><span class="hljs-string">'Code'</span></span> const_count_end = const_count ;      . }</code> </pre> <br>  On the next pass, the assembler will substitute for const_count_end exactly as much as he counted constants. <br><br>  Methods and fields are organized in a similar way.  I will give an example of a macro that generates a constant Method <br><br><pre> <code class="hljs pgsql">macro UTF8 <span class="hljs-type"><span class="hljs-type">name</span></span>, <span class="hljs-type"><span class="hljs-type">text</span></span> { const <span class="hljs-type"><span class="hljs-type">name</span></span> u1 <span class="hljs-number"><span class="hljs-number">1</span></span> ; tag u2 .<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> - .<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>: u1 <span class="hljs-type"><span class="hljs-type">text</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>: } macro <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>, className { UTF8 className_#<span class="hljs-type"><span class="hljs-type">name</span></span>, className const <span class="hljs-type"><span class="hljs-type">name</span></span> u1 <span class="hljs-number"><span class="hljs-number">7</span></span> ; tag u2 className_#<span class="hljs-type"><span class="hljs-type">name</span></span> } macro NameAndType <span class="hljs-type"><span class="hljs-type">name</span></span>, nameText, typeText { UTF8 name_#<span class="hljs-type"><span class="hljs-type">name</span></span>, nameText UTF8 type_#<span class="hljs-type"><span class="hljs-type">name</span></span>, typeText const <span class="hljs-type"><span class="hljs-type">name</span></span> u1 <span class="hljs-number"><span class="hljs-number">12</span></span> ; tag u2 name_#<span class="hljs-type"><span class="hljs-type">name</span></span> u2 type_#<span class="hljs-type"><span class="hljs-type">name</span></span> } macro <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>, className, methodName, methodType { <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> class_#<span class="hljs-type"><span class="hljs-type">name</span></span>, className ;   <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> NameAndType nameAndType_#<span class="hljs-type"><span class="hljs-type">name</span></span>, methodName, methodType ;   NameAndType const <span class="hljs-type"><span class="hljs-type">name</span></span> u1 <span class="hljs-number"><span class="hljs-number">10</span></span> ; tag u2 class_#<span class="hljs-type"><span class="hljs-type">name</span></span> u2 nameAndType_#<span class="hljs-type"><span class="hljs-type">name</span></span> }</code> </pre> <br>  Here you can see how the links go - Method refers to Class, Class refers to UTF8, also with NameAndType.  Arguments are passed to the macro as strings, for example, <code>Method printlnInt, 'java/io/PrintStream', 'println', '(I)V'</code> . <br><br>  And finally, the source itself: <br><br><pre> <code class="hljs kotlin">format binary <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'class'</span></span> include <span class="hljs-string"><span class="hljs-string">'java.inc'</span></span> ; --- FILE --- magic: u4 <span class="hljs-number"><span class="hljs-number">0xCAFEBABE</span></span> version: u4 <span class="hljs-number"><span class="hljs-number">51</span></span> ConstantPool Class <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">'java'</span></span> Class <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>, <span class="hljs-string"><span class="hljs-string">'java/lang/Object'</span></span> UTF8 main, <span class="hljs-string"><span class="hljs-string">'main'</span></span> UTF8 main_sig, <span class="hljs-string"><span class="hljs-string">'([Ljava/lang/String;)V'</span></span> Field o, <span class="hljs-string"><span class="hljs-string">'java/lang/System'</span></span>, <span class="hljs-string"><span class="hljs-string">'out'</span></span>, <span class="hljs-string"><span class="hljs-string">'Ljava/io/PrintStream;'</span></span> Method println, <span class="hljs-string"><span class="hljs-string">'java/io/PrintStream'</span></span>, <span class="hljs-string"><span class="hljs-string">'println'</span></span>, <span class="hljs-string"><span class="hljs-string">'(Ljava/lang/String;)V'</span></span> Method printlnInt, <span class="hljs-string"><span class="hljs-string">'java/io/PrintStream'</span></span>, <span class="hljs-string"><span class="hljs-string">'println'</span></span>, <span class="hljs-string"><span class="hljs-string">'(I)V'</span></span> String hello, <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span> ConstantPoolEnd u2 PUBLIC, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ;  ,  ,    Methods MethodStart PUBLIC or STATIC, main, main_sig, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> getstatic o ldc hello ;   ,   invokevirtual println getstatic o bipush <span class="hljs-number"><span class="hljs-number">42</span></span> invokevirtual printlnInt <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MethodEnd MethodsEnd u2 <span class="hljs-number"><span class="hljs-number">0</span></span> ;  </code> </pre> <br>  ¬ªThe full code can be viewed <a href="https://gist.github.com/Pabloader/aa52421a0a2cfa0f49f2cd90894c2186">here</a> . <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/309922/">https://habr.com/ru/post/309922/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309910/index.html">Scala or not Scala? That is the question</a></li>
<li><a href="../309912/index.html">Poll. The current state of automated testing 2016</a></li>
<li><a href="../309914/index.html">The history of programming languages: how Fortran allowed users to communicate with the computer on "you"</a></li>
<li><a href="../309918/index.html">How to stop being afraid and fall in love with mbed [Part 2]</a></li>
<li><a href="../309920/index.html">Fax in the City (T.38)</a></li>
<li><a href="../309928/index.html">Customize Windows Store for Business</a></li>
<li><a href="../309930/index.html">Arguments for function tree</a></li>
<li><a href="../309934/index.html">How to get a lot of server for little money: options for the earth and the cloud</a></li>
<li><a href="../309936/index.html">Overview of Node.js packages for parsing command line options</a></li>
<li><a href="../309938/index.html">We get rid of binary dependencies with composite assembly in Gradle 3.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>