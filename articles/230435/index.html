<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About QML and the new Yandex.Disk REST API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends! 
 Recently, articles on QtQuick \ QML About Ubuntu SDK (based on QtQuick) have completely ceased to appear on Habr√© and silence, bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About QML and the new Yandex.Disk REST API</h1><div class="post__text post__text-html js-mediator-article">  Good day, friends! <br>  Recently, articles on QtQuick \ QML About Ubuntu SDK (based on QtQuick) have completely ceased to appear on Habr√© and silence, but at the moment it is the main toolkit offered for developing applications for Ubuntu (the most popular Linux distribution kit).  I wanted to correct this situation to the best of my ability by writing this article!  It‚Äôs not worth trying to embrace the immense, so I‚Äôll start, perhaps, with the story of how I managed to replace a large amount of code with C ++ code with QML (in the application under the Ubuntu SDK).  If it became interesting to you, and maybe even incomprehensible, and where is Yandex.Disk, then I ask for the cat! <br><img src="https://habrastorage.org/getpro/habr/post_images/087/997/22c/08799722ce82d0d9a39bc64c971df88c.png" alt="image"><br><a name="habracut"></a><br><h5>  Introduction </h5><br>  I will start from afar, but I will try briefly - a few years ago I wanted to create a client of some cloud storage under MeeGo (!).  It so happened that at that very moment Yandex.Disk opened its API.  I quickly implemented the WebDAV API service using C ++ \ Qt, and GUI using QML.  It turned out <a href="http://store.ovi.com/content/317076">pretty well</a> - a simple and reliable program, most of the reviews are positive (well, except for those who did not figure out how to log in = \). <br>  After some time, I decided to participate in the OpenSource development of basic applications for Ubuntu Phone - this is how I met the Ubuntu SDK while working on the RSS Reader ‚ÄúShorts‚Äù.  Meanwhile, the Ubuntu App Showdown was approaching.  I decided to participate with my client in the ‚ÄúPorted applications‚Äù category (you can port from any OS), the benefit of transferring the code from MeeGo to Ubuntu Phone is actually trivial.  It was not possible to win for technical reasons.  However, the result was an excellent Yandex.Disk client under Ubuntu Phone.  However, he also had a drawback - the C ++ part was assembled under ARM only, as a result, at the package level, the cross-platform was lost. <br>  And most recently, I received a notification from Yandex about the release of a new REST API Disk in production.  I immediately thought about implementing this API in pure JavaScript.  For those who do not know - QML (not particularly strictly speaking) includes JavaScript, that is, it allows you to use all the features of this language, in conjunction with the capabilities of the Qt library (properties, signals, etc.), the result is quite powerful and flexible combination).  The result would be a fully cross-platform implementation of the Yandex.Disk client (for all platforms where Qt is available, of course). <br><br><h5>  Baseline and Objectives </h5><br>  So, there is a <u>ready-made application</u> that allows you to perform various operations on the contents of Yandex.Disk (copy, move, delete, retrieve public links, etc.).  The network part is implemented using C ++ \ Qt, as well as the storage of the display data model.  <u>The task</u> is to switch to a new API of the service, having already implemented it in JavaScript and not making revisions in the UI code. <br><img src="https://habrastorage.org/getpro/habr/post_images/76d/bdc/aae/76dbdcaaefc6e6a2dc6e46f9341d061a.png" alt="image"><br><br><h5>  REST API implementation </h5><br>  I developed for myself a simple technique for implementing a web service API.  It consists in using the extremely lightweight type QtObject with a custom set of properties and methods.  Schematically it looks like this: <br><pre><code class="javascript hljs">QtObject { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: yadApi signal responseReceived(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resObj, string code, int requestId) property string clientId: <span class="hljs-string"><span class="hljs-string">"2ad4de036f5e422c8b8d02a8df538a27"</span></span> property string clientPass: <span class="hljs-string"><span class="hljs-string">""</span></span> property string accessToken: <span class="hljs-string"><span class="hljs-string">""</span></span> property int expiresIn: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">// Public methods... // Private methods... }</span></span></code> </pre> <br>  The ‚ÄúresponseReceived‚Äù signal is sent by the API object each time an asynchronous response comes from XMLHttpRequest (see below).  The ‚ÄúaccessToken‚Äù and ‚ÄúexpiresIn‚Äù properties are set after passing authorization through OAuth from the outside (on the login page for this task, WebView is used - it requests the URL from yadApi to get the token, follows it, prompts the user to enter their data, if successful his life time). <br>  And here is one of the public API methods - file deletion: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">path, permanently</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!path) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseUrl = <span class="hljs-string"><span class="hljs-string">"https://cloud-api.yandex.net/v1/disk/resources?path="</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (permanently) baseUrl += <span class="hljs-string"><span class="hljs-string">"&amp;permanently=true"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> __makeRequst(baseUrl, <span class="hljs-string"><span class="hljs-string">"remove"</span></span>, <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>) }</code> </pre><br>  It is very simple - the request URL is formed from the passed parameters, and then passed to the __maReqqest internal method.  It looks like this: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__makeRequst</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, code, method</span></span></span><span class="hljs-function">) </span></span>{ method = method || <span class="hljs-string"><span class="hljs-string">"GET"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task = {<span class="hljs-string"><span class="hljs-string">"code"</span></span> : code, <span class="hljs-string"><span class="hljs-string">"doc"</span></span> : doc, <span class="hljs-string"><span class="hljs-string">"id"</span></span> : __requestIdCounter++} doc.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc.readyState === XMLHttpRequest.DONE) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resObj = {} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doc.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { resObj.request = task resObj.response = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(__preProcessData(code, doc.responseText)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Error resObj.request = task resObj.isError = true resObj.responseDetails = doc.statusText resObj.responseStatus = doc.status } __emitSignal(resObj, code, doc.requestId) } } doc.open(method, request, true) doc.setRequestHeader("Authorization", "OAuth " + accessToken) doc.send() return task }</span></span></code> </pre><br>  In the above piece of code, you can see the promised XMLHttpRequest, as well as sending a signal to receive the result.  In addition, a request object is formed - it is an operation code, an identifier, and the XMLHttpRequest itself.  Later it can be used for cancellation, processing of the result, etc.  If suddenly someone becomes interested in "__emitSignal" - it is implemented trivially: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__emitSignal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resObj, operationCode, requestId</span></span></span><span class="hljs-function">) </span></span>{ responseReceived(resObj, operationCode, requestId) }</code> </pre><br>  This code can be used to log and intercept sending signals.  As for the internal function "__preProcessData" - it does not do anything (!), It is a bookmark for the future.  The fact is that I have learned from bitter experience in this regard - when working with the Steam API, 64-bit numbers sometimes come up in the JSON of responses, moreover, they are not enclosed in quotes.  As a result, JavaScript perceives them as double, accuracy is lost, and long live sadness, sadness!  The solution was the preprocessing of incoming data, enclosing numbers in quotes, as well as the subsequent work with them already as with strings. <br>  And by and large this is all - one by one all the API methods I needed were implemented, namely creating a folder, copying, moving, deleting, loading, changing the status of publicity.  In total, there were 140 (!) Lines of code in QML \ JS, which functionally completely replaced one thousand other lines of code with C ++ \ Qt implementations of the WebDAV protocol. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Implementation of the layer </h5><br>  The implementation of the WebDAV protocol in C ++ turned out to be quite simple and transparent, but it was inconvenient to use it directly from QML.  In the old version, a special class Bridge (a la KO) was created as an intermediary, which makes it easier to work with the service.  I decided not to abandon this approach in the new version and neatly replace my old Bridge with a new, similarly named QML type with an identical set of methods and properties.  To support the API, so to speak, UI would continue to cause the same functions, but absolutely other entity.  Again, schematically, it looks like this: <br><pre> <code class="javascript hljs">QtObject { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: bridgeObject property string currentFolder: <span class="hljs-string"><span class="hljs-string">"/"</span></span> property bool isBusy: taskCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> property int taskCount: <span class="hljs-number"><span class="hljs-number">0</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks: [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slotMoveToFolder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">folder</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isBusy) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-comment"><span class="hljs-comment">// .... code } function slotDelete(entry) { __addTask(yadApi.remove(entry)) } property QtObject yadApi: YadApi { id: yadApi onResponseReceived: { __removeTask(resObj.request) switch (resObj.request.code) { case "metadata": // console.log(JSON.stringify(resObj)) if (!resObj.isError) { var r = resObj.response currentFolder = __checkPath(r.path) // Filling model } // !isError break; case "move": case "copy": case "create": case "delete": case "publish": case "unpublish": __addTask(yadApi.getMetaData(currentFolder)) break; } // API property ListModel folderModel: ListModel { id: dirModel } }</span></span></code> </pre><br>  So, to replace my own class, I needed the ‚ÄúcurrentFolder‚Äù and ‚ÄúisBusy‚Äù properties.  The first property is used to store the current directory path when navigating.  It is kept up-to-date in the ‚ÄúslotMoveToFolder‚Äù method.  We also added several properties and methods for taking into account running queries (__addTask, __removeTask, the tasks array and its taskCount length. <i>Just don‚Äôt have to be CO now and say that the array has a length and so the property allows you to make binding in QML, This case is used only in isBusy, in the future somewhere else</i> ).  I left the function naming as before - starting with the ‚Äúslot‚Äù prefix (in the C ++ version of the class, methods from QML could be made visible in two ways: make them slots or use Q_INVOKABLE).  For brevity, again I left only the method of deleting and moving to the specified directory, all the rest are also present in the full version of the source code.  Methods of type Bridge are called directly from the UI. <br>  One of the properties of the new Bridge is the implementation of the API described above - YadApi.  Also at the place of creation, listening to signals about the completion of the operation is performed with the execution of appropriate actions.  So, renaming or deleting, for example, causes a reload of the directory contents. <br>  Special attention is given to the data model - dirModel.  In the previous implementation, I had the FolderModel class, which inherited from QAbstractItemModel according to the classic scenario - introducing my own roles (those who are familiar with Qt will understand a little about what they mean) and so on.  Now, all of this was easily abandoned in favor of the standard ListModel, which can store JS objects.  This model is populated as follows: <br><pre> <code class="javascript hljs">dirModel.clear() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = r._embedded.items <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; items.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itm = items[i] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = { <span class="hljs-comment"><span class="hljs-comment">/* All entries attributes */</span></span> <span class="hljs-string"><span class="hljs-string">"href"</span></span> : __checkPath(itm.path), <span class="hljs-string"><span class="hljs-string">"isFolder"</span></span> : itm.type == <span class="hljs-string"><span class="hljs-string">"dir"</span></span>, <span class="hljs-string"><span class="hljs-string">"displayName"</span></span> : itm.name, <span class="hljs-string"><span class="hljs-string">"lastModif"</span></span> : itm.modified, <span class="hljs-string"><span class="hljs-string">"creationDate"</span></span> : itm.created, <span class="hljs-comment"><span class="hljs-comment">/* Custom attributes */</span></span> <span class="hljs-string"><span class="hljs-string">"contentLen"</span></span> : itm.size ? itm.size : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"contentType"</span></span> : itm.mime_type ? itm.mime_type : <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"publicUrl"</span></span> : itm.public_url ? itm.public_url : <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"publicKey"</span></span> : itm.public_key ? itm.public_key : <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"isPublished"</span></span> : itm.public_key ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"isSelected"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"preview"</span></span> : itm.preview } dirModel.append(o) }</code> </pre><br>  Property names in the model also had to be left as in the old version for compatibility.  I can‚Äôt say that in the C ++ model implementation I got a very large class, but it‚Äôs very pleasant to get rid of it using the standard model and such a small structure! <br><br><h5>  Conclusion </h5><br>  In the end, I completely abandoned C ++ in my Yandex.Disk client.  I do not in any way mean that there is something bad or like that in the pros.  Not!  The purpose of my article was to show the capabilities of pure QML ‚Äî it can really do a lot with its help, although its primary task is to develop a UI (in this article, it is not actually affected).  And the code looks simple and clear <s>, not at all like the implementation of a calculator on CSS</s> ! <br>  Thanks for attention!  The code can be found <a href="https://code.launchpad.net/~mrqtros/yad/trunk">on launchpad'e</a> . <br><br>  PS Questions are welcome, if you wish I can disclose any part of the article in more detail! <br>  PSS In the next article I plan to touch on the key aspects and tools of the Ubuntu SDK. </div><p>Source: <a href="https://habr.com/ru/post/230435/">https://habr.com/ru/post/230435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230417/index.html">Using the principles of gestalt psychology to increase the conversion of sites. Part 3: Cost Benefit Analysis</a></li>
<li><a href="../230421/index.html">Writing your autocompletions for Shell. Part 1: zsh</a></li>
<li><a href="../230425/index.html">Writing your autocompletions for Shell. Part 2: bash</a></li>
<li><a href="../230427/index.html">Indie games are like indie games only.</a></li>
<li><a href="../230431/index.html">Using elements as background images with -moz-element</a></li>
<li><a href="../230439/index.html">How to create clear logical (L3) network diagrams</a></li>
<li><a href="../230441/index.html">JQuery Deferred - usage examples</a></li>
<li><a href="../230443/index.html">Structuring, grouping and binding in SVG - elements <g>, <use>, <defs> and <symbol></a></li>
<li><a href="../230445/index.html">Comparison of first-generation manned spacecraft</a></li>
<li><a href="../230449/index.html">18 surprises when reading jQuery source code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>