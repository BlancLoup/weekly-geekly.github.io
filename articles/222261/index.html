<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross-platform CommonJS in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What are we talking about? 
 About JS modules that can be used in the browser and on the server. About their interaction and external dependencies. Le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross-platform CommonJS in practice</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/383/9b2/f05/3839b2f05fce04cfa7602d5375950e82.png" align="right"><br><h4>  What are we talking about? </h4><br>  About JS modules that can be used in the browser and on the server.  About their interaction and external dependencies.  Less theory, more practice.  As part of the young fighter's course, we are implementing a simple and very original application based on Node.JS: ToDo-list.  For this we have to: <br><ol><li>  ‚ÄúStart‚Äù cross-platform modules based on the Express framework; </li><li>  Teach them to work with platform-dependent colleagues; </li><li>  Create a transport layer between the client and the server; </li><li>  Taki make ToDo-list; </li><li>  Comprehend the result. </li></ol><br><a name="habracut"></a><br><h4>  Application Requirements </h4><br>  Let's focus on the essence of the whole idea and take on the implementation of the minimum functionality.  Requirements are formulated as follows: <br><ol><li>  The application is accessible using a browser; </li><li>  The user works with his ToDo list in one session.  When reloading the page, the list should remain; after closing the tab or browser, a new one should be created; </li><li>  The user can add new items to the list; </li><li>  The user can mark the added item as completed. </li></ol><br><br><h4>  Making a frame </h4><br>  Without problems, we raise the framework of the application based on the <a href="http://expressjs.com/guide.html">Express framework</a> .  We will slightly modify the structure we received from the box: <br><pre><code class="hljs axapta">. ‚îú‚îÄ‚îÄ bin ‚îú‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">//     ,   ‚îú‚îÄ‚îÄ modules //  , ,  CommonJS  ‚îú‚îÄ‚îÄ public ‚îÇ  ‚îî‚îÄ‚îÄ stylesheets ‚îú‚îÄ‚îÄ routes ‚îî‚îÄ‚îÄ views</span></span></code> </pre> <br><br>  Let's create our first module from the subject area - Point, the constructor of the ToDo list item: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// modules/Point/Point.js /** *    * @param {Object} params * @param {String} params.description * @param {String} [params.id] * @param {Boolean} [params.isChecked] * @constructor */ function Point(params) { if (!params.description) { throw 'Invalid argument'; } this._id = params.id; this._description = params.description; this._isChecked = Boolean(params.isChecked); } Point.prototype.toJSON = function () { return { id: this._id, description: this._description, isChecked: this._isChecked }; }</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Fully</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @param {String} id */</span></span> Point.prototype.setId = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!id) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'Invalid argument'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._id = id; } <span class="hljs-comment"><span class="hljs-comment">/** * @returns {String} */</span></span> Point.prototype.getId = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._id; } Point.prototype.check = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._isChecked = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } Point.prototype.uncheck = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._isChecked = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * @returns {Boolean} */</span></span> Point.prototype.getIsChecked = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._isChecked; } <span class="hljs-comment"><span class="hljs-comment">/** * @returns {String} */</span></span> Point.prototype.getDescription = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._description; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = Point;</code> </pre><br></div></div><br>  Wonderful.  This is our first cross-platform module and we can already use it on the server, for example, like this: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// routes/index.js var express = require('express'); var router = express.Router(); /* GET home page. */ router.get('/', function (req, res) { var Point = require('../modules/Point'); var newPoint = new Point({ description: 'Do something' }); console.log('My new point:', newPoint); }); module.exports = router;</span></span></code> </pre><br>  There are several ways to work with the CommonJS module in the browser, the easiest to set up and use is middleware for Express <a href="https://github.com/ForbesLindesay/browserify-middleware">browserify-middleware</a> : <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// app.js // ... var browserify = require('browserify-middleware'); app.use('/client', browserify('./client')); // ...</span></span></code> </pre><br>  By adding such simple code, we can immediately write the first lines of our client application: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// client/todo.js var console = require('console'); //  `node_modules/browserify/node_modules/console-browserify` var Point = require('../modules/Point');</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Browserify uses the Nodov <a href="http://nodejs.org/api/modules.html">algorithm for loading modules</a> , and also provides <a href="http://nodejs.org/api/modules.html">browser implementations of core libraries</a> .  This has already been written a lot, so I‚Äôll just say that the script loaded at <i>/client/todo.js is now</i> fully functional in the browser. <br><br><h4>  Let's talk about the modules </h4><br>  In my project I used the following conditional division of modules: <br><br>  <b>Utilitarian modules</b> <br>  With their help, the developer organizes and accompanies the code.  For example, in our case, this is a library of promises <a href="https://github.com/dfilatov/vow">Vow</a> , <a href="http://lodash.com/">lodash</a> , console.  Most of these modules are not only cross-platform, but also support several download formats (CommonJS, AMD). <br><br>  <b>Domain Modules</b> <br>  Provide an interface for working with domain objects.  We have already created one such module - the Point constructor, soon there will be a list module, providing the interface we need (addPoint, getPoints, checkPoint) and the user module, which is responsible for initializing the user session. <br><br>  Such modules can be either fully cross-platform or have platform-specific parts.  For example, some methods or properties should not be available in the browser.  But most often the platform-specific part falls into the following category of modules. <br><br>  <b>DAL modules (Data Access Layer)</b> <br>  These are modules that are responsible for accessing data from an arbitrary set of sources and their conversion into an internal representation (objects, collections) and vice versa.  For the browser, it can be localStorage, sessionStorage, cookies, external API.  On the server, the choice is even greater: the whole chain of databases, the file system and, again, some external API. <br><br>  If the cross-platform domain module interacts with the DAL, then the DAL module must have a browser and server implementation with a single interface.  Technically, we can organize this using a <a href="https://github.com/substack/node-browserify">useful browserify feature</a> , which consists in specifying the <i>browser</i> property in the module's package.json.  Thus, domain modules can work with different DAL modules depending on the execution environment: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"dal"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span> : <span class="hljs-string"><span class="hljs-string">"./node.js"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//     "browser": "./browser.js" //   browserify     }</span></span></code> </pre><br><br><h4>  We implement modules </h4><br>  What modules will be required for our task?  Let memcache act on the server as storage, we will store our ToDo lists in it.  User identification will occur in the browser, put the session identifier in sessionStorage and will transmit with each request to the server.  Accordingly, on the server we will need to pick up this identifier from the request parameters. <br><br>  It turns out that at the DAL level we have to implement the protocol of interaction with sessionStorage and <a href="https://github.com/elbart/node-memcache">memcache</a> (we implement the retrieval of the request parameters using standard Express tools). <br><div class="spoiler">  <b class="spoiler_title">modules / dal / browser / sessionStorage.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.set = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ sessionStorage.setItem.apply(sessionStorage, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.get = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionStorage.getItem.apply(sessionStorage, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">modules / dal / node / memcache.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vow = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vow'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memcache = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'memcache'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> memcache.Client(<span class="hljs-number"><span class="hljs-number">21201</span></span>, <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientDefer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> vow.Promise(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) </span></span>{ client .on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, resolve) .on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, reject) .on(<span class="hljs-string"><span class="hljs-string">'timeout'</span></span>, reject) .on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, reject) .connect(); }); <span class="hljs-comment"><span class="hljs-comment">/** *    Memcache * @see {@link https://github.com/elbart/node-memcache#usage} * @param {String} clientMethod * @param {String} key * @param {*} [value] * @returns {vow.Promise} resolve with {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clientMethod, key, value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestParams = [key]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isUndefined(value)) { requestParams.push(value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> vow.Promise(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) </span></span>{ requestParams.push(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { reject(err); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resolve(data); } }); clientDefer.then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ client[clientMethod].apply(client, requestParams); }, reject); }); } <span class="hljs-comment"><span class="hljs-comment">/** *     * @param {String} key * @param {*} value * @returns {vow.Promise} */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.set = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request(<span class="hljs-string"><span class="hljs-string">'set'</span></span>, key, value); } <span class="hljs-comment"><span class="hljs-comment">/** *     * @param {String } key * @returns {vow.Promise} resolve with {String} */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.get = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request(<span class="hljs-string"><span class="hljs-string">'get'</span></span>, key); }</code> </pre><br></div></div><br>  Now we can implement the following User domain module, which will provide us with an object with a single <i>getId</i> method: <br><div class="spoiler">  <b class="spoiler_title">modules / user / dal / browser.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storage = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../dal/browser/sessionStorage'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = <span class="hljs-string"><span class="hljs-string">'todo_user_id'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   id * @returns {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> possible = <span class="hljs-string"><span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { text += possible.charAt(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * possible.length)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/** * @returns {String} */</span></span> getId: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userId = storage.get(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!userId) { userId = makeId(); storage.set(key, userId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> userId; } };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">modules / user / dal / node.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../../app'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/** * @returns {String} */</span></span> getId: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app.get(<span class="hljs-string"><span class="hljs-string">'userId'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     middleware } };</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">modules / user / dal / package.json</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"dal"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span> : <span class="hljs-string"><span class="hljs-string">"./node.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"browser"</span></span>: <span class="hljs-string"><span class="hljs-string">"./browser.js"</span></span> }</code> </pre><br></div></div><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// modules/user/user.js var dal = require('./dal'); //     ./dal/browser.js,   - ./dal/node.js function User() { } /** *    * @returns {String} */ User.prototype.getId = function () { return dal.getId(); } module.exports = new User();</span></span></code> </pre><br><br>  We will organize the interaction between the browser and the server based on the REST protocol, which will require us to implement it at the DAL level for the browser: <br><div class="spoiler">  <b class="spoiler_title">modules / dal / browser / rest.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vow = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'vow'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *    REST API * @param {String} moduleName -   * @param {String} methodName -   * @param {Object} params -   * @param {String} method -   * @returns {vow.Promise} resolve with {Object} xhr.response */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.request = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleName, methodName, params, method</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">'/api/'</span></span> + moduleName + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + methodName + <span class="hljs-string"><span class="hljs-string">'/?'</span></span>, paramsData = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_.isObject(params)) { paramsData = _.map(params, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">param, paramName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> paramName + <span class="hljs-string"><span class="hljs-string">'='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(param); }).join(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method !== <span class="hljs-string"><span class="hljs-string">'POST'</span></span> &amp;&amp; paramsData) { url += paramsData; paramsData = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> vow.Promise(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(method, url); xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'json'</span></span>; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(xhr.status === <span class="hljs-number"><span class="hljs-number">200</span></span>) { resolve(xhr.response); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { reject(xhr.response || xhr.statusText); } }; xhr.send(paramsData); }); }</code> </pre><br></div></div><br>  and a special Express router that will work with our domain modules: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// routes/api.js // ... router.use('/:module/:method', function (req, res) { var module = require('../modules/' + req.params.module), method = module[req.params.method]; if (!method) { res.send(405); return; } method.apply(module, req.apiParams) .then(function (data) { res.json(data); }, function (err) { res.send(400, JSON.stringify(err)); }); }); // ...</span></span></code> </pre><br>  Based on the conditions of the problem, we must provide the following methods to the API: <br><ol><li>  GET, / list / getPoints - get a to-do list in the ToDo list of the current user; </li><li>  POST, / list / addPoint ‚Äî get a new item in the ToDo list of the current user; </li><li>  POST, / list / checkPoint - mark the item as done; </li></ol><br>  In the case of adding a new item, we will have to impose additional responsibilities on the router: converting the request parameters into an internal representation for transfer to the module: <br><pre> <code class="javascript hljs">router.post(<span class="hljs-string"><span class="hljs-string">'/list/addPoint'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Point = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../modules/Point'</span></span>), point; req.apiParams = []; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(req.param(<span class="hljs-string"><span class="hljs-string">'point'</span></span>))); req.apiParams.push(point); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} next(); });</code> </pre><br>  Great, now we can implement the final module of the subject domain list: <br><div class="spoiler">  <b class="spoiler_title">modules / list / dal / browser.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rest = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../dal/browser/rest'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Point = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../Point'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @returns {vow.Promise} resolve with {Point[]} */</span></span> getPoints: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rest.request(<span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-string"><span class="hljs-string">'getPoints'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">userId</span></span>: user.getId()}, <span class="hljs-string"><span class="hljs-string">'GET'</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">points</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.map(points, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(point); }); }); }, <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @param {Point} point * @returns {vow.Promise} resolve with {Point} */</span></span> addPoint: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestParams = { <span class="hljs-attr"><span class="hljs-attr">userId</span></span>: user.getId(), <span class="hljs-attr"><span class="hljs-attr">point</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(point) }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rest.request(<span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-string"><span class="hljs-string">'addPoint'</span></span>, requestParams, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(point); }); }, <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @param {Point} point * @returns {vow.Promise} */</span></span> checkPoint: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestParams = { <span class="hljs-attr"><span class="hljs-attr">userId</span></span>: user.getId(), <span class="hljs-attr"><span class="hljs-attr">pointId</span></span>: point.getId() }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rest.request(<span class="hljs-string"><span class="hljs-string">'list'</span></span>, <span class="hljs-string"><span class="hljs-string">'checkPoint'</span></span>, requestParams, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>); } };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">modules / list / dal / node.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'lodash'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memcache = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../dal/node/memcache'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Point = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../Point'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *       * @param {User} user * @returns {String} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getListKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'list_'</span></span> + user.getId(); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @returns {vow.Promise} resolve with {Point[]} */</span></span> getPoints: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memcache.get(getListKey(user)) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">points</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (points) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { points = _.map(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(points), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(point); }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { points = []; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { points = []; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> points; }); }, <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @param {Point} point * @returns {vow.Promise} resolve with {Point} */</span></span> addPoint: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getPoints(user) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">points</span></span></span><span class="hljs-function">) </span></span>{ point.setId(<span class="hljs-string"><span class="hljs-string">'point_'</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime())); points.push(point); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memcache.set(getListKey(user), <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(points)) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> point; }); }); }, <span class="hljs-comment"><span class="hljs-comment">/** * @param {User} user * @param {Point} point * @returns {vow.Promise} */</span></span> checkPoint: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, point</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getPoints(user) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">points</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = _.find(points, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p.getId() === point.getId(); }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'Point not found'</span></span>; } p.check(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memcache.set(getListKey(user), <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(points)); }); } };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">modules / list / dal / package.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"dal"</span></span>, <span class="hljs-string"><span class="hljs-string">"main"</span></span> : <span class="hljs-string"><span class="hljs-string">"./node.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"browser"</span></span>: <span class="hljs-string"><span class="hljs-string">"./browser.js"</span></span> }</code> </pre><br></div></div><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// modules/list/list.js //   var _ = require('lodash'); var vow = require('vow'); var console = require('console'); // DAL- var dal = require('./dal'); //    var Point = require('../Point'); var user = require('../user'); var list = {}; var cache = {}; //   /** *       * @param {Point} newPoint * @returns {vow.Promise} resolve with {Point} */ list.addPoint = function (newPoint) { /* ... */ } /** *     * @param {String} pointId * @returns {vow.Promise} */ list.checkPoint = function (pointId) { /* ... */ } /** *      * @returns {vow.Promise} resolve with {Point[]} */ list.getPoints = function () { console.log('list / getPoints'); return new vow.Promise(function (resolve, reject) { var userId = user.getId(); if (_.isArray(cache[userId])) { resolve(cache[userId]); return; } dal.getPoints(user) .then(function (points) { cache[userId] = points; console.log('list / getPoints: resolve', cache[userId]); resolve(points); }, reject); }); } module.exports = list;</span></span></code> </pre><br>  Structurally, the modules of our application began to look like this: <br><pre> <code class="hljs pgsql">modules ‚îú‚îÄ‚îÄ dal ‚îÇ  ‚îú‚îÄ‚îÄ browser ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ rest.js ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ sessionStorage.js ‚îÇ  ‚îî‚îÄ‚îÄ node ‚îÇ  ‚îî‚îÄ‚îÄ memcache.js ‚îú‚îÄ‚îÄ list ‚îÇ  ‚îú‚îÄ‚îÄ dal ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ browser.js //  dal/browser/rest.js ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ node.js //  dal/node/memcache.js ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ package.json ‚îÇ  ‚îú‚îÄ‚îÄ list.js ‚îÇ  ‚îî‚îÄ‚îÄ package.json ‚îú‚îÄ‚îÄ <span class="hljs-type"><span class="hljs-type">Point</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ package.json ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-type"><span class="hljs-type">Point</span></span>.js ‚îî‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ‚îú‚îÄ‚îÄ dal ‚îÇ  ‚îú‚îÄ‚îÄ browser.js //  dal/browser/sessionStorage.js ‚îÇ  ‚îú‚îÄ‚îÄ node.js ‚îÇ  ‚îî‚îÄ‚îÄ package.json ‚îú‚îÄ‚îÄ package.json ‚îî‚îÄ‚îÄ <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.js</code> </pre><br><br><h4>  Together </h4><br>  It's time to implement the logic of our application.  Let's start by adding a new item to the ToDo list: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// client/todo.js // ... //    -           var console = require('console'); var _ = require('lodash'); var list = require('../modules/list'); var Point = require('../modules/Point'); var todo = { addPoint: function (description) { var point = new Point({ description: description }); list.addPoint(point); } }; // ...</span></span></code> </pre><br>  What happens when you call todo.addPoint ('Test')?  I will try to draw the main steps in the diagrams.  To begin, consider the interaction of modules in the browser: <br><div class="spoiler">  <b class="spoiler_title">Diagram</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/64c/019/0fe/64c0190fe78d7a708f2105c88baf3e18.png"><br></div></div><br>  As you can see, the list module 2 times refers to its DAL-module, which makes http-requests to our API. <br>  This is how the interaction of the same (for the most part) modules on the server side looks like: <br><div class="spoiler">  <b class="spoiler_title">Bigger chart</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/f3b/69c/0c1/f3b69c0c1b1e36727b8df2465c7e993a.png"><br></div></div><br>  Here's what happens: the interaction between the modules of the subject area and the DAL modules in the browser and on the server is identical.  Differ, as we planned, the interaction protocols and data sources at the DAL level. <br><br>  The case will work in the same way with the ‚Äúcrossing out‚Äù clause: <br><pre> <code class="javascript hljs">list.checkPoint(pointId);</code> </pre><br>  Another couple of minutes - and our application is ready. <br><div class="spoiler">  <b class="spoiler_title">Code. Readable?</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// client/todo.js (function () { var console = require('console'); var _ = require('lodash'); var list = require('../modules/list'); var Point = require('../modules/Point'); var listContainer = document.getElementById('todo_list'); var newPointContainer = document.getElementById('todo_new_point_description'); var tmpl = '&lt;ul&gt;' + '&lt;% _.forEach(points, function(point) { %&gt;' + '&lt;li data-id="&lt;%- point.getId() %&gt;" data-checked="&lt;%- point.getIsChecked() ? 1 : \'\' %&gt;" class="&lt;% if (point.getIsChecked()) { %&gt;todo_point_checked &lt;% }; %&gt;"&gt;' + '&lt;%- point.getDescription() %&gt;' + '&lt;/li&gt;&lt;% }); %&gt;' + '&lt;/ul&gt;'; var todo = { addPoint: function (description) { var point = new Point({ description: description }); list.addPoint(point) .then(todo.render, todo.error); }, checkPoint: function (pointId) { list.checkPoint(pointId) .then(todo.render, todo.error); }, render: function () { list.getPoints() .then(function (points) { listContainer.innerHTML = _.template(tmpl, { points: points }); }); }, error: function (err) { alert(err); } }; newPointContainer.addEventListener('keyup', function (ev) { if (ev.keyCode == 13 &amp;&amp; ev.ctrlKey &amp;&amp; newPointContainer.value) { todo.addPoint(newPointContainer.value); newPointContainer.value = ''; } }); listContainer.addEventListener('click', function (ev) { var targetData = ev.target.dataset; if (!targetData.checked) { console.debug(targetData.checked); todo.checkPoint(targetData.id); } }); todo.render(); })();</span></span></code> </pre><br></div></div><br>  <b>Repository code</b> : <a href="https://github.com/psyduckinattack/todo-commonjs">github</a> . <br><br><h4>  Comprehend </h4><br>  Why, actually, this whole conversation?  At the moment I have some moral satisfaction from the work done and a number of questions about its feasibility.  How suitable is this model for complex projects and where are the limits of its application?  Am I prepared to put up with the inevitable overhead that an application based on cross-platform modules will have? <br><br>  Until full understanding so far away.  In any case, it is good to be able to do something like this and think about the prospects.  Cross-platform frameworks and component tests - why not? <br></div><p>Source: <a href="https://habr.com/ru/post/222261/">https://habr.com/ru/post/222261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222247/index.html">Swipe gestures in Internet Explorer and other browsers</a></li>
<li><a href="../222249/index.html">Signed a law on the right of the Cabinet to regulate the threshold of duty-free e-commerce</a></li>
<li><a href="../222253/index.html">PHDays IV: Registration is now open for Competitive Intelligence and Hash Runner online contests.</a></li>
<li><a href="../222257/index.html">Stock Market Toolkit: What are Futures and How Do They Work?</a></li>
<li><a href="../222259/index.html">Development of REST API on Express, Restify, hapi and LoopBack</a></li>
<li><a href="../222263/index.html">The fifth international application development forum Apps4All will be held in Moscow</a></li>
<li><a href="../222265/index.html">Special Report 301 (2014)</a></li>
<li><a href="../222267/index.html">Higher School of Economics opens the program "Management of online gaming projects"</a></li>
<li><a href="../222275/index.html">Jelastic 2 will have access via SSH</a></li>
<li><a href="../222277/index.html">CARDIAC - do-it-yourself computer paper</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>