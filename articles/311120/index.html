<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virtual Private Cloud: Image Preparation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Virtual Private Cloud service has a large set of ready-made operating system images for creating virtual machines. 


 However, many users need im...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virtual Private Cloud: Image Preparation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a64/ea9/67a/a64ea967a5bfc5b9cbfdfc14100e9d49.png" alt="VPC Image Building" width="100%" height="100%"><br><br><p>  The <a href="https://selectel.ru/services/vpc/" rel="nofollow">Virtual Private Cloud</a> service has a large set of ready-made operating system images for creating virtual machines. </p><br><p>  However, many users need images that are missing from our service, for example, it may be a less common type or version of the required operating system. </p><br><p>  Sometimes it becomes necessary to change the set of pre-installed packages or the system configuration files in the finished image ‚Äî for example, for users who deploy a cluster of similar servers. </p><br><p>  In order not to make the same setup every time after installing the server, you can prepare an image with the required changes and thus speed up the installation of a large number of similar virtual machines.  In this article we will show how this is done. </p><a name="habracut"></a><br><p>  As an example, the image of Ubuntu 16.04 will be used: preparing the working environment, setting the necessary parameters, building and uploading the image to the cloud service. </p><br><p>  Also, the necessary steps to prepare the image with full compatibility with all the additional features of the Virtual Private Cloud service will be considered. </p><br><p>  We will use <a href="http://docs.openstack.org/developer/diskimage-builder/" rel="nofollow">diskimage-builder</a> as a tool for building an image.  This is a set of components for preparing images of operating systems, file systems, RAM disks with open source code, supported by the OpenStack community. </p><br><p>  The tool supports image creation of most common GNU / Linux distributions: </p><br><ul><li>  Centos </li><li>  Debian </li><li>  Fedora </li><li>  Rhel </li><li>  Ubuntu </li><li>  Gentoo </li><li>  OpenSUSE </li></ul><br><p>  By default, diskimage-builder prepares the image of the cloud version of the operating system, so the image will contain the <a href="https://launchpad.net/cloud-init" rel="nofollow">cloud-init</a> and <a href="https://launchpad.net/cloud-utils" rel="nofollow">cloud-utils</a> packages necessary for automatic configuration of the system in the cloud. </p><br><h2>  Creating a Ubuntu 16.04 Image </h2><br><p>  We will prepare the image on a machine running Ubuntu 14.04. </p><br><p>  First, install the necessary dependencies: </p><br><pre><code class="bash hljs">sudo apt update sudo apt -y install python-pip curl</code> </pre> <br><p>  Then install the diskimage-builder: </p><br><pre> <code class="bash hljs">sudo pip install diskimage-builder</code> </pre><br><p>  Create the base directories for work: </p><br><pre> <code class="bash hljs">mkdir -p ~/diskimage-builder/{images,elements}</code> </pre><br><p>  To set up diskimage-builder, we need to specify several additional parameters, the value of which is stored directly in the environment variables of the command shell (so you can specify them on the command line): </p><br><ul><li>  <strong>ARCH = "amd64"</strong> - image architecture. <br><br></li><li>  <strong>BASE_ELEMENTS = "ubuntu bootloader cloud-init-datasources"</strong> - here we will indicate the used <a href="http://docs.openstack.org/developer/diskimage-builder/elements.html" rel="nofollow">elements of</a> diskimage-builder.  Elements are a set of bash scripts that perform all the routine actions to prepare and change the image.  The most important for us is the ubuntu element, which downloads and unpacks the standard official distribution image, installs the required packages and updates the system to the current state inside the image using the <a href="https://en.wikipedia.org/wiki/Chroot" rel="nofollow">chroot</a> utility, and assembles everything back into an image ready for use.  The bootloader element installs the bootloader (in our case GRUB2) into the system image being prepared, and cloud-init-datasources passes the list of data sources for the cloud-init utility, which is required for initial setup of the operating system at startup. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  <strong>DIB_CLOUD_INIT_DATASOURCES = "ConfigDrive, Ec2"</strong> - data sources for the cloud-init-datasources element. <br><br></li><li>  <strong>DIB_RELEASE = "xenial"</strong> - the version of the operating system on the basis of which we will create an image. <br><br></li><li>  <strong>IMAGE_PATH = "~ / diskimage-builder / images / ubuntu-16.04"</strong> - the name and path for the image. </li></ul><br><p>  The image is assembled using the command: </p><br><pre> <code class="bash hljs">disk-image-create vm <span class="hljs-variable"><span class="hljs-variable">$BASE_ELEMENTS</span></span> -t raw -o <span class="hljs-variable"><span class="hljs-variable">$IMAGE_PATH</span></span></code> </pre><br><p>  After the -t switch, we specify the desired image format.  Images are <a href="http://docs.openstack.org/developer/diskimage-builder/user_guide/building_an_image.html" rel="nofollow">supported</a> : qcow2, tar, vhd, docker, raw. </p><br><p>  Before directly assembling an image, you will most likely need to make additional settings in the system, for example: </p><br><ul><li>  install additional packages in the system; </li><li>  disable the <a href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/" rel="nofollow">predictable_interface_naming</a> mechanism, which renames the familiar interface names eth0, eth1, ... into names like enp0s3, ens3, etc; </li><li>  disable the creation of the user ‚Äúubuntu‚Äù and allow access to the user ‚Äúroot‚Äù via the SSH protocol; </li><li>  Regenerate SSH keys for each virtual machine created from this image; </li><li>  change the preset time zone. </li></ul><br><p>  To do this, we need to create an additional element in the ~ / diskimage-builder / elements directory. </p><br><p>  Create directories: </p><br><pre> <code class="bash hljs">mkdir -p ~/diskimage-builder/elements/ubuntu-16-custom/{install.d,post-install.d,finalise.d}</code> </pre><br><p>  Inside the ~ / diskimage-builder / elements / ubuntu-16-custom directory, create a README.rst file with the description of the new element: </p><br><pre> <code class="bash hljs">================ ubuntu-16-custom ================ Customize Ubuntu 16.04 (Xenial)</code> </pre><br><p>  In the ~ / diskimage-builder / elements / ubuntu-16-custom / install.d directory create the script 50-install-additional-packages: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash packages="python2.7 python python-minimal" apt -y install $packages</span></span></code> </pre><br><p>  The scripts in the <a href="http://docs.openstack.org/developer/diskimage-builder/developer/developing_elements.html" rel="nofollow">install.d</a> directory are executed when the image is assembled during the installation of the main packages.  The 50-install-additional-packages script we created will install version 2.7 of the python system, which is still required for many applications to work.  By default, only python version 3.5 is present in the Ubuntu 16.04 image. </p><br><p>  You can also add to this list the necessary packages that you need to install in the image. </p><br><p>  Next, in the ~ / diskimage-builder / elements / ubuntu-16-custom / post-install.d directory, you need to create a 50-configure-system script to modify the system configuration: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # Permit password auth via SSH echo 'ssh_pwauth: true' &gt;&gt; /etc/cloud/cloud.cfg.d/50_remote_access.cfg # Generate new keys in first boot echo 'ssh_deletekeys: true' &gt;&gt; /etc/cloud/cloud.cfg.d/50_remote_access.cfg # Don't disable root access via SSH echo 'disable_root: false' &gt;&gt; /etc/cloud/cloud.cfg.d/50_remote_access.cfg # Don't create "ubuntu" user echo 'users: []' &gt;&gt; /etc/cloud/cloud.cfg.d/50_remote_access.cfg # Change default timezone to MSK echo 'timezone: Europe/Moscow' &gt;&gt; /etc/cloud/cloud.cfg.d/50_timezone.cfg # Change PermitRootLogin value to "yes" sed -i 's/PermitRootLogin .*/PermitRootLogin yes/g' /etc/ssh/sshd_config # Set root password to empty passwd -d root</span></span></code> </pre><br><p>  The scripts in the <a href="http://docs.openstack.org/developer/diskimage-builder/developer/developing_elements.html" rel="nofollow">post-install.d</a> directory are executed immediately after the scripts in the install.d directory. </p><br><p>  We also need to change the GRUB settings to add the ‚Äúnet.ifnames = 0‚Äù startup parameter, which saves the interface names in the usual ethN format. </p><br><p>  Add the 50-configure-grub script to the ~ / diskimage-builder / elements / ubuntu-16-custom / finalise.d directory: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash sed -i 's/\(^GRUB_CMDLINE_LINUX.*\)"$/\1 net.ifnames=0"/' /etc/default/grub update-grub</span></span></code> </pre><br><p>  The scripts in the <a href="http://docs.openstack.org/developer/diskimage-builder/developer/developing_elements.html" rel="nofollow">finalise.d</a> directory <a href="http://docs.openstack.org/developer/diskimage-builder/developer/developing_elements.html" rel="nofollow">are</a> executed after all the main stages of preparing the image. </p><br><p>  After creating the described scripts, we need to change their attributes, for this we execute the <a href="https://en.wikipedia.org/wiki/Chmod" rel="nofollow">chmod command</a> : </p><br><pre> <code class="bash hljs">chmod 0755 ~/diskimage-builder/elements/ubuntu-16-custom/*d/*</code> </pre><br><p>  Now, before creating the image, we need to specify the path for our new element.  This can be done using the <strong>ELEMENTS_PATH</strong> parameter. </p><br><p>  In order not to specify any parameters directly on the command line each time, in the ~ / diskimage-builder / directory, create a script build-ubuntu-16.04, which will set diskimage-builder parameters and build the image: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export ARCH="amd64" export BASE_ELEMENTS="bootloader cloud-init-datasources ubuntu ubuntu-16-custom" export DIB_CLOUD_INIT_DATASOURCES="ConfigDrive, Ec2" export DIB_RELEASE="xenial" export ELEMENTS_PATH="./elements/:/usr/share/diskimage-builder/elements/" export IMAGE_PATH="./images/ubuntu-16.04" disk-image-create vm $BASE_ELEMENTS -t raw -o $IMAGE_PATH</span></span></code> </pre><br><p>  Change the attributes of this file: </p><br><pre> <code class="bash hljs">chmod 0755 ~/diskimage-builder/build-ubuntu-16.04</code> </pre><br><p>  After this you should get this file hierarchy: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$tree</span></span> -p ~/diskimage-builder /home/user/diskimage-builder ‚îú‚îÄ‚îÄ [-rwxr-xr-x] build-ubuntu-16.04 ‚îú‚îÄ‚îÄ [drwxr-xr-x] elements ‚îÇ ‚îî‚îÄ‚îÄ [drwxr-xr-x] ubuntu-16-custom ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] finalise.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-configure-grub ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] install.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-install-additional-packages ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] post-install.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-configure-cloud-init ‚îÇ ‚îî‚îÄ‚îÄ [-rw-r--r--] README.rst ‚îî‚îÄ‚îÄ [drwxr-xr-x] images</code> </pre><br><p>  Run the build-ubuntu-16.04 script: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/diskimage-builder sudo ./build-ubuntu-16.04</code> </pre><br><p>  The <a href="https://www.sudo.ws/" rel="nofollow">sudo</a> utility when calling is needed so that the suggestion to enter a password does not appear in the middle of the process of preparing the image.  This behavior is explained by the fact that some pre-installed diskimage-builder elements contain a call to sudo (for example, a <a href="https://github.com/openstack/diskimage-builder/blob/master/elements/base/root.d/01-ccache" rel="nofollow">01-ccache script</a> from a base element, which is executed when building most distributions). </p><br><p>  At the end of our script, the new image will be located in the ~ / diskimage-builder / images / ubuntu-16.04.raw directory. </p><br><p>  You can use the created image in the Selectel ‚ÄúVirtual Private Cloud‚Äù service by downloading it via the web interface of the <a href="https://support.selectel.ru/vpc/images/" rel="nofollow">VPC</a> panel or via the <a href="http://docs.openstack.org/cli-reference/glance.html" rel="nofollow">glance API</a> . </p><br><p>  Please note that the password for root was deleted at the image build stage, so access to the virtual machine via SSH will initially only be possible by key.  You can add an SSH key when creating a machine in the VPC panel.  Access to the server is also possible via the no-VNC virtual console in the control panel, in which case you will not need to enter the root password if it has not been set. <br>  The root password is set in the standard way using the passwd utility. </p><br><p>  If you try to use an image created using the above procedures in our Virtual Private Cloud service (VPC), you will encounter a number of restrictions.  The following VPC features will not be available to you: </p><br><ul><li>  setting the initial password generated by the VPC service; </li><li>  change root password from the VPC web panel; </li><li>  change root password using <a href="http://docs.openstack.org/cli-reference/nova.html" rel="nofollow">nova API</a> ; </li><li>  interface change for the default route from the VPC web panel; </li><li>  automatic change of network interface settings within the system, in the event that they have been changed in the server control panel; </li></ul><br><p>  In the next section, we will show how to make a fully compatible VPC image. </p><br><h2>  Creating an image for the service "Virtual Private Cloud" </h2><br><p>  In order for the created image to be fully compatible with the VPC service, at the assembly stage you will need to add additional property properties for the image and install additional packages into the system. </p><br><p>  Add another element ubuntu-16-selectel, for this we create a directory: </p><br><pre> <code class="bash hljs">mkdir -p ~/diskimage-builder/elements/ubuntu-16-selectel/</code> </pre><br><p>  Inside this directory, add the item description in the README.rst file: </p><br><pre> <code class="bash hljs">==================== ubuntu-16-selectel ==================== Build ubuntu image <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Virtual Private Cloud</code> </pre><br><p>  Create the required directories for the new item: </p><br><pre> <code class="bash hljs">mkdir -p ~/diskimage-builder/elements/ubuntu-16-selectel/{pre-install.d,install.d,post-install.d}</code> </pre><br><p>  Change the repository list with the script ~ / diskimage-builder / elements / ubuntu-16-selectel / pre-install.d / 50-add-mirrors: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # Add key for Selectel OpenStack repository apt-key adv --fetch-keys http://repo.os.selectel.org/selectel-openstack.key cat &lt;&lt;EOF &gt; /etc/apt/sources.list ## Selectel OpenStack repository deb http://repo.os.selectel.org xenial main ## Selectel mirrors deb http://mirror.selectel.ru/ubuntu xenial main restricted universe multiverse deb http://mirror.selectel.ru/ubuntu xenial-updates main restricted universe multiverse deb http://mirror.selectel.ru/ubuntu xenial-backports main restricted universe multiverse ## Security updates deb http://security.ubuntu.com/ubuntu xenial-security main restricted universe multiverse EOF</span></span></code> </pre><br><p>  Add additional packages with the ~ / diskimage-builder / elements / ubuntu-16-selectel / install.d / 50-add-selectel-packages script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash packages="crontab-randomizer fstrim-blocks qemu-guest-agent set-root-pw" apt -y install $packages</span></span></code> </pre><br><p>  The following utilities will be installed: </p><br><ul><li>  <strong>crontab-randomizer</strong> is a simple script that randomizes time intervals in / etc / crontab, then we will add a call to this script when you first start the system; <br><br></li><li>  <strong>fstrim-blocks</strong> - a wrapper for the pre-installed utility fstrim, allows you to conduct a <a href="https://en.wikipedia.org/wiki/Trim_(computing)" rel="nofollow">TRIM</a> file system on fast disks block by block at small intervals, during installation it will add a call to cron.weekly; <br><br></li><li>  <strong>qemu-guest-agent</strong> is a utility that allows you to transfer QMP commands for managing the system to a virtual machine, in our case this utility is needed to change the password of the virtual machine through the VPC panel and nova API; <br><br></li><li>  <strong>set-root-pw</strong> - a script for initially setting a password in the virtual machine, obtained from the OpenStack metadata, then we will also add a call to this script when you first start the system; </li></ul><br><p>  Also during the image build, the cloud-init package will be automatically updated to the version that is in the Selectel OpenStack mirror.  This version contains patches that ensure the consistency of network settings between the virtual machine and the VPC service. </p><br><p>  Automatic updating of packages during image building takes place using the pre-installed <a href="https://github.com/openstack/diskimage-builder/blob/master/elements/base/install.d/00-up-to-date" rel="nofollow">00-up-to-date</a> script, during the install.d stage. </p><br><p>  Next, we need to add additional configuration files for cloud-init, create a script 50-configure-cloud-init in the ~ / diskimage-builder / elements / ubuntu-16-selectel / post-install.d directory: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # Prevent cloud-init to change custom apt mirrors echo 'apt_preserve_sources_list: true' &gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo 'system_info:' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo '- arches: [i386, amd64]' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo 'search:' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo 'primary:' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo '- http://mirror.selectel.ru/ubuntu' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo 'failsafe:' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg echo '- http://archive.ubuntu.com/ubuntu/' &gt;&gt; /etc/cloud/cloud.cfg.d/50_selectel_mirror.cfg # Prevent cloud-init to disable EC2-style metadata echo 'disable_ec2_metadata: false' &gt; /etc/cloud/cloud.cfg.d/50_enable_ec2.cfg # Perform some commands in boot time # 'runcmd' only runs during the first boot echo 'runcmd:' &gt; /etc/cloud/cloud.cfg.d/50_first_boot_routines.cfg echo '- set-root-pw 2&gt; /dev/null' &gt;&gt; /etc/cloud/cloud.cfg.d/50_first_boot_routines.cfg echo '- crontab-randomizer' &gt;&gt; /etc/cloud/cloud.cfg.d/50_first_boot_routines.cfg</span></span></code> </pre><br><p>  It is also recommended to remove the pre-installed /etc/cron.weekly/fstrim script in case of using fstrim-blocks, since the pre-installed version does not include block-by-block start parameters, which will cause additional load on the system when fstrim starts. </p><br><p>  Remove this file with a simple script ~ / diskimage-builder / elements / ubuntu-16-selectel / post-install.d / 51-remove-fstrim-weekly: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash rm -f /etc/cron.weekly/fstrim</span></span></code> </pre><br><p>  Change the attributes of the new scripts: </p><br><pre> <code class="bash hljs">chmod 755 ~/diskimage-builder/elements/ubuntu-16-selectel/*d/*</code> </pre><br><p>  Add a new element ubuntu-16-selectel to the script ~ / diskimage-builder / build-ubuntu-16.04: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export ARCH="amd64" export BASE_ELEMENTS="bootloader cloud-init-datasources ubuntu ubuntu-16-custom ubuntu-16-selectel" export DIB_CLOUD_INIT_DATASOURCES="ConfigDrive, Ec2" export DIB_RELEASE="xenial" export ELEMENTS_PATH="./elements/:/usr/share/diskimage-builder/elements/" export IMAGE_PATH="./images/ubuntu-16.04" disk-image-create vm $BASE_ELEMENTS -t raw -o $IMAGE_PATH</span></span></code> </pre><br><p>  The file hierarchy should look like this: </p><br><pre> <code class="bash hljs">$ tree -p diskimage-builder diskimage-builder ‚îú‚îÄ‚îÄ [-rw-r--r--] build-ubuntu-16.04 ‚îî‚îÄ‚îÄ [drwxr-xr-x] elements ‚îú‚îÄ‚îÄ [drwxr-xr-x] ubuntu-16-custom ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] finalise.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-configure-grub ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] install.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-install-additional-packages ‚îÇ ‚îú‚îÄ‚îÄ [drwxr-xr-x] post-install.d ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-configure-system ‚îÇ ‚îî‚îÄ‚îÄ [-rw-r--r--] README.rst ‚îî‚îÄ‚îÄ [drwxr-xr-x] ubuntu-16-selectel ‚îú‚îÄ‚îÄ [drwxr-xr-x] install.d ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-add-selectel-packages ‚îú‚îÄ‚îÄ [drwxr-xr-x] post-install.d ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-configure-cloud-init ‚îú‚îÄ‚îÄ [drwxr-xr-x] pre-install.d ‚îÇ ‚îî‚îÄ‚îÄ [-rwxr-xr-x] 50-add-selectel-openstack-mirror ‚îî‚îÄ‚îÄ [-rw-r--r--] README.rst</code> </pre><br><p>  Run the image build: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/diskimage-builder sudo ./build-ubuntu-16.04</code> </pre><br><p>  To download an image with all the necessary properties, you need the glance utility and the RC file of access to the project (you can download it in our control panel; all the necessary instructions are published there) <a href="https://support.selectel.ru/vpc/access/" rel="nofollow">https://support.selectel.ru/vpc/access/</a> . </p><br><p>  The command to load will look like this: </p><br><pre> <code class="bash hljs">glance image-create --name Ubuntu-16.04-VPC \ --disk-format raw \ --container-format bare \ --property hw_disk_bus=scsi \ --property hw_scsi_model=virtio-scsi \ --property x_sel_image_owner=Selectel \ --property hw_qemu_guest_agent=yes \ --file ~/diskimage-builder/images/ubuntu-16.04.raw \ --progress</code> </pre><br><p>  At loading properties will be added: </p><br><ul><li>  <strong>hw_qemu_guest_agent = yes</strong> ‚Äî needed to support the mechanism for changing the server password through the VPC panel or through the nova API;  This property will work only if the qemu-guest-agent utility is at least version 2.3 present in the image (version 2.5 is used in Ubuntu 16.04); </li><li>  <strong>x_sel_image_owner = Selectel</strong> - necessary to support the display of the password in the VPC panel; </li><li>  <strong>hw_disk_bus = scsi</strong> , <strong>hw_scsi_model = virtio-scsi</strong> - these properties will allow the use of more modern and productive tires virtio-scsi, one of the advantages of which is the possibility of using TRIM. </li></ul><br><p>  After downloading, the image will be displayed on the Images tab in your VPC project named Ubuntu-16.04-VPC. </p><br><p>  When the server is first started, the password for the root user will be generated and set automatically.  It will be displayed on the ‚ÄúConsole‚Äù tab; in the same place, if necessary, you can generate a new password. </p><br><p>  In addition, you do not have to manually configure the network interfaces on the server if you change them in the control panel on the Ports tab.  In order for cloud-init to reconfigure the network interfaces, you will need to restart the server on power.  After that, new OpenStack metadata with new network settings will be generated. </p><br><p>  You can prevent the cloud-init utility from changing the network settings each time the server is restarted.  To do this, in the installed system, add the /etc/cloud/cloud.cfg.d/99_disable_network_config.cfg file: </p><br><pre> <code class="bash hljs">network: config: disabled</code> </pre><br><p>  In the near future, we will add the ability to prohibit automatic reconfiguration of the network through the web interface of the VPC panel without the need to edit the system configuration. </p><br><h2>  Conclusion </h2><br><p>  In this article, we looked at the basic features of diskimage-builder, explored ways to add your own scripts to change the image configuration, the main assembly steps, and an example of loading the finished image into the cloud environment. </p><br><p>  If you have any questions about the main ways of using this tool, or any moments in the management of images and virtual machines in the VPC service are not clear to you, please indicate this in the comments. </p><br><p>  We will also be happy if you share your own ways of using diskimage-builder. </p></div><p>Source: <a href="https://habr.com/ru/post/311120/">https://habr.com/ru/post/311120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311110/index.html">YouTrack 7.0 Release: New Agile Concept, Gantt Chart, and More</a></li>
<li><a href="../311112/index.html">What's new in C # 7 and already supported in Visual Studio ‚Äú15‚Äù Preview 4</a></li>
<li><a href="../311114/index.html">The book Spark for Professionals: Modern Patterns of Big Data Processing</a></li>
<li><a href="../311116/index.html">Seminar "Operation of the data center: working with contractors"</a></li>
<li><a href="../311118/index.html">GoTo school projects: recommendation system for a news portal</a></li>
<li><a href="../311122/index.html">How it works: MegaFon card</a></li>
<li><a href="../311124/index.html">Aspirin from setting permissions on a file server</a></li>
<li><a href="../311126/index.html">How it was: reveal the details of Droidcon Moscow 2016</a></li>
<li><a href="../311128/index.html">.Net Core, exchange with 1C over TCP / IP between different devices</a></li>
<li><a href="../311130/index.html">UWP beginner: Responsive Design (VB.NET + C #)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>