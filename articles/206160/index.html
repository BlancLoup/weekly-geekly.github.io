<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of developing a client network I2P. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article , the tasks needed to build an I2P marshutizer capable of participating in the network, including interacting with other marsh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of developing a client network I2P. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/205320/">previous article</a> , the tasks needed to build an I2P marshutizer capable of participating in the network, including interacting with other marshutizers via the usual Internet, building different types of tunnels and collecting information about other nodes of the network, were considered.  Despite the importance of these tasks, the I2P client, performing only the functions of a marshuff, from the user's point of view is a ‚Äúthing in itself‚Äù, since it does not do anything interesting to the user.  This article focuses on application layer protocols for transmitting user data over the I2P network. <br><br><a name="habracut"></a><br>  If the issues of the I2P marshruzier's work are more or less logically consecrated in the official documentation, then the application protocols are a jumble of different ideas, which boil down to the fact that everyone is free to implement their own protocol for their own application, using the destination point as addresses.  However, this does not at all bring closer to the implementation of a client of its own, since the existing network resources already use some protocols and any new implementation should be able to work with them.  As an example, you can see the <a href="http://www.i2p2.de/how_garlicrouting">description of "garlic"</a> , from this page you can only understand how to pack "garlic" and how to encrypt.  What is transmitted between Alice and Bob, and how Bob knows that the answer should be sent to Alice, is completely incomprehensible.  It also contains the statement that, in order to confirm delivery, a DeliveryStatus message is transmitted in one of the ‚Äúgarnecines‚Äù with an indication of the sender marshulliser in the delivery instructions, thereby revealing the marshrutizer on which the sender sits.  Of course it is not.  Unfortunately, the only way to find out how things really were was to analyze the traffic generated by the official Java client. <br><br><h4>  ‚ÄúGarlic‚Äù data transfer </h4><br>  We will understand this issue in more detail, somewhat modifying the original example and making it more practical.  Suppose that Vasya Pupkin refers to the Flibusta site, which is now available only through I2P, while Vasya has his own website that offends someone‚Äôs feelings, and therefore is in I2P.  To do this, Vasya runs a marshutizer that constantly supports at least one outgoing and one incoming tunnel.  Vasya created a separate destination for his website and published its address everywhere.  To contact Flibusta, her address Vasya already knows, and his marshallizer knows her LeaseSet and can send a message there, the problem is that Vasya needs to receive a response from Flibusta, and for that she needs to know Vasya's address.  To this end, another destination is created on the vasin marshrutizer, serving as a return address for all connections initiated by Vasya.  Not only for Flibusta, but for all other sites.  If necessary, you can create several such return addresses, but then you also have to build LeaseSets with different non-intersecting sets of tunnels. <br><img src="https://habrastorage.org/getpro/habr/post_images/e18/c6d/9bf/e18c6d9bfcb687d471156a40ea3c3f96.jpg" alt="garlic"><br>  Garlic's I2NP message is used to transfer data between destinations.  The messages themselves are transmitted and encrypted between the routers, using a separate encryption key pair, the public key of which is transmitted to the LeaseSet.  This key does not coincide with the public key of the marshrouser, and, unlike the latter, is generated with a new one at each start.  Inside the message consists of "garlic", each of which consists of I2NP messages and instructions for its delivery (delivery instructions) of 4 types: <br><ul><li>  Local.  The message is intended for the marshutizer itself.  As a rule, someone's LeaseSet. </li><li>  Destination point  The message is intended to a destination connected to the marshutizer.  It is the only way to send data to a destination. </li><li>  Tunnel.  The message is intended to be sent to the specified inbound tunnel starting on the specified marshrutizer.  Used to confirm the delivery of "garlic". </li><li>  Marshutizator.  The message is intended to be sent to another marshutizer.  Extremely dangerous from the point of view of security, if the specified marshutizer is different from its own or trusted.  In practice, not met. </li></ul><br>  As a rule, "garlic" consisting of two "garlic" is used.  The first is the I2NP message DeliveryStatus with the message number of the ‚Äúgarlic‚Äù itself and the delivery to one of the incoming tunnels of the sender‚Äôs marshrouter.  Used to confirm the delivery of all "garlic" for its intended purpose.  The second is the I2NP Data message, which contains the data being transmitted and delivered to the destination.  Sometimes there is a third "garlic" - LeaseSet destination point (not marshutizator) of the sender.  In our example, this is Vasya's LeaseSet return address.  Such ‚Äúgarlic‚Äù is present in two cases: in the very first message and when the LeaseSet changes.  This is done in order for the marshruzator to know how to send a response to the sender, otherwise you would have to request the corresponding LeaseSet from the floodfill marshutizers, which most likely will not be there, such as Vasya‚Äôs return address, and vice versa, the Vasya‚Äôs secret website will be present there. <br>  The question arises, how does Flibusta know that the answer should be sent to Vasya, and not to Petya or anyone else who is turning to her at the same moment.  Even if it was known that ‚Äúgarlic‚Äù came from Vasya's marshrutizer, which, of course, is not the case, it would not help much, because Vasya's marshrutizer also has its website and, possibly, a lot more .  It turns out that this information should be contained within the data transmitted in the Data message, which indicates an unsuccessful design of the entire system, since it does not allow isolation of different levels of protocols from each other.  In other words, the address of the destination must be present simultaneously in both the data itself and the protocol for transmitting this data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  I2CP protocol data </h4><br>  Initially, the I2CP protocol was developed exclusively for the exchange between different applications and the marshrutizer - its messages should not get into the I2P network itself.  However, the contents of the SendMessageMessage and MessagePayloadMessage messages are transmitted over the network within I2NP Data messages, and are gzipped data with a specially modified view header. <br><br>  0x1F 0x8B 0x08 - gzip prefix <br>  1 byte of gzip flags <br>  2 bytes TCP or UDP port of the sender <br>  2 bytes TCP or UDP port of the receiver <br>  1 byte of additional gzip flags <br>  1 byte of protocol type: 6 - streaming (streaming), 17 - datagram (datagram), 18 - ‚Äúraw‚Äù (raw) <br><br>  Thus, each Data message transmitted via garlic will always begin with 0x1F 0x8B 0x08 and first of all unpacked gzip and, depending on the type of protocol, is processed by the corresponding implementation. <br><br><h4>  Streaming protocol </h4><br>  The streaming protocol is similar to the TCP protocol and guarantees the sequence of data transfer.  Messages consist of a header and the actual data.  The type of message is determined by the flags field; similarly to TCP, there are SYN / FIN flags for establishing and breaking the connection.  Unlike TCP, there can also be up to 255 NACKs ‚Äî the numbers of the missed messages with the requirement to send them again, which is more typical of packet protocols and requires a more complex implementation.  It also contains standard TCP fields: 4-byte ports of the sender and receiver, called streams, sequence numbers and confirmation numbers. <br>  When a connection is established, messages are exchanged with the SYNCHRONIZE flag set, and the FROM_INCLUDED and SIGNATURE_INCLUDED flags must be set.  The first means that the full 387-byte I2P address is present in the header, and the second that the entire message is signed with the sender's I2P private key.  Thus, the parties recognize each other‚Äôs I2P addresses, and verification of the signature ensures that these addresses are real.  In other words, Vasya, connecting to the Flibusta address, after establishing the connection, can be sure that this is Flibusta, and Flibusta will know the return address of Vasya. <br>  Thus, the interface of streaming protocols can be implemented as ordinary sockets, which allows the use of I2P in network applications with minimal changes. </div><p>Source: <a href="https://habr.com/ru/post/206160/">https://habr.com/ru/post/206160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206146/index.html">We buy train tickets in the New Year</a></li>
<li><a href="../206148/index.html">Creating your own drivers for Linux</a></li>
<li><a href="../206150/index.html">The second life of old dial gauges</a></li>
<li><a href="../206152/index.html">Tuning mooedit, work on the bugs</a></li>
<li><a href="../206154/index.html">rusEfi: ignition and other buns</a></li>
<li><a href="../206164/index.html">Startups from Silicon Valley with Russian-speaking founders. Jacob Diener and Igor Katsman - the founders of Driveway Software</a></li>
<li><a href="../206166/index.html">Private space - Per aspera ad astra</a></li>
<li><a href="../206168/index.html">Overview of switches with 24 10Gb optical ports</a></li>
<li><a href="../206170/index.html">Optimal storage architecture for virtual infrastructure backups</a></li>
<li><a href="../206172/index.html">Ten major events of 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>