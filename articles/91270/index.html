<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data storage in the Windows Azure cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 Among the many options for storing data, of course, you can select a new and interesting to study information storage technology in th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data storage in the Windows Azure cloud</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/2bb/55d/3f3/2bb55d3f3e2011974d086179a06f0350.png"><br>  Among the many options for storing data, of course, you can select a new and interesting to study information storage technology in the cloud.  At the moment there are several services to provide services of this type, they can be counted on the fingers - this is Amazon Web Services, Sun Cloud, Windows Azure.  Each of these services provides its own interfaces for data access, in this article I would like to focus on the Windows Azure service. <br>  This cloud computing platform provides 3 types of information storage services: <br><a name="habracut"></a><br><ul><li>  Blob service allows storing textual and binary information in specially organized blob containers. </li><li>  Queue service, allows you to organize an unlimited storage of messages (according to the documentation, each message can be no more than 8 KB). </li><li>  The table service allows you to store data structured in tables that is accessed via the REST API. </li></ul><br>  The last service listed above - Table Storage, at first glance, can be considered an analogue of the relational table storage; however, there are a number of important differences in its concept that I will try to reveal in the course of the article. <br>  This storage can contain tables (Tables), tables in the Table Storage concept are a collection of entities (Entities), they are similar to tuples in relational storages, in turn, an entity is a set of certain properties (Properties), which, in turn, represent a pair name and typed value ‚Äù(entities and typed value pair), entities are similar to fields in a table in relational repositories.  It should be noted here that the table in Table Storage does not define the structure of the stored entities, but on the contrary, the stored entities may contain different properties, but be in the same table. <br><ol><li>  Let us consider in detail the rules for the formation of table names: </li><li>  Table names can contain only alphanumeric characters. </li><li>  The table name cannot begin with a number. </li><li>  Table names are case sensitive. </li><li>  Table names must contain from 3 to 63 characters. </li></ol>  Now consider some aspects in the formation of properties and entities: <br><ul><li>  Property names are case sensitive and cannot contain more than 255 characters. </li><li>  Each entity does not exceed 253 user-defined properties. </li><li>  The total size of the data for each entity should be no more than 1 MB. </li><li>  Each entity must contain 3 system properties described below. </li></ul><h2>  System properties of entities. </h2><br>  To support balanced data loading, the tables in the storage can be divided into sections (Partitions), so, to unequivocally tell which entity belongs to which partition, it must contain the PartitionKey property, which uniquely identifies the partition of the table in which this entity is located. <br>  Another required property in each stored entity is the RowKey property, which already identifies a specific entity in a specific section.  The described properties of RowKey and PartitionKey form a primary key pair (Primary Key), each entity and must be specified during insert, delete and update operations. <br>  And the last, the most insignificant for the developer, will be the property - Timestamp, it is intended for the internal needs of the service and stores information about the time of the last modification of the entity. <br>  As noted above, there is a REST API for accessing data in Table Storage, however, Microsoft provides a special library for accessing data called ADO.NET Data Services (in the latest version of the framework 4.0, it was renamed WCF Data Services).  This library provides the developer with classes for working with data schemas, entities, and their properties.  How to use it will be shown below, using the example of creating a client for Windows Azure data services. <br><br><h2>  Creating a test data model </h2><br>  Now armed with the original technical data, you can proceed to create a demonstration data model for the Azure Table Service.  But first we need to prepare an environment for testing and creating client applications.  To do this, we need to download and install an addon for Visual Studio and Windows Azure SDK: <a href="http://www.microsoft.com/downloads/details.aspx%3FFamilyID%3D5664019e-6860-4c33-9843-4eb40b297ab6%26displaylang%3Den">http://www.microsoft.com/downloads/details.aspx?FamilyID=5664019e-6860-4c33-9843-4eb40b297ab6&amp;displaylang=en</a> <br>  Then you can proceed directly to the programming.  To do this, create in Visual Studio 2010 a simple console application called TableServiceExample: <br><img src="https://habrastorage.org/getpro/habr/post_images/af3/e27/283/af3e272832b420dd030afa675649c0f7.png"><br><br>  And add links to System.Data.Services.Client assemblies, Microsoft.WindowsAzure.StorageClient: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img alt="t" src="https://habrastorage.org/getpro/habr/post_images/7ae/d65/5c3/7aed655c35e1a0d80ffb183e6ff16d9f.png"><br><br>  Now it is the turn to voice what is planned to be implemented, namely, it will be necessary to create a storage for two entities: <br><ol><li>  The product must contain the following fields: Name, Brand, price, link to the product category. </li><li>  The product category must contain the following fields: category ID, name. </li></ol>  I just want to make a reservation that Table Services in the current implementation does not support references to other objects (in the language of the DBMS, there are no means to maintain foreign keys), so all the logic of binding and integrity falls on the final application. <br>  To display data in application objects, you need to create the appropriate classes, previously inheriting them from TableServiceEntity.  Immediately I want to identify several aspects that relate to the objects being created: 1) All entities of the goods will be stored in one section (PartitionKey), called ‚ÄúProductPartition‚Äù, and the species entities in the section ‚ÄúProductKindPartition‚Äù 2) The RowKey identifier will be the string representation of the Guid specified when creating object. <br>  Source code of the class "Product": <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Product : TableServiceEntity <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> PartitionName = <font color="#A31515">"ProductPartition"</font> ; <br> <br> <font color="#0000ff">public</font> Product() <br> { <br> <br> } <br> <br> <font color="#0000ff">private</font> Product( <font color="#0000ff">string</font> partitionKey, <font color="#0000ff">string</font> rowKey) <br> : <font color="#0000ff">base</font> (partitionKey, rowKey) <br> { <br> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> Product Create() <br> { <br> <font color="#0000ff">string</font> rowKey = <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> Product(PartitionName, rowKey); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Name { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Trademark { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> Kind { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And the source code of the class "Product Type": <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> ProductKind : TableServiceEntity <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> PartitionName = <font color="#A31515">"ProductKindPartition"</font> ; <br> <br> <font color="#0000ff">public</font> ProductKind() <br> { <br> <br> } <br> <br> <font color="#0000ff">private</font> ProductKind( <font color="#0000ff">string</font> partitionKey, <font color="#0000ff">string</font> rowKey) <br> : <font color="#0000ff">base</font> (partitionKey, rowKey) <br> { <br> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> ProductKind Create() <br> { <br> <font color="#0000ff">string</font> rowKey = <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> ProductKind(PartitionName, rowKey); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> Id { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Name { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br> </blockquote><br>  To create the necessary tables for storing the entities described above, it is necessary to determine the data context by the following criteria: <br><br>  1) The context class must be inherited from TableServiceContext <br>  2) For each table, you need to define a property of type IQueryable, where DataItemType is the type of entities that will be stored in the table. <br><br>  Let's look at the source code of our data context: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> TestServiceDataContext : TableServiceContext <br> { <br> <font color="#0000ff">public</font> TestServiceDataContext( <font color="#0000ff">string</font> baseAddress, StorageCredentials credentials) <br> : <font color="#0000ff">base</font> (baseAddress, credentials) <br> { <br> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> ProductTableName = <font color="#A31515">"Product"</font> ; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">const</font> <font color="#0000ff">string</font> ProductKindTableName = <font color="#A31515">"ProductKind"</font> ; <br> <br> <font color="#0000ff">public</font> IQueryable&lt;Product&gt; Product <br> { <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> CreateQuery&lt;Product&gt;( ProductTableName ); } <br> } <br> <br> <font color="#0000ff">public</font> IQueryable&lt;ProductKind&gt; ProductKind <br> { <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> CreateQuery&lt;ProductKind&gt;( ProductKindTableName ); } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Before deploying our data scheme in a tabular service, you need to become familiar with the principles of Windows Azure Data Services authentication. <br><br><h2>  Setting up access to Table Services </h2><br>  Each request to Azure tabular data services must be authenticated, in practice this means that each REST API request contains a specially crafted signature.  We will not go into details, although if you are interested in reading the corresponding section of the SDK, due to the fact that all the rough work will be taken over by the ADO .NET Data Services package for Azure Storage, we just need to correctly specify the authentication data.  Such data will be the account name (Account) and access key (Shared Key). <br>  Before we add something to the program we are creating, we need to run the local Storage emulator on the computer, we need to immediately make a reservation that it additionally needs an installed SQL Server of any edition, including Express.  This program is included with the Windows Azure SDK and its name Development Storage.  Before the first launch, the application will create and initiate a database into which it will later be used to store information.  If everything goes well, then the Development Storage icon will appear in the notification area and by clicking on it you can see which services are running at the moment, as well as their local addresses: <br><br><img alt="pp" src="https://habrastorage.org/getpro/habr/post_images/1c2/ec8/fa7/1c2ec8fa79c568c0009d2a1f0c497a77.png"><br><br>  Authentication in them is based on well-known and pre-generated data: <br><ul><li>  Account name: devstoreaccount1 </li><li>  Account key: Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq / K1SZFPTOtr / KBHBeksoGMGw == </li></ul><br>  This information will be used in the application.  First, add the App.config configuration file and write the following lines to the appSettings section: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">configuration</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">appSettings</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="AccountName"</font> <font color="#ff0000">value</font> <font color="#0000ff">="devstoreaccount1"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="AccountSharedKey"</font> <font color="#ff0000">value</font> <font color="#0000ff">="Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">add</font> <font color="#ff0000">key</font> <font color="#0000ff">="TableStorageEndpoint"</font> <font color="#ff0000">value</font> <font color="#0000ff">="http://127.0.0.1:10002/devstoreaccount1"</font> <font color="#0000ff">/&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">appSettings</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">configuration</font> <font color="#0000ff">&gt;</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now, in order to correctly format our code, we will create a class TableStoreManager and add the following fields to it: <br><ol><li>  _credentials of type StorageCredentialsAccountAndKey - represents the data on access to the table storage (Table Storage), through a shared key authentication scheme (Shared Key) </li><li>  _tableStorage of type CloudTableClient - clicks for access to tabular storage. </li><li>  The _context of type TestServiceDataContext is the class created in the previous section with a description of all the tables. </li></ol><br>  After the TableStoreManager type being described, it is necessary to initialize all these fields with the following lines: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> accountKey = <font color="#2B91AF">ConfigurationManager</font> .AppSettings[ <font color="#A31515">"AccountSharedKey"</font> ]; <br> <font color="#0000ff">string</font> tableBaseUri = <font color="#2B91AF">ConfigurationManager</font> .AppSettings[ <font color="#A31515">"TableStorageEndpoint"</font> ]; <br> <font color="#0000ff">string</font> accountName = <font color="#2B91AF">ConfigurationManager</font> .AppSettings[ <font color="#A31515">"AccountName"</font> ]; <br> <br> _credentials = <font color="#0000ff">new</font> StorageCredentialsAccountAndKey(accountName, accountKey); <br> _tableStorage = <font color="#0000ff">new</font> CloudTableClient(tableBaseUri, _credentials); <br> _context = <font color="#0000ff">new</font> TestServiceDataContext(tableBaseUri, _credentials); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now that all the access components have been initialized, it is necessary to check whether tables need to be created and if it is required to create them in the storage, we will do it in a separate TryCreateShema method: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> list = <font color="#0000ff">from</font> table <font color="#0000ff">in</font> _tableStorage.ListTables() <br> <font color="#0000ff">where</font> table == TestServiceDataContext.ProductKindTableName <br> || table == TestServiceDataContext.ProductTableName <font color="#0000ff">select</font> table; <br> <br> <font color="#0000ff">if</font> (list != <font color="#0000ff">null</font> &amp;&amp; list.ToList&lt; <font color="#0000ff">string</font> &gt;().Count == 0){ <br> CloudTableClient.CreateTablesFromModel( <font color="#0000ff">typeof</font> (TestServiceDataContext), <br> <font color="#2B91AF">ConfigurationManager</font> .AppSettings[ <font color="#A31515">"TableStorageEndpoint"</font> ], <br> _credentials); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Here, first, all the tables of existing tables are sampled, and their names are compared with those in the schema, and if the tables are not found, then the program will create them according to the model we defined in the TestServiceDataContext class.  And, lastly, you need to add a call to the created method to the Initialize method that was previously defined. <br><br><h2>  Fetching data from storage. </h2><br>  Azure Table Storage has a fairly diverse API for creating queries against the tables in the storage, for example, you can request a certain number of items, or return the first one, and also add filtering to specific fields.  But here it should be noted that in the current implementation of the considered Storage there are some limitations, first of all, that more than a thousand elements cannot be returned at once and the fact that each request cannot be completed for more than five seconds if at least one of these conditions will not be satisfied, then the service will return an error.  But back to querying, the ADO .NET Services Framework makes the chore of using REST APIs for storage services easier and provides the user with LINQ syntax for querying.  Unfortunately, not all LINQ data access capabilities are supported in the current implementation, now you can use only a few operators: <br><ol><li>  From - fully supported </li><li>  Where - fully supported </li><li>  Take - supported with a maximum limit of 1000 items </li><li>  First, FirstOrDefault - fully supported. </li></ol><br>  The list ends here.  To compose queries, use the TestServiceDataContext.CreateQuery method, where T is the type of the returned entity. <br>  We will build a method that returns all the available goods (the limit of 1000 items is not yet checked) <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt;Product&gt; GetAllProducts() <br> { <br> <font color="#0000ff">var</font> products = <font color="#0000ff">from</font> product <font color="#0000ff">in</font> _context.CreateQuery&lt;Product&gt;(TestServiceDataContext.ProductTableName) <font color="#0000ff">select</font> product; <br> <font color="#0000ff">return</font> products.ToList&lt;Product&gt;(); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Next we write a sample of all the available categories, as well as a specific category by its identifier: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt;ProductKind&gt; GetProductKinds() <br> { <br> <font color="#0000ff">var</font> productKinds = <font color="#0000ff">from</font> productKind <font color="#0000ff">in</font> <br> _context.CreateQuery&lt;ProductKind&gt;(TestServiceDataContext.ProductKindTableName) <br> <font color="#0000ff">select</font> productKind; <br> <font color="#0000ff">return</font> productKinds.ToList&lt;ProductKind&gt;(); <br> } <br> <br> <font color="#0000ff">public</font> ProductKind GetProductKind( <font color="#0000ff">int</font> id) <br> { <br> <font color="#0000ff">var</font> productKinds = ( <font color="#0000ff">from</font> productKind <font color="#0000ff">in</font> <br> _context.CreateQuery&lt;ProductKind&gt;(TestServiceDataContext.ProductKindTableName) <br> <font color="#0000ff">where</font> productKind.Id == id <br> <font color="#0000ff">select</font> productKind); <br> <br> <font color="#0000ff">var</font> productKindList = productKinds.ToList&lt;ProductKind&gt;(); <br> <br> ProductKind result = <font color="#0000ff">null</font> ; <br> <br> <font color="#0000ff">if</font> (productKindList.Count &gt; 0) { <br> <br> result = productKindList[0]; <br> } <br> <br> <font color="#0000ff">return</font> result; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now I would like to check our service at work, but if we run it and everything works correctly, we still won't see anything, since there is no data in the repository, therefore, for the first demonstration, we need to also implement the mechanism for adding entities. <br><br><h2>  Add data to the cloud </h2><br>  The procedure for adding new entities using ADO .NET Services looks pretty simple, just follow the added entries to have unique RowKey and PartiotionKey within the entire table.  For the insert operation, the first parameter must be passed to the method of the created context TestServiceDataContext.AddObject - the name of the table where the additions will be made and the second parameter - the object to add.  After calling two methods - DataServiceContext.SaveChanges - to force the sending of new data to the cloud storage, as well as DataServiceContext.Detach - to remove references from the context to the object.  Thus, in the TableStoreManager class, we will create two Insert methods, respectively, to add the Product and ProductKind entities: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> Insert(Product product) <br> { <br> _context.AddObject(TestServiceDataContext.ProductTableName, product); <br> _context.SaveChanges(); <br> _context.Detach(product); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Insert(ProductKind productKind) <br> { <br> _context.AddObject(TestServiceDataContext.ProductKindTableName, productKind); <br> _context.SaveChanges(); <br> _context.Detach(productKind); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h2>  The first testing service </h2><br>  After a long acquaintance with the architecture of Azure Table Storage, we can see this service in action, for this we will write in the Main method, our console program, the following lines: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">try</font> <br> { <br> TableStoreManager manager = <font color="#0000ff">new</font> TableStoreManager(); <br> manager.Initialize(); <br> <br> ProductKind productKind = ProductKind.Create(); <br> productKind.Name = <font color="#A31515">""</font> ; <br> productKind.Id = 1; <br> manager.Insert(productKind); <br> <br> Product product = Product.Create(); <br> product.Name = <font color="#A31515">""</font> ; <br> product.Kind = productKind.Id; <br> product.Trademark = <font color="#A31515">"Candy"</font> ; <br> manager.Insert(product); <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine(ex.Message); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  With this program, we, first, initialize the Table Services structure, creating the necessary tables there and, second, add one entry to the ‚ÄúProducts‚Äù and ‚ÄúTypes of Goods‚Äù tables.  Now, before testing, you need to remember to start the local ‚Äúcloud‚Äù DevelopmentStorage and execute our program.  If everything is written and done correctly, the program will wait a few seconds and return control without a single error.  Now you need to make sure that the data is really stored in the local storage, for this we change the Main method: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">try</font> <br> { <br> TableStoreManager manager = <font color="#0000ff">new</font> TableStoreManager(); <br> manager.Initialize(); <br> <br> <font color="#0000ff">var</font> products = manager.GetAllProducts(); <br> <br> <font color="#0000ff">foreach</font> (Product product <font color="#0000ff">in</font> products) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">": {0}  {1}"</font> , product.Name, product.Trademark); <br> <br> ProductKind productKind = manager.GetProductKind(product.Kind); <br> <br> <font color="#0000ff">if</font> (productKind != <font color="#0000ff">null</font> ) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" : {0}"</font> , productKind.Name); <br> } <br> } <br> <br> } <br> <font color="#0000ff">catch</font> (Exception ex) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine(ex.Message); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Let's run the program again, not forgetting about the DevelopmentStorage, and if everything is correct, then in the console we will see that all the saved data has returned and is ready for processing: <br><br><img alt="cc" src="https://habrastorage.org/getpro/habr/post_images/2ab/fc9/352/2abfc9352b78e76d24d7626db605bd13.png"><br><br><h2>  Entity update </h2><br>  The mechanism for updating entities in Table Storage is quite simple, each time you need to specify the RowKey and PatitionKey values ‚Äã‚Äãof the object being changed.  To ensure competitive access to entities, a mandatory flag was introduced - Etag (the If-Match header in the REST API).  This flag determines when an object was changed, and if this Etag does not match the already existing storage does not allow changing the data, it will return an error signaling that it is necessary to re-request the information.  But you can independently influence the unconditional update by setting the * symbol in the ETag. <br>  To update an object through Ado .Net Data Services, you must first add it to the context using the TableServiceContext.AttachTo method, then call passing the same object to the TableServiceContext.UpdateObject method and send the information to the server by calling the TableServiceContext.SaveChanges method: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> Update(Product product) <br> { <br> _context.Detach(product); <br> _context.AttachTo(TestServiceDataContext.ProductTableName, product, <font color="#A31515">"*"</font> ); <br> _context.UpdateObject(product); <br> _context.SaveChanges(); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  At the very beginning, before updating, it is necessary to make sure that the object being updated is no longer in the Ado .NET Services vision field, for this we simply call the TableServiceContext.Detach method. <br>  Now you can write a small test and make sure that everything works: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TableStoreManager manager = <font color="#0000ff">new</font> TableStoreManager(); <br> manager.Initialize(); <br> <font color="#0000ff">var</font> products = manager.GetAllProducts(); <br> <font color="#0000ff">foreach</font> (Product product <font color="#0000ff">in</font> products) <br> { <br> product.Name += <font color="#A31515">" 2"</font> ; <br> product.Trademark = <font color="#A31515">""</font> ; <br> manager.Update(product); <br> } <br> products = manager.GetAllProducts(); <br> <font color="#0000ff">foreach</font> (Product product <font color="#0000ff">in</font> products) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine(product.Name); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  By running the written code, you can see that the data is safely changed, and the testing of the created procedure can be considered complete. <br><br><h2>  Deleting entities. </h2><br>  Like updating, deleting objects requires two properties - these are RowKey and PartitionKey, and also implies specifying the Etag flag - whose behavior is similar to that described in the previous section.  In fact, when deleting an entity, it is marked as ‚Äúdeleted‚Äù and becomes inaccessible to clients, and physically it is deleted when periodic garbage collection takes place.  The code for deleting our product-Product entity using ADO .NET Services is shown below: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> Delete(Product product) <br> { <br> _context.Detach(product); <br> _context.AttachTo(TestServiceDataContext.ProductTableName, product, <font color="#A31515">"*"</font> ); <br> _context.DeleteObject(product); <br> _context.SaveChanges(); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  To test the correctness of the work, you can write the following lines in the Main method: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">TableStoreManager manager = <font color="#0000ff">new</font> TableStoreManager(); <br> manager.Initialize(); <br> <font color="#0000ff">var</font> products = manager.GetAllProducts(); <br> <br> <font color="#0000ff">foreach</font> (Product product <font color="#0000ff">in</font> products) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">": {0}  {1}"</font> , product.Name, product.Trademark); <br> manager.Delete(product); <br> } <br> <br> products = manager.GetAllProducts(); <br> <br> <font color="#0000ff">if</font> (products.ToArray().Length == 0) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" "</font> ); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h2>  Conclusion </h2><br>  This article showed a general approach to access one of the types of cloud services.  The Ado .NET Services library has a number of interesting nuances to review which you can write another article, so I tried not to load the code with additional conditions, but brought it as lightly as possible. <br>  Unfortunately, the full-fledged version of the Azure platform is currently unavailable for Russian consumers, so it‚Äôs impossible to test the written example.  However, the author is the owner since the spring of 2009 an invite to CTP, which gives the right to create a number (with restrictions), on a real cloud, of services in order to familiarize with Azure.  In this regard, this approach was tested by me about a year ago, by creating a cloud service that has been running non-stop for almost a year (it was launched in June 2009) - this indicates the true reliability of cloud computing over conservative ones. <br><br>  PS <br>  Sources can be downloaded <a href="http://www.filesavr.com/tableserviceexample">here.</a> </div><p>Source: <a href="https://habr.com/ru/post/91270/">https://habr.com/ru/post/91270/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91259/index.html">Small review of HP Mini 210 Vivienne Tam Edition</a></li>
<li><a href="../91261/index.html">Flat mouse concept</a></li>
<li><a href="../91262/index.html">ClangBSD collects itself</a></li>
<li><a href="../91265/index.html">Do you go to the interview without information about the fork salary?</a></li>
<li><a href="../91266/index.html">Hacked Gmail account</a></li>
<li><a href="../91272/index.html">Scant him</a></li>
<li><a href="../91274/index.html">MGTS, forget about me forever!</a></li>
<li><a href="../91275/index.html">A look at the problem of piracy</a></li>
<li><a href="../91276/index.html">Small Add-In for Visual Studio</a></li>
<li><a href="../91278/index.html">7 ways to determine the host site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>