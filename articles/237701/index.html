<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why can't I reset my password?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Such a question came today in tech support. The user enters the password recovery page, enters his email, presses the ‚ÄúRecover‚Äù button. The system hap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why can't I reset my password?</h1><div class="post__text post__text-html js-mediator-article">  Such a question came today in tech support.  The user enters the password recovery page, enters his email, presses the ‚ÄúRecover‚Äù button.  The system happily reports that email has been sent.  The user enters the mailbox, the user does not see the letter, the user is not satisfied. <br><a name="habracut"></a><br>  The following is the standard: ‚ÄúCheck that the email is entered correctly, make sure that the letter does not fall into spam‚Äù.  Checked-made sure did not help.  I went to the mail server - the letter was not even sent. <br><br>  Break away from all cases and throw in testing.  I go to the recovery page, enter my email - everything is in order, a letter with a link to password recovery comes.  I enter the user's email - silence.  The letter is not sent.  In the log - nothing (from the word "absolutely"). <br><br>  This is followed by half an hour of useless throwing, a bit of bewilderment and a lot of obscene language.  Calm down, take a deep breath and climb into the Django source code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Password reset is responsible for resetting the password: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@csrf_protect def password_reset(request, is_admin_site=False, template_name='registration/password_reset_form.html', email_template_name='registration/password_reset_email.html', subject_template_name='registration/password_reset_subject.txt', password_reset_form=PasswordResetForm, token_generator=default_token_generator, post_reset_redirect=None, from_email=None, current_app=None, extra_context=None): if post_reset_redirect is None: post_reset_redirect = reverse('password_reset_done') else: post_reset_redirect = resolve_url(post_reset_redirect) if request.method == "POST": form = password_reset_form(request.POST) if form.is_valid(): opts = { 'use_https': request.is_secure(), 'token_generator': token_generator, 'from_email': from_email, 'email_template_name': email_template_name, 'subject_template_name': subject_template_name, 'request': request, } if is_admin_site: opts = dict(opts, domain_override=request.get_host()) form.save(**opts) return HttpResponseRedirect(post_reset_redirect) else: form = password_reset_form() context = { 'form': form, } if extra_context is not None: context.update(extra_context) return TemplateResponse(request, template_name, context, current_app=current_app)</span></span></code> </pre> <br></div></div><br>  Once redirected to post_reset_redirect, it means that form.save () is executed.  We look at what's under the hood: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, domain_override=None, subject_template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'registration/password_reset_subject.txt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, email_template_name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'registration/password_reset_email.html'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, use_https=False, token_generator=default_token_generator, from_email=None, request=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Generates a one-use only link for resetting password and sends to the user. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.mail <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> send_mail UserModel = get_user_model() email = self.cleaned_data[<span class="hljs-string"><span class="hljs-string">"email"</span></span>] active_users = UserModel._default_manager.filter( email__iexact=email, is_active=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> active_users: <span class="hljs-comment"><span class="hljs-comment"># Make sure that no email is sent to a user that actually has # a password marked as unusable if not user.has_usable_password(): continue if not domain_override: current_site = get_current_site(request) site_name = current_site.name domain = current_site.domain else: site_name = domain = domain_override c = { 'email': user.email, 'domain': domain, 'site_name': site_name, 'uid': urlsafe_base64_encode(force_bytes(user.pk)), 'user': user, 'token': token_generator.make_token(user), 'protocol': 'https' if use_https else 'http', } subject = loader.render_to_string(subject_template_name, c) # Email subject *must not* contain newlines subject = ''.join(subject.splitlines()) email = loader.render_to_string(email_template_name, c) send_mail(subject, email, from_email, [user.email])</span></span></code> </pre><br></div></div><br>  Here, of course, comes to me.  The user is first registered through VKontakte.  Then put the email.  And untied Vkontakte.  And in the process of registration through VK to him, i.e.  the user was assigned <code>set_unusable_password()</code> (for he did not have a password). <br><br>  This whole stream of emotions was caused by these lines: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Make sure that no email is sent to a user that actually has # a password marked as unusable if not user.has_usable_password(): continue</span></span></code> </pre><br>  What for?  Why?  Who is guilty?  Why can't I reset my password if it was not originally set?  And most importantly, why is the system not reporting this in any way, but, chuckling, it redirects to post_reset_redirect ?!  As it says, ‚Äúexplicit is better than implicit‚Äù? <br><br>  In general, keep in mind.  And do not step on this rake. <br><br>  <b>Update:</b> <br><br>  Thank you comrade <a href="https://habrahabr.ru/users/zzeus/" class="user_link">zzeus</a> : <br><blockquote>  Users flagged with an unusable password (see if you‚Äôre using an LDAP.) no mail will be sent either. </blockquote><br>  Well, in this regard, a small survey, I wonder. </div><p>Source: <a href="https://habr.com/ru/post/237701/">https://habr.com/ru/post/237701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237691/index.html">The little robot controls the plane like a real pilot.</a></li>
<li><a href="../237693/index.html">We check Oracle VM VirtualBox. Part 2</a></li>
<li><a href="../237695/index.html">Statistical verification of randomness of binary sequences using NIST methods</a></li>
<li><a href="../237697/index.html">Some interesting and useful things for web developer # 29</a></li>
<li><a href="../237699/index.html">Professions of the future: 3D printing in medicine</a></li>
<li><a href="../237703/index.html">From smart glass to smart home - the wonders of Chinese startups</a></li>
<li><a href="../237705/index.html">The relationship of UX and optimization: how to do it correctly</a></li>
<li><a href="../237709/index.html">Return A. Kibkalo - free webinar on Storage Spaces - DSS based on Windows Server 2012R2</a></li>
<li><a href="../237711/index.html">I need help: Alexey Chervonenkis disappeared</a></li>
<li><a href="../237713/index.html">iPhone 6 set a new sales record - but growth rates are falling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>