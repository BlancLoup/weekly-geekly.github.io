<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How do we take screenshots of pages</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 This is our first article on Habr√©, and in it we would like to tell you about how we make beautiful screenshots of pages for our service and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How do we take screenshots of pages</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  This is our first article on Habr√©, and in it we would like to tell you about how we make beautiful screenshots of pages for our service and how we came to this, which rakes we attacked. <br><br>  This service is extremely important to us in order to display updates.  And the faster and closer to reality (read - flash support) it works, the more pleasant it is for users. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://storage.surfingbird.ru/11/11/21/20/iv5D6240_orig_cf1a0d0e.jpg"><br><a name="habracut"></a><br><br>  After studying the Internet, the following options were found: <br><ul><li>  <strong>1. Sites</strong> </li></ul><ul><li>  <a href="http://browsershots.org/">BrowserShots</a> - apparently honored veteran.  Free, supports a bunch of browsers, for money can take screenshots with a higher priority than without it.  The joy lies in the fact that it opensource, the source - in Python.  And the sadness is that the screenshots in most of the browsers simply do not work, the flash is not supported, some of the screenshots that seem to have been broken.  Focused on web designers. </li><li>  <a href="http://www.webshotspro.com/">WebShots Pro</a> - also from the first page of Google.  They have api, which is already interesting, the cost of which depends on the volume, size of pictures and the availability of service tags.  But - you will not believe, boys - they make screenshots using IE!  In general, everything is clear with them.  Well, in fact, they look dubious beyond that. </li><li>  <a href="http://www.thumbalizr.com/">thumbalizr beta</a> - promising guys, affordable api, paid service is to turn off the watermark, but do not support flash. </li><li>  <a href="http://url2png.com/">url2png</a> - all previous sites, except to some extent thumbalizr, look, frankly, razdolbayski-pofigistichno.  And it seems to me that they work the same way.  url2png leaves a very pleasant impression - though, again, it does not remove the flash and costs more than others. </li><li>  <a href="http://www.websnapr.com/">websnapr</a> - well, half to half, nothing special. </li></ul><ul><li>  <strong>2. Programs</strong> </li></ul><ul><li>  <a href="http://khtml2png.sourceforge.net/">kthml2png</a> - deserved old man.  Almost not supported.  In general, we did not try it. </li><li>  <a href="http://cutycapt.sourceforge.net/">CutyCapt</a> is a more current program.  But - "CutyCapt has a number of known quirks."  Sometimes he simply does not manage to remove the screen.  Making friends with a flash is difficult. </li><li>  <a href="http://www.phantomjs.org/">PhantomJS</a> - as far as I know, the most active of these projects.  A lot of opportunities, not just screenshots.  You can execute Javascript in the context of the page, for example.  But the position of the author about the plug-ins (flash including) is as follows - it should work, but I don‚Äôt want to guarantee anything and I won‚Äôt.  Interesting problems with this will be described below :) </li></ul><br>  In general, having looked at it and not seeing the ideal, our first attempt to implement the most authentic screenshots was the <strong>launch of Firefox under Xvfb</strong> , and the screenshot of the entire screen for 30 seconds. <br>  Xvfb is an indispensable utility for such purposes.  This is a virtual framebuffer, which allows you not to put full X on the server, and run the "displays" with any resolution.  Well, the applications in them :) <br>  The method was, of course, imperfect.  Firstly, firefox turned out to be stubborn and all the time he strove to slip a window for updating himself or plug-ins.  Secondly, sometimes I just crashed screenshots (a monochrome picture was obtained) or hung.  Thirdly, taking a screenshot strictly after 30 seconds is clearly suboptimal - if the site was loaded earlier, there is nothing to wait :) And, of course, he ate the memory. <br><br>  The next step we tried was to <strong>write our own utility on Qt</strong> - in order to be able to edit it for ourselves, because after all, the service of making screenshots is really very important for us.  Qt is not for nothing that the authors of most of these programs use it - there is a modern engine and a convenient API.  There are fewer problems, but they remain - sometimes the utility hangs, sometimes it makes a broken screenshot ... And for some reason it did not work on the combat servers with a flash. <br><br>  The developer of this utility at some point suggested that we <strong>switch to PhantomJS</strong> - which we used.  The situation again became somewhat better, but not perfect.  It also sometimes hangs, and there are links that always cause an error, as well as cases of sporadic failures.  The flash did not work either, showed black rectangles, which in principle already suited us more or less. <br>  But PhantomJS at the expense of being able to perform js on the page allowed us to retrieve the page description from the DOM (from meta tags or the secret algorithm directly from the text), the title, and potentially do any interesting things, for example, to define pages that prohibit showing yourself in the frame, which is also quite a critical feature for us.  HTML can be such a mess that it can be a pain to work with it on the server;  Browser engines have been accustomed to endure any bullying for decades. <br>  So we would have lived with him for a long time, but when we began to add a fair number of links to us, Phantom pleased us with something new - working in parallel several copies of the program, processing links with a flash, SUDDENLY began to take it off, but, let's say, in one screenshot I got a video from another link, and in the second screenshot there was a combination of two videos at once.  In short, the blood-intestine-dismemberment. <br><br>  Hell, I thought, and remembered that <strong>Google Chrome</strong> generally has a built-in flash player, and it was already clear that all self-written programs suffered from a lack of reliability.  Chrome is hard to blame for this :) In addition, it is extremely easy to write extensions on pure js, which could do everything the same as PhantomJS, and even more. <br>  He also had all the magic command line keys that allow him to run without an interface and without any annoying suggestions.  He also knew how to write in STDERR, and work in incognito mode, which ensures the most repetitive results of screenshots.  We have become available all the power of CSS-selectors and we have <strong>earned a flash</strong> . <br>  In general, Google Chrome <strong>fulfilled all our erotic dreams</strong> ;) <br>  Actually the screenshots are taken with a snapshot of the entire screen in which the browser works, well, plus some special cases for special, magical sites. <br><br>  In a sense, history has made a spiral revolution - we started with a browser, and finished with a browser.  Just working on this task with Chrome turned out to be much easier.  Yes, it is possible to write an extension under Firefox that will probably be able to do the same thing that we do with Chrome - but it will be more difficult.  After writing a <a href="https://addons.mozilla.org/ru/firefox/addon/surfingbird-toolbar/">toolbar for Firefox,</a> I guarantee it :) <br>  And he works with memory more carefully.  By the way, Chrome even has the ability to take screenshots without external utilities - they can be received in the form of a data-uri, but, ironically, in this mode the flash is not removed :) <br><br><br>  So, here is a small checklist, how to get your own screenshots service, avoiding long trial and error: <br><br><ul><li>  Use the job queue.  I advise Resque, but it can be * MQ, and Kestrel, even a relational database.  The main thing is to work normally with several parallel handlers. </li><li>  Run the required number of Xvfb sessions, on different ‚Äúdisplays‚Äù </li><li>  Write a queue handler that will run Google Chrome with the necessary parameters, like <strong>DISPLAY =: 1 / opt / google-chrome / google / chrome ....</strong>  The list of parameters can be found here: <a href="">http://src.chromium.org/svn/trunk/src/chrome/common/chrome_switches.cc</a> </li><li>  Write an extension for Google Chrome, which will monitor the completion of the page load and send a signal to the outside world.  Documentation: <a href="http://code.google.com/chrome/extensions/getstarted.html">http://code.google.com/chrome/extensions/getstarted.html</a> </li><li>  Set on the task queue the necessary number of handlers, each of which will use its own DISPLAY.  Remember to check that DISPLAY is available.  This is easy to do with console utilities from the X11 family. </li><li>  Take a screenshot by taking a screenshot of the signal from the extension, or use the <a href="http://code.google.com/chrome/extensions/tabs.html">captureVisibleTab</a> method, but then the flash (and other plugins) will not be removed </li></ul><br><br>  Do not forget the steps "..." and "Profit!";) <br><br>  In the end, I think we got a solution that surpasses all commercial analogues that I have seen. </div><p>Source: <a href="https://habr.com/ru/post/137847/">https://habr.com/ru/post/137847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137833/index.html">Programming Language Popularity Index for February 2012</a></li>
<li><a href="../137836/index.html">New Google Chrome in Android - without flash support</a></li>
<li><a href="../137840/index.html">Facebook overstates the number of active users, but not by much</a></li>
<li><a href="../137842/index.html">Share your experience and listen to Java-guru at Siclum Java Subbotnik February 11</a></li>
<li><a href="../137843/index.html">Nginx share has grown up a bit again.</a></li>
<li><a href="../137848/index.html">Fourth Kiev Habravstrecha</a></li>
<li><a href="../137849/index.html">Path service was found to download the entire iPhone address book on its servers</a></li>
<li><a href="../137851/index.html">Customize the appearance of the UIPopoverController</a></li>
<li><a href="../137852/index.html">Simplify.js - JavaScript library to simplify broken lines</a></li>
<li><a href="../137854/index.html">Interesting bugfix, or break Skype completely</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>