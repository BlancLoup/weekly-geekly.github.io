<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>svnconfbackup: a script to backup configuration files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few years ago, I faced the task of backing up configuration files. But not simple, but such that at any moment it would be possible to see what has ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>svnconfbackup: a script to backup configuration files</h1><div class="post__text post__text-html js-mediator-article"> A few years ago, I faced the task of backing up configuration files.  But not simple, but such that at any moment it would be possible to see what has changed and when.  I knew about the existence of <a href="http://www.opennet.ru/prog/info/2271.shtml">csvbackup</a> , but I wanted my own script, with Subversion and without Perl. <br><a name="habracut"></a><br>  For those who are not familiar with Subversion, I will explain.  Subversion is one of <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0_%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B8%25D1%258F%25D0%25BC%25D0%25B8">the version control systems</a> .  Such systems allow you to store multiple versions of the same file.  It is incredibly convenient.  Imagine that the company has two administrators - you and your partner.  Monday.  You are the first day you left the holiday, and your partner went on holiday abroad on Saturday, without a phone, of course.  And suddenly you find that one of the services, for example, a web server, is not working properly.  But before you go on vacation, everything worked!  What changed?  Having a backup copy of configuration files in the version control system you can not only roll back to the working version of the configs, but also track all changes made in the configuration files during the period of your absence, in fact, identify the problem. <br><br>  I wanted to make the script simple, cross-platform, if I may say so, and with minimal dependencies.  Sh was chosen as the interpreter.  goes in the base FreeBSD system.  To copy files, pax is used, because pax, when copying a file, recreates the full path to it, that is, after the command <br><br> <code>pax -rw /etc/ssh/ssh_config /var/tmp</code> <br> <br>  we get the file / var / tmp / etc / ssh / ssh_config.  pax also runs on the base FreeBSD system.  Later, when I moved to Debian, it was an unpleasant surprise for me that pax should be installed separately. <br>  We will set the list of files for backup in two ways - as a result of the work of the find command and as a simple list of files separated by spaces, which is convenient for single files. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The variables will be moved to the settings file /usr/local/etc/svnconfbackup.conf: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#,      <br> TMPDIR= <font color="#A31515">"/var/tmp"</font> <br> #   <br> REPDIR= <font color="#A31515">"conf"</font> <br> #   <br> DESTDIR=$REPDIR.`date +%s` <br> #    <br> LIST= <font color="#A31515">"/etc /usr/local/etc /var/named"</font> <br> EXCLUDE_LIST= <font color="#A31515">"-not -path /etc/'*'shadow'*' \ <br> -and -not -path /var/named/internal/slave/'*' \ <br> -and -not -name '*'.pem \ <br> -and -not -name '*'.key \ <br> -and -not -name '*'.crt \ <br> -and -not -path /etc/ssh_host_rsa_key \ <br> -and -not -path /etc/ssh_host_dsa_key"</font> <br> FILES= <font color="#A31515">"/home/pgsql/data/*.conf"</font> <br> #      <br> SVN=`which svn` <br> SVNADMIN=`which svnadmin` <br> #   <br> SVNROOT= <font color="#A31515">"/usr/local/svnconfbackuproot"</font> <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The LIST variable contains a list of directories in which find will look for files, and the FILES variable contains an additional list of files to back up.  This settings file can be considered as a full sh-script.  Let me remind you that inside single quotation marks, or strict quotation marks, any special character (with the exception of single quotation marks) is interpreted as a simple character.  That is, in the EXCLUDE_LIST variable, the asterisks will remain asterisks.  And in the FILES variable, we end up with a list of files in the <code>/home/pgsql/data/</code> directory ending in <code>.conf</code> , since the "*" in this case is the file name pattern. <br>  And the content enclosed between the return quotes `` will be replaced with the result of the command execution, i.e.  on her console output.  Thus, instead of <code>`date +%s`</code> we get the number of seconds that have elapsed since 00:00:00 on January 1, 1970 ( <code>mktemp</code> was rejected due to the different behavior in Linux and FreeBSD) <br>  Backslash \ overrides the special value of the newline character.  This is done just in case. <br><br>  But back to the script.  It will consist of two parts ‚Äî the initialization of the Subversion repository and the backup procedure.  Initialization must be performed manually once, at the very beginning.  The backup itself should take place without user intervention. <br>  Command syntax: <br><br> <code>svnbackupconfig init|update</code> <br> <br>  Those.  <code>svnbackupconfig init</code> will initiate the repository initialization, and <code>svnbackupconfig update</code> will start the backup procedure, in other words, update the data in the repository. <br><br>  First you need to load the settings and initialize the local variables. <br><br><blockquote> <code><font color="black">#!/bin/sh <br> . /usr/local/etc/svnconfbackup.conf <br> <br> #     URL <br> SVNROOTsvn= <font color="#A31515">"file://$SVNROOT"</font></font> <br></code> </blockquote><br><br>  Next, we will process the command parameter passed in from the command line. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">case</font> <font color="#A31515">"$1"</font> <font color="#0000ff">in</font> <br> init) <br> #    <br> ;; <br> update) <br> #     <br> esac</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Initialization procedure <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">cd $TMPDIR <br> #   <br> mkdir $DESTDIR <br> chmod 700 $DESTDIR <br> #   <br> mkdir $DESTDIR/branch <br> mkdir $DESTDIR/tag <br> mkdir $DESTDIR/trunk <br> cd $DESTDIR <br> #     <br> #   <br> <font color="#0000ff">if</font> [ ! -d $SVNROOT ]; then <br> $SVNADMIN create $SVNROOT <br> fi <br> #   <br> $SVN import $SVNROOTsvn/$REPDIR -q -m <font color="#A31515">"Initial repository layout"</font> <br> #   <br> cd ../ <br> rm -rf $DESTDIR</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The backup procedure is not much longer, but I want to dwell on the algorithm in more detail.  To make the script simple and straightforward, I solved <s>the Hindu</s> problem head-on. <br><ol><li>  Download the previous backup from the repository to a temporary directory. </li><li>  Copy there all the files specified in the backup lists.  Let Subversion know what has changed. </li><li>  Add new files to the repository that are missing in the previous backup. </li><li>  Check every file from backup.  If it is not in the system, remove it from the repository. </li><li>  Save result to repository. </li></ol><br><br>  This is, without doubt, a resource-intensive algorithm.  However, on a typical system, its implementation will take only a few minutes. <br>  New files (p.3) can be found easily - in the output of <code>svn status</code> lines start with the character "?": <br><br> <code>$ svn status <br> ? some.file</code> <br> <br>  To get the file names we will use the construction <br><br> <code>svn status|grep ^?|awk '{print $2}'</code> <br> <br>  Does this mean that the output of the <code>svn status</code> sent to the <code>grep ?</code>  which will return strings with the first character "?".  This output, in turn, is passed to the <code>awk '{print $2}'</code> command, which will return the second parameter, i.e.  file name. <br><br>  Actually, the backup procedure. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">cd $TMPDIR <br> #   <br> mkdir $DESTDIR <br> chmod 700 $DESTDIR <br> #     <br> $SVN checkout -q $SVNROOTsvn/$REPDIR/trunk $DESTDIR <br> cd $DESTDIR <br> #  ,    <br> list=`eval find $LIST $EXCLUDE_LIST -and -type f|sort` <br> #  <br> <font color="#0000ff">for</font> p <font color="#0000ff">in</font> ${list} $FILES ; <font color="#0000ff">do</font> <br> pax -rw $p . &gt; /dev/ <font color="#0000ff">null</font> 2&gt;&amp;1 <br> done; <br> #  ,     <br> list=`eval $SVN status|grep ^?|awk <font color="#A31515">'{print $2}'</font> ` <br> #     <br> <font color="#0000ff">for</font> p <font color="#0000ff">in</font> ${list} ; <font color="#0000ff">do</font> <br> $SVN add -q $p <br> done; <br> #      <br> #      .svn <br> list=`eval find . -name .svn -prune -or -print` <br> #        <br> #     <br> <font color="#0000ff">for</font> p <font color="#0000ff">in</font> ${list} ; <font color="#0000ff">do</font> <br> <font color="#0000ff">if</font> [ ! -e /$p ]; then <br> $SVN delete -q $p --force <br> fi <br> done; <br> #   <br> $SVN diff <br> #    <br> $SVN commit -q -m <font color="#A31515">"svnbackup automatic update"</font> <br> #   <br> cd ../ <br> rm -rf $DESTDIR</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Archive <a href="">link svnconfbackup.googlecode.com/files/svnconfbackup.tar.gz</a> <br><br>  Using this script is also easy.  After unpacking the archive, place the script file in <code>/usr/local/bin</code> , and the configuration file in <code>/usr/local/etc</code>  Adjust settings according to your OS.  Now you need to initialize the repository.  Run the command <br><br> <code>svnbackupconfig init</code> <br> <br>  Now, if you wish, you can make the first backup manually. <br><br> <code>svnbackupconfig update</code> <br> <br>  The process will take several minutes and will end with the text of all configuration files on the console, since the repository is still empty.  Upon further use, the output will contain only changes between versions. <br>  The autorun configuration will be slightly different for Linux and FreeBSD. <br><br>  For Linux: <br><br> <code><nobr>echo -e "/usr/local/bin/svnconfbackup update\n" &gt; /etc/cron.daily/svnconfbackup&lt;br&gt; <br> chmod 755 /etc/cron.daily/svnconfbackup <br></nobr></code> <br><br>  For FreeBSD: <br><br> <code><nobr>echo "/usr/local/bin/svnconfbackup update\n" &gt; /usr/local/etc/periodic/daily/999.svnbackup&lt;br&gt; <br> chmod 755 /usr/local/etc/periodic/daily/999.svnbackup <br></nobr></code> <br><br>  Now - how to use backup.  By and large, below - a very brief description of the main svn commands. <br>  For definiteness, we will use the default settings.  To get the last backup run the command <br><br> <code>svn checkout file:///usr/local/svnconfbackup/conf/trunk conf</code> <br> <br>  A conf directory will be created in the current directory, in which a copy of the last backup will be placed.  When restoring data, keep in mind that in each directory there are service directories named .svn. <br><br>  For the following operations, go to the conf directory, which is also called the working directory svn. <br>  We need only two commands - update and diff.  Note that the update command updates the working directory svn, not the repository.  Thus, to roll back to the previous version, you need to run the command <br><br> <code>svn update --revision PREV</code> <br> <br>  In general, as an argument for the --revision key or its short form -r, you can specify both the revision number and date.  For example: <br><br> <code>svn update -r "{2010-03-31}"</code> <br> <br>  In this case, the backup will be taken on March 31, 2010 00:00:00.  Please note that if you have an automatic backup later than this time, for example, at 4 am, then there will be a backup for March 30 in the working directory. <br><br>  With the diff command you can see the changes between any two versions of files.  At the same time, you can explicitly indicate the versions of which files should be compared.  For example, the command <br><br> <code>svn diff -r "{2010-01-01}:HEAD"</code> <br> <br>  will show what has changed since last year.  By the way, the -r option also works with the checkout command!  More information about syntax and keys can be found in the help: <br><br> <code>svn help &lt; &gt;</code> <br> <br>  Just in case, leave a <a href="http://svnbook.red-bean.com/">link to the site of an excellent book on Subversion</a> . <br><br>  Good luck!  And remember - administrators are divided into two types - some data has already been lost, while others will lose! <br><br>  UPD Transferred to the thematic blog </div><p>Source: <a href="https://habr.com/ru/post/83120/">https://habr.com/ru/post/83120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../83114/index.html">Choosing a cheap hosting</a></li>
<li><a href="../83116/index.html">Android has become even ... more real</a></li>
<li><a href="../83117/index.html">Lessons learned from developing 64-bit C / C ++ applications</a></li>
<li><a href="../83118/index.html">Why Dr. Web "ordered" operators and aggregators?</a></li>
<li><a href="../83119/index.html">Amplifier for 500 rubles. Do it yourself</a></li>
<li><a href="../83121/index.html">Bearded War website</a></li>
<li><a href="../83125/index.html">The new Skype will sound CD-quality</a></li>
<li><a href="../83126/index.html">Gomel. Another city where visited UFO</a></li>
<li><a href="../83129/index.html">Free H.264 extended to 2016</a></li>
<li><a href="../83130/index.html">Protection of personal information</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>