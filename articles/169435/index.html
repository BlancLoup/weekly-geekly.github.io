<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Little Brave Arkanoid (Part 4)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After a short break, we will continue our development . Today we will add a small sound effect to the project, which is played when a ball collides wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Little Brave Arkanoid (Part 4)</h1><div class="post__text post__text-html js-mediator-article">  After a short break, we will continue our <a href="http://habrahabr.ru/post/166929/">development</a> .  Today we will add a small sound effect to the project, which is played when a ball collides with anything on the playing field.  About work with SoundEngine (which we will use today) I already wrote <a href="http://habrahabr.ru/post/161959/">earlier</a> .  For this reason, today I will tell not so much about it, but about how its use will affect the project we are developing. <br><a name="habracut"></a><br>  The main (and somewhat unexpected for me) consequence of including SoundEngine in the project was the need to switch from IwGl to IwGx.  The fact is that SoundEngine uses IwResManager subsystem capabilities for loading sound effect descriptions.  The description itself is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">sounds.group</b> <div class="spoiler_text"><pre><code class="cpp hljs">CIwResGroup { name <span class="hljs-string"><span class="hljs-string">"sounds"</span></span> <span class="hljs-string"><span class="hljs-string">"./sounds/contact.wav"</span></span> CIwSoundSpec { name <span class="hljs-string"><span class="hljs-string">"contact"</span></span> data <span class="hljs-string"><span class="hljs-string">"contact"</span></span> vol <span class="hljs-number"><span class="hljs-number">0.9</span></span> loop <span class="hljs-literal"><span class="hljs-literal">false</span></span> } CIwSoundGroup { name <span class="hljs-string"><span class="hljs-string">"sound_effects"</span></span> maxPolyphony <span class="hljs-number"><span class="hljs-number">8</span></span> killOldest <span class="hljs-literal"><span class="hljs-literal">true</span></span> addSpec <span class="hljs-string"><span class="hljs-string">"contact"</span></span> } }</code> </pre> <br></div></div><br>  Attempting to include in the project IwResManager leads to the fact that it simply stops gathering: <br><br><img src="https://habrastorage.org/storage2/a33/210/93e/a3321093ea2489ca0506580f7e205640.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Adding IwGeom to a project also doesn't help much: <br><br><img src="https://habrastorage.org/storage2/d39/aa2/392/d39aa23929e9dd51f34c25c0c879d2b7.png"><br><br>  After fruitless attempts to correct the situation, I decided to stop using IwGl and move on to IwGx.  I do not insist that this is the only possible solution, but it seemed to me the most reasonable. <br><br>  As usual, let's start with the mkb file: <br><br><div class="spoiler">  <b class="spoiler_title">arcanoid.mkb</b> <div class="spoiler_text"><pre> <code class="diff hljs">#!/usr/bin/env mkb options { module_path="../yaml" module_path="../box2d" + module_path="$MARMALADE_ROOT/examples" } subprojects { - iwgl + iwgx + iwresmanager + SoundEngine yaml box2d } includepath { ./source/Main ./source/Model } files { [Main] (source/Main) Main.cpp Main.h Quads.cpp Quads.h TouchPad.cpp TouchPad.h Desktop.cpp Desktop.h IO.cpp IO.h World.cpp World.h + ResourceManager.cpp + ResourceManager.h [Model] (source/Model) IBox2DItem.h Board.cpp Board.h Bricks.cpp Bricks.h Ball.cpp Ball.h Handle.cpp Handle.h + [Data] + (data) + sounds.group } assets { (data) level.json + (data-ram/data-gles1, data/data-gles1) + sounds.group.bin }</code> </pre><br></div></div><br>  Downloading and playback of resources will take a new (and still very simple) module: <br><br><div class="spoiler">  <b class="spoiler_title">ResourceManager.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _RESOURCEMANAGER_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _RESOURCEMANAGER_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;map&gt; #include &lt;string&gt; #include "s3e.h" #include "IwResManager.h" #include "IwSound.h" #define SOUND_GROUP "sounds" using namespace std; class ResourceManager { private: bool checkSound() {return true;} public: void init(); void release(); void update(); void fireSound(const char* name); }; extern ResourceManager rm; #endif // _RESOURCEMANAGER_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ResourceManager.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ResourceManager.h"</span></span></span><span class="hljs-meta"> ResourceManager rm; void ResourceManager::init() { IwSoundInit(); IwResManagerInit(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> IW_BUILD_RESOURCES IwGetResManager()-&gt;AddHandler(new CIwResHandlerWAV); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> IwGetResManager()-&gt;LoadGroup(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sounds.group"</span></span></span><span class="hljs-meta">); } void ResourceManager::release() { IwResManagerTerminate(); IwSoundTerminate(); } void ResourceManager::update() { IwGetSoundManager()-&gt;Update(); } void ResourceManager::fireSound(const char* name) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!checkSound()) return; CIwResGroup* resGroup = IwGetResManager()-&gt;GetGroupNamed(SOUND_GROUP); CIwSoundSpec* SoundSpec = (CIwSoundSpec*)resGroup-&gt;GetResNamed(name, IW_SOUND_RESTYPE_SPEC); CIwSoundInst* SoundInstance = SoundSpec-&gt;Play(); }</span></span></code> </pre><br></div></div><br>  Activate the sound effect will be simple and simple, from the World module: <br><br><div class="spoiler">  <b class="spoiler_title">World.cpp</b> <div class="spoiler_text"><pre> <code class="diff hljs">#include "s3e.h" +#include "ResourceManager.h" #include "World.h" #include "Ball.h" ... void World::PostSolve(b2Contact* contact, const b2ContactImpulse* impulse) { impact(contact-&gt;GetFixtureA()-&gt;GetBody()); impact(contact-&gt;GetFixtureB()-&gt;GetBody()); isContacted = true; + rm.fireSound(CONTACT_SOUND); }</code> </pre><br></div></div><br>  Actually these are all the changes that were necessary to make for the realization of sound effects.  Now we have to make a number of changes related to the transition from IwGl to IwGx. <br><br><div class="spoiler">  <b class="spoiler_title">Desktop.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Desktop.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IwGx.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"s3e.h"</span></span></span><span class="hljs-meta"> Desktop desktop; void Desktop::init() { IwGxInit(); IwGxLightingOff(); width = IwGxGetScreenWidth(); height = IwGxGetScreenHeight(); IwGxSetColClear(0, 0, 0, 0); vSize = 0; duration = 1000 / 60; } void Desktop::release() { IwGxTerminate(); } void Desktop::update() { IwGxClear(IW_GX_COLOUR_BUFFER_F | IW_GX_DEPTH_BUFFER_F); CIwMaterial* pMat = IW_GX_ALLOC_MATERIAL(); IwGxSetMaterial(pMat); } void Desktop::refresh() { IwGxFlush(); IwGxSwapBuffers(); s3eDeviceYield(duration); } int Desktop::toRSize(int x) const { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (vSize == 0) return x; return (x * width) / vSize; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Quads.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _QUADS_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _QUADS_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IwGX.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_VERTS 2000 class Quads { private: CIwSVec2 verts[MAX_VERTS]; CIwColour cols[MAX_VERTS]; int vertc; public: void update() {vertc = 0;} void refresh(); void setVert(int x, int y, int r, int g, int b, int a); }; extern Quads quads; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// _QUADS_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Quads.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Quads.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"s3e.h"</span></span></span><span class="hljs-meta"> Quads quads; void Quads::refresh() { IwGxSetVertStreamScreenSpace(verts, vertc); IwGxSetColStream(cols, vertc); IwGxDrawPrims(IW_GX_TRI_LIST, NULL, vertc); } void Quads::setVert(int x, int y, int r, int g, int b, int a) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (vertc &gt;= MAX_VERTS) return; verts[vertc].x = x; verts[vertc].y = y; cols[vertc].r = r; cols[vertc].g = g; cols[vertc].b = b; cols[vertc].a = a; vertc++; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Bricks.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _BRICKS_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _BRICKS_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IwGX.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"s3e.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Desktop.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"World.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IBox2DItem.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BRICK_HALF_WIDTH 20 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BRICK_HALF_HEIGHT 10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;vector&gt; using namespace std; class Bricks: public IBox2DItem { private: struct SBrick { SBrick(int x, int y): x(x), y(y), body(NULL), isBroken(false), hw(BRICK_HALF_WIDTH), hh(BRICK_HALF_HEIGHT) {} SBrick(const SBrick&amp; p): x(px), y(py), body(p.body), isBroken(p.isBroken), hw(p.hw), hh(p.hh) {} int x, y, hw, hh; int isBroken; b2Body* body; }; vector&lt;SBrick&gt;* bricks; virtual bool impact(b2Body* b); public: Bricks(): bricks() {} void init(); void release(); void refresh(); void clear(){bricks-&gt;clear();} void add(SBrick&amp; b); typedef vector&lt;SBrick&gt;::iterator BIter; friend class Board; }; #endif // _BRICKS_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Bricks.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Bricks.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Quads.h"</span></span></span><span class="hljs-meta"> void Bricks::init() { bricks = new vector</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SBrick&gt;(); } void Bricks::release() { delete bricks; } void Bricks::refresh() { for (BIter p = bricks-&gt;begin(); p != bricks-&gt;end(); ++p) { if (p-&gt;isBroken) continue; quads.setVert(p-&gt;x - p-&gt;hw, p-&gt;y - p-&gt;hh, 0x00, 0xff, 0x50, 0xff); quads.setVert(p-&gt;x - p-&gt;hw, p-&gt;y + p-&gt;hh, 0x00, 0xff, 0x50, 0xff); quads.setVert(p-&gt;x + p-&gt;hw, p-&gt;y - p-&gt;hh, 0x00, 0xff, 0x50, 0xff); quads.setVert(p-&gt;x + p-&gt;hw, p-&gt;y + p-&gt;hh, 0x00, 0xff, 0x50, 0xff); quads.setVert(p-&gt;x + p-&gt;hw, p-&gt;y - p-&gt;hh, 0x00, 0xff, 0x50, 0xff); quads.setVert(p-&gt;x - p-&gt;hw, p-&gt;y + p-&gt;hh, 0x00, 0xff, 0x50, 0xff); } } bool Bricks::impact(b2Body* b) { for (BIter p = bricks-&gt;begin(); p != bricks-&gt;end(); ++p) { if (p-&gt;body == b) { p-&gt;isBroken = true; return true; } } return false; } void Bricks::add(SBrick&amp; b) { b.body = world.addBrick(bx, by, b.hw, b.hh, (IBox2DItem*)this); bricks-&gt;push_back(b); }</span></span></span></span></code> </pre><br></div></div><br>  Here you should pay attention to the order of traversing vertices in triangles.  The first thing I saw, after switching from IwGl to IwGx, were the coal-black figures of bricks and a ball on a soft purple background.  I managed to display "from the inside out" absolutely all the triangles that I had. <br><br>  The second important point concerns working with memory.  I do not know how exactly IwGx works with memory, but there is an important rule of thumb to which I came.  All memory allocated dynamically (including in STL) must be freed until the moment IwGxTerminate is called (otherwise it will be destroyed).  For this reason, the vector bricks has become a pointer to a vector.  Perhaps this is not the most elegant solution, but it entailed the minimum amount of necessary changes. <br><br>  Similarly, we modify other modules: <br><br><div class="spoiler">  <b class="spoiler_title">Ball.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _BALL_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _BALL_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;vector&gt; #include "s3e.h" #include "Desktop.h" #include "World.h" #include "IBox2DItem.h" #define MAX_SEGMENTS 7 #define BALL_RADIUS 15 using namespace std; class Ball: public IBox2DItem { private: struct Offset { Offset(int dx, int dy): dx(dx), dy(dy) {} Offset(const Offset&amp; p): dx(p.dx), dy(p.dy) {} int dx, dy; }; vector&lt;Offset&gt;* offsets; int x; int y; b2Body* body; public: void init(); void release(); void refresh(); virtual void setXY(int X, int Y); typedef vector&lt;Offset&gt;::iterator OIter; }; #endif // _BALL_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Ball.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Ball.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Desktop.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Quads.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;math.h&gt; void Ball::init(){ x = desktop.getWidth() / 2; y = desktop.getHeight()/ 2; offsets = new vector&lt;Offset&gt;(); float delta = - PI / (float)MAX_SEGMENTS; float angle = delta / 2.0f; float r = (float)desktop.toRSize(BALL_RADIUS); for (int i = 0; i &lt; MAX_SEGMENTS * 2; i++) { offsets-&gt;push_back(Offset((int16)(cos(angle) * r), (int16)(sin(angle) * r))); angle = angle + delta; offsets-&gt;push_back(Offset((int16)(cos(angle) * r), (int16)(sin(angle) * r))); } body = world.addBall(x, y, (int)r, (IBox2DItem*)this); } void Ball::release() { delete offsets; } void Ball::setXY(int X, int Y) { x = X; y = Y; } void Ball::refresh() { OIter o = offsets-&gt;begin(); int r = desktop.toRSize(BALL_RADIUS); for (int i = 0; i &lt; MAX_SEGMENTS * 2; i++) { quads.setVert(x + (r / 4), y + (r / 4), 0xff, 0xff, 0xff, 0xff); quads.setVert(x + o-&gt;dx, y + o-&gt;dy, 0x00, 0x00, 0x00, 0x00); o++; quads.setVert(x + o-&gt;dx, y + o-&gt;dy, 0x00, 0x00, 0x00, 0x00); o++; } }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Handle.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _HANDLE_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _HANDLE_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IwGX.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"s3e.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Desktop.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"World.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IBox2DItem.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HANDLE_COLOR 0xffff3000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HANDLE_H_WIDTH 40 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HANDLE_H_HEIGHT 10 class Handle: public IBox2DItem { private: int x; int y; int touchId; public: void init(); void refresh(); void update(); virtual void setXY(int X, int Y); }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// _HANDLE_H_</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Handle.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Handle.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Quads.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"TouchPad.h"</span></span></span><span class="hljs-meta"> void Handle::init() { x = desktop.getWidth() / 2; y = desktop.getHeight(); touchId = -1; } void Handle::setXY(int X, int Y) { x = X; y = Y; } void Handle::refresh() { int hw = desktop.toRSize(HANDLE_H_WIDTH); int hh = desktop.toRSize(HANDLE_H_HEIGHT); quads.setVert(x - hw, y - hh, 0x00, 0x30, 0xff, 0xff); quads.setVert(x - hw, y + hh, 0x00, 0x30, 0xff, 0xff); quads.setVert(x + hw, y - hh, 0x00, 0x30, 0xff, 0xff); quads.setVert(x + hw, y + hh, 0x00, 0x30, 0xff, 0xff); quads.setVert(x + hw, y - hh, 0x00, 0x30, 0xff, 0xff); quads.setVert(x - hw, y + hh, 0x00, 0x30, 0xff, 0xff); world.addHandle(x, y, desktop.toRSize(HANDLE_H_WIDTH), desktop.toRSize(HANDLE_H_HEIGHT), (IBox2DItem*)this); } void Handle::update() { Touch* t = NULL; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (touchId &gt; 0) { t = touchPad.getTouchByID(touchId); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { t = touchPad.getTouchPressed(); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (t != NULL) { touchId = t-&gt;id; world.moveHandle(t-&gt;x, t-&gt;y); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { touchId = -1; } }</span></span></code> </pre><br></div></div><br>  In Board, we simply replace two vectors (scopes and types) with pointers to vectors.  Next, run the application and make sure that everything works: <br><br><img src="https://habrastorage.org/storage2/18b/70c/603/18b70c603922d24db57aff25a6df22a6.png"><br><br>  You may notice that I removed the gradient fill from the bricks.  Honestly, it was just too lazy to mess around with it, given that all the same, textures will be stretched on all objects (otherwise, you shouldn‚Äôt even dream of any presentation). <br></div><p>Source: <a href="https://habr.com/ru/post/169435/">https://habr.com/ru/post/169435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169415/index.html">Why we began to use the Stylus preprocessor in Yandex. Mail, as well as about the library that helps to live with IE</a></li>
<li><a href="../169417/index.html">Aida. Automation of work with Git, JIRA and TeamCity</a></li>
<li><a href="../169419/index.html">How to improve "Windows 8". Private opinion</a></li>
<li><a href="../169429/index.html">Yahoo unhappy with Microsoft results</a></li>
<li><a href="../169433/index.html">HP will release the tablet again, but on Android</a></li>
<li><a href="../169437/index.html">3d printers. Review of achievements for 2012</a></li>
<li><a href="../169445/index.html">vPass 2 is a simple and convenient Javascript secure password generator.</a></li>
<li><a href="../169447/index.html">Zend Optimizer + finally laid out on github</a></li>
<li><a href="../169449/index.html">I do not want to go over the heads</a></li>
<li><a href="../169451/index.html">Optimization of 2D applications for mobile devices in Unity3d</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>