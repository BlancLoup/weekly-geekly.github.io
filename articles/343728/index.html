<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unity game, open source</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Black Friday, Black Friday ... tired. I announce my personal White Monday - for a couple of nights I wrote a small game and post its code for general ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unity game, open source</h1><div class="post__text post__text-html js-mediator-article">  Black Friday, Black Friday ... tired.  I announce my personal White Monday - for a couple of nights I wrote a small game and post its code for general use, <s>with a 90% discount</s> .  Why do I need this?  Well, I see the following advantages - the very open source code for job search (yes, yes, now I am in active search), read in the comments about my jambs, and finally change the status to Habr√©. <br><a name="habracut"></a><br><h3>  The essence of the game </h3><br>  The idea came suddenly, and until it flew away, decided to write it down and then embody it.  Imagine a cold, dark cell in a certain prison.  In it sits, it is not known as well as it is not known by whom, the chained wizard, who every night torments every evil.  With his last strength, he creates a small fireball and breathes a semblance of life into it. <br><br>  Get to know this is Kalcifer, your avatar in this game. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z_/0x/n7/z_0xn74xtgflo9kfcfqryn3jirw.gif"></div><br>  It is to them you will destroy all the filth, which is creeping in the direction of our chained poor fellow. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://github.com/DemiLix/1NightGame">Referring to the code</a> <br><br><h3>  Explanation of the code </h3><br>  Let's start with the <strong>GameManager</strong> .  He is the head of everything, it is in him that the state of the game changes - Initialization-&gt; GameLoop-&gt; Win or Lose.  Single and single, for singleton.  Since the game is not a network, simple, and without complex transitions, it was decided to use this pattern.  Here is the processing of hits on the player (see below <a href="https://habr.com/ru/post/343728/">Known problems</a> ), accounting hit points and checking for winnings / losses.  There would be a <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582">GodObject</a> , but we have too few classes, so I know not all about everyone.  At the initialization stage, a pool of objects is created that reflect the animation of damage to the player and the death of enemies.  To track the state of hit points, you can subscribe to <u>UpdateHpWizardDelegate</u> or <u>UpdateHpCalciferDelegate</u> .  In our case, <strong>GUIManager</strong> does <strong>this</strong> to display the current hp on the screen. <br><br><img src="https://habrastorage.org/webt/g0/of/9x/g0of9xbggse6zhd3f8ceyho_wic.png"><br><br>  By this time, <b>SpawnManager</b> has already compiled a list of enemy spawn points. <br><br><img src="https://habrastorage.org/webt/d0/7k/cr/d07kcrpqoearwidqvo3dwmghzv4.png"><br><br>  a <b>WaveManager</b> uploaded the order of the waves of the creation of enemies.  Waves can be configured in two ways: register in the game code or download from the Json file.  To edit this Json a custom editor is written: <b>GameDataEditor</b> <br><br><img src="https://habrastorage.org/webt/ta/eg/ax/taegax2h_j9cuud_oececvvinzu.png"><br><br>  You can register the exact number of spawn or indicate that you can create on any free one. <br><br>  Creation of waves made with the help of sly Korutina: <br><br><div class="spoiler">  <b class="spoiler_title">Spawnwaves</b> <div class="spoiler_text"><pre><code class="hljs pgsql">private IEnumerator SpawnWaves() { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> WaitForSeconds(firstWaveDelay); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (currentWave &lt; waves.Count) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CheckFinishedCurrentWave()) { var step = waves[currentWave].GetCurrentWaveStep(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (step != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> WaitForSeconds(step.delay); var spawners = step.spawners; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spawners != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var spawn <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> spawners) { SpawnPoint spawnPoint; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spawn.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> == Consts.INDEX_RANDOM_SPAWN_POINT) { spawnPoint = SpawnManager.S_Instance.GetRandomEmptySpawnPoint(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { spawnPoint = SpawnManager.S_Instance.GetSpawnPointByIndex(spawn.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spawnPoint != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { SpawnManager.S_Instance.SpawnEnemy(spawnPoint, spawn.name); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("Not empty spawn point"); } } } <span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>.Log(step.text); } waves[currentWave].currentStep++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SelectNextWave(); } } }</code> </pre> <br></div></div><br>  First, <u>firstWaveDelay</u> seconds before the start of the first wave 1.  After that, in a cycle, all the waves are driven in turn, inserting the desired delay <u>step.delay</u> between the wave steps.  Why in korutina and not for example in Update?  Yes, in fact, it is possible this way and that, just here it is more vivid, you can see where the delay ( <u>yield return new WaitForSeconds</u> ) and you don‚Äôt have to keep unnecessary cycles and checks. <br><br>  Let's see what SpawnPoint is all <b>about</b> .  This is MonoBehavior with 2 components: <b>SpawnPoint</b> and <b>CircleCollider2D</b> .  In the first, with the help of the second, it is determined whether the spawn is busy with some sort of enemy.  <u>OnDrawGizmos</u> displays <u>spawn locations</u> in the Unity editor. <br><br><div class="spoiler">  <b class="spoiler_title">OnDrawGizmos</b> <div class="spoiler_text"><br><pre> <code class="hljs dos"> void OnDrawGizmos() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_IsDirty) { Gizmos.<span class="hljs-built_in"><span class="hljs-built_in">color</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">Color</span></span>.red; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Gizmos.<span class="hljs-built_in"><span class="hljs-built_in">color</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">Color</span></span>.green; } Gizmos.DrawSphere(transform.position, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>f); }</code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/lp/w5/uf/lpw5uf2h6mfaljilo0rqg3ovxfm.png"><br><br>  All enemies come from the base class <b>BasicEnemy</b> in which there are several virtual methods: <br><br><ul><li>  <u>ContactWizard ()</u> , to interact with the wizard </li><li>  <u>ContactCalcifer ()</u> , for interacting with Calcifer </li><li>  <u>ShowDeathAnimation ()</u> , to show the death animation </li></ul><br>  They can be redefined in descendants, for a different reaction to these events.  For example, <b>PoisonEnemy</b> hurts when Calcifer is touched, unlike other enemies. <br><br><div class="spoiler">  <b class="spoiler_title">PoisonEnemy.ContactCalcifer</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ContactCalcifer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { GameManager.S_Instance.DamageCalcifer(damage); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.ContactCalcifer(); }</code> </pre><br></div></div><br>  By the way, we do not delete enemies and many other objects (many and often created on the scene) using <u>Destroy (this)</u> , but send it back to the <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D1%2583%25D0%25BB">object pool</a> - <u>ObjectPool.Recycle (this)</u> .  So we save a lot on the creation of objects, which is known to be quite a costly business. <br><br>  For example, animations end with a call to <u>SelfDestroy ()</u> , which returns the animation object back to the pool. <br><br><img src="https://habrastorage.org/webt/pq/xf/7i/pqxf7i6_zse_r7iy0icnmg1jvuc.png"><br><br>  The enemies are moving with the help of <s>the pathos force of the</s> <b>BasicEnemyMoving</b> component.  In it, we are interested in two methods: <u>OnEnable ()</u> and <u>Move ()</u> .  <u>OnEnable ()</u> is called after pulling the enemy from the pool and is needed to turn the enemy (if necessary) in the direction of the target. <br><br><div class="spoiler">  <b class="spoiler_title">OnEnable</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> OnEnable() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj!=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>&amp;&amp;obj.NeedRotateForDirection) { Vector3 moveDirection = <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>.position - GameManager.S_Instance.wizardTransform.position; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (moveDirection != Vector3.zero) { <span class="hljs-type"><span class="hljs-type">float</span></span> angle = Mathf.Atan2(moveDirection.y, moveDirection.x) * Mathf.Rad2Deg<span class="hljs-number"><span class="hljs-number">-90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>.rotation = Quaternion.AngleAxis(angle, Vector3.forward); } } }</code> </pre><br></div></div><br>  <u>Move ()</u> is a virtual method that moves the enemy to the goal.  It can be redefined in descendants and make a special movement (with jerks, sinusoidal, etc.) <br><br><div class="spoiler">  <b class="spoiler_title">Move</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Move</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>.position = Vector3.MoveTowards(<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>.position, SpawnManager.S_Instance.TEMP_GOAL.position, speed * <span class="hljs-type"><span class="hljs-type">Time</span></span>.deltaTime); }</code> </pre><br></div></div><br>  On this as if everything. <br><br><a name="GameManager"></a><br><h3>  Known shoals </h3><br><ul><li>  Singletons </li><li>  No Wizard and Calcifer classes.  All logic with their interaction lies in <b>GameManager</b> </li><li>  Magic numbers with rotation angles of sprites.  Yes, I understand that it would be necessary to bring all the sprites to one corner and already from him to dance.  But not enough time. </li><li>  There is no progress record </li><li>  Curve ad prefabs enemies in <b>SpawnManager</b> </li></ul><br><h3>  Todo </h3><br><ul><li>  Change of day / night.  Happy rest, scatter skills, etc.  At night you burn vrazhin. </li><li>  New types of enemies: shooting, hurting Calcifer, leaving slime / cobwebs, teleporting, breeding </li><li>  Calcifer pumping: stats, tower defense, skills </li><li>  Several endings.  There are a couple of ideas about several scenarios, in cases of loss at different stages / different pumping </li><li>  Lighting.  The walls of the chamber are illuminated by Calcifer, as it grows, more and more. </li><li>  Cut scene. </li></ul><br>  <a href="http://powstudios.com/content/fire-animation-pack-1">Lights</a> animation taken from <a href="http://powstudios.com/content/fire-animation-pack-1">powstudios.com</a> <br>  For the magician's sprite, a special thank you to cute <a href="https://vk.com/corey_tyan">Kori Tyan</a> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/98/iv/bk/98ivbktxydtejzpvzutfxrvbcfg.png" width="250"></div></div><p>Source: <a href="https://habr.com/ru/post/343728/">https://habr.com/ru/post/343728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343716/index.html">Experiment to promote the game on Google Play. Part 1</a></li>
<li><a href="../343718/index.html">Sound settings in Ubuntu</a></li>
<li><a href="../343720/index.html">Strong typing in non-strict tests</a></li>
<li><a href="../343724/index.html">PLATO: the history of the world's first e-learning system</a></li>
<li><a href="../343726/index.html">Hinton's capsule nets</a></li>
<li><a href="../343730/index.html">We write DSL in Koltin</a></li>
<li><a href="../343732/index.html">Corporate "stuffing" for small networks</a></li>
<li><a href="../343736/index.html">Avtomatny workshop - 2. Example "Crossing", the mathematical transformations of TK in OA</a></li>
<li><a href="../343738/index.html">We understand what was discovered there in the problem of queens</a></li>
<li><a href="../343740/index.html">Security Week 48: Root Access for Diligence, Miner Consultant and Trial Macro Malware</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>