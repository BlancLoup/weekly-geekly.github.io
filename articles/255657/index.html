<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our devices to control the lighting in the smart home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Almost a year ago, we first introduced our automation controller, Wiren Board Smart Home . Soon we will launch sales of its new version - Wir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our devices to control the lighting in the smart home</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f1a/c91/eb2f1ac91b580af7ae287f90888aae8f.jpg" alt="image" align="left"><br><h2>  Hello! </h2><br>  Almost a year ago, we first introduced our automation controller, <b><a href="http://habrahabr.ru/company/contactless/blog/213243/">Wiren Board Smart Home</a></b> .  Soon we will launch sales of its new version - <a href="http://contactless.ru/store/"><b>Wiren Board 4</b></a> , and today we will tell about our two new devices from the class of budget wire peripherals for home automation. <br><br>  To create a smart home with one central controller is indispensable: some additional actuators are also required. <br>  The Wiren Board controller was previously positioned as a universal center of a smart home that controls third-party actuators. <br>  However, it became clear that the choice of periphery for budget installations is very limited, and the problem is particularly acute, oddly enough, in the most common area of ‚Äã‚Äãhome automation - in lighting control. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. What are the options? </h2><br><br>  Among the ready-made wireless devices to control the light of the budget segment, the choice consists of unidirectional (without feedback) devices operating at 433 MHz: <br><br><ul><li>  nooLite equipment (~ $ 20 per channel), </li><li>  Chinese noname kits (~ $ 10 per device), </li><li>  CoCo equipment (~ $ 20 per device), etc. </li></ul><br>  The lack of feedback, together with the use of the 433.92 MHz noisy range, makes the use of these devices in home automation very inconvenient.  The closest-priced devices with feedback (Z-wave) are several times more expensive. <br><br>  With wired devices, the situation is slightly better: in the budget segment there are devices based on Modbus or ADICON protocols, which are produced by several manufacturers: ICP-DAS, ‚ÄúSmart House‚Äù, Uniel.  Many products of these manufacturers are successful, but in general the price of devices and the price per channel in those actuators that are not terrible to use is not as low as we would like.  Some manufacturers do not work with retail customers, and few who always have them in stock. <br><br>  Seeing this sad situation, we decided to launch our line of wired peripherals. <br><br>  As a trial balloon, a dimmer for LED strips and a relay unit that works using the Modbus protocol, RS-485 standard, were chosen. <br><br><br><h2>  2. Why was Modbus chosen? </h2><br><br>  Modbus RTU is an open communication protocol based on a master-slave architecture.  Widely used in industry.  It is very simple to implement.  RS-485 is a standard for transmitting data using a differential signal over a twisted pair cable of the ‚Äúcommon bus‚Äù type, therefore the communication line is reliable and noise-resistant.  The price paid for this is the need to lay a cable. <br><br>  In home automation, RS-485 is convenient in that it can be bred using conventional CAT5 twisted pair for Ethernet.  In this case, one pair is used for data, two more - for power, one remains free.  All devices are connected in parallel to the same cable.  Branches, ‚Äústars‚Äù and rings in the network topology are not allowed by the standard, but in practice even such networks work well at distances of tens of meters. <br><br> <a href=""><img src="https://habrastorage.org/files/724/80a/dff/72480adff18f47cf9f39340c4b30114f.png"></a> <br><br><br><h2>  3. Local management </h2><br><br>  Modules are controlled both via Modbus and locally by connecting two external control buttons.  This allows the modules to work completely autonomously.  Therefore, by connecting a wall switch, you can control the lighting from it.  This is convenient and generally improves the reliability of the entire system: if the central controller fails or the RS-485 bus fails, the lighting continues to operate normally - simply without automation. <br><br>  Different operation modes of the buttons are supported: non-latching switches (most conveniently), regular latching switches. <br><br>  Since the modules work in standalone mode, and almost all PLCs and controllers for home automation support the Modbus protocol, the modules can be laid during repair for future connection to the home automation system. <br><br>  On modules it is also possible to assemble groups of pass-through switches, including using more than two switches connected in parallel.  It will work even without a central controller. <br><br><br><h2>  4. Centralized management </h2><br><br>  A bus with devices needs to be connected to a home automation controller for management.  We developed devices for use with the Wiren Board controller, but there are no restrictions on using modules with other controllers that support Modbus RTU.  A description of all registers is available on our <b>wiki</b> . <br><br>  Each Modbus device on the bus must have a unique address, so the standard for installations on Modbus is the procedure of pre-setting the address.  The address is set by sending a broadcast write command to the appropriate register, with only one device connected to the port. <br>  We tried to simplify the life of users in this place as much as possible, and distribute devices with predefined addresses that are written on the modules. <br><br>  In addition to standard operations ‚Äî setting the color for the LED dimmer and the relay status for the relay module ‚Äî several other interesting features are realized in the devices. <br><br>  The relay module has a ‚ÄúSafety timer‚Äù function, which allows you to turn off the relay if the module has not been interrogated by the central controller for a specified time.  The function is useful, for example, to control heaters in thermostats, when it is important that the load does not remain turned on in emergency situations, for example, when the bus is broken or if there is a problem with the central controller. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fee/14f/10b/fee14f10b1b85c9fc6eaaa759f666d70.jpg" alt="image"><br><br>  Both devices allow the controller to read the current state of the buttons.  Each button is also associated with a register counter, which stores the number of clicks on the corresponding button.  This allows the use of buttons connected to devices in user rules. <br><br>  All these functions are available through the Modbus registers and are supported by the appropriate software on the Wiren Board (the code, as usual, is open and works on any device with Linux). <br><br>  In addition, the modules have several service blocks of registers.  In one of these blocks, a model identifier is recorded, which allows automatic identification of devices on the bus.  In one more block, the firmware version is recorded. <br><br><br><h2>  5. Design features of the modules: </h2><br><br>  The use of one-sided surface mounting allows the modules to be made quite compact and easy to manufacture.  The packageless version (shrinkable tubing) significantly reduces the cost. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/94e/fa7/26f/94efa726ffb6f6cd239f40f4457b52d7.jpg" alt="image"></div><br><br>  The brains of the modules are an inexpensive STM32F0 microcontroller, with a large margin of possibilities. <br>  The consumption of the microcontroller and transceiver RS-485 is quite small, which allows the use of linear regulators for their power.  The operating voltage range of the modules is <b>8-24V</b> . <br>  Such a wide range of operating voltages is due to the lack of a single standard in home automation: in different systems, both 12V and 24V are used.  In addition, we wanted to ensure stable operation even when the voltage on the cables subsided. <br><br>  In order for the relay module to work in a wide voltage range, the following trick was used: the relays have a working voltage of 12 volts, but the MC measures the input voltage and controls the relay coil using PWM with a duty cycle of D = 12V / Ui, i.e.  the average current through the relay coil remains nominal even at high input voltages.  Also after switching on the relay, the holding current is set to half the nominal - this reduces the heating of the relay and the total consumption of the device by 4 times. <br><br>  When using PWM, there is a feature: at low frequencies, the relays work as a speaker.  So that the devices do not squeak, the PWM frequency is output outside the audio range and is 24 kHz. <br><br>  Power transistors LED dimmer WB-RGB - IRF8736 (Vmax = 30V, the resistance of the channel only ~ 5mOhm).  Buffer 74HC125 increases the control voltage from 3.3V from MK to 5V on the gates.  This allows such a small scarf to remain cold even at a current of 5A per channel. <br><br>  PWM is used to control the brightness of LED strips in the LED dimmer.  In the overwhelming majority of competing products, the frequency of PWM is in the region of 100-200 Hz, and in particularly bad cases this leads to a noticeable flicker of illumination.  In our device, PWM operates at a higher frequency.  As in the case of the relay, the frequency is displayed on the border of the audio range, but here it is done to avoid peeping of some not very high-quality power supplies of LED strips. <br><br>  Obviously, the function of maintaining the state of the module when power is turned off is highly desirable.  STM32F0 has an unpleasant feature in this regard: it does not have a built-in EEPROM, only flash-memory with a very limited rewriting resource. <br>  Writing to flash memory each time a new value is received is too wasteful, so the state is stored in RAM and flushed to the flash only when power is lost.  The moment of switching off is monitored by a voltage drop below a certain threshold. <br><br>  It‚Äôs not enough to save the state when turned off.  The number of overwrites per cell is limited to a thousand cycles.  Therefore, the next level of optimization is to use all free memory, i.e.  write values ‚Äã‚Äãevenly using different cells. <br><br>  The operation of writing a bit (i.e. setting a single value) to flash memory is fast, but erasing is performed only page by page, takes a lot of time and requires a lot of energy.  If there are no free cells left, you need to erase the entire page before writing the new value.  For this, you would have to put a huge capacitor for "backup power" when you turn it off. <br><br>  We use the following technique: when turning on the MK, we first check the availability of free space for recording in flash, if it is not there, then we free up space for future recording by erasing pages. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0db/f06/0e4/0dbf060e4851e893e5eb5ec9896a4081.jpg" alt="image"></div><br><br><br><h2>  6. Prices and plans </h2><br><br>  Since our main goal is to expand the ecosystem for Wiren Board controllers, we set fairly affordable prices for new modules, which are lower than those of competing products: <br><ol><li>  two-channel relay on a DIN rail WB-MR2-DIN costs <a href="http://contactless.ru/store/">2000r</a> </li><li>  the same two-channel relay WB-MR2 in heat shrink - <a href="http://contactless.ru/store/">1500r</a> </li><li>  RGB-dimmer WB-MRGB: <a href="http://contactless.ru/store/">2100 rubles</a> . </li></ol><br><br>  We plan to expand the line of devices on Modbus, so we will be happy to receive feedback in the vote and in the comments about which modules you would like to see on sale. </div><p>Source: <a href="https://habr.com/ru/post/255657/">https://habr.com/ru/post/255657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255647/index.html">Levitron on Arduino</a></li>
<li><a href="../255649/index.html">Best approaches to moving a MATLAB code to a fixed point</a></li>
<li><a href="../255651/index.html">Create a beautiful date / time / data picker in android</a></li>
<li><a href="../255653/index.html">Developing a cross-platform application using the Ionic Framework</a></li>
<li><a href="../255655/index.html">Video surveillance through 3 / 4G (part 1)</a></li>
<li><a href="../255659/index.html">We pump over Stream API, or we need more sugar.</a></li>
<li><a href="../255661/index.html">Magvik filter</a></li>
<li><a href="../255663/index.html">Interview with Stanislav Shalunov - developer of technology used in BitTorrent and Apple</a></li>
<li><a href="../255665/index.html">PHP Digest number 60 - interesting news, materials and tools (March 30 - April 13, 2015)</a></li>
<li><a href="../255667/index.html">We do the IR remote control for the camera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>