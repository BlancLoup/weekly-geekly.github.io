<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practical advice on the separation of data into parts. Generate PartitionKey and RowKey for Azure Table Storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. This is the final article from the series ‚ÄúThe internal structure and architecture of the AtContent.com service‚Äù. Here are the best practices f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practical advice on the separation of data into parts. Generate PartitionKey and RowKey for Azure Table Storage</h1><div class="post__text post__text-html js-mediator-article">  Hello.  This is the final article from the series ‚ÄúThe internal structure and architecture of the AtContent.com service‚Äù.  Here are the best practices from our experience with Azure Table Storage and the platform as a whole.  This article can be a starting point for building typical data structures and will allow more efficient use of Windows Azure resources. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a20/4c2/ed2/a204c2ed287741b1b7fba21fbae43c99.png"><br><br>  Horizontal scaling relies heavily on data sharing and the Windows Azure platform is no exception.  One of the components of the platform is the Azure Storage Table - NoSQL database with unlimited growth.  But many developers ignore it in favor of familiar and familiar SQL.  In this case, quite often tasks are solved using the Azure Storage Table much more efficiently than using Azure SQL. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here you will find practice and application scenarios for Azure Storage Tables. <br><a name="habracut"></a><br><h4>  In general, about Azure Table Storage </h4><br>  The most common use case is storage lists.  It fits nicely into the Azure Storage Tables architecture.  Lists can be very different, but the most frequently used ones are records by date. <br><br>  The first thing you should pay attention to when working is how values ‚Äã‚Äãare selected from the table.  There are several features here: <br><ul><li>  Values ‚Äã‚Äãare selected in parts of not more than 1000 values; </li><li>  Sampling without a partition key (PartitionKey) is very slow; </li><li>  When choosing a value range by key, the condition ‚Äúless than or equal to‚Äù correctly works; </li></ul><br>  It is always necessary to remember about sampling in parts, because Table Storage can return any number of records and a continuation token.  Although most often this happens when there are more than 1000 entries. The SDK has a mechanism that allows you to process it automatically, so you should not worry too much about it.  It is necessary to remember only that each request is an additional transaction.  If you have a 2001 entry in the sample, there will be at least 3 calls to the repository. <br><br>  Also need to remember about PartitionKey.  This is a very important key, which is responsible for the separation of data into sections.  If you do not specify it in the request, then the cloud storage will have to poll all sections and then collect the data in one set.  In this case, different sections can be located on different servers.  And it will not add performance to your requests.  In addition, it will increase the number of transactions to the repository. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b78/476/46d/b7847646dcc403d71eb8db594dc327c3.png"><br><br>  And finally, the least obvious feature is the selection of records by condition.  Experimentally it was found that if you specify the condition ‚Äúless than‚Äù or ‚Äúless than or equal to‚Äù for RowKey, then the selected values ‚Äã‚Äãwill go from the minimum to the one that will satisfy the condition.  In this case, the order of the returned entries will be from smaller to larger.  That is, if you have 10,000 records in a table that satisfy the condition, and you only need the first 100, for which the RowKey is less than a certain value, then the storage will select 100 records starting from the minimum RowKey value. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8ac/786/411/8ac7864110a102ebff80f93f16b7d514.png"><br><br>  As an example, consider a table in which several records with the key RowKey from a date.  And we need to select 2 records for which RowKey is less than 20120801221700. We expect that the repository will return records with the keys ‚Äú20120801221110‚Äù and ‚Äú20120801201728‚Äù.  But in accordance with the sorting order, the repository will return the values ‚Äã‚Äã‚Äú20120801171004‚Äù and ‚Äú20120801181514‚Äù. <br><br>  This can be overcome using an inverted key.  So, in the case of a date, it is DateTime.MaxValue - CurrentDateTime.  Then, the sample will use the opposite condition and it will work correctly. <br><br><h4>  Practice choosing partition keys </h4><br>  When designing an application, you should be guided by the recommendations that Microsoft makes regarding the Storage Table ( <a href="http://msdn.microsoft.com/en-us/library/windowsazure/hh508997.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/hh508997.aspx</a> ).  The meaning of these recommendations is very simple.  Design your applications so that there are not too many partition keys, and not too few.  And also, that there were not too many entries in each section.  It is desirable that they are divided into sections evenly.  If it is possible to predict the load on the sections, then the sections that will be subject to greater load should be filled with a smaller number of records.  Based on the Storage Tables architecture, partitions that are under heavy load are automatically replicated.  And the smaller the partition size is, the faster replication will occur. <br><br>  During development, we faced the problem of selecting partition keys for a table in which data is stored for identifying and authenticating users.  Since we identify the user primarily by email, it was necessary to choose a system according to which they would be divided into sections.  After conducting a small experiment, it was found that a good uniform distribution gives MD5 hashing and the subsequent separation of part of the bits from the hash to determine the partition number. <br><br>  Such a simple code will allow you to get the necessary number of bits from the MD5 hash and use it as a section number: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Security.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHashMD5Binary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Input, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> BitCount = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">128</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Input == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] MD5Bytes = MD5.Create().ComputeHash( Encoding.Default.GetBytes(Input)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Len = MD5Bytes.Length; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Result = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> HasBits = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Len; i++) { Result += Convert.ToString(MD5Bytes[i], <span class="hljs-number"><span class="hljs-number">2</span></span>).PadLeft(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>); HasBits += <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HasBits &gt;= BitCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BitCount &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> || BitCount &gt;= <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, BitCount); }</code> </pre> <br>  This method, like many others, is available as part of CPlaseEngine, a link to which can be found at the end of the article. <br><br>  In consequence, we extended this practice to other parts of our system, and it showed itself from a very good side.  Although in some cases partitioning is more profitable by user ID.  Or on the part of the user ID.  This allows you to build queries to select data related to a specific user.  In this case, requests are effective in the sense that one has to choose from one section. <br><br><h4>  Practice choosing keys for records </h4><br>  As you can see earlier, often the key for recording is associated with some date.  Most often, the date of creation.  In our system, this is very common.  And it is very effective for records, of which after you need to get a list starting from some date. <br><br>  Naturally, the recording key must be unique.  This uniqueness should be for a pair of ‚Äúpartition key‚Äù - ‚Äúwrite key‚Äù.  Therefore, when generating a key, it is safest to add a few random characters to it. <br><br>  If you plan to select records in the form of lists, then the general recommendation for generating a record key is to associate it with the parameter with which you will build the list.  So, for example, if you build a list of values ‚Äã‚Äãby date, then it is best to use the date when generating the key. <br><br><h4>  Distribution and synthesis </h4><br>  The practice of dividing by key hash can be applied not only in relation to Table Storage.  It extends very well to the file system.  When caching entities from Table Storage to the cache on an instance, we also use a hash partition from the file path. <br><br>  Horizontal scaling is closely related to the separation of data and the more efficiently you will share the data - the more efficient the system will work.  Windows Azure as a platform provides a very powerful infrastructure for building reliable, scalable, fault-tolerant services.  But at the same time, we should not forget that in order to build such services, the internal architecture must comply with the principles of building high-load systems. <br><br>  I also want to be happy to announce that our OpenSource project CPlaseEngine has appeared on the CodePlex openly.  It contains tools that allow you to develop services on the Windows Azure platform more efficiently.  You can download it at <a href="https://cplaseengine.codeplex.com/">https://cplaseengine.codeplex.com/</a> . <br><br>  Read in the series: <br><ul><li>  " <a href="http://habrahabr.ru/post/140418/">AtContent.com.</a>  <a href="http://habrahabr.ru/post/140418/">Internal structure and architecture</a> ", </li><li>  " <a href="http://habrahabr.ru/post/140461/">The mechanism of messaging between roles and instances</a> ", </li><li>  " <a href="http://habrahabr.ru/post/140955/">Caching data on an instance and managing caching</a> ", </li><li>  " <a href="http://habrahabr.ru/post/141797/">Effective cloud queue management (Azure Queue)</a> ", </li><li>  " <a href="http://habrahabr.ru/post/142627/">LINQ extensions for Azure Table Storage, implementing Or and Contains operations</a> ." </li></ul></div><p>Source: <a href="https://habr.com/ru/post/143838/">https://habr.com/ru/post/143838/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143833/index.html">Which mobile OS do you consider the most promising?</a></li>
<li><a href="../143834/index.html">Hack Wi-Fi in 10 hours</a></li>
<li><a href="../143835/index.html">Wozniak wants to see Apple more open</a></li>
<li><a href="../143836/index.html">The first meeting of Microsoft .NET User Group in Gomel - the first pancake is not a lump :)</a></li>
<li><a href="../143837/index.html">Sorry, the store on the record</a></li>
<li><a href="../143839/index.html">American dream, or Half a year in the top. In the mind</a></li>
<li><a href="../143840/index.html">About the organization of the desktop, works and documents</a></li>
<li><a href="../143842/index.html">Buy a computer with Windows 7 - get Windows 8 for $ 15</a></li>
<li><a href="../143843/index.html">Ultrabook review Acer Aspire S3</a></li>
<li><a href="../143846/index.html">Network on DHCP Option82 - it's just</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>