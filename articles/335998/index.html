<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make a project on the recognition of handwritten numbers with additional training online. Hyde for not quite beginners</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Recently, machine learning and data science in general are becoming increasingly popular. New libraries are constantly appearing and quite a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make a project on the recognition of handwritten numbers with additional training online. Hyde for not quite beginners</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  Recently, machine learning and data science in general are becoming increasingly popular.  New libraries are constantly appearing and quite a bit of code may be required to train machine learning models.  In such a situation, you can forget that machine learning is not an end in itself, but a tool for solving a problem.  It is not enough to make a working model, it is equally important to present the analysis results qualitatively or to make a working product. <br><br><img src="https://habrastorage.org/web/a1e/a62/47b/a1ea6247b3ce4c4db03cce9a1c670449.jpg" width="45%" align="right">  I would like to talk about how I created a <a href="https://digits-draw-recognize.herokuapp.com/">project</a> for recognizing handwritten input of numbers with models that are trained on user-drawn numbers.  Two models are used: simple neural network (FNN) on pure numpy and convolutional network (CNN) on Tensorflow.  You can learn how to do the following from practically nothing: <br><br><ul><li>  create a simple website using Flask and Bootstrap; </li><li>  place it on the Heroku platform; </li><li>  realize saving and loading of data using the Amazon s3 cloud; </li><li>  build your own dataset; </li><li>  train machine learning models (FNN and CNN); </li><li>  make the possibility of additional training of these models; </li><li>  make a website that can recognize drawn images; </li></ul><br>  For a full understanding of the project, it is advisable to know how deep learning works for image recognition, have a basic knowledge of Flask and understand a bit about HTML, JS and CSS. <br><a name="habracut"></a><br><h2>  Something about me </h2><br>  After graduating from the Faculty of Economics of Moscow State University, I worked for 4 years in IT consulting in the field of implementation and development of ERP systems.  It was very interesting to work, over the years I learned a lot of useful things, but over time it came to the realization that this is not mine.  After much deliberation, I decided to change the scope of activities and move to machine learning (not because of hype, but because I really became interested).  For this, he quit and worked for about half a year, independently studying programming, machine learning and other necessary things.  After that, with difficulty, but still found work in this direction.  I try to develop and improve my skills in my free time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  The origin of the idea </h2><br>  A few months ago, I passed a Yandex and MIPT specialization on Coursera.  She has her own team in Slack, and in April there the group organized itself for passing the Stanford course cs231n.  How this happened is a separate story, but more to the point.  An important part of the course is an independent project (40% of the assessment for students), which provides complete freedom of action.  I did not see the point of doing something serious and then writing about this article, but still my soul asked me to complete the course adequately.  Around this time, I came across a <a href="https://tensorflow-mnist.herokuapp.com/">website</a> where you can draw a number and two grids on Tensorflow instantly recognize it and show the result.  I decided to do something similar, but with my own data and models. <br><br><h1>  Main part </h1><br>  Here I will talk about what and how I did to implement the project.  The explanations will be sufficiently detailed so that you can repeat what has been done, but I will briefly describe or skip some basic things. <br><br><h2>  Project planning </h2><br>  Before you start something big, it is worth it to plan something.  Along the way, new details will be found out and the plan will have to be corrected, but some initial vision simply must be. <br><br><ol><li>  For any machine learning project, one of the fundamental issues is the question of what data to use and where to get it.  Dataset MNIST is actively used in the tasks of recognition of numbers, and that is why I did not want to use it.  On the Internet, you can find examples of such projects, where models are trained on MNIST (for example, the one <a href="https://github.com/sugyan/tensorflow-mnist">mentioned above</a> ), but I wanted to do something new.  And finally, it seemed to me that many of the figures in MNIST are far from reality - when I looked at dataset, I came across many such options that are difficult to imagine in reality (if only a person has a really creepy handwriting).  Plus drawing numbers in the browser with a mouse is somewhat different from writing them with a pen.  As a result, I decided to build my own dataset; </li><li>  The next (or rather simultaneous) step is to create a site for data collection.  At that time I had basic knowledge of Flask, as well as HTML, JS and CSS.  That's why I decided to create a website on Flask, and Heroku was chosen as the hosting platform, as it allows you to quickly and easily capture a small website; </li><li>  Next was to create the models themselves, which should do the main work.  This stage seemed the easiest, since after cs231n there was sufficient experience in creating neural network architectures for image recognition.  Previously I wanted to make several models, but later I decided to dwell on two - FNN and CNN.  In addition, it was necessary to make it possible to validate these models; I already had some ideas on this subject; </li><li>  After preparing the models, you should give the site a decent look, somehow display the predictions, give an opportunity to evaluate the correctness of the answer, describe the functionality a little and do a number of other small and not so great things.  At the planning stage, I did not spend much time thinking about it, I just made a list; </li></ol><br><h2>  Data collection </h2><br>  Almost half of all the time spent on the project took me to collect data.  The fact is that I was not very familiar with what had to be done, so I had to move by trial and error.  Naturally, it was not the drawing itself that was difficult, but the creation of a site on which it would be possible to draw numbers and save them somewhere.  For this, I needed to get to know Flask better, dig into Javascript, get acquainted with the Amazon S3 cloud and learn about Heroku.  I describe all this in sufficient detail so that it can be repeated, having the same level of knowledge that I had at the beginning of the project. <br><br>  Previously, I drew such a scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e5/666/407/4e56664079fbd9cc79633897ad783756.jpg"><br><br>  The data collection itself took several days, well, or several hours of pure time.  I drew 1000 numbers, about 100 each (but not exactly), tried to draw in different styles, but, of course, I could not cover all the possible variants of handwriting, which, however, was not the goal. <br><br><h3>  Creating the first version of the site (for data collection) </h3><br>  The first version of the site looked like this: <br><br><img src="https://habrastorage.org/web/618/04c/ce8/61804cce8086487abcc201e11e442959.jpg"><br><br>  It had only the most basic functionality: <br><br><ul><li>  canvas for drawing; </li><li>  radio buttons for label selection; </li><li>  buttons for saving images and cleaning canvas; </li><li>  the field in which the save was written successfully; </li><li>  saving pictures on the Amazon cloud; </li></ul><br>  So, now more about all this.  Especially for the article I made a minimally working version of the site, by the example of which I will tell you how to do the above: <a href="https://digits-little.herokuapp.com/">Site</a> <a href="https://github.com/Erlemar/digits_little">Code</a> <br><br>  Note: if the site has not been opened for a long time, then its launch can take up to 20-30 seconds - the costs of the free version of hosting.  This situation is relevant for the full version of the site. <br><br><h3>  Flask in brief </h3><br>  Flask - Python framework for creating websites.  The official site has a great <a href="http://flask.pocoo.org/docs/0.12/quickstart/">introduction</a> .  There are different ways to use Flask to receive and transfer information, so in this project I used AJAX.  AJAX allows for ‚Äúbackground‚Äù data exchange between the browser and the web server, this allows you not to reload the pages every time you transfer data. <br><br><h3>  Project structure </h3><br><img src="https://habrastorage.org/web/7b5/d72/4c5/7b5d724c5bc4435faa306cf4bd529beb.jpg"><br><br>  All files used in the project can be divided into 2 unequal groups: the smaller part is necessary for the application to work on Heroku, and all the others are directly involved in the work of the site. <br><br><h3>  HTML and JS </h3><br>  HTML files should be stored in the folder ‚Äútemplate‚Äù, at this stage it was enough to have one.  In the header of the document and at the end of the body tag are links to js and css files.  These files themselves must be in the ‚Äústatic‚Äù folder. <br><br><div class="spoiler">  <b class="spoiler_title">Html file</b> <div class="spoiler_text"><pre><code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Handwritten digit recognition<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"static/bootstrap.min.css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"static/style.css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>   . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"the_stage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag">&gt;</span></span>fsf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-default butt"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clearCanvas()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>clear<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-default butt"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"save"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"saveImg()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>save<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> Please select one of the following <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>0 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>1 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>2 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>3 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>4 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>5 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"6"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>6 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"7"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>7 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>8 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"radio"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"action"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"digit"</span></span></span><span class="hljs-tag">&gt;</span></span>9 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-md-6 column"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>result:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rec_result"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"static/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"static/bootstrap.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"static/draw.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br>  Now more about how drawing on canvas and saving the picture works. <br>  Canvas is a two-dimensional HTML5 element for drawing.  The image may be drawn by a script or the user may be able to draw using the mouse (or by touching the touch screen). <br><br>  Canvas is defined in HTML as follows: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"the_stage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Before that, I was not familiar with this element of HTML, so my initial attempts at drawing ability were unsuccessful.  After a while, I found a working example and borrowed it (the link is in my draw.js file). <br><br><div class="spoiler">  <b class="spoiler_title">Drawing code</b> <div class="spoiler_text"><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> drawing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offset_left = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offset_top = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_canvas</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById (<span class="hljs-string"><span class="hljs-string">"the_stage"</span></span>); context = canvas.getContext (<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); canvas.onmousedown = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{mousedown(event)}; canvas.onmousemove = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{mousemove(event)}; canvas.onmouseup = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{mouseup(event)}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = canvas; o ; o = o.offsetParent) { offset_left += (o.offsetLeft - o.scrollLeft); offset_top += (o.offsetTop - o.scrollTop); } draw(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPosition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">evt</span></span></span><span class="hljs-function">) </span></span>{ evt = (evt) ? evt : ((event) ? event : <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> left = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> top = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"the_stage"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (evt.pageX) { left = evt.pageX; top = evt.pageY; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement.scrollLeft) { left = evt.clientX + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement.scrollLeft; top = evt.clientY + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement.scrollTop; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { left = evt.clientX + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.scrollLeft; top = evt.clientY + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.scrollTop; } left -= offset_left; top -= offset_top; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-attr"><span class="hljs-attr">x</span></span> : left, <span class="hljs-attr"><span class="hljs-attr">y</span></span> : top}; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mousedown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ drawing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> location = getPosition(event); context.lineWidth = <span class="hljs-number"><span class="hljs-number">8.0</span></span>; context.strokeStyle=<span class="hljs-string"><span class="hljs-string">"#000000"</span></span>; context.beginPath(); context.moveTo(location.x,location.y); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mousemove</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!drawing) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> location = getPosition(event); context.lineTo(location.x,location.y); context.stroke(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouseup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!drawing) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; mousemove(event); context.closePath(); drawing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } . . . onload = start_canvas;</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">How drawing works</b> <div class="spoiler_text">  When the page loads, the start_canvas function starts.  The first two lines find the canvas as an element with a specific id ("the stage") and define it as a two-dimensional image.  When drawing on canvas, there are 3 events: onmousedown, onmousemove and onmouseup.  There are similar touch events, but more on that later. <br><br>  onmousedown - occurs when you click on the canvas.  At this point, the width and color of the line is set, and the starting point of the drawing is determined.  In words, locating the cursor sounds easy, but in fact it is not quite trivial.  To find the point, the <strong>getPosition ()</strong> function is used - it finds the coordinates of the cursor on the page and determines the coordinates of the point on the canvas, taking into account the relative position of the canvas on the page and taking into account that the page can be scrolled.  After finding the point, <strong>context.beginPath ()</strong> starts the drawing path, and <strong>context.moveTo (location.x, location.y)</strong> ‚Äúmoves‚Äù this path to the point that was determined at the time of the click. <br><br>  onmousemove - following the movement of the mouse while pressing the left key.  At the very beginning, a check was made that the key was pressed (that is, drawing = true), but if not, no drawing was performed.  <strong>context.lineTo ()</strong> creates a line along the mouse movement path, and <strong>context.stroke ()</strong> draws it directly. <br>  onmouseup - occurs when the left mouse button is released.  <strong>context.closePath ()</strong> completes line drawing. <br></div></div><br>  There are 4 more elements in the interface: <br><br><ul><li>  "Field" with the current status.  JS refers to it by id (rec_result) and displays the current status.  The status is either empty, or indicates that the image is saved, or shows the name of the saved image. </li></ul><br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-md-6 column"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>result:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rec_result"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><ul><li>  Radio buttons to select numbers.  At the stage of data collection, the drawn figures must somehow be assigned to the labels, for this, 10 buttons were added.  Buttons are set like this: <br><br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>="radio" <span class="hljs-type"><span class="hljs-type">name</span></span>="action" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="0" id="digit"&gt;<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  where in place 0 is the corresponding figure.  <em>Name is</em> used so that JS can get the value of the active radio button ( <em>value</em> ); </li><li>  Button to clear canvas - so that you can draw a new number. <br><br><pre> <code class="hljs javascript">&lt;button type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"btn btn-default butt"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"clearCanvas()"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">clear</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  Clicking this button will do the following: </li></ul><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ context.fillStyle = <span class="hljs-string"><span class="hljs-string">'#ffffff'</span></span>; context.fillRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearCanvas</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ context.clearRect (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); draw(); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"rec_result"</span></span>).innerHTML = <span class="hljs-string"><span class="hljs-string">""</span></span>; }</code> </pre><br>  Canvas content is cleared, and it is filled with white.  Also, the status becomes empty. <br><br><ul><li>  Finally, the button to save the drawn image.  It calls the following Javascript function: </li></ul><br><pre> <code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveImg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"rec_result"</span></span>).innerHTML = <span class="hljs-string"><span class="hljs-string">"connecting..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"the_stage"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataURL = canvas.toDataURL(<span class="hljs-string"><span class="hljs-string">'image/jpg'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dig = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'input[name="action"]:checked'</span></span>).value; $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/hook"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">imageBase64</span></span>: dataURL, <span class="hljs-attr"><span class="hljs-attr">digit</span></span>: dig } }).done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(response) <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"rec_result"</span></span>).innerHTML = response }); }</code> </pre><br>  Immediately after pressing the button, the value of ‚Äúconnecting ...‚Äù is displayed in the status field.  The image is then converted to a text string using the base64 encoding method.  The result is as follows: <code>data:image/png;base64,%string%</code> , where you can see the file type (image), extension (png), base64 encoding and the string itself.  Here I want to note that I noticed a mistake in my code too late.  I should have used 'image / jpeg' as an argument for <code>canvas.toDataURL()</code> , but I made a typo and as a result the images were actually png. <br><br>  Then I take the value of the active radio button (by name = 'action' and as <code>checked</code> ) and save it to the variable <code>dig</code> . <br><br>  Finally, the AJAX request sends the encoded image and label to the python, and then receives a response.  I spent quite a lot of time trying to make this construction work, I will try to explain what is happening in each line. <br><br>  First, the type of request is specified - in this case ‚ÄúPOST‚Äù, that is, the data from JS is transferred to the python script. <br><br>  "/ hook" is where data is transferred.  Since I use Flask, I can specify "/ hook" as the URL in the desired decorator, and this will mean that the function in this decorator will be used when a POST request is sent to this URL.  More on this in the section about Flask below. <br><br>  <code>data</code> is the data that is transmitted in the request.  There are a lot of data transfer options, in this case I set the value and the name through which you can get this value. <br>  Finally, <code>done()</code> is what happens when the request is successful.  My AJAX request returns a certain answer (or rather the text with the name of the saved image), this answer is first displayed in the console (for debugging), and then displayed in the status field. <br><br>  To distract, I want to talk about a small problem that arose at the beginning of the project.  For some reason, this basic site for image processing was loaded for about a minute.  I tried to minimize it, leaving just a few lines - nothing helped.  As a result, thanks to the console, it was possible to identify the source of the brakes - antivirus. <br><br><img src="https://habrastorage.org/web/cfe/5f3/f22/cfe5f3f2272d46c986904ca74ebb8c11.jpg"><br><br>  It turned out that Kaspersky inserts his script into my site, which led to inadequately long loading.  After disabling the option, the site began to load instantly. <br><br><h3>  Flask and image saving </h3><br>  Now let's move on to how data from an AJAX request gets into python, and how the image is saved. <br><br>  There are many guides and articles on working with Flask, so I‚Äôll just briefly describe the basic things, pay special attention to the lines without which the code does not work, and, of course, I‚Äôll tell you about the rest of the code that is the basis of the site. <br><br><div class="spoiler">  <b class="spoiler_title">main.py</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">__author__ = <span class="hljs-string"><span class="hljs-string">'Artgor'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">functions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask, render_template, request <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask_cors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CORS, cross_origin <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> base64 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os app = Flask(__name__) model = Model() CORS(app, headers=[<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>]) @app.route("/", methods=["POST", "GET", <span class="hljs-string"><span class="hljs-string">'OPTIONS'</span></span>]) def index_page(): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>) @app.route(<span class="hljs-string"><span class="hljs-string">'/hook'</span></span>, methods = ["GET", "POST", <span class="hljs-string"><span class="hljs-string">'OPTIONS'</span></span>]) def get_image(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.<span class="hljs-keyword"><span class="hljs-keyword">method</span></span> == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: image_b64 = request.<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>[<span class="hljs-string"><span class="hljs-string">'imageBase64'</span></span>] drawn_digit = request.<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>[<span class="hljs-string"><span class="hljs-string">'digit'</span></span>] image_encoded = image_b64.split(<span class="hljs-string"><span class="hljs-string">','</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] image = base64.decodebytes(image_encoded.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) save = model.save_image(drawn_digit, image) print(<span class="hljs-string"><span class="hljs-string">'Done'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> save <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: port = <span class="hljs-type"><span class="hljs-type">int</span></span>(os.environ.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("PORT", <span class="hljs-number"><span class="hljs-number">5000</span></span>)) app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=port, <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">functions.py</b> <div class="spoiler_text"><pre> <code class="hljs python">__author__ = <span class="hljs-string"><span class="hljs-string">'Artgor'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> codecs <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> open <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> boto.s3.key <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Key <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> boto.s3.connection <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> S3Connection <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.nothing = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, drawn_digit, image)</span></span></span><span class="hljs-function">:</span></span> filename = <span class="hljs-string"><span class="hljs-string">'digit'</span></span> + str(drawn_digit) + <span class="hljs-string"><span class="hljs-string">'__'</span></span> + str(uuid.uuid1()) + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(image) print(<span class="hljs-string"><span class="hljs-string">'Image written'</span></span>) REGION_HOST = <span class="hljs-string"><span class="hljs-string">'s3-external-1.amazonaws.com'</span></span> conn = S3Connection(os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_ACCESS_KEY_ID'</span></span>], os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_SECRET_ACCESS_KEY'</span></span>], host=REGION_HOST) bucket = conn.get_bucket(<span class="hljs-string"><span class="hljs-string">'testddr'</span></span>) k = Key(bucket) fn = <span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename k.key = filename k.set_contents_from_filename(fn) print(<span class="hljs-string"><span class="hljs-string">'Done'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">'Image saved successfully with the name {0}'</span></span>.format(filename))</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">How code works</b> <div class="spoiler_text">  The first step is to create an instance of the Flask class with the default value of <code>app = Flask(__name__)</code> .  This will be the basis of the application. <br><br>  Next, I create an instance of the class to use the second script.  Considering that there is only one function in it, one could dispense with the use of classes or even keep all the code in one script.  But I knew that the number of methods would grow, so I decided to immediately use this option. <br><br>  CORS (Cross-origin resource sharing) is a technology that provides web pages with access to resources from another domain.  In this application, it is used to save images on the Amazon cloud.  I have been looking for a way to activate this setting for a long time, and then how to make it easier.  As a result, implemented one line: <code>CORS(app, headers=['Content-Type'])</code> . <br><br>  Next, the <code>route()</code> decorator is used ‚Äî it determines which function is executed for which URL.  In the main script there are 2 decorators with functions.  The first one is used for the main page (since the address is <code>"/"</code> ) and displays ‚Äúindex.html‚Äù.  The second decorator has the address "" / hook "", which means that it is the data from JS that is transferred to it (remember that the same address was specified there). <br><br>  I note that both decorators have the list ‚ÄúPOST‚Äù, ‚ÄúGET‚Äù, 'OPTIONS' as the value of the method parameter.  POST and GET are used to receive and transmit data (both are specified just in case), OPTIONS is required to transfer parameters such as CORS.  In theory, OPTIONS should be used by default, starting with Flask 0.6, but without its explicit instructions, I could not get the code to work. <br><br>  Now let's talk about the function to get the image.  From JS in Python comes the 'request'.  This may be form data, data obtained from AJAX, or something else.  In my case, this is a dictionary with the keys and values ‚Äã‚Äãspecified in JS.  Removing the picture label is trivial, you just need to take the dictionary value by key, but you need to process the string with the image - take the part related to the image itself (discarding the description) and decode it. <br><br>  After that, the function is called from the second script to save the image.  It returns a string with the name of the saved image, which then returns to JS and is displayed on the browser page. <br><br>  The last part of the code is necessary for the application to work on heroku (taken from the documentation).  How to place the application on Heroku will be described in detail in the appropriate section. <br><br>  Finally, let's see how the image is saved.  Currently, the image is stored in a variable, but to save the image on the Amazon cloud, you must have a file, so you need to save the image.  The name of the image contains its label and unique id generated by uuid.  After that, the picture is saved in the tmp temporary folder and uploaded to the cloud.  I‚Äôll say right away that the file in the tmp folder will be temporary: heroku stores the new / changed files during the session, and after it deletes the files or rolls back the changes.  This allows you not to think about the need to clean the folder and generally convenient, but because of this, and have to use the cloud. <br></div></div><br>  And now you can talk about how the Amazon cloud works and what you can do with it. <br><br><h3>  Amazon s3 integration </h3><br>  Python has two libraries for working with the Amazon cloud: boto and boto3.  The second is newer and better supported, but so far some things are more convenient to do using the first. <br><br><div class="spoiler">  <b class="spoiler_title">Create and configure bucket in Amazon</b> <div class="spoiler_text">  I think that registration of the account will not cause any problems.  It is important not to forget to generate access keys using libraries (Access Key ID and Secret Access Key).  In the cloud itself, you can create buckets, where the files will be stored.  In Russian buckets - buckets that sounds strange to me, so I prefer to use the original name. <br>  And now went the nuances. <br><br><img src="https://habrastorage.org/web/e91/318/24c/e9131824cabb473d8b195d994c68e84e.jpg"><br><br>  When creating you need to specify the name, and then you need to be careful.  Initially, I used a name containing hyphens, but could not connect to the cloud.  It turned out that some individual characters actually cause this problem.  There are workarounds, but they do not work for everyone.  As a result, I began to use the variant of the name with underscore (digit_draw_recognize), there were no problems with it. <br>  Next you need to specify the region.  You can choose almost any, but it should be guided by this <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">tablet</a> . <br>  First, we need Endpoint for the selected region, and secondly, it is easier to use regions that support versions 2 and 4 of the signature, so that you can use what is convenient.  I chose US East (N. Virginia). <br><br>  The remaining parameters when creating a bucket can not be changed. <br>  Another important point is to configure CORS. <br><br><img src="https://habrastorage.org/web/da7/aa5/578/da7aa557855f48e085ab034d9b2a822b.jpg"><br><br>  The following code must be entered into the setup: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span>*<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedOrigin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span>GET<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedMethod</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MaxAgeSeconds</span></span></span><span class="hljs-tag">&gt;</span></span>3000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MaxAgeSeconds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span>Authorization<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllowedHeader</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CORSConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  You can read more about this setting <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html">here</a> and set softer / tighter parameters.  Initially, I thought that I needed to specify more methods (and not just GET), but it all works. <br></div></div><br>  Now actually about the code.  For now, it‚Äôs about how to save files on Amazon.  About receiving data from the cloud will be discussed later. <br><br><pre> <code class="hljs lua">REGION_HOST = <span class="hljs-string"><span class="hljs-string">'s3-external-1.amazonaws.com'</span></span> conn = S3Connection(<span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.environ[<span class="hljs-string"><span class="hljs-string">'AWS_ACCESS_KEY_ID'</span></span>], <span class="hljs-built_in"><span class="hljs-built_in">os</span></span>.environ[<span class="hljs-string"><span class="hljs-string">'AWS_SECRET_ACCESS_KEY'</span></span>], host=REGION_HOST) bucket = conn.get_bucket(<span class="hljs-string"><span class="hljs-string">'testddr'</span></span>) k = Key(bucket) fn = <span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename k.key = filename k.set_contents_from_filename(fn)</code> </pre><br>  The first step is to create a connection to the cloud.  To do this, you must specify the Access Key ID, Secret Access Key and Region Host.  We have already generated the keys, but it is dangerous to indicate them explicitly.  This can be done only when testing the code locally.  I hit the code on github a couple of times with openly specified keys - they were stolen for a couple of minutes.  Do not repeat my mistakes.  Heroku provides the ability to store keys and refer to them by name - more on this below.  The region host is the endpoint value from the region label. <br><br>  After that, you need to connect to the bucket - here it is already quite possible to specify the name directly. <br><br>  <code>Key</code> used to work with objects in the basket.  To save an object, you must specify the file name (k.key), and then call <code>k.set_contents_from_filename()</code> with the path to the file you want to save. <br><br><h3>  Heroku </h3><br>  It's time to talk about how to place a website on Heroku.  Heroku is a multi-language cloud platform that allows you to quickly and conveniently deploy web applications.  It is possible to use Postgres and a lot of interesting things.  Generally speaking, I could store images using Heroku resources, but I need to store different types of data, so it was easier to use a separate cloud. <br><br>  Heroku offers several price plans, but for my application (including the full-fledged one, not this small one), the free one is enough.  The only minus is that the application ‚Äúfalls asleep‚Äù after half an hour of activity and at the next launch it can spend 30 seconds to ‚Äúwake up‚Äù. <br><br>  You can find a lot of guides on deploying applications on Heroku (here is a link to the <a href="https://devcenter.heroku.com/articles/getting-started-with-python">official one</a> ), but most of them use the console, and I prefer to use interfaces.  Besides, it seems to me much easier and more convenient. <br><br><div class="spoiler">  <b class="spoiler_title">Placing an application on Heroku</b> <div class="spoiler_text">  So to the point.  To prepare the application, you need to create several files: <br><br><ul><li>  Requires version control system .git.  Usually it is created automatically when you create a github repository, but you need to check that it really is; </li><li>  <code>runtime.txt</code> - this file should indicate the required version of the programming language used, in my case python-3.6.1; </li><li>  <code>Procfile</code> is a file with no extension.  It indicates which commands should be run on heroku.  This defines the type of <code>web</code> process that runs (my script) and the address: </li></ul><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">web</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">python</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.py</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">runserver</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5000</span></span></code> </pre><br><ul><li>  <code>requirements.txt</code> - a list of libraries that will be installed on Heroku.  It is better to specify the necessary versions; </li><li>  And the last thing - at least one file must be in the ‚Äútmp‚Äù folder, otherwise there may be problems with saving the files in this folder while the application is running; </li></ul><br>  Now you can begin the process of creating an application.  At this point there should be an account for heroku and a prepared github repository. <br><br>  From the <a href="https://dashboard.heroku.com/apps">page</a> with the list of applications, a new one is created: <br><br><img src="https://habrastorage.org/web/112/379/534/1123795348d94a7aa92d12c14ffd0d4e.jpg"><br><br>  Specify the name and country: <br><br><img src="https://habrastorage.org/web/af0/79e/52a/af079e52acc642f0b72fdc4b3c05acde.jpg"><br><br>  On the Deploy tab, select the connection to Github: <br><br><img src="https://habrastorage.org/web/a21/255/5ab/a212555abdd04f40aa4b61d2a397c758.jpg"><br><br>  Connect and select the repository: <br><br><img src="https://habrastorage.org/web/f5f/e26/fd1/f5fe26fd13fd45a59141a51e81af8c4e.jpg"><br><br>  It makes sense to enable automatic updating of the application on Heroku every time you update the repository.  And you can begin the deployment: <br><br><img src="https://habrastorage.org/web/453/181/e22/453181e2279945388995353d2f6bf6ec.jpg"><br><br>  We look at the logs and hope that everything went well: <br><br><img src="https://habrastorage.org/web/f89/54b/0c1/f8954b0c19e147bfaa84c50b8d715ef7.jpg"><br><br>  But still not everything is ready, before the first launch of the application on the settings tab, you need to set variables - keys for the Amazon cloud. <br><br><img src="https://habrastorage.org/web/b1b/eec/d8e/b1beecd8ef8a4cf6a0509ec9759ab206.jpg"><br></div></div><br>  Now you can run the application and work with it.  This completes the site description for data collection.  The following discussion focuses on data processing and the next stages of the project. <br><br><h2>  Image processing for models </h2><br>  I save the drawn images as pictures in the original format, so that you can always look at them and try different processing options. <br><br>  Here are some examples: <br><br><img src="https://habrastorage.org/web/093/2ef/dd2/0932efdd27be4c6a95e631690559b04c.jpg"><br><br>  The idea of ‚Äã‚Äãimage processing for my project is as follows (similar to mnist): the drawn figure is scaled to fit in a 20x20 square, keeping the proportions, and then placed in the center of a white square 28x28 in size.  The following steps are necessary for this: <br><br><ul><li>  find the borders of the image (the border has the shape of a rectangle); </li><li>  find the height and width of the bounded rectangle; </li><li>  to equate the larger side to 20, and the smaller to scale so as to keep the proportions; </li><li>  find the starting point for drawing the scaled digit on a 28x28 square and draw it; </li><li>  convert to np.array so that you can work with data and normalize; </li></ul><br><div class="spoiler">  <b class="spoiler_title">Image processing</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#    img = Image.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) #   bbox = Image.eval(img, lambda px: <span class="hljs-number"><span class="hljs-number">255</span></span>-px).getbbox() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bbox == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> #    widthlen = bbox[<span class="hljs-number"><span class="hljs-number">2</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">0</span></span>] heightlen = bbox[<span class="hljs-number"><span class="hljs-number">3</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">1</span></span>] #  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> heightlen &gt; widthlen: widthlen = <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen / heightlen) heightlen = <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: heightlen = <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen / heightlen) widthlen = <span class="hljs-number"><span class="hljs-number">20</span></span> #    hstart = <span class="hljs-type"><span class="hljs-type">int</span></span>((<span class="hljs-number"><span class="hljs-number">28</span></span> - heightlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) wstart = <span class="hljs-type"><span class="hljs-type">int</span></span>((<span class="hljs-number"><span class="hljs-number">28</span></span> - widthlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) #   img_temp = img.crop(bbox).resize((widthlen, heightlen), Image.NEAREST) #       new_img = Image.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">28</span></span>), <span class="hljs-number"><span class="hljs-number">255</span></span>) new_img.paste(img_temp, (wstart, hstart)) #   np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>   imgdata = list(new_img.getdata()) img_array = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([(<span class="hljs-number"><span class="hljs-number">255.0</span></span> - x) / <span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> imgdata])</code> </pre><br></div></div><br><h2>  Image augmentation </h2><br>  It is obvious that 1000 images are not enough for training the neural network, and in fact some of them need to be used for model validation.       ‚Äî   ,     .   ,     ,     .      . <br><br>       ,     .        2020      .    4   ‚Äî 4     . <br><br>        .  ,     ‚Äî 30      ;     5 ,  12  .      ,   12    6. <br><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="hljs pgsql">#    image = Image.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) #        ims_add = [] labs_add = [] # ,       angles = np.arange(<span class="hljs-number"><span class="hljs-number">-30</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) #   bbox = Image.eval(image, lambda px: <span class="hljs-number"><span class="hljs-number">255</span></span>-px).getbbox() #    widthlen = bbox[<span class="hljs-number"><span class="hljs-number">2</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">0</span></span>] heightlen = bbox[<span class="hljs-number"><span class="hljs-number">3</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">1</span></span>] #  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> heightlen &gt; widthlen: widthlen = <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) heightlen = <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: heightlen = <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) widthlen = <span class="hljs-number"><span class="hljs-number">20</span></span> #    hstart = <span class="hljs-type"><span class="hljs-type">int</span></span>((<span class="hljs-number"><span class="hljs-number">28</span></span> - heightlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) wstart = <span class="hljs-type"><span class="hljs-type">int</span></span>((<span class="hljs-number"><span class="hljs-number">28</span></span> - widthlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) # <span class="hljs-number"><span class="hljs-number">4</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [min(widthlen, heightlen), max(widthlen, heightlen)]: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [min(widthlen, heightlen), max(widthlen, heightlen)]: #   resized_img = image.crop(bbox).resize((i, j), Image.NEAREST) #       resized_image = Image.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">28</span></span>), <span class="hljs-number"><span class="hljs-number">255</span></span>) resized_image.paste(resized_img, (wstart, hstart)) #   <span class="hljs-number"><span class="hljs-number">6</span></span>   <span class="hljs-number"><span class="hljs-number">12.</span></span> angles_ = random.sample(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(angles), <span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> angle <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> angles_: #   transformed_image = <span class="hljs-keyword"><span class="hljs-keyword">transform</span></span>.rotate(np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(resized_image), angle, cval=<span class="hljs-number"><span class="hljs-number">255</span></span>, preserve_range=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>).astype(np.uint8) labs_add.append(<span class="hljs-type"><span class="hljs-type">int</span></span>(label)) #      img_temp = Image.fromarray(np.uint8(transformed_image)) #   np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>   imgdata = list(img_temp.getdata()) normalized_img = [(<span class="hljs-number"><span class="hljs-number">255.0</span></span> - x) / <span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> imgdata] ims_add.append(normalized_img)</code> </pre><br></div></div><br>  : <br><br><img src="https://habrastorage.org/web/96f/3d8/225/96f3d8225726461cbd7fb2f1baa12893.jpg"><br><br>    800 * 24 = 19200      200   .         . <br><br><h2> FNN </h2><br>      feed forward neural net.   ,   cs231n,    . <br><br><img src="https://habrastorage.org/web/7a1/5a4/4ff/7a15a44ff6cf4ed890de3b361645b10d.jpg"><br><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt #https://gist.github.com/anbrjohn/<span class="hljs-number"><span class="hljs-number">7116</span></span>fa0b59248375cd0c0371d6107a59 def draw_neural_net(ax, left, right, bottom, top, layer_sizes, layer_text=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>): <span class="hljs-string"><span class="hljs-string">''' :parameters: - ax : matplotlib.axes.AxesSubplot The axes on which to plot the cartoon (get eg by plt.gca()) - left : float The center of the leftmost node(s) will be placed here - right : float The center of the rightmost node(s) will be placed here - bottom : float The center of the bottommost node(s) will be placed here - top : float The center of the topmost node(s) will be placed here - layer_sizes : list of int List of layer sizes, including input and output dimensionality - layer_text : list of str List of node annotations in top-down left-right order '''</span></span> n_layers = len(layer_sizes) v_spacing = (top - bottom)/<span class="hljs-type"><span class="hljs-type">float</span></span>(max(layer_sizes)) h_spacing = (right - left)/<span class="hljs-type"><span class="hljs-type">float</span></span>(len(layer_sizes) - <span class="hljs-number"><span class="hljs-number">1</span></span>) ax.axis(<span class="hljs-string"><span class="hljs-string">'off'</span></span>) # Nodes <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n, layer_size <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(layer_sizes): layer_top = v_spacing*(layer_size - <span class="hljs-number"><span class="hljs-number">1</span></span>)/<span class="hljs-number"><span class="hljs-number">2.</span></span> + (top + bottom)/<span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(layer_size): x = n*h_spacing + left y = layer_top - m*v_spacing <span class="hljs-type"><span class="hljs-type">circle</span></span> = plt.Circle((x,y), v_spacing/<span class="hljs-number"><span class="hljs-number">4.</span></span>, color=<span class="hljs-string"><span class="hljs-string">'w'</span></span>, ec=<span class="hljs-string"><span class="hljs-string">'k'</span></span>, zorder=<span class="hljs-number"><span class="hljs-number">4</span></span>) ax.add_artist(<span class="hljs-type"><span class="hljs-type">circle</span></span>) # Node annotations <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> layer_text: <span class="hljs-type"><span class="hljs-type">text</span></span> = layer_text.pop(<span class="hljs-number"><span class="hljs-number">0</span></span>) plt.annotate(<span class="hljs-type"><span class="hljs-type">text</span></span>, xy=(x, y), zorder=<span class="hljs-number"><span class="hljs-number">5</span></span>, ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'center'</span></span>) # Edges <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n, (layer_size_a, layer_size_b) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(zip(layer_sizes[:<span class="hljs-number"><span class="hljs-number">-1</span></span>], layer_sizes[<span class="hljs-number"><span class="hljs-number">1</span></span>:])): layer_top_a = v_spacing*(layer_size_a - <span class="hljs-number"><span class="hljs-number">1</span></span>)/<span class="hljs-number"><span class="hljs-number">2.</span></span> + (top + bottom)/<span class="hljs-number"><span class="hljs-number">2.</span></span> layer_top_b = v_spacing*(layer_size_b - <span class="hljs-number"><span class="hljs-number">1</span></span>)/<span class="hljs-number"><span class="hljs-number">2.</span></span> + (top + bottom)/<span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> m <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(layer_size_a): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(layer_size_b): <span class="hljs-type"><span class="hljs-type">line</span></span> = plt.Line2D([n*h_spacing + left, (n + <span class="hljs-number"><span class="hljs-number">1</span></span>)*h_spacing + left], [layer_top_a - m*v_spacing, layer_top_b - o*v_spacing], c=<span class="hljs-string"><span class="hljs-string">'k'</span></span>) ax.add_artist(<span class="hljs-type"><span class="hljs-type">line</span></span>) node_text = [<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-string"><span class="hljs-string">'h1'</span></span>,<span class="hljs-string"><span class="hljs-string">'h2'</span></span>,<span class="hljs-string"><span class="hljs-string">'h3'</span></span>,<span class="hljs-string"><span class="hljs-string">'...'</span></span>, <span class="hljs-string"><span class="hljs-string">'h100'</span></span>] fig = plt.figure(figsize=(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) ax = fig.gca() draw_neural_net(ax, <span class="hljs-number"><span class="hljs-number">.1</span></span>, <span class="hljs-number"><span class="hljs-number">.9</span></span>, <span class="hljs-number"><span class="hljs-number">.1</span></span>, <span class="hljs-number"><span class="hljs-number">.9</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], node_text) plt.text(<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.95</span></span>, "Input Layer\nImages 28x28", ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'top'</span></span>, fontsize=<span class="hljs-number"><span class="hljs-number">16</span></span>) plt.text(<span class="hljs-number"><span class="hljs-number">0.26</span></span>, <span class="hljs-number"><span class="hljs-number">0.78</span></span>, "W1", ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'top'</span></span>, fontsize=<span class="hljs-number"><span class="hljs-number">16</span></span>) plt.text(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.95</span></span>, "Hidden Layer\n with ReLU", ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'top'</span></span>, fontsize=<span class="hljs-number"><span class="hljs-number">16</span></span>) plt.text(<span class="hljs-number"><span class="hljs-number">0.74</span></span>, <span class="hljs-number"><span class="hljs-number">0.74</span></span>, "W2", ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'top'</span></span>, fontsize=<span class="hljs-number"><span class="hljs-number">16</span></span>) plt.text(<span class="hljs-number"><span class="hljs-number">0.88</span></span>, <span class="hljs-number"><span class="hljs-number">0.95</span></span>, "Output Layer\n10 classes", ha=<span class="hljs-string"><span class="hljs-string">'center'</span></span>, va=<span class="hljs-string"><span class="hljs-string">'top'</span></span>, fontsize=<span class="hljs-number"><span class="hljs-number">16</span></span>) plt.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>()</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> FNN</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">import numpy as np class <span class="hljs-type"><span class="hljs-type">TwoLayerNet</span></span>(object): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" A two-layer fully-connected neural network. The net has an input dimension of N, a hidden layer dimension of H, and performs classification over C classes. We train the network with a softmax loss function and L2 regularization on the weight matrices. The network uses a ReLU nonlinearity after the first fully connected layer. In other words, the network has the following architecture: input - fully connected layer - ReLU - fully connected layer - softmax The outputs of the second fully-connected layer are the scores for each class. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> def __init__(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, input_size, hidden_size, output_size, std): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" Initialize the model. Weights are initialized following Xavier intialization and biases are initialized to zero. Weights and biases are stored in the variable self.params, which is a dictionary with the following keys: W1: First layer weights; has shape (D, H) b1: First layer biases; has shape (H,) W2: Second layer weights; has shape (H, C) b2: Second layer biases; has shape (C,) Inputs: - input_size: The dimension D of the input data. - hidden_size: The number of neurons H in the hidden layer. - output_size: The number of classes C. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params = {} <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] = (((<span class="hljs-number"><span class="hljs-number">2</span></span> / input_size) ** <span class="hljs-number"><span class="hljs-number">0.5</span></span>) * np.random.randn(input_size, hidden_size)) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] = np.zeros(hidden_size) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] = (((<span class="hljs-number"><span class="hljs-number">2</span></span> / hidden_size) ** <span class="hljs-number"><span class="hljs-number">0.5</span></span>) * np.random.randn(hidden_size, output_size)) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] = np.zeros(output_size) def loss(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-type"><span class="hljs-type">X</span></span>, y=<span class="hljs-type"><span class="hljs-type">None</span></span>, reg=<span class="hljs-number"><span class="hljs-number">0.0</span></span>): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" Compute the loss and gradients for a two layer fully connected neural network. Inputs: - X: Input data of shape (N, D). X[i] is a training sample. - y: Vector of training labels. y[i] is the label for X[i], and each y[i] is an integer in the range 0 &lt;= y[i] &lt; C. - reg: Regularization strength. Returns: - loss: Loss (data loss and regularization loss) for this batch of training samples. - grads: Dictionary mapping parameter names to gradients of those parameters with respect to the loss function; has the same keys as self.params. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> # <span class="hljs-type"><span class="hljs-type">Unpack</span></span> variables from the params dictionary <span class="hljs-type"><span class="hljs-type">W1</span></span>, b1 = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] <span class="hljs-type"><span class="hljs-type">W2</span></span>, b2 = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] <span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">D</span></span> = <span class="hljs-type"><span class="hljs-type">X</span></span>.shape # <span class="hljs-type"><span class="hljs-type">Compute</span></span> the forward pass l1 = <span class="hljs-type"><span class="hljs-type">X</span></span>.dot(<span class="hljs-type"><span class="hljs-type">W1</span></span>) + b1 l1[l1 &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> l2 = l1.dot(<span class="hljs-type"><span class="hljs-type">W2</span></span>) + b2 exp_scores = np.exp(l2) probs = exp_scores / np.sum(exp_scores, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>, keepdims=<span class="hljs-type"><span class="hljs-type">True</span></span>) scores = l2 # <span class="hljs-type"><span class="hljs-type">Compute</span></span> the loss <span class="hljs-type"><span class="hljs-type">W1_r</span></span> = <span class="hljs-number"><span class="hljs-number">0.5</span></span> * reg * np.sum(<span class="hljs-type"><span class="hljs-type">W1</span></span> * <span class="hljs-type"><span class="hljs-type">W1</span></span>) <span class="hljs-type"><span class="hljs-type">W2_r</span></span> = <span class="hljs-number"><span class="hljs-number">0.5</span></span> * reg * np.sum(<span class="hljs-type"><span class="hljs-type">W2</span></span> * <span class="hljs-type"><span class="hljs-type">W2</span></span>) loss = -np.sum(np.log(probs[range(y.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>]), y]))/<span class="hljs-type"><span class="hljs-type">N</span></span> + <span class="hljs-type"><span class="hljs-type">W1_r</span></span> + <span class="hljs-type"><span class="hljs-type">W2_r</span></span> # <span class="hljs-type"><span class="hljs-type">Backward</span></span> pass: compute gradients grads = {} probs[range(<span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>]),y] -= <span class="hljs-number"><span class="hljs-number">1</span></span> dW2 = np.dot(l1.<span class="hljs-type"><span class="hljs-type">T</span></span>, probs) dW2 /= <span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>] dW2 += reg * <span class="hljs-type"><span class="hljs-type">W2</span></span> grads[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] = dW2 grads[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] = np.sum(probs, axis=<span class="hljs-number"><span class="hljs-number">0</span></span>, keepdims=<span class="hljs-type"><span class="hljs-type">True</span></span>) / <span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>] delta = probs.dot(<span class="hljs-type"><span class="hljs-type">W2</span></span>.<span class="hljs-type"><span class="hljs-type">T</span></span>) delta = delta * (l1 &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) grads[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] = np.dot(<span class="hljs-type"><span class="hljs-type">XT</span></span>, delta)/ <span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>] + reg * <span class="hljs-type"><span class="hljs-type">W1</span></span> grads[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] = np.sum(delta, axis=<span class="hljs-number"><span class="hljs-number">0</span></span>, keepdims=<span class="hljs-type"><span class="hljs-type">True</span></span>) / <span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>] return loss, grads def train(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-type"><span class="hljs-type">X</span></span>, y, <span class="hljs-type"><span class="hljs-type">X_val</span></span>, y_val, learning_rate=<span class="hljs-number"><span class="hljs-number">1e-3</span></span>, learning_rate_decay=<span class="hljs-number"><span class="hljs-number">0.95</span></span>, reg=<span class="hljs-number"><span class="hljs-number">5e-6</span></span>, num_iters=<span class="hljs-number"><span class="hljs-number">100</span></span>, batch_size=<span class="hljs-number"><span class="hljs-number">24</span></span>, verbose=<span class="hljs-type"><span class="hljs-type">False</span></span>): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" Train this neural network using stochastic gradient descent. Inputs: - X: A numpy array of shape (N, D) giving training data. - y: A numpy array f shape (N,) giving training labels; y[i] = c means that [i] has label c, where 0 &lt;= c &lt; C. - X_val: A numpy array of shape (N_val, D); validation data. - y_val: A numpy array of shape (N_val,); validation labels. - learning_rate: Scalar giving learning rate for optimization. - learning_rate_decay: Scalar giving factor used to decay the learning rate each epoch. - reg: Scalar giving regularization strength. - num_iters: Number of steps to take when optimizing. - batch_size: Number of training examples to use per step. - verbose: boolean; if true print progress during optimization. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> num_train = <span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>] iterations_per_epoch = max(num_train / batch_size, <span class="hljs-number"><span class="hljs-number">1</span></span>) # <span class="hljs-type"><span class="hljs-type">Use</span></span> <span class="hljs-type"><span class="hljs-type">SGD</span></span> to optimize the parameters in <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.model loss_history = [] train_acc_history = [] val_acc_history = [] # <span class="hljs-type"><span class="hljs-type">Training</span></span> cycle for it in range(num_iters): # <span class="hljs-type"><span class="hljs-type">Mini</span></span>-batch selection indexes = np.random.choice(<span class="hljs-type"><span class="hljs-type">X</span></span>.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>], batch_size, replace=<span class="hljs-type"><span class="hljs-type">True</span></span>) <span class="hljs-type"><span class="hljs-type">X_batch</span></span> = <span class="hljs-type"><span class="hljs-type">X</span></span>[indexes] y_batch = y[indexes] # <span class="hljs-type"><span class="hljs-type">Compute</span></span> loss and gradients using the current minibatch loss, grads = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.loss(<span class="hljs-type"><span class="hljs-type">X_batch</span></span>, y=y_batch, reg=reg) loss_history.append(loss) # <span class="hljs-type"><span class="hljs-type">Update</span></span> weights <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] -= learning_rate * grads[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] -= learning_rate * grads[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] -= learning_rate * grads[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] -= learning_rate * grads[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] if verbose and it % <span class="hljs-number"><span class="hljs-number">100</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>: print(<span class="hljs-string"><span class="hljs-string">'iteration %d / %d: loss %f'</span></span> % (it, num_iters, loss)) # <span class="hljs-type"><span class="hljs-type">Every</span></span> epoch, check accuracy and decay learning rate. if it % iterations_per_epoch == <span class="hljs-number"><span class="hljs-number">0</span></span>: # <span class="hljs-type"><span class="hljs-type">Check</span></span> accuracy train_acc = (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.predict(<span class="hljs-type"><span class="hljs-type">X_batch</span></span>)==y_batch).mean() val_acc = (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.predict(<span class="hljs-type"><span class="hljs-type">X_val</span></span>) == y_val).mean() train_acc_history.append(train_acc) val_acc_history.append(val_acc) # <span class="hljs-type"><span class="hljs-type">Decay</span></span> learning rate learning_rate *= learning_rate_decay return { <span class="hljs-string"><span class="hljs-string">'loss_history'</span></span>: loss_history, <span class="hljs-string"><span class="hljs-string">'train_acc_history'</span></span>: train_acc_history, <span class="hljs-string"><span class="hljs-string">'val_acc_history'</span></span>: val_acc_history, } def predict(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-type"><span class="hljs-type">X</span></span>): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" Use the trained weights of this two-layer network to predict labels for points. For each data point we predict scores for each of the C classes, and assign each data point to the class with the highest score. Inputs: - X: A numpy array of shape (N, D) giving N D-dimensional data points to classify. Returns: - y_pred: A numpy array of shape (N,) giving predicted labels for each of elements of X. For all i, y_pred[i] = c means that X[i] is predicted to have class c, where 0 &lt;= c &lt; C. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> l1 = <span class="hljs-type"><span class="hljs-type">X</span></span>.dot(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>]) + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] l1[l1 &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> l2 = l1.dot(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>]) + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] exp_scores = np.exp(l2) probs = exp_scores / np.sum(exp_scores, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>, keepdims=<span class="hljs-type"><span class="hljs-type">True</span></span>) y_pred = np.argmax(probs, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) return y_pred def predict_single(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-type"><span class="hljs-type">X</span></span>): <span class="hljs-comment"><span class="hljs-comment">""</span></span><span class="hljs-comment"><span class="hljs-comment">" Use the trained weights of this two-layer network to predict label for data point. We predict scores for each of the C classes, and assign the data point to the class with the highest score. Inputs: - X: A numpy array of shape (N, D) giving N D-dimensional data points to classify. Returns: - y_pred: A numpy array of shape (1,) giving predicted labels for X. "</span></span><span class="hljs-comment"><span class="hljs-comment">""</span></span> l1 = <span class="hljs-type"><span class="hljs-type">X</span></span>.dot(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>]) + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] l1[l1 &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> l2 = l1.dot(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>]) + <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] exp_scores = np.exp(l2) y_pred = np.argmax(exp_scores) return y_pred</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  FNN</b> <div class="spoiler_text">   cs231n <a href="http://cs231n.github.io/neural-networks-1/"></a>  : <br><br><img src="https://habrastorage.org/web/029/728/de0/029728de0f0f426198fc944c7b27c382.png"><br><br>           ‚Äî  ,       ,  ,    . <br><br>       ,        N  784,  N ‚Äî   (19200  ).     ,           ,     : <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-1"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-2">f</span><span class="MJXp-mo" id="MJXp-Span-3" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-munderover" id="MJXp-Span-4"><span><span class="MJXp-over"><span class=" MJXp-script"><span class="MJXp-mrow" id="MJXp-Span-8" style="margin-right: 0px; margin-left: 0px;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-9">n</span></span></span><span class=""><span class="MJXp-mo" id="MJXp-Span-5" style="margin-left: 0.111em; margin-right: 0.167em;"><span class="MJXp-largeop">‚àë</span></span></span></span></span><span class=" MJXp-script"><span class="MJXp-mrow" id="MJXp-Span-6" style="margin-left: 0px;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-7">i</span></span></span></span><span class="MJXp-msubsup" id="MJXp-Span-10"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-11" style="margin-right: 0.05em;">x</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-12" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-13">i</span></span></span><span class="MJXp-msubsup" id="MJXp-Span-14"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15" style="margin-right: 0.05em;">w</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-16" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-17">i</span></span></span><span class="MJXp-mo" id="MJXp-Span-18" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">b</span><span class="MJXp-mo" id="MJXp-Span-20" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.261ex" height="6.89ex" viewBox="0 -1661 6570.7 2966.5" role="img" focusable="false" style="vertical-align: -3.032ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-66" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-28" x="550" y="0"></use><g transform="translate(940,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJSZ2-2211" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="848" y="-1536"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6E" x="721" y="1627"></use></g><g transform="translate(2551,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="809" y="-213"></use></g><g transform="translate(3467,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-77" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="1013" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-2B" x="4750" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-62" x="5751" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-29" x="6181" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-1">f(\sum_{i}^{n} x_{i}w_{i} + b)</script></p>       ReLU (Rectified Linear Unit),       <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-21"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-22">l</span><span class="MJXp-mn" id="MJXp-Span-23">1</span><span class="MJXp-mo" id="MJXp-Span-24" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25">m</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-26">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27">x</span><span class="MJXp-mo" id="MJXp-Span-28" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mn" id="MJXp-Span-29">0</span><span class="MJXp-mo" id="MJXp-Span-30" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-munderover" id="MJXp-Span-31"><span><span class="MJXp-over"><span class=" MJXp-script"><span class="MJXp-mrow" id="MJXp-Span-35" style="margin-right: 0px; margin-left: 0px;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-36">n</span></span></span><span class=""><span class="MJXp-mo" id="MJXp-Span-32" style="margin-left: 0.111em; margin-right: 0.167em;"><span class="MJXp-largeop">‚àë</span></span></span></span></span><span class=" MJXp-script"><span class="MJXp-mrow" id="MJXp-Span-33" style="margin-left: 0px;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-34">i</span></span></span></span><span class="MJXp-msubsup" id="MJXp-Span-37"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-38" style="margin-right: 0.05em;">x</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-39" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40">i</span></span></span><span class="MJXp-msubsup" id="MJXp-Span-41"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-42" style="margin-right: 0.05em;">w</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-43" style="vertical-align: -0.4em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44">i</span></span></span><span class="MJXp-mo" id="MJXp-Span-45" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46">b</span><span class="MJXp-mo" id="MJXp-Span-47" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25.733ex" height="6.89ex" viewBox="0 -1661 11079.4 2966.5" role="img" focusable="false" style="vertical-align: -3.032ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-31" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-3D" x="1076" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6D" x="2133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-61" x="3011" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-78" x="3541" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-28" x="4113" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-30" x="4503" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-2C" x="5003" y="0"></use><g transform="translate(5448,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJSZ2-2211" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="848" y="-1536"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6E" x="721" y="1627"></use></g><g transform="translate(7059,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="809" y="-213"></use></g><g transform="translate(7976,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-77" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-69" x="1013" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-2B" x="9259" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-62" x="10260" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-29" x="10689" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-2">l1 = max(0, \sum_{i}^{n} x_{i}w_{i} + b)</script></p>                .  ReLU   ,     ,  sigmoid  tahn;   ,      (   ),   learning rate    .         784  100,    N  100.              : <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-48"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-49">l</span><span class="MJXp-mn" id="MJXp-Span-50">2</span><span class="MJXp-mo" id="MJXp-Span-51" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-52">l</span><span class="MJXp-mn" id="MJXp-Span-53">1</span><span class="MJXp-msubsup" id="MJXp-Span-54"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-55" style="margin-right: 0.05em;">w</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-56" style="vertical-align: 0.5em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-57">h</span></span></span><span class="MJXp-mo" id="MJXp-Span-58" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-59">b</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.491ex" height="2.762ex" viewBox="0 -1009.3 5808.6 1189" role="img" focusable="false" style="vertical-align: -0.417ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-32" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-3D" x="1076" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-6C" x="2133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-31" x="2431" y="0"></use><g transform="translate(2932,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-77" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-68" x="1013" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMAIN-2B" x="4378" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/ods/blog/335998/&amp;xid=25657,15700019,15700186,15700190,15700248,15700253&amp;usg=ALkJrhitsm85hU1228afKK_j_-cVzzqnFg#MJMATHI-62" x="5379" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-3">l2 = l1w^{h} + b</script></p>    softmax,   : <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-60"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-61">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-62">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-63">t</span><span class="MJXp-mo" id="MJXp-Span-64" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mfrac" id="MJXp-Span-65" style="vertical-align: 0.25em;"><span class="MJXp-box"><span class="MJXp-msubsup" id="MJXp-Span-66"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-67" style="margin-right: 0.05em;">e</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-68" style="vertical-align: 0.5em;"><span class="MJXp-msubsup" id="MJXp-Span-69"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-70" style="margin-right: 0.05em;">f</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-71" style="vertical-align: -0.4em;"><span class="MJXp-msubsup" id="MJXp-Span-72"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-73" style="margin-right: 0.05em;">y</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-74" style="vertical-align: -0.4em;">i</span></span></span></span></span></span></span><span class="MJXp-box" style="margin-top: -0.9em;"><span class="MJXp-denom"><span><span class="MJXp-rule" style="height: 1em; border-top: none; border-bottom: 1px solid; margin: 0.1em 0px;"></span></span><span><span class="MJXp-box"><span class="MJXp-msubsup" id="MJXp-Span-75"><span class="MJXp-mo" id="MJXp-Span-76" style="margin-left: 0.111em; margin-right: 0.05em;">‚àë</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-77" style="vertical-align: -0.4em;">j</span></span><span class="MJXp-msubsup" id="MJXp-Span-78"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-79" style="margin-right: 0.05em;">e</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-80" style="vertical-align: 0.5em;"><span class="MJXp-msubsup" id="MJXp-Span-81"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-82" style="margin-right: 0.05em;">f</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-83" style="vertical-align: -0.4em;">j</span></span></span></span></span></span></span></span></span></span></span><script type="math/tex;mode=display" id="MathJax-Element-4">out = \frac{e^{f_{y_i}}}{ \sum_j e^{f_j} }</script></p><br>  ,  softmax ‚Äî      .       ,  ,      . ,        100  10,     10 ,             . Cross-entropy loss  softmax  : <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-84"><span class="MJXp-msubsup" id="MJXp-Span-85"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-86" style="margin-right: 0.05em;">L</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-87" style="vertical-align: -0.4em;">i</span></span><span class="MJXp-mo" id="MJXp-Span-88" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-89" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mi" id="MJXp-Span-90">log</span><span class="MJXp-mo" id="MJXp-Span-91" style="margin-left: 0em; margin-right: 0em;"></span><span class="MJXp-mrow" id="MJXp-Span-92"><span class="MJXp-mo" id="MJXp-Span-93" style="margin-left: 0em; margin-right: 0em; vertical-align: -0.867em;"><span class="MJXp-right MJXp-scale3" style="font-size: 4.467em; margin-left: -0.21em;">(</span></span><span class="MJXp-mfrac" id="MJXp-Span-94" style="vertical-align: 0.25em;"><span class="MJXp-box"><span class="MJXp-msubsup" id="MJXp-Span-95"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-96" style="margin-right: 0.05em;">e</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-97" style="vertical-align: 0.5em;"><span class="MJXp-msubsup" id="MJXp-Span-98"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-99" style="margin-right: 0.05em;">f</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-100" style="vertical-align: -0.4em;"><span class="MJXp-msubsup" id="MJXp-Span-101"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-102" style="margin-right: 0.05em;">y</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-103" style="vertical-align: -0.4em;">i</span></span></span></span></span></span></span><span class="MJXp-box" style="margin-top: -0.9em;"><span class="MJXp-denom"><span><span class="MJXp-rule" style="height: 1em; border-top: none; border-bottom: 1px solid; margin: 0.1em 0px;"></span></span><span><span class="MJXp-box"><span class="MJXp-msubsup" id="MJXp-Span-104"><span class="MJXp-mo" id="MJXp-Span-105" style="margin-left: 0.111em; margin-right: 0.05em;">‚àë</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-106" style="vertical-align: -0.4em;">j</span></span><span class="MJXp-msubsup" id="MJXp-Span-107"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-108" style="margin-right: 0.05em;">e</span><span class="MJXp-mrow MJXp-script" id="MJXp-Span-109" style="vertical-align: 0.5em;"><span class="MJXp-msubsup" id="MJXp-Span-110"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-111" style="margin-right: 0.05em;">f</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-112" style="vertical-align: -0.4em;">j</span></span></span></span></span></span></span></span></span><span class="MJXp-mo" id="MJXp-Span-113" style="margin-left: 0em; margin-right: 0em; vertical-align: -0.867em;"><span class="MJXp-right MJXp-scale3" style="font-size: 4.467em; margin-left: -0.21em;">)</span></span></span></span></span><script type="math/tex;mode=display" id="MathJax-Element-5">L_i = -\log\left(\frac{e^{f_{y_i}}}{ \sum_j e^{f_j} }\right)</script></p><br></div></div><br>    : <br><br><ul><li>         (Xavier).        2 /   .           ; </li><li>   loss          L2 ; </li><li>   train     -.     .          ,    learning rate   decay; </li><li>  predict_single     ,  predict ‚Äî  ; </li></ul><br>           : <br><br><pre> <code class="hljs lisp">input_size = <span class="hljs-number"><span class="hljs-number">28</span></span> * <span class="hljs-number"><span class="hljs-number">28</span></span> hidden_size = <span class="hljs-number"><span class="hljs-number">100</span></span> num_classes = <span class="hljs-number"><span class="hljs-number">10</span></span> net = tln(<span class="hljs-name"><span class="hljs-name">input_size</span></span>, hidden_size, num_classes)</code> </pre><br>         : <br><br><ul><li>       ; </li><li>     -,     ; </li><li>   learning rate   decay,    learning rate   ; </li><li>   ; </li><li>   verbose  /  ; </li></ul><br><pre> <code class="hljs pgsql">stats = net.train(X_train_, y_train_, X_val, y_val, num_iters=<span class="hljs-number"><span class="hljs-number">19200</span></span>, batch_size=<span class="hljs-number"><span class="hljs-number">24</span></span>, learning_rate=<span class="hljs-number"><span class="hljs-number">0.1</span></span>, learning_rate_decay=<span class="hljs-number"><span class="hljs-number">0.95</span></span>, reg=<span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre><br>  ,      loss       ,    : <br><br><pre> <code class="hljs matlab">plt.subplot(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) plt.<span class="hljs-built_in"><span class="hljs-built_in">plot</span></span>(stats[<span class="hljs-string"><span class="hljs-string">'loss_history'</span></span>]) plt.title(<span class="hljs-string"><span class="hljs-string">'Loss history'</span></span>) plt.xlabel(<span class="hljs-string"><span class="hljs-string">'Iteration'</span></span>) plt.ylabel(<span class="hljs-string"><span class="hljs-string">'Loss'</span></span>) plt.subplot(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) plt.<span class="hljs-built_in"><span class="hljs-built_in">plot</span></span>(stats[<span class="hljs-string"><span class="hljs-string">'train_acc_history'</span></span>], label=<span class="hljs-string"><span class="hljs-string">'train'</span></span>) plt.<span class="hljs-built_in"><span class="hljs-built_in">plot</span></span>(stats[<span class="hljs-string"><span class="hljs-string">'val_acc_history'</span></span>], label=<span class="hljs-string"><span class="hljs-string">'val'</span></span>) plt.title(<span class="hljs-string"><span class="hljs-string">'Classification accuracy history'</span></span>) plt.xlabel(<span class="hljs-string"><span class="hljs-string">'Epoch'</span></span>) plt.ylabel(<span class="hljs-string"><span class="hljs-string">'Clasification accuracy'</span></span>) plt.<span class="hljs-built_in"><span class="hljs-built_in">legend</span></span>() plt.show()</code> </pre><br><img src="https://habrastorage.org/web/d61/35b/c30/d6135bc3037a4f5485b550489664f881.jpg"><br><br><h2>     </h2><br>    ‚Äî  . , ,          ‚Äî ,       .      .    ,      ,           . ,       ,   ,      . <br><br>         ,     .       .         learning rate, regularization,     ,     -;     ,        .      . <br><br><div class="spoiler">  <b class="spoiler_title">Selection of parameters</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> itertools <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> product best_net = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> results = {} best_val = <span class="hljs-number"><span class="hljs-number">-1</span></span> learning_rates = [<span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>] regularization_strengths = [<span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.01</span></span>] hidden_size = [<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>] epochs = [<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>] batch_sizes = [<span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>] best_params = <span class="hljs-number"><span class="hljs-number">0</span></span> best_params = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> product(learning_rates, regularization_strengths, hidden_size, epochs, batch_sizes): print(<span class="hljs-string"><span class="hljs-string">'learning rate: {0}, regularization strength: {1}, hidden size: {2}, \ iterations: {3}, batch_size: {4}.'</span></span>.format(v[<span class="hljs-number"><span class="hljs-number">0</span></span>], v[<span class="hljs-number"><span class="hljs-number">1</span></span>], v[<span class="hljs-number"><span class="hljs-number">2</span></span>], v[<span class="hljs-number"><span class="hljs-number">3</span></span>], v[<span class="hljs-number"><span class="hljs-number">4</span></span>])) net = TwoLayerNet(input_size, v[<span class="hljs-number"><span class="hljs-number">2</span></span>], num_classes) stats = net.train(X_train_, y_train, X_val_, y_val, num_iters=v[<span class="hljs-number"><span class="hljs-number">3</span></span>], batch_size=v[<span class="hljs-number"><span class="hljs-number">4</span></span>], learning_rate=v[<span class="hljs-number"><span class="hljs-number">0</span></span>], learning_rate_decay=<span class="hljs-number"><span class="hljs-number">0.95</span></span>, reg=v[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) y_train_pred = net.predict(X_train_) train_acc = np.mean(y_train == y_train_pred) val_acc = (net.predict(X_val_) == y_val).mean() print(<span class="hljs-string"><span class="hljs-string">'Validation accuracy: '</span></span>, val_acc) results[(v[<span class="hljs-number"><span class="hljs-number">0</span></span>], v[<span class="hljs-number"><span class="hljs-number">1</span></span>], v[<span class="hljs-number"><span class="hljs-number">2</span></span>], v[<span class="hljs-number"><span class="hljs-number">3</span></span>], v[<span class="hljs-number"><span class="hljs-number">4</span></span>])] = val_acc <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> val_acc &gt; best_val: best_val = val_acc best_net = net best_params = (v[<span class="hljs-number"><span class="hljs-number">0</span></span>], v[<span class="hljs-number"><span class="hljs-number">1</span></span>], v[<span class="hljs-number"><span class="hljs-number">2</span></span>], v[<span class="hljs-number"><span class="hljs-number">3</span></span>], v[<span class="hljs-number"><span class="hljs-number">4</span></span>])</code> </pre><br></div></div><br>     ,    ,   ,  -  .   ,     , learning rate         .        .  -   ,         :    ,       1  . 1   24 ,         -  .         24. <br><br>           MNIST,           MNIST. <br><br><div class="spoiler"> <b class="spoiler_title">      MNIST</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">def <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span> = "."): fname_img = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-string"><span class="hljs-string">'t10k-images.idx3-ubyte'</span></span>) fname_lbl = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-string"><span class="hljs-string">'t10k-labels.idx1-ubyte'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(fname_lbl, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> flbl: magic, num = struct.unpack("&gt;II", flbl.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>)) lbl = np.fromfile(flbl, dtype=np.int8) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(fname_img, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fimg: magic, num, <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, cols = struct.unpack("&gt;IIII", fimg.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>)) img = np.fromfile(fimg, dtype=np.uint8).reshape(len(lbl), <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, cols) get_img = lambda idx: (lbl[idx], img[idx]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(lbl)): yield get_img(i) test = list(<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>="/MNIST_data")) mnist_labels = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([i[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test]).astype(<span class="hljs-type"><span class="hljs-type">int</span></span>) mnist_picts = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([i[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test]).reshape(<span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">784</span></span>) / <span class="hljs-number"><span class="hljs-number">255</span></span> y_mnist = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(mnist_labels).astype(<span class="hljs-type"><span class="hljs-type">int</span></span>)</code> </pre><br></div></div><br>       : <br><br><img src="https://habrastorage.org/web/e44/757/929/e4475792921543e998344e3acddb2fb9.jpg"><br><br>   ,      ~10 ,      . <br><br> ,   ,    MNIST  .   ,    ,        MNIST  .       CNN   <a href="https://www.tensorflow.org/get_started/mnist/pros"></a> Tensorflow  MNIST   .    MNIST   99%+ (  ),         : 78.5%    63.35%  .     ,     MNIST  ,               MNIST. <br><br> ,      : <br><br><ul><li>    ; </li><li>     /; </li><li>    : , , rmsprop; </li></ul><br>         . ,        . <br><br>      : <code>net.param</code>    ,   ‚Äî  ,   ‚Äî  .  numpy       : <code>np.save('tmp/updated_weights.npy', net.params)</code> .    <code>np.load('models/original_weights.npy')[()]</code> ( <code>[()]</code>   ,        ). <br><br>      . <br><br><h2>  FNN </h2><br>       .     : <br><br><ul><li>     ,    .        ; </li><li>   ,   ; </li><li>          (1 ,   24); </li><li>    (learning rate  )      ; </li><li>  predict-single  3      .      ,      ; </li></ul><br><div class="spoiler"> <b class="spoiler_title">  FNN</b> <div class="spoiler_text"><pre> <code class="hljs markdown">import numpy as np class FNN(object): """ A two-layer fully-connected neural network. The net has an input dimension of N, a hidden layer dimension of H, and performs classification over C classes. We train the network with a softmax loss function and L2 regularization on the weight matrices. The network uses a ReLU nonlinearity after the first fully connected layer. In other words, the network has the following architecture: input - fully connected layer - ReLU - fully connected layer - softmax The outputs of the second fully-connected layer are the scores for each class. """ def <span class="hljs-strong"><span class="hljs-strong">__init__</span></span>(self, weights,input<span class="hljs-emphasis"><span class="hljs-emphasis">_size=28*28,hidden_</span></span>size=100,output<span class="hljs-emphasis"><span class="hljs-emphasis">_size=10): """ Initialize the model. Weights are initialized following Xavier intialization and biases are initialized to zero. Weights and biases are stored in the variable self.params, which is a dictionary with the following keys: W1: First layer weights; has shape (D, H) b1: First layer biases; has shape (H,) W2: Second layer weights; has shape (H, C) b2: Second layer biases; has shape (C,) Inputs: - input_</span></span>size: The dimension D of the input data. - hidden<span class="hljs-emphasis"><span class="hljs-emphasis">_size: The number of neurons H in the hidden layer. - output_</span></span>size: The number of classes C. """ self.params = {} self.params[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] = weights[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] self.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] = weights[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] self.params[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] = weights[<span class="hljs-string"><span class="hljs-string">'W2'</span></span>] self.params[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] = weights[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>] def loss(self, X, y, reg=0.0): """ Compute the loss and gradients for a two layer fully connected neural network. Inputs: - X: Input data of shape (N, D). X[<span class="hljs-string"><span class="hljs-string">i</span></span>] is a training sample. - y: Vector of training labels. y[<span class="hljs-string"><span class="hljs-string">i</span></span>] is the label for X[<span class="hljs-string"><span class="hljs-string">i</span></span>], and each y[<span class="hljs-string"><span class="hljs-string">i</span></span>] is an integer in the range 0 <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">C.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Regularization</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strength.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Returns:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loss:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Loss</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loss</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">regularization</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loss</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">this</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">batch</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">training</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">samples.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">grads:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Dictionary</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mapping</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">parameter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">names</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gradients</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">those</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">parameters</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">respect</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">loss</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">has</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">same</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">keys</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params.</span></span></span></span><span class="xml"><span class="hljs-tag"> """ # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Unpack</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">variables</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">from</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">params</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dictionary</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W1</span></span></span></span><span class="xml"><span class="hljs-tag">'], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag">'], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">D</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">X.shape</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Compute</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">forward</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pass</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">X.dot(W1)</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">l1.dot(W2)</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.exp(l2)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.sum</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">axis</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">keepdims</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">True)</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Backward</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pass:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">compute</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">gradients</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">grads</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">range</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X.shape</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">]), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag">= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dW2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.dot(l1.T,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dW2</span></span></span></span><span class="xml"><span class="hljs-tag"> /= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">X.shape[0]</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dW2</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">reg</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">grads</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag">'] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">dW2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">grads</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag">'] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.sum(probs,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">axis</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">keepdims</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">True)</span></span></span></span><span class="xml"><span class="hljs-tag"> / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X.shape</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">delta</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">probs.dot(W2.T)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">delta</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">delta</span></span></span></span><span class="xml"><span class="hljs-tag"> * (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> &gt;</span></span></span></span> 0) grads[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] = np.dot(XT, delta)/ X.shape[<span class="hljs-string"><span class="hljs-string">0</span></span>] + reg <span class="hljs-bullet"><span class="hljs-bullet">* W1 grads['b1'] = np.sum(delta, axis=0, keepdims=True) / X.shape[0] return grads def train(self, X, y, learning_rate=0.1*</span></span>(0.95<span class="hljs-emphasis"><span class="hljs-emphasis">**24)/32, reg=0.001, batch_size=24): """ Train this neural network using stochastic gradient descent. Inputs: - X: A numpy array of shape (N, D) giving training data. - y: A numpy array f shape (N,) giving training labels; y[i] = c means that [i] has label c, where 0 &lt;= c &lt; C. - X_val: A numpy array of shape (N_val, D); validation data. - y_val: A numpy array of shape (N_val,); validation labels. - learning_rate: Scalar giving learning rate for optimization. - learning_rate_decay: Scalar giving factor used to decay the learning rate each epoch. - reg: Scalar giving regularization strength. - num_iters: Number of steps to take when optimizing. - batch_size: Number of training examples to use per step. - verbose: boolean; if true print progress during optimization. """ num_train = X.shape[0] # Compute loss and gradients using the current minibatch grads = self.loss(X, y, reg=reg) self.params['W1'] -= learning_rate *</span></span> grads[<span class="hljs-string"><span class="hljs-string">'W1'</span></span>] self.params[<span class="hljs-string"><span class="hljs-string">'b1'</span></span>] -= learning<span class="hljs-emphasis"><span class="hljs-emphasis">_rate * grads['b1'][0] self.params['W2'] -= learning_</span></span>rate <span class="hljs-bullet"><span class="hljs-bullet">* grads['W2'] self.params['b2'] -= learning_rate *</span></span> grads[<span class="hljs-string"><span class="hljs-string">'b2'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>] def predict(self, X): """ Use the trained weights of this two-layer network to predict labels for points. For each data point we predict scores for each of the C classes, and assign each data point to the class with the highest score. Inputs: - X: A numpy array of shape (N, D) giving N D-dimensional data points to classify. Returns: - y<span class="hljs-emphasis"><span class="hljs-emphasis">_pred: A numpy array of shape (N,) giving predicted labels for each of elements of X. For all i, y_</span></span>pred[<span class="hljs-string"><span class="hljs-string">i</span></span>] = c means that X[<span class="hljs-string"><span class="hljs-string">i</span></span>] is predicted to have class c, where 0 <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">C.</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">X.dot(self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W1</span></span></span></span><span class="xml"><span class="hljs-tag">']) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">l1.dot(self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag">']) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.exp(l2)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.sum</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">axis</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">keepdims</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">True)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y_pred</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.argmax(probs,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">axis</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y_pred</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">def</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict_single</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Use</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">trained</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">this</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two-layer</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">network</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">label</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">point.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">We</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">scores</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">each</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">C</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">classes</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">assign</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">point</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">highest</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">score.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Inputs:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">A</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numpy</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">D</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">giving</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">D-dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">points</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">classify.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Returns:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">list</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">most</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probable</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predictions</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">their</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probabilities</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tuples.</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">X.dot(self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W1</span></span></span></span><span class="xml"><span class="hljs-tag">']) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">l1.dot(self.params[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">W2</span></span></span></span><span class="xml"><span class="hljs-tag">']) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self.params</span></span></span></span><span class="xml"><span class="hljs-tag">['</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b2</span></span></span></span><span class="xml"><span class="hljs-tag">'] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.exp(l2)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag"> / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.sum</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">exp_scores</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y_pred</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.argmax(exp_scores)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">list(zip(np.argsort(probs)[::-1][:3],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.round</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.argsort</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">)[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">::-1</span></span></span></span><span class="xml"><span class="hljs-tag">][</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:3</span></span></span></span><span class="xml"><span class="hljs-tag">]] * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">100</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">))) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3</span></span></span></span></span></span></code> </pre><br></div></div><br>         ,    ‚Äî       ,     learning rate. <br>  learning rate   .    0.1,   24  0.1 x (0.95 ^ 24).   ,        ‚Äî 800 .    ,        .         0.1 x (0.95 ^ 24) / 32.         ,        . <br><br><h2> CNN </h2><br>  ,   FNN      ,       CNN,    ,        CNN,     . <br><br>    CNN    cs231n     Tenforlow  MNIST,       . <br><br><img src="https://habrastorage.org/web/361/262/a38/361262a38ec9415b8a1a1c982f0f3b48.jpg"><br><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt plt.rcdefaults() <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> matplotlib.lines <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Line2D <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> matplotlib.patches <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Rectangle <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> matplotlib.collections <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PatchCollection #https://github.com/gwding/draw_convnet NumConvMax = <span class="hljs-number"><span class="hljs-number">8</span></span> NumFcMax = <span class="hljs-number"><span class="hljs-number">20</span></span> White = <span class="hljs-number"><span class="hljs-number">1.</span></span> Light = <span class="hljs-number"><span class="hljs-number">0.7</span></span> Medium = <span class="hljs-number"><span class="hljs-number">0.5</span></span> Dark = <span class="hljs-number"><span class="hljs-number">0.3</span></span> Black = <span class="hljs-number"><span class="hljs-number">0.</span></span> def add_layer(patches, colors, size=<span class="hljs-number"><span class="hljs-number">24</span></span>, num=<span class="hljs-number"><span class="hljs-number">5</span></span>, top_left=[<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], loc_diff=[<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>], ): # <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> a rectangle top_left = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(top_left) loc_diff = np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(loc_diff) loc_start = top_left - np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([<span class="hljs-number"><span class="hljs-number">0</span></span>, size]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(num): patches.append(Rectangle(loc_start + ind * loc_diff, size, size)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ind % <span class="hljs-number"><span class="hljs-number">2</span></span>: colors.append(Medium) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: colors.append(Light) def add_mapping(patches, colors, start_ratio, patch_size, ind_bgn, top_left_list, loc_diff_list, num_show_list, size_list): start_loc = top_left_list[ind_bgn] \ + (num_show_list[ind_bgn] - <span class="hljs-number"><span class="hljs-number">1</span></span>) * np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(loc_diff_list[ind_bgn]) \ + np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([start_ratio[<span class="hljs-number"><span class="hljs-number">0</span></span>] * size_list[ind_bgn], -start_ratio[<span class="hljs-number"><span class="hljs-number">1</span></span>] * size_list[ind_bgn]]) end_loc = top_left_list[ind_bgn + <span class="hljs-number"><span class="hljs-number">1</span></span>] \ + (num_show_list[ind_bgn + <span class="hljs-number"><span class="hljs-number">1</span></span>] - <span class="hljs-number"><span class="hljs-number">1</span></span>) \ * np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(loc_diff_list[ind_bgn + <span class="hljs-number"><span class="hljs-number">1</span></span>]) \ + np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>([(start_ratio[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-number"><span class="hljs-number">.5</span></span> * patch_size / size_list[ind_bgn]) * size_list[ind_bgn + <span class="hljs-number"><span class="hljs-number">1</span></span>], -(start_ratio[<span class="hljs-number"><span class="hljs-number">1</span></span>] - <span class="hljs-number"><span class="hljs-number">.5</span></span> * patch_size / size_list[ind_bgn]) * size_list[ind_bgn + <span class="hljs-number"><span class="hljs-number">1</span></span>]]) patches.append(Rectangle(start_loc, patch_size, patch_size)) colors.append(Dark) patches.append(Line2D([start_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>], end_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>]], [start_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>], end_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>]])) colors.append(Black) patches.append(Line2D([start_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>] + patch_size, end_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>]], [start_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>], end_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>]])) colors.append(Black) patches.append(Line2D([start_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>], end_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>]], [start_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>] + patch_size, end_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>]])) colors.append(Black) patches.append(Line2D([start_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>] + patch_size, end_loc[<span class="hljs-number"><span class="hljs-number">0</span></span>]], [start_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>] + patch_size, end_loc[<span class="hljs-number"><span class="hljs-number">1</span></span>]])) colors.append(Black) def label(xy, <span class="hljs-type"><span class="hljs-type">text</span></span>, xy_off=[<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>]): plt.text(xy[<span class="hljs-number"><span class="hljs-number">0</span></span>] + xy_off[<span class="hljs-number"><span class="hljs-number">0</span></span>], xy[<span class="hljs-number"><span class="hljs-number">1</span></span>] + xy_off[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-type"><span class="hljs-type">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">family</span></span>=<span class="hljs-string"><span class="hljs-string">'sans-serif'</span></span>, size=<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: fc_unit_size = <span class="hljs-number"><span class="hljs-number">2</span></span> layer_width = <span class="hljs-number"><span class="hljs-number">40</span></span> patches = [] colors = [] fig, ax = plt.subplots() ############################ # conv layers size_list = [<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>] num_list = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>] x_diff_list = [<span class="hljs-number"><span class="hljs-number">0</span></span>, layer_width, layer_width, layer_width, layer_width] text_list = [<span class="hljs-string"><span class="hljs-string">'Inputs'</span></span>] + [<span class="hljs-string"><span class="hljs-string">'Feature\nmaps'</span></span>] * (len(size_list) - <span class="hljs-number"><span class="hljs-number">1</span></span>) loc_diff_list = [[<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>]] * len(size_list) num_show_list = list(map(min, num_list, [NumConvMax] * len(num_list))) top_left_list = np.c_[np.cumsum(x_diff_list), np.zeros(len(x_diff_list))] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(size_list)): add_layer(patches, colors, size=size_list[ind], num=num_show_list[ind], top_left=top_left_list[ind], loc_diff=loc_diff_list[ind]) label(top_left_list[ind], text_list[ind] + <span class="hljs-string"><span class="hljs-string">'\n{}@{}x{}'</span></span>.format( num_list[ind], size_list[ind], size_list[ind])) ############################ # <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> layers start_ratio_list = [[<span class="hljs-number"><span class="hljs-number">0.4</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>], [<span class="hljs-number"><span class="hljs-number">0.4</span></span>, <span class="hljs-number"><span class="hljs-number">0.8</span></span>], [<span class="hljs-number"><span class="hljs-number">0.4</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>], [<span class="hljs-number"><span class="hljs-number">0.4</span></span>, <span class="hljs-number"><span class="hljs-number">0.8</span></span>]] patch_size_list = [<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] ind_bgn_list = range(len(patch_size_list)) text_list = [<span class="hljs-string"><span class="hljs-string">'Convolution'</span></span>, <span class="hljs-string"><span class="hljs-string">'Max-pooling'</span></span>, <span class="hljs-string"><span class="hljs-string">'Convolution'</span></span>, <span class="hljs-string"><span class="hljs-string">'Max-pooling'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(patch_size_list)): add_mapping(patches, colors, start_ratio_list[ind], patch_size_list[ind], ind, top_left_list, loc_diff_list, num_show_list, size_list) label(top_left_list[ind], text_list[ind] + <span class="hljs-string"><span class="hljs-string">'\n{}x{} kernel'</span></span>.format( patch_size_list[ind], patch_size_list[ind]), xy_off=[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">-65</span></span>]) ############################ # fully connected layers size_list = [fc_unit_size, fc_unit_size, fc_unit_size] num_list = [<span class="hljs-number"><span class="hljs-number">1568</span></span>, <span class="hljs-number"><span class="hljs-number">625</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>] num_show_list = list(map(min, num_list, [NumFcMax] * len(num_list))) x_diff_list = [sum(x_diff_list) + layer_width, layer_width, layer_width] top_left_list = np.c_[np.cumsum(x_diff_list), np.zeros(len(x_diff_list))] loc_diff_list = [[fc_unit_size, -fc_unit_size]] * len(top_left_list) text_list = [<span class="hljs-string"><span class="hljs-string">'Hidden\nunits'</span></span>] * (len(size_list) - <span class="hljs-number"><span class="hljs-number">1</span></span>) + [<span class="hljs-string"><span class="hljs-string">'Outputs'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(size_list)): add_layer(patches, colors, size=size_list[ind], num=num_show_list[ind], top_left=top_left_list[ind], loc_diff=loc_diff_list[ind]) label(top_left_list[ind], text_list[ind] + <span class="hljs-string"><span class="hljs-string">'\n{}'</span></span>.format( num_list[ind])) text_list = [<span class="hljs-string"><span class="hljs-string">'Flatten\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'Fully\nconnected'</span></span>, <span class="hljs-string"><span class="hljs-string">'Fully\nconnected'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(size_list)): label(top_left_list[ind], text_list[ind], xy_off=[<span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-number"><span class="hljs-number">-65</span></span>]) ############################ colors += [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>] collection = PatchCollection(patches, cmap=plt.cm.gray) collection.set_array(np.<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(colors)) ax.add_collection(collection) plt.tight_layout() plt.axis(<span class="hljs-string"><span class="hljs-string">'equal'</span></span>) plt.axis(<span class="hljs-string"><span class="hljs-string">'off'</span></span>) plt.<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>() fig.set_size_inches(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2.5</span></span>) fig_dir = <span class="hljs-string"><span class="hljs-string">'./'</span></span> fig_ext = <span class="hljs-string"><span class="hljs-string">'.png'</span></span> fig.savefig(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(fig_dir, <span class="hljs-string"><span class="hljs-string">'convnet_fig'</span></span> + fig_ext), bbox_inches=<span class="hljs-string"><span class="hljs-string">'tight'</span></span>, pad_inches=<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br></div></div><br>   Tensorflow,   ,    FNN  numpy. <br><br><div class="spoiler"> <b class="spoiler_title"> CNN</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf # Define architecture def model(X, w, w3, w4, w_o, p_keep_conv, p_keep_hidden): l1a = tf.nn.relu( tf.nn.conv2d( X, w, strides=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], padding=<span class="hljs-string"><span class="hljs-string">'SAME'</span></span> ) + b1 ) l1 = tf.nn.max_pool( l1a, ksize=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], strides=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], padding=<span class="hljs-string"><span class="hljs-string">'SAME'</span></span> ) l1 = tf.nn.dropout(l1, p_keep_conv) l3a = tf.nn.relu( tf.nn.conv2d( l1, w3, strides=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], padding=<span class="hljs-string"><span class="hljs-string">'SAME'</span></span> ) + b3 ) l3 = tf.nn.max_pool( l3a, ksize=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], strides=[<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], padding=<span class="hljs-string"><span class="hljs-string">'SAME'</span></span> ) # Reshaping <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dense layer l3 = tf.reshape(l3, [<span class="hljs-number"><span class="hljs-number">-1</span></span>, w4.get_shape().as_list()[<span class="hljs-number"><span class="hljs-number">0</span></span>]]) l3 = tf.nn.dropout(l3, p_keep_conv) l4 = tf.nn.relu(tf.matmul(l3, w4) + b4) l4 = tf.nn.dropout(l4, p_keep_hidden) pyx = tf.matmul(l4, w_o) + b5 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pyx tf.reset_default_graph() # Define variables init_op = tf.global_variables_initializer() X = tf.placeholder("float", [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>]) Y = tf.placeholder("float", [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>]) w = tf.get_variable("w", shape=[<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>], initializer=tf.contrib.layers.xavier_initializer()) b1 = tf.get_variable(<span class="hljs-type"><span class="hljs-type">name</span></span>="b1", shape=[<span class="hljs-number"><span class="hljs-number">16</span></span>], initializer=tf.zeros_initializer()) w3 = tf.get_variable("w3", shape=[<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>], initializer=tf.contrib.layers.xavier_initializer()) b3 = tf.get_variable(<span class="hljs-type"><span class="hljs-type">name</span></span>="b3", shape=[<span class="hljs-number"><span class="hljs-number">32</span></span>], initializer=tf.zeros_initializer()) w4 = tf.get_variable("w4", shape=[<span class="hljs-number"><span class="hljs-number">32</span></span> * <span class="hljs-number"><span class="hljs-number">7</span></span> * <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">625</span></span>], initializer=tf.contrib.layers.xavier_initializer()) b4 = tf.get_variable(<span class="hljs-type"><span class="hljs-type">name</span></span>="b4", shape=[<span class="hljs-number"><span class="hljs-number">625</span></span>], initializer=tf.zeros_initializer()) w_o = tf.get_variable("w_o", shape=[<span class="hljs-number"><span class="hljs-number">625</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>], initializer=tf.contrib.layers.xavier_initializer()) b5 = tf.get_variable(<span class="hljs-type"><span class="hljs-type">name</span></span>="b5", shape=[<span class="hljs-number"><span class="hljs-number">10</span></span>], initializer=tf.zeros_initializer()) # Dropout rate p_keep_conv = tf.placeholder("float") p_keep_hidden = tf.placeholder("float") py_x = model(X, w, w3, w4, w_o, p_keep_conv, p_keep_hidden) reg_losses = tf.get_collection(tf.GraphKeys.REGULARIZATION_LOSSES) reg_constant = <span class="hljs-number"><span class="hljs-number">0.01</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=py_x, labels=Y) + reg_constant * sum(reg_losses)) train_op = tf.train.RMSPropOptimizer(<span class="hljs-number"><span class="hljs-number">0.0001</span></span>, <span class="hljs-number"><span class="hljs-number">0.9</span></span>).minimize(<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>) predict_op = tf.argmax(py_x, <span class="hljs-number"><span class="hljs-number">1</span></span>) #Training train_acc = [] val_acc = [] test_acc = [] train_loss = [] val_loss = [] test_loss = [] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tf.<span class="hljs-keyword"><span class="hljs-keyword">Session</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sess: tf.global_variables_initializer().run() # Training iterations <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">256</span></span>): # Mini-batch training_batch = zip(range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(trX), batch_size), range(batch_size, len(trX)+<span class="hljs-number"><span class="hljs-number">1</span></span>, batch_size)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> training_batch: sess.run(train_op, feed_dict={X: trX[<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>], Y: trY[<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>], p_keep_conv: <span class="hljs-number"><span class="hljs-number">0.8</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">0.5</span></span>}) # Comparing labels <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> predicted <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> train_acc = np.mean(np.argmax(trY, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) == sess.run(predict_op, feed_dict={X: trX, Y: trY, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>})) train_acc.append(train_acc) val_acc = np.mean(np.argmax(teY, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) == sess.run(predict_op, feed_dict={X: teX, Y: teY, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>})) val_acc.append(val_acc) test_acc = np.mean(np.argmax(mnist.test.labels, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) == sess.run(predict_op, feed_dict={X: mnist_test_images, Y: mnist.test.labels, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>})) test_acc.append(test_acc) print(<span class="hljs-string"><span class="hljs-string">'Step {0}. Train accuracy: {3}. Validation accuracy: {1}. \ Test accuracy: {2}.'</span></span>.format(i, val_acc, test_acc, train_acc)) _, loss_train = sess.run([predict_op, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>], feed_dict={X: trX, Y: trY, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>}) train_loss.append(loss_train) _, loss_val = sess.run([predict_op, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>], feed_dict={X: teX, Y: teY, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>}) val_loss.append(loss_val) _, loss_test = sess.run([predict_op, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>], feed_dict={X: mnist_test_images, Y: mnist.test.labels, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>}) test_loss.append(loss_test) print(<span class="hljs-string"><span class="hljs-string">'Train loss: {0}. Validation loss: {1}. \ Test loss: {2}.'</span></span>.format(loss_train, loss_val, loss_test)) # Saving model all_saver = tf.train.Saver() all_saver.save(sess, <span class="hljs-string"><span class="hljs-string">'/resources/data.chkp'</span></span>) #Predicting <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tf.<span class="hljs-keyword"><span class="hljs-keyword">Session</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sess: # Restoring model saver = tf.train.Saver() saver.restore(sess, "./data.chkp") # Prediction pr = sess.run(predict_op, feed_dict={X: mnist_test_images, Y: mnist.test.labels, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>}) print(np.mean(np.argmax(mnist.test.labels, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) == sess.run(predict_op, feed_dict={X: mnist_test_images, Y: mnist.test.labels, p_keep_conv: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, p_keep_hidden: <span class="hljs-number"><span class="hljs-number">1.0</span></span>})))</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  CNN</b> <div class="spoiler_text"> CNN     FNN   ,           .   CNN     ‚Äî      ,   -   . <br><br>    .      (   N x 28 x 28 x 1),  ¬´¬ª          (   ),    .          .        .             .    :       . ,     RGB. <a href="https://www.researchgate.net/figure/309487032_fig2_Figure-2-a-Illustration-of-the-operation-principle-of-the-convolution-kernel"></a>      . <br><br><img src="https://habrastorage.org/web/d09/64e/0a8/d0964e0a811d43a08e851a038f3b0e35.jpg" height="60%"><br><br>      ,   ,      1,         .       zero-padding,   0    ,           .      : <br><br><ul><li>  ,      ,     ; </li><li>     ,       ; </li><li>         ,      ; </li><li>     ,      ,    ,   zero-padding   ,     ; </li></ul><br>     max pooling (  ,  max  ).       ,      .    :      ,         .   <a href="http://cs231n.github.io/convolutional-networks/"></a> cs231n. <br><br><img src="https://habrastorage.org/web/668/3f1/aa8/6683f1aa80754cd4ac2a4c5341b721a7.jpeg" height="60%"><br><br> Max pooling     ( 2  2)      .         .         ;     2. <br>               .        .  ,     ,       . <br><br>  ,     . <br>     N x 28 x 28 x 1.     4  4  16,   zero-padding ( <code>padding='SAME'</code>  Tensorflow)    ,    N x 28 x 28 x 16.   max pooling 2  2   2,   N x 14 x 14 x 16.      4  4  32  zero-padding,   N x 14 x 14 x 32.  max pooling (      )  N x 7 x 7 x 32.     .        32 * 7 * 7  625  1568  625,   N  625.      625  10      10 . <br><br> ,        . ,    ¬´¬ª       . <br></div></div><br>    : <br><br><ul><li>     ,       ; </li><li>     :         ; </li><li> X, y   dropout   ; </li><li> Cost   softmax_cross_entropy_with_logits   L2; </li><li>  ‚Äî RMSPropOptimizer; </li><li>      (256),          ; </li><li>          dropout 0.2  convolutional   0.5  .        ,   ¬´¬ª (MNIST) ; </li><li>       ,        /. ,         ,   ,   ; </li></ul><br>  MNIST  TF    : <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">from</span></span> tensorflow.examples.tutorials.mnist <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> input_data mnist = input_data.read_data_sets('<span class="hljs-type"><span class="hljs-type">MNIST_data</span></span>', <span class="hljs-title"><span class="hljs-title">one_hot</span></span>=<span class="hljs-type"><span class="hljs-type">True</span></span>) mnist_test_images = mnist.test.images.reshape(-1, 28, 28, 1)</code> </pre><br>      ,    FNN,     - ,       : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">trX</span></span> = X_train.reshape(-<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment"># 28x28x1 teX = X_val.reshape(-1, 28, 28, 1) enc = OneHotEncoder() enc.fit(y.reshape(-1, 1), 10).toarray() # 10x1 trY = enc.fit_transform(y_train.reshape(-1, 1)).toarray() teY = enc.fit_transform(y_val.reshape(-1, 1)).toarray()</span></span></code> </pre><br><h2>     </h2><br>  CNN      FNN,    -. - ,  CNN  ,     .      ,  : <br><br><img src="https://habrastorage.org/web/8a2/45b/fa3/8a245bfa3d1242d3be2cc02b19dfb391.jpg"><br><br>     : <br><br><img src="https://habrastorage.org/web/86b/b23/0f9/86bb230f958c4765b094ce236cef517a.jpg"><br><br> ,       ,        ~100 . <br><br><h2>  </h2><br>      CNN    ,     FNN:    , 1 ,    -3    . <br><br><div class="spoiler"> <b class="spoiler_title">  CNN</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">import numpy as np import boto import boto3 from boto.s3.key import Key from boto.s3.connection import S3Connection import tensorflow as tf import os class CNN(object): """ Convolutional neural network with several levels. The architecture is the following: input - conv - relu - pool - dropout - conv - relu - pool - dropout - fully connected layer - dropout - fully connected layer The outputs of the second fully-connected layer are the scores for each class. """ def __init__(self): """ Initialize the model. Weights are passed into the class. """ self.params = {} def train(self, image, digit): """ Train this neural network. 1 step of gradient descent. Inputs: - X: A numpy array of shape (N, 784) giving training data. - y: A numpy array f shape (N,) giving training labels; y[i] = c means that X[i] has label c, where 0 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">c</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">C.</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.reset_default_graph</span></span></span></span><span class="xml"><span class="hljs-tag">() </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">init_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.global_variables_initializer()</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">", [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">None</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Y</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">", [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">None</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b1"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[16],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">32</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b3"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[32],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[32</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">625</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b4"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[625],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[625,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b5</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b5"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[10],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">") </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">") </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1a</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.conv2d</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.max_pool(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1a</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ksize</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3a</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.conv2d</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b3</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.max_pool(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3a</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ksize</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag">) #</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Reshape</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">matmul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.reshape(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4.get_shape</span></span></span></span><span class="xml"><span class="hljs-tag">()</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.as_list</span></span></span></span><span class="xml"><span class="hljs-tag">()[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">]]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(tf.matmul(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b4</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">py_x</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.matmul(l4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b5</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Cost</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">L2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_losses</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_collection(tf.GraphKeys.REGULARIZATION_LOSSES)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_constant</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0.01</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cost</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.reduce_mean(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.softmax_cross_entropy_with_logits</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">logits</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">py_x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">labels</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Y)</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_constant</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sum</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_losses</span></span></span></span><span class="xml"><span class="hljs-tag">) ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">train_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.train.RMSPropOptimizer(0.00001).minimize(cost)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.argmax(py_x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.Session</span></span></span></span><span class="xml"><span class="hljs-tag">() </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess:</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Load</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">saver</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.train.Saver()</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">saver.restore</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data-all_2_updated.chkp</span></span></span></span><span class="xml"><span class="hljs-tag">") </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">trX</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">image.reshape(-1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">trY</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">np.eye(10)[digit]</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess.run</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">train_op</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">feed_dict</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{X:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">trX</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Y:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">trY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">}) # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Save</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">updated</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">all_saver</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.train.Saver()</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">all_saver.save</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess</span></span></span></span><span class="xml"><span class="hljs-tag">, '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data-all_2_updated.chkp</span></span></span></span><span class="xml"><span class="hljs-tag">') </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">def</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">self</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">image</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'original'</span></span></span></span><span class="xml"><span class="hljs-tag">)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Generate</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">prediction</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">one</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">or</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">several</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">digits.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Weights</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">are</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">downloaded</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">from</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Amazon.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Returns:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">list</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">most</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probable</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predictions</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">their</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probabilities</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">as</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tuples.</span></span></span></span><span class="xml"><span class="hljs-tag"> """ </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">boto3.client(</span></span></span></span><span class="xml"><span class="hljs-tag"> '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s3</span></span></span></span><span class="xml"><span class="hljs-tag">', </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aws_access_key_id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">os.environ[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">AWS_ACCESS_KEY_ID</span></span></span></span><span class="xml"><span class="hljs-tag">'], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aws_secret_access_key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">os.environ[</span></span></span></span><span class="xml"><span class="hljs-tag">'</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">AWS_SECRET_ACCESS_KEY</span></span></span></span><span class="xml"><span class="hljs-tag">'] ) # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Choose</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">load</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">weights</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'original'</span></span></span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'data-all_2.chkp'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">else:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'data-all_2_updated.chkp'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">f</span></span></span></span><span class="xml"><span class="hljs-tag"> + '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.meta</span></span></span></span><span class="xml"><span class="hljs-tag">' </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s3.download_file</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">digit_draw_recognize</span></span></span></span><span class="xml"><span class="hljs-tag">',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">os.path.join</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">f</span></span></span></span><span class="xml"><span class="hljs-tag"> + '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.index</span></span></span></span><span class="xml"><span class="hljs-tag">' </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s3.download_file</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">digit_draw_recognize</span></span></span></span><span class="xml"><span class="hljs-tag">',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">os.path.join</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">f</span></span></span></span><span class="xml"><span class="hljs-tag"> + '</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.data-00000-of-00001</span></span></span></span><span class="xml"><span class="hljs-tag">' </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s3.download_file</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">digit_draw_recognize</span></span></span></span><span class="xml"><span class="hljs-tag">',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">os.path.join</span></span></span></span><span class="xml"><span class="hljs-tag">('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/',</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">fn</span></span></span></span><span class="xml"><span class="hljs-tag">)) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.reset_default_graph</span></span></span></span><span class="xml"><span class="hljs-tag">() </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">init_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.global_variables_initializer()</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.Session()</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Define</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">architecture</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">", [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">None</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Y</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">", [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">None</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b1"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[16],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">4</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">32</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b3"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[32],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[32</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">7</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">625</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[625,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">10</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.contrib.layers.xavier_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b4"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[625],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">") </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.placeholder(</span></span></span></span><span class="xml"><span class="hljs-tag">"</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">float</span></span></span></span><span class="xml"><span class="hljs-tag">") </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b5</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_variable(name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b5"</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">shape</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[10],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">initializer</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.zeros_initializer())</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1a</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.conv2d</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">X</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b1</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.max_pool(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1a</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ksize</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3a</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.conv2d</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag"> ) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b3</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.max_pool(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3a</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ksize</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">strides</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">[1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">padding</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'SAME'</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.reshape(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4.get_shape</span></span></span></span><span class="xml"><span class="hljs-tag">()</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.as_list</span></span></span></span><span class="xml"><span class="hljs-tag">()[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">]]) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.relu(tf.matmul(l3,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w4</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b4</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">l4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.dropout(l4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">py_x</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.matmul(l4,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">w_o</span></span></span></span><span class="xml"><span class="hljs-tag">) + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">b5</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Cost</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">L2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_losses</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.get_collection(tf.GraphKeys.REGULARIZATION_LOSSES)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_constant</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0.01</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cost</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.reduce_mean(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tf.nn.softmax_cross_entropy_with_logits</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">logits</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">py_x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">labels</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">Y)</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_constant</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sum</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">reg_losses</span></span></span></span><span class="xml"><span class="hljs-tag">) ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">train_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.train.RMSPropOptimizer(0.00001).minimize(cost)</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict_op</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.argmax(py_x,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.nn.softmax(py_x)</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Load</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predict</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">saver</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tf.train.Saver()</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">saver.restore</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tmp</span></span></span></span><span class="xml"><span class="hljs-tag">/" + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">f</span></span></span></span><span class="xml"><span class="hljs-tag">) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">y_pred</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">sess.run(probs,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">feed_dict</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{X:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">image.reshape</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_conv:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p_keep_hidden:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1.0</span></span></span></span><span class="xml"><span class="hljs-tag">}) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">y_pred</span></span></span></span><span class="xml"><span class="hljs-tag"> # </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">list</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">with</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">predictions</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">their</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probabilities</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">list(zip(np.argsort(probs)[0][::-1][:3],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.round</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">][</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">np.argsort</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">probs</span></span></span></span><span class="xml"><span class="hljs-tag">)[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">][</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">::-1</span></span></span></span><span class="xml"><span class="hljs-tag">][</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:3</span></span></span></span><span class="xml"><span class="hljs-tag">]] * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">100</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">))) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sess.close</span></span></span></span><span class="xml"><span class="hljs-tag">() </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">top_3</span></span></span></span></span></span></code> </pre><br></div></div><br>        learning rate.      0.00001,   100    . ,      . ,        . <br><br><h2>     </h2><br>       (      ). -,    ,       <a href="https://startbootstrap.com/template-overviews/small-business/"></a> bootstrap.    :    html     css, js  .  ,        ,    . <br><br>       .     : <br><br><img src="https://habrastorage.org/web/c65/28d/9f5/c6528d9f52f445588cb9d46e86d28aef.jpg"><br><br>  <strong>main.py</strong>  ,   <strong>functions.py</strong>   . <br><br><div class="spoiler"> <b class="spoiler_title">functions.py</b> <div class="spoiler_text"><pre> <code class="hljs python">__author__ = <span class="hljs-string"><span class="hljs-string">'Artgor'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> base64 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> boto.s3.key <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Key <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> boto.s3.connection <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> S3Connection <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> codecs <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> open <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy.ndimage.interpolation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rotate, shift <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> skimage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> transform <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> two_layer_net <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FNN <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> conv_net <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CNN <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Load weights for FNN here. Original weights are loaded from local folder, updated - from Amazon. """</span></span> self.params_original = np.load(<span class="hljs-string"><span class="hljs-string">'models/original_weights.npy'</span></span>)[()] self.params = self.load_weights_amazon(<span class="hljs-string"><span class="hljs-string">'updated_weights.npy'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, image)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Processing image for prediction. Saving in temproral folder so that it could be opened by PIL. Cropping and scaling so that the longest side it 20. Then putting it in a center of 28x28 blank image. Returning array of normalized data. """</span></span> filename = <span class="hljs-string"><span class="hljs-string">'digit'</span></span> + <span class="hljs-string"><span class="hljs-string">'__'</span></span> + str(uuid.uuid1()) + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(image) img = Image.open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) bbox = Image.eval(img, <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> px: <span class="hljs-number"><span class="hljs-number">255</span></span>-px).getbbox() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bbox == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> widthlen = bbox[<span class="hljs-number"><span class="hljs-number">2</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">0</span></span>] heightlen = bbox[<span class="hljs-number"><span class="hljs-number">3</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> heightlen &gt; widthlen: widthlen = int(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) heightlen = <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: heightlen = int(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) widthlen = <span class="hljs-number"><span class="hljs-number">20</span></span> hstart = int((<span class="hljs-number"><span class="hljs-number">28</span></span> - heightlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) wstart = int((<span class="hljs-number"><span class="hljs-number">28</span></span> - widthlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) img_temp = img.crop(bbox).resize((widthlen, heightlen), Image.NEAREST) new_img = Image.new(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">28</span></span>), <span class="hljs-number"><span class="hljs-number">255</span></span>) new_img.paste(img_temp, (wstart, hstart)) imgdata = list(new_img.getdata()) img_array = np.array([(<span class="hljs-number"><span class="hljs-number">255.0</span></span> - x) / <span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> imgdata]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> img_array <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">augment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, image, label)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Augmenting image for training. Saving in temporal folder so that it could be opened by PIL. Cropping and scaling so that the longest side it 20. The width and height of the scaled image are used to resize it again so that there would be 4 images with different combinations of weight and height. Then putting it in a center of 28x28 blank image. 12 possible angles are defined and each image is randomly rotated by 6 of these angles. Images converted to arrays and normalized. Returning these arrays and labels. """</span></span> filename = <span class="hljs-string"><span class="hljs-string">'digit'</span></span> + <span class="hljs-string"><span class="hljs-string">'__'</span></span> + str(uuid.uuid1()) + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(image) image = Image.open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) ims_add = [] labs_add = [] angles = np.arange(<span class="hljs-number"><span class="hljs-number">-30</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) bbox = Image.eval(image, <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> px: <span class="hljs-number"><span class="hljs-number">255</span></span>-px).getbbox() widthlen = bbox[<span class="hljs-number"><span class="hljs-number">2</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">0</span></span>] heightlen = bbox[<span class="hljs-number"><span class="hljs-number">3</span></span>] - bbox[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> heightlen &gt; widthlen: widthlen = int(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) heightlen = <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: heightlen = int(<span class="hljs-number"><span class="hljs-number">20.0</span></span> * widthlen/heightlen) widthlen = <span class="hljs-number"><span class="hljs-number">20</span></span> hstart = int((<span class="hljs-number"><span class="hljs-number">28</span></span> - heightlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) wstart = int((<span class="hljs-number"><span class="hljs-number">28</span></span> - widthlen) / <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [min(widthlen, heightlen), max(widthlen, heightlen)]: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [min(widthlen, heightlen), max(widthlen, heightlen)]: resized_img = image.crop(bbox).resize((i, j), Image.NEAREST) resized_image = Image.new(<span class="hljs-string"><span class="hljs-string">'L'</span></span>, (<span class="hljs-number"><span class="hljs-number">28</span></span>,<span class="hljs-number"><span class="hljs-number">28</span></span>), <span class="hljs-number"><span class="hljs-number">255</span></span>) resized_image.paste(resized_img, (wstart, hstart)) angles_ = random.sample(set(angles), <span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> angle <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> angles_: transformed_image = transform.rotate(np.array(resized_image), angle, cval=<span class="hljs-number"><span class="hljs-number">255</span></span>, preserve_range=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>).astype(np.uint8) labs_add.append(int(label)) img_temp = Image.fromarray(np.uint8(transformed_image)) imgdata = list(img_temp.getdata()) normalized_img = [(<span class="hljs-number"><span class="hljs-number">255.0</span></span> - x) / <span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> imgdata] ims_add.append(normalized_img) image_array = np.array(ims_add) label_array = np.array(labs_add) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image_array, label_array <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_weights_amazon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, filename)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Load weights from Amazon. This is npy. file, which needs to be read with np.load. """</span></span> s3 = boto3.client( <span class="hljs-string"><span class="hljs-string">'s3'</span></span>, aws_access_key_id=os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_ACCESS_KEY_ID'</span></span>], aws_secret_access_key=os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_SECRET_ACCESS_KEY'</span></span>] ) s3.download_file(<span class="hljs-string"><span class="hljs-string">'digit_draw_recognize'</span></span>, filename, os.path.join(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span>, filename)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> np.load(os.path.join(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span>, filename))[()] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_weights_amazon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, filename, file)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Save weights to Amazon. """</span></span> REGION_HOST = <span class="hljs-string"><span class="hljs-string">'s3-external-1.amazonaws.com'</span></span> conn = S3Connection(os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_ACCESS_KEY_ID'</span></span>], os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_SECRET_ACCESS_KEY'</span></span>], host=REGION_HOST) bucket = conn.get_bucket(<span class="hljs-string"><span class="hljs-string">'digit_draw_recognize'</span></span>) k = Key(bucket) k.key = filename k.set_contents_from_filename(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">'Weights saved'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, drawn_digit, image)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Save image on Amazon. Only existing files can be uploaded, so the image is saved in a temporary folder. """</span></span> filename = <span class="hljs-string"><span class="hljs-string">'digit'</span></span> + str(drawn_digit) + <span class="hljs-string"><span class="hljs-string">'__'</span></span> + \ str(uuid.uuid1()) + <span class="hljs-string"><span class="hljs-string">'.jpg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(image) REGION_HOST = <span class="hljs-string"><span class="hljs-string">'s3-external-1.amazonaws.com'</span></span> conn = S3Connection(os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_ACCESS_KEY_ID'</span></span>], os.environ[<span class="hljs-string"><span class="hljs-string">'AWS_SECRET_ACCESS_KEY'</span></span>], host=REGION_HOST) bucket = conn.get_bucket(<span class="hljs-string"><span class="hljs-string">'digit_draw_recognize'</span></span>) k = Key(bucket) k.key = filename k.set_contents_from_filename(<span class="hljs-string"><span class="hljs-string">'tmp/'</span></span> + filename) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">'Image saved successfully with the \ name {0}'</span></span>.format(filename)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">predict</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, image)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Predicting image. If nothing is drawn, returns a message; otherwise 4 models are initialized and they make predictions. They return a list of tuples with 3 top predictions and their probabilities. These lists are sent to "select_answer" method to select the best answer. Also tuples are converted into strings for easier processing in JS. The answer and lists with predictions and probabilities are returned. """</span></span> img_array = self.process_image(image) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> img_array <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Can't predict, when nothing is drawn"</span></span> net = FNN(self.params) net_original = FNN(self.params_original) cnn = CNN() cnn_original = CNN() top_3 = net.predict_single(img_array) top_3_original = net_original.predict_single(img_array) top_3_cnn = cnn.predict(img_array, weights=<span class="hljs-string"><span class="hljs-string">'updated'</span></span>) top_3_cnn_original = cnn_original.predict(img_array, weights=<span class="hljs-string"><span class="hljs-string">'original'</span></span>) answer, top_3, top_3_original, top_3_cnn, top_3_cnn_original = self.select_answer(top_3, top_3_original, top_3_cnn, top_3_cnn_original) answers_dict = {<span class="hljs-string"><span class="hljs-string">'answer'</span></span>: str(answer), <span class="hljs-string"><span class="hljs-string">'fnn_t'</span></span>: top_3, <span class="hljs-string"><span class="hljs-string">'fnn'</span></span>: top_3_original, <span class="hljs-string"><span class="hljs-string">'cnn_t'</span></span>: top_3_cnn, <span class="hljs-string"><span class="hljs-string">'cnn'</span></span>: top_3_cnn_original} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> answers_dict <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">train</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, image, digit)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Models are trained. Weights on Amazon are updated. """</span></span> r = self.save_image(digit, image) print(r) <span class="hljs-comment"><span class="hljs-comment"># Start models and train them net = FNN(self.params) X, y = self.augment(image, digit) net.train(X, y) cnn = CNN() cnn.train(X, y) # Save updated weights. np.save('tmp/updated_weights.npy', net.params) response = self.save_weights_amazon( 'updated_weights.npy', './tmp/updated_weights.npy' ) response = self.save_weights_amazon( 'data-all_2_updated.chkp.meta', './tmp/data-all_2_updated.chkp' ) response = self.save_weights_amazon( 'data-all_2_updated.chkp.index', './tmp/data-all_2_updated.chkp' ) response = self.save_weights_amazon( 'data-all_2_updated.chkp.data-00000-of-00001', './tmp/data-all_2_updated.chkp' ) return response def select_answer(self,top_3,top_3_original,top_3_cnn,top_3_cnn_original): """ Selects best answer from all. In fact only from the trained models, as they are considered to be better than untrained. """ answer = '' # If answers are the same, show this answer. if int(top_3[0][0]) == int(top_3_cnn[0][0]): answer = str(top_3[0][0]) # If answers' probabilities are low, show fail message. elif int(top_3[0][1]) &lt; 50 and int(top_3_cnn[0][1]) &lt; 50: answer = "Can't recognize this as a digit" # Otherwise show answer with highest probability elif int(top_3[0][0]) != int(top_3_cnn[0][0]): if int(top_3[0][1]) &gt; int(top_3_cnn[0][1]): answer = str(top_3[0][0]) else: answer = str(top_3_cnn[0][0]) top_3 = ['{0} ({1})%'.format(i[0], i[1]) for i in top_3] top_3_original = ['{0} ({1})%'.format(i[0], i[1] for i in top_3_original] top_3_cnn = ['{} ({:2.4})%'.format(i[0], i[1]) for i in top_3_cnn] top_3_cnn_original = ['{} ({:2.4})%'.format(i[0], i[1]) for i in top_3_cnn_original] return answer, top_3, top_3_original, top_3_cnn, top_3_cnn_original</span></span></code> </pre><br></div></div><br>       ¬´¬ª ,      .  FNN   ‚Äî      ,   <code>init</code>       ,   . <br><br>    ,      tmp    (        ,       ).      ,      Amazon.  ,   <strong>load_weights_amazon</strong> <br><br>      Amazon     :   ,      (  , ,   <code>os.environ['AWS_ACCESS_KEY_ID']</code> ,  ,    : <code>aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID']</code> ).       bucket  ,      . <br><br>  Tensorflow        ,      .       ,    Tensorflow  . <br><br>         JS  Python     <code>predict</code> . ,     ‚Äî     ,  .  ,    ,       .        JS,   ,    . <br><br>     4 .   FNN  ,      . <br><br>  CNN        ,    ‚Äî   .       . <br><br>   4    .    ?      <code>select_answer</code> .      FNN  CNN:   ,      ;         50%,   ,    ; ,   ,   ,        (  ).  ,      (  )    ,     JS.       JS. <br><br> JS      ,        ‚Äî  . <br><br>     : <br><br><ul><li>      (    )   Python; </li><li>   (  )      ,     ; </li><li>      train,   1     ; </li><li>    ; </li></ul><br>      .    : <br><br><ul><li>  canvas ‚Äî  ,    ; </li><li>  ¬´Predict¬ª ‚Äî       ,           ,       ; </li><li>  ¬´Allow to use the drawn digit for model training¬ª ‚Äî        ,    .  /     ; </li><li>  ¬´Yes¬ª ‚Äî         ,         (   ); </li><li>  ¬´No¬ª ‚Äî         ,             (   ); </li><li>  ¬´Clear¬ª ‚Äî    canvas     ; </li><li>   /    ; </li></ul><br>  <a href=""></a> JS          /   :   <code>document.getElementById().style.display</code>   ¬´none¬ª  ¬´block¬ª. <br><br><h2>  Preparing for launch </h2><br>         ,    ,   ,  . <br><br><ol><li>    .          ,           ,    -   .  bootstrap      ,     .          ,   .     <a href="https://developer.mozilla.org/en-US/docs/Web/API/Touch_events"></a>    mozilla     .    ,    : ontouchstart, ontouchmove, ontouchend.         ,  ,   ; </li><li>   -     .    MNIST  ,            ,    .         ‚Ä¶  ,    Heroku        ,           ,     ; </li><li>       :  ,    .    :        CNN       .       ‚Ä¶   ,       . ,      ,        ,      .             . </li><li> ,      :      ,         .      ,       .    : <code>Models</code> .      Flask.     python         ,     ; </li></ol><br><h1>   </h1><br> 23   ¬´ ¬ª        .    .          ,        ,    ( ).              ,      ,          ,    ,   ¬´ ¬ª.     . <br><br>           ‚Äî  .   2 :     ,     ;     mozilla        .    ,     , ,      . <br>     ‚Äî    ,      /  (  ,   ,  ), ,    ¬´¬ª . <br><br>     :    .  ,        ,    2,5      (  ,     ).     ‚Ä¶    : <br><br><img src="https://habrastorage.org/web/1e0/a4b/15e/1e0a4b15ed9a4984929786d6ef069fe1.jpg"><br><br>           . <br><br><h2>     </h2><br>   ~  ,     (    slack ODS)      .        ,    ,        . <br><br><ul><li>      ¬´-¬ª.    ,     ,     .    ‚Äî  -   google quickdraw   ,     .   ‚Äî  SVM         . ,    ,   ‚Äî   ( ),       ; </li><li>  .      :            -; </li><li>     ‚Äî        ; </li><li>    / ; </li><li> /        .      ,      ¬´Yes¬ª  ¬´No¬ª; </li><li>      PC     ‚Äî         ,    ; </li></ul><br><h2>  Conclusion </h2><br>       .       .            .     .      . ,   ,      data science   ,          . </div><p>Source: <a href="https://habr.com/ru/post/335998/">https://habr.com/ru/post/335998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335986/index.html">One secure password for all occasions</a></li>
<li><a href="../335988/index.html">Replace and Conquer - the SOLID approach to developing reusable components on the web</a></li>
<li><a href="../335990/index.html">The digest of interesting materials for the mobile developer # 217 (August 14 - August 20)</a></li>
<li><a href="../335992/index.html">Edge hates your attributes</a></li>
<li><a href="../335994/index.html">Blockchain</a></li>
<li><a href="../336000/index.html">Myriads of running C # tasks</a></li>
<li><a href="../336002/index.html">How to complete the first project</a></li>
<li><a href="../336006/index.html">Liscript - web REPL: kisses, bikes and excavators</a></li>
<li><a href="../336010/index.html">React Native: from simple animation to interactive at 60 FPS</a></li>
<li><a href="../336012/index.html">Support for system errors in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>