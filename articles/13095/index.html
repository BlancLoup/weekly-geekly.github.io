<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hardened Gentoo: Installation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The installation of Hardened Gentoo (more precisely, the upgrade of the current Gentoo system in Hardened) looks like this: 



1. switch to hardened ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hardened Gentoo: Installation</h1><div class="post__text post__text-html js-mediator-article">  The installation of Hardened Gentoo (more precisely, the upgrade of the current Gentoo system in Hardened) looks like this: <br><a name="habracut"></a><br><ol><li>  switch to hardened toolchain and rebuild the whole system with it so that all binaries use PIE and SSP (after that the system becomes protected by SSP) </li><li>  install hardened-sources (they contain PaX + GrSecurity + SeLinux + additional patches from Gentoo) and compile them with support for PaX, GrSecurity and GrSecurity / RBAC </li><li>  we are overloaded with the new kernel (after that, the system is also protected by PaX + PIE and GrSecurity) </li><li>  for some time we set up and debug access restrictions (after which the system is also protected by GrSecurity / RBAC) </li></ol><br>  Expected problems: <br><ul><li>  not everything can be compiled with PIE + SSP - perhaps separate packages will need to be patched or compiled without one or both of them (I still needed to switch to vanilla gcc via gcc-config only to compile the X's so that they work with ATI firewood) </li><li>  not everything can work normally, because  some programs (usually mentioning X's and java) use the execution of dynamically generated code for completely legal purposes, and now when they try to do this they will be stitched with either SSP or PIE + PaX - for these programs you will need to individually disable some of the PaX protections (for this there are special utilities, for example paxctl) and / or compile them without SSP </li><li>  not everything can work due to the limitations of the ‚Äúfeatures‚Äù of the GrSecurity core - in this case, you will need to disable some of the GrSecurity protection (globally, in make menuconfig) </li><li>  setting access restrictions may not be easy, and at any time when a thread of the prog does something that we did not take into account when setting up its rights - it will be nailed by the kernel ... and these rules will have to be fixed as a matter of urgency </li></ul><br>  Here we go‚Ä¶ :) <br><br>  Too strong optimization (-O3) together with hardened toolchain can lead to different glitches and compilation failures, so you need to replace -O3 with -O2 in /etc/make.conf and remove all other -f * optimizer flags. <br><br>  Go to hardened profile.  (Theoretically, instead, one could simply add to the USE flags: ‚Äúhardened pie ssp‚Äù.) <br><pre><code class="bash hljs">ln -snf ../usr/portage/profiles/hardened/x86/2.6/ /etc/make.profile</code> </pre> <br>  After switching the profile to hardened / x86 / 2.6 /, several USE flags I needed turned off, which are automatically enabled in regular profiles - I added them to make.conf (you may have other flags, just remember to track this point): <br><pre> <code class="bash hljs">avi encode gtk2 jpeg mpeg oss quicktime spell truetype xv bitmap-fonts truetype-fonts type1-fonts</code> </pre><br>  Compiling hardened-toolchain and rebuilding it for all other packages: <br><pre> <code class="bash hljs">emerge binutils gcc glibc emerge -e world dispatch-conf</code> </pre><br>  Next, you need to put some more packages: <br><pre> <code class="bash hljs">emerge paxtest paxctl gradm</code> </pre><br>  paxtest could have been put before, before switching to hardened toolchain.  This utility tries to do various dangerous operations (such as stack overflow with code execution), which are usually performed by exploits.  If the system is protected, then all its attempts will be stopped, as it will inform.  In general, you can drive it before installing the hardened toolchain, after as well after rebooting with the kernel where PaX is enabled, for fun.  :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      paxtest as its dependency will also install the prog chpax - this is the old way to manage PaX, instead of which it is better to use paxctl.  But some programs distributed without source code are compiled so that paxctl cannot work with them, and you have to use chpax. <br><br>  Well, gradm is needed to configure RBAC in GrSecurity - the very same rights restrictions for processes and users. <br><br>  As for the kernel settings.  To begin with, I configured everything as described in the Gentoo and GrSecurity dock - not all protections are included, but most software will work with such settings.  In the process of analyzing the settings, several theoretical assumptions arose: <br><ul><li>  If you load the hardened kernel BEFORE recompiling the system, problems may arise if this option is enabled: <br><pre> <code class="hljs erlang-repl">PaX -&gt; Non-executable pages -&gt; Disallow ELF text relocations</code> </pre> </li><li>  On a server where there are no Xs, you can additionally enable: (do not forget to check before this that something other than Xes, in particular, hwclock, has not stopped working): <br><pre> <code class="hljs erlang-repl">Grsecurity -&gt; Address Space Protection -&gt; Disable privileged I/O</code> </pre> </li><li>  In addition, there is also an assumption that some chroot restrictions may interfere with operations such as installing Gentoo (which goes inside chroot) or attempting to repair the system (if, for example, to boot from a CD with such a hardened kernel): <br><pre> <code class="hljs erlang-repl">Grsecurity -&gt; Filesystem Protections -&gt; Deny mounts Grsecurity -&gt; Filesystem Protections -&gt; Deny double-chroots Grsecurity -&gt; Filesystem Protections -&gt; Deny (f)chmod +s Grsecurity -&gt; Filesystem Protections -&gt; Deny mknod</code> </pre></li></ul><br>  <a href="http://habrahabr.ru/blogs/linux/13094/">Start.</a>  To <a href="http://habrahabr.ru/blogs/linux/13097/">be</a> continued <a href="http://habrahabr.ru/blogs/linux/13097/">...</a> </div><p>Source: <a href="https://habr.com/ru/post/13095/">https://habr.com/ru/post/13095/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130943/index.html">Logitech Squeezebox Radio - for those who love radio and the Internet</a></li>
<li><a href="../130945/index.html">Dynamic programming and lazy computing</a></li>
<li><a href="../130946/index.html">Ants AI Challenge. Tutorial novice bosses</a></li>
<li><a href="../130947/index.html">As a web studio does not quarrel with the customer</a></li>
<li><a href="../130949/index.html">Use ResourceLoader in MediaWiki</a></li>
<li><a href="../130951/index.html">Windows 8 early performance tests</a></li>
<li><a href="../130955/index.html">Old-new games. Release 2</a></li>
<li><a href="../130956/index.html">Dropbox API</a></li>
<li><a href="../130957/index.html">Team Street View shot mountain panoramas, driving through the Alps by train</a></li>
<li><a href="../130958/index.html">Error 80040154 when working with WebAdministration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>