<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to find 56 potential vulnerabilities in FreeBSD code in one evening</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The time has come to check the FreeBSD project again and demonstrate that even in such serious and high-quality projects, the PVS-Studio analyzer easi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to find 56 potential vulnerabilities in FreeBSD code in one evening</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b6/5d4/195/5b65d4195da88c1044587655b7c725d9.png" alt="FreeBSD, CWE"></div><br>  The time has come to check the FreeBSD project again and demonstrate that even in such serious and high-quality projects, the PVS-Studio analyzer easily finds errors.  This time I decided to look at the search for errors in terms of detecting potential vulnerabilities.  The PVS-Studio analyzer has always been able to detect defects that could potentially be used for an attack.  But we never focused on this and described errors as typos, the consequences of unsuccessful Copy-Paste and so on, and did not classify them, for example, according to CWE.  Now it‚Äôs very popular to talk about security and vulnerabilities, so I‚Äôll try to expand your perception of our analyzer a little.  PVS-Studio is not only a search for bugs, but also a tool that improves code security. <br><a name="habracut"></a><br><h2>  About verification </h2><br>  <i>A report on our review of FreeBSD in 2016 can be found <a href="https://www.viva64.com/ru/b/0377/"><i>here</i></a> .</i> <br><br>  As the name implies, what I described in the article I found in one evening.  Those.  I spent only 2-3 hours searching for potential vulnerabilities.  This speaks of the full power of the <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static analyzer.  I recommend using our analyzer to anyone who cares about the quality of the code, and even more so its reliability and resistance to possible attacks. <br><br>  I quickly wrote out the code with errors, but I could not find the time to complete my research in the form of this article for three weeks.  During this time, we have even corrected some of the errors that will be described in the article, in the framework of the new direction ‚ÄúSecurity Defects that PVS-Studio team fixed this week‚Äù: <a href="https://www.viva64.com/ru/b/0487/">issue N2</a> , <a href="https://www.viva64.com/ru/b/0491/">issue N3</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We ruled what is simpler and where it is clear how to fix it, without going into the essence of the algorithms.  Therefore, FreeBSD authors should not be limited to our edits and even this article, but it makes sense to analyze the code yourself and in more detail.  I am ready to give them a temporary key for a full check, and also to help in the fight against false positives that will disturb them.  By the way, about false positives ... <br><br><h2>  False alarms </h2><br>  By checking the project with PVS-Studio, you can get a very wide variation in the number of false positives.  For example, we recently <a href="https://www.viva64.com/ru/b/0478/">tested the FAR project</a> , and the number of false positives was 50%.  This is a great result, meaning that every second message indicates an error or extremely bad code.  And when <a href="https://www.viva64.com/ru/b/0481/">checking Media Portal 2, the</a> result was even better: 27% of false positives. <br><br>  The FreeBSD project is more complicated.  The fact is that the analyzer issued a huge number of general-purpose warnings: <br><br><ul><li>  3577 High level </li><li>  2702 Medium Levels </li></ul><br>  Most messages, of course, are false positives.  It is difficult to calculate, but I think there will be about 95% of false positives. <br><br>  What does this mean?  This says that it makes no sense to talk about the number of false positives on large projects without having to pre-configure the analyzer.  Most of the false warnings occur due to different macros and are easy to remove using the various mechanisms provided by PVS-Studio.  Let me explain this with an example. <br><br>  In the FreeBSD code you can find the following array: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> Q #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> Q #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> Q(_r) \ (((_r) == 1.5) ? 0 : (((_r) ==2.25) ? 1 : (((_r) == 3) ? 2 : \ (((_r) == 4.5) ? 3 : (((_r) == 6) ? 4 : (((_r) == 9) ? 5 : \ (((_r) == 12) ? 6 : (((_r) == 13.5)? 7 : 0)))))))) static const struct txschedule series_quarter[] = { { 3,Q( 1.5),3,Q(1.5), 0,Q(1.5), 0,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 1.5Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q(2.25),3,Q(1.5), 4,Q(1.5), 0,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*2.25Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q( 3),3,Q(1.5), 4,Q(1.5), 0,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 3Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q( 4.5),3,Q( 3), 4,Q(1.5), 2,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 4.5Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q( 6),3,Q(4.5), 4,Q( 3), 2,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 6Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q( 9),3,Q( 6), 4,Q(4.5), 2,Q(1.5) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 9Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q( 12),3,Q( 9), 4,Q( 6), 2,Q( 3) }, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 12Mb/s */</span></span></span><span class="hljs-meta"> { 4,Q(13.5),3,Q( 12), 4,Q( 9), 2,Q( 6) } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*13.5Mb/s */</span></span></span><span class="hljs-meta"> }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> Q</span></span></code> </pre> <br>  Macro Q (1.5) is revealed in: <br><br><pre> <code class="cpp hljs">(((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">1.5</span></span>) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) ==<span class="hljs-number"><span class="hljs-number">2.25</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">3</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : \ (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">4.5</span></span>) ? <span class="hljs-number"><span class="hljs-number">3</span></span> : (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">6</span></span>) ? <span class="hljs-number"><span class="hljs-number">4</span></span> : (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">9</span></span>) ? <span class="hljs-number"><span class="hljs-number">5</span></span> : \ (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">12</span></span>) ? <span class="hljs-number"><span class="hljs-number">6</span></span> : (((<span class="hljs-number"><span class="hljs-number">1.5</span></span>) == <span class="hljs-number"><span class="hljs-number">13.5</span></span>)? <span class="hljs-number"><span class="hljs-number">7</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>))))))))</code> </pre> <br>  The PVS-Studio analyzer considers some of the comparisons to be suspicious.  For example, on the expression (((1.5) == 3) it gives a warning: <br><br>  <a href="http://www.viva64.com/ru/w/V674/">V674</a> The '1.5' literal of the 'double' type is compared to a value of the 'int' type.  Consider inspecting the '(1.5) == 3' expression.  tx_schedules.h 228 <br><br>  In total, the analyzer generates <b>96 messages</b> for this array. <br><br>  There are several more such arrays in FreeBSD code.  In total, the analyzer generates 692 High level warnings on them.  Let me remind you that the total warnings of the High level are 3577. This means that such macros lead to the appearance of 1/5 of these warnings. <br><br>  In other words, by slightly configuring the analyzer, you can eliminate 20% of the false High level messages.  This can be done in different ways, but perhaps the easiest way to turn off the warning is <a href="http://www.viva64.com/ru/w/V674/">V674</a> for those files that use similar arrays.  To do this, write somewhere in the file comment // - V :: 674. <br><br>  I have already voiced an important thought, but I will repeat it, since we are again and again asked about the average percentage of false positives.  Even if we calculate this average percentage based on the verification of many projects, it will not have any practical value.  This is the same as being interested in the average temperature in the hospital. <br><br>  It all depends very much on the project.  Someone will be lucky and you can work with the list of warnings, almost without setting anything up.  Others are not lucky, as is the case with the FreeBSD project.  We'll have to deal with setting and marking macros.  But it is not as scary as it may seem at first glance.  Above, I just showed how you can immediately eliminate a lot of false warnings.  A similar situation will be with other warnings that arise because of stupid macros. <br><br>  And in general, if it was difficult to fight the noise, I would not be able to find all these errors for the article in one evening. <br><br><h2>  New world view </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c51/a66/713/c51a66713cb446cfa41216ad73f7d45b.png" alt="Wide horizons"></div><br>  We decided to look at the world more broadly.  Where we used to see errors and the smell code, now we are also trying to see potential vulnerabilities.  To do this, we decided to start by classifying the warnings issued by PVS-Studio according to the Common Weakness Enumeration (CWE).  You can read more about this here: <a href="https://www.viva64.com/ru/b/0486/">PVS-Studio: search for security defects</a> . <br><br>  Of course, only a small fraction of the errors can be exploited.  In other words, only a few of the errors found by CWE can turn into <a href="https://cve.mitre.org/">CVE</a> .  However, the more errors that fall under the CWE classification, found using static analysis, the better. <br><br>  Use PVS-Studio to prevent vulnerabilities.  This article will demonstrate that the analyzer copes well with this task. <br><br><h2>  Potential vulnerabilities </h2><br><h3>  CWE-476: NULL Pointer Dereference </h3><br>  In total, I noticed 22 errors of this type.  And, probably, I missed the same amount. <br><br>  Let's start with a simple case. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ql_mbx_isr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg)</span></span></span><span class="hljs-function"> </span></span>{ .... ha = arg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ha == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { device_printf(ha-&gt;pci_dev, <span class="hljs-string"><span class="hljs-string">"%s: arg == NULL\n"</span></span>, __func__); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V522/">warning</a> : <a href="http://www.viva64.com/ru/w/V522/">V522</a> Dereferencing of the null pointer 'ha' might take place.  ql_isr.c 750 <br><br>  Here the error is visible immediately.  If <i>ha</i> is <i>NULL</i> , then it is dereference in the expression <i>ha-&gt; pci_dev</i> . <br><br>  The same situation is found in three more files: <br><br><ul><li>  V522 Dereferencing of the null pointer 'sc' might take place.  tws_cam.c 1066 </li><li>  V522 Dereferencing of the null pointer 'ni' might take place.  ieee80211_hwmp.c 1925 </li><li>  V522 Dereferencing of the null pointer 'sbp' might take place.  sbp.c 2337 </li></ul><br>  Now consider a more complex situation: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ecore_ilt_client_mem_op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct bxe_softc *sc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cli_num, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> memop)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i, rc; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ecore_ilt</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SC_ILT</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sc</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt_client_info</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt_cli</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clients</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cli_num</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ilt || !ilt-&gt;lines) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; .... }</code> </pre> <br>  PVS-Studio <a href="http://www.viva64.com/ru/w/V595/">warning</a> : <a href="http://www.viva64.com/ru/w/V595/">V595</a>  Check lines: 667, 669. ecore_init_ops.h 667 <br><br>  Let us dwell on this case in more detail, since not everyone understands all the danger contained in this code. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f0/867/7bb/3f08677bb95117715550345b6f6a0784.png" alt="Silent null"></div><p></p><br>  At the beginning, the <i>ilt</i> pointer is dereferenced: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt_client_info</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt_cli</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ilt</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clients</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cli_num</span></span></span><span class="hljs-class">];</span></span></code> </pre> <br>  Next, it is checked for NULL equality: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ilt || !ilt-&gt;lines)</code> </pre> <br>  Consequently, null pointer dereferencing is possible.  This inevitably leads to undefined program behavior. <br><br>  Here, some will argue that there is no misfortune, since the pointer is derefered "not really."  They will say that the cell address of the array is simply calculated.  Yes, they say, this address is incorrect and cannot be used.  However, there is a check below, and the function will exit if the <i>ilt</i> pointer is equal to zero.  Therefore, the invalid pointer <i>ilt_cli</i> will not be used anywhere and there is no error in the program. <br><br>  They are wrong.  You can not think so.  Dereferencing a null pointer results in undefined behavior.  Therefore, the code is incorrect and you should not argue how it will work.  It can work as you like. <br><br>  However, such an explanation often does not suit some readers, so I will try to develop a thought.  The compiler knows that dereferencing a null pointer is an undefined behavior.  Therefore, if the pointer is dereferenced, then it is not <i>NULL</i> .  Since it is not <i>NULL, the</i> compiler has the right to remove the redundant check <i>if (! Ilt)</i> .  As a result, if the pointer is <i>NULL</i> , then there will be no exit from the function.  Therefore, the function will start processing invalid pointers, which can lead to anything. <br><br>  Some object, saying that the macro <a href="https://en.wikipedia.org/wiki/Offsetof">offsetof is</a> sometimes implemented as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> offsetof(st, m) ((size_t)(&amp;((st *)0)-&gt;m))</span></span></code> </pre> <br>  <i>Here the null pointer dereferencing takes place, but the code works successfully.</i>  <i>Consequently, this proves that such constructions are quite admissible.</i> <br><br>  And again they are wrong.  Nothing proves it. <br><br>  When considering the idiomatic implementation of <i>offsetof,</i> one should take into account that the compiler is allowed to use non-portable techniques for implementing this functionality.  The fact that the compiler uses the constant of the pointer in the implementation of the <i>library</i> when implementing the <i>offsetof</i> does not mean that you can safely execute <i>&amp; ilt-&gt; clients [cli_num]</i> in the case when the <i>ilt</i> is a null pointer. <br><br>  More details on this topic can be found in my article " <a href="https://www.viva64.com/ru/b/0306/">Dereferencing a null pointer leads to undefined behavior</a> ." <br><br>  As a result, the code discussed above is a very real error and should be corrected. <br><br>  Now that we have dealt with the nuances of null pointer dereferencing, it becomes clear that the following function is also incorrect: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> struct iscsi_outstanding * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iscsi_outstanding_add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct iscsi_session *is, struct icl_pdu *request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">union</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ccb *ccb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *initiator_task_tagp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iscsi_outstanding</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> error; ISCSI_SESSION_LOCK_ASSERT(is); io = uma_zalloc(iscsi_outstanding_zone, M_NOWAIT | M_ZERO); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (io == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { ISCSI_SESSION_WARN(is, <span class="hljs-string"><span class="hljs-string">"failed to allocate %zd bytes"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*io)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } error = icl_conn_task_setup(is-&gt;is_conn, request, &amp;ccb-&gt;csio, initiator_task_tagp, &amp;io-&gt;io_icl_prv); .... }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V522/">V522</a> Dereferencing of the null pointer 'ccb' might take place.  The null pointer is passed into 'iscsi_outstanding_add' function.  Inspect the third argument.  Check lines: 'iscsi.c: 2157'.  iscsi.c 2091 <br><br>  At the beginning it may not be clear why the analyzer decided that the <i>ccb</i> pointer <i>would</i> be zero.  Therefore, we note that the analyzer indicates in the warning also here: iscsi.c: 2157. <br><br>  Here is the call to the <i>iscsi_outstanding_add</i> function, which is passed <i>NULL</i> as the actual argument: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iscsi_action_abort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct iscsi_session *is, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">union</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ccb *ccb)</span></span></span><span class="hljs-function"> </span></span>{ .... io = iscsi_outstanding_add(is, request, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;initiator_task_tag); .... }</code> </pre> <br>  Here, the analyzer needed to perform an interprocedural analysis to find the defect. <br><br>  Let's take a break from complex errors and consider a very simple case of an incorrect error handler. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">radeon_cs_ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct drm_device *dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, struct drm_file *fpriv)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drm_radeon_private</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_priv</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev_private</span></span></span><span class="hljs-class">;</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev_priv == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { DRM_ERROR(<span class="hljs-string"><span class="hljs-string">"called with no initialization\n"</span></span>); mtx_unlock(&amp;dev_priv-&gt;cs.cs_mutex); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EINVAL; } .... }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V522/">V522</a> Dereferencing of the null pointer 'dev_priv' might take place.  radeon_cs.c 153 <br><br>  The body of the <i>if statement</i> is executed only when the <i>dev_priv</i> pointer is zero.  Thus, it is not clear what address is calculated here: <i>&amp; dev_priv-&gt; cs.cs_mutex</i> .  And indeed it is UB. <br><br>  Oh.  Something problems with null pointers does not end there.  But what to do, since it is the headache of many programming languages.  So make coffee and keep reading. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/67b/c5c/fa1/67bc5cfa1cb578d70303c56d3ad2c308.png" alt="Null"></div><p></p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bwn_txpwr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> npending)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bwn_mac</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mac</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arg</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bwn_softc</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sc</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mac</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mac_sc</span></span></span><span class="hljs-class">;</span></span> BWN_LOCK(sc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mac &amp;&amp; mac-&gt;mac_status &gt;= BWN_MAC_STATUS_STARTED &amp;&amp; mac-&gt;mac_phy.set_txpwr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) mac-&gt;mac_phy.set_txpwr(mac); BWN_UNLOCK(sc); }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V595/">V595</a> The 'mac' pointer was used before it was verified against nullptr.  Check lines: 6757, 6760. if_bwn.c 6757 <br><br>  The <i>mac</i> pointer at the beginning is dereferenced, and then checked for <i>NULL</i> equality.  Everything is simple here, so I will not comment on it in more detail. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opcode_obj_rewrite</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctl3_rewriters</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipfw_add_obj_rewriter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct opcode_obj_rewrite *rw, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tmp, ctl3_rewriters, ctl3_rsize * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*rw)); <span class="hljs-comment"><span class="hljs-comment">// &lt;= memcpy(&amp;tmp[ctl3_rsize], rw, count * sizeof(*rw)); qsort(tmp, sz, sizeof(*rw), compare_opcodes); /* Switch new and free old */ if (ctl3_rewriters != NULL) // &lt;= free(ctl3_rewriters, M_IPFW); ctl3_rewriters = tmp; ctl3_rsize = sz; CTL3_UNLOCK(); }</span></span></code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V595/">V595</a> The 'ctl3_rewriters' pointer was used against it.  Check lines: 3206, 3210. ip_fw_sockopt.c 3206 <br><br>  Notice that at first the <i>ctl3_rewriters</i> pointer <i>is</i> used as the actual argument of the <i>memcpy</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tmp, ctl3_rewriters, ctl3_rsize * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*rw));</code> </pre> <br>  And then they suddenly remember that it should be checked for <i>NULL</i> equality: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctl3_rewriters != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)</code> </pre> <br>  Consider another case of incorrect code designed to release resources: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mly_user_command</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mly_softc *sc, struct mly_user_command *uc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mly_command</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mc</span></span></span><span class="hljs-class">;</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mc-&gt;mc_data != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= free(mc-&gt;mc_data, M_DEVBUF); // &lt;= if (mc != NULL) { // &lt;= MLY_LOCK(sc); mly_release_command(mc); MLY_UNLOCK(sc); } return(error); }</span></span></code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V595/">V595</a> The 'mc' pointer was used before it was verified against nullptr.  Check lines: 2954, 2955. mly.c 2954 <br><br>  It is necessary to round out with null pointers, because, I think, the description of such errors has already bored not only me, but also the reader.  I see CWE-476 (NULL Pointer Dereference) in the following code areas: <br><br><ul><li>  V595 The 'cm' pointer was used against it.  Check lines: 3361, 3381. mfi.c 3361 </li><li>  V595 The 'cm' pointer was used against it.  Check lines: 1383, 1394. mpr_sas_lsi.c 1383 </li><li>  V595 The 'cm' pointer was used against it.  Check lines: 1258, 1269. mps_sas_lsi.c 1258 </li><li>  V595 The 'ctl3_handlers' pointer was used before it was verified against nullptr.  Check lines: 3441, 3445. ip_fw_sockopt.c 3441 </li><li>  V595 The 'ccb' pointer was used before it was verified against nullptr.  Check lines: 540, 547. iscsi_subr.c 540 </li><li>  V595 The 'satOrgIOContext' pointer was used before it was verified against nullptr.  Check lines: 11341, 11344. smsatcb.c 11341 </li><li>  V595 The 'satOrgIOContext' pointer was used before it was verified against nullptr.  Check lines: 11498, 11501. smsatcb.c 11498 </li><li>  V595 'm m pointer pointer  Check lines: 1153, 1157. midi.c 1153 </li><li>  V595 'm m pointer pointer  Check lines: 1153, 1157. midi.c 1153 </li><li>  V595  Check lines: 1882, 1893. es137x.c 1882 </li><li>  V595 The 'via' pointer  Check lines: 1375, 1392. via8233.c 1375 </li><li>  V595 The 'via' pointer  Check lines: 604, 613. via82c686.c 604 </li></ul><br>  But that's not all!  I was just bored with studying this kind of error, and I turned to the study of another type of warning.  PVS-Studio analyzer is waiting for heroes who will study all the warnings related to null pointers. <br><br><h3>  CWE-467: Use of sizeof () on a Pointer Type </h3><br>  Consider the definition of the <i>pfloghdr</i> structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pfloghdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">u_int8_t</span></span> length; <span class="hljs-keyword"><span class="hljs-keyword">sa_family_t</span></span> af; <span class="hljs-keyword"><span class="hljs-keyword">u_int8_t</span></span> action; <span class="hljs-keyword"><span class="hljs-keyword">u_int8_t</span></span> reason; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ifname[IFNAMSIZ]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ruleset[PFLOG_RULESET_NAME_SIZE]; <span class="hljs-keyword"><span class="hljs-keyword">u_int32_t</span></span> rulenr; <span class="hljs-keyword"><span class="hljs-keyword">u_int32_t</span></span> subrulenr; <span class="hljs-keyword"><span class="hljs-keyword">uid_t</span></span> uid; <span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> pid; <span class="hljs-keyword"><span class="hljs-keyword">uid_t</span></span> rule_uid; <span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> rule_pid; <span class="hljs-keyword"><span class="hljs-keyword">u_int8_t</span></span> dir; <span class="hljs-keyword"><span class="hljs-keyword">u_int8_t</span></span> pad[<span class="hljs-number"><span class="hljs-number">3</span></span>]; };</code> </pre> <br>  As you can see, this structure is quite large.  To initialize such structures, it is common practice when the entire structure is filled with zeros, and then values ‚Äã‚Äãare set for individual fields. <br><br>  However, the <i>nat64lsn_log</i> function failed to correctly initialize the structure.  Consider the code for this function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nat64lsn_log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct pfloghdr *plog, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(plog, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(plog)); <span class="hljs-comment"><span class="hljs-comment">// &lt;= plog-&gt;length = PFLOG_REAL_HDRLEN; plog-&gt;af = family; plog-&gt;action = PF_NAT; plog-&gt;dir = PF_IN; plog-&gt;rulenr = htonl(n); plog-&gt;subrulenr = htonl(sn); plog-&gt;ruleset[0] = '\0'; strlcpy(plog-&gt;ifname, "NAT64LSN", sizeof(plog-&gt;ifname)); ipfw_bpf_mtap2(plog, PFLOG_HDRLEN, m); }</span></span></code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V512/">V512</a> A call of the 'memset' function will 'plog'.  nat64lsn.c 218 <br><br>  Note that <i>sizeof (plog)</i> does not calculate the size of the structure, but the size of the pointer.  As a result, not the entire structure is reset, but only a few first bytes, all other fields of the structure remain uninitialized.  Of course, the correct values ‚Äã‚Äãare clearly written to some fields.  However, a number of members in the structure will remain uninitialized. <br><br>  Exactly the same error can be seen in the nat64stl.c file: <a href="http://www.viva64.com/ru/w/V512/">V512</a> A call of the pause.  nat64stl.c 72 <br><br><h3>  CWE-457: Use of Uninitialized Variable </h3><br>  Consider another error due to which the variable may not be initialized. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">osGLOBAL bit32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tdsaSendTMFIoctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( tiRoot_t *tiRoot, tiIOCTLPayload_t *agIOCTLPayload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *agParam1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *agParam2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resetType )</span></span></span><span class="hljs-function"> </span></span>{ bit32 status; <span class="hljs-keyword"><span class="hljs-keyword">tmf_pass_through_req_t</span></span> *tmf_req = ....; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !(defined(__FreeBSD__)) status = ostiSendResetDeviceIoctl(tiRoot, agParam2, tmf_req-&gt;pathId, tmf_req-&gt;targetId, tmf_req-&gt;lun, resetType); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> TI_DBG3(( </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Status returned from ostiSendResetDeviceIoctl is %d\n"</span></span></span><span class="hljs-meta">, status)); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(status != IOCTL_CALL_SUCCESS) { agIOCTLPayload-&gt;Status = status; return status; } status = IOCTL_CALL_SUCCESS; return status; }</span></span></code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V614/">V614</a> Uninitialized variable 'status' used.  tdioctl.c 3396 <br><br>  If the <i>__FreeBSD__</i> macro is declared (and it is declared), then the condition <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> !(defined(__FreeBSD__))</span></span></code> </pre> <br>  not performed.  As a result, the code inside the <i>#if ... # endif construct is</i> not compiled, and the <i>status</i> variable remains uninitialized. <br><br><h3>  CWE-805: Buffer Access with Incorrect Length Value </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qls_mpid_glbl_hdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> cookie; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> id[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> time_lo; .... } <span class="hljs-keyword"><span class="hljs-keyword">qls_mpid_glbl_hdr_t</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qls_mpi_coredump</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">qls_mpid_glbl_hdr_t</span></span> mpi_global_header; .... }; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qls_mpi_coredump</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">qls_mpi_coredump_t</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qls_mpi_core_dump</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">qla_host_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ha)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">qls_mpi_coredump_t</span></span> *mpi_dump = &amp;ql_mpi_coredump; .... <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(mpi_dump-&gt;mpi_global_header.id, <span class="hljs-string"><span class="hljs-string">"MPI Coredump"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(mpi_dump-&gt;mpi_global_header.id)); .... }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V512/">V512</a> A call of the MPI Coredump function will lead to the meeting.  qls_dump.c 1615 <br><br>  To show how the types and members of the structure that we are interested in were declared, we had to bring in quite a lot of code.  But do not rush to yawn, now I will highlight the most significant: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> id[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(id, <span class="hljs-string"><span class="hljs-string">"MPI Coredump"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(id));</code> </pre> <br>  Important for us: <br><br><ol><li>  The <i>sizeof</i> operator calculates the size of the array and returns the number 16. </li><li>  The string ‚ÄúMPI Coredump‚Äù, taking into account the terminal zero, takes 13 bytes. </li></ol><br>  13 bytes of the string and 3 more bytes after the string will be copied.  Such code may even work in practice.  Just copy 3 bytes with garbage or a fragment of another string.  However, formally, this is going beyond the array boundary, and, therefore, this code leads to undefined program behavior. <br><br><h3>  CWE-129: Improper Validation of Array Index </h3><br>  So I had a chance to show you one of the new diagnostics implemented in PVS-Studio.  The essence of diagnostics <a href="https://www.viva64.com/ru/w/V781/">V781</a> : <br><br>  <i>At the beginning, the value of the variable is used as the size or index of the array.</i>  <i>And then this value is compared with 0 or with the size of the array.</i>  <i>This may indicate a logical error in the code or a typo in one of the comparisons.</i> <br><br>  At its core, this diagnosis is similar to the <a href="https://www.viva64.com/ru/w/V595/">V595</a> , which is well known to my regular readers. <br><br><pre> <code class="cpp hljs">,        FreeBSD. <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sbp_targ_mgm_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct fw_xfer *xfer)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> exclusive = <span class="hljs-number"><span class="hljs-number">0</span></span>, lun; .... lun = orb4-&gt;id; lstate = orbi-&gt;sc-&gt;lstate[lun]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lun &gt;= MAX_LUN || lstate == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || (exclusive &amp;&amp; STAILQ_FIRST(&amp;lstate-&gt;logins) != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; STAILQ_FIRST(&amp;lstate-&gt;logins)-&gt;fwdev != orbi-&gt;fwdev) ) { <span class="hljs-comment"><span class="hljs-comment">/* error */</span></span> orbi-&gt;status.dead = <span class="hljs-number"><span class="hljs-number">1</span></span>; orbi-&gt;status.status = STATUS_ACCESS_DENY; orbi-&gt;status.len = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V781/">V781</a>  Perhaps there is a mistake in program logic.  Check lines: 1617, 1619. sbp_targ.c 1617 <br><br>  At the beginning, the programmer boldly used the <i>lun</i> index to access the <i>lstate</i> array.  And only then a check is made: does the index value exceed the maximum permissible value equal to <i>MAX_LUN</i> ?  If it exceeds, then this situation is treated as erroneous.  But it is too late, since we could already go far beyond the array. <br><br>  Formally, this will lead to an undefined program behavior.  In practice, instead of correctly processing an incorrect index value, <a href="https://www.viva64.com/ru/t/0063/">Access Violation</a> may occur. <br><br>  Now we will consider a more interesting case of incorrect array indexing. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> R88E_GROUP_2G 6 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RTWN_RIDX_OFDM6 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RTWN_RIDX_COUNT 28 struct rtwn_r88e_txagc { uint8_t pwr[R88E_GROUP_2G][20]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RTWN_RIDX_MCS(7) + 1 */</span></span></span><span class="hljs-meta"> }; void r88e_get_txpower(struct rtwn_softc *sc, int chain, struct ieee80211_channel *c, uint16_t power[RTWN_RIDX_COUNT]) { const struct rtwn_r88e_txagc *base = rs-&gt;rs_txagc; .... for (ridx = RTWN_RIDX_OFDM6; ridx </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; RTWN_RIDX_COUNT; ridx++) { if (rs-&gt;regulatory == 3) power[ridx] = base-&gt;pwr[0][ridx]; else if (rs-&gt;regulatory == 1) { if (!IEEE80211_IS_CHAN_HT40(c)) power[ridx] = base-&gt;pwr[group][ridx]; } else if (rs-&gt;regulatory != 2) power[ridx] = base-&gt;pwr[0][ridx]; } .... }</span></span></span></span></code> </pre> <br>  The analyzer issued here three warnings for three expressions, where the <i>pwr</i> array is <i>accessed</i> : <br><br><ul><li>  V557 Array overrun is possible.  The value of 'ridx' index could reach 27. r88e_chan.c 115 </li><li>  V557 Array overrun is possible.  The value of 'ridx' index could reach 27. r88e_chan.c 118 </li><li>  V557 Array overrun is possible.  The value of 'ridx' index could reach 27. r88e_chan.c 120 </li></ul><br>  In a loop, the value of the <i>ridx</i> index changes from <i>RTWN_RIDX_OFDM6</i> to <i>RTWN_RIDX_COUNT</i> .  That is, the variable <i>ridx</i> takes values ‚Äã‚Äãin the range [4..27].  At first glance, everything is fine. <br><br>  To find the error, pay attention to the <i>pwr</i> member, which is a two-dimensional array: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> pwr[R88E_GROUP_2G][<span class="hljs-number"><span class="hljs-number">20</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// R88E_GROUP_2G == 6</span></span></code> </pre> <br>  And let's look again at how this array is accessed in a loop: <br><br><pre> <code class="cpp hljs">base-&gt;pwr[<span class="hljs-number"><span class="hljs-number">0</span></span>][ridx] <span class="hljs-comment"><span class="hljs-comment">// ridx=[4..27] base-&gt;pwr[group][ridx] // ridx=[4..27] base-&gt;pwr[0][ridx] // ridx=[4..27]</span></span></code> </pre> <br>  There is clearly something wrong here.  Occurs over the edge of the array.  However, I find it difficult to guess how this code should work and what should be changed here. <br><br><h3>  CWE-483: Incorrect Block Delimitation </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">smbfs_getattr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ap)</span></span></span><span class="hljs-function"> struct vop_getattr_args *ap</span></span>; { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (np-&gt;n_flag &amp; NOPEN) np-&gt;n_size = oldsize; smbfs_free_scred(scred); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V640/">V640</a> The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  smbfs_vnops.c 283 <br><br>  The design of the code does not correspond to the logic of its work.  Visually, it seems that the line <i>smbfs_free_scred (scred);</i>  executed only if the condition is true.  But in fact, this line is always executed. <br><br>  Perhaps there is no real error here, and it is enough to format the code, but, in any case, this code fragment deserves close attention. <br><br>  The analyzer detected 4 more four similar suspicious code fragments, but I will not give them here, since they are all of the same type.  Limited warning: <br><br><ul><li>  V640 The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  ctl.c 8569 </li><li>  V640 The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  ieee80211_ioctl.c 2019 </li><li>  V640 The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  in_mcast.c 1063 </li><li>  V640 The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  in6_mcast.c 1004 </li></ul><br><h3>  CWE-563: Assignment to Variable without Use ('Unused Variable') </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipf_p_ftp_port</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(softf, fin, ip, nat, ftp, dlen)</span></span></span><span class="hljs-function"> ipf_ftp_softc_t *softf</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">fr_info_t</span></span> *fin; <span class="hljs-keyword"><span class="hljs-keyword">ip_t</span></span> *ip; <span class="hljs-keyword"><span class="hljs-keyword">nat_t</span></span> *nat; <span class="hljs-keyword"><span class="hljs-keyword">ftpinfo_t</span></span> *ftp; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dlen; { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nat-&gt;nat_dir == NAT_INBOUND) a1 = ntohl(nat-&gt;nat_ndstaddr); <span class="hljs-comment"><span class="hljs-comment">// &lt;= else a1 = ntohl(ip-&gt;ip_src.s_addr); // &lt;= a1 = ntohl(ip-&gt;ip_src.s_addr); // &lt;= a2 = (a1 &gt;&gt; 16) &amp; 0xff; a3 = (a1 &gt;&gt; 8) &amp; 0xff; a4 = a1 &amp; 0xff; .... }</span></span></code> </pre> <br>  PVS-Studio analyzer warning: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'a1' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 397, 400. ip_ftp_pxy.c 400 <br><br>  Regardless of the condition, the variable <i>a1</i> will be assigned the value <i>ntohl (ip-&gt; ip_src.s_addr)</i> . <br><br>  It seems to me that the last assignment is redundant. ,       . <br><br>     : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ecore_func_send_switch_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( struct bxe_softc *sc, struct ecore_func_state_params *params)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ECORE_TEST_BIT(ECORE_F_UPDATE_VLAN_FORCE_PRIO_FLAG, &amp;switch_update_params-&gt;changes)) rdata-&gt;sd_vlan_force_pri_flg = <span class="hljs-number"><span class="hljs-number">1</span></span>; rdata-&gt;sd_vlan_force_pri_flg = switch_update_params-&gt;vlan_force_prio; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'rdata-&gt;sd_vlan_force_pri_flg' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 6327, 6328. ecore_sp.c 6328 <br><br>  ,       .  . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ixgbe_add_vf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">device_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dev, u16 vfnum, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">nvlist_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *config)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nvlist_exists_binary(config, <span class="hljs-string"><span class="hljs-string">"mac-addr"</span></span>)) { mac = nvlist_get_binary(config, <span class="hljs-string"><span class="hljs-string">"mac-addr"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); bcopy(mac, vf-&gt;ether_addr, ETHER_ADDR_LEN); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nvlist_get_bool(config, <span class="hljs-string"><span class="hljs-string">"allow-set-mac"</span></span>)) vf-&gt;flags |= IXGBE_VF_CAP_MAC; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">/* * If the administrator has not specified a MAC address then * we must allow the VF to choose one. */</span></span> vf-&gt;flags |= IXGBE_VF_CAP_MAC; vf-&gt;flags = IXGBE_VF_ACTIVE; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'vf-&gt;flags' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 5992, 5994. if_ix.c 5994 <br><br>    "|"       : <br><br><pre> <code class="cpp hljs">vf-&gt;flags |= IXGBE_VF_ACTIVE;</code> </pre> <br> ,   ,   , . ,  .   ,   ,      . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> __mask; } <span class="hljs-keyword"><span class="hljs-keyword">l_sigset_t</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linux_sigreturn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct thread *td, struct linux_sigreturn_args *args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">l_sigset_t</span></span> lmask; .... lmask.__mask = frame.sf_sc.sc_mask; lmask.__mask = frame.sf_extramask[<span class="hljs-number"><span class="hljs-number">0</span></span>]; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'lmask.__mask' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 594, 595. linux32_sysvec.c 595 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> u_int sysctl_log_level = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sysctl_chg_loglevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SYSCTL_HANDLER_ARGS)</span></span></span><span class="hljs-function"> </span></span>{ u_int level = *(u_int *)arg1; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> error; error = sysctl_handle_int(oidp, &amp;level, <span class="hljs-number"><span class="hljs-number">0</span></span>, req); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (error); sysctl_log_level = (level &gt; SN_LOG_DEBUG_MAX)?(SN_LOG_DEBUG_MAX):(level); sysctl_log_level = (level &lt; SN_LOG_LOW)?(SN_LOG_LOW):(level); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'sysctl_log_level' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 423, 424. alias_sctp.c 424 <br><br>     Copy-Paste, ,  ,      .  : <br><br><pre> <code class="cpp hljs">sysctl_log_level = (level &lt; SN_LOG_LOW)?(SN_LOG_LOW):(sysctl_log_level);</code> </pre> <br> . -    : " <a href="https://www.viva64.com/ru/b/0485/">   </a> ". <br><br>  ,    . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uath_tx_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct uath_softc *sc, struct mbuf *m0, struct ieee80211_node *ni, struct uath_data *data)</span></span></span><span class="hljs-function"> </span></span>{ .... chunk-&gt;flags = (m0-&gt;m_flags &amp; M_FRAG) ? <span class="hljs-number"><span class="hljs-number">0</span></span> : UATH_CFLAGS_FINAL; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m0-&gt;m_flags &amp; M_LASTFRAG) chunk-&gt;flags |= UATH_CFLAGS_FINAL; chunk-&gt;flags = UATH_CFLAGS_FINAL; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'chunk-&gt;flags' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 1566, 1567. if_uath.c 1567 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e3/d7a/2b4/7e3d7a2b4f79589c495d92cf516b23b7.png" alt=""></div><p></p><br><br>   -     . ,    . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ch7017_mode_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> lvds_pll_feedback_div, lvds_pll_vco_control; .... lvds_pll_feedback_div = CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED | (<span class="hljs-number"><span class="hljs-number">2</span></span> &lt;&lt; CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT) | (<span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&lt; CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT); lvds_pll_feedback_div = <span class="hljs-number"><span class="hljs-number">35</span></span>; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'lvds_pll_feedback_div' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 287, 290. dvo_ch7017.c 290 <br><br>      35     . ,  -      ,     . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bhnd_pmu1_pllinit0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct bhnd_pmu_softc *sc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xtal)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pmuctrl; .... <span class="hljs-comment"><span class="hljs-comment">/* Write XtalFreq. Set the divisor also. */</span></span> pmuctrl = BHND_PMU_READ_4(sc, BHND_PMU_CTRL); pmuctrl = ~(BHND_PMU_CTRL_ILP_DIV_MASK | BHND_PMU_CTRL_XTALFREQ_MASK); pmuctrl |= BHND_PMU_SET_BITS(((xt-&gt;fref + <span class="hljs-number"><span class="hljs-number">127</span></span>) / <span class="hljs-number"><span class="hljs-number">128</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>, BHND_PMU_CTRL_ILP_DIV); pmuctrl |= BHND_PMU_SET_BITS(xt-&gt;xf, BHND_PMU_CTRL_XTALFREQ); .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'pmuctrl' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 2025, 2026. bhnd_pmu_subr.c 2026 <br><br>   <i>|=</i>   =. <br><br>  ,  ,   : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e1000_update_mc_addr_list_vf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct e1000_hw *hw, u8 *mc_addr_list, u32 mc_addr_count)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mc_addr_count &gt; <span class="hljs-number"><span class="hljs-number">30</span></span>) { msgbuf[<span class="hljs-number"><span class="hljs-number">0</span></span>] |= E1000_VF_SET_MULTICAST_OVERFLOW; mc_addr_count = <span class="hljs-number"><span class="hljs-number">30</span></span>; } msgbuf[<span class="hljs-number"><span class="hljs-number">0</span></span>] = E1000_VF_SET_MULTICAST; msgbuf[<span class="hljs-number"><span class="hljs-number">0</span></span>] |= mc_addr_count &lt;&lt; E1000_VT_MSGINFO_SHIFT; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'msgbuf[0]' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 422, 426. e1000_vf.c 426 <br><br><h3> CWE-570: Expression is Always False </h3><br><pre> <code class="cpp hljs">.... U16 max_ncq_depth; .... <span class="hljs-function"><span class="hljs-function">SCI_STATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scif_user_parameters_set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( SCI_CONTROLLER_HANDLE_T controller, SCIF_USER_PARAMETERS_T * scif_parms )</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scif_parms-&gt;sas.max_ncq_depth &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; scif_parms-&gt;sas.max_ncq_depth &gt; <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SCI_FAILURE_INVALID_PARAMETER_VALUE; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression is always false. scif_sas_controller.c 531 <br><br>       1   32.    ,    <i>&amp;&amp;</i>   <i>||</i>  . <br><br> -            . <br><br>    .      <i>LibAliasSetMode</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LibAliasSetMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(.....)</span></span></span></span>;</code> </pre> <br>     . ,     ,   -1.  -1   UINT_MAX. <br><br>  ,    . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ng_nat_rcvmsg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(node_p node, item_p item, hook_p lasthook)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LibAliasSetMode(priv-&gt;lib, ng_nat_translate_flags(mode-&gt;flags), ng_nat_translate_flags(mode-&gt;mask)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { error = ENOMEM; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression is always false. Unsigned type value is never &lt; 0. ng_nat.c 374 <br><br> ,   .        . <br><br>  ,   ,     .      -1.   <i>if (foo() &lt; 0)</i> .  ,   . <br><br>      .   2: <br><br><ul><li> ,   <i>LibAliasSetMode</i>   <i>signed</i> <i>int</i> ; </li><li>    ,      <i>UINT_MAX</i> . </li></ul><br>    ‚Äî  . <br><br>   ,  ,   ,    .   ,        . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HAL_BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ar9300_reset_tx_queue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct ath_hal *ah, u_int q)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">u_int32_t</span></span> cw_min, chan_cw_min, value; .... value = (ahp-&gt;ah_beaconInterval * <span class="hljs-number"><span class="hljs-number">50</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span>) - ah-&gt;ah_config.ah_additional_swba_backoff - ah-&gt;ah_config.ah_sw_beacon_response_time + ah-&gt;ah_config.ah_dma_beacon_response_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) value = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) value = <span class="hljs-number"><span class="hljs-number">10</span></span>; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'value &lt; 0' is always false. Unsigned type value is never &lt; 0. ar9300_xmit.c 450 <br><br>      : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dtrace_debug_output</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;first &lt; d-&gt;next) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p1 = dtrace_debug_bufr; count = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;next - (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;first; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = d-&gt;first; p &lt; d-&gt;next; p++) *p1++ = *p; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;next &gt; d-&gt;first) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p1 = dtrace_debug_bufr; count = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;last - (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;first; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = d-&gt;first; p &lt; d-&gt;last; p++) *p1++ = *p; count += (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;next - (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>) d-&gt;bufr; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p = d-&gt;bufr; p &lt; d-&gt;next; p++) *p1++ = *p; } .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V517/">V517</a> The use of 'if (A) {...} else if (A) {...}' pattern was detected. There is a probability of logical error presence. Check lines: 102, 109. dtrace_debug.c 102 <br><br>        : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;first &lt; d-&gt;next) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (d-&gt;next &gt; d-&gt;first) {</code> </pre> <br>    ,   .      . <br><br><h3> CWE-571: Expression is Always True </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mfi_tbolt_send_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mfi_softc *sc, struct mfi_command *cm)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *cdb; .... <span class="hljs-comment"><span class="hljs-comment">/* check for inquiry commands coming from CLI */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cdb[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x28</span></span> || cdb[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x2A</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((req_desc = mfi_tbolt_build_mpt_cmd(sc, cm)) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { device_printf(sc-&gt;mfi_dev, <span class="hljs-string"><span class="hljs-string">"Mapping from MFI "</span></span> <span class="hljs-string"><span class="hljs-string">"to MPT Failed \n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } } .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression 'cdb[0] != 0x28 || cdb[0] != 0x2A' is always true. Probably the '&amp;&amp;' operator should be used here. mfi_tbolt.c 1110 <br><br>  <i>(cdb[0] != 0x28 || cdb[0] != 0x2A)</i>  .     <i>0x28,</i>       <i>0x2A</i> .  And vice versa.     . <br><br>    ,     . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">safe_mcopy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mbuf *srcm, struct mbuf *dstm, u_int offset)</span></span></span><span class="hljs-function"> </span></span>{ u_int j, dlen, slen; <span class="hljs-keyword"><span class="hljs-keyword">caddr_t</span></span> dptr, sptr; <span class="hljs-comment"><span class="hljs-comment">/* * Advance src and dst to offset. */</span></span> j = offset; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (j &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcm-&gt;m_len &gt; j) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; j -= srcm-&gt;m_len; srcm = srcm-&gt;m_next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcm == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } sptr = mtod(srcm, <span class="hljs-keyword"><span class="hljs-keyword">caddr_t</span></span>) + j; slen = srcm-&gt;m_len - j; j = offset; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (j &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dstm-&gt;m_len &gt; j) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; j -= dstm-&gt;m_len; dstm = dstm-&gt;m_next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dstm == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... }</code> </pre> <br>   PVS-Studio: <br><br><ul><li> V547 Expression 'j &gt;= 0' is always true. Unsigned type value is always &gt;= 0. safe.c 1596 </li><li> V547 Expression 'j &gt;= 0' is always true. Unsigned type value is always &gt;= 0. safe.c 1608 </li></ul><br>  ,   <i>j</i>   . ,  <i>(j &gt;= 0)</i>   .        <i>while (true)</i> . <br><br>   ,               ,       <i>break</i>  <i>return</i> .  ,         <i>j</i>  <i>u_int</i>  <i>int</i> . <br><br>     ,    ,               ,  -    . <br><br>    ,  .   .  , ,         CWE. ,     : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OSSA_MPI_ENC_ERR_ILLEGAL_DEK_PARAM 0x2001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OSSA_MPI_ERR_DEK_MANAGEMENT_DEK_UNWRAP_FAIL 0x2002 GLOBAL bit32 mpiDekManagementRsp( agsaRoot_t *agRoot, agsaDekManagementRsp_t *pIomb ) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (status == OSSA_MPI_ENC_ERR_ILLEGAL_DEK_PARAM || OSSA_MPI_ERR_DEK_MANAGEMENT_DEK_UNWRAP_FAIL) { agEvent.eq = errorQualifier; } .... }</span></span></code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V560/">V560</a> A part of conditional expression is always true: 0x2002. sampirsp.c 7224 <br><br>       <i>status</i> .  ,       ,    . <br><br>     . ,   ,     <i>ugidfw_rule_valid</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ugidfw_rule_valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mac_bsdextended_rule *rule)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_subject.mbs_flags | MBS_ALL_FLAGS) != MBS_ALL_FLAGS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_subject.mbs_neg | MBS_ALL_FLAGS) != MBS_ALL_FLAGS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_object.mbo_flags | MBO_ALL_FLAGS) != MBO_ALL_FLAGS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_object.mbo_neg | MBO_ALL_FLAGS) != MBO_ALL_FLAGS) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_object.mbo_neg | MBO_TYPE_DEFINED) &amp;&amp; (rule-&gt;mbr_object.mbo_type | MBO_ALL_TYPE) != MBO_ALL_TYPE) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rule-&gt;mbr_mode | MBI_ALLPERM) != MBI_ALLPERM) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EINVAL); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br> ? <br><br> , .      .          . <br><br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V617/">V617</a> Consider inspecting the condition. The '0x00000080' argument of the '|' bitwise operation contains a non-zero value. mac_bsdextended.c 128 <br><br>  ,    <i>MBO_TYPE_DEFINED</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MBO_TYPE_DEFINED 0x00000080</span></span></code> </pre> <br>  ,   : <br><br><pre> <code class="cpp hljs">(rule-&gt;mbr_object.mbo_neg | MBO_TYPE_DEFINED)</code> </pre> <br>    .   ,  ,   ,    ,    : <br><br><pre> <code class="cpp hljs">(rule-&gt;mbr_object.mbo_neg | MBO_TYPE_DEFINED) != MBO_TYPE_DEFINED</code> </pre> <br> -     .        .    ,     CWE-571: <br><br><ul><li> V560 A part of conditional expression is always true: 0x7dac. t4_main.c 8001 </li><li> V547 Expression 'cfgflags &gt;= 0 || cfgflags &lt;= 3' is always true. hwpmc_piv.c 812 </li><li> V547 Expression 'cfgflags &gt;= 0 || cfgflags &lt;= 3' is always true. hwpmc_piv.c 838 </li><li> V501 There are identical sub-expressions 'G_Addr-&gt;g_addr.s_addr' to the left and to the right of the '==' operator. alias_sctp.c 2132 </li></ul><br><h3> CWE-14: Compiler Removal of Code to Clear Buffers </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mlx5_core_create_qp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct mlx5_core_dev *dev, struct mlx5_core_qp *qp, struct mlx5_create_qp_mbox_in *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inlen)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mlx5_destroy_qp_mbox_out</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dout</span></span></span><span class="hljs-class">;</span></span> .... err_cmd: <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;din, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(din)); <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;dout, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dout)); din.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_QP); din.qpn = cpu_to_be32(qp-&gt;qpn); mlx5_cmd_exec(dev, &amp;din, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(din), &amp;out, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dout)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V597/">V597</a> The compiler could delete the 'memset' function call, which is used to flush 'dout' object. The memset_s() function should be used to erase the private data. mlx5_qp.c 159 <br><br>    <i>dout</i> ,   .   ,       . ,     <i>sizeof(dout)</i> ,    .      <i>memset</i> . <br><br>        : <a href="http://www.viva64.com/ru/w/V597/">V597</a> The compiler could delete the 'memset' function call, which is used to flush 'dout' object. The memset_s() function should be used to erase the private data. mlx5_qp.c 323 <br><br>  ,       ,  -,       : <br><br><ul><li>    ,  .    <i>memset</i>   . </li><li>    ,    .    . </li></ul><br>   .       <i>memset</i>  .     .        <a href="https://www.viva64.com/ru/w/V597/">V597</a> . <br><br><h3> CWE-561: Dead Code </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wi_pci_resume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">device_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wi_softc</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sc</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">device_get_softc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ieee80211com</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ic</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sc</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sc_ic</span></span></span><span class="hljs-class">;</span></span> WI_LOCK(sc); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;wi_bus_type != WI_BUS_PCI_NATIVE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= WI_UNLOCK(sc); // &lt;= } if (ic-&gt;ic_nrunning &gt; 0) wi_init(sc); WI_UNLOCK(sc); return (0); }</span></span></code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V779/">V779</a> Unreachable code detected. It is possible that an error is present. if_wi_pci.c 258 <br><br>        <i>return</i> ,       . <br><br><h2>  Other </h2><br>        .   ,     CWE,        ,    .    ,      ,     . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mac_proc_vm_revoke_recurse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct thread *td, struct ucred *cred, struct vm_map *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">map</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mac_mmap_revocation_via_cow) { vme-&gt;max_protection &amp;= ~VM_PROT_WRITE; vme-&gt;protection &amp;= ~VM_PROT_WRITE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((revokeperms &amp; VM_PROT_READ) == <span class="hljs-number"><span class="hljs-number">0</span></span>) vme-&gt;eflags |= MAP_ENTRY_COW | MAP_ENTRY_NEEDS_COPY; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V646/">V646</a> Consider inspecting the application's logic. It's possible that 'else' keyword is missing. mac_process.c 352 <br><br> ,   , ,      <i>else</i> . <br><br> : <br><br><ul><li> V646 Consider inspecting the application's logic. It's possible that 'else' keyword is missing. if_em.c 1905 </li><li> V646 Consider inspecting the application's logic. It's possible that 'else' keyword is missing. if_em.c 3200 </li></ul><br>     Copy-Paste.  ? <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cyapa_raw_input</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct cyapa_softc *sc, struct cyapa_regs *regs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> freq)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;delta_x &gt; sc-&gt;cap_resx) sc-&gt;delta_x = sc-&gt;cap_resx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;delta_x &lt; -sc-&gt;cap_resx) sc-&gt;delta_x = -sc-&gt;cap_resx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;delta_y &gt; sc-&gt;cap_resx) sc-&gt;delta_y = sc-&gt;cap_resy; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;delta_y &lt; -sc-&gt;cap_resy) sc-&gt;delta_y = -sc-&gt;cap_resy; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V778/">V778</a> Two similar code fragments were found. Perhaps, this is a typo and 'cap_resy' variable should be used instead of 'cap_resx'. cyapa.c 1458 <br><br>  : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sc-&gt;delta_y &gt; sc-&gt;cap_resx)</code> </pre> <br>    <i>cap_resx</i>  <i>cap_resy</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">linux_msqid_pushdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l_int ver, struct l_msqid64_ds *linux_msqid64, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">caddr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uaddr)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (linux_msqid64-&gt;msg_qnum &gt; USHRT_MAX) linux_msqid.msg_qnum = linux_msqid64-&gt;msg_qnum; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> linux_msqid.msg_qnum = linux_msqid64-&gt;msg_qnum; .... }</code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V523/">V523</a> The 'then' statement is equivalent to the 'else' statement. linux_ipc.c 353 <br><br> : <br><br><ul><li> V523 The 'then' statement is equivalent to the 'else' statement. linux_ipc.c 357 </li><li> V523 The 'then' statement is equivalent to the 'else' statement. nfs_clvnops.c 2877 </li><li> V523 The 'then' statement is equivalent to the 'else' statement. smsatcb.c 5793 </li><li> V523 The 'then' statement is equivalent to the 'else' statement. arcmsr.c 4182 </li><li> V523 The 'then' statement is equivalent to the 'else' statement. bxe.c 3812 </li></ul><br> ,       <i>strncmp</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ipf_p_irc_complete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ircp, buf, len)</span></span></span><span class="hljs-function"> ircinfo_t *ircp</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len; { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(s, <span class="hljs-string"><span class="hljs-string">"PRIVMSG "</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(s, <span class="hljs-string"><span class="hljs-string">"\001DCC "</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return 0; .... }</span></span></code> </pre> <br>   PVS-Studio: <a href="http://www.viva64.com/ru/w/V666/">V666</a> Consider inspecting third argument of the function 'strncmp'. It is possible that the value does not correspond with the length of a string which was passed with the second argument. ip_irc_pxy.c 140 <br><br>  ,    ,      ¬´PRIVMSG ¬ª.    . <br><br>   ,     "\001DCC ".    ,   ,  4,  5 . : \001 ‚Äî   . <br><br><h2>   PVS-Studio </h2><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/125/05c/ed7/12505ced7a1dc169e6f5fd260a728ecc.png" alt="  PVS-Studio"></div><p></p><br>  FreeBSD  <a href="https://scan.coverity.com/projects/freebsd"></a>   Coverity (    Synopsys).        ,  PVS-Studio     56     10 .           .    ?  ,  PVS-Studio    Coverity   .   PVS-Studio     . <br><br><h2>  Conclusion </h2><br>  ,          ,  .  ,  ,    ,     ,       .    ,         . ,              .      . <br><br>    ,    PVS-Studio  .  ,   <a href="https://www.viva64.com/ru/pvs-studio-download/"> PVS-Studio</a>     .   ,    support[@]viva64.com   <a href="https://www.viva64.com/ru/about-feedback/">  </a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0496/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br><br>        ,      : Andrey Karpov. <a href="http://www.viva64.com/en/b/0496/">How to find 56 potential vulnerabilities in FreeBSD code in one evening</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/325780/">https://habr.com/ru/post/325780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325764/index.html">Meta development tool: FutoIn CID</a></li>
<li><a href="../325770/index.html">Parametric modeling in CAD SolveSpace: Degrees of freedom and constraint equations</a></li>
<li><a href="../325772/index.html">Interfaces of the aggregator of tours: what we have done and where we need the help of Habr</a></li>
<li><a href="../325776/index.html">‚ÄúShaw, again?‚Äù Or hacking transport Citycard (Nizhny Novgorod)</a></li>
<li><a href="../325778/index.html">Life programmers</a></li>
<li><a href="../325782/index.html">The book "Programming in Python"</a></li>
<li><a href="../325784/index.html">Web application security: practical cases</a></li>
<li><a href="../325786/index.html">Why we created a replacement for the old document search systems</a></li>
<li><a href="../325788/index.html">PWA, ‚ÄúOminous Valley‚Äù and stable work offline</a></li>
<li><a href="../325790/index.html">Look at yourself through Zuckerberg‚Äôs eyes and help his rivals.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>