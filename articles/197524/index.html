<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony CMF. Part 1, data storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of the preface 
 I‚Äôve been programming on Yii for two years now and I‚Äôve recently started to stare at Symfony Framework 2. Partly, I‚Äôm attract...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony CMF. Part 1, data storage</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/606/322/bce/606322bce0a894b6cd0dda6f92c2e3a7.png" alt="image" align="left"><h4>  Instead of the preface </h4><br>  I‚Äôve been programming on <a href="http://yiiframework.com/">Yii</a> for two years now and I‚Äôve recently started to stare at Symfony Framework 2. Partly, I‚Äôm attracted to the well-thought-out architecture, partly the weak connectivity of components, and partly the flexibility of built applications.  Immediately after I dealt with the main device of the new framework, I wondered if it was possible to build a CMS on it, and maybe even use the finished one. <br><br>  I haven‚Äôt yet come up with a box solution, however, somehow I wandered onto the Symfony CMF project site and found myself completely overwhelmed by a methodical approach to solving the problems I encountered while working on a conveyor to tighten a design on some Drupal.  On Habr√© there are no publications about CMF, and the project itself is still very raw, but in the long run everything looks interesting, although in some places there is something to complain about. <br><br><h4>  Symfony CMF </h4><br>  The <a href="http://cmf.symfony.com/">Symfony CMF</a> project is designed to simplify the development of functionality inherent in the CMS, for all those who use Symfony Framework 2 in their work. <br>  The main features of the project: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  weak connectivity </li><li>  scalability </li><li>  convenience </li><li>  testability </li></ul><br>  It is necessary to focus on the word <strong>CMF</strong> - the project is not a CMS in itself, it is a <strong>framework</strong> .  Unlike CMS, where all components are tightly tied to each other, in Symfony CMF you: <br><br><ul><li>  use whatever you want </li><li>  replace what you don't like </li><li>  ignore what is not required </li></ul><br>  That is, you are given a set of modular development tools, and not a ready-made application on a turnkey basis, although basic bundles have already been developed that provide CMS functionality. <br><a name="habracut"></a><br><h4>  Why another CMF? </h4><br>  It‚Äôs no secret that there are a lot of ready-made products on the market, both paid (1-Bitrix, UMI) and free (Drupal, MODx, Wordpress, Joomla).  Therefore, it is quite logical that a question may arise when seeing the inscription <em>Whatever CMS / CMF.</em> <strong>Why even make another CMS at all?</strong>  <strong>They are already so full.</strong> <br>  And I absolutely agree.  As a user. <br><br>  CMS is really a dime a dozen.  But as a developer, I often shed sweat, blood and tears, trying to get something more out of them, something the authors of the underlying system and third-party extensions did not. <br><br>  Due to insufficiently thought-out architecture, when working with ready-made solutions, one has to deal with: <br><br><ul><li>  the lack of a clear separation of logic, configuration, content and presentation.  Suffice it to recall the modules Drupal - a bunch of files, a jumble of unclear how named global functions, hooks and other things.  That's the way a <a href="http://odino.org/why-we-choose-symfony2-over-any-other-php-framework/">good article</a> in which this issue is discussed </li><li>  a lot of legacy code left over from old versions.  Periodically, developers are trying to fix it, promising to rewrite the kernel and other joys, but until the new (rewritten) version reaches the ‚Äúcan be used‚Äù stage, a lot of time can pass </li><li>  often there are no such concepts as development, testing, and there are no deployment tools </li><li>  caching problems  Somewhere it is not, somewhere it is, but it does not give a sufficient degree of flexibility, or there are problems with disability, or it simply does not save, etc. </li><li>  poor performance on large (in this case, this concept is relative) data volumes </li><li>  difficulty in creating your own components or overriding existing ones </li><li>  you have to choose between pre-defined data types, or be content with EAV-storage on top of relational DBMS, or worse </li><li>  uncomfortable template engines-bicycles, invented by the authors of CMS ... </li><li>  ... and all this as a consequence of the <a href="http://en.wikipedia.org/wiki/Not_invented_here">NIH</a> syndrome. </li></ul><br>  The developers of these systems are aware of flaws and do not reject the charges, but at the moment it is impossible to solve all these problems.  However, we will not swear at everyone, we will better formulate a number of problems that the CMS should solve for the sake of user convenience, and then we will see how these problems are solved in Symfony CMF.  So the problems are: <br><br><ul><li>  data storage </li><li>  template system </li><li>  routing, CNC, and how the user can control all this </li><li>  menu setting </li><li>  content management (editable blocks on the page, front-end editing on a live site, uploading files) </li><li>  i18n </li><li>  good admin </li></ul><br>  Let's start in order from the problems. <br><br><h4>  Data storage problem </h4><br>  Based on the actual interpretation of the concept of CMS, it becomes clear that the most important component of the CMS is data storage.  Even more - the <em>CMS should provide data storage with different properties</em> .  For example, for materials like BlogPost or NewsItem, you can create common fields <code>title</code> and <code>body</code> , and then the differences will follow - you may need to attach pictures to the news. <br><br>  Imagine an online store.  What is stored in the database?  At least - descriptions of goods and order history.  Unlike the first, for the second it is much easier to design a storage scheme, although it is obvious that both friends cannot exist without friends.  Hence the following requirement: the <em>CMS should be able to refer to the content both within the CMS and in other parts of the system</em> . <br><br>  The content on the site itself is most often organized in the form of a tree structure, in some way repeating the file system.  At the same time, the authors of the site want to organize content in different ways depending on their needs, as well as flexibly adjust the menus and addresses of materials.  Thus, the <em>CMS must present the data in a tree structure</em> and <em>be able to maintain several independent trees at the same time</em> . <br><br>  The information that users enter into the CMS is rarely perfectly structured.  Sometimes, you need to add one, another, third, tenth field - <em>CMS should not be forced to use a single scheme for content</em> or, even better, <em>give the opportunity to define your own scheme</em> . <br><br>  In large organizations, it is not uncommon for the material to go through several stages of verification before appearing on the site, instead of publishing with one click - the <em>CMS should support moving and exporting content between trees</em> .  And for the story it would be nice <em>to keep versions of the content</em> that can be restored at any time. <br><br>  It should be remembered about users from other countries and regions.  Although the whole site is not usually required to translate into another language, the <em>CMS should provide an opportunity to present content in different languages, with an optional fallback according to the rules specified</em> . <br><br>  When the content becomes too much, you will definitely need <em>full-text search</em> , the ability to determine the <em>rules for controlling access to subtrees</em> , and <em>assistance in the process of publishing a document by several authors</em> (workflow is different for everyone). <br><br><h5>  Content Repository </h5><br>  It becomes clear that one "muscle" will not get off.  Relational databases with such tasks simply can not cope, although there are algorithms such as Materialized path or Nested set, which allow you to store the structure of a graph in flat databases.  But even if a single implementation will work, it will most likely be rigidly tied to a specific engine, and this is already bad, because it deprives us of freedom and flexibility.  No need to blame the RDBMS - they are conceived for completely different tasks, they need clearly described data, and not trees consisting of weakly structured elements. <br><br>  However, we will not be upset - after all, we have invented content <strong>repositories</strong> or <strong>content repositories</strong> long ago, if we translate bourgeois.  Repositories are designed to give access to reading, writing and searching data, regardless of the applications that need this data.  In essence, this is a data warehouse with an emphasis primarily on the logical aspect of data processing. <br><br><h5>  JCR-170 </h5><br>  The problem of data storage for document-oriented systems arose many years ago, so even in the first half of the two thousandth, people from Day Software (namely David N√ºscheler) submitted a request through the Java Community Process to accept the <a href="http://www.jcp.org/en/jsr/detail%3Fid%3D170">Content Repository API for Java (JCR)</a> specification, which The serial number was assigned to 170. Later, the specification was held under the number JSR-283 (2.0), JSR-333 (2.1, the final draft was completed on August 31), but the link to the first version is still more common. <br><br>  According to the specification, the repository is an object database that provides storage, search and retrieval of hierarchical data.  In addition, the provided API allows you to use data versioning, transactions, change tracking, import / export to XML, and also store binary and metadata. <br><br>  Such a repository is organized as a tree of nodes that have properties.  Directly the data is stored in them, and it can be numbers, and strings, and binary data of arbitrary length.  Nodes can be subdivided into types, have child nodes, certain behavioral characteristics, or simply refer to neighbors (using a special property and a unique identifier that each node has). <br><br>  Starting with the second version of the specification, the repository should be able to respond to SQL queries, which is more convenient than their XPath counterparts from the first edition. <br><br>  As a vivid example of the implementation of such happiness, you can highlight the <a href="http://jackrabbit.apache.org/">Apache Jackrabbit</a> project, an open-source repository written in Java.  In addition to all the goodies described above, this project (started back in 2004 as the initial implementation of the JCR API) is able to flexibly control access to the content.  There is also clustering, locking mechanisms, etc., but this is not very interesting for us now, so we‚Äôll skip it. <br><br><h5>  PHPCR </h5><br>  But not everyone writes in Java!  (Omit the jokes on this topic) <br>  For people like us, the <a href="http://phpcr.github.com/">Content Repository for PHP</a> was created - the JCR API described above, adapted to the style of PHP.  Assuming that the API is the same and well specified, it follows: you can write the application once, and then just change the backends (theoretically, of course). <br>  An important plus is that we do not reinvent the wheel (as we remember, the problem of data storage in the CMS has already been solved). <br>  Of course, such an initiative could not be ignored - David <a href="https://java.net/jira/browse/JSR_333-28">sent a request</a> for the adoption of PHPCR in JCR 2.1.  Very cute. <br><br>  Since you cannot just take and port APIs from Java to PHP, there are still differences between implementations.  In short, this is due to the fact that PHP is weakly typed and does not support method overloading.  Therefore, some of the interfaces and functions were simply thrown away as unnecessary, and where there was an overload, methods were simply added optional arguments.  Details of the differences are described <a href="https://github.com/phpcr/phpcr/blob/master/doc/JCR_TO_PHPCR.txt">here</a> , but nothing terrible is not there. <br><br>  Currently PHPCR supports the following functions: <br><br><ul><li>  tree access </li><li>  access to nodes by UUID </li><li>  search by nodes </li><li>  versioning </li><li>  identifying opportunities </li><li>  Import and export to XML </li><li>  Locks </li><li>  Transactions * </li><li>  Permissions </li><li>  Access control* </li><li>  Change tracking </li></ul><br>  (*) - Not yet implemented in Jackalope-Jackrabbit (more on this below), although the information could be a little outdated. <br><br>  <strong>Key PHPCR concepts</strong> : <br><br><ul><li>  all content is stored in the node tree </li><li>  nodes have name and type </li><li>  nodes have child nodes and value-storing properties </li><li>  property values ‚Äã‚Äãcan store numbers, strings, binary objects, and references to other nodes. </li></ul><br>  Somewhere we have already heard, is not it? <br><br>  Let's see what this repository might look like (schematically, of course): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cms</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">home</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Hello"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"News"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Today: PHPCR presentation"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">home</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">contact</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Contact"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"phpcr-users@groups.google.com"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">contact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pages</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cms</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  So far, nothing supernatural. <br>  Consider a little more detail what you have to work with. <br><br><h6>  Knots </h6><br><ul><li>  node is a named container that always has a parent </li><li>  resembles XML elements </li><li>  nodes can be created, deleted, modified, copied </li><li>  <em>the path</em> to the node consists of the path of the parent node and the name of the current node: </li><li>  Path: / cms / pages / home </li><li>  Parent path: / cms / pages </li><li>  Host Name: home </li></ul><br><h6>  Node properties </h6><br><ul><li>  nodes have named properties that store values </li><li>  resemble XML attributes </li><li>  data types: STRING, URI, BOOLEAN, LONG, DOUBLE, DECIMAL, BINARY, DATE, NAME, PATH, WEAKREFERENCE, REFERENCE </li><li>  types (WEAK) REFERENCE create links to other nodes </li><li>  nodes and properties can have namespaces: <code>jcr:created</code> , <code>jcr:mimeType</code> , <code>phpcr:class</code> <br></li></ul><br><h6>  Basic node types </h6><br><ul><li>  define the names allowed for use, as well as the types of properties and child nodes </li><li>  each node must have a main type installed </li><li>  for storage, anything is used <code>nt:unstructured</code> <br></li><li>  among other built-in types are nt: address, nt: folder, nt: file and others </li><li>  You can define new types of nodes to create your own scheme </li></ul><br><h6>  Mixin node types </h6><br><ul><li>  main types do not have multiple inheritance </li><li>  but there are mixin types that add <a href="https://en.wikipedia.org/wiki/Trait_(computer_programming)">trait-</a> like functionality to nodes </li><li>  mixin types can be assigned to a node during its lifetime </li></ul><br>  Example: let's say we have a <code>jcr:uuid</code> property that stores a unique identifier.  Knowing uuid, we can create a mixin <code>mix:referenceable</code> , and based on it <code>mix:versionable</code> (but then we still need to have the properties <code>jcr:versionHistory</code> , <code>jcr:predecessors</code> , <code>jcr:baseVersion</code> , <code>jcr:isCheckedOut</code> , <code>jcr:mergeFailed</code> , etc. ) <br><br><h6>  Workspaces </h6><br><ul><li>  there can be several workspaces, each one keeps its own node tree </li><li>  resembles the Unix file system and branches in Git / SVN, each can be cloned and merged </li><li>  can be used independently </li></ul><br><img alt="    PHPCR" src="https://habrastorage.org/getpro/habr/post_images/7c6/2cb/1e6/7c62cb1e6a29e22c5e3b5c4db0d514a5.png" title="PHPCR data acquisition process"><br><br>  And now some examples of how to work with all this: <br><br>  Session creation <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PHPCR</span></span>\<span class="hljs-title"><span class="hljs-title">SimpleCredentials</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ,      use Jackalope\RepositoryFactoryJackrabbit as Factory; $parameters = array( 'jackalope.jackrabbit_uri' =&gt; 'http://localhost:8080/server', ); $repository = Factory::getRepository($parameters); //         $creds = new SimpleCredentials('admin','admin'); $session = $repository-&gt;login($creds, 'default');</span></span></code> </pre><br>  CRUD operations <br><br><pre> <code class="php hljs">$root = $session-&gt;getRootNode(); <span class="hljs-comment"><span class="hljs-comment">//        $node = $root-&gt;addNode('test', 'nt:unstructured'); //        $node = $session-&gt;getNode('/test'); // /  $node-&gt;setProperty('prop', 'value'); //       $session-&gt;save(); //       $node-&gt;remove(); //  ,   -     $session-&gt;save();</span></span></code> </pre><br>  Tree traversal <br><br><pre> <code class="php hljs">$node = $session-&gt;getNode(<span class="hljs-string"><span class="hljs-string">'/site/content'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($node-&gt;getNodes() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { var_dump($child-&gt;getName()); } <span class="hljs-comment"><span class="hljs-comment">//   foreach ($node as $child) { var_dump($child-&gt;getName()); } //    foreach ($node-&gt;getNodes('di*') as $child) { var_dump($child-&gt;getName()); }</span></span></code> </pre><br>  Versionality <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $node = $session-&gt;getNode('/site/content/about'); $node-&gt;addMixin('mix:versionable'); $session-&gt;save(); //    $node-&gt;setProperty('title', 'About'); $session-&gt;save(); // - ( ) //  - (   ) //         $session-&gt;save() $vm = $session-&gt;getWorkspace()-&gt;getVersionManager(); $vm-&gt;checkpoint($node-&gt;getPath()); //   $node-&gt;setProperty('title', 'Ups'); $session-&gt;save(); //    ,    ¬´  ¬ª $vm-&gt;checkin($node-&gt;getPath()); $base = $vm-&gt;getBaseVersion($node-&gt;getPath()); $current = $base-&gt;getLinearPredecessor(); $previous = $current-&gt;getLinearPredecessor(); //     $frozenNode = $previous-&gt;getFrozenNode(); echo $frozenNode-&gt;getProperty('title'); // About //       $vm-&gt;restore(true, $previous); $node = $session-&gt;getNode('/site/content/about'); echo $node-&gt;getProperty('title'); // About</span></span></code> </pre><br>  Search <br><br><pre> <code class="php hljs">$qm = $workspace-&gt;getQueryManager(); <span class="hljs-comment"><span class="hljs-comment">//  SQL2   "*"     //         // (. http://docs.jboss.org/exojcr/1.12.13-GA/developer/en-US/html/ch-jcr-query-usecases.html#d0e3332) $sql = "SELECT * FROM [nt:unstructured] WHERE [nt:unstructured].type = 'nav' AND ISDESCENDANTNODE('/some/path') ORDER BY score, [nt:unstructured].title"; $query = $qm-&gt;createQuery($sql, 'JCR-SQL2'); $query-&gt;setLimit($limit); $query-&gt;setOffset($offset); $queryResult = $query-&gt;execute(); foreach ($queryResult-&gt;getNodes() as $node) { var_dump($node-&gt;getPath()); }</span></span></code> </pre><br><br>  Other code examples can be viewed <a href="http://phpcr.github.io/slides.html">in this presentation</a> . <br><br>  However, let us return to the alluring thought about different backends. <br><br>  We currently have not so many implementations, but also those already interesting: <br><br><ul><li>  <a href="http://midgard-project.org/phpcr/">Midgard2 PHPCR</a> </li><li>  <a href="https://github.com/jackalope/jackalope">Jackalope</a> </li><li>  supports jackrabbit </li><li>  supports Doctrine DBAL (data storage on relational databases) </li><li>  supports MongoDB (actually not) </li></ul><br><h5>  Midgard2 PHPCR </h5><br>  <a href="http://midgard-project.org/midgard2/">Midgard2</a> is an open source content repository with binders for C, Python and <a href="http://midgard-project.org/phpcr/">PHP</a> . <br><br>  A little <a href="https://github.com/midgardproject/phpcr-midgard2">different terminology</a> from JCR, Midgard2 provides the same functions for accessing content via Midgard2 PHPCR using the <a href="https://github.com/midgardproject/midgard-php5">php5-midgard2 extension</a> .  Being built on top of the GNOME libgda library, Midgard2 maintains <a href="http://www.gnome-db.org/Providers_status">an impressive list of</a> relational databases in which you can place your repository. <br><br>  Immediately I will say about a fly in the ointment - a PHP extension is compiled for a sufficiently small number of OS: <br><br><ul><li>  under Debian 7 Wheezy, the package is still in unstable branches (and deservedly silently drops PHP-FPM in a segfolt). </li><li>  for CentOS, the packages are either outdated or not for all architectures (but where there is, it is very likely that it works, the hands did not reach) </li><li>  Windows builds do not exist in nature (it is possible that the ‚Äúgnome‚Äù roots of Midgard2 itself are affected, although four years old files are still in PHP4 in the repository) </li><li>  I could not test it under Mac OS due to my lack of it (but judging by the site, everything is put through brew). </li></ul><br>  In general, everything was successfully installed on Ubuntu Server 12.04, there are fresh packages and nothing crashes. <br><br>  However, from communicating with the Symfony CMF developers on IRC, it became clear to me that this backend provider had been broken for several months, even tests for it were disabled.  The reason is somewhere on the side of the Midgard2 team, although <a href="https://github.com/bergie/">bergie</a> promised to fix it. <br><br><img alt="IRC" src="https://habrastorage.org/getpro/habr/post_images/f1f/4bb/479/f1f4bb479570230fce83027e5905b894.png" title="IRC"><br><br>  Midgard2 PHPCR as part of the symfony CMF did not work for me.  Maybe someone else will.  Not now, then later. <br><br><h5>  Jackalope </h5><br>  Continuing to beat the hare topic in the names ( <a href="">Jackrabbit</a> , <a href="">Jackalope</a> ), Jackalope provides access to three types of data warehouses: <br><br><ul><li>  this is already known to us apache jackrabbit </li><li>  Doctrine Database Abstraction Layer, which allows you to use supported DBAL engines.  This is in theory, in practice, only MySQL, PostreSQL and SQLite have been tested (someone is using something else?). </li><li>  <a href="https://github.com/chirimoya/jackalope/tree/MongoDB">MongoDB</a> (not updated for two years, most likely broken or irrelevant) </li></ul><br>  Jackalope (and in particular jackalope-jackrabbit) is fairly stable and is recommended for use as the most complete implementation of the PHPCR API in terms of features.  We will work with her.  However, phpcr-api-tests that check the availability and performance of the PHPCR API are also included for jackalope-doctine-dbal, which may eventually catch up. <br><br><h4>  PHPCR Summary </h4><br>  So, we have an (adapted for PHP) API for accessing content repositories that conform to the JCR API standard.  For this API, several libraries have been developed that abstract the application code from the data store. <br><br>  So far, there should be two main questions, and both will be answered: <br><br>  <strong>When to use PHPCR?</strong> <br><br><ul><li>  When to work with hierarchical navigation structures </li><li>  When you have data related to each other </li><li>  When data versioning is needed </li></ul><br>  <strong>When to NOT use PHPCR?</strong> <br><br>  For strictly structured content and the use of aggregate queries, it is recommended to use relational databases.  For example, in an online store, product descriptions can be stored in PHPCR, and orders can be stored in RDBMS. <br><br><h4>  PHPCR ODM </h4><br>  The specification is great, but the API is too abstract and inconvenient for everyday use (after all, most are accustomed to some ORM system).  And here comes the <a href="http://www.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a> project, which is a bundle of PHPCR and Object Document Mapper. <br><br>  <a href="http://www.doctrine-project.org/projects/orm.html">A Doctrine ORM</a> , familiar to developers using SF2 (and not only SF2), implements the <a href="http://en.wikipedia.org/wiki/Data_mapper_pattern">Data mapper</a> pattern to access data stored in RDMBS. <br><br>  ODM, like Doctrine ORM, uses Data mapper to completely separate business logic from the data storage layer, which in this case is the content repository.  The authors honestly admit that ODM is inspired by the ideas of <a href="http://www.hibernate.org/">Hibernate</a> . <br><br>  ODM stores objects as PHPCR nodes, calling them documents.  At the same time, since PHPCR is already independent of implementations, it does not require writing a new abstraction layer from the database (DBAL). <br><br>  What is a <strong>document</strong> in PHPCR ODM terminology? <br><br>  The document is a concise PHP class that does not implement any interfaces (or rather, you can always implement it, but the library itself does not require this) and is not inherited from some basic abstract classes.  Such an entity should not have methods with the keyword <code>final</code> , implement the <code>clone()</code> and <code>wakeup()</code> methods, or implement them, but doing so <em>very carefully</em> .  By itself, an entity consists of properties fixed in a repository.  Since ODM works on top of the <a href="http://www.doctrine-project.org/projects/common.html">Doctrine Common</a> library, which implements the basic functionality (annotations, caching and autoloading of classes), mapping of properties in the data store to class properties is done using the familiar way ‚Äî through annotations in PHP comments or in YAML / XML configurations.  Each document has a title (title) and content (content).  All documents are organized as a tree and can refer to other documents.  Take a look at the sample document: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Demo</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ODM</span></span>\<span class="hljs-title"><span class="hljs-title">PHPCR</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span>\<span class="hljs-title"><span class="hljs-title">Annotations</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">PHPCRODM</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\Document */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyDocument</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\Id */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $id; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\ParentDocument */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $parent; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\Nodename */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\Children */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $children; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\String */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $title; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\String */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $content; <span class="hljs-comment"><span class="hljs-comment">//            }</span></span></code> </pre><br>  Note that in addition to the usual data types (for example, String), annotations can also specify the type of references to child or parent documents. <br><br>  For those unfamiliar with the Data mapper pattern, it may seem that such classes are a bit similar to <a href="https://en.wikipedia.org/wiki/Active_record_pattern">Active record</a> (hello, rails and Yii-shniki), but they are not anyway. <br><br>  How to work with such a document? <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'../bootstrap.php'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     $rootDocument = $documentManager-&gt;find(null, '/'); //    $doc = new \Demo\Document(); $doc-&gt;setParent($rootDocument); $doc-&gt;setName('doc'); $doc-&gt;setTitle('My first document'); $doc-&gt;setContent('The document content'); //  ,    $childDocument = new \Demo\Document(); $childDocument-&gt;setParent($doc); $childDocument-&gt;setName('child'); $childDocument-&gt;setTitle('My child document'); $childDocument-&gt;setContent('The child document content'); //     ,        $documentManager-&gt;persist($doc); $documentManager-&gt;persist($childDocument); //   ,   ..   $documentManager-&gt;flush();</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'../bootstrap.php'</span></span>; $doc = $documentManager-&gt;find(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">"/doc"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Found '</span></span>.$doc-&gt;getId() .<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Title: '</span></span>.$doc-&gt;getTitle().<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Content: '</span></span>.$doc-&gt;getContent().<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($doc-&gt;getChildren() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($child <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> \Demo\Document) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Has child '</span></span>.$child-&gt;getId() . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Unexpected child '</span></span>.get_class($child).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">//   $documentManager-&gt;remove($doc); $documentManager-&gt;flush();</span></span></code> </pre><br>  A small note is that in ORM it is usual to receive data using queries.  In ODM, you need to use a hierarchy for this.  However, you can <a href="http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/working-with-objects.html">do queries</a> if you really want to. <br><br>  PHPCR ODM has already implemented two very important functions - versioning and multilingualism.  Let's start with the first. <br><br>  Versioning in PHPCR is of two kinds - simpleVersionable and versionable.  For simple versioning, checkin / checkout methods and a linear history are provided.  Chekin creates a new version of the node and makes read-only available. To write something down, you need to make a checkout. <br><br>          (  -  PHPCR-ODM  )   (  ,      Jackalope).        ,            ( ,     ,       ). <br><br>     <code>mix:versionable</code>  PHPCR    .  , PHPCR Version API   PHPCR ODM ,        <code>PHPCR\VersionManager</code>   PHPCR-.    <a href=""></a>  <a href="http://www.day.com/specs/jcr/2.0/15_Versioning.html"></a> . <br><br>    PHPCR    .  -  (   ).   ,          . <br><br>         ( ‚Äî    <code>restoreVersion()</code>  <code>removeVersion()</code> . <br><br>      - ,       : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Document</span></span></span><span class="hljs-comment">(versionable="simple") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyPersistentClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@VersionName</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $versionName; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@VersionCreated</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $versionCreated; }</code> </pre><br>   ,    ,  ,     Phpdoc-   .         ,      . <br><br><pre> <code class="php hljs">$article = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Article(); $article-&gt;id = <span class="hljs-string"><span class="hljs-string">'/test'</span></span>; $article-&gt;topic = <span class="hljs-string"><span class="hljs-string">'Test'</span></span>; $dm-&gt;persist($article); $dm-&gt;flush(); <span class="hljs-comment"><span class="hljs-comment">//         $dm-&gt;checkpoint($article); $article-&gt;topic = 'Newvalue'; $dm-&gt;flush(); //     $versioninfos = $dm-&gt;getAllLinearVersions($article); $firstVersion = reset($versioninfos); //        $oldVersion = $dm-&gt;findVersionByName(null, $article-&gt;id, $firstVersion['name']); echo $oldVersion-&gt;topic; // "Test" //    $article = $dm-&gt;find('/test'); echo $article-&gt;topic; // "Newvalue" //       $dm-&gt;restoreVersion($oldVersion); //   echo $article-&gt;topic; // "Test" //    ,    $article-&gt;topic = 'Newvalue'; $dm-&gt;flush(); $dm-&gt;checkpoint($article); //      (     ) $dm-&gt;removeVersion($oldVersion);</span></span></code> </pre><br>   .       .   ,         , ,    ,     .          ‚Äî     DocumentManager,    ,       <code>find()</code>        . : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@PHPCRODM</span></span></span><span class="hljs-comment">\Document(translator="attribute") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyPersistentClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Locale</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $locale; <span class="hljs-comment"><span class="hljs-comment">/** *   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Date</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $publishDate; <span class="hljs-comment"><span class="hljs-comment">/** *   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@String</span></span></span><span class="hljs-comment">(translated=true) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $topic; <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Binary</span></span></span><span class="hljs-comment">(translated=true) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $image; }</code> </pre><br>       : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   DocumentManager (   ) $localePrefs = array( 'en' =&gt; array('fr'), 'fr' =&gt; array('en'), ); $dm = new \Doctrine\ODM\PHPCR\DocumentManager($session, $config); $dm-&gt;setLocaleChooserStrategy(new LocaleChooser($localePrefs, 'en')); //   : $doc = new Article(); $doc-&gt;id = '/my_test_node'; $doc-&gt;author = 'John Doe'; $doc-&gt;topic = 'An interesting subject'; $doc-&gt;text = 'Lorem ipsum...'; //     $dm-&gt;persist($doc); $dm-&gt;bindTranslation($doc, 'en'); //          $doc-&gt;topic = 'Un sujet int√©ressant'; $dm-&gt;bindTranslation($doc, 'fr'); //    echo $doc-&gt;locale; // fr //    PHPCR $dm-&gt;flush(); //       // (   ) $doc = $dm-&gt;find(null, '/my_test_node'); //     $doc = $dm-&gt;findTranslation(null, '/my_test_node', 'fr'); $doc-&gt;title = 'nouveau'; $dm-&gt;flush(); //    ,    </span></span></code> </pre><br>      ,    ,      ,         .    ,   ,           ( ,   ,    ). ,  ,     . <br><br>      ,  ,    (    ),    Solr/ElasticSearch    Doctrine DBAL      MongoDB.        Jackrabbit (   Oak)      ,    -   PHPCR      . <br><br>  Summarize.   ODM    : <br><br><ul><li> PHP Content Repository     Jackalope  Midgard2 (   Jackrabbit  ) </li><li> PHPCR-ODM  Doctrine Common       </li><li>   . </li></ul><br>   <a href="http://habrahabr.ru/post/211086/"> </a> . </div><p>Source: <a href="https://habr.com/ru/post/197524/">https://habr.com/ru/post/197524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197514/index.html">Officials rejected the petition to repeal the "anti-piracy" law</a></li>
<li><a href="../197516/index.html">Network for the smallest. Micro Issue number 3. IBGP</a></li>
<li><a href="../197518/index.html">ePayService at Kyiv CasualConnect 2013</a></li>
<li><a href="../197520/index.html">Lock-free data structures. Basics: Memory Model</a></li>
<li><a href="../197522/index.html">How we did the wiren board</a></li>
<li><a href="../197528/index.html">ABCat: OpenSource catalog and audiobook downloader</a></li>
<li><a href="../197540/index.html">Algorithm of data distribution in a server cluster in dCache</a></li>
<li><a href="../197542/index.html">HTC One max officially presented</a></li>
<li><a href="../197546/index.html">Ghost: Just a blogging platform</a></li>
<li><a href="../197550/index.html">A site that matures and grows wiser without you. Pro Wordpress</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>