<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Static code analyzers on the example of ClickHouse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A little more than a month ago, an article was published containing an analysis of the ClickHouse source code using PVS-Studio. The article was quite ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Static code analyzers on the example of ClickHouse</h1><div class="post__text post__text-html js-mediator-article"><p>  A little more than a month ago, an <a href="https://habrahabr.ru/company/pvs-studio/blog/337182/">article</a> was published containing an analysis <a href="https://github.com/yandex/ClickHouse/">of the ClickHouse source code</a> using PVS-Studio.  The article was quite successful: for example, the link to it was sent to me at least ten times on the day of its publication.  The overall tone of the article is positive, and traffic on the site <a href="https://clickhouse.yandex/">clickhouse.yandex</a> on the day of its release has increased markedly. </p><br><p>  I really respect when a company or a person does its work exhaustively.  So, PVS-Studio has a comprehensive approach to promotion: there are only 337 articles on Habr√© alone.  They hold reports at almost all Russian C ++ conferences.  In any case, it is worth noting: people try and by their work benefit other people. </p><br><p>  That article aroused our interest in static analyzers, and we decided to test the operation of several publicly available PVS-Studio analogues on the ClickHouse code base.  In today's article we will share with you the results of this study. </p><br><p><img src="https://habrastorage.org/files/d9b/066/e61/d9b066e61e1f480a977d889dc03ded99.png"></p><a name="habracut"></a><br><p> On the day the article was published, we fixed all the bugs noted in it.  The result can be seen <a href="https://habrahabr.ru/company/pvs-studio/blog/337182/">in this commit</a> .  Some bugs at the time of publication were no longer in <code>master</code> , since we fixed them earlier. </p><br><p>  There are no doubts about the usefulness of static analyzers.  Some commentators say that it is much more useful to have code review, tests, launches under sanitizers.  The benefits of these solutions are obvious.  Moreover, we already have a code review (mediocre), subcommittee tests (with insufficient coverage) and launches under sanitizers (only ASan, once a day Valgrind).  Static analyzers can find other bugs - for example, copy-paste in code that is never executed and which should have been removed a year ago.  And something more serious also has a chance to find (read on).  That is, the benefits of static analyzers are non-zero. </p><br><p>  The article did not indicate all the detected defects, and we were offered to use the trial license of PVS-Studio to search for the rest.  But before requesting a time-limited license, we first wanted to make sure that we were fairly well prepared and did not waste time. </p><br><p>  We decided to first explore several alternatives of PVS-Studio, as a result of which we tried Clang-Tidy, ppcheck, Coverity and Svace.  For each of them, we managed to compile instructions on how to properly use them for ClickHouse code. </p><br><h3 id="cppcheck">  Cppcheck </h3><br><p><img src="https://habrastorage.org/webt/59/f1/63/59f163c651927591931300.png"></p><br><p>  Instructions for use: <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/tests/instructions/cppcheck.txt">cppcheck.txt</a> . </p><br><p>  This tool has several important advantages: it is very easy to use and works extremely fast.  So, our repository was analyzed in a few seconds.  The standard launch mode resulted in only a few false positive warnings.  About 200 warnings were received in the <code>--enable-all</code> mode, some of which were meaningful: </p><br><ul><li>  <a href="https://github.com/yandex/ClickHouse/commit/8b313ab99ec6330d26d64596666725f717a29e51">Someone forgot to enter one character</a> .  Lucky - the error does not affect the behavior of the program. </li><li>  Non-use of the function <a href="https://github.com/yandex/ClickHouse/commit/8b313ab99ec6330d26d64596666725f717a29e51">log1p</a> - did not know that such exists.  In this case also does not affect the behavior of the program. </li></ul><br><p>  In addition, the analyzer also found some non-optimalities when passing parameters to functions, forgotten explicit-definitions, too wide areas of visibility for some variables, and so on. </p><br><p>  Many false positives are due to the fact that the analyzer is very primitive.  Apparently, it does not even fully parse C ++.  For example, the following code </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> lambda = [&amp;]{ x = <span class="hljs-number"><span class="hljs-number">1</span></span>; };</code> </pre> <br><p>  treated in the same way as the code: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; { x = <span class="hljs-number"><span class="hljs-number">1</span></span>; };</code> </pre> <br><p>  Nevertheless, a large number of false positives is the norm for static code analyzers.  The scenario of using them is to look at a few hundred errors and, possibly, to find among them several really significant ones. </p><br><h3 id="clang-tidy">  Clang-tidy </h3><br><p><img src="https://habrastorage.org/webt/59/f1/63/59f16362b001e886186111.png"></p><br><p>  Instructions for use: <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/tests/instructions/clang-tidy.txt">clang-tidy.txt</a> </p><br><p>  An important advantage of this tool is that it is located in the Clang ecosystem.  This means that if your system is compiled with Clang, then Clang-Tidy will correctly take into account all the features of the assembly of your project.  There are instructions on how to add your own checks. </p><br><p>  Clang-Tidy spends about a dozen seconds analyzing each translation unit.  It is slow enough. </p><br><p>  Clang-Tidy differs from Clang static analyzer (also known as scan-build) by the presence of style checks.  Some of the style checks let you automatically rewrite code.  It is worth noting that the Clang static analyzer, unlike the Clang-Tidy, can generate HTML pages with the results, whereas the Clang-Tidy only displays messages about the problems found in the terminal window. </p><br><p>  There is no point in using all types of checks.  For example, one of the <a href="https://www.securecoding.cert.org/confluence/pages/viewpage.action%3FpageId%3D637">CERT Secure Coding Standards</a> checks, <a href="https://github.com/isocpp/CppCoreGuidelines">C ++ Core Guidelines</a> or <a href="http://www.codingstandard.com/section/index/">HTC ++</a> says ‚Äúdo not use pointer arithmetic‚Äù.  It is in some sense reasonable, but it is too painful to explicitly mark all the sources for which this check should be turned off. </p><br><p>  Helpful messages were found in the static analyzer and performance test groups.  Performance found two types of errors: post iterations of iterators and passing arguments by value instead of passing by reference.  Unfortunately, checking the transmission of arguments by reference works even for small structures, for example: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; };</code> </pre> <br><p>  or <code>STRONG_TYPEDEF</code> . </p><br><p>  In this case, replacing a transfer by value to a transfer by reference may turn out to be useless or even harmful (provided that the function is not inline and not cloned, because in these cases there is no difference).  In other situations, the check turned out to be more useful, see the <a href="https://github.com/yandex/ClickHouse/commit/d29c77adea08af7922d7b82e56ccee2f2d11783f">commit</a> with corrections.  Of course, such errors should be detected at the code review stage - provided that you were attentive enough.  Note that after correcting all the performance warnings, the actual performance of ClickHouse has not changed.  This is expected: if the corresponding errors were in narrow places, we would have noticed it the first time you run <code>sudo perf top</code> . </p><br><p>  The warnings from static analyzer are quite useful: </p><br><ul><li>  <a href="https://github.com/yandex/ClickHouse/commit/e9ae1938706c8c6e4aab478c0356b1dcf4d300e9">Call a virtual function in the constructor</a> .  It turned out that virtual was written by mistake. </li><li>  <a href="https://github.com/yandex/ClickHouse/commit/d19d9f8589d8e39d104a7ad8cd7d56c79324c250">Loss of precision in calculations</a> </li><li>  <a href="https://github.com/yandex/ClickHouse/commit/4799f28dadc31f4c967f5304cf5465c307ee1573">Null pointer dereferencing</a> . </li></ul><br><h3 id="coverity">  Coverity </h3><br><p>  Instructions for use: <a href="https://github.com/yandex/ClickHouse/blob/master/dbms/tests/instructions/coverity.txt">coverity.txt</a> . </p><br><p>  Coverity is a closed commercial product, but for open source projects it can be used for free.  Among the famous products that use Coverity are, for example, Linux. </p><br><p>  The scheme of work: a utility is downloaded from the site, which wraps any build system (instead of <code>make</code> simply indicates <code>cov-build make</code> ) and intercepts the compiler calls.  It was not the first time we managed to make it work - I had to go through several options how to tell it which compiler was being used. </p><br><p>  For some translation units, the tool‚Äôs running time reaches an hour, and the total analysis time of the entire project is 4 hours.  The result is a tarball that can be downloaded to the Coverity website.  Archive size 1.5 GB booted successfully.  You can download and more voluminous results. <br>  Then, in order to gain access to the results of the analyzer, it is necessary to pass a test for the ability to work with the source code of the analyzed project.  For example, they gave me access for one and a half days. </p><br><p><img src="https://habrastorage.org/webt/59/f1/62/59f162d15eab0878649010.png"></p><br><p>  After that, a beautiful web-interface became available, where you can interactively study the code with annotations of defects, as well as note resolutions (false positive, intentional, fix required, etc.). </p><br><p><img src="https://scan.coverity.com/projects/10031/badge.svg?flat=1" alt="https://scan.coverity.com/projects/yandex-clickhouse/"></p><br><p>  Immediately they gave an achivka, although I did not understand why. <br>  Found 312 some defects. </p><br><ul><li>  <a href="https://github.com/yandex/ClickHouse/commit/ed1c0820f00c33b54eda7750b3b3c746a70038c7">An uninitialized variable</a> if the user in the config does not specify a single element in one of the sections. </li><li>  <a href="https://github.com/yandex/ClickHouse/commit/9cafeb9e85ce094969e79ce46b85233bc682de4f">The dereferencing of the end iterator is</a> only to turn it into an address. </li><li>  <a href="https://github.com/yandex/ClickHouse/commit/5e25c40a26f5499afa09916cad2df243a1a4daef">Every little thing</a> . </li></ul><br><p>  Some of the defects found are actually part of the intended design. </p><br><ul><li>  Tautological conditions in if in template code.  This is completely normal, is a common practice and code style.  Moreover, the code is written on the assumption that the compiler knows this very well and will remove unnecessary code. </li><li>  An uninitialized class member in the default constructor.  Sometimes this is really a mistake, but in some cases it is acceptable. </li><li>  Raw exception in the main function in the test program.  This allows our style.  If an exception crashes out of the main function, it will be processed using std :: terminate, the standard library will do a few useful things for you (verbose terminate handler): it will output an exception type, for successors, std :: exception will output what, call abort;  the program will receive an abort signal, the operating system will write a core dump, and the program will end with a non-zero code.  All this is very useful. </li></ul><br><p>  In addition, one of the errors looked like an <code>Unrecoverable parse error</code> at the sight of std :: shared_mutex.  This means that Coverity does not support C ++ 17. </p><br><h3 id="svace">  Svace </h3><br><p>  November 30, 2016 I got to the conference <a href="http://ospcon.osp.ru/tbd_dbms2017/">"Database Technology"</a> , where I was able to agree with colleagues from ISP RAS about using their static analysis tool Svace.  This tool is implemented in the Samsung Corporation, but is little known among domestic programmers. </p><br><p>  The analysis results are available in a convenient web interface with viewing the source code and annotations to it.  The most serious error detected is the absence of freeaddrinfo <a href="https://github.com/yandex/ClickHouse/commit/861684c5544970a2db9e8cdf2f3fabe4e0659c4e">in one of the code branches</a> .  It is worth noting that both the results of the analysis and the sampling of defects for study were provided by colleagues from ISP RAS. </p><br><h3 id="vyvody">  findings </h3><br><p>  Using static analyzers is not the first important measure to improve the code of your product.  For example, if you do not have auto-assembly with running tests at least under Address Sanitizer, it will be more useful to ensure this first.  Analysis of the results of the work of static analyzers requires a large amount of time, at least at the very beginning.  Proper use requires integration into the CI system.  Only if you have done simpler things - you can try such a wonderful thing as static analyzers.  But why should I discourage you - try it for sure! </p><br><p>  Finally, I would like to thank once again the colleagues from PVS-Studio for the work they are doing, in particular, for the article dedicated to ClickHouse.  They not only helped us by finding a few important problems in our code, but also inspired research that this article is about. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342018/">https://habr.com/ru/post/342018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342008/index.html">Mars IS expands the functionality of the operational analysis platform SPLUNK</a></li>
<li><a href="../342010/index.html">Russian-speaking crowdfunding got a new service similar to the American Patreon.com</a></li>
<li><a href="../342012/index.html">Escape from the nest of success or the problems of large companies</a></li>
<li><a href="../342014/index.html">MVP is not a draft! Right?</a></li>
<li><a href="../342016/index.html">Scratch - we tighten up mathematics, we develop self-control</a></li>
<li><a href="../342020/index.html">Basic installation and configuration of Puppet 4 with storage of manifests in SVN</a></li>
<li><a href="../342022/index.html">Clouds from an unknown country. Cloud FAQ</a></li>
<li><a href="../342024/index.html">Overview of the new version of Infobox hosting</a></li>
<li><a href="../342026/index.html">How black SEO-optimizers collect millions of visitors on highly relevant queries in Yandex</a></li>
<li><a href="../342028/index.html">Space photography of the Earth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>