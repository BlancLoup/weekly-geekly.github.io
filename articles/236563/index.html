<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Legitimate backdoor in distributing corporate Windows Store apps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In this article, we share experiences on the distribution of corporate applications for Windows Store. 

 We have a client. An excellent cus...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Legitimate backdoor in distributing corporate Windows Store apps</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  In this article, we share experiences on the <b>distribution of corporate applications for Windows Store.</b> <br><br>  We have a client.  An excellent customer for whom we have created, implemented and continue to develop a large portal solution for remote agent service.  About a year ago, it was decided to create a mobile workplace for an employee based on Windows 8 tablets. <br>  But creating an application is only one task.  It was necessary to think over the next step: it should be installed on the tablets of the customer company and go to Russia, because the end users are company representatives in different regions.  At the same time, there should be a mechanism for updating the applications, because without this, you understand, nowhere. <br><a name="habracut"></a><br>  At the testing stage, you can use the application for one month by installing a developer license, which we did ( <a href="http://msdn.microsoft.com/ru-ru/library/windows/apps/hh974578.aspx">link</a> ).  But once it comes time to launch the application in life.  We considered various options: <br><br><ol><li>  <b>Distribution through the app store.</b> <br>  The method seems tempting: we release an application in which the functionality ‚Äúfor our own people‚Äù is protected by a password, and only employees can use the application for its intended purpose.  But such distribution violates the rules of publication in the app store.  There is a high probability to receive a review in response (as it happened with iOS applications): <br>  <i>2.12 We found that your app is a limited company, or set of users - your company.</i> </li><li>  <b>The use of computer management software organizations</b> , such as Windows Intune ( <a href="http://www.microsoft.com/ru-ru/server-cloud/products/windows-intune/">link</a> ), Air-Watch ( <a href="http://www.air-watch.com/solutions/windows-pc-rt">link</a> ). <br>  These are serious decisions that require additional costs for their purchase and configuration;  in addition, they should be taken into use by the company's IT services.  The use of these systems undoubtedly solves almost all the problems of remote control and monitoring of devices, but at the moment the customer was not ready to configure and use these systems. </li><li>  <b>As in many cases, there is a way, just need a little search</b> ... </li></ol><br><h4>  Update Installer </h4><br>  We decided to try to cope with the task ourselves and <s>invent a bike</s> to create a program that helps to customize the OC before installing the application, directly install and update our application with the Modern UI interface. <br>  The fact is that corporate tablets that are used in the company were x86 with Windows 8 Professional installed.  This architecture allows you to run not only applications from the store, but also ‚Äúgood old‚Äù programs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the algorithm would seem to be standard: <br><ol><li>  The user gets the installer and installs the classic update program. </li><li>  The program checks the availability of the new version of the application, and if there is one, it downloads the finished package. </li><li>  The program deploys the package and runs the installation script. </li><li>  And the application is installed / updated. </li></ol><br><br><h4>  Sideloading </h4><br>  But, as usual, not everything is so smooth - there are nuances.  There is another difficulty that Microsoft created for us and which had to be bypassed: on some system configurations, the installation of applications is completely blocked.  Applications cannot be installed if the group policy settings are not set to ‚ÄúAllow trusted apps to install‚Äù.  In this case, the setting itself is not available for some platforms.  Details of the sideloading mechanism ( <a href="http://technet.microsoft.com/en-us/library/hh852635.aspx">here</a> ). <br><br>  Application installation is available if: <br><br>  For Windows 8 Enterprise, Windows 8 Professional: <br><ul><li>  The computer must be in the domain. </li><li>  In the group policy settings is set to "Allow trusted apps to install". </li></ul><br>  For Windows 8 Enterprise, Windows 8 Professional, Windows RT operating systems: <br><ul><li>  A special sideloading key must be activated on the computer.  The sideloading key is a 25-digit key (similar to an activation key for Windows). </li><li>  In the group policy settings is set to "Allow trusted apps to install". </li></ul><br>  In the variant with the addition of computers to the domain, we were denied, but the key for sideloading activation was provided. <br>  What does the key installation and policy setting for the user look like?  Maybe the installation instructions sent along with the key solve the problem? <br><blockquote><ol><li>  First, install the sideloading key.  Open a command prompt as an administrator and enter the commands: <br>  slmgr / ipk &lt;sideloding key is here ...&gt; <br>  slmgr / ato ec67814b-30e6-4a50-bf7b-d55daf729d1e </li><li>  Open the local group policy editor (Start -&gt; gpedit.msc).  Find the folder N and change the value of X. </li><li>  ... </li></ol></blockquote><br>  In general, the process for an inexperienced user looks nontrivial, something needs to be done about it.  Therefore, we will try to use our installer and automate the process. <br><br><h4>  Putting it all together </h4><br>  So, the proposed solution - the installer program - works as follows: is distributed as an .msi file (mailing list among employees), is installed into the system and works according to the following algorithm: <br><br><img src="https://habrastorage.org/files/7ab/82a/be3/7ab82abe3d2643a5af01ccdb7558a2ce.png"><br><br>  After installation, the program is minimized to tray and immediately starts an automatic check for updates.  If the application is not installed, the following message appears in the tray: <br><br><img src="https://habrastorage.org/files/732/56e/18c/73256e18c8904885add796f7b24e5dd2.png"><br><br>  We click on it, the form itself appears, on which there is a brief description of the application, an information window, a progress bar and buttons.  In the information window there can be inscriptions of the type: ‚ÄúAn update is available ...‚Äù, ‚ÄúApplication installation ...‚Äù, etc. <br><br><img src="https://habrastorage.org/files/6dd/4b0/dd2/6dd4b0dd2e7e44fcb2f416104938cfbf.png"><br><img src="https://habrastorage.org/files/203/db1/9bb/203db19bbf644a7c89c05ea3ab9c1933.png"><br><img src="https://habrastorage.org/files/7f2/cf1/f08/7f2cf1f08fea4457b338ac0340ab8f16.png"><br><br>  After installation, the application is in the tray and periodically (several times a day) requests the server for updates.  If updates are available, the application notifies the user. <br><br>  It makes sense to focus a little on the <b>technical implementation of some parts of the program.</b> <br><br><h4>  Code examples </h4><br><div class="spoiler">  <b class="spoiler_title">Group Policy Setup</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetGroupPolicy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = Registry.LocalMachine.CreateSubKey(<span class="hljs-string"><span class="hljs-string">@"Software\Policies\Microsoft\Windows\Appx"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶‚Ä¶ key.SetValue("AllowAllTrustedApps", 1, Microsoft.Win32.RegistryValueKind.DWord); }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Installing Sideloading Key</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> InstallSideloadingKey() { // ,    sideloading key <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsSideloadKeyInstalled()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process() { StartInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo() { FileName = @"C:\Windows\System32\slmgr.vbs", }, }; //   p.StartInfo.Arguments = "/ipk " + _sideloadingKey; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); p.SuppressPopups(); p.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); //   p.StartInfo.Arguments = "/ato ec67814b-30e6-4a50-bf7b-d55daf729d1e"; p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); p.SuppressPopups(); p.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Verify that the key is installed</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">private static <span class="hljs-type"><span class="hljs-type">bool</span></span> IsSideloadKeyInstalled() { // ,           //  sideloading key. <span class="hljs-type"><span class="hljs-type">bool</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; Process p = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Process() { StartInfo = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ProcessStartInfo() { FileName = @"C:\Windows\System32\slmgr.vbs", }, }; p.StartInfo.Arguments = "/dlv"; //          . p.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; (i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) &amp;&amp; (!p.HasExited); i++) { p.<span class="hljs-keyword"><span class="hljs-keyword">Refresh</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p.MainWindowHandle.ToInt32() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { var list = WindowsHelper.GetChildWindows(p.MainWindowHandle); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(var ptr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list) { string windowText = WindowsHelper.GetText(ptr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(windowText.Contains("APPXLOB") &amp;&amp; windowText.Contains(_sideloadingKeyPart)) { result = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } //       WindowsHelper.CloseWindow(p.MainWindowHandle); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); } p.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Install Application Package</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateApp(string appxPath) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(appxPath)) { //    .appxbundle" return; } // //   string command = @"/C powershell <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-AppxPackage "; command += appxPath; //      ? var package = PackageHelper.GetPackage(); if (package != null) { //    -   command += " -<span class="hljs-keyword"><span class="hljs-keyword">Update</span></span>"; } Process p = new Process() { StartInfo = new ProcessStartInfo() { WorkingDirectory = @"C:\", FileName = "cmd.exe", Arguments = command, RedirectStandardOutput = true, UseShellExecute = false, }, EnableRaisingEvents = true, }; p.Exited += (s, e) =&gt; { //     var pr = s as Process; string text = pr.StandardOutput.ReadToEnd(); if (String.IsNullOrEmpty(text)) { //   .    . else //     . }; p.Start(); // Start process p.WaitForExit(); }</code> </pre><br></div></div><br><br><h4>  Conclusion </h4><br>  The described method of distribution is, of course, very confusing.  There are methods for distributing Windows 8 applications much more accurate and convenient.  But the conditions in which we were put, forced us to solve the problem in this way.  With this solution, you and the customer will not have to buy and configure any third-party systems;  You will not load the user with complex application installation algorithms;  You will not have reason to fear that the application will not pass certification. </div><p>Source: <a href="https://habr.com/ru/post/236563/">https://habr.com/ru/post/236563/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236553/index.html">29% of Russians believe that online services reliably protect their passwords</a></li>
<li><a href="../236555/index.html">Free .me domain for a year in 15 minutes</a></li>
<li><a href="../236557/index.html">CADR hackerspace: Made with secret technology</a></li>
<li><a href="../236559/index.html">Automate the creation and editing of used source lists with Mendeley</a></li>
<li><a href="../236561/index.html">Automated testing is easy! How I tested Pechkina</a></li>
<li><a href="../236565/index.html">Survey: do you work better than your average colleague?</a></li>
<li><a href="../236567/index.html">How to easily make Navigation Drawer and tabs used in popular applications from Google</a></li>
<li><a href="../236569/index.html">Creating a simple program with RMI and parallel access to a GUI in Java</a></li>
<li><a href="../236573/index.html">Laziness - the engine of progress or my option to create an environment for web development based on VirtualBox</a></li>
<li><a href="../236575/index.html">Azure Business Talks technology talk show - not only about Azure, but also about clouds in general</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>