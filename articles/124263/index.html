<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic installation of FreeBSD 8.2-RELEASE on ZFS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We all know that from time to time it is very rare, almost never, but a situation arises in which an unplanned reset or power failure of the FreeBSD s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic installation of FreeBSD 8.2-RELEASE on ZFS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/9fc287c3/02d09299/c2e23346/fc0a145a.png" align="left">  We all know that <s>from time to time it is</s> very rare, almost never, but a situation arises in which an unplanned reset or power failure of the FreeBSD server causes the download to stop with the persistent demand to start fsck by hand.  It happens that the server has been bored, the admin has not visited him for a long time, and what a full moon can, but this phenomenon occurs in nature.  The time has come, I think, to move to ZFS - the people recommend, the beta test stage has long passed, disk space is not wasted, and ... ZFS does not need the fsck utility to check the integrity of the file system (!).  Having studied mana, wiki, lissaru, he came to the conclusion that it is necessary to pierce, brush and lacquer in some places with a rasp and go to the masses.  Indeed, the process, compared to the standard sysinstall, is somewhat difficult, but fast as never before - 2 minutes and the server with the root partition on ZFS is ready. <br><a name="habracut"></a><br>  Yes, of course, we will not run with our hands the whole pack of commands that we recommend to run, and we will not bother with sysinstall, but we will create an automatic installation script that we will run from <b>Fixit</b> mode.  To do this, you need a DVD or USBstick installation option, the server where the script is stored (available via ssh). <br>  The installation process looks like this: boot, select the <b>Fixit - CD / DVD</b> mode, hang the IP on the network card and run the script: <br><blockquote>  <b>Fixit #</b> <font color="#000080">ifconfig em0 192.168.1.100/24</font> <br>  <b>Fixit #</b> <font color="#000080">ssh user@192.168.1.1 'cat / opt / script / zfs-init' |</font>  <font color="#000080">sh</font> <br></blockquote><br>  Now turn to the contents of the script, it should do the following: <br>  1. Mark the disk (GPT - boot, swap0, disk0) <br>  2. Create a ZFS pool (/ root, / tmp, / usr, / var, / opt) - the / root partition was made separately, it can also be limited in size <br>  3. Throw a fryahu with minimal configs to start on ZFS <br><br>  A script on the shell, just a list of commands in a certain sequence.  At the beginning of the script, change the variables dev (disk), iface (network card), tank (ZFS pool name), hostname (host name), tz (timezone).  Here he is: <br><blockquote><ol><li>  <font color="#666666">#! / bin / sh</font> </li><li></li><li>  <font color="#666666"># Wars</font> </li><li>  <font color="#007800">dev</font> = da0 </li><li>  <font color="#007800">tank</font> = tank </li><li>  <font color="#007800">iface</font> = em0 </li><li>  <font color="#007800"><font color="#c20cb9">hostname</font></font> = core.domain.com </li><li>  <font color="#007800">tz</font> = <font color="#ff0000">"Europe / Kiev"</font> </li><li></li><li>  <font color="#666666"># gpart</font> </li><li>  gpart create <font color="#660033">-s</font> GPT <font color="#007800">$ dev</font> </li><li>  gpart add <font color="#660033">-s</font> 64K <font color="#660033">-t</font> freebsd-boot <font color="#007800">$ dev</font> </li><li>  gpart add <font color="#660033">-s</font> 2G <font color="#660033">-t</font> freebsd-swap <font color="#660033">-l</font> swap0 <font color="#007800">$ dev</font> </li><li>  gpart add <font color="#660033">-t</font> freebsd-zfs <font color="#660033">-l</font> disk0 <font color="#007800">$ dev</font> </li><li></li><li>  gpart bootcode <font color="#660033">-b</font> <font color="#000000">/</font> mnt2 <font color="#000000">/</font> boot <font color="#000000">/</font> pmbr <font color="#660033">-p</font> <font color="#000000">/</font> mnt2 <font color="#000000">/</font> boot <font color="#000000">/</font> gptzfsboot <font color="#660033">-i</font> <font color="#000000">1</font> <font color="#007800">$ dev</font> </li><li></li><li>  sysctl kern.geom.debugflags = 0x10 </li><li></li><li>  <font color="#666666"># install ZFS</font> </li><li>  kldload <font color="#000000">/</font> mnt2 <font color="#000000">/</font> boot <font color="#000000">/</font> kernel <font color="#000000">/</font> opensolaris.ko </li><li>  kldload <font color="#000000">/</font> mnt2 <font color="#000000">/</font> boot <font color="#000000">/</font> kernel <font color="#000000">/</font> zfs.ko </li><li></li><li>  <font color="#c20cb9">mkdir</font> <font color="#000000">/</font> boot <font color="#000000">/</font> zfs </li><li>  <font color="#666666">#rere ZFS pool</font> </li><li>  zpool create <font color="#660033">-f</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> dev <font color="#000000">/</font> gpt <font color="#000000">/</font> disk0 </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = none <font color="#007800">$ tank</font> </li><li></li><li>  zfs <font color="#000000">set</font> <font color="#007800">atime</font> = off <font color="#007800">$ tank</font> </li><li>  zfs <font color="#000000">set</font> <font color="#007800">checksum</font> = fletcher4 <font color="#007800">$ tank</font> </li><li>  zfs create <font color="#660033">-o</font> <font color="#007800">compression</font> = off <font color="#660033">-o</font> <font color="#007800"><font color="#7a0874">exec</font></font> = on <font color="#007800">$ tank</font> <font color="#000000">/</font> root </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> root </li><li>  zpool <font color="#000000">set</font> <font color="#007800">bootfs</font> = <font color="#007800">$ tank</font> <font color="#000000">/</font> root <font color="#007800">$ tank</font> </li><li>  zfs create <font color="#660033">-o</font> <font color="#007800">compression</font> = on <font color="#660033">-o</font> <font color="#007800"><font color="#7a0874">exec</font></font> = on <font color="#660033">-o</font> <font color="#007800">setuid</font> = off <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp </li><li>  zfs create <font color="#007800">$ tank</font> <font color="#000000">/</font> usr </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> usr <font color="#007800">$ tank</font> <font color="#000000">/</font> usr </li><li>  zfs create <font color="#007800">$ tank</font> <font color="#000000">/</font> var </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> var <font color="#007800">$ tank</font> <font color="#000000">/</font> var </li><li>  zfs create <font color="#660033">-o</font> <font color="#007800">compression</font> = off <font color="#660033">-o</font> <font color="#007800">setuid</font> = off <font color="#007800">$ tank</font> <font color="#000000">/</font> opt </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> opt <font color="#007800">$ tank</font> <font color="#000000">/</font> opt </li><li></li><li>  <font color="#7a0874">cd</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> ;  <font color="#c20cb9">ln</font> <font color="#660033">-s</font> <font color="#000000">/</font> usr <font color="#000000">/</font> home home <font color="#000000">&amp;&amp;</font> <font color="#7a0874">cd</font> - </li><li>  <font color="#c20cb9">mkdir</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> var <font color="#000000">/</font> tmp </li><li>  <font color="#c20cb9">chmod</font> <font color="#000000">1777</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> var <font color="#000000">/</font> tmp <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp </li><li></li><li>  <font color="#666666"># install base system</font> </li><li>  <font color="#7a0874">cd</font> <font color="#000000">/</font> dist <font color="#000000">/</font> <font color="#000000">8.2</font> - <font color="#000000">*</font> </li><li>  <font color="#7a0874">export</font> <font color="#007800">DESTDIR</font> = <font color="#000000">/</font> <font color="#007800">$ tank</font> </li><li>  <font color="#000000">for</font> <font color="#c20cb9">dir</font> <font color="#000000">in</font> base catpages dict doc info lib32 manpages;  <font color="#000000">do</font> <font color="#7a0874">(</font> <font color="#7a0874">cd</font> <font color="#007800">$ dir</font> ; <font color="#7a0874">echo</font> <font color="#ff0000">"y"</font> <font color="#000000">|</font> . <font color="#000000">/</font> install.sh <font color="#7a0874">)</font> ;  <font color="#000000">done</font> </li><li>  <font color="#7a0874">cd</font> src;  .  <font color="#000000">/</font> install.sh all </li><li>  <font color="#7a0874">cd</font> .. <font color="#000000">/</font> kernels;  .  <font color="#000000">/</font> install.sh generic </li><li>  <font color="#7a0874">cd</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> boot;  <font color="#c20cb9">cp</font> <font color="#660033">-Rlp</font> GENERIC <font color="#000000">/ *</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> boot <font color="#000000">/</font> kernel <font color="#000000">/</font> </li><li></li><li>  <font color="#666666"># install base configs</font> </li><li>  <font color="#c20cb9">cat</font> <font color="#000000">&lt;&lt;</font> EOF <font color="#000000">&gt;</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> etc <font color="#000000">/</font> rc.conf </li><li>  <font color="#007800">zfs_enable</font> = <font color="#ff0000">"YES"</font> </li><li>  <font color="#007800"><font color="#c20cb9">hostname</font></font> = <font color="#ff0000">" <font color="#007800">$ hostname</font> "</font> </li><li>  ifconfig_ <font color="#007800">$ iface</font> = <font color="#ff0000">"DHCP"</font> </li><li>  <font color="#007800">sshd_enable</font> = <font color="#ff0000">"YES"</font> </li><li>  <font color="#007800">ntpd_enable</font> = <font color="#ff0000">"YES"</font> </li><li>  <font color="#007800">ntpd_program</font> = <font color="#ff0000">"/ usr / sbin / ntpd"</font> </li><li>  <font color="#007800">ntpd_flags</font> = <font color="#ff0000">"-p /var/run/ntpd.pid -f /var/db/ntpd.drift"</font> </li><li>  EOF </li><li></li><li>  <font color="#c20cb9">cat</font> <font color="#000000">&lt;&lt;</font> EOF <font color="#000000">&gt;</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> etc <font color="#000000">/</font> ntp.conf </li><li>  server 82.207.71.6 iburst maxpoll <font color="#000000">9</font> </li><li>  server 91.198.10.4 iburst maxpoll <font color="#000000">9</font> </li><li>  server 79.142.192.4 iburst maxpoll <font color="#000000">9</font> </li><li>  server 193.193.193.107 iburst maxpoll <font color="#000000">9</font> </li><li>  EOF </li><li></li><li>  <font color="#7a0874">echo</font> <font color="#ff0000">'zfs_load = "YES"'</font> <font color="#000000">&gt;</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> boot <font color="#000000">/</font> loader.conf </li><li>  <font color="#7a0874">echo</font> <font color="#ff0000">"vfs.root.mountfrom = <font color="#000099">\"</font> zfs: <font color="#007800">$ tank</font> / root <font color="#000099">\ "</font> "</font> <font color="#000000">&gt;&gt;</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> boot <font color="#000000">/</font> loader.conf </li><li></li><li>  <font color="#c20cb9">cp</font> <font color="#000000">/</font> mnt2 <font color="#000000">/</font> usr <font color="#000000">/</font> share <font color="#000000">/</font> zoneinfo <font color="#000000">/</font> <font color="#007800">$ tz</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> etc <font color="#000000">/</font> localtime </li><li>  <font color="#c20cb9">cp</font> <font color="#000000">/</font> boot <font color="#000000">/</font> zfs <font color="#000000">/</font> zpool.cache <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> boot <font color="#000000">/</font> zfs <font color="#000000">/</font> zpool.cache </li><li></li><li>  <font color="#c20cb9">cat</font> <font color="#000000">&lt;&lt;</font> EOF <font color="#000000">&gt;</font> <font color="#000000">/</font> <font color="#007800">$ tank</font> <font color="#000000">/</font> etc <font color="#000000">/</font> fstab </li><li>  <font color="#666666"># Device Mountpoint FStype Options Dump Pass #</font> </li><li>  <font color="#000000">/</font> dev <font color="#000000">/</font> gpt <font color="#000000">/</font> swap0 none swap sw <font color="#000000">0</font> <font color="#000000">0</font> </li><li>  procfs <font color="#000000">/</font> proc procfs rw <font color="#000000">0</font> <font color="#000000">0</font> </li><li>  EOF </li><li></li><li>  <font color="#7a0874">export</font> <font color="#007800">LD_LIBRARY_PATH</font> = <font color="#000000">/</font> mnt2 <font color="#000000">/</font> lib </li><li></li><li>  <font color="#7a0874">cd</font> <font color="#000000">/</font> </li><li></li><li>  <font color="#666666"># correct ZFS mount points and quotas</font> </li><li>  zfs unmount <font color="#660033">-a</font> </li><li>  zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> opt <font color="#007800">$ tank</font> <font color="#000000">/</font> opt </li><li>  zfs <font color="#000000">set</font> <font color="#007800">quota</font> = 1G <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp <font color="#000000">&amp;&amp;</font> zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> tmp <font color="#007800">$ tank</font> <font color="#000000">/</font> tmp </li><li>  zfs <font color="#000000">set</font> <font color="#007800">quota</font> = 5G <font color="#007800">$ tank</font> <font color="#000000">/</font> usr <font color="#000000">&amp;&amp;</font> zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> usr <font color="#007800">$ tank</font> <font color="#000000">/</font> usr </li><li>  zfs <font color="#000000">set</font> <font color="#007800">quota</font> = 10G <font color="#007800">$ tank</font> <font color="#000000">/</font> var <font color="#000000">&amp;&amp;</font> zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = <font color="#000000">/</font> var <font color="#007800">$ tank</font> <font color="#000000">/</font> var </li><li>  zfs <font color="#000000">set</font> <font color="#007800">quota</font> = 512m <font color="#007800">$ tank</font> <font color="#000000">/</font> root <font color="#000000">&amp;&amp;</font> zfs <font color="#000000">set</font> <font color="#007800">mountpoint</font> = legacy <font color="#007800">$ tank</font> <font color="#000000">/</font> root </li></ol></blockquote><br>  While the script is running, you do not need to touch the keyboard, after finishing just restart the server, and log in with root without a password. <br><br>  Materials: <a href="http://wiki.freebsd.org/RootOnZFS/GPTZFSBoot">RootOnZFS / GPTZFSBoot</a> , <a href="http://www.lissyara.su/articles/freebsd/file_system/root_zfs_gpt/">Installing FreeBSD using ZFS as the main one</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Good luck </div><p>Source: <a href="https://habr.com/ru/post/124263/">https://habr.com/ru/post/124263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124257/index.html">RIM goes for broke</a></li>
<li><a href="../124258/index.html">Multiplication of long numbers by the Karatsuba method</a></li>
<li><a href="../124260/index.html">Infographics. If social networks were schoolchildren</a></li>
<li><a href="../124261/index.html">Brand reversion</a></li>
<li><a href="../124262/index.html">Where to get capital to budding entrepreneurs</a></li>
<li><a href="../124264/index.html">Mail-en agent in Linux</a></li>
<li><a href="../124265/index.html">Microsoft opened its social service?</a></li>
<li><a href="../124266/index.html">Using Zend GData in a symfony2 project</a></li>
<li><a href="../124267/index.html">XSS vulnerability in Skype</a></li>
<li><a href="../124268/index.html">Smart switches based on the 8051 core, controlled by Ethernet, Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>