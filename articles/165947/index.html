<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a new file format for backup sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now I am working on a new PHP-script that will back up not only the database, but also all the files of the site. 

 It was originally planned to use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a new file format for backup sites</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/9fc/196/70b/9fc19670b421fd9501b7513052e00708.jpg" align="left">  Now I am working on a new PHP-script that will back up not only the database, but also all the files of the site. <br><br>  It was originally planned to use one of the common archive formats.  In this case, the first thing that comes to mind is ZIP and TAR.  There are many ready-made classes for them, and the ZIP extension is even included in the standard PHP distribution.  But having studied the specifications of the formats, and also tried out ready-made solutions, I was inclined to invent my own bicycle. <br><br>  Request "cycloheaters" to refrain from comments in the style of "enough for us to bike."  In the end, without the creation of "bikes" there would be neither Google, nor Google Chrome, nor Facebook, nor WinRAR and 7-Zip. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Why not tar? </h4><br>  TAR is the most common format in unix-systems.  And without any hesitation, the administrator will write himself for backup files or copy one of the many ready-made scripts from the Internet that use the tar system program.  But TAR was developed a long time ago, and besides, it was originally intended to create archives on tape.  In this regard, he has the following disadvantages. <br><br><h5>  No index </h5>  In the TAR there is no directory with the contents of the archive.  Therefore, to view the contents of the archive, you need to scan the archive, walking through all the file headers.  That on large archives can take considerable time. <br><br><h5>  Cannot use offset (fseek) inside the container </h5>  Since TAR does not support compression, it is usually completely compressed with gzip or bzip2.  In this regard, if you need to get the file from the end of the archive, then you need, in fact, unpack all the compressed data from the archive, until we reach the desired file. <br><br><h5>  Cannot record stream to archive </h5>  As in TAR, the file size is stored in the file header (without it, we will not be able to find the next file header).  That we can not directly write to the archive stream (ie, still non-existent file, the size of which is initially unknown).  Therefore, when backing up the same MySQL, first they make a separate database dump, and only then it is packaged with TAR along with the rest of the files. <br><br><h5>  No file integrity control </h5>  Checksums are not stored for files. <br><br><h4>  Why not ZIP? </h4><br>  ZIP is the most common format on Windows, and, perhaps, in general in the world.  He, like TAR, is from the 80s, but it was last updated in 2007.  It has missing in the TAR index, the ability to quickly navigate through the container, control the integrity of files, even a stream recording.  But he also has flaws. <br><br><h5>  No support for continuous (solid) archives </h5>  What is very bad for compressibility, when a lot of small files. <br><br><h5>  Time is stored in MS-DOS format. </h5>  This means that dates are stored with an accuracy of 2 seconds, plus in the case of PHP, these are redundant conversions from unix timestamp to MS-DOS format and back. <br><br><h5>  No encryption of file names in the archive </h5>  Encrypted only the contents of the files, headers and the central directory in clear text. <br><br>  In principle, the flaws are much less significant than those of TAR, and I was about to use ZIP.  But the situation was overshadowed by the fact that some advanced features (stream recording, unix file attributes), ready-made libraries, including the standard ZipArchive class, do not support.  And, therefore, for their support I would have to write my own implementation of the ZIP. <br><br>  In general, I decided to consider other options.  After googling, it was possible to find documentation on the RAR, 7Z, DAR, ACE formats, and also poked around the slightly closed CBU and TIB.  In the process of thought crept in building your own bike. <br><img src="https://habrastorage.org/storage2/14f/190/1d0/14f1901d0e878424f2f2642569542a02.jpg"><br><h4>  New file format for backup sites </h4><br>  So, the new format (without thinking twice about it was called SXB from Sypex Backup) is a compilation of ideas spied on in various formats plus a few of its own. <br><br>  The main tasks that were set during the development of the SXB format: <br><ul><li>  Block data deduplication </li><li>  Incremental backup at block level </li><li>  Save streams to archive </li><li>  Additional data types (not just files and directories) </li><li>  Continuous archive </li><li>  Index Availability </li><li>  Quick random access to content </li><li>  It may contain both compressed and uncompressed data (for badly compressible files, such as photos, archives, etc.) </li><li>  Multi-volume </li><li>  Encryption of both content and file headers </li><li>  Versioning support </li><li>  Content integrity control </li></ul><br>  Also, the development takes into account the specificity of PHP for working with files larger than 2 GB. <br>  I will describe some points in more detail. <br><br><h4>  Block data deduplication </h4><br>  Data deduplication is a technology with the help of which duplicate data is excluded from the archive, which allows reducing its size.  There is file-level and block-level deduplication.  In the first case, the file hashes are compared, in the second - the hashes of individual file blocks. <br><br>  Block deduplication was chosen for the SXB format as it is better suited for backup sites.  For example, this allows for incremental backups that are constantly growing, logs or database tables to save them not completely, but only a small block with the added data. <br><br><h5>  Save streams to archive </h5><br>  This feature is needed so that the MySQL backup can be saved directly to the archive, without creating temporary files.  That, in addition to speeding up work, reduces the requirements for free space, and also allows deduplication to be applied at the level of individual tables, rather than the entire SQL file. <br><br><h5>  Additional data types </h5><br>  It is difficult to imagine a modern site that does not use a database.  And since a new format is being developed, the idea arose of moving away from the standard MySQL backup to an SQL file. <br><br>  In the SXB format, in addition to files and directories, special data types have been added for database backup (table structure, table contents, triggers, functions, etc.).  The structure of MySQL objects will be stored in the form of the corresponding CREATE queries, and the contents of the tables - in the form of text with tabs as a separator (this format is more compact and allows you to dump / restore data much faster). <br><br>  In general, I‚Äôm getting round on this, or I‚Äôve already written a lot, if I‚Äôm interested I can add more technical details. <br><br><h4>  And now about what the article was about. </h4><br>  I wanted to check deduplication on real sites.  Of those large sites that were on hand, one on a private engine (206 MB), the second on vbulletin (934 MB), deduplication showed very encouraging results. <br><img src="https://habrastorage.org/storage2/bcf/d7c/bd7/bcfd7cbd76b18cc6164c362b03e00d35.png"><br>  <i>WinRAR was launched in continuous archive mode (the file is faster and more compact).</i>  <i>For 7-Zip, the old LZMA algorithm was tested, and the new LZMA2 that loads all 4 processor cores.</i>  <i>PHP 5.4.10 was used under Win 7 x64.</i> <br><br>  Yes, of course, with maximum compression, WinRAR and 7-Zip will show higher compression, but at the same time they eat gigabytes of memory and fully load all 4 cores for a considerable time.  In principle, it is not necessary to deal with them by the degree of compression, there is a slightly different task.  But the fact that the php script can show similar results to multi-threaded programs is encouraging. <br><br>  <b>Those who want to help in development, and who are just wondering how many duplicates are on your site, please <a href="">protest a special simplified PHP script</a> .</b> <br><br>  Interested in the number of data deduplication excluded, dimensions and preferably a comparison with other archivers (size and time, mode, the fastest one).  As a result, the following info is issued: <br><pre><code class="php hljs">dirs <span class="hljs-number"><span class="hljs-number">162</span></span> files <span class="hljs-number"><span class="hljs-number">6811</span></span> full_size <span class="hljs-number"><span class="hljs-number">206.133</span></span> dup_size <span class="hljs-number"><span class="hljs-number">28.721</span></span> archive_size <span class="hljs-number"><span class="hljs-number">152.277</span></span> duplicates <span class="hljs-number"><span class="hljs-number">3119</span></span> bigfiles <span class="hljs-number"><span class="hljs-number">477</span></span> bf_blocks <span class="hljs-number"><span class="hljs-number">5220</span></span> bf_dup <span class="hljs-number"><span class="hljs-number">316</span></span> bf_size <span class="hljs-number"><span class="hljs-number">154.426</span></span> bf_dup_size <span class="hljs-number"><span class="hljs-number">8.027</span></span> time <span class="hljs-number"><span class="hljs-number">13.53622</span></span></code> </pre> <br>  And finally, as reference information, links to format specifications. <br>  <a href="http://www.pkware.com/documents/casestudies/APPNOTE.TXT">ZIP File Format Specification</a> <br>  <a href="http://www.gnu.org/software/tar/manual/html_node/Standard.html">TAR File Format Specification</a> <br>  <a href="http://www.forensicswiki.org/w/images/5/5b/RARFileStructure.txt">RAR File Format Specification</a> <br>  <a href="http://darbinding.sourceforge.net/specs/7zFormat.txt">7Z File Format Specification</a> <br>  <a href="http://darbinding.sourceforge.net/specs/darK06.html">DAR File Format Specification</a> <br>  <a href="http://darbinding.sourceforge.net/specs/ACE.txt">ACE File Format Specification</a> </div><p>Source: <a href="https://habr.com/ru/post/165947/">https://habr.com/ru/post/165947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165931/index.html">Dusting eyes or how to get more development orders</a></li>
<li><a href="../165935/index.html">NASA - weekly review of events (now in Russian)</a></li>
<li><a href="../165937/index.html">i Janitor or laziness as an engine of progress</a></li>
<li><a href="../165939/index.html">Facebook introduced smart search - Graph Search</a></li>
<li><a href="../165943/index.html">Alternative WPF language JAML = XAML - XML ‚Äã‚Äã+ JSON</a></li>
<li><a href="../165949/index.html">Habraslivki: golden posts "Habrahabra" and Geektimes</a></li>
<li><a href="../165951/index.html">Thermometer, joystick and laptop in the same cabinet, not counting arduino</a></li>
<li><a href="../165953/index.html">What can the Dalai Lama teach us about absolute negative temperatures?</a></li>
<li><a href="../165955/index.html">Overview of the new features of System Center 2012 SP1</a></li>
<li><a href="../165959/index.html">Using D-Bus in web systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>