<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grails, jQuery, AJAX: do anchor-navigation. Part 2 final</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Complete and incomplete pages 
 We continue to talk about anchor-navigation . Our goal is to make a working application on Grails. 

 There is one sub...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grails, jQuery, AJAX: do anchor-navigation. Part 2 final</h1><div class="post__text post__text-html js-mediator-article"><h3>  Complete and incomplete pages </h3><br>  We continue to <a href="http://habrahabr.ru/blogs/groovy_grails/108611/">talk about anchor-navigation</a> .  Our goal is to make a working application on Grails. <br><br>  There is one subtlety.  I really want the page to be shown in full version (with a header, navigation, etc.), and in the shortened version (for AJAX-calls).  However, typing <strong>/ my-app / do / receipts</strong> , we get the <em>full</em> version.  Now it looks like this: <br><img src="https://habrastorage.org/storage/289582b2/f2b912f6/1b7bffb6/3b1db8c0.jpg"><a name="habracut"></a><br>  Oops!  We must somehow distinguish the situation when the page is the main one and when it is internal.  To do this, we write a small filter: <br><br> <code>grails-app/conf/PartialPageLoadFilters.groovy</code> <br> <pre> <code class="hljs ruby"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filters</span></span></span><span class="hljs-function"> = { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">controller:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"*"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">action:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"*"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { before = { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  AJAX-? <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.xhr) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     . request.partialPage = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } }</code> </pre><br>  Note the use of the magic attribute <strong>request.xhr</strong> provided by Grails.  Its presence means that the current request is invoked via AJAX.  Most browsers report this to the server through a special HTTP-Header.  Above, I simply declared all AJAX requests to be "internal"; in a real application, the situation can be more complicated. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now I can use the <strong>request.partialPage</strong> flag everywhere.  You can make a separate layout for the internal pages, but I preferred to just stupidly make such inserts into the main layout: <br><br> <code>grails-app/views/layouts/main.gsp</code> <br> <pre> <code class="html hljs xml">%{--   --}% <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${request.partialPage}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:layoutBody</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:if</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:else</span></span></span><span class="hljs-tag">&gt;</span></span> %{--    --}% <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pageContent"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:layoutBody</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">g:else</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We have achieved full transparency (for the controller and GSP) in which of the page options to show. <br><br><h3>  Bookmarks and history </h3><br>  So, we have three screens switched through AJAX: <br><table><tbody><tr><th>  / my-app / # do / receipts </th><th>  / my-app / # do / buy </th><th>  / my-app / # do / feedback </th></tr><tr><td><img src="https://habrastorage.org/storage/464e805c/fcb68ae0/66c915b9/7f0f8277.png"></td><td><img src="https://habrastorage.org/storage/2b9aab4b/9b899111/720d8c38/4efb230f.png"></td><td><img src="https://habrastorage.org/storage/daba6f05/7d02fef7/7566f7c7/a2c0897c.png"></td></tr></tbody></table><br>  Everything is very cool, but as it turns out, our ‚Äúdynamic‚Äù links cannot be bookmarked.  The fact is that they contain an anchor-tail, which is <strong>not transmitted</strong> to the server.  Therefore, the server when downloading such a URL does not know which of the internal pages to show. <br><br>  About anchor knows only javascript.  This solution suggests itself: first load the base page with JavaScript, then run the code that defines the current anchor and loads the inside using AJAX.  Especially without bothering, I wrote this code: <br><br> <code>web-app/js/application.js</code> <br> <pre> <code class="javascript hljs">$.ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(<span class="hljs-string"><span class="hljs-string">'#pageContent'</span></span>).html(<span class="hljs-string"><span class="hljs-string">'...'</span></span>) .load(buildURL(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.hash), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   updateNavLinks(); }); });</span></span></code> </pre><br>  This code only demonstrates the idea.  If desired, this code can be finished to a more beautiful state, but the essence will not change: first you have to load the basic wrapper, then the user will have to wait for the internal part to load.  For example, Facebook usually does not show anything at all until the inside is loaded - a matter of taste. <br><br>  And what about the story?  When navigating Back / Forward, our <strong>$ .ready</strong> event will not work.  The browser considers such transitions as a ‚Äújump‚Äù from one anchor to another, i.e.  just scrolling through the page.  There are no uniquely identified JavaScript events.  What to do? <br><br>  One way to solve this (rather brutal in itself) is to periodically check the <strong>document.location.hash</strong> property for changes.  If suddenly the current anchor has changed, you need to overload the inside of the page. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkLocalState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.hash &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.hash != currentState) { currentState = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.hash; $(<span class="hljs-string"><span class="hljs-string">'#pageContent'</span></span>).html(<span class="hljs-string"><span class="hljs-string">' , ...'</span></span>) .load(buildURL(currentState), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   updateNavLinks(); }); } }</span></span></code> </pre><br>  Now we check the change of anchor every 500 milliseconds: <br><br><pre> <code class="javascript hljs">$.ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setInterval(checkLocalState, <span class="hljs-number"><span class="hljs-number">500</span></span>); });</code> </pre><br>  Now our application will respond to Back / Forward transitions, but with a half second delay.  This delay (sometimes annoying to the user) can be seen on many large sites using a similar navigation scheme.  If you reduce the spacing, the background javascript will eat more resources.  If the interval is increased, the reaction time will increase.  In general, you have to pay for everything. <br><br><h3>  Summary </h3><br>  We created the Grails + jQuery application with AJAX navigation, which: <br><ol><li>  Reloads only the internal contents of the page without reloading the entire page. </li><li>  Correctly saves the state of the page in the address bar, i.e.  Suitable for bookmarks and transfer links to friends. </li><li>  Correctly responds to Back / Forward transitions in the browser. </li><li>  Allows you to develop server code "in the old way", without bothering with the new rules of the game, because  All page loading logic is made transparent (for controllers and GSP pages). </li><li>  Links can be opened in a new window and they will work correctly. </li><li>  I note that the links in our application <strong>are</strong> no different from regular links, with the exception of the pound ( <strong>#</strong> ) at the beginning of the URL!  After all, we carefully carried away all the logic of the links in the jQuery-code. </li></ol><br>  Of course, in a real application, the code given here will have to be improved, in particular, to more accurately take into account situations where there is no anchor, use a more complex link building scheme, etc.  However, I hope that he successfully demonstrates the idea and solves most of the problems with anchor-navigation. <br><br>  References: <br><ol><li>  <a href="http://yensdesign.com/2008/11/creating-ajax-websites-based-on-anchor-navigation/">http://yensdesign.com/2008/11/creating-ajax-websites-based-on-anchor-navigation/</a> </li><li>  <a href="http://developerlife.com/tutorials/%3Fp%3D232">GWT Tutorial - Managing History and Hyperlinks</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/108650/">https://habr.com/ru/post/108650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108635/index.html">With a view to 11</a></li>
<li><a href="../108638/index.html">TDD is like snowboarding</a></li>
<li><a href="../108639/index.html">Extensions for Opera: Settings Page</a></li>
<li><a href="../108642/index.html">Domain support. RF in Biggo and Python</a></li>
<li><a href="../108649/index.html">"Berlin"</a></li>
<li><a href="../108655/index.html">Set up AirPrint on a regular USB printer for Mac OS X 10.6.5 (Video)</a></li>
<li><a href="../108656/index.html">How to make a startup and get an MBA with a broken leg</a></li>
<li><a href="../108658/index.html">Hg Init: Part 2. The Basics of Mercurial</a></li>
<li><a href="../108659/index.html">Ext JS 4 preview: faster, easier, more stable</a></li>
<li><a href="../108660/index.html">HackDay: Battle of Companies - December 9-10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>