<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Site update, database schema update (MySQL)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problem - you need to update the site (aka "svn up") plus update the database schema - add tables, indexes, etc. 
 SQL database update requests are st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Site update, database schema update (MySQL)</h1><div class="post__text post__text-html js-mediator-article">  Problem - you need to update the site (aka "svn up") plus update the database schema - add tables, indexes, etc. <br>  SQL database update requests are stored in the repository, you need to run the necessary SQL after updating the application code. <br><br>  Complexity: 1) it is impossible for the same SQL to be executed twice.  2) it is necessary to execute queries in a certain sequence (it is impossible to make ALTER TABLE before creation). <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How? </h2><br><br>  1. Regulations regarding SQL queries on changing the structure of the database - the developer knows that SQL will be executed on the LIVE server with all the consequences. <br><br>  2. Regulations regarding the naming of files with SQL queries <br><br>  0034.users_added_balance_column.sql <br><br>  files are numbered in order to uniquely preserve the order of execution <br><br>  3. A special format of files with SQL queries (template) is used: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">SET</font> @version= <font color="#A31515">'users_added_balance_column'</font> ; <br> <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> <font color="#0000ff">EXISTS</font> `dbversions` (`version` <font color="#0000ff">varchar</font> (200) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ,`dt_applied` datetime <font color="#0000ff">default</font> <font color="#0000ff">NULL</font> , <font color="#0000ff">UNIQUE</font> <font color="#0000ff">KEY</font> `version` (`version`)) ENGINE=InnoDB <font color="#0000ff">DEFAULT</font> CHARSET=latin1; <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> prc_update; <br> DELIMITER // <br> <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> prc_update(version_to_check <font color="#0000ff">VARCHAR</font> (200)) <font color="#0000ff">BEGIN</font> <font color="#0000ff">SET</font> @isversion=( <font color="#0000ff">SELECT</font> `version` <font color="#0000ff">FROM</font> `dbversions` <font color="#0000ff">WHERE</font> `version`=version_to_check); <font color="#0000ff">IF</font> ISNULL(@isversion) <font color="#0000ff">THEN</font> <br> ‚Äî <font color="#0000ff">INSERT</font> <font color="#0000ff">SQL</font> HERE (BELOW) <br> <br> <font color="#0000ff">ALTER</font> <font color="#0000ff">TABLE</font> `user_groups` <font color="#0000ff">ADD</font> <font color="#0000ff">INDEX</font> ( `userId` ); <br> <br> <font color="#0000ff">ALTER</font> <font color="#0000ff">TABLE</font> `user_groups` <br> <font color="#0000ff">ADD</font> <font color="#0000ff">CONSTRAINT</font> `user_groups_ibfk_1` <font color="#0000ff">FOREIGN</font> <font color="#0000ff">KEY</font> (`userId`) <font color="#0000ff">REFERENCES</font> `users` (`id`) <font color="#0000ff">ON</font> <font color="#0000ff">DELETE</font> <font color="#0000ff">CASCADE</font> <font color="#0000ff">ON</font> <font color="#0000ff">UPDATE</font> <font color="#0000ff">CASCADE</font> ; <br> <br> ‚Äî <font color="#0000ff">END</font> , DO <font color="#0000ff">NOT</font> <font color="#0000ff">INSERT</font> <font color="#0000ff">SQL</font> BELOW THIS LINE <br> <font color="#0000ff">INSERT</font> <font color="#0000ff">INTO</font> `dbversions` <font color="#0000ff">SET</font> `version`=version_to_check, dt_applied=NOW(); <font color="#0000ff">SET</font> @echo_string = CONCAT( <font color="#A31515">'Executed '</font> , version_to_check); <br> <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> @echo_string = CONCAT( <font color="#A31515">'Skipped '</font> , version_to_check); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">SELECT</font> @echo_string <font color="#0000ff">AS</font> <font color="#A31515">''</font> ; <br> <font color="#0000ff">END</font> // <br> DELIMITER; <br> <font color="#0000ff">CALL</font> prc_update(@version); <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> prc_update; <font color="#0000ff">SET</font> @version= <font color="#0000ff">NULL</font> ;</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  That is, the ‚Äúheader‚Äù and ‚Äúbasement‚Äù are always used, which, in fact, guarantee that SQL will be executed once.  At the beginning of the file the label is written (the same as the file name). <br><br>  The essence of what is happening: the dbversions table stores the labels of all executed queries.  The stored procedure checks each time whether the given SQL query was launched on the given database. <br><br>  4. There is an updatedb.php script that runs all queries automatically (only those that were not executed due to the stored procedure in each .sql file are executed): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#!/usr/bin/php <br> &lt;?php <br> <br> require( dirname(__FILE__). <font color="#008000">'/../bootstrap_cli.php' );</font> <br> <br> $dir = dirname(__FILE__); <br> <br> list($dbName, $dbUser, $dbPassword, $dbHost) = split( <font color="#008000">'/', Config::$databasesConnections['main']);</font> <br> <br> <font color="#0000ff">if</font> (!empty($dbPassword)) { <br> $dbPassword_cmdln = <font color="#008000">'-p'.$dbPassword;</font> <br> } <font color="#0000ff">else</font> { <br> $dbPassword_cmdln = <font color="#008000">'';</font> <br> } <br> <br> foreach (glob($dir. <font color="#008000">'/*.sql') as $sqlFile) {</font> <br> <br> system( <font color="#A31515">"mysql -u {$dbUser} {$dbPassword_cmdln} {$dbName} &lt; {$sqlFile}"</font> ); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  All this allows you to quickly update the server (staging, live, working copy) - svn up, then updatedb.php - without fear of forgetting to update something or break the base. <br><br>  Thanks to this organization, the application ‚Äúrises‚Äù on almost any machine in a few minutes ‚Äî there is no need for database dumps - the application is completely in the repository (SVN). </div><p>Source: <a href="https://habr.com/ru/post/80486/">https://habr.com/ru/post/80486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80476/index.html">Light touch</a></li>
<li><a href="../80477/index.html">New face of my brainchild. Thanks to everyone who contributed.</a></li>
<li><a href="../80478/index.html">Netcraft's January report on http server popularity</a></li>
<li><a href="../80480/index.html">Installing FreeBSD on a USB flash drive for a seedbox machine</a></li>
<li><a href="../80485/index.html">Russian analogue suicidemachine.org</a></li>
<li><a href="../80490/index.html">IP base of mobile operators</a></li>
<li><a href="../80492/index.html">Yii 1.1.0</a></li>
<li><a href="../80493/index.html">Microphone for iphone</a></li>
<li><a href="../80495/index.html">Who wants to try MindMeister?</a></li>
<li><a href="../80496/index.html">Calendarika - free personal calendar creation service.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>