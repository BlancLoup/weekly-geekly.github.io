<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zip codes - to freedom! (Reversing in pictures)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of years ago, I wrote about using the PAF (Postcode Address File) base of the British Royal Mail (Royal Mail) to bring users' mailing address...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zip codes - to freedom! (Reversing in pictures)</h1><div class="post__text post__text-html js-mediator-article"> A couple of years ago, <a href="http://habrahabr.ru/post/106207/">I wrote</a> about using the PAF (Postcode Address File) base of the British Royal Mail (Royal Mail) to bring users' mailing addresses to a standard form.  Since PAF is the main intellectual property of Royal Mail, getting it is not so easy: an annual subscription costs from ¬£ 400 depending on the completeness of the base and the frequency of updates.  A week or two after the subscription, a solid red box with a CD comes in the mail: <br><img src="https://habrastorage.org/storage2/b19/c84/4c2/b19c844c2cbcd1d93810e4612cd6e125.jpg"><br><br>  On the disk - an EXE file that requests a "serial number" and unpacks the database (set of CSV files) to disk.  The serial number is sent separately to the attacker who intercepted the package, could not use the base.  (They will invent the same - a text file with a serial number!) Each client has his own number so that in case of a ‚Äúleak‚Äù it is clear who to complain to.  However, the serial number does not interfere with the ‚Äúleakage‚Äù of the data itself, and <a href="http://wikileaks.org/wiki/UK_government_database_of_all_1,841,177_post_codes_together_with_precise_geographic_coordinates_and_other_information,_8_Jul_2009">Postzon</a> (one of the components of the PAF) appeared on WikiLeaks in 2009.  The commentaries to it noted that " <i>this base was compiled by taxpayers, and activists, including <a href="http://www.guardian.co.uk/technology/2012/nov/01/royal-mail-postcode-address-data">The Guardian</a> and <a href="http://www.testmagazine.co.uk/2010/02/blow-to-developers-as-no-10-blocks-free-postcode-file/">Sir Tim Berners-Lee</a> , have long tried to convince the Royal Mail to open free access to PAF; but so far these attempts have not crowned with success</i> . "  However, a year after Postzon appeared on WikiLeaks, a similar database appeared in open access on behalf of the British cartographic service Ordnance Survey and the <a href="http://www.ordnancesurvey.co.uk/oswebsite/products/code-point-open/">OS Code-Point Open</a> - in this way, Royal Mail kept the person, not giving in to the requirements of activists, and leaked received the status of public.  However, a fully PAF is still not publicly available.  (While I was preparing this article, Postzon and with WikiLeaks disappeared somewhere; but <a href="http://webcache.googleusercontent.com/search%3Fq%3Dcache:60i2MnpfYUMJ:wikileaks.org/wiki/UK_government_database_of_all_1,841,177_post_codes_together_with_precise_geographic_coordinates_and_other_information,_8_Jul_2009">Google remembers everything</a> .) <br><br>  A year after receiving the PAF, I needed to look at it again, but the sheet with the serial number, sent separately from the disk, had time to get lost in a year.  Then it became interesting to me - how difficult would it be to bypass the verification of the serial number in a product so solid and so fiercely protected from ‚Äúinformation liberators‚Äù?  Half an hour later I had the data on my screw, and the unpacking program itself seemed to me a good demo for beginner reverse engineers.  No IDA is required - only free and fast-install tools. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Severe assemblers, <a href="http://habrahabr.ru/company/kaspersky/blog/171931/">whom even Kaspersky is afraid of</a> , will surely find this example a toy, and, while yawning, leaf through the rest of the article.  Well, okay - tutorials in the style of <a href="">"how to draw an owl"</a> annoy me a lot more than those in which simple things are chewed. <br><a name="habracut"></a><br>  Let's start with the fact that we run the program under <a href="http://msdn.microsoft.com/en-gb/windows/hardware/gg463009.aspx">windbg</a> : <br><img src="https://habrastorage.org/storage2/ab2/82e/1ef/ab282e1ef967de0594b1a6228abbfbfa.png"><br><br>  We hammer in a field for a serial with garbage, and we click "Begin".  A message appears that the serial is incorrect. <br>  Click on the debugger to break: <br><img src="https://habrastorage.org/storage2/6f9/3a5/7a4/6f93a57a44eeb042e4b13fe7ab94774d.png"><br><br>  Switch to the main thread ( <code>~0s</code> ) and look at the call stack ( <code>k</code> ): <br><img src="https://habrastorage.org/storage2/820/a22/96a/820a2296a3e680d57f79e79698faddc5.png"><br><br>  We see that execution stopped somewhere inside the message loop launched from the <code>MessageBox</code> , and the return address from the <code>MessageBox</code> is 0041f086.  Let's see what was in the code <i>before the</i> <code>MessageBox</code> call, for example, 0x40 bytes before returning (command <code>u 041f086-40 l 1f</code> ): <br><img src="https://habrastorage.org/storage2/ecb/674/233/ecb674233dd4bb18b888154b2a981196.png"><br><br>  So, the <code>MessageBox</code> is called (with the return address 0041f086), if the byte <code>[ebp-45h]</code> turned out to be zero, and the value of this byte is written just a few instructions earlier - the result of the function call 00402adc is stored there, obviously checking the value of the serial number. <br><br>  Amazing!  Run the file again, setting a breakpoint immediately after calling the checking function: <code>g 0041f051</code> . <br>  As soon as we press "Begin" on the first screen, the debugger stops the program, and in the eax register we see the result of the serial: zero. <br>  ‚ÄúFixing‚Äù it by one: <code>r ax=1</code> , and resuming execution: <code>g</code> <br>  Hooray!  We see the second screen - the Royal Mail license agreement. <br><img src="https://habrastorage.org/storage2/91e/5e0/988/91e5e09881a2addeb1deb42fbf4d4e50.png"><br><br>  We click on the further, further, further, and finally, the program reports on the successful unpacking of the database. <br>  But ... what is she unpacking to us ?! <br><img src="https://habrastorage.org/storage2/4a6/8f7/aa5/4a68f7aa5d13493e647b9e93a114d4bf.png"><br><br>  Here are the cunning!  It looks like the serial number entered is checked again somewhere. <br>  How to find where? <br><br>  Let's take the disassembler <a href="http://users.tbc.net/~clive/dumppe.htm">dumppe</a> , set on our file, and look in the listing for the line "INVALID KEY" <br>  In my favorite Farah, this is done with the <code>edit:&lt;dumppe /disasm SetupRM.exe</code> command <code>edit:&lt;dumppe /disasm SetupRM.exe</code> , and fans of other file managers will have to redirect the output to a file. <br><img src="http://habrastorage.org/storage2/aca/38e/ca0/aca38eca0e708e7e7165e6d0bacbb27f.png"><br><br>  The string was found at 00481AE6, and it is referred to (Xref) at 00401CB2: <br><img src="http://habrastorage.org/storage2/d82/5fb/777/d825fb77731ebf3cf0d20cac6e42dc8e.png"><br><br>  We see the check and <code>jz</code> at 00401CAD.  There is no point in ‚Äúcorrecting‚Äù the register value before checking, because the check is called many thousand times - for each unpacked line.  So, you need to fix the code itself. <br><br>  Run the program for the third time, with familiar movements: <code>g 0041f051</code> , ‚ÄúBegin‚Äù, <code>r ax=1</code> . <br>  Then we fix the check: we replace the opcode <code>jz</code> (74) with <code>jmp short</code> (eb) using the command <code>eb 401cad eb</code> .  Raymond Chen has a <a href="http://blogs.msdn.com/b/oldnewthing/archive/2004/11/11/255800.aspx">handy selection of</a> frequently used x86 opcodes. <br>  We continue execution ( <code>g</code> ) and happily agree with all the requirements of Royal Mail. <br><img src="http://habrastorage.org/storage2/bcb/7b9/9b1/bcb7b99b10ef3b674d46a97596aa1aac.png"><br><br>  Here are our data, the long-awaited! <br><img src="http://habrastorage.org/storage2/bb7/194/4ce/bb71944ce4fc6e628ff303421ab45fd7.png"><br><br>  So, the minimum windbg commands needed: <br><table><tbody><tr><td>  <code>~</code> <i>x</i> <code>s</code> </td><td>  <b>s</b> et active thread </td><td>  switch to stream context <i>x</i> </td></tr><tr><td> <code>k</code> </td> <td>  stac <b>k</b> </td><td>  show call stack </td></tr><tr><td>  <code>u</code> <i>address</i> <code>l</code> <i>length</i> </td><td>  <b>u</b> nassemble </td><td>  show code <i>at</i> </td></tr><tr><td>  <code>g</code> <i>address</i> </td><td>  <b>g</b> o </td><td>  perform until we reach the <i>address</i> </td></tr><tr><td>  <code>r</code> <i>register</i> = <i>value</i> </td><td>  <b>r</b> egister </td><td>  change register value </td></tr><tr><td>  <code>eb</code> <i>address</i> <i>value</i> </td><td>  <b>e</b> nter <b>b</b> yte </td><td>  change byte value by <i>address</i> </td></tr></tbody></table>  For lovers of "programming with the mouse" all this has analogues somewhere on the menu and on the toolbars;  and, as you can see, these six teams are already enough to cope with programs of the Royal Mail level.  <b>Reverse engineering is available to everyone!</b> <br><br>  ... Of sporting interest, I later repeated my research with the next release of the PAF, from 2012.  It turned out that the defense there was significantly strengthened - instead of two <code>je/jne</code> checks, it was necessary to fix as many as seven! </div><p>Source: <a href="https://habr.com/ru/post/173651/">https://habr.com/ru/post/173651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173641/index.html">Crash IE9 with CSS</a></li>
<li><a href="../173643/index.html">Pre-order for Samsung Galaxy S IV available</a></li>
<li><a href="../173645/index.html">Personal computer in the living room</a></li>
<li><a href="../173647/index.html">Another vulnerability in the lock of some Samsung smartphones</a></li>
<li><a href="../173649/index.html">WorldHostingDays - the largest hosters conference (report)</a></li>
<li><a href="../173653/index.html">Watching the collection. Tailable cursors</a></li>
<li><a href="../173655/index.html">Amazon Expanded Instance Types with EBS-Optimized Disks</a></li>
<li><a href="../173657/index.html">Voyager 1 almost left the solar system</a></li>
<li><a href="../173661/index.html">Windows Azure Storage - Architecture</a></li>
<li><a href="../173663/index.html">The war is over, everyone has won</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>