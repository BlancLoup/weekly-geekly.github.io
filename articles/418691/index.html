<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rancher: Kubernetes in 5 minutes on bare iron</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the crossing, the orchestrator is not changed. 

 After I finally got tired of Docker Swarm because of its pseudo-simplicity and constant doping, n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rancher: Kubernetes in 5 minutes on bare iron</h1><div class="post__text post__text-html js-mediator-article">  At the crossing, the orchestrator is <s>not</s> changed. <br><br>  After I finally got tired of Docker Swarm because of its pseudo-simplicity and constant doping, not very convenient work with distributed file systems, a slightly damp web-interface and narrow functionality, as well as the lack of support out of the box for GitLab integration, it was decided to deploy your Kubernetes cluster on your own hardware, that is, by deploying Rancher Management Server 2.0. <br><br>  Installation experience, fault tolerance scheme, work with haProxy and two dashboards under the cat: <br><a name="habracut"></a><br>  <strong>Input data:</strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      HP Proliant DL320e Gen8 Host Server - 2 pcs. <br>  VM Ubuntu Server 16.04, 2Gb RAM, 2vCPU, 20Gb HDD - 1 pc.  on each Host (VM-haProxy). <br>  VM Ubuntu Server 16.04, 4Gb RAM, 4vCPU, 40Gb HDD, 20 Gb SSD - 3 pcs.  on each Host (VM - * - Cluster). <br>  VM Ubuntu Server 16.04, 4Gb RAM, 4vCPU, 100Gb HDD - 1 pc.  on anyone Host (VM-NFS). <br><br>  Network layout: <br><br><div class="spoiler">  <b class="spoiler_title">Pic1</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ua/wg/ec/uawgecpkngtalxstr0i1fam-ok4.jpeg"><br></div></div><br>  <strong>Getting Started:</strong> <br><br>  <em>VM-haProxy</em> has haProxy, fail2ban, iptables rules onboard.  It acts as a gateway for all the machines behind it.  We have two gateways and all machines in case of loss of the gateway connection on their host will switch to another. <br><br>  The main task of these nodes (VM-haProxy) is to distribute access to the backend, balance, forward ports, collect statistics. <br><br>  My choice fell on haProxy, as a more narrowly focused tool regarding balancing and health checking.  For all this, I like the syntax of configuration directives and work with IP whitelists and blacklists, as well as working with a multi-domain SSL connection. <br><br>  HaProxy configuration: <br><br><div class="spoiler">  <b class="spoiler_title">haproxy.conf with comments</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">########################################################## #Global # ########################################################## global log 127.0.0.1 local0 notice maxconn 2000 user haproxy group haproxy tune.ssl.default-dh-param 2048 defaults log global mode http option httplog option dontlognull retries 3 option redispatch timeout connect 5000 timeout client 10000 timeout server 10000 option forwardfor option http-server-close ########################################################## #TCP # ########################################################## #    API  Kubernetes listen kube-api-tls bind *:6443 mode tcp option tcplog server VM-Master-Cluster Master:6443 ########################################################## #HTTP/HTTPS - Frontend and backend # ########################################################## #      "  ", frontend  backend. frontend http-in bind *:80 acl network_allowed src -f /path/allowed-ip #     IP.     . http-request deny if !network_allowed #       IP  . reqadd X-Forwarded-Proto:\ http mode http option httpclose acl is_haproxy hdr_end(host) -i haproxy.domain.ru acl is_rancher hdr_end(host) -i rancher.domain.ru acl is_kubernetes hdr_end(host) -i kubernetes.domain.ru use_backend kubernetes if is_kubernetes use_backend rancher if is_rancher use_backend haproxy if is_haproxy frontend https-in bind *:443 ssl crt-list /path/crt-list #    .        . acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed reqadd X-Forwarded-Proto:\ https acl is_rancher hdr_end(host) -i rancher.etraction.ru acl is_kubernetes hdr_end(host) -i kubernetes.etraction.ru use_backend kubernetes if is_kubernetes { ssl_fc_sni kubernetes.domain.ru } use_backend rancher if is_rancher { ssl_fc_sni rancher.domain.ru } # Backend  haProxy.    . backend haproxy stats enable stats uri /haproxy?stats stats realm Strictly\ Private stats auth login:passwd cookie SERVERID insert nocache indirect #  , , backend   dashboard rancher  kubernetes. backend rancher acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http redirect scheme https if !{ ssl_fc } server master master:443 check ssl verify none backend kubernetes acl network_allowed src -f /path/allowed-ip http-request deny if !network_allowed mode http balance leastconn redirect scheme https if !{ ssl_fc } server master master:9090 check ssl verify none</span></span></code> </pre> <br></div></div><br>  <strong>Important:</strong> All machines must ‚Äúknow‚Äù each other by the host name. <br><br><div class="spoiler">  <b class="spoiler_title">add-host-entry.pp puppet manifest for adding hostnames in / etc / hosts</b> <div class="spoiler_text"><pre> <code class="bash hljs">class host_entries { host { <span class="hljs-string"><span class="hljs-string">'proxy01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.11'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'proxy02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.12'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'master'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.100'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node01'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.101'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node02'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.102'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node03'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.103'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node04'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.104'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'node05'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.105'</span></span>, } host { <span class="hljs-string"><span class="hljs-string">'nfs'</span></span>: ip =&gt; <span class="hljs-string"><span class="hljs-string">'10.10.10.200'</span></span>, } }</code> </pre><br></div></div><br>  <em>VM-Master-Cluster</em> - the main control machine.  Different from other nodes, it has Puppet Master, GlusterFS Server, Rancher Server (container), etcd (container), control manager (container) on board.  In case of shutdown of this host, production services continue to work. <br>  <em>VM-Node-Cluster</em> - Nodes, Workers.  Worker machines whose resources will be combined into one fault tolerant environment.  Nothing interesting. <br><br>  <em>VM-NFS</em> - NFS server (nfs-kernel-server).  The main task is to provide buffer space.  Stores configuration files and any.  Does not store anything important.  His fall can be corrected slowly, drinking coffee. <br><br>  <strong>Important:</strong> All environment machines must have onboard: docker.io, nfs-common, gluster-server. <br><br><div class="spoiler">  <b class="spoiler_title">must-have-packages.pp puppet manifest for installing the necessary software</b> <div class="spoiler_text"><pre> <code class="bash hljs">class musthave { package { <span class="hljs-string"><span class="hljs-string">'docker.io'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'nfs-common'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } package { <span class="hljs-string"><span class="hljs-string">'gluster-server'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'installed'</span></span>, } }</code> </pre><br></div></div><br>  Mounting nfs-volume and setting up GlusterFS will not be described, since it is generously described in large quantities. <br><br>  If you notice, in the specification description, there are SSD disks, they are prepared for the work of the distributed file system Gluster.  Create partitions and vaults on high-speed disks. <br><br>  <em>Note.</em>  In fact, Rancher does not require a mirror-like environment to run.  All of the above is my vision of the cluster and a description of what practices I follow. <br><br>  To run Rancher, <strong>one</strong> machine is enough, with 4CPU, 4Gb RAM, 10Gb HDD. <br><br>  5 minutes to Rancher. <br><br>  On the VM-Master-Cluster we perform: <br><br><pre> <code class="bash hljs">sudo docker run -d --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher</code> </pre> <br>  Check availability: <br><br><pre> <code class="bash hljs">curl -k https://localhost</code> </pre> <br>  If you saw the API - I congratulate you exactly half way passed. <br><br>  Having looked at the network diagram again, we will remember that we will work from the outside, through haProxy, in our configuration we publish the link <a href="https://rancher.domain.ru/">rancher.domain.ru</a> , go on, set our password. <br><br>  The next page is the Kubernetes cluster creation page. <br><br><div class="spoiler">  <b class="spoiler_title">Pic2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1w/ke/xn/1wkexnv2z_lgd_epga3vx3foyv4.png"><br></div></div><br>  In the Cluster Options menu, select Flannel.  With other network providers did not work.  I can not advise. <br><br>  It is worth paying attention to the fact that we installed the checkboxes etcd and Control Plane, the worker‚Äôs checkbox is not set, in case you don‚Äôt plan to use the manager in worker mode. <br>  We work inside the local network, with the same address on the NIC, so the same IP is indicated in the Public and Internal Address fields. <br><br>  Copy the resulting code above, run it in the console. <br><br>  After some time in the web interface you will see a message about the addition of the node.  And after some time you start the Kubernetes cluster. <br><br><div class="spoiler">  <b class="spoiler_title">Pic.3</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lj/sn/kk/ljsnkkwx3eh2w0eg5vysblt8wpm.png"><br></div></div><br>  To add a worker, go to cluster editing in the Rancher web interface, you will see the same menu that generates the connection command. <br><br>  Set the checkbox only in the worker position, specify the IP of the future worker, copy the command and execute it in the console of the node you need. <br><br>  After some time, the cluster power will increase, exactly like the number of nodes. <br><br>  <strong>Installing Kubernetes Dashboard:</strong> <br><br>  Go to the Projects / Namespaces menu. <br><br>  After installation, you will see that the Kubernetes namespaces will be contained outside the projects.  To fully work with these namespaces, they must be placed in the project. <br><br>  Add a project, name it at your discretion.  Move the namespaces (cattle-system, ingress-nginx, kube-public, kube-system) to the project you created using the Move context menu.  It should work like this: <br><br><div class="spoiler">  <b class="spoiler_title">Pic.4</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dz/qv/el/dzqvelzycrlwyj3bkwllq-pndqm.png"><br></div></div><br>  Click directly on the project name, you will be taken to the workload control panel.  It is here that we will analyze how to create a simple service. <br><br><div class="spoiler">  <b class="spoiler_title">Pic.5</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/q6/lp/5z/q6lp5znqlnhzkudjafjnr172n-g.png"><br></div></div><br>  Click "Import YAML" in the upper right corner.  Copy and paste the contents of <a href="">this file</a> into the textbox of the window that opens, select the namespace "kube-system", click "Import". <br><br>  After some time, the pod kubernetes-dashboard will start. <br><br>  Go to pod editing, open the ports publishing menu, set the following values: <br><br><div class="spoiler">  <b class="spoiler_title">Pic.6</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_p/2b/wk/_p2bwkxifynrhipap0imqddogfi.png"><br></div></div><br>  Check access on the node where pod is running. <br><br><pre> <code class="bash hljs">curl -k https://master:9090</code> </pre> <br>  See the answer?  The publication is complete, it remains to reach the administrative part. <br><br>  On the main cluster management page in Rancher, there are very handy tools, such as, kubectl - cluster management console and Kubeconfig File - configuration file containing the API address, ca.crt, etc. <br><br>  Go to kubectl and execute: <br><br><pre> <code class="bash hljs">kubectl create serviceaccount cluster-admin-dashboard-sa kubectl create clusterrolebinding cluster-admin-dashboard-sa --clusterrole=cluster-admin --serviceaccount=default:cluster-admin-dashboard-sa</code> </pre><br>  We have created a service account with higher privileges, now we need a token to access the Dashboard. <br><br>  Find the secret of the created account: <br><br><pre> <code class="bash hljs">kubectl get secret | grep cluster-admin-dashboard-sa</code> </pre><br>  We will see the account name with a certain hash at the end, copy it and execute it: <br><br><pre> <code class="bash hljs">kubectl describe secret cluster-admin-dashboard-sa-$( )</code> </pre><br>  Again, remember that we have all safely published through haProxy. <br><br>  <a href="https://kubernetes.domain.ru/">Follow the</a> link <a href="https://kubernetes.domain.ru/">kubernetes.domain.ru</a> .  Enter the received token. <br><br>  Rejoice: <br><br><div class="spoiler">  <b class="spoiler_title">Fig.7</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ps/1q/iw/ps1qiwgxivruyotas0fcb2slwfy.png"><br></div></div><br>  <em>PS</em> <br>  In summary, I would like to thank Rancher for creating an intuitive interface, an easily deployable instance, simple documentation, the ability to quickly move and scalability at the cluster level.  Perhaps, I was too harsh at the beginning of the post that Swarm was tired, rather obvious development trends, kind of forced to stare at the side and not bring the boring routine affairs to the end.  Docker has created an era of development.  And to judge this project certainly not for me. </div><p>Source: <a href="https://habr.com/ru/post/418691/">https://habr.com/ru/post/418691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418681/index.html">On Friendship Day - 50% discount on all IDE JetBrains for our friends</a></li>
<li><a href="../418683/index.html">Creating an emulator arcade machine. Part 2</a></li>
<li><a href="../418685/index.html">Procedural level generation</a></li>
<li><a href="../418687/index.html">The 3.5 "revolution: details of a small diskette boom with wavepave music</a></li>
<li><a href="../418689/index.html">How to create a library of components in Figma, saving the budget, for example, an online auction</a></li>
<li><a href="../418695/index.html">Anti-Piracy Wars - The Empire Strikes Back</a></li>
<li><a href="../418699/index.html">Creating an emulator arcade machine. Part 3</a></li>
<li><a href="../418705/index.html">Futex basics</a></li>
<li><a href="../418709/index.html">You need to force yourself: drivers and barriers in interfaces</a></li>
<li><a href="../418711/index.html">Token-Managed Registries 1.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>