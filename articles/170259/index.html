<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qemu-KVM: Work in Debian</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a compilation of information accumulated during the use of the Qemu-KVM hypervisor. I want to share the knowledge that I have at the m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qemu-KVM: Work in Debian</h1><div class="post__text post__text-html js-mediator-article">  This article is a compilation of information accumulated during the use of the Qemu-KVM hypervisor.  I want to share the knowledge that I have at the moment.  I hope that my article will benefit those who are only going to use the Qemu-KVM hypervisor or are already using it.  And another thing: the article is not for linux beginners (elementary things will not be considered here). <br><br>  Much has been written about this virtualization system in the network.  But when you really start working with it, you encounter a lack of information and practical examples of application.  So let's get started. <br><br>  Incoming task.  The computer was allocated as a test station - to check the performance of backup copies of databases, installed software, build msi packages and other very diverse tasks.  Computer Configuration: <br><ul><li>  Atlon X2 245 processor </li><li>  RAM 4 gigabytes </li><li>  500 gigabyte hard drive </li><li>  motherboard ASUS M4N68T-M LE. </li></ul><a name="habracut"></a><br>  After a brief reflection, it was decided to use the computer as a platform for working with virtual machines.  CPU hardware virtualization supported.  In this regard, it was decided to install another 1 hard drive.  Rummaging in the "bins of the motherland" was found a disk of 80 gigabytes.  It was added to the configuration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With the computer sorted out.  Now in line is the hypervisor.  I wanted to work with such a platform, which can then be used in a corporate environment.  Therefore, virtualbox, microsoft virtual pc, vmware workstations were not suitable.  The following question arose - which system to choose: <br><ol><li>  Microsoft hyper-v does not fit - paid.  The company in which I work uses only licensed software.  Therefore, no one will allocate a server license for my purposes. </li><li>  VMWARE ESXi does not know the SATA controller located on the motherboard (since it was developed for server systems). </li><li>  Qemu-kvm is a freely developed hypervisor that supports hardware virtualization.  It can be installed in any modern Linux distribution.  This is for me, and we take it. </li></ol><br>  Choosing a Linux distribution.  I use the default Debian.  You can choose any distribution you like (ubuntu, Fedora, Opensuse, Archlinux).  The qemu-kvm hypervisor is in any of the above distributions, and Google is replete with articles on how to install it. <br><br>  Get down to business.  I will not describe the installation of the operating environment.  I will only make a reservation that during the installation of the operating environment, the larger hard disk did not touch.  His time will come.  How to install a hypervisor on Debian is very well described <a href="http://wiki.debian.org/ru/KVM">here</a> .  Personally, I put qemu-kvm libvirt-bin. <br><br>  Hypervisor set, now a little about the internal structure.  There are two directories that are worth a look: <br>  / etc / libvirt / - configuration files are mainly stored here <br>  / var / lib / libvirt / - images of hard drives, instant snapshots of the system and much more will be stored here. <br>  Our hypervisor is installed. <br><br>  Now a little about the settings.  Qemu-kvm does not work directly with a network card on a physical computer.  Therefore you need to configure the bridge.  What we do: open the file / etc / network / interfaces and bring it to the following form: <br>  <em># This file is the network interfaces available on your system</em> <em><br></em>  <em># and how to activate them.</em>  <em>For more information, see interfaces (5).</em> <em><br></em>  <em># The loopback network interface</em> <em><br></em>  <em>auto lo br0</em> <em><br></em>  <em>iface lo inet loopback</em> <em><br></em>  <em># Set up interfaces manually, avoiding conflicts with eg, network manager</em> <em><br></em>  <em>iface eth0 inet manual</em> <em><br></em>  <em># Bridge setup</em> <em><br></em>  <em>iface br0 inet static</em> <em><br></em>  <em>bridge_ports eth0</em> <em><br></em>  <em>address xxxx.xxx.xxx.xxx</em> <em><br></em>  <em>broadcast xxxx.xxx.xxx.xxx</em> <em><br></em>  <em>netmask xxxx.xxx.xxx.xxx</em> <em><br></em>  <em>gateway xxxx.xxx.xxx.xxx</em> <em><br></em>  <em>bridge_stp off</em> <em><br></em>  <em>bridge_fd 0</em> <em><br></em>  <em>bridge_maxwait 0</em> <em><br></em> <br>  More information <a href="https://help.ubuntu.com/community/KVM/Networking">here</a> . <br><br>  Next, save the file and reboot the computer. <br>  Oh, miracle!  Hypervisor installed! <br>  Then the question arises: how to manage the server?  You can manage Qemu-kvm with two programs: virt-manager and virtinst. <br><br>  <b>Virt-manager.</b> <br>  This program is designed for a graphical interface.  It supports both remote control of virtual machines and local.  But she has a huge minus - analogs for windows simply do not. <br>  How I personally got out of the situation.  I installed the LXDE GUI and the xrdp server, thanks to such a simple set of programs I did not have to physically go to the computer (it hurts him a lot).  I just connected through a standard RDP client which is in windows.  But this is an additional waste of computer resources. <br>  If you installed virt-manager, it automatically creates: <br>  storage for images of virtual machines on the path / var / lib / libvirt / images <br>  virtual network interface default. <br>  Therefore, you need to mount a hard disk with a large amount into the / var / lib / libvirt / images directory. <br><br>  <b>Virtinst.</b> <br>  This is a console utility.  No graphics, solid command line and saving system resources. <br>  If you decide to use console management, you will need to manually create a repository of virtual machine images.  This is done as follows.  By ssh connect to the server.  Log in as root. <br>  You can choose any place for storage: <br><ol><li>  you can mount the hard disk in a directory and specify it as a storage </li><li>  You can simply select the device storage. </li></ol><br>  I was more attracted by the directory option (it's easier to copy virtual machine disks).  So what I did was: formatted a 500 gigabyte disk into ext4 format (when btrfs is completed, it is better to use it).  Created the / etc / libvirt / images directory and mounted it there.  Do not forget to add a line for automatic mounting in fstab.  Then in the console type vitsh and press Enter.  It looks like this: <br>  <i>root @ kvm: / home / firsachi # virsh</i> <i><br></i>  <i>Welcome to virsh, the virtualization interactive terminal.</i> <i><br></i>  <i>Type: 'help' for help with commands</i> <i><br></i>  <i>'quit' to quit</i> <i><br><br></i>  <i>virsh #</i> <i><br></i> <br>  Now, if we give the help command, we can see the list of shell commands.  We are interested in whether there is ready storage.  To do this, enter the command pool-list --all <br>  <i>virsh # pool-list - all</i> <i><br></i>  <i>- Name State Autostart</i> <i><br></i> <br>  If you just enter the pool-list, then you will be shown only active storage, and you need to see them all. <br>  Create a pool <br>  <i>virsh # pool-define-as storage dir --target / etc / libvirt / images /</i> <br><br>  We say that the pool starts automatically <br>  <i>virsh # pool-autostart storage</i> <br><br>  We start the pool <br>  <i>virsh # pool-start storage</i> <br><br>  Now check <br>  <i>virsh # pool-list ‚Äìall</i> <br><br>  The conclusion should be such <br>  <i>virsh # pool-list - all</i> <i><br></i>  <i>Name State Autostart</i> <i><br></i>  <i>- storage active yes</i> <i><br></i> <br>  A little about the teams recommend reading <a href="http://blog.erema.name/virsh-man-po-russki/18/">here</a> . <br><br>  If you do not create a repository for virtual machine disk images, then in order for the disks to lie in one place, you will need to specify the full path to the image when you create it (write a lot), and so the image will be created in the specified pool or if you have one, his name is optional.  The pool configuration file will be located in the / etc / libvirt / storage / directory. This is the .xml file.  Exit the virsh by typing the exit command. <br><br>  In principle, our hypervisor is installed and can be used.  But there is still a small trifle, which I would like to mention.  Namely, how Qemu-kvm works. <br><br>  A virtual machine running on it sends commands to the physical processor directly via a loadable module (kvm-amd or kvm-intel).  It must be one of the modules that corresponds to the manufacturer of the processor (Intel or AMD). <br><br>  This module is loaded during system startup.  However, this is not my method.  I rebuild the system kernel in order to embed the necessary module (as an option when rebuilding) directly into the kernel. <br>  But this is not the only modernization that I spend.  In addition, I do the following: <br><ul><li>  turn off sound support (this is a server, not a workstation); </li><li>  I do not use the IPv6 protocol (it is not used in my network); </li><li>  I disable support for wifi, wmax network cards and all that is connected. </li></ul> I do not like when the extra functions burden the core with an extra load. <br><br>  In building my own kernel, these <a href="http://habrahabr.ru/post/82600/">first</a> and <a href="http://wiki.debian.org/ru/Make-Kpkg">second</a> articles helped me. <br><br>  I'll run a little forward.  Many people on the Internet complained that the virtio network card model does not work correctly.  This is an explanation, and quite simple.  Drivers for this device are in the experimental stage.  But virtio storage works fine. <br><br>  Now we start working with virtual machines.  Create our first virtual machine: <br>  <i>virt-install --connect qemu: /// system \</i> <i><br></i>  <i>--name comp1 \</i> <i><br></i>  <i>--ram 512 \</i> <i><br></i>  <i>--vcpus = 1 \</i> <i><br></i>  <i>--disk pool = storage, cache = none, size = 20, format = qcow2 \</i> <i><br></i>  <i>--disk /home/firsachi/Winxp.iso,device=cdrom \</i> <i><br></i>  <i>--bridge = br0, model = e1000 \</i> <i><br></i>  <i>--os-type = windows</i> <i><br></i>  <i>--os-variant = winxp \</i> <i><br></i>  <i>--graphics vnc, port = 5901, listen = 0.0.0.0</i> <br><br>  Some details I want to clarify: <br>  <b>pool = storage we</b> specify the pool in which you want to create a disk; <br>  <b>cache = none,</b> this means that disk write caching is disabled.  In my case, this is an img image.  When write caching is enabled, the time for accessing the virtual machine disk is doubled; <br>  <b>size = 20</b> disk size in gigabytes; <br>  format = qcow2 is the format of the disk image.  As I understand it, only it supports system snapshots; <br>  <b>model = e1000</b> model of the Intel gigabit network card (the default is the hundred-megabyte rtl8139); <br>  <b>port = 5901</b> port, which can be accessed using Ultra VNC Viewer; <br>  <b>listen = 0.0.0.0</b> permission to connect from all IP (by default, only localhost listens). <br>  Installation can be made directly to the device.  It will look like this: <br>  <i>virt-install --connect qemu: /// system \</i> <i><br></i>  <i>--name comp1 \</i> <i><br></i>  <i>--ram 512 \</i> <i><br></i>  <i>--vcpus = 1 \</i> <i><br></i>  <i>--disk / dev / sdb, format = qcow2 \</i> <i><br></i>  <i>--disk /home/firsachi/Winxp.iso,device=cdrom \</i> <i><br></i>  <i>--bridge = br0, model = e1000 \</i> <i><br></i>  <i>--os-type = windows</i> <i><br></i>  <i>--os-variant = winxp \</i> <i><br></i>  <i>--graphics vnc, port = 5901, listen = 0.0.0.0</i> <br>  Where <b>sdb</b> should be replaced with your device. <br><br>  If everything went well, then to connect to the console of our virtual machine, you need to install Ultra VNC Viewer on your computer.  In the connection, you need to specify the IP address of the server and the port, or the domain name of the server and the port. <br>  How is the installation of Windows, I hope everyone knows. <br><br>  Now about the virtual machine drivers.  Driver installation requires the following disk images: virtio-win-0.1-30.iso and viostor-0.1-30-floppy.img <br>  The last disk is not necessary, it is needed only if you are going to install windows xp or windows 2003 server on virtio storage (by the way, if you do this, the operating system is faster). <br><br>  Here it is written how to connect and disconnect <a href="http://superuser.com/questions/239870/change-cd-rom-via-virsh">cdrom</a> . <br>  There is one more bonus: external devices can be connected to the virtual machine (for example, a physical hard disk or usb drive).  We go in virsh.  The command will look like this: <br>  <i>virsh # attach-disk comp1 / dev / sdc vdv --type disk</i> <br>  Where: <ul><li>  comp1 is the name of the virtual computer to which we connect the disk. </li><li>  / dev / sdc - path to the device on the physical computer. </li><li>  Vdv - where we connect to the virtual machine. </li><li>  --type - type of disk. </li></ul><br>  Unmount disk: <br>  <i>virsh # deatach-disk comp1 vdv</i> <br><br>  This <a href="http://ru.wikibooks.org/wiki/%25D0%25A3%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B2%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B5%25D0%25B9_%25D0%25BD%25D0%25B0_%25D0%25BE%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B5_libvirt">article</a> will help a lot.  I also recommend looking <a href="http://builder.virt-tools.org/artifacts/libvirt-virshcmdref/html/sect-attach-disk.html">here</a> . <br><br>  Where do I apply this hypervisor?  I constantly have a domain controller on it.  And it works stably, without failures.  Authorization in the domain occurs without problems.  In parallel, I can run a maximum of 2 virtual machines. <br>  <b>Restore a virtual machine on another server.</b> <br>  One sunny and cloudless day I thought: what will happen if I have to transfer it to another server.  There is a virtual machine migration mode in the hypervisor, but there is no place to check it - there is no such second computer. <br>  Therefore it was necessary to proceed from the worst option.  Suppose: <br><ul><li>  The computer on which the virtual machine was running burned out (Atlon X2 245 processor). </li><li>  Once a week, the virtual machine shuts down and a backup copy of the configuration file and disk image is made. </li></ul><br>  Hence my actions in this case.  For the experiment, I brought my laptop from home.  It has an i5-3210M processor, linux distribution OpenSuse (for my laptop is more compatible with the "iron"). <br><br>  I installed Qemu-KVM on it, moved the virtual machine configuration file and disk image to it.  In the configuration file, edited the path to the virtual machine disk, rebooted the laptop.  And, lo and behold!  The hypervisor not only saw my virtual machine, but also launched it. <br><br>  <b>Create snapshots of virtual machines.</b> <br>  Qemu-KVM supports the creation of snapshots of virtual machines.  I will give the simplest example.  From the superuser, go to virsh and execute the following command: <br>  <i>virsh # snapshot-create-as name</i> <br>  name is the name of the virtual machine. <br>  After the snapshot of the virtual machine is taken, the backup copies of the configuration files will be stored in the / var / lib / libvirt / qemu / snapshot / directory.  But that's where the data of the virtual machine disk is located - I do not know yet. <br><br>  You can view the pictures with the following command: <br>  <i>virsh # snapshot-list name</i> <i><br></i>  <i>Name Creation Time State</i> <i><br></i>  <i>- 1360593244 2013-02-11 16:34:04 +0200 running</i> <i><br></i>  <i>1360594479 2013-02-11 16:54:39 ‚Äã‚Äã+0200 running</i> <i><br></i> <br>  You can restore from a photo like this: <br>  <i>virsh # snapshot-revert name 1360593244</i> <br><br>  You can delete an unnecessary image as follows: <br>  <i>virsh # snapshot-delete name 1360593244</i> <br><br>  That's how we live now: the Qemu-KVM hypervisor, the virtual domain controller, and I am pleased with the work done. <br>  Thanks to everyone who read to the end.  I hope my thoughts were helpful. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/170259/">https://habr.com/ru/post/170259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170245/index.html">Wizee shopping center guide: 200 thousand downloads, 100 thousand users and 140 shopping centers</a></li>
<li><a href="../170247/index.html">Warranty replacement of SanDisk memory card from American Amazon</a></li>
<li><a href="../170249/index.html">The network laid out 320 gigapixel panorama of London</a></li>
<li><a href="../170251/index.html">Report on the Exchange environment using Powershell (now on Exchange 2013)</a></li>
<li><a href="../170253/index.html">Since March, Twitter is starting to disable API 1.0.</a></li>
<li><a href="../170261/index.html">Facts and figures about digital television</a></li>
<li><a href="../170263/index.html">Manage Windows services using PowerShell. Part 6. Service Accounts</a></li>
<li><a href="../170265/index.html">Anonymous Classes in Objective-C</a></li>
<li><a href="../170267/index.html">Three letters you don't know about</a></li>
<li><a href="../170269/index.html">Separate - Template for PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>