<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make a web application for your own Bluetooth Low Energy device?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few weeks ago, for the sake of entertainment, I gathered a simple robotic arm (a la manipulator) and decided to tie the control from my smartphone v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make a web application for your own Bluetooth Low Energy device?</h1><div class="post__text post__text-html js-mediator-article"><a name="prologue"></a>  A few weeks ago, for the sake of entertainment, I gathered a simple robotic arm (a la manipulator) and decided to tie the control from my smartphone via Bluetooth to it.  I don‚Äôt yet have experience in developing native mobile applications, I‚Äôm already familiar with <a href="https://cordova.apache.org/">Apache Cordova</a> , but it would be interesting to use the <strong>Web Bluetooth API by</strong> spicing with <strong>Progressive Web Apps</strong> chips. <br><br> <a href="https://habrahabr.ru/post/339146/"><img src="https://habrastorage.org/webt/59/cd/3a/59cd3ad5cf1f6256216554.png" alt="Picture To Attract Attention"><br></a>  <a href="https://habrahabr.ru/post/339146/"><i><font color="#999">Picture to attract attention, leading under the cat</font></i></a> <br><br>  At first glance it may seem that there are enough articles on keywords: there is <a href="https://webbluetoothcg.github.io/web-bluetooth/">a</a> Bluetooth Web <a href="https://webbluetoothcg.github.io/web-bluetooth/">specification</a> , a <a href="https://developers.google.com/web/updates/2015/07/interact-with-ble-devices-on-the-web">detailed article</a> on the Google Developers blog with <a href="https://googlechrome.github.io/samples/web-bluetooth/">examples</a> , a <a href="https://geektimes.ru/post/276558/">detailed review of</a> Bluetooth Low Energy, examples of reverse engineering of protocols for various BLE devices, and even blinking with ‚Äúsmart‚Äù lights and retrieving data from fitness bracelets directly from the browser - <em>what could go wrong?</em> <br><a name="habracut"></a><br>  So I thought, until I tried to make my own device and communicate with it from the browser.  I will not dig deep, just share my practical experience and code, I personally would be very useful for me three weeks ago :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  <b><font color="#333">Table of contents</font></b> </h3><br><div class="spoiler">  <b class="spoiler_title">Expand Table of Contents</b> <div class="spoiler_text"><ol><li>  <a href="https://habr.com/ru/post/339146/">Prologue</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Problem</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Setting up a Bluetooth Low Energy module</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Creating a web application</a> <br><ol><li>  <a href="https://habr.com/ru/post/339146/">Concept</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Task</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Training</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Ui</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Event handlers</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Connect to device</a> <br><ol><li>  <a href="https://habr.com/ru/post/339146/">Bluetooth device request</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Connecting to the device, receiving service objects and characteristics</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Enable feature change notifications</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Output to terminal</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Testing</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/339146/">Auto reconnect</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Disconnect from device</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Data acquisition</a> <br><ol><li>  <a href="https://habr.com/ru/post/339146/">Introduction of intermediate buffer</a> </li></ol></li><li>  <a href="https://habr.com/ru/post/339146/">Sending data</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Progressive web app</a> <br><ol><li>  <a href="https://habr.com/ru/post/339146/">Icon</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Manifesto</a> </li><li>  <a href="https://habr.com/ru/post/339146/">Service Worker</a> </li></ol></li></ol></li><li>  <a href="https://habr.com/ru/post/339146/">Epilogue</a> </li></ol></div></div><br><a name="problem"></a><h2>  <b>Problem</b> </h2><br>  So, you assembled the device, decided to retrofit it with a Bluetooth module and access it from a browser.  Hereinafter, as an example, there will be a picture of the connection of the Bluetooth module to the <strong>Arduino Uno</strong> , so let it be an Arduino-based device, although, of course, there is no fundamental difference whether you use <strong>STM</strong> , <strong>Raspberry</strong> , <strong>ESP8266</strong> or something else.  It is important that your controller will work with the Bluetooth module using the <strong>UART</strong> protocol (for more details, <a href="https://geektimes.ru/post/253786/">please visit Geektimes</a> or <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BD%25D0%25B8%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2581%25D0%25B8%25D0%25BD%25D1%2585%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D1%2580%25D0%25B8%25D1%2591%25D0%25BC%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0%25D1%2582%25D1%2587%25D0%25B8%25D0%25BA">Wikipedia</a> ). <br><br>  If you, like me, have already screwed the good old Bluetooth module <strong>HC-05</strong> to your device, threw the firmware, started some of Google's examples and cannot understand why the browser does not detect your device, then I‚Äôll <strike>hurry</strike> to disappoint you: Web Bluetooth only supports ‚ÄúBluetooth 4 standard‚Äù. <br><br>  This is the reason for writing the article, because when you, like me, come back happy from the nearest store with the BLE module ( <strong>HM-10</strong> , for example), you will find that it works quite differently and, most importantly, does not supports the profile of the serial port ( <strong>Serial Port Profile</strong> , SPP, more details in <a href="http://ru.bmstu.wiki/SPP_(Serial_Port_Profile)">the Bauman library</a> ), through which you used to carelessly drive bytes back and forth. <br><br>  You may already be familiar with the concept of <strong>Bluetooth Low Energy</strong> , in particular, the <strong>Generic Attribute Profile</strong> (GATT) profile, but I will try to briefly explain what matters now for us: <em>instead of a self-made serial protocol, your device should provide a set of application ‚ÄúCharacteristics‚Äù that the connected device can read and / or modify.</em> <br><br>  For example, take a robotic arm: it moves in space along three coordinates (numbers X, Y, Z) and can open (0) or close (1) a claw.  So, we need to configure the BLE module to read and write 4 characteristics that the connected device can learn, read and write the desired values ‚Äã‚Äãinto. <br><br>  And it's great, but here's the bad luck: the usual BLE level ‚Äúhobby‚Äù modules that you will meet in the ‚Äúnearby store‚Äù or on Aliexpress: HM-10, JDY-08, AT-09, a certain CC41-A, which got to me, or others do not have the ability to configure any services and features. <br><br>  Instead, they provide only one characteristic, which kind of emulates a serial port, and all you write to it, the module sends to your controller via TX, and it sends all that you send from the controller to the RX module to the connected device.  With a limit of 20 bytes inherent in any BLE characteristic, by the way. <br><br>  Thus, despite the fact that Web Bluetooth is limited to the use of a common attribute profile, we will actually have to make a serial port profile on top of it for ‚Äúeveryday use‚Äù. <br><br><a name="ble-module-configuration"></a><h2>  <b>Setting up a Bluetooth Low Energy module</b> </h2><br>  To begin with, we will configure the BLE module, it will not take much time, if you know what and how.  It so happened that I had in my hands a <strong>CC41-A</strong> module on a <strong>Texas Instruments CC2541 chip</strong> , which cost me 340 p. In the ‚Äúnext store‚Äù.  Therefore, as an example, I will describe exactly its configuration, but the essence is common for other modules using a similar chip. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/cd/44/59cd44a4f3432486294183.png" alt="Pinout BLE module for example HM-10"></div><br>  <i><font color="#999">Pinout BLE module on the example of HM-10, clickable</font></i> <br><br>  If you have a <strong>USB-TTL converter</strong> , then it is enough to connect a BLE module to it and you will get direct access to the module from a computer via the COM port.  <em>Pay attention to the description of your module, maybe it works with 3.3V logic, so on the TX-RX and RX-TX lines you will have to use a logic level converter (voltage level shifter, taste and color on <a href="http://we.easyelectronics.ru/Shematech/soglasovanie-logicheskih-urovney-5v-i-33v-ustroystv.html">EasyElectronics</a> ).</em>  The CC41-A module, despite the fact that ‚ÄúLEVEL: 3.3V‚Äù is written on it, copes remarkably well with 5V logic. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/cd/4f/59cd4fee281fb336932362.png" alt="Connecting the BLE module to a USB-TTL converter"></div><br>  <i><font color="#999">Connecting a BLE module to a USB-TTL converter, clickable</font></i> <br><br>  Instead of a converter, you can use your controller by implementing the simplest serial bridge with it: everything that you send to one serial port will be transferred to another, and vice versa.  In the case of Arduino Uno, you will have to use the <strong>SoftwareSerial</strong> library: <br><br><div class="spoiler">  <b class="spoiler_title">Sketch for Arduino Uno</b> <div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;SoftwareSerial.h&gt; SoftwareSerial SerialBt(2, 3); void setup() { Serial.begin(9600); SerialBt.begin(9600); } void loop() { if (SerialBt.available()) { Serial.write(SerialBt.read()); } if (Serial.available()) { SerialBt.write(Serial.read()); } }</code> </pre> </div></div><br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cd/51/59cd51c05634e212633585.png" alt="Connecting the BLE module to the Arduino Uno"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Connecting the BLE module to the Arduino Uno, clickable</font></i></a> <br><br>  Start the terminal program (you can use the Serial Monitor from the Arduino IDE, I prefer the <a href="https://sites.google.com/site/terminalbpp/">Bray's Terminal</a> ) and connect to the COM port on which the BLE module hangs with standard settings: <br><br><ul><li>  Baud rate: <b>9600</b> </li><li>  Data bits: <b>8</b> </li><li>  Parity: <b>none</b> </li><li>  Stop bits: <b>1</b> </li><li>  Handshaking: <b>none</b> </li></ul><br><br>  In standby mode, the module responds to <strong>AT commands</strong> ending in carriage return and line feed ( <code>CR+LF</code> , ‚ÄúBoth NL &amp; CR‚Äù option in Serial Monitor).  Some BLE modules by default work at a different speed, for example, at 38400, some modules enter configuration mode after clicking a button located on their board, some modules do not require commands to be in upper case ‚Äî check the specifications of your particular module. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/6a/59cf6a7dce2d2588871156.png" alt="Terminal program window in the BLE module configuration process"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">The terminal program window in the configuration process of the BLE module,</font></i></a> <a href=""><i><font color="#999"><br></font></i></a>  <a href=""><i><font color="#999">clickable</font></i></a> <br><br>  Send the ‚ÄúAT‚Äù command to test the connection.  The module should answer "OK" - it means everything is in order.  In fact, it is enough to make sure that the module operates in slave mode, waiting for the connection of the master device, the service UUID is <code>0xFFE0</code> , and the characteristic UUID is set as <code>0xFFE1</code> ‚Äî we will need this later.  Some commands that work with my module: <br><br><ul><li>  <code>AT</code> - performance check; </li><li>  <code>AT+HELP</code> - output all commands; </li><li>  <code>AT+DEFAULT</code> - reset to factory settings; </li><li>  <code>AT+RESET</code> - soft reboot; </li><li>  <code>AT+ROLE</code> - output mode; </li><li>  <code>AT+ROLE0</code> - setting the slave mode; </li><li>  <code>AT+NAME</code> - display the module name; </li><li>  <code>AT+NAMESimon</code> - set the module name as <code>Simon</code> ; </li><li>  <code>AT+PIN</code> - output PIN code (password) for pairing; </li><li>  <code>AT+PIN123456</code> - set the PIN code as <code>123456</code> ; </li><li>  <code>AT+UUID</code> - display the UUID of the service; </li><li>  <code>AT+UUID0xFFE0</code> - setting the service UUID as <code>0xFFE0</code> ; </li><li>  <code>AT+CHAR</code> - output UUID characteristics; </li><li>  <code>AT+CHAR0xFFE1</code> - set the UUID characteristics as <code>0xFFE1</code> . </li></ul><br><br>  Now you can try to connect to the BLE module, for example, from the <a href="https://googlechrome.github.io/samples/web-bluetooth/characteristic-properties.html">Characteristic Properties Sample</a> page, specifying "0xFFE0" as a service and "0xFFE1" as a characteristic.  Or even send something from the terminal to the browser on the <a href="https://googlechrome.github.io/samples/web-bluetooth/notifications.html">Notifications Sample</a> page. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/6b/59cf6bb639d36350802847.png" alt="Receiving information about the characteristic and data sent from the terminal"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Obtaining information about the characteristic and data sent from the terminal, clickable</font></i></a> <br><br><a name="web-app"></a><h2>  <b>Creating a web application</b> </h2><br>  Warm-up is over, go to the most interesting! <br><br><a name="concept"></a><h3>  <b><font color="#333">Concept</font></b> </h3><br>  I propose to consider the concept of managing your device.  On a regular HTML page in the browser, you create a certain UI with various controls that will implement the interaction with your device. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/6a/59cf6a38efc57848520297.png" alt="Sample UI Application for Managing a Robotic Arm"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">An example of a UI application for controlling a robotic arm,</font></i></a> <a href=""><i><font color="#999"><br></font></i></a>  <a href=""><i><font color="#999">clickable</font></i></a> <br><br>  If it is, for example, a robotic arm moving in three coordinates and opening and closing a claw, then it can be three numerical sliders or even a 2D surface, when pressed, which calculates X and Y values, one slider for moving along the Z axis and a button opening or closing claw.  If this is a teapot, you can make the "Boil!" Button.  If this is a radio-controlled machine, then you can make the buttons ‚Äúforward‚Äù, ‚Äúbackward‚Äù, ‚Äúleft‚Äù, ‚Äúright‚Äù, ‚Äúturn on / off headlights‚Äù, ‚Äúgive a signal‚Äù and the like. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/ce/b0/59ceb09e8445f097656124.png" alt="The overall picture of what is happening under the hood"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">The overall picture of what is happening under the hood is clickable.</font></i></a> <br><br>  Hanging handlers for clicking or changing the states of certain UI elements in JavaScript, you create a message that you send via the Bluetooth Web API to your device.  The BLE module receives the message, transmits it to the controller via the UART, the controller parses the message, takes the required actions and can send a response or error as a message back to the BLE module using the same UART, then the module will transmit it to the connected device, and you will receive a response using JS in browser. <br><br>  For example, when you click on the close claw button, the <code>onclick</code> button handler is triggered, which sends the message <code>GRIPPER=CLOSE</code> .  The controller receives the message, understands what is required of it, closes the claw and sends back the message <code>GRIPPER=CLOSED</code> .  Processing this message, we in JS remember the state of the claw and change the text on the button to ‚ÄúOpen‚Äù. <br><br><a name="task"></a><h3>  <b><font color="#333">Task</font></b> </h3><br>  Creating an HTML page (UI) and simple work with JavaScript event handlers is not such a difficult thing, and here is enough basic knowledge of web technologies.  Therefore, I propose to abstract from a specific device and <strong>create an application terminal that will connect to your device and exchange messages with it.</strong> <br><br>  We also implement the <strong>logging of the process of connecting</strong> to a Bluetooth Low Energy device, <strong>reconnecting</strong> in case of loss of communication, and <strong>bypassing the BLE length limit of the characteristic</strong> to 20 bytes. <br><br>  Well, at the end we will turn an ordinary HTML page into a <strong>progressive web application</strong> (about Progressive Web Apps on <a href="https://developers.google.com/web/progressive-web-apps/">Google Developers</a> , in <a href="https://en.wikipedia.org/wiki/Progressive_web_app">Wikipedia</a> - in English), which can be installed on the desktop of the smartphone and used in the absence of the Internet. <br><br>  Having the opportunity to exchange messages between the HTML page and your device, a stable connection and a simple API, it will not be difficult to sharpen the application for your needs. <br><br><a name="preparation"></a><h3>  <b><font color="#333">Training</font></b> </h3><br>  In addition to your favorite <strong>IDE,</strong> you will need a working <strong>‚Äúdevice‚Äù</strong> that we configured earlier; this will help you in real time to receive and send messages through the terminal program on your computer to test the application. <br><br>  Web Bluetooth API is available by default in <strong>Chrome 56+</strong> and <strong>Opera 43+</strong> .  The Google Developers <a href="https://developers.google.com/web/updates/2015/07/interact-with-ble-devices-on-the-web">article</a> also mentions that you need to enable the <u>chrome: // flags / # enable-experimental-web-platform-features</u> flag in Linux and restart the browser. <br><br>  And the last important moment: the web application should open either under <strong>HTTPS</strong> (you can use <a href="https://pages.github.com/">GitHub Pages</a> ), or under <a href="http://localhost/">http: // localhost</a> - these are the security requirements. <br><br><a name="ui"></a><h3>  <b><font color="#333">Ui</font></b> </h3><br>  The application will consist of one HTML page <code>index.html</code> , one stylesheet file <code>styles.css</code> and one <code>main.js</code> file in which all the magic will occur. <br><br>  Let's make a button for connecting to the device, a disconnect button, a div-container for messages and a send form consisting of a text field and the ‚ÄúSend‚Äù button: <br><br><div class="spoiler">  <b class="spoiler_title">index.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"styles.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"connect"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag">&gt;</span></span>Connect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"disconnect"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag">&gt;</span></span>Disconnect<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"terminal"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send-form"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">&gt;</span></span>Send<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  In the div container we will display the connection log, incoming and outgoing messages in the following form: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"terminal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>  ...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"out"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"in"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In order not to guess which message is from where, let's divide them by color in styles: <br><br><div class="spoiler">  <b class="spoiler_title">styles.css</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-id"><span class="hljs-selector-id">#terminal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: gray; } <span class="hljs-selector-id"><span class="hljs-selector-id">#terminal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.out</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: red; } <span class="hljs-selector-id"><span class="hljs-selector-id">#terminal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.in</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: blue; }</code> </pre></div></div><br>  As you can see, nothing special.  The interface is ready :) <br><br><a name="event-handlers"></a><h3>  <b><font color="#333">Event handlers</font></b> </h3><br>  Further work will occur in <code>main.js</code> <br><br>  Get links to UI elements, hang up the handlers by clicking on the connect and disconnect buttons and send the form: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     UI let connectButton = document.getElementById('connect'); let disconnectButton = document.getElementById('disconnect'); let terminalContainer = document.getElementById('terminal'); let sendForm = document.getElementById('send-form'); let inputField = document.getElementById('input'); //        Connect connectButton.addEventListener('click', function() { connect(); }); //        Disconnect disconnectButton.addEventListener('click', function() { disconnect(); }); //     sendForm.addEventListener('submit', function(event) { event.preventDefault(); //    send(inputField.value); //     inputField.value = ''; //    inputField.focus(); //      }); //   Bluetooth      function connect() { // } //     function disconnect() { // } //     function send(data) { // }</span></span></code> </pre><br><a name="connection"></a><h3>  <b><font color="#333">Connect to device</font></b> </h3><br>  The full connection algorithm consists of several stages: <br><br><ol><li>  Bluetooth device request: the browser launches a search and select the nearest device dialog, the user makes a selection, the application code receives the object. </li><li>  Connect to device from application code: <ol><li>  connection to the server of the general attribute profile (GATT Server), </li><li>  getting the right service </li><li>  obtaining the desired characteristics. </li></ol></li><li>  The inclusion of notifications about changes in characteristics - it is necessary to receive messages from your device. </li></ol><br><br>  Let's make in the code: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     let deviceCache = null; //   Bluetooth      function connect() { return (deviceCache ? Promise.resolve(deviceCache) : requestBluetoothDevice()). then(device =&gt; connectDeviceAndCacheCharacteristic(device)). then(characteristic =&gt; startNotifications(characteristic)). catch(error =&gt; log(error)); } //   Bluetooth  function requestBluetoothDevice() { // } //    ,     function connectDeviceAndCacheCharacteristic(device) { // } //       function startNotifications(characteristic) { // } //    function log(data, type = '') { // }</span></span></code> </pre><br>  In the <code>connect()</code> function, we implemented a Promise chain (a chain of functions returning Promise objects) corresponding to the connection stages. <br><br>  We also introduced the <code>deviceCache</code> variable, into which we will later write down the object of the device selected by the user in order to know what to reconnect in case of disconnection. <br><br>  In the first line of the body of the <code>connect()</code> function, the ternary operator immediately creates a completed Promise with the <code>deviceCache</code> object, if it is non-zero, or calls the function of requesting a Bluetooth device to select otherwise.  Thus, if the user has already connected to the device, then when you next click on the ‚ÄúConnect‚Äù button, the device selection dialog will not appear. <br><br>  If an error occurs at any of the stages, we output it to the terminal using the <code>log()</code> function, which we also implement later. <br><br><a name="request-device"></a><h4>  <b><font color="#666">Bluetooth device request</font></b> </h4><br>  To request a choice of a Bluetooth device, it is necessary to call the <code>navigator.bluetooth.requestDevice()</code> function with the configuration object as a required argument that describes which Bluetooth devices we are interested in.  You can use the filter by service, by name, you can accept all devices, but you still need to specify the used service, otherwise the browser will not provide access to it. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Bluetooth  function requestBluetoothDevice() { log('Requesting bluetooth device...'); return navigator.bluetooth.requestDevice({ filters: [{services: [0xFFE0]}], }). then(device =&gt; { log('"' + device.name + '" bluetooth device selected'); deviceCache = device; return deviceCache; }); }</span></span></code> </pre><br>  We request all devices that provide a service with a UUID of <code>0xFFE0</code> , which the BLE module was configured to use.  After the user selects a device, the Promise runs with a device object, which we write to the above cache and return later. <br><br><a name="connection-service-characteristic"></a><h4>  <b><font color="#666">Connecting to the device, receiving service objects and characteristics</font></b> </h4><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    let characteristicCache = null; //    ,     function connectDeviceAndCacheCharacteristic(device) { if (device.gatt.connected &amp;&amp; characteristicCache) { return Promise.resolve(characteristicCache); } log('Connecting to GATT server...'); return device.gatt.connect(). then(server =&gt; { log('GATT server connected, getting service...'); return server.getPrimaryService(0xFFE0); }). then(service =&gt; { log('Service found, getting characteristic...'); return service.getCharacteristic(0xFFE1); }). then(characteristic =&gt; { log('Characteristic found'); characteristicCache = characteristic; return characteristicCache; }); }</span></span></code> </pre><br>  We perform a simple Promise chain that speaks for itself.  The variable <code>characteristicCache</code> - by analogy with <code>deviceCache</code> - saves the resulting feature object, it will be needed to write data to it, that is, to send a message from the browser to the device. <br><br>  In the <code>getPrimaryService()</code> and <code>getCharacteristic()</code> functions, the UUIDs are used as arguments, with which the BLE module is configured. <br><br><a name="start-notifications"></a><h4>  <b><font color="#666">Enable feature change notifications</font></b> </h4><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       function startNotifications(characteristic) { log('Starting notifications...'); return characteristic.startNotifications(). then(() =&gt; { log('Notifications started'); }); }</span></span></code> </pre><br>  It is enough to refer to the <code>startNotifications()</code> method of the characteristic object, and then hang the handler on the characteristic change event, but more on that later. <br><br><a name="logging"></a><h4>  <b><font color="#666">Output to terminal</font></b> </h4><br>  We are implementing the output function in the terminal to test the connection to the device right now: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    function log(data, type = '') { terminalContainer.insertAdjacentHTML('beforeend', '&lt;div' + (type ? ' class="' + type + '"' : '') + '&gt;' + data + '&lt;/div&gt;'); }</span></span></code> </pre><br>  Using the <code>insertAdjacentHTML()</code> method, we insert a div with the class specified in the <code>type</code> argument at the end of the terminal's div container ‚Äî very simple. <br><br><a name="connection-test"></a><h4>  <b><font color="#666">Testing</font></b> </h4><br>  Open the page in the browser, click the "Connect" button, after which the device selection dialog will start.  Connect to your device, messages about the connection process will appear in the terminal. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/8f/59cf8fecba2c3769051139.png" alt="Device selection and connection"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Device selection and connection, clickable</font></i></a> <br><br>  Then I ran into a pair of pitfalls, about which it is not written anywhere.  The output of service messages helped diagnose and fix problems. <br><br>  The first is that when I connected to the device from the phone to which the <strong>Mi Band</strong> is attached, also working on BLE and in close proximity, the connection was extremely rare, and if it was installed, it almost immediately fell off.  This happened even in native applications.  I tried to take the Mi Band to a distance - it did not help.  I did not untie the bracelet, I just use another smartphone.  If you have similar problems, pay attention to the devices that communicate in parallel with your smartphone. <br><br>  The second stone is more likely not a stone, but a feature that usually manifests itself at the first connection: the connection may suddenly be lost for no apparent reason, and the browser does not support it, which is why we need to implement the reconnect functionality ourselves. <br><br><a name="reconnection"></a><h3>  <b><font color="#333">Auto reconnect</font></b> </h3><br>  To track disconnection, the Bluetooth Web proposes a <code>gattserverdisconnected</code> event whose handler should be hung onto the device object.  The most logical place for this is the device selection function: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Bluetooth  function requestBluetoothDevice() { log('Requesting bluetooth device...'); return navigator.bluetooth.requestDevice({ filters: [{services: [0xFFE0]}], }). then(device =&gt; { log('"' + device.name + '" bluetooth device selected'); deviceCache = device; //   deviceCache.addEventListener('gattserverdisconnected', handleDisconnection); return deviceCache; }); } //   function handleDisconnection(event) { let device = event.target; log('"' + device.name + '" bluetooth device disconnected, trying to reconnect...'); connectDeviceAndCacheCharacteristic(device). then(characteristic =&gt; startNotifications(characteristic)). catch(error =&gt; log(error)); }</span></span></code> </pre><br>  Now, if you connect to the device, and then de-energize it, and the Bluetooth connection is lost, the browser one-time tries to reconnect: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/9a/59cf9a33071aa478936818.png" alt="Reconnect attempt"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Attempt to reconnect, clickable</font></i></a> <br><br><a name="disconnection"></a><h3>  <b><font color="#333">Disconnect from device</font></b> </h3><br>  Before shutting down, it is important not to forget to remove the assigned handler from the <code>gattserverdisconnected</code> event, otherwise the browser will simply reconnect: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     function disconnect() { if (deviceCache) { log('Disconnecting from "' + deviceCache.name + '" bluetooth device...'); deviceCache.removeEventListener('gattserverdisconnected', handleDisconnection); if (deviceCache.gatt.connected) { deviceCache.gatt.disconnect(); log('"' + deviceCache.name + '" bluetooth device disconnected'); } else { log('"' + deviceCache.name + '" bluetooth device is already disconnected'); } } characteristicCache = null; deviceCache = null; }</span></span></code> </pre><br>  You can not reset the <code>deviceCache</code> , then the next time you click the "Connect" button, the device selection dialog will not appear, connecting to the previous device instead. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/9b/59cf9b43e19fb572348126.png" alt="Disconnect"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Disable, clickable</font></i></a> <br><br><a name="receiving"></a><h3>  <b><font color="#333">Data acquisition</font></b> </h3><br>  Data is received from the device asynchronously using a notification mechanism that occurs when the value of the BLE characteristic changes.  We only need to subscribe to the relevant event <code>characteristicvaluechanged</code> .  This should be done after the inclusion of notifications.  It will also correctly remove the handler from the characteristic when the device is disconnected: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       function startNotifications(characteristic) { log('Starting notifications...'); return characteristic.startNotifications(). then(() =&gt; { log('Notifications started'); //   characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged); }); } //     function disconnect() { if (deviceCache) { log('Disconnecting from "' + deviceCache.name + '" bluetooth device...'); deviceCache.removeEventListener('gattserverdisconnected', handleDisconnection); if (deviceCache.gatt.connected) { deviceCache.gatt.disconnect(); log('"' + deviceCache.name + '" bluetooth device disconnected'); } else { log('"' + deviceCache.name + '" bluetooth device is already disconnected'); } } //   if (characteristicCache) { characteristicCache.removeEventListener('characteristicvaluechanged', handleCharacteristicValueChanged); characteristicCache = null; } deviceCache = null; } //   function handleCharacteristicValueChanged(event) { let value = new TextDecoder().decode(event.target.value); log(value, 'in'); }</span></span></code> </pre><br>  <code>event.target.value</code> is a <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/DataView">DataView</a> object containing an <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> containing the message from your device.  Using <code>TextDecoder</code> ( <a href="https://developer.mozilla.org/en-US/docs/Web/API/TextDecoder">MDN, in English only</a> ), we distill the byte array into text. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/ce/67/59ce67a2d1d21401983439.png" alt="Sending data from the terminal and receiving in the browser"></a> </div> <a href=""><br></a>  <a href=""><i><font color="#999">Sending data from the terminal and receiving in the browser, clickable</font></i></a> <br><br>  Testing shows that receiving messages from the device is stable, with or without the end of the string with <code>CR</code> , <code>LF</code> symbols.  Long messages reach completely, but are broken multiple of 20 bytes. <br><br><a name="receive-buffer"></a><h4>  <b><font color="#666">Introduction of intermediate buffer</font></b> </h4><br>  You may not need to support messages longer than 20 bytes, but for the sake of completeness, let's get around this limitation.  The idea is simple: we will write incoming lines to the intermediate buffer before receiving the delimiter character.  When receiving the delimiter character, we will call the third function, transferring data from the buffer to it, and clear the buffer for subsequent writing. <br><br>  The delimiter character would be logical to feed the string ( <code>LF</code> , <code>\n</code> ).  It may also be useful to remove the whitespace from the beginning and end of the message: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      let readBuffer = ''; //   function handleCharacteristicValueChanged(event) { let value = new TextDecoder().decode(event.target.value); for (let c of value) { if (c === '\n') { let data = readBuffer.trim(); readBuffer = ''; if (data) { receive(data); } } else { readBuffer += c; } } } //    function receive(data) { log(data, 'in'); }</span></span></code> </pre><br>  When creating a web application specific to your device, you can change the <code>receive()</code> function to your needs, being sure that you are working with a solid message from the device. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/ce/67/59ce67dd8115d614927401.png" alt="           "></a> </div> <a href=""><br> <i><font color="#999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data from the terminal and receiving in the browser after the introduction of the intermediate buffer, clickable</font></font></font></i></a> <br><br><a name="sending"></a><h3> <b><font color="#333"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data</font></font></font></b> </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data to the device is done by writing the value to the characteristic, and more specifically by calling the method </font></font><code>writeValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of the characteristic object with </font></font><code>ArrayBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an argument. </font><font style="vertical-align: inherit;">To convert the string to the </font></font><code>ArrayBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">easiest to use </font></font><code>TextEncoder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><a href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MDN, in English only</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     function send(data) { data = String(data); if (!data || !characteristicCache) { return; } writeToCharacteristic(characteristicCache, data); log(data, 'out'); } //     function writeToCharacteristic(characteristic, data) { characteristic.writeValue(new TextEncoder().encode(data)); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just in case, we cast data to a string type using a global object </font></font><code>String</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In such an implementation, a limit of 20 bytes will also apply: anything that goes beyond will simply be cut off. </font><font style="vertical-align: inherit;">Therefore, if the message is longer than 20 bytes, it is worth breaking it into pieces and sending it sequentially with some delay:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     function send(data) { data = String(data); if (!data || !characteristicCache) { return; } data += '\n'; if (data.length &gt; 20) { let chunks = data.match(/(.|[\r\n]){1,20}/g); writeToCharacteristic(characteristicCache, chunks[0]); for (let i = 1; i &lt; chunks.length; i++) { setTimeout(() =&gt; { writeToCharacteristic(characteristicCache, chunks[i]); }, i * 100); } } else { writeToCharacteristic(characteristicCache, data); } log(data, 'out'); }</span></span></code> </pre><br>       ,         ( <code>\n</code> ). <br><br>         ,      ( <code>CR</code> , <code>\r</code> )    ( <code>LF</code> , <code>\n</code> ),      ,        ,  100 . <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/ce/68/59ce6859ea1cd581233408.png" alt="     "></a> </div> <a href=""><br> <i><font color="#999">     , </font></i></a> <br><br>  Works!             JS . <br><br><a name="pwa"></a><h3> <b><font color="#333">Progressive Web App</font></b> </h3><br>           ,          -  .      <strong>Progressive Web Apps</strong> (  <a href="https://developers.google.com/web/progressive-web-apps/">Google Developers</a>   <a href="https://en.wikipedia.org/wiki/Progressive_web_app"></a> ‚Äî in English):     -,         .    PWA    -               . <br><br><a name="icon"></a><h4> <b><font color="#666"></font></b> </h4><br>        .    <a href="https://realfavicongenerator.net/">realfavicongenerator.net</a> ‚Äî           . <br><br>   ¬´Favicon for Android Chrome¬ª     ¬´Assets¬ª   ¬´Create all documented icons¬ª,    Chrome              ,      . <br><br>      ¬´Generate¬ª,  ¬´Favicon package¬ª      -.       <code>&lt;head&gt;</code> . <br><br><a name="manifest"></a><h4> <b><font color="#666"></font></b> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Along with the icons, the generator kindly provided us with the preparation of the </font></font><a href="https://developer.mozilla.org/ru/docs/Web/%25D0%259C%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2584%25D0%25B5%25D1%2581%25D1%2582"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manifest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>manifest.json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icons"</span></span>: [ ... ], <span class="hljs-attr"><span class="hljs-attr">"theme_color"</span></span>: <span class="hljs-string"><span class="hljs-string">"#ffffff"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"background_color"</span></span>: <span class="hljs-string"><span class="hljs-string">"#ffffff"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"display"</span></span>: <span class="hljs-string"><span class="hljs-string">"standalone"</span></span> }</code> </pre><br>       <code>name</code>    <code>short_name</code> ,   ,   12 . <br><br>   <code>icons</code>     ,   <code>display</code> ‚Äî   . <code>standalone</code> ,  -     UI ,      ‚Äî ,   . <br><br>       <code>theme_color</code> ,  <code>background_color</code>      <strong>Splash screen</strong>   .  <code>theme_color</code>  ,       <code>&lt;meta name="theme-color" content="#ffffff"&gt;</code> . <br><br>     <code>start_url</code>  <code>scope</code>  <code>./</code> ,  -,        ,  -,    -    ,    ,         -. <br><br><a name="service-worker"></a><h4> <b><font color="#666">Service Worker</font></b> </h4><br> <a href="https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API">Service Worker</a>             .    Service Worker   <a href="https://github.com/GoogleChromeLabs/sw-toolbox">Service Worker Toolbox</a> ,   <a href="">sw-toolbox.js</a>  <a href="">companion.js</a> ,     <code>index.html</code>     <code>&lt;body&gt;</code> : <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"companion.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-service-worker</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sw.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>       <code>sw.js</code>   <code>index.html</code> ,    : <br><br><pre> <code class="javascript hljs">importScripts(<span class="hljs-string"><span class="hljs-string">'sw-toolbox.js'</span></span>); toolbox.precache([ <span class="hljs-string"><span class="hljs-string">'companion.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, <span class="hljs-string"><span class="hljs-string">'main.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'styles.css'</span></span>, ]);</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we have not just a page, but a truly progressive web application: </font></font><br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/cf/a7/59cfa71d1cd5c110950039.png" alt="      "></a> </div> <a href=""><br> <i><font color="#999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding an application to the desktop and launching it, clickable</font></font></font></i></a> <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/59/ce/69/59ce69579c409524133290.png" alt="Final test"></a> </div> <a href=""><br> <i><font color="#999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final test, clickable</font></font></font></i></a> <br><br><a name="epilogue"></a><h2>  <b>Epilogue</b> </h2><br>         Bluetooth Low Energy       -,        . <br><br>     UI     ,   ,       ‚Ä¶    ,      , . <br><br>    <code>index.html</code> , <code>styles.css</code> , <code>main.js</code>  <code>sw.js</code>  <a href="https://gist.github.com/loginov-rocks/8aeb19f207b1da53eaa553faa7aa8a51"></a> . <br><br>   -    : <a href="https://loginov-rocks.github.io/Web-Bluetooth-Terminal/">loginov-rocks.github.io/Web-Bluetooth-Terminal</a> ‚Äî       <a href="https://www.youtube.com/watch%3Fv%3DBNXN_931W_M">YouTube</a> . <br><br>  <strong>GitHub</strong>      <a href="https://github.com/loginov-rocks/bluetooth-terminal">ES6 </a>     BLE  , , <a href="https://github.com/loginov-rocks/Web-Bluetooth-Terminal"> -</a> . <br><br> <b>UPD:</b>  . </div><p>Source: <a href="https://habr.com/ru/post/339146/">https://habr.com/ru/post/339146/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339136/index.html">A selection of interesting events for the week in Moscow</a></li>
<li><a href="../339138/index.html">Decompilation of RNC ProPack 5 years long</a></li>
<li><a href="../339140/index.html">ITMO University team reached the final of the World Robot Olympiad</a></li>
<li><a href="../339142/index.html">‚ÄúOne more step to blockchain‚Äù: Bitfury Group presented Exonum 0.2</a></li>
<li><a href="../339144/index.html">Donates to streamers and real money for unreal life: summed up the QIWI API Contest</a></li>
<li><a href="../339148/index.html">React 16 server rendering innovations</a></li>
<li><a href="../339150/index.html">Submit the cool project: your API-client from one configuration file</a></li>
<li><a href="../339152/index.html">‚ÄúThe role of the analyst in making important product decisions‚Äù: video recordings of reports from the meeting</a></li>
<li><a href="../339154/index.html">Motivated installations from the USA (Android) - review of options, statistics, opinion</a></li>
<li><a href="../339156/index.html">Two facets of teleportation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>