<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attackers use Linux / Moose to compromise Linux-embedded systems, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Malware Linux / Moose is used by attackers to compromise various devices running Linux, including network routers. On a compromised router or other Li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attackers use Linux / Moose to compromise Linux-embedded systems, part 1</h1><div class="post__text post__text-html js-mediator-article">  Malware <b>Linux / Moose is</b> used by attackers to compromise various devices running Linux, including network routers.  On a compromised router or other Linux / Moose device, it will intercept network traffic and provide its operators with a proxy service.  As a rule, intruders are interested in HTTP session files (cookies) from popular network services.  They will be used by intruders to perform various illegal actions through a proxy. <br><br><img src="https://habrastorage.org/files/15d/193/ae0/15d193ae049444eabd2f0aa5acb8262e.jpeg"><br><br>  The malware is represented by regular ELF executable files, from which all debug information has been removed.  Linux / Moose uses multi-threading in its work; it creates more than 30 threads for performing various tasks.  Many of them are used to automatically search and infect other devices. <br><a name="habracut"></a><br>  <b>General information</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Linux / Moose uses unconventional network-penetration mechanisms in comparison with other malware targeted at routers.  He also specializes in DNS traffic redirection (DNS hijacking) and the forced termination of other malware processes if they are active in the system. <br><br>  We were able to collect various statistics on the work of Moose by creating a special environment, as well as to track the interaction of the infected system with network services, to compromise which the malicious code is aimed at.  The malware does not have mechanisms in its arsenal that would allow it to survive after the device is rebooted.  It also does not specialize in providing remote shell access to botnet operators. <br><br>  Below are the key findings that we were able to obtain when analyzing Linux / Moose. <br><br><ul><li>  The malicious program is aimed at compromising home routers and modems, including those that are provided to users by ISP-providers. </li><li>  Linux / Moose contains mechanisms for its penetration into the network served by the router. </li><li>  The malware can intercept traffic that passes through a compromised device, so it can listen on various types of devices, including PCs, laptops, and smartphones. </li><li>  Moose runs a complex proxy service (SOCKS and HTTP) on a compromised device, which can only be accessed from a fixed list of IP addresses. </li><li>  Operators use infected devices to perform fraudulent activities on social services on Twitter, Facebook, Instagram, YouTube, etc. </li><li>  Attackers can configure the malware so that it will redirect the DNS traffic passing through the router.  This technique allows them to organize a Man-in-the-Middle (MitM) attack. </li><li>  Moose infects t.  <a href="http://en.wikipedia.org/wiki/Linux_on_embedded_systems">Linux-based embedded devices</a> that run on MIPS and ARM architecture. </li></ul><br>  The Moose study showed us the following features of this malware. <br><br><ul><li>  It has mechanisms for distributing its files on the Internet using the LAN interfaces of a compromised router. </li><li>  The Moose service listens on port number 10073, which allows certain IP addresses to make proxy connections through a compromised device.  For the organization of the proxy protocols are used HTTP / HTTPS and SOCKS. </li><li>  The malicious program can send traffic from the C &amp; C server manager to other hosts, which allows you to effectively bypass the NAT security systems. </li><li>  Moose listens for network connections passing through the router and sends part of the received traffic to the C &amp; C server. </li><li>  Moose periodically monitors the presence of other malicious programs in the compromised OS and forcibly terminates their processes in case of detection. </li></ul><br>  The malware has no special mechanisms to compromise other systems.  Only those that have weak login credentials are subject to compromise.  Moose does not use any vulnerabilities in the OS or software to compromise other devices.  In fact, such a simple method of compromise is still very effective, according to a recent <a href="https://www.fireeye.com/blog/threat-research/2015/02/anatomy_of_a_brutef.html">report by</a> FireEye, it is one of the ten most urgent reasons for the leakage or theft of these companies.  Below is a general scheme of the Moose. <br><br><img src="https://habrastorage.org/files/b7d/101/d35/b7d101d3594243299019cd5e611f1534.png"><br>  Fig.  The general scheme of work Linux / Moose. <br><br>  A malicious program periodically interacts with its managers C &amp; C-servers, the list of which is hard-wired in its executable file.  To do this, the malware selects one of these servers, which will later provide it with configuration information and send instructions.  We call this server a configuration C &amp; C server (configuration C &amp; C server).  There are also other types of management servers, to which we have named the reporting C &amp; C server (report C &amp; C server) and the C &amp; C relay server (relay C &amp; C server).  At first, Moose sends reports of infection, and the second is used for NAT traversal operation. <br><br>  <b>Compromising network services and using proxies</b> <br><br>  In the analysis of Moose, we found many opportunities that it provides for attackers.  These features have been indicated above.  For a more detailed picture, we launched our own infected devices.  Below are the HTTP cookies that the bot is trying to steal for further fraud on the part of intruders. <br><br><ul><li>  Twitter: twll, twid </li><li>  Facebook: c_user </li><li>  Instagram: ds_user_id </li><li>  Google: SAPISID, APISID </li><li>  Google Play / Android: LAY_ACTIVE_ACCOUNT </li><li>  Youtube: LOGIN_INFO </li></ul><br>  We monitored the state of one of the infected routers, which was protected by the firewall, and were able to obtain statistics of the proxy traffic passing through it.  Statistics were collected for almost a month in the spring of 2015. <br><br><img src="https://habrastorage.org/files/15f/042/4dd/15f0424dd9fb40c9934d050aa304731d.png"><br>  Fig.  Statistics of proxy traffic distributed by ports. <br><br>  The diagram above shows that most of this traffic is encrypted.  The malware operator's traffic passes through TCP port number 2318. This port is used to communicate with the external IP address of the infected device and the proxy client.  It should be noted that most of the traffic we recorded on the infected router belonged to the Instagram social service (HTTP), and the protocol level was then upgraded from HTTP to the HTTPS secure connection level using the Location: protocol field. <br><br><img src="https://habrastorage.org/files/379/9ed/12c/3799ed12caf243dbafa4fcde9d87e076.png"><br>  Fig.  The Instagram service server translates a client (fake account) to use the HTTPS protocol using the HTTP field Location field. <br><br>  At the first stage, you can see the use of a proxy using the SOCKS protocol, then the client can be switched to the HTTPS mode from the server side.  Although the transmitted traffic is encrypted, we can see the IP address of the destination host.  In addition, we can check the certificate that identifies the server and its so-called.  Common Name (CN).  CN is a required attribute that allows you to verify the authenticity of the website and provides us with an accurate description of the purpose of the transmitted traffic. <br><br><img src="https://habrastorage.org/files/2b0/c8d/168/2b0c8d1685ce47148db7a710ad2762da.png"><br>  Fig.  Distribution of HTTPS traffic (proxy) by services on the example of a compromised router. <br><br>  It can be seen that most of the traffic belonged to the services of Twitter, Instagram, Soundcloud.  The diagram on the right shows the services included in the "Other" item.  In addition to the encrypted data, we were able to obtain data about autonomous systems (Autonomous Systems, AS), to which proxied traffic was sent through the passive DNS information mechanism.  Below is a list of organizations that have been affected by Linux / Moose. <br><br><ul><li>  Fotki (Yandex) </li><li>  Instagram (Facebook) </li><li>  Live (Microsoft) </li><li>  Soundcloud </li><li>  Twitter </li><li>  Vine </li><li>  Yahoo </li><li>  YouTube (Google) </li></ul><br>  We were also able to obtain information on the number of requests for web services that were made through a proxy and for what task this proxy was used. <br><br><img src="https://habrastorage.org/files/5cd/5e1/161/5cd5e11616c94d28b0af571cadb1618e.png"><br>  Fig.  A visual representation of the proxy activity, the traffic is distributed according to the type of information transmitted. <br><br>  The diagram above shows that most of the traffic belongs to network services that have been identified through the aforementioned CN certificates, passive DNS information, and the IP addresses of the autonomous system.  Botnet traffic is the number of proxy requests that were sent to the managing C &amp; C server and were always destined for TCP port 2318. All other requests are of the ‚ÄúOther‚Äù type.  Obviously, the above statistics show that cybercriminals actively use infected computers for illegitimate access to social services, and, on average, more than 500 requests pass through the infected router every day. <br><br>  Despite our efforts, we could not reliably count the number of compromised routers.  Moose itself is designed to make such an operation more difficult.  The bot does not use the P2P protocol; instead, the IP address of the manager of the C &amp; C server is hard-wired in its code, it also allows only clients from a specific list of IP addresses to connect to the proxy.  Another reason for our failure was the lack of desire of hosting providers to assist us in the investigation.  We used different mechanisms for counting the number of infected devices, which are listed below. <br><br>  One of such mechanisms for counting the activity of Moose on port 10073 is the <a href="https://isc.sans.edu/port.html">Internet Storm Center</a> .  This port is not regulated by the IANA organization and is not used by any popular software, so the abnormally large amount of traffic passing through this port indicates the activity of this malicious program. <br><br><img src="https://habrastorage.org/files/0ff/025/eae/0ff025eae85144ef8cfd1fba106bb4a1.png"><br>  Fig.  Activity of potentially compromised devices on port 10073. <br><br>  Above in the figure, one can see that a significant increase in Moose activity has been observed since mid-2014, more precisely, from April.  We first encountered this malware at the end of July 2014. At the end of 2014, its activity began to decline, despite the fact that the authors themselves are constantly engaged in updating the malware. <br><br>  In the bot itself, the attackers laid quite aggressive propagation mechanisms.  Below is the statistics of the activity of the bot to find new devices to compromise for 24 hours. <br><br><img src="https://habrastorage.org/files/698/188/d24/698188d241654dbe96f677ff0e2976b2.png"><br>  Fig.  Statistics scanned by the bot new devices to compromise for 24 hours. <br><br>  In 24 hours, the bot performed 170 thousand connection attempts on port 10073, which corresponds to 23 thousand unique hosts.  Of these, 36 connections were successful and ended with TCP connections (handshake), which means the potential for compromising these devices.  Of the 85 thousand attempts by Telnet connections that were made to 18 thousand unique hosts, 161 attempts ended with a request for Telnet credentials. <br><br>  In fact, this statistic may be inaccurate, since it largely depends on the type of equipment on which the malware is running.  We started the bot in software emulation mode, which is a slowing down factor in the operation of malware.  In other words, we do not know how this data corresponds to the data on a really infected device. <br><br>  We also asked our friends from Rapid7 to scan the Internet address space for the availability of both ports 10073 and 23 (Telnet) in order to get a general picture of devices and computers that fall under the ‚ÄúMoose orientation‚Äù.  It turned out that 1 million IP addresses meet this requirement.  If we subtract from this number the number of devices (IP) that did not request credentials for a Telnet connection, we will get about 50 thousand potentially infected hosts. <br><br>  Malicious software Linux / Moose requires Linux OS as an environment for its execution.  Moose executable ELF files depend on the popular C-library for embedded systems called <a href="http://www.uclibc.org/">uClibc</a> .  Today, many so-called.  embedded systems running Linux, this applies to routers, as well as higher-level networking equipment.  Some infected devices are easier to identify than others.  For example, after its launch on the system, the malicious program checks the presence of the /home/hik/start.sh file on the disk.  This file is usually located in HikVision's DVR devices, which <a href="http://www.hikvision.com/europe/Press-Release-details.asp%253Fid%253D2692">have already become a</a> victim of malware for embedded systems. <br><br>  Devices of the following vendors are vulnerable to infection with Linux / Moose: Actiontec, HikVision, Netgear, Synology, TP-Link, ZyXEL, Zhone.  In addition, medical devices like Hospira Drug Infusion Pump are also vulnerable. <br><br>  As we already mentioned, attackers use Linux / Moose to steal HTTP session data for various social services.  Then this data is used for fraudulent actions in these services, including operations like setting, cheating new Followers or subscribers.  A bot is used to perform all of these operations, so on one of the infected routers we were able to observe malware attempts to gain access to more than 700 different Instagram accounts during the month.  The following fake account was intentionally created by attackers for this purpose. <br><br><img src="https://habrastorage.org/files/266/525/029/266525029d5942369b7a23a2734090e6.png"><br>  Fig.  Fake account intruders. <br><br>  A few days later this account was already following 30-40 social service accounts. <br><br><img src="https://habrastorage.org/files/37a/66a/7db/37a66a7db689468b9f867cdbaf2aca1c.png"><br>  Fig.  Fake accounts of intruders. <br><br>  Below is a snapshot of the HTTP traffic in the Wireshark tool.  In the Location field of the protocol header you can see the user name, this line is highlighted in yellow.  The operators did not wind up the list of the Following-Users immediately, but at certain intervals of activity, masking the fraudulent activity. <br><br><img src="https://habrastorage.org/files/54c/f61/cff/54cf61cff37e46d09e328ffa741ff4fa.png"><br>  Fig.  Fragment of the HTTP traffic of the Instagram service proxied by attackers. <br><br>  A few hours later this account has already followed 36 users. <br><br><img src="https://habrastorage.org/files/ebf/e92/6f9/ebfe926f939a4f938475af8a98d3216f.png"><br>  Fig.  Fake Instagram account. <br><br><img src="https://habrastorage.org/files/5b9/0eb/782/5b90eb7822fb40e99e9304063b589024.png"><br>  Fig.  Users followed by a malicious user account. <br><br>  We noticed one of the accounts followed by the fake Instagram user, which is listed below.  Despite a small number of publications, he has an abnormally large number of followers. <br><br><img src="https://habrastorage.org/files/9ac/507/0ac/9ac5070ac4f64e44885dedbe469b9632.png"><br>  Fig.  Account of one of the users, followed by the above false account.  A week later, the number of followers for him increased several times. <br><br>  <b>Compromise DNS Services Router</b> <br><br>  As we mentioned above, a bot is able to redirect DNS requests (DNS hijacking) of the router to the addresses that the attackers need.  Such an operation is performed by the payload code, which is launched only during the infection process of the router.  In addition, by default, the C &amp; C server does not give the bot a command to use DNS redirection.  Below is a typical DNS compromise pattern that attackers can use for their own purposes. <br><br><ol><li>  Malicious users infect with a malicious program routers located close to each other, for example, home routers of users of one ISP provider. </li><li>  Moose is awaiting the interception of network service cookies. </li><li>  When a user logs into their service account, the malware sends this cookie data to attackers. </li><li>  The attackers send the command to the bot, setting it up accordingly: turning off the host check setting for compromise before connecting via Telnet, turning on the DNS hijacking setting, searching for new victim devices is balanced to infect hosts with an IP address range that is close to external IP address of the router. </li><li>  Due to the host check turned off for compromise, Moose will re-infect devices it has already compromised.  In the process of this reinfection, the bot will trigger fake DNS IP addresses. </li><li>  The user remains unaware that his router has been compromised and redirects his programs to fake IP addresses. </li></ol><br>  Further, the bot can configure the DNS records so that they point to phishing sites, malware, and also allow attackers to perform an attack like Man-in-the-Middle (MitM), which will prevent the client from switching to a secure HTTPS connection during operation. with this or that server. <br><br>  <b>General scheme of work</b> <br><br>  As we have already mentioned, Linux / Moose is represented by ELF executable files, in which debugging information is completely absent.  These files are statically compiled with the uLibc library.  In doing so, the malware relies on multithreading in its execution, simultaneously creating more than 30 threads during the infection procedure. <br><br><img src="https://habrastorage.org/files/33d/b6d/858/33db6d8580ca4de285bdc163091fce4c.png"><br>  Fig.  Information about the malicious executable file. <br><br>  As a sample for analysis, we chose the version of the malicious program that runs on the MIPS architecture.  Various screenshots of fragments of malicious code belong to this particular architecture.  We also skimmed through similar samples for the ARM architecture, they turned out to be almost identical.  Below is a diagram of the operation and interaction of the various components of Moose. <br><br><img src="https://habrastorage.org/files/4f4/8df/cfc/4f48dfcfc2474a53910ad7c118ded3aa.png"><br>  Fig.  The scheme of interaction of components Moose. <br><br>  The malware uses a special function to obfuscate messages sent to the C &amp; C server.  This feature is identical for the various options and components of Moose.  Below is its Python code. <br><br><img src="https://habrastorage.org/files/4fd/01b/324/4fd01b3246854eb6b6c9730d9ee7750d.png"><br>  Fig.  The function of obfuscation messages C &amp; C-server. <br><br>  <b>Infection of devices</b> <br><br>  We attributed Moose to a class of malware like the worm (worm) because of its ability to automatically replicate.  To do this, the bot launches three sets of streams, the first one is engaged in scanning arbitrary (random) IP addresses, the second one scans a certain range of addresses, the third one is the streams created on each network interface of the router.  Threads execute the same code fragment, which we will call the scanner thread. <br><br>  The number of threads for each of these sets is determined by the configuration C &amp; C server.  The <i>cnccfg_nb_thdscan_local</i> parameter determines the number of threads that will scan a range of IP addresses that are close to the external IP address of the router.  The <i>cnccfg_nb_thdscan_ext</i> parameter determines the number of threads that will be used to scan randomly taken IP addresses.  The <i>cnccfg_flag_scanner_sniffer</i> parameter defines the latter case.  In a real situation, we observed 10 launched streams of the first set, 20 streams of the second and 1 stream for each interface of the router in the latter case. <br><br>  The figure below shows the above IP address space scan. <br><br><img src="https://habrastorage.org/files/595/ace/f5a/595acef5ac3c47eeb389c5994073bb47.png"><br>  Fig.  The mechanism for finding new victims through the scanning of the space of IP addresses. <br><br>  At each IP address, the malicious code performs the following actions: checks the connectivity to TCP port number 10073. If it successfully passes the TCP procedure of a handshake (handshake), it refuses further actions and considers that this host is already infected.  Information about this will be sent to the reporting C &amp; C server. </div><p>Source: <a href="https://habr.com/ru/post/259175/">https://habr.com/ru/post/259175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259165/index.html">Making a Callback from the site using Askozia PBX</a></li>
<li><a href="../259167/index.html">XSD Design Patterns</a></li>
<li><a href="../259169/index.html">A way to make iptables write to your log and not duplicate to the system</a></li>
<li><a href="../259171/index.html">Level device in NES games</a></li>
<li><a href="../259173/index.html">Data Lake - from theory to practice. Tale about how we build ETL on Hadoop</a></li>
<li><a href="../259177/index.html">Hola VPN extension sells user traffic and contains remote code execution vulnerabilities</a></li>
<li><a href="../259181/index.html">Reuters: US plans to target Stuxnet to North Korea</a></li>
<li><a href="../259183/index.html">16 reasons why players leave your game</a></li>
<li><a href="../259185/index.html">Game server on Scala + Akka: Case study</a></li>
<li><a href="../259187/index.html">Shadow DOM (Shady DOM)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>