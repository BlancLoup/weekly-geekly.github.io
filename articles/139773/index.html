<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Alternative check of preconditions in Code Contracts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When trying to use the Code Contracts library in a real project, a small complexity may arise: although the Contract class itself with methods for tes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Alternative check of preconditions in Code Contracts</h1><div class="post__text post__text-html js-mediator-article">  When trying to use the <a href="http://research.microsoft.com/en-us/projects/contracts/">Code Contracts</a> library in a real project, a small complexity may arise: although the <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.contracts.contract.aspx">Contract</a> class itself with methods for testing preconditions and postconditions, is located in mscorlib starting from version 4 of the .NET Framework, but without installing the Code Contracts library itself, they do not fall into resulting assembly. <br><br>  This can cause certain difficulties in large distributed teams, since for normal use of contracts all developers will have to install an additional extension.  And since the key people of the project may not have a clear confidence in whether it is necessary for us to do this kindly, such a transition may be difficult. <br><br>  However, Code Contracts support an additional ‚Äúcompatibility mode‚Äù, which allows you to ‚Äúhard-fix‚Äù precondition checks in the resulting code, so that they will be visible to everyone, regardless of whether contracts are installed on the developer‚Äôs machine or not. <br><a name="habracut"></a><br><h5>  <b>Formulation of the problem</b> </h5><br>  Let's first look at an example that more clearly shows what the problem is. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s</span></span></span><span class="hljs-function">)</span></span> { Contract.Requires(s != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Length; } }</code> </pre> <br><br>  With this code, everything is fine and if you try to call the <b>Foo</b> method with <b>null</b> , we get a violation of the contract, which, if the Code Contracts library is installed and the preconditioning check is on, will throw an exception 'System.Diagnostics.Contracts .__ ContractsRuntime.ContractException'. <br><br>  Yes, this is exactly what we are waiting for, but the peculiarity is that the <b>exception generation code is not generated by the compiler, but by a separate process that starts immediately after compilation</b> .  And this means that without the Code Contracts library, the execution of this code will lead to the generation of a <b>NullReferenceExcpetion</b> , since no additional validation of the arguments will remain in the shadow.  I have repeatedly come across the fact that this behavior caused something like this: ‚ÄúWTF?  Where did my check go! ‚Äù <br><br>  Since we don‚Äôt want to hear such ‚ÄúWTF?!?‚Äù From our colleagues, whose contracts have not been established, we would like to have a way to fix the precondition check more thoroughly. <br><br><h5>  <b>Manual precondition check</b> </h5><br>  The Code Contracts library allows you to use preconditions in the old format.  This means that if the existing method already contains a check of input parameters (ie, a check of preconditions), then to convert them into full-fledged preconditions after them, it suffices to add the call to <b>Contract</b> <b>.</b>  <b>EndContractBlock</b> : <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"s"</span></span>); Contract.EndContractBlock(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Length; } }</code> </pre><br><br>  Add Call <b>Contract</b> <b>.</b>  <b>EndContractBlock</b> turns one (or several) checks of input parameters into full-fledged preconditions.  Now, for any developer whose contracts are <b>not installed</b> , this code will look like before.  At the same time, contract holders will be able to enjoy all their benefits, such as checking the validity of a program with the help of Static Checker, automatic generation of documentation, the possibility of catching all breaches of contracts (more on this later).  The difference between this method of verification and the fact that they cannot be turned off and cut out of the code completely. <br><br>  This approach can be combined with more advanced contract management techniques.  For example, it is possible to combine the <b>old</b> <b>-</b> <b>style</b> precondition check in conjunction with the check of post-conditions and invariants.  But since the postconditions and invariants relate more to the class itself, and not to its clients, this does not affect all those developers whose contracts have not been established. <br><br>  <b>NOTE</b> <br>  The Code Contracts library allows you to customize which checks should remain in the resulting code.  If developers are confident enough in their code, then they can remove all checks from the code and save a few processor cycles on each of them.  In more detail about the levels of monitoring and opportunities for their management can be found in the article: <a href="http://sergeyteplyakov.blogspot.com/2010/05/blog-post_20.html">‚ÄúMonitoring of statements during the execution period‚Äù</a> . <br><br><h5>  <b>Using existing validation methods</b> </h5><br>  Another standard method for validating arguments is to use special classes (guard) with a set of different methods, such as <b>NotNull</b> , <b>NotNullOrEmpty</b> , etc.  The Code Contracts library supports the ability to turn such methods into full-fledged contracts: for this, the methods of the validator class must be marked with the <b>ContractArgumentValidatorAttribute</b> attribute. <br><br>  <b>NOTE</b> <br>  Unfortunately, the <b>ContractArgumentValidatorAttribute</b> attribute is not included in the .NET Framework version 4.0, it will only appear in version 4.5.  This situation is being tackled by adding the ContractExtensions.cs file to your project, which will appear in% ProgramFiles% \ Microsoft \ Contracts \ Language \ CSharp after installing the Code Contracts library. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Guard</span></span> { [ContractArgumentValidatorAttribute] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IsNotNull&lt;T&gt;(T t) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"t"</span></span>); Contract.EndContractBlock(); } }</code> </pre><br><br>  Now we can use the good old method <b>IsNotNull</b> to check the preconditions: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s</span></span></span><span class="hljs-function">)</span></span> { Guard.IsNotNull(s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Length; }</code> </pre><br><br><h5>  Retreat from the topic.  Contract.ContractFailed </h5><br>  You may have noticed that there are two versions of the <b>Contract</b> method <b>.</b>  <b>Requires</b> , one of which is generic and can be used to generate the desired type of exception, but a violation of the non-generic version leads to the generation of an internal exception of the type <b>ContractException</b> . <br><br>  The reason why the internal exception is generated by default is that contract violation cannot be repaired programmatically.  This is a bug in the code and for its elimination it is necessary to change this code.  However, when using any approach to the verification of preconditions ( <b>Contract</b> <b>.</b> <b>Requires</b> + 2 of the approaches considered today), the user can ‚Äúgrab‚Äù the exception by intercepting the basic type of exception. <br><br>  In the <b>Contract</b> class, there is a <a href="http://msdn.microsoft.com/ru-ru/library/system.diagnostics.contracts.contract.contractfailed.aspx">ContractFailed</a> event that will be triggered if the preconditions / postconditions / invariants are violated.  For example, before running an integration or unit test, you can subscribe to this event, and if the precondition falls, but the test remains green, then you can roll up your sleeves and go look for that careless programmer who catches exceptions that are not intended to be processed. <br><br><h5>  <b>Conclusion</b> </h5><br>  Using one of the approaches described here for the transition to contract programming allows you to smoothly migrate code to contracts without breaking the life of the rest of the team.  At the same time, you can use old means of validation with all the advantages of contracts (including the ability to learn about the violation of preconditions described in the previous section), without forcing everyone to install additional utilities on their machines. </div><p>Source: <a href="https://habr.com/ru/post/139773/">https://habr.com/ru/post/139773/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139767/index.html">Notebook Digital Hi-Note Ultra 2000</a></li>
<li><a href="../139768/index.html">Time.is: atomic time synchronization</a></li>
<li><a href="../139769/index.html">Board Games for Windows Phone: Combat Intelligence</a></li>
<li><a href="../139771/index.html">Apple closes iWork service</a></li>
<li><a href="../139772/index.html">Hewlett-Packard prepares rival Amazon Web Services</a></li>
<li><a href="../139774/index.html">Linus Torvalds on binary compatibility</a></li>
<li><a href="../139775/index.html">Cebit 2012. Final Report</a></li>
<li><a href="../139776/index.html">JQuery UI Documentation in Russian</a></li>
<li><a href="../139777/index.html">Creating Windows 8 and IE10 - a selection of materials for February'12</a></li>
<li><a href="../139780/index.html">Creating Groups for Technology Entrepreneurship from Stanford University</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>