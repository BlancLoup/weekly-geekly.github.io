<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Import a DXF drawing in a Java program, stepping on all the rakes of this ‚Äúsimple‚Äù format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AutoCAD and similar CAD systems have long become a standard in the field of design, and it is not surprising that the DWG / DXF file formats used in t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Import a DXF drawing in a Java program, stepping on all the rakes of this ‚Äúsimple‚Äù format</h1><div class="post__text post__text-html js-mediator-article">  AutoCAD and similar CAD systems have long become a standard in the field of design, and it is not surprising that the DWG / DXF file formats used in them became the same standard.  So if you are developing some kind of solution for architects and designers, the ability to work with these formats (or at least one of them) is a must have feature of your product. <br><br><img src="https://habrastorage.org/files/ca7/72c/33d/ca772c33decd46cc85caa7c1bf88def6.png"><br><br>  As part of my <a href="https://habrahabr.ru/post/282626/">web service to simulate the movement of pedestrians,</a> I had to attend to import master plans in these formats.  I didn‚Äôt deal with CAD in the past, so I naively thought, ‚ÄúWhat else would you think - another format of drawings, lines and polygons, what could be complicated there?‚Äù.  But in the process of work, it turned out that there may be enough complicated there, some nuances are quite similar to ancient crutches stretching from the depths of centuries, while many things are not properly documented in the specifications of the format itself (for example, working with blocks or with curves).  Apparently they are considered obvious to any draftsman, but what to do if you are from another area, and you do not have such knowledge? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, under the cut - a list of rakes and decisions that could not google and had to get midnight vigils over the drawings. <br><a name="habracut"></a><br><br>  <b>Solvable problem</b> <br><br>  For my Java application, I needed to set up import of master plans of regions and convert it into an internal simplified GeoJSON view.  In this case, I did not need complete information and all kinds of entities, only some of them that would be used in the simulation.  So this material does not cover all features and Nontrivial DXF Technical Solutions.  And why DXF, but not DWG?  And about this below. <br><br>  <b>Format selection</b> <br><br>  So, what is primarily associated with the words "autocad" and "file format"?  This is a DWG.  The binary closed format, which was originally created by AutoDesk, and its specifications were not disclosed, but in due time it was successfully reversed by the Open Design Alliance. <br>  And here comes the disappointment # 1: <b>there are no actual free implementations of this format.</b>  At all. <br>  There is a library to work with it from AutoDesk.  There is a popular Teigha library, created by ODA.  And ... everything.  Both are paid, and well paid (talking about hundreds and thousands of dollars).  Does not fit. <br>  There are a number of attempts to implement the standard as a free open-source solution.  For example <i>jdwglib</i> .  But they are all dead for a long time, last updated 5-10 years ago.  But progress does not stand still, new versions of auto-casts add new features to DWG, as a result, you can say goodbye to the dream of reading files of modern versions, as well as with the support and hope of fixing bugs. <br><br>  An alternative is DXF.  Somewhat less popular, but at the same time supported by all CAD systems, initially open and therefore, in theory, more common. <br>  The search for libraries at first is also discouraging - specifically for Java there is not a single living project, the same picture everywhere: recent releases 5 years ago, abandoned repositories, latest news sadly gazing into eternity, full of unjustified optimism and promises.  But by itself, the format, in contrast to DWG, is not so actively developed, so even with a fairly old library it is quite possible to open current drawings. <br><br>  As a result, the Kabeja library was selected, the last release of which was in 2011.  Using the bundled sample (DXF to SVG conversion), it was checked that all actual drawing files open correctly, after which I proceeded to import.  One comment on the issue of parsing DXF from a certain CAD-guru on Stackoverflow, which, they say, ‚ÄúDXF looks simple, but in reality you will be tired of working with him.‚Äù <br><br>  <b>Layers</b> <br><br>  DXF drawing contains a set of layers (layer) and blocks (block).  There are other entities there, but in order to rip out the coordinates of the geometry in the simplest case, they are not needed. <br><br><img src="https://habrastorage.org/files/10c/7ad/462/10c7ad4627514e5398613040f8097b6d.png"><br><br>  Everything is obvious with layers, they work the same way as in some Photoshop.  Layers can be turned on and off and you can set default graphics settings for a layer (that is, for example, all lines by default on this layer will have such and such thickness).  Since my task was only to squeeze the coordinates, I did not deal with mapping issues. <br><br>  Okay, everything seems simple: we run through the list of layers, for each layer - according to the list of objects, we transform the coordinates.  But already here I stepped on the first rake: the <b>set of layers that you see in CAD and which is in the file is not the same thing</b> .  I broke my head, why I suddenly lost pieces of the road.  They are in NanoCAD, not in my export.  I got into the debugger - they are not in the returned Kabeja structures either.  But if you export the file entirely with their sample - they are.  In general, it turned out that one layer from the editor in the file can be represented by several layers, with names like "layerName", "layerName @ 1".  Why it is done and where it comes from - the devil knows it, but the fact is that searching for an exact match of the name of the layer (which even the structure of the library code storing the layers in the Map with the name key hints at) does not work. <br><br>  <b>Blocks</b> <br><br>  Blocks are templates that once drawn can be repeatedly inserted.  In this case, a change in the base unit will change all its inserts.  Conveniently.  Even cooler is that the block can contain objects from several layers.  In this case, the insert also belongs to some layer.  In this case, the block may contain inserts of other blocks.  That is, you can make blocks "section of the house", then make a block of them "house", which is then inserted several times on the card.  In this case, the final object will have several layers (separate fill, separate contours, separate special marks), as well as the original blocks.  All this is very cool from the user's point of view, but adds work to the programmer. <br>  Moreover, a block can be inserted not just once, but repeatedly as a rectangular matrix.  For this, the insertion object has parameters with the number of rows, columns and the distance between them. <br><br>  As a result, the insertion processing code looks something like this: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row = <span class="hljs-number"><span class="hljs-number">0</span></span>; row &lt; insert.getRows(); ++row) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> col = <span class="hljs-number"><span class="hljs-number">0</span></span>; col &lt; insert.getColumns(); ++col) { <span class="hljs-comment"><span class="hljs-comment">//                 ,    . AffineTransform transform = new AffineTransform(); transform.translate( insert.getPoint().getX() - (insert.getColumns() - col) * insert.getColumnSpacing() , insert.getPoint().getY() - (insert.getRows() - row) * insert.getRowSpacing()); transform.rotate(Math.toRadians(insert.getRotate())); transform.scale(insert.getScaleX(), insert.getScaleY()); // Feature    ,    GeoJSON  for (Feature f : block.features) { //   ,  .         Feature inserted = cloneFeatureWithTransform(f, transform); features.add(inserted); } } } return block.features.size();</span></span></code> </pre> <br><br>  It is also important to know that the <b>blocks and layers in the file are not ordered</b> .  That is, alternately processing blocks, you can stumble into it on an insert from another block that has not yet been processed.  To be honest, I don‚Äôt know if it is possible to manage to make a cycle and what will happen in that case. <br><br>  <b>Lines</b> <br><br>  Let me remind you that my task is to convert DXF to GeoJSON, which of all types of geometry recognizes only a broken line and a polygon, no arcs and curves. <br><br>  DXF supports a bunch of different line options: <br><br><ol><li>  Already 2 types of broken lines - Polyline and LWPolyline.  In my case, simple 2D drawings, there is no difference between them. </li><li>  Arcs, and as many as two types - elliptical and circular.  Fortunately, the Kabeja classes already have ready-made methods for obtaining the coordinates of points on them, so it‚Äôs easy to transform an arc into a polyline with the necessary precision. </li><li>  Splines - again Kabeja is able to convert them into Polyline </li><li>  Just linear segments </li></ol><br><br>  It would seem simple, but no.  Even the seemingly simple Polyline type can be used to display second-order curves (and not just broken lines).  To do this, the <i>bulge</i> parameter can be set at the top.  If it is specified, then two vertices are connected not by a straight line, but by an arc of a circle passing through these vertices and the center of which can be expressed through them and this parameter. <br><br><img src="https://habrastorage.org/files/69c/5af/278/69c5af2786eb4330b253dc805f4cd74a.png"><br><br>  Here is the code to determine the center of the circle: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Point </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCenterByVerticesAndBulge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DXFVertex a, DXFVertex b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bulge)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> norm = Math.sqrt(Math.pow(b.getX() - a.getX(), <span class="hljs-number"><span class="hljs-number">2</span></span>) + Math.pow(b.getY() - a.getY(), <span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> s = norm / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> d = s * (<span class="hljs-number"><span class="hljs-number">1</span></span> - bulge * bulge) / (bulge * bulge); <span class="hljs-comment"><span class="hljs-comment">// "direction" double u = (b.getX() - a.getX()) / norm; double v = (b.getY() - a.getY()) / norm; //"center" double c1 = Math.signum(bulge) * -v * d + (a.getX() + b.getX()) / 2; double c2 = Math.signum(bulge) * u * d + (a.getY() + b.getY()) / 2; return new Point(c1, c2, 0); }</span></span></code> </pre><br><br>  I fought over these arcs for a long time, but in the end I spat and turned them off, connecting the vertices directly.  Since in the general plans such arcs are usually used for rounding off at the corners of intersections, I could score on them completely - the difference in terms of simulation is small. <br><br>  <b>Fill / hatch</b> <br><br>  This is what my simulator works directly with.  Buildings, roads and generators, for the time being, I demand to specify with fillings (otherwise it is not clear where the interior is in the jumble of individual lines, and where is the exterior). <br><br>  And here, too, there are nuances: <br><ol><li>  The border of a fill can be any combination of line objects.  Part of the border can be broken, then a few arcs, then just a bunch of segments of different lines </li><li>  One fill object can have an arbitrary number of non-intersecting regions (which is uncharacteristic for many other formats where the polygon has only one outer boundary), each of which can have an arbitrary number of holes </li><li>  Fills can be repeatedly nested: that is, there is a hole inside the fill, in which there is another fill, in which there is again a hole, and all this in DXF is defined by one HATCH object with several borders. </li><li>  There are even more exotic variants of the relationship of pouring and its borders (see picture), but I still don‚Äôt thank God for them </li></ol><br><br><img src="https://habrastorage.org/files/b4e/7b6/0d1/b4e7b60d1a644d4f8df7d5b0555c2987.png"><br><br>  In general, from DXF for filling, we get a bunch of borders that have the flag ‚Äúexternal or internal‚Äù, and then we have to somehow figure out how they are made and how to scatter them along GeoJSON polyvons, which can have only one external border and not have nesting. <br><br>  I went in several ways, but for each algorithm I rather quickly received a drawing on which this algorithm did not work.  For example, this one is here: a street and driveway scheme for a residential area of ‚Äã‚ÄãChita, in which they are all set with literally a couple of HATCH objects with a very complex structure, in which for some reason all borders were marked as external (I sense some kind of bug in Kabeja, as DXF defines at once two similar flags External and Outer, but in the library there is only one): <br><br><img src="https://habrastorage.org/files/0b4/db2/606/0b4db26060674329a9f6c8ab57c976b6.png"><br><br>  As a result, the only working algorithm looks like this: <br><ol><li>  Create a polygon for each outer boundary. </li><li>  Subtract all other boundaries from it, whether they are marked by external or internal </li><li>  Correct possible problems (the polygon turned out to be empty, the holes go beyond the boundaries of the external contour, the polygon broke into unbound areas, etc.) </li></ol><br><br>  For the third point (and indeed for working with the geometry already inside the simulation algorithm itself), I used the JTS library - Java Topology Suite.  It contains quite a lot of all sorts of necessary primitives and operations on working with geometry, starting from operations such as building a buffer and ending with data structures such as a quadtree. <br><br>  <b>Victory?</b> <br><br>  After a lot of torment and having propped everything up with crutches, I nevertheless managed to create support for the DXF subset I needed and upload the drawings directly to my simulator, in order to use them to determine the designers' shoals.  Since I had to extract most of the above information with combat and sitting up to two nights over NanoCAD (not advertising, but this is the only easily accessible free and high-quality DXF editor I found, the same LibreCAD did not master the right to open the first drawing that I did I gave it to him), I decided to share it with the habrasoobschestvom - suddenly my experience will save someone time. <br><br>  Well, yes, here is how the prediction of my algorithm looks for the region from the screenshot above: <br><br><img src="https://habrastorage.org/files/721/7fe/03e/7217fe03e77f4c83b7b251f4fce935e5.jpg"><br><br>  Obvious conclusions - do not make tracks at right angles, but do not and try to make some strange rounding where there is no need.  We'll see in a few years if my prediction when the area is built is justified. <br><br>  Thanks for the plans of the districts thanks to <a href="http://m-ksp.ru/">the Integrated Architectural and Construction Design Workshop</a> </div><p>Source: <a href="https://habr.com/ru/post/301484/">https://habr.com/ru/post/301484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301472/index.html">Storage Federation or all enterprise storage federation</a></li>
<li><a href="../301474/index.html">Seminar "Oracle in the cloud" and a tour of one of the largest data centers in Russia NORD 4, May 26, Moscow</a></li>
<li><a href="../301476/index.html">Application of statistical criteria for solving detection problems in radio engineering</a></li>
<li><a href="../301478/index.html">PHP, static variables inside class methods and one bug history</a></li>
<li><a href="../301482/index.html">JQuery 3.0 Release Candidate Release</a></li>
<li><a href="../301488/index.html">SimSim, open</a></li>
<li><a href="../301490/index.html">Content Marketing in Infographics</a></li>
<li><a href="../301492/index.html">Intel Edison + webcam = barcode scanner</a></li>
<li><a href="../301494/index.html">IoT networking technology</a></li>
<li><a href="../301496/index.html">The first words of major projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>