<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Debugging a Java application that cannot be stopped. We catch exotics with the most accessible means - BTrace approach</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Java applications - this means that in the modern Java world the opportunity to meet this percentage by 90% or even more (consider the most common env...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Debugging a Java application that cannot be stopped. We catch exotics with the most accessible means - BTrace approach</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f27/908/9ca/f279089ca4ff5d11e487a0ea585621b0.jpg"><br>  <b>Java applications</b> - this means that in the modern Java world the opportunity to meet this percentage by 90% or even more (consider the most common environments, HotSpot based JVM version from 1.6) <br>  <b>which cannot be stopped</b> - the application is working, and for one reason or another it cannot be restarted <br>  <b>Exotic</b> - something such that it does not happen every day to catch a head (a certain sequence of calling methods, outlandish combinations of parameter values, ...) <br>  <b>available means</b> - free of charge, efficient, effective, easy, simple, etc., etc.  This article describes the wonderful tool BTrace <a href="https://kenai.com/projects/btrace">kenai.com/projects/btrace</a> <br><br>  And of course nothing has been specifically added to the Java application code regarding debugging tools ... <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article is essentially a continuation of the post ‚ÄúDebugging a Java application when it does not wait at all - welcome to the InTrace approach‚Äù <a href="http://habrahabr.ru/post/219661">habrahabr.ru/post/219661</a> , which showed how to get into an already running application and build a fairly detailed execution trace.  That there is a very useful skill, but in real life, sometimes, there are cases when an incomprehensible behavior jumps with a probability of 1 per 1,000, or even worse, and try to find it in tons of traces. <br>  Therefore, for example, we take a simple program (file excitement / Coin.java) and we will collect ‚Äúexotic‚Äù on the fly. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> excitement; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.BufferedReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStreamReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Coin</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">head</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"  Enter  ..."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(System.in)).readLine(); Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; count &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; ++count) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rand.nextInt(<span class="hljs-number"><span class="hljs-number">2</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Coin().head(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Coin().tail(); } } System.out.println(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>); } }</code> </pre> <br><br>  Compile <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">javac</span></span> excitement/Coin.java</code> </pre><br><br>  And run <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">javac</span></span> excitement.Coin</code> </pre><br><br>  It's easier nowhere, right?  ) <br><br>  For exotics, I‚Äôll take the exciting question: ‚ÄúHow many times in a row will an eagle and tails go out the most, and also how many times will they just fall out?‚Äù This is a rand.nextInt (2) test.  What are the predictions?  Bets are accepted ... <br><br>  Get the answer will help very well-known and, among other things, just a great tool BTrace <a href="https://kenai.com/projects/btrace">kenai.com/projects/btrace</a> , repeatedly mentioned on Habr√© in comments, but unfortunately never described hitherto in posts. <br><br>  To launch it is worth considering a couple of ways: <br>  1) command line lovers - console utility downloaded from <a href="">kenai.com/projects/btrace/downloads/directory/releases/release-1.2.4</a> (latest available version) <br>  and run as <br><pre> <code class="hljs xml">btrace <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PID</span></span></span><span class="hljs-tag">&gt;</span></span> TracingScript.java</code> </pre><br>  Where <br>  PID is the process identifier (obtained, for example, via jps) <br>  TracingScript.java - a tracing script, with which a more intimate acquaintance will be a little further <br><br>  2) window lovers are encouraged to use the VisualVM plugin in <a href="http://visualvm.java.net/download.html">visualvm.java.net/download.html</a> .  Why go to Tools-&gt; Plugins-&gt; Available Plugins, click BTrace Workbench and press ‚ÄúInstall‚Äù, carefully read the license (although who reads them), okay, so be it, without the slightest hesitation, we agree to this and subsequent windows for everything .  And now, after successful installation, in the context menu of the process of interest, a new item ‚ÄúTrace Application ...‚Äù has appeared in VisualVM <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f27/0fe/f82/f270fef82a49ad9b8f06e9d35a86894d.png"><br><br>  BTrace does its job by relying on the algorithm described in a very Java-like script (you can also use D-scripts).  Very similar - because it‚Äôs like Java itself, but still because BTrace does not change the execution of the program being traced (I mean, even so, it tries not to modify its behavior, only to receive information on the execution following the format ‚Äú read-only ‚Äù), you have to forget about a lot of java things (starting with the creation of new objects and ending with many more, see <a href="https://kenai.com/projects/btrace/pages/UserGuide">kenai.com/projects/btrace/pages/UserGuide</a> BTrace Restrictions) and use the tools provided directly by BTrace. <br><br>  And now the script (file TracingScript.java) <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.btrace.annotations.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> com.sun.btrace.BTraceUtils.*; <span class="hljs-meta"><span class="hljs-meta">@BTrace</span></span> <span class="hljs-comment"><span class="hljs-comment">//     public class TracingScript { @Property //    " "  MBean JMX (jconsole, VisualVM, ...) private static long tailCount; @Property(name="Total head count is") //    JMX private static long headCount; @Property private static long maxHeadSequence = 1; @Property private static long maxTailSequence = 1; @Property private static long sequence = 1; @Property private static long prevId = -1; @OnMethod(clazz = "excitement.Coin", //      excitement  Coin method = "head", // c  head location = @Location(Kind.RETURN)) //     public static void onHead() { ++headCount; sequence = prevId == 0 ? sequence + 1 : 1; if (sequence &gt; maxHeadSequence) maxHeadSequence = sequence; prevId = 0; } @OnMethod(clazz = "excitement.Coin", method = "tail", location = @Location(Kind.RETURN)) public static void onTail() { ++tailCount; sequence = prevId == 1 ? sequence + 1 : 1; if (sequence &gt; maxTailSequence) maxTailSequence = sequence; prevId = 1; } @OnExit //     public static void onexit(int code) { println(strcat("total heads:", str(headCount))); // -            println(strcat("total tails:", str(tailCount))); println(strcat("max tail sequence:", str(maxTailSequence))); println(strcat("max head sequence:", str(maxHeadSequence))); } }</span></span></code> </pre><br><br>  In the end, we run this script, click "Enter" in the program waiting for the coins to be thrown and get (from someone both, and I did this): <br><br> <code>total heads:531</code> <br> <code>total tails:469</code> <br> <code>max tail sequence:9</code> <br> <code>max head sequence:8</code> <br> <br>  In general, heads and tails fell out 8 and 9 times in a row (although I had 10-11 times in several launches).  Those who wish are invited to independently verify how much the obtained coincides with the results of the formulas of the theory of probability (so as not to stop here in a complex topic regarding the methods of generating such simple random numbers). <br><br>  Summing up: <br>  BTrace is a pretty powerful tool that allows you to trace very, very wild features on the fly.  This article only touches the tip of the iceberg of its chic features (if you wish, at least take it and write a book), the material is given with the aim of teaching the very basics and getting as interested as possible.  For those hooked, look in more detail here <a href="https://kenai.com/projects/btrace/pages/UserGuide">kenai.com/projects/btrace/pages/UserGuide</a> , first of all, pay attention to the number of annotations and a long list of very, very vital useful examples.  But still, do not forget - everything happens at your own peril and risk, because the transformation of Java classes used by BTrac to achieve the goal (penetration) can always play a cruel joke. <br><br>  And finally, about coins (physics and only) - often the coin is not perfectly balanced (usually the eagle is a bit heavier than tails), so it‚Äôs impossible to get a coin and get 50/50 in real life.  Be alert, take the side of the coin directly with your mind. <br>  Yes, luck will come with you) <br><br>  Thank you for attention! </div><p>Source: <a href="https://habr.com/ru/post/227639/">https://habr.com/ru/post/227639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../227617/index.html">Laughter and psevdoreyting sin</a></li>
<li><a href="../227629/index.html">Google has reported a billion active users of Android</a></li>
<li><a href="../227631/index.html">Reshebnik on gamification. Task # 1: Internet project with UGC content</a></li>
<li><a href="../227633/index.html">Teams from Russia took the first two places in the World Programming Championship</a></li>
<li><a href="../227637/index.html">Entity Framework and Performance</a></li>
<li><a href="../227641/index.html">Google Cardboard. Virtual reality of cardboard and Android-smartphone</a></li>
<li><a href="../227643/index.html">Space whalers</a></li>
<li><a href="../227645/index.html">Happy inventor and rationalizer</a></li>
<li><a href="../227647/index.html">Welding of optical fibers. Part 4: measurements on optics, removal and analysis of the trace</a></li>
<li><a href="../227649/index.html">Gmail api</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>