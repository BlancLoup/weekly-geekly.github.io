<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxmox 4. Day Two. Thin-LVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon friends. After a previously published article a lot of water has flowed, several servers have been raised, several already on the new 5...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxmox 4. Day Two. Thin-LVM</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon friends.  After a previously published <a href="https://habrahabr.ru/post/315086/">article a</a> lot of water has flowed, several servers have been raised, several already on the new 5th version.  There were clusters and CEPH, and even replication with two nodes (a function appeared in 5-ke).  I made a decision for myself (as advised in past comments) that it is easier and more convenient to install debian, mark up the disks correctly and lift proxmox on top of a working soft-raid. <br><br>  About markup, about VLM and thin disks further and will be discussed. <br><a name="habracut"></a><br>  On one server I ran into a very big and unpleasant thing.  The server is separate, on debian 8. With a markup in which a separate large space is allocated under the thin-lvm disk for storing virtual machine disks, there is one subtlety that I did not take into account earlier. <br><br>  <b>Real configuration example:</b> a soft raid-10 of 4 3 TB disks was created. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of the total 5.7 TB, a separate disk of 5.37 LVM-Thin type for virtualo disks is allocated.  There are virtual machines with a total allocated disk space of 4.03 TB.  The machines worked for themselves and gradually filled the discs.  Filling for six months averaged 20-30% in each of the virtual locks. <br><br>  On the next day (of course, Monday, which also coincided with the first day of the long-awaited vacation), our zabbix server began to frantically send via telegrams notifications from the VitroAlk.  First, about the failures of individual services such as http or ssh, and then completely about the loss of pings.  It is useful to connect via ssh to the mail virtual machine, it slows down, nothing is clear from the first couple of seconds, then about a dozen messages from zabbix about the problems of other virtual women arrive here.  I understand with a side glance that it‚Äôs bad for all virtual women, except for the hyper-personal itself.  I climb on it and open the console of the first problematic machine. <br><br>  And see <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"><code>device-mapper: message ioctl on failed: Operation not supported</code> <br> </div></div><br>  The first thing I thought was a soft-raid crumbled.  But why there was no notification on this topic from the hyper himself ‚Äî once, why the hipper works outwardly correctly ‚Äî two. <br><br>  I climb on lvm ‚Äìa And I see general data on pve \ data <br><br>  Data% - 23.51% <br>  Meta% - 99.95% <br><br>  Checkmate. <br><br>  I check the rest of the virtual machines - they have the same write errors, the services frantically twitch in convulsions.  Users are hysterical. <br><br>  Of all the sane articles in Google on this topic - they write the same thing everywhere - to expand the space by adding an additional physical hard disk. <br><br>  Given that getting to our local Ford Knox, where this server is difficult, we lose a lot of time, we send a flash drive with a USB flash drive to 8GB.  After 1.5 hours, it is in place, inserts a USB flash drive, I add it to the lvm group, expand the meta disk by another 3 GB with the command: <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler header</b> <div class="spoiler_text"> <code>lvresize --poolmetadatasize +3G pve/data</code> <br> </div></div><br>  And as a result I get Meta% - 1.58% <br><br>  I restart the machines one by one, checking their disks and fixing problems with my hands, because  some (for example, the mail server) did not want to run humanly without problems and corrections via sfck.  And finally solve the problem. <br><br>  What was it, Carl?  - I ask myself. <br><br>  Creating the Thin-LVM partition and adding it to the proxmox, I didn‚Äôt think that it was necessary to manually take into account the capacity of the metadata, calculate it on the calculator and set it manually when creating the disk.  Why are such important, critical indicators not monitored for example through the same Proxmox GUI? <br><br>  Guys, if not difficult, in the comments, I beg you to comment on this, what has been done wrong, why very little is written about the creation of Thin and precisely about the meta data.  And what are the solutions to the problem besides mine?  Not always, an authorized person with a flash drive, who was allowed into the DC, could be given access to the rack, and I, while on vacation for 1 thousand km, managed to solve the problem at 2:00. <br><br>  PS: Well, the result of course does not suit me.  The flash drive still sticks out in the server.  Added to the LVM group and can die at any time (with the loss of metadata in this case - and this is worse than when the system simply can not write them).  When I return, I will think about how to get rid of the flash drive in other ways (it is no longer possible to change and \ or add a disk to the server).  On this occasion, comrades, I would also like to hear objective comments. </div><p>Source: <a href="https://habr.com/ru/post/339676/">https://habr.com/ru/post/339676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339666/index.html">We attack DHCP part 4. DHCP + ARP + Apple = MiTM</a></li>
<li><a href="../339668/index.html">MBLTdev online quest: prizes and answers</a></li>
<li><a href="../339670/index.html">From a useless hobby to a featured feature on Google Play</a></li>
<li><a href="../339672/index.html">Data geometry 4. Graph space</a></li>
<li><a href="../339674/index.html">Sharing Scrum and DevOps - Translation of the article The Convergence of Scrum and DevOps</a></li>
<li><a href="../339678/index.html">Simple Python Scada (continued)</a></li>
<li><a href="../339680/index.html">Startup of the day (August and September 2017)</a></li>
<li><a href="../339682/index.html">How to get alerts from Jupyter notebook in Telegram?</a></li>
<li><a href="../339684/index.html">Spark - A stunning web microframe for Java</a></li>
<li><a href="../339688/index.html">Developer Tacts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>