<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why the motorcycle could not replace the tank, or the translation of the REG.RU website from the Template :: Toolkit to Text :: Xslate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Behind any major Internet project is an automated information system and a website selling goods or services. The larger the project, the more difficu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why the motorcycle could not replace the tank, or the translation of the REG.RU website from the Template :: Toolkit to Text :: Xslate</h1><div class="post__text post__text-html js-mediator-article">  Behind any major Internet project is an automated information system and a website selling goods or services.  The larger the project, the more difficult the logic of the site, and the greater load it has to bear.  There are challenges to increase the "power" of the site and reduce the response time of pages.  Like everyone who writes such systems, we periodically hold sessions on tuning the speed of our <a href="http://www.reg.ru/">website</a> .  We optimize everything we can reach.  At a certain stage, they rested on the speed of the HTML template, which is not at all clear how to ‚Äúoverclock‚Äù.  We managed to squeeze something using <a href="">caching of subpatterns</a> , but, despite the positive results obtained, the work time of the template engine still remained the cornerstone in the speed of page generation.  More radical measures were needed, perhaps even other template engines ... <br><br>  About the history of one of our initiatives in the difficult task of finding the <s>Holy Grail of</s> the fastest templating engine, read below in the detailed report of Dmitry Karasik, who was involved in this task: <br><br>  ‚ÄúIn my opinion, now everyone is using template engines for web development.  All use and slowly swear at the imperfection of the selected tool.  After all, the migration of a spreading project to another template maker is very difficult, so much more often people prefer to finish something in an already existing package than to rewrite a lot of code with an unknown result. <br><a name="habracut"></a><br>  REG.RU registrar faced the need to increase the speed of its website, written in the <a href="http://www.template-toolkit.org/">Template :: Toolkit</a> , and instructed me to solve this problem.  I was pleasantly surprised that people inside the company, after analyzing possible solutions, decided to transfer the project to another template engine, <a href="http://xslate.org/">Text :: Xslate</a> , while retaining the full syntax of Template :: Toolkit (hereinafter <a href="http://xslate.org/">referred to</a> as TT). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I had heard about Xslate, but had no previous dealings with it.  According to the advertising data on the website, he overtakes TT by 158 times, and if ‚Äúat least one half of what he said is true‚Äù (c), then this looks like an excellent option.  And there wasn‚Äôt much to doubt because of that - most of the project was written in C, and at least, by itself, it‚Äôs faster than a pearl.  Moreover, Xslate partially supports TT syntax.  Looking at the code, it seemed to me that everything was ‚Äúok‚Äù - there is no complete support, probably because the author concentrated on the template engine, leaving the basic outline to those who would be interested in expanding Xslate in this direction (a kind of invitation to participate in the project).  It all looked quite promising, and I decided to finish the Xslate to the point that it supported TT in full or in full enough for the customer, which we joyfully agreed about with REG.RU.  The winners will be, as it seemed, everything - the client will receive a 158 times faster code, Xslate will receive a refined syntax and new users, the community will receive an excellent alternative to TT2, and I, respectively, a profit and a feather in the hat. <br><br>  The problems started almost immediately.  The author of Xslate Goro Fuji (alas, alas) did not respond to any letters, nor to IRC.  My proposal to agree on how to expand the module so that it most corresponded to the author's intention, actually failed.  Maybe my letter was not written in accordance with the rules of Japanese etiquette.  I used to come across conferences with programmers from Japan, and if I couldn‚Äôt manage to establish a deeper contact than on-duty smiles and hello, it‚Äôs probably more difficult to go online. <br><br>  ‚ÄúWell, it's nothing,‚Äù I thought, ‚ÄúIn the end, the RTFS mantra has never failed.‚Äù  If the code is quality, you can always publish a patch or a forked project, even if the author does not want to cooperate.  In the end, I do not pretend to understand how to develop Xslate as a project, but I am only going to use its highly optimized engine as a base. <br><br>  And I began to study the module.  In fairness, it's worth saying that both the code and the Xslate architecture are great.  They should be studied by students, and programmers with experience would also do well to look.  Xslate is built around the fact that template engines mostly chase text back and forth, and the optimization started already at this level - replacing the usual barley concatenation <br><br><pre>  $ a. = $ b </pre><br>  copied to C is the same analog, but as light as possible.  Also, all processing is also in C: atomic operations of the template engine (for example, the above concatenation or operations in terms of TT as [% IF%], [% CALL%], etc.) are not only written in C, but also the run cycle of the template file is written on it.  This means that the cycles required for calling the procedures (even if written in C) from pearl were saved, and this is a rather expensive operation.  This trick turned out to be possible, because a pattern that looks fairly ordinary, like, for example, written on TT <br><br><pre> [% IF a%]
    text a
 [% ELSE%]
    text b
 [% END%] </pre><br>  Xslate translates to pseudo-assembler commands like <br><br><pre> .if a
 .literal "text a"
 .print # 1
 .goto 3
 .literal "text b"
 .print # 2
 .end
</pre><br>  and then into a binary compiled file.  Unlike TT, which also compiles templates, but in a pearl-barley code that looks something like this: <br><br><pre> Template :: Document-&gt; new ( 
     BLOCK =&gt; sub {
         ...
         eval {
             ...
             if ($ a) {
                $ output. = "text a";
             } else {
                $ output. = "text b";
             }
             ...
         }
     }
 )
 ...
</pre><br>  and then it is loaded with the usual eval. <br>  But this was not enough for the author of Xslate!  The code that executes the individual "assembler" commands was not made in the way that one might think, for example (schematically): <br><br><pre> for (i = 0; i &lt;opcodes.length; i ++) {
     opcodes.list [i] .callback ();
 }
</pre><br>  and using the so-called  <a href="http://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B8%25D1%2582%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4">sewn code</a> : <br><br><pre>     LABEL (noop): TXCODE_noop (aTHX_ st);  goto * (st-&gt; pc-&gt; exec_code);
     LABEL (move_to_sb): TXCODE_move_to_sb (aTHX_ st);  goto * (st-&gt; pc-&gt; exec_code);
     LABEL (move_from_sb): TXCODE_move_from_sb (aTHX_ st);  goto * (st-&gt; pc-&gt; exec_code);
     LABEL (save_to_lvar): TXCODE_save_to_lvar (aTHX_ st);  goto * (st-&gt; pc-&gt; exec_code);
     ...
     LABEL (end): TXCODE_end (aTHX_ st);
</pre><br>  where the execution "jumps" between the goto, until the opcode "end" is encountered.  In fact, unnecessary function calls do not occur at all, if, for example, the TXCODE_move_to_sb code looks like register.a = register.b, which allows the entire processor body to theoretically fit in the processor cache (in practice this is unrealistic, since templates do not consist only of simple action - very often calls for pearl barley functions are required). <br><br>  From the side of the parser, everything looked interesting too.  For me personally, the mechanics of parsing, all these LL / LR / LALR parsers have never been particularly interesting, but I can appreciate the idea.  Both TT and Xslate are small independent languages, and not just a set of directives (for example, on Xslate, you can "golf" here are the commercials: <br><br><pre>  Hello, &lt;: $ lang // "Perl":&gt; world! </pre><br>  However, TT used the old proven lex / yacc method performed by Parse :: Yapp, which personally appeals to me most.  Xslate used my own parser, which was made like a <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B8%25D1%2581%25D1%2585%25D0%25BE%25D0%25B4%25D1%258F%25D1%2589%25D0%25B8%25D0%25B9_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7">top-down parser</a> , and which I had never encountered before.  I will not go into details here, I will only say that extending the syntax with this type of parser was far from the most pleasant task from my experience.  Mostly due to the fact that many parts of the code were common to all syntaxes supported by Xslate, and we had to break apart each of them. <br><br>  However, the biggest problems were still ahead, in runtime.  As it turned out, Xslate in runtime simply does not have a mechanism similar to TT-shn [% CALL%], which can call a function defined in another template.  With this, I found how to fight, having spent a couple of weeks of free time picking in his pseudo-assembler and trying to understand his principles, so as not to break anything.  It also turned out that TT has the ability to use asymmetric brackets, for example, [% - ...%], but the Xslate parser does not know how.  But the biggest sticking point was that TT and Xslate just have very different scope visibility for variables, i.e.  if in TT I write [% foo = 'bar'%] and after that the variable foo is visible in all subtemplates, in Xslate it is a local variable. <br><br>  All these problems were, of course, solvable, but again the question arose of a balance of effort and result ‚Äî the pilot assessment of the project did not suggest such a scale of changes.  After a meeting with the customer, it turned out that the company was interested in a performance increase of at least twice.  And I decided to evaluate how much you can really raise productivity, and, roughly speaking, ‚Äúis it worth it?‚Äù <br><br>  With this, everything turned out to be simple - Devel :: NYTProf, an excellent profiler (after many years with Devel :: DProf especially), produced just such an interesting picture when tracing the template: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/340/bb5/99d/340bb599d2984d42c6213b5587d1b82e.jpg" alt="image"><br><br>  The table was once again five times longer, and I removed some of the lines for clarity, but even a cursory analysis suggests that the main load is not due to the TT, but independently of it.  As a result, even if we make it so that the speed from replacing the TT with the Xslate is zero, then this will not give the desired two-fold increase.  Nevertheless, in order not to retreat completely empty-handed, I decided to dig a little more, and found what I found: <br><br>  ‚Ä¢ In main_menu.inc and index.html, I discovered a tritely slow code like <br><br><pre> [% FOR x%]
 [% FOR y%]
 ... do something ...
 [% END%]
 [% END%]
</pre><br>  which is easily rewritten at a faster rate.  One of these, I think, you can already raise the speed in the right two times. <br><br>  ‚Ä¢ Then - Template :: Stash, part of the TT.  This main suspect, it turns out, has long been firmly optimized for nowhere in Template :: Stash :: XS - apparently, once upon a time his speed also interfered with someone‚Äôs speed.  However, it was the barley part that was problematic, which I, having cut back a little, lowered from 356ms to 238ms.  The only problem is that my ‚Äútrimming‚Äù works specifically for this customer and with this particular profile, and the patch for general use will not make sense.  In other words, you can use a local hack, but then the system administrator will have to impose it every time.  Doubtful benefit is obtained, in general.  Who cares, here it is: <br><br><pre> --- Template-Toolkit-2.24 / xs / Stash.xs.0 2012-11-22 23: 26: 54.670467300 +0100
 +++ Template Toolkit-2.24 / xs / Stash.xs 2012-11-22 23: 26: 39.406594300 +0100
 @@ -1198.21 +1198.7 @@
      }
 
      if (! SvOK (RETVAL)) {
 - dSP;
 - ENTER;
 - SAVETMPS;
 - PUSHMARK (SP);
 - XPUSHs (root);
 - XPUSHs (ident);
 - PUTBACK;
 - n = call_method ("undefined", G_SCALAR);
 - SPAGAIN;
 - if (n! = 1)
 - croak ("undefined () did not return a single value \ n");
 - RETVAL = SvREFCNT_inc (POPs);
 - PUTBACK;
 - FREETMPS;
 - LEAVE;
 + RETVAL = newSVpv ("", 0);
      }
      else
</pre><br>  Roughly speaking, calling undefined is too expensive, and you just need to return an empty string.  But, if these are 60 thousand calls, then the time spent will increase accordingly. <br><br>  ‚Ä¢ IO :: Uncompress :: * and IO :: Compress :: *, as it turned out, are related to memcached - it compresses the data if its volume exceeds the default megabyte.  I played with this option, but the improvement was microscopic. <br><br>  ‚Ä¢ Finally, Template :: Iterator, 180660 calls.  I rewrote it partially on XS and lowered it from 263 to 7ms, which is 5-7% of the entire request.  The result is uploaded to CPAN as <a href="">Template :: Iterator :: XS</a> .  This is the only thing that can benefit the community.  If you have an existing project on a TT, then you can easily embed this module like this <br><br><pre> use Template;
 use Template :: Iterator :: XS;
 $ Template :: Config :: ITERATOR = 'Template :: Iterator :: XS';
</pre><br>  and see what comes of it. <br><br>  The results were such that they could not boast.  The question of how best (and whether it is worth it at all) is to move from TT to something else remains open to me.  Moreover, it is impossible to make an unequivocal conclusion that TT is very bad - in any case, in terms of speed of implementation, but this is more likely a matter for general discussion. <br><br>  Finally, I want to thank REG.RU for the opportunity to delve into the interesting code and for perseverance in publishing the Module :: Iterator :: XS module - the result of which was this article, which, on my initiative, would hardly have seen the light.  Usually, companies are frankly not interested in the fact that the code that was written on their order was published anywhere.  In this regard, REG.RU was a pleasant exception, for which I, on behalf of the pearl barley community, express my gratitude. ‚Äù </div><p>Source: <a href="https://habr.com/ru/post/161351/">https://habr.com/ru/post/161351/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161333/index.html">The road to victory at Russian AI Cup 2012</a></li>
<li><a href="../161335/index.html">JAVA library padeg - New Year's gift habr</a></li>
<li><a href="../161337/index.html">How to blow fire from water</a></li>
<li><a href="../161341/index.html">Flowmaster: Notsen Wireless HDMI</a></li>
<li><a href="../161345/index.html">We remind users to change their password in Windows 7 / Windows 8: NetWrix Password Expiration Notifier</a></li>
<li><a href="../161353/index.html">Review of the PocketBook Touch reader</a></li>
<li><a href="../161355/index.html">App Annie: Half of Google Play‚Äôs revenue from the Asian market</a></li>
<li><a href="../161359/index.html">From home automation and smart homes in general to a specific example.</a></li>
<li><a href="../161361/index.html">Transferring non-exported Crypto-PRO containers</a></li>
<li><a href="../161363/index.html">City infrastructure for Nokia Lumia 920</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>