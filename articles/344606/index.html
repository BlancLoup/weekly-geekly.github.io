<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dependencies of our dependencies or a few words about the vulnerability of our projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dependencies of our dependencies 


  


 This story began on November 30 in the morning. When a completely normal Test environment build suddenly fel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dependencies of our dependencies or a few words about the vulnerability of our projects</h1><div class="post__text post__text-html js-mediator-article"><h1 id="zavisimosti-nashih-zavisimostey">  Dependencies of our dependencies </h1><br><p> <a href="https://habrahabr.ru/post/344606/"><img src="https://habrastorage.org/webt/ki/7z/xa/ki7zxaym5aqmfx-0umizkdwtcxq.jpeg"></a> </p><br><p>  This story began on November 30 in the morning.  When a completely normal Test environment build suddenly fell.  Probably, some linter fell off, without waking up, I thought and was wrong. </p><br><p>  To whom it is interesting what this story ended and what thoughts it suggested - I ask for cat. </p><a name="habracut"></a><br><p>  When I opened the build log, I saw that npm install had crashed.  I thought strangely.  Last night everything worked fine.  After studying the logs for some time, a suspicious line was found: </p><br><div class="spoiler">  <b class="spoiler_title">this is suspicious...</b> <div class="spoiler_text"><pre><code class="javascript hljs">node --<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> <span class="hljs-string"><span class="hljs-string">'if (require("./package.json").name === "coffee-script") { var red, yellow, cyan, reset; red = yellow = cyan = reset = ""; if (!process.env.NODE_DISABLE_COLORS) { red = "\x1b[31m"; yellow = "\x1b[33m"; cyan = "\x1b[36m"; reset = "\x1b[0m"; } console.warn(red + "CoffeeScript has moved!" + reset + " Please update references to " + yellow + "\"coffee-script\"" + reset + " to use " + yellow + "\"coffeescript\"" + reset + " (no hyphen) instead."); console.warn("Also, a new major version has been released under the " + yellow + "coffeescript" + reset + " name on NPM. This new release targets modern JavaScript, with minimal breaking changes. Learn more at " + cyan + "http://coffeescript.org" + reset + "."); console.warn(""); }</span></span></code> </pre> </div></div><br><p>  Here I was again surprised.  Again, yesterday we did not use coffee-script on the project and it‚Äôs unlikely that much has changed overnight.  A quick review of package.json confirmed that no adversary had added anything to it.  So, probably, we have updated some kind of dependency that uses coffee-script.  But it was against this idea that for quite some time I had set strict versions for all dependencies of the project and, as it seemed to me, this could not happen.  Having no results looking for a similar problem on the Internet, I again returned to the thought of a renewed dependency.  Therefore, a script was written on the knee which bypassed all package.json s in node_modules in search of coffee-script.  There were about 5-6 such dependencies.  This further strengthened my suspicions, and not much time thinking, I demolished the entire node_modules, and at the same time all dependencies except one in the local repository and launched npm install again.  The process was successful.  Then, step by step, the dependency was found, which brought down install. </p><br><p>  It turned out to be karma-typescript, which had a pad in transitive dependency, which in turn depended on coffee-script.  And here I am depressed again.  There were few options.  Or temporarily disable the tests, or wait for the fix, or fork and fix it yourself (and it‚Äôs not very clear what exactly needs to be fixed).  Without much hope, I went to Github to create an issue.  What was my surprise when I was answered literally after 20 minutes.  It turned out that some comrade decided to update the coffee-script package to npm and instead of declaring the old package obsolete, he simply made him unpublish. </p><br><div class="spoiler">  <b class="spoiler_title">One of the comments from the community:</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ze/c4/g1/zec4g1ovo_nqruhnh_fns5yahxe.png"></div></div><br><p>  Fortunately, @ondrejbase has already suggested <del>  crutch </del>  temporary solution that helped me.  And the whole story ended relatively cheaply.  But it could not be so. </p><br><p>  It was a saying.  And now I propose to talk about the dependencies of our projects and the problems that they bring to us. </p><br><p>  Let's start with the simple. </p><br><h2 id="globalnye-zavisimosti">  Global dependencies </h2><br><p>  Recently, I once again came across an article for beginners that began with the line </p><br><p> <code>npm install -g typescript</code> </p> <br><p>  And could not resist.  In my opinion, this is one of the worst tips you can give a beginner developer.  I'm serious.  Here are the problems this advice leads to: </p><br><ul><li>  Local repository conflict.  Collecting all the code using global dependencies (tsc, for example) or validating it with global linters, we can no longer easily update these dependencies.  After all, updating something global, we endanger all repositories in which it is used.  As a result, you have to either spend time updating these dependencies in all repositories, or not updating them at all. </li><li>  Conflict with team members.  The use of global dependencies in teamwork leads to their desynchronization.  And, as a result, to the fact that my code does not gather or does not pass the test of my colleague. </li><li>  Conflict with build machine.  What I gather is not guaranteed to build on the build machine.  Or, which is much worse and more cunning - it will not be collected in the same way as mine.  And this is a guaranteed debug hell for the next hour or more. </li></ul><br><p>  And all this happens because most manuals start with <code>npm install abc -g</code> .  Although you can put everything locally and connect to package.json as <code>./node_modules/.bin/tsc</code> </p><br><p>  If you are thinking of writing your guide, please remember this article and save my nerves, as well as the nerves of all those who will use it in practice. </p><br><p>  NB Globally installing code generators (create-react-app, create-angular-app) is fine.  They will work once and that's it.  In addition, you do not need to install them again when you decide to create the next repository. </p><br><h2 id="nestrogie-zavisimosti">  Soft dependencies </h2><br><p>  Let's go further.  Install the create-react-app, and create the base application.  We go in package.json and what we see there? </p><br><p> <code>"react": "^16.2.0"</code> </p> <br><p>  Everyone (or almost everyone) knows what the ^ symbol means.  It means that npm can set any version older or equal to that specified, within the major release.  And what's wrong with that?  I do not want to be categorical, but, as for me, this approach is also ‚Äúnot very‚Äù, and this is why: </p><br><ul><li>  Loss of control.  As soon as you left ^ or ~ in your package.json you lost control of your code.  Of course I exaggerate, but think.  You are loading into the project a version of a third-party library about which you don‚Äôt even know its version.  Only that it lies in the repository from some publisher.  And suddenly, what will happen, we can only hope that this package has a fairly organized community to notice. </li><li>  Changes breaking backward compatibility.  Of course, publishing a major version, the developers promise that there will not be breaking changes within it.  But, gentlemen, let's be realistic.  This is the Internet, and this is open source: no one owes you anything.  What worked an hour ago can fall off with a comment like: ‚ÄúThis is a new release targets modern JavaScript, with minimal breaking changes‚Äù. </li><li>  Invisible updates.  Suppose I have a library of the form abc: ^ 2.1.1.  And, it turns out, I do not know what version of the library I actually have.  Maybe 2.1.1, and maybe 2.9.9.  And it seems that this is not a problem, on the contrary.  I do not need to look for documentation for a particular version, it is enough to always look the latest.  And here I look at it, and I see a new chip, and it does not work.  But it does not work because I just forgot to update the library.  I update it, comedy code, and after 30 minutes my colleague runs to me because his application does not work!  And three more come for him and make me sad.  Who needs it? </li><li>  And finally: dependency dependencies.  This is the cherry on the cake and this is what I would like you to think about. </li></ul><br><h2 id="zavisimosti-nashih-zavisimostey-ili-znz">  Dependencies of our dependencies or ZNZ </h2><br><p>  Let's start with why we have a broken build.  All dependencies were set rigidly and nevertheless we fell.  Despite the fact that the versions of our main dependencies remained the same (remember, no ^, ~ in package.json) their dependencies were not so strict.  We did not control the dependencies of our dependencies, although we tried.  And, that the most unpleasant such behavior is encouraged by default.  I don't know who did it and why, but he put a big pig on all of us, and especially on those who practice continuous-integration. </p><br><p>  Of course, this particular problem is easy to fix.  It is enough to create a lock-file (for example, using the npm shrinkwrap command) or use yarn, a package manager that by default captures all dependencies of your project. </p><br><p>  However, this solves only part of the problem.  There remains one more, much more dangerous part of it, and its name is <a href="https://docs.npmjs.com/cli/unpublish">unpublish</a> .  If you have not encountered this problem before, then <a href="https://habrahabr.ru/post/280039/">here is an excellent article</a> that shows the entire vulnerability of modern web development.  At any time, deliberately or through carelessness, your project may stop being assembled just because someone has deleted his package from npm.  And it's not difficult to do that.  Simply enter the unpublish command.  This misfortune <a href="https://docs.npmjs.com/misc/registry">can be fought</a> .  But let's be honest with ourselves?  Which one of us has its own local npm?  And who even thought about it?  I'm afraid not so much.  And I only hope that you are now warned. <br>  By the way, if you log into my repository (do not do this, please), you will see that almost all my projects violate everything that was said above.  And this is another proof of how widespread the problem is. </p><br><h2 id="vyvody">  findings </h2><br><ul><li>  Use the global installation flag wisely.  You should not use it for those dependencies on which your project will constantly depend. </li><li>  If you are not working on one or several physical machines, consider setting the dependencies strictly.  This will allow you to have the same basic project dependencies in all repositories and with colleagues.  In addition, you will increase control over your own code and the process of updating it. </li><li>  Use lock file.  Especially if you are going to use continues-integration. </li><li>  Think about private register packages.  This not only saves you from sudden removal of packages, but also speeds up the installation of dependencies on the build machine.  And this will save your time and the amount of coffee that is drunk while the build is underway during pull requests. </li></ul><br><p>  I have everything on it, I hope it was interesting and useful.  According to a strange tradition, there should be some kind of advertisement here, but I don‚Äôt have it, so I‚Äôll just pass on thanks to my colleagues who put out this fire with me. </p><br><p>  And I apologize for the English words, but in the Russian equivalent they severely hurt the eyes. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/344606/">https://habr.com/ru/post/344606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344596/index.html">Hadoop 3.0: a brief overview of new features</a></li>
<li><a href="../344598/index.html">The ill traveler and the yellow October</a></li>
<li><a href="../344600/index.html">Tutorial on the Unreal Engine. Part 4: UI</a></li>
<li><a href="../344602/index.html">Blockchain 101: Books, Research, and Related Articles</a></li>
<li><a href="../344604/index.html">ChatScript Intelligent Chat Bots: The Basics</a></li>
<li><a href="../344608/index.html">Italian robot strike</a></li>
<li><a href="../344610/index.html">Innopolis eyes of a resident of Moscow</a></li>
<li><a href="../344614/index.html">Adding special offers to customers in emails using Zentyal + Postfix + alterMIME</a></li>
<li><a href="../344616/index.html">Criticism 1C</a></li>
<li><a href="../344618/index.html">‚ÄúI should always be in sight‚Äù - Interview with Oleg Shelayev from ZeroTurnaround (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>