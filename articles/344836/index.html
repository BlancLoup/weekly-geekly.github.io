<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lack of RAM in Linux on a working PC: optimization and actions when it hangs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On any operating system there is often not enough RAM. Consider, as well as save on the increase in hardware resources of the machine with Linux, and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lack of RAM in Linux on a working PC: optimization and actions when it hangs</h1><div class="post__text post__text-html js-mediator-article"> On any operating system there is often not enough RAM.  Consider, as well as save on the increase in hardware resources of the machine with Linux, and continue to more or less comfortable to use a computer with Linux in conditions of insufficient memory. <br><a name="habracut"></a><br>  This situation is typical: there is a swap (swap, swap partition), which begins to be used when there is a shortage of RAM, and it is placed on the HDD, that is, a hard disk with a low speed of reading information.  In such situations, the operating system starts to slow down, the mouse cursor hangs, it is difficult to switch to the next tty, etc.  Why?  Because the Linux kernel scheduler cannot execute a request for an action in a running program until it has access to its RAM, it cannot perform the following action either, it creates a queue of read requests from the disk, and the system ‚Äúhangs‚Äù precisely because That queue processing is much slower than the user wants. <br><br>  If at such a moment you run <code>htop</code> or <code>uptime</code> , the Load Average (LA) will be very high, despite the low load on the processor cores.  The combination of a high load average and a low processor load indicate a clogged processor queue. <br><br>  Often on the Internet, it is advised to change the Linux kernel parameter <code>vm.swappiness</code> .  You can find out its current value on your system as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>sysctl vm.swappiness</code> <br> <br>  The answer will be 60 almost certainly.  This means that the Linux kernel starts swapping rarely used pages of RAM when the use of free RAM reaches 100% - <b>60</b> % = 40%.  Often there are recommendations to put, for example, vm.swappiness = 10, so that the swap does not begin to be used until the OZ load reaches 90%.  In fact <b>, you do not need to touch vm.swappiness, you are no smarter than the Linux kernel developers, who did not just set 60 by default</b> .  Why? <br><br>  Imagine that you have only 4 GB of RAM, of which 3 GB is now occupied, vm.swappiness = 10, the hard disk swap (HDD) is 0% busy, and you open a heavy website in the browser, which requires more than available free 1 GB, for example, 2 GB.  The operating system begins on an emergency basis to send to the swap at least 0.5 GB (and in fact more), so that you can allocate the required amount of RAM to the browser.  This procedure becomes the highest priority, and you will have to sacrifice even the movements of the mouse cursor in order to complete it as quickly as possible.  Are you waiting.  It takes 5 minutes, and the system breaks down, because it has completed the procedure of 100% loading of the access queue to the slow hard disk on which the RAM (swap) is located.  With default vm.swappiness = 60, rarely used memory pages are dumped into a swap in <b>advance</b> , and there is no sudden hang for 5-10 minutes. <br><br><h2>  zram and swap priorities </h2><br>  I recommend to enable <strong>zram - transparent compression of the contents of RAM</strong> .  This is automated in Ubuntu, just install the package: <br><br> <code>sudo apt install zram-config</code> <br> <br>  Hereinafter, for Rosa and Fedora distributions everything is the same, but instead of zram-config - <br><br>  <code>zram-start</code> . <br><br>  The systemd <code>zram-config</code> on Ubuntu will be automatically added to startup when the package is installed and started when the system is rebooted.  To start manually: <br><br> <code>sudo systemctl start zram-config</code> <br> <br>  stops: <br><br> <code>sudo systemctl stop zram-config</code> <br> <br>  Remove from autorun: <br><br> <code>sudo systemctl disable zram-config</code> <br> <br>  Adding to autorun: <br><br> <code>sudo systemctl enable zram-config</code> <br> <br>  When running, zram-config takes a number equal to 50% of the total RAM, then makes one virtual device / dev / zramN, where N starts at 0, for each processor core, and the volume of each / dev / zramN is 50% of the entire operative memory divided by the number of processor cores.  This is done to parallelize the compression of the contents of RAM by the processor cores;  as far as I know, on modern Linux kernels, a single device / dev / zramN is enough, and it will parallelize itself, but I am completely satisfied with the sparking work of the zram-config, and I prefer not to go into it with my hands. <br><br>  The <code>swapon -s</code> will list all involved swaps with their priority.  The first is the swap whose priority is higher.  If you already have a disk swap and zram is enabled, then in the case of the above-described auto-configurator package, the priorities out of the box will be correct.  For example, a disk swap will have -1, and all / dev / zramN will be 5. Thus, zram is first used, and only then the disk. <br><br>  By the way, zram is often used on smartphones, it does not create any noticeable load on the processor with the default compression method lz4. <br><br>  Also, the priority of the swap can be specified in <code>/etc/fstab</code> .  I will show with an example how it was done on my work computer with 6 GB of RAM. <br><br><pre> <code class="hljs swift">$ cat /etc/fstab | grep <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>  <span class="hljs-type"><span class="hljs-type">SSD</span></span> <span class="hljs-type"><span class="hljs-type">UUID</span></span>=844fc9fb-509d-4dab-9ea5-a3d5142f76d8 <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> sw,pri=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span>  <span class="hljs-type"><span class="hljs-type">HDD</span></span>   <span class="hljs-type"><span class="hljs-type">UUID</span></span>=b643c42a-0abd-4f35-<span class="hljs-number"><span class="hljs-number">8865</span></span>-7a51be5769e8 <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-built_in"><span class="hljs-built_in">swap</span></span> sw,pri=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  The <code>pri=X</code> mount option sets swap priorities.  If you also enable zram, the picture will be like this: <br><br><pre> <code class="hljs pgsql">$ swapon -s Filename <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> Size Used Priority /dev/sdb3 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">1005564</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> /dev/sda2 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">6655996</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> /dev/zram0 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">690764</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> /dev/zram1 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">690764</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> /dev/zram2 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">690764</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> /dev/zram3 <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">690764</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br>  First of all, it will swap into a zram, that is, it will be compressed inside the RAM without using an external device for swap, the second will use a small swap on the SSD.  Almost never will be used 6 GB swap on the HDD, but they will be needed if I want to send the computer to sleep in conditions of a large load of RAM.  (Actually, my zram is disabled). <br><br>  On office PCs with 4 GB of RAM (Xubuntu 16.04, 17.10) I always put the <code>zram-config</code> package.  Chromium, according to observations, by the eye, is very well compressed in RAM, with the result that zram allows you to make the work much more comfortable without upgrading the iron. <br><br><h2>  Quickly cut down the program, overloading the RAM.  RAM capacity for SSH </h2><br>  It happens that even with vm.swappiness = 60, some feature, as a rule, the browser, requires a lot of RAM, and the system hangs.  It is solved very simply: the <strong>Alt + SysRq (PrintScreen) + F</strong> key combination forces oom_killer to forcibly turn on and cut down the process that at the time of the call takes up the most memory.  Strictly 1 process for 1 challenge, and strictly something will be killed.  If you press it many times in a row, the graphical session will most likely restart.  The kill event is reflected in <code>dmesg</code> red. <br><br>  However, this thing, called Magic SysRq, is disabled in most distributions out of the box, because an unprivileged user can kill absolutely any process.  For this, the kernel.sysrq kernel parameter <code>kernel.sysrq</code> ; you can find out its current value as follows: <br><br>  <code>sysctl kernel.sysrq</code> . <br><br>  Alt + SysRq + F requires kernel.sysrq = 1.  To do this, we will edit the kernel parameters located in the /etc/sysctl.conf files (usually the symlink on /etc/sysctl.d/99-sysctl.conf) and /etc/sysctl.d/*.conf.  It is best to create a separate file: <br><br> <code>sudo nano /etc/sysctl.d/99-dumalogiya.conf</code> <br> <br>  We write in it: <br><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#    Alt+SysRq,  .. Alt+SysRq+F </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   OOM Killer kernel.sysrq = 1 #  8    ,    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   ,      SSH  . vm.admin_reserve_kbytes = 60192</span></span></code> </pre><br>  Press Ctrl + O, Enter to save. <br><br>  In the case of the browser Chromium Alt + SysRq (PrintScreen) + F will cut down one tab, without closing the browser itself, which is very convenient. <br><br><img src="https://habrastorage.org/webt/u1/3v/bm/u13vbm2nbnusegbrvekjquvh1ke.png"><br><br>  Magic SysRq keystrokes are intercepted directly by the Linux kernel, so they work even when the X server hangs because of the processor queue. <br><br>  vm.admin_reserve_kbytes is the size of RAM in kilobytes, which will be kept guaranteed free for administrative purposes, for example, SSH.  The default is about 8 MB.  It is advisable to increase the number 60192 almost from the bald. <br><br>  I uploaded /etc/sysctl.d/99-dumalogiya.conf to the deb-package dumalogiya-sysctl, which I put in my repository and put it on all computers, very conveniently, you can update the config in a centralized way, and you do not need to manually configure each machine.  As an instruction for building simple deb-packs on my knees, I recommend <a href="https://debian.pro/1390">https://debian.pro/1390</a> .  The repository was created using aptly, which simply creates the structure of files and folders within the web server directory. </div><p>Source: <a href="https://habr.com/ru/post/344836/">https://habr.com/ru/post/344836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344824/index.html">Deep Learning with Spark and Hadoop: Meet Deeplearning4j</a></li>
<li><a href="../344826/index.html">Microkernel vs. monolith and the "triumph" of MINIX</a></li>
<li><a href="../344830/index.html">Quantum computing: annealing with switches and other fun</a></li>
<li><a href="../344832/index.html">Stay lazy with angular / cli</a></li>
<li><a href="../344834/index.html">In France, bitcoins are not money</a></li>
<li><a href="../344840/index.html">Tutorial on the Unreal Engine. Part 6: Animation</a></li>
<li><a href="../344842/index.html">Description of business processes. Use caution</a></li>
<li><a href="../344844/index.html">Surrogates</a></li>
<li><a href="../344848/index.html">Irreparable consequences of HolyJS 2017 Moscow</a></li>
<li><a href="../344852/index.html">How to make friends with Skype and proxy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>