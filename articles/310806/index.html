<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My most important project was the bytecode interpreter (or ‚Äúhow to see the matrix‚Äù)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the forums I often see questions from novice C ++ programmers: ‚Äúwhich literature would you recommend?‚Äù. I usually answer with a set of reliable boo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My most important project was the bytecode interpreter (or ‚Äúhow to see the matrix‚Äù)</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/e9c/ac8/2ae/e9cac82ae63a4a4d81d48fa911779faf.jpg"></p><br><p>  In the forums I often see questions from novice C ++ programmers: ‚Äúwhich literature would you recommend?‚Äù.  I usually answer with a set of reliable books with the addition: no amount of books read will replace practice.  You need to actually do something.  But what?  What could be a good project?  You need something that will teach a lot, but it is quite simple and interesting in order not to get bored.  I recently thought about this question, and seems to have found the answer.  You should definitely write a bytecode interpreter.  For me, such a project has been decisive in the development of the entire subsequent career. </p><br><h2>  How it all began </h2><br><p>  In 200X, I was a second year student at the university.  I already had a little programming experience.  I was able to use abstractions available in C ++, I did not really understand how everything works.  For me, the compiler and the operating system were just black boxes, working through magic spells, and I generally found this acceptable. <a name="habracut"></a></p><br><p>  Lack of knowledge did not prevent me from actively participating in the wars of programming languages.  One of these threads prompted me to get acquainted with the Java virtual machine, and I learned about the <a href="https://en.wikipedia.org/wiki/Stack_machine">stack architecture</a> . </p><br><p>  I practically understood nothing in the x86 architecture, and did not hear anything about other architectures.  The idea of ‚Äã‚Äãa car without registers seemed to me very interesting and unusual.  I thought about it all that day and decided to sit down and write my own simple stack virtual machine. </p><br><h2>  How it looked </h2><br><p>  Stupid Virtual Machine (or SVM for short) followed the simplest possible idea.  The word size (word) was 32 bits, and access to the memory was carried out according to words (it was impossible to access individual bytes).  The memory areas for software code and data were completely isolated from each other (I later learned that this is a distinctive feature of <a href="https://en.wikipedia.org/wiki/Harvard_architecture">Harvard architecture</a> ).  Even the stack was in its own separate part of the memory. </p><br><p> The instruction set was also quite simple.  Standard arithmetic and logical instructions, work with memory, stack manipulations and jumps.  Everything worked in the most obvious way.  For example, the <code>ADD</code> instruction took 2 first 32-bit values ‚Äã‚Äãfrom the stack, added them as signed integers, and pushed the result onto the stack. </p><br><p>  The input / output was primitive, tied to stdin / stdout.  There were instructions <code>IN</code> and <code>OUT</code> .  The first one pushed the reading result onto the stack, the second one displayed the first value from the stack.  For convenience, I added a special flag: should the input be considered a stream of raw bytes or a string representation of a signed integer. </p><br><h2>  How was programming </h2><br><p>  At the beginning, I wrote all the programs for SVM on pure machine code, in a hex editor.  It quickly got tired, so I wrote an assembler with support for labels and string literals.  For example, "Hello, World" looked like this: </p><br><pre> <code class="hljs swift"><span class="hljs-string"><span class="hljs-string">"Hello, World!\n"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span></code> </pre><br><p>  When an assembler sees a string literal, it pushes each byte onto the stack.  <code>PRINT</code> is not an instruction, it is just a macro that generates a loop.  The loop prints each character from the stack until it reaches 0. </p><br><p>  Writing and reading code for a stack machine is a strange experience.  Here is a slightly more advanced example, the calculation of the greatest common divisor looked like this: </p><br><pre> <code class="hljs 1c">IN ;  <span class="hljs-built_in"><span class="hljs-built_in"></span></span> <span class="hljs-string"><span class="hljs-string">"A"</span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   IN ;  <span class="hljs-built_in"><span class="hljs-built_in"></span></span> <span class="hljs-string"><span class="hljs-string">"B"</span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   :GCD ;   DUP ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> B  <span class="hljs-number"><span class="hljs-number">0</span></span>,  A  gcd <span class="hljs-number"><span class="hljs-number">0</span></span> ; (   ) @END ; (     ) JE ; (   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>    ) SWP ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> B <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  <span class="hljs-number"><span class="hljs-number">0</span></span>,    gcd(B, A modulo B) OVR MOD @GCD JMP ; ! :END POP ;  <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   OUT ;     ,  </code> </pre><br><p>  This demonstrates the use of tags and conditional transitions. </p><br><p>  If you want to see an even more advanced example, then read the <a href="">assembly code for sorting inserts</a> , but I will not be offended if you decide to skip it.  This is a fairly long listing, so I did not include it in the post. </p><br><p>  If interested, you can also take a look at <a href="">the virtual machine and assembler code</a> that I found in the old files.  There is nothing unusual, and in general, it is rather an example of how NOT to write a bytecode interpreter.  To make stack machines work as well as register machines, it takes a few tricks.  Of course, I did not know anything about them, and my approach was naive, which negatively affected the performance. </p><br><h2>  Why do you need to do that too </h2><br><p>  Writing even a primitive bytecode interpreter and several programs for it will make you think about things under the hood that are usually taken for granted. </p><br><p>  For example, when I thought about the implementation of procedures in SVM, I realized that a function call is nothing more than a transition with an additional set of rules with which both the caller and the callee must implicitly agree.  This helped me understand the concept of a calling convention, and magic things like <code>_cdecl</code> and <code>WINAPI</code> suddenly became meaningful. </p><br><p>  Of course, such a project will not teach you all the cunning nuances of C ++ or C, but it will help you to form the right way of thinking.  In those years, I had a certain mental barrier, because of which I did not dare to look inside the black boxes full of magic.  It is very important to break this barrier if you are going to do programming seriously, and especially if you are interested in ~ low-level programming in languages ‚Äã‚Äãlike C ++ or C. Such controlled contact with "simulated low-level" programming taught me not to be afraid of segfault'ov and without fear of working with disassembler.  It helped me a lot in my career, and I consider this project one of the most important in my life. </p><br><h2>  More ideas </h2><br><ul><li>  You can go a little further and implement some graphical features in your virtual machine.  You can even write simple games! </li><li>  Try writing a compiler from a simple high-level language to your bytecode.  Unfortunately, I never wrote a compiler for the Stupid Virtual Machine (instead, I wrote a compiler that generates the x86 assembler as part of the compiler course).  This would be an excellent exercise, requiring some additional theoretical knowledge. </li><li>  Making your interpreter work as fast as possible is another interesting but time-consuming task.  It is <a href="http://www.cs.toronto.edu/~matz/dissertation/matzDissertation-latex2html/node6.html">not so</a> <a href="http://nominolo.blogspot.com/2012/07/implementing-fast-interpreters.html">easy</a> . </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/310806/">https://habr.com/ru/post/310806/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310794/index.html">Data structures for the smallest</a></li>
<li><a href="../310798/index.html">Setting up voice gateways Huawei eSpace IAD on the example of working with Asterisk PBX</a></li>
<li><a href="../310800/index.html">Michael Pryor, Trello: How to build a product for the mass market. Continuation</a></li>
<li><a href="../310802/index.html">Major processing plans to withdraw from the Russian market, possibly due to hacker actions</a></li>
<li><a href="../310804/index.html">Enhanced Photography Sample Code for the Intel RealSense R200 Camera</a></li>
<li><a href="../310808/index.html">Quality content for the site: what is it?</a></li>
<li><a href="../310810/index.html">Crysis worldwide via RDP protocol</a></li>
<li><a href="../310812/index.html">Microsoft, UN and EmerCoin: using blockchain technology in real projects</a></li>
<li><a href="../310814/index.html">Launch ReactOS on a secure military laptop from the M1 Abrams tank kit</a></li>
<li><a href="../310816/index.html">The first project on FPGA Altera and USB-Blaster connection in Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>