<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Xen Cloud Platform in Enterprise [3]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third part. Previous parts: First , second . 

 In this topic: memory management and virtual machine processors. 

 Memory 
 In order to understan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Xen Cloud Platform in Enterprise [3]</h1><div class="post__text post__text-html js-mediator-article">  The third part.  Previous parts: <a href="http://habrahabr.ru/blogs/virtualization/104025/">First</a> , <a href="http://habrahabr.ru/blogs/virtualization/104881/">second</a> . <br><br>  In this topic: memory management and virtual machine processors. <br><br><h1>  Memory </h1><br>  In order to understand how XCP works with memory, you need to understand how Xen works with it.  Unlike OpenVZ, Xen always allocates memory to a virtual machine (more precisely, a domain) for exclusive use.  Domain memory is a domain memory and only.  No overselling, no shared pages, no hypervizor swap (virtual machines can, of course, swap).  If you have 4GB, then approximately 3.5GB can be divided between guest machines (512 will go to dom0).  How you share them is your freedom.  But to give the car more memory than it is available, you can not.  Not.  Point. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But in the management of actually allocated memory, everything is very good.  In Xen 3.4, the memory management mechanism (xenballoon) is based on a brain that is quite complex for perception, but simple in terms of the hypervisor, the basis: memory pages are transferred (transfer) between the domain and the hypervisor. <a name="habracut"></a>  Transmission means that the transmitting memory becomes less, and the receiving one - more.  This mechanism uses not only xenballoon, but also many drivers (in order not to make copies, they simply transfer pages with data to each other), but only xenballoon abuses them in such volumes.  The balloon itself works exactly as its name sounds - it is ‚Äúinflated‚Äù within the domain, giving up the occupied space to the hypervisor.  When a domain is given a memory, the ball is deflated. <br><br>  Memory management is not free, it takes a bit of domain memory for service costs itself.  In the worst case, it is about 5%, the more memory, the smaller the percentage (by 16GB of memory, the value drops to about 1%). <br><br>  There are two memory management scenarios: adding memory to a running machine and removing memory from a running machine.  With removal everything is simple - xenballoon gives pages to the hypervisor.  With the addition it is more complicated - the kernel actually cannot expand its address space (in Xen 3.4 memory hotplug was not yet supported), so this scheme is implemented a little differently: when creating a domain, some of the pages are marked as allocated to the domain and immediately given back to the hypervisor ( i.e., balloon is considered to be pre-inflated in advance), and at the right time, the hypervisor returns pages back to the domain. <br><br>  By virtue of this model, there is a theoretical ceiling (specified when creating a domain, that is, when starting a virtual machine), to which virtual memory can be expanded.  It affects the size of service costs, and artificially limits the lower memory limit (for 16GB, this is approximately 512MB, for 2GB, it seems 128MB).  Thus, we get two boundaries that are set when starting the domain - <code>memory_static_min</code> and <code>memory_static_max</code> .  Despite the fact that the user can make memory_static_min arbitrarily low, the amount of memory will never fall below a certain value, calculated from the maximum.  It is encoded directly in the xenballloon.c code and serves to protect against the OOM killer on level ground (so that there is enough memory for the kernel overhead and a minimum set of software to function).  In some places, he too aggressively lifts the bar (especially in the area of ‚Äã‚Äãthe ceiling of 2-4GB), but in general, the values ‚Äã‚Äãare quite reasonable. <br><br>  In addition to these restrictions, two more (artificial) values ‚Äã‚Äãare introduced - memory_dynamic_max and memory_dynamic_min.  These values ‚Äã‚Äãdefine the boundaries within which the memory can be regulated and can change on the fly (that is, it is simply an administrative convention).  There is also a target value (memory_target) - the desired amount of memory.  Most often, the amount of memory is divided as needed (i.e. memory = memory_target), but if the request to the target cannot be executed, then these values ‚Äã‚Äãmay differ. <br><br>  There are two methods for adjusting the virtual machine's memory capacity - manual and automatic.  Manual sets the target to the specified value.  Automatically sets the boundaries (maximum / minimum) and gives XCP the ability to regulate the amount of memory of each domain on its own. <br><br>  The memory regulation is called Dynamic Memory Control and is a squeezed daemon running on each pool host (it has nothing to do with Debian Squeeze, just a coincidence).  This daemon allocates a maximum of available memory to new domains (but no more than dynamic-max), and in case of need of a hypervisor in memory (for example, to start a new virtual machine), it presses all machines (but not less than dynamic-min).  If the squeezed failed to free up the required amount of memory, the host refuses to start the new virtual machine (if it is started <code>xe vm-start</code> command without specifying where to start, the machine will start where it is, if it says ‚Äústart here‚Äù, there will be a failure at launch). <br><br>  On the move, you can change the values ‚Äã‚Äãof dynamic-min / max, of course, within the available.  When changing values, the possibility of change is not checked, and you can get a machine with memory = 512Mb, dynamic-min = 2GiB, target = 4GiB, dynamic-max = 8GiB.  (on reboot, if conditions cannot be met, the machine will not start). <br><br>  In any case, the formula is checked for each change: <br><br> <code>static-min ‚â§ dynamic_min ‚â§ target ‚â§ dynamic_max ‚â§ static-max <br></code> <br><br><h1>  Processor (s) </h1><br>  Xen supports dynamic power on / off processors.  (And yes, answering questions from comments - there can be more than 4 cores, I personally saw 16 cores with one virtual machine, the number of processors is not limited).  By default, all machines are made with one processor, to enable multiprocessing, they must be turned off.  There are three values ‚Äã‚Äãthat determine behavior: <br><ul><li>  VCPUs-max - the maximum number of processors for a domain (set when creating a domain, that is, when you turn on the virtual machine). </li><li>  VCPUs-number - the current number of processors </li><li>  VCPUs-at-startup - The number of processors when the machine is turned on (creating the domain) </li></ul><br>  It must be said that Xen is blatantly cheating, and he does not know how to connect processors on the go.  In fact, VCPUs-max processors are turned on in the virtual machine, just some of them are marked off.  Thus, connecting / disconnecting processors is not their hotplug from the point of view of the OS, but simply ‚Äúenable / disable‚Äù.  However, this does not reduce the complexity of the task for guest systems by changing the number of processors involved in planning processes.  Some programs rage about changing the number of processors (the most characteristic is atop, which, when connected to a pair of processors, begins to assume that they were always there, but was ‚Äústolen‚Äù by the hypervisor).  Most programs do not care - because they do not think about the number of processors.  The "connected, but turned off" processors have a small penalty ‚Äî the kernel still knows about them and reserves memory by the number of VCPUs-max cores, not by the number of included ones. <br><br>  There may be more virtual processors than physical processors, however, this leads to lags in the machine (instead of quiet execution of the code, the hypervisor constantly switches the context between processors). <br><br>  Since there are usually fewer processors than virtual machines, there is competition for CPU time, and Zen is in charge of planning virtual machines in the same way that the OS kernel does in relation to processes.  At the moment there are three schedulers (they can be changed on the go) - honest, real time and experimental.  Frankly, I did not look at them deeply; standing by default ‚Äúfair‚Äù is enough for most tasks. <br><br>  Between each other, virtual machines can have processor limits and relative priorities. <br><br>  The limit is set as a value cap, which gives the maximum allowed machine time for each processor as a percentage (attention to each core, cap = 75% with two cores means 150% of computer time, in some documentation they say that cap is total consumption machines, that is, cap = 150, cap = 330, etc. - this is not true).  cap = 10 will give us 10% of the machine time and turn a powerful Xeon into a very regrettable P2 (or even P1), which is especially acute at the boot stage.  In principle, reducing the cap below 25% is not worth it, because the machine can start to blunt even in the console (with a spreading bash competition easily). <br><br>  The second mechanism is more interesting - this is a relative priority.  It is set in hypervirtual parrots (weight).  That virtual machine with a longer hyper-virtual parrot gets more machine time. <br><br>  The strict ratio is that a machine with weight = 20 receives at least twice as much machine time as a machine with weight = 10 (if you want to consume this machine time, if the ‚Äúpriority‚Äù machine is idle, then the low-priority one can eat as much as it wants).  These numbers quietly scale up to tens of thousands (i.e., maybe a machine with weight = 20000 and weight = 1, in this case the second one, in fact, works in idle priority). <br><br>  Important: all priorities, unfortunately, can be changed only when the domain is stopped. <br><br>  For extremely fine connoisseurs of digging in the guts, it is possible to assign specific kernels (so-called VCPU-pinning) to a virtual machine and the possibility of masking (disabling) some of the processor's capabilities (VPCU-features). <br><br>  You can see the real situation with virtual machines using <code>xentop</code> . </div><p>Source: <a href="https://habr.com/ru/post/105262/">https://habr.com/ru/post/105262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../105254/index.html">Miniplan - simple and convenient SaaS organizer</a></li>
<li><a href="../105256/index.html">Russian Internet Week (RIW ‚Äì 2010)</a></li>
<li><a href="../105258/index.html">Pimp my surf, or Otsumenyur your surfing</a></li>
<li><a href="../105260/index.html">Constructor for .NET Scheduler Printing Form</a></li>
<li><a href="../105261/index.html">Some more useful plugins</a></li>
<li><a href="../105263/index.html">Promotion of technical posts</a></li>
<li><a href="../105265/index.html">Mash a car? - Upload photos to DentBetty and local car repair shops will fight for you</a></li>
<li><a href="../105266/index.html">Integrity Superdome Switches to Blade Architecture</a></li>
<li><a href="../105267/index.html">Chic effect for checkbox and radio-button on CSS3</a></li>
<li><a href="../105269/index.html">Culinary sites snippets now with photos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>