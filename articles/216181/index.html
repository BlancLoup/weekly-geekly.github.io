<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C ++ web application, or taming the FastCGI daemon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nowadays, thanks to tools like NodeJS, creating a web application is nothing. I downloaded the binary, js in 5 lines of code, and you can brag. And if...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C ++ web application, or taming the FastCGI daemon</h1><div class="post__text post__text-html js-mediator-article">  Nowadays, thanks to tools like NodeJS, creating a web application is nothing.  I downloaded the binary, js in 5 lines of code, and you can brag.  And if you connect express and add another 5 lines, then we get a full-fledged web application with routing, templates, sessions and other amenities.  So simple that even boring.  And it became interesting to me: how is the situation with my old acquaintance C ++, whom I have not seen for 5 years now?  At one time, I was seduced by ActionScript and other JavaScript, but I completely forgot about a good friend who helped out more than once.  In light of <a href="http://habrahabr.ru/company/yandex/blog/209324/">recent</a> <a href="http://habrahabr.ru/company/yandex/blog/214069/">articles</a> on Configurable Omnipotent Custom Applications Integrated Network Engine (abbreviated Cocaine), a project called Fastcgi Daemon, based on the Cocaine HTTP interface, caught my eye.  And so, meet <br><a name="habracut"></a><br><blockquote>  Fastcgi Daemon - Yandex's opensCodCGI applications on C ++. <br></blockquote><br>  I.e <br><br><blockquote>  Fastcgi Daemon is an open source framework developed in Yandex and designed to create highly loaded FastCGI applications in C ++. <br></blockquote><br>  Unfortunately, this is all that you find in the README from the official repository. <br>  More documentation is available here at <a href="https://github.com/lmovsesjan/Fastcgi-Daemon/wiki/_pages">github.com/lmovsesjan/Fastcgi-Daemon/wiki/_pages</a> , but for full-fledged work it is not enough.  For example, the entire installation there takes one line: <br><br><pre><code class="bash hljs">sudo apt-get install fastcgi-daemon2-init libfastcgi-daemon2-dev libfastcgi2-syslog</code> </pre> <br>  But in the official repositories of Ubuntu, and in any other (maybe I looked badly), these packages could not be found.  In this article, I decided to collect my research related to installing, configuring and using this tool.  All the sources below, as well as ready-made deb-files can be picked up here <a href="https://github.com/nickalie/HelloFastCGI">github.com/nickalie/HelloFastCGI</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Installation </h2><br>  The project is supported for Ubuntu, so I performed all the operations below on Ubuntu 12.04 64 bit with fresh updates. <br>  First, install all necessary dependencies.  You can do this with the following command: <br><br><pre> <code class="bash hljs">sudo apt-get install -y build-essential git debhelper automake1.9 autotools-dev libboost-dev libboost-thread-dev libfcgi-dev libxml2-dev libboost-regex-dev libtool libssl-dev autoconf-archive</code> </pre><br>  Now we clone the repository with Fastcgi Daemon.  Here we have a choice of 2 options: <br><ul><li>  <a href="https://github.com/golubtsov/Fastcgi-Daemon">github.com/golubtsov/Fastcgi-Daemon</a> - the last commit a year ago.  This is the repository featured in <a href="https://github.com/Kobolog/cocaine-docs-ru/wiki/HTTP-FastCGI">Cocaine documentation.</a> <br></li><li>  <a href="https://github.com/lmovsesjan/Fastcgi-Daemon">github.com/lmovsesjan/Fastcgi-Daemon</a> - looks more or less alive, the last commit 21 days ago.  Contains a coherent description of the framework API. <br></li></ul><br>  I chose the first option <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/golubtsov/Fastcgi-Daemon.git</code> </pre><br>  Go to the folder with the fresh project <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Fastcgi-Daemon</code> </pre><br>  and run the build <br><br><pre> <code class="bash hljs">dpkg-buildpackage -rfakeroot</code> </pre><br>  At the output we get ready-to-install deb-files that are in the parent directory.  Do <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br>  and <br><br><pre> <code class="bash hljs">sudo dpkg -i ./libfastcgi-daemon2-dev_2.10-13_amd64.deb \ ./libfastcgi-daemon2_2.10-13_amd64.deb \ ./fastcgi-daemon2-init_2.10-13_amd64.deb \ ./fastcgi-daemon2_2.10-13_amd64.deb \ ./libfastcgi2-syslog_2.10-13_amd64.deb</code> </pre><br>  We also need a web server that can work with FastCGI.  I use nginx for my needs, the same is advised in the documentation <br><br><pre> <code class="bash hljs">sudo apt-get install nginx</code> </pre><br>  If you want to use the latest version of this web server, before doing this <br><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:nginx/stable &amp;&amp; sudo apt-get update</code> </pre><br>  This is the end of the installation.  We turn to our first application. <br><br><h2>  application </h2><br>  Create the HelloFastCGI.cpp file and put the following code into it: <br><br><pre> <code class="hljs rust">#include &lt;fastcgi2/component.h&gt; #include &lt;fastcgi2/component_factory.h&gt; #include &lt;fastcgi2/handler.h&gt; #include &lt;fastcgi2/request.h&gt; #include &lt;iostream&gt; #include &lt;sstream&gt; class HelloFastCGI : <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> public fastcgi::Component, <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> public fastcgi::Handler { public: HelloFastCGI(fastcgi::ComponentContext *context) : fastcgi::Component(context) { } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> void onLoad() { } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> void onUnload() { } <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> void handleRequest(fastcgi::Request *request, fastcgi::HandlerContext *context) { request-&gt;setContentType(<span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>); std::stringbuf buffer(<span class="hljs-string"><span class="hljs-string">"Hello "</span></span> + (request-&gt;hasArg(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) ? request-&gt;getArg(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) : <span class="hljs-string"><span class="hljs-string">"stranger"</span></span>)); request-&gt;write(&amp;buffer); } }; FCGIDAEMON_REGISTER_FACTORIES_BEGIN() FCGIDAEMON_ADD_DEFAULT_FACTORY(<span class="hljs-string"><span class="hljs-string">"HelloFastCGIFactory"</span></span>, HelloFastCGI) FCGIDAEMON_REGISTER_FACTORIES_END()</code> </pre><br>  The method that interests us the most is handleRequest.  That he is engaged in processing the request.  I hope from the code it is clear what happens in this method, but I will explain just in case.  If the request (POST or GET) has the parameter ‚Äúname‚Äù, then we display the text ‚ÄúHello% name%‚Äù, otherwise ‚ÄúHello stranger‚Äù. <br><br>  The fastcgi :: Request class is responsible for both the request and the response at the same time, although usually this functionality is divided into 2 classes or objects, as, for example, in the same NodeJS. <br>  Already ‚Äúout of the box‚Äù we can work with cookies, set arbitrary HTTP statuses, headers, etc. In general, we have access to a gentlemen‚Äôs set for developing web services and web applications.  Unless sessions are not implemented by default, but they are screwed into 2 accounts.  This will tell next time. <br><br>  Let us return to our sheep.  Now we need to compile this class into a shared library: <br><br><pre> <code class="bash hljs">g++ HelloFastCGI.cpp -O2 -fPIC -lfastcgi-daemon2 -shared -o libHelloFastCGI.so</code> </pre><br>  Then you should prepare the HelloFastCGI.conf configuration file (it is important that the extension be ‚Äúconf‚Äù): <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fastcgi</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XInclude"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pools</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pool</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">threads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">queue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5000"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pools</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pool</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"main"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/hellofascgi"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">component</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HelloFastCGIComponent"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">components</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">component</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HelloFastCGIComponent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MainModule:HelloFastCGIFactory"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">component</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"daemon-logger"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logger:logger"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>INFO<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ident</span></span></span><span class="hljs-tag">&gt;</span></span>hellofastcgi<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ident</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">component</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">components</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">module</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MainModule"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"./libHelloFastCGI.so"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">module</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logger"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/usr/lib/fastcgi2/fastcgi2-syslog.so"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">daemon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">component</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"daemon-logger"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">backlog</span></span></span><span class="hljs-tag">&gt;</span></span>128<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">backlog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">socket</span></span></span><span class="hljs-tag">&gt;</span></span>/tmp/fastcgi_daemon.sock<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">socket</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">threads</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">threads</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pidfile</span></span></span><span class="hljs-tag">&gt;</span></span>/var/run/fastcgi2/HelloFastCGI.pid<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pidfile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">monitor_port</span></span></span><span class="hljs-tag">&gt;</span></span>20012<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">monitor_port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">daemon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fastcgi</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We have a handler for requests that come to ‚Äú/ hellofastcgi‚Äù (for example, <a href="http://www.somedomain.com/hellofastcgi">www.somedomain.com/hellofastcgi</a> ).  This handler is the HelloFastCGIComponent component, which lies in the MainModule module.  More precisely, the module contains the HelloFastCGIFactory factory, which allows you to get the necessary component.  MainModule, in turn, draws its resources from the newly compiled libHelloFastCGI.so.  Also pay attention to the contents of the ‚Äúsocket‚Äù tag - this is nothing more than a unix-socket, which we will soon need to specify in the nginx settings.  ‚ÄúPidfile‚Äù is important when demonizing FastCGI-Daemon.  Its name must match the name of the conf-file, the only difference is in extensions.  In order for the daemon to be able to start / stop / restart, the pid must be in ‚Äú/ var / run / fastcgi2 /‚Äù. <br><br>  It's time to set up a web server.  Since I am doing all this on a freshly installed nginx, without further ado, I rule / etc / nginx / sites-available / default.  The content should be something like: <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/tmp/fastcgi_daemon.sock; } }</code> </pre><br>  Restart nginx <br><br><pre> <code class="bash hljs">sudo service nginx restart</code> </pre><br>  Run our application with <br><br><pre> <code class="bash hljs">fastcgi-daemon2 --config=HelloFastCGI.conf</code> </pre><br>  If everything was done correctly, then open <a href="http://localhost/hellofastcgi">localhost / hellofastcgi</a> in the browser, you should see <br><br><pre> <code class="html hljs xml">Hello stranger</code> </pre><br>  Add the argument <a href="http://localhost/hellofastcgi%3Fname%3Dnick">localhost / hellofastcgi? Name = nick</a> and get <br><br><pre> <code class="html hljs xml">Hello nick</code> </pre><br>  Hurray, it works!  I hope you have too. <br><br>  However, now Fastcgi Daemon runs in the console as a normal application.  Where is the promised demonization?  We will talk about this below. <br><br><h2>  Setting up daemon </h2><br>  Fortunately, Fastcgi Daemon and Daemon, that it is very easy to demonize (I apologize for the tautology). <br><br>  We take the previously created HelloFastCGI.conf, replace the relative path to libHelloFastCGI.so with an absolute path in it and put it in / etc / fastcgi2 / available. <br><br>  Now you can start / stop / restart the daemon in the usual way: <br><br><pre> <code class="bash hljs">sudo service fascgi-daemon2 start/stop/restart &lt;appname&gt;/all</code> </pre><br>  In our case it will be <br><br><pre> <code class="bash hljs">sudo service fastcgi-daemon2 start HelloFastCGI</code> </pre><br>  To run all available applications in / etc / fastcgi2 / available use the keyword ‚Äúall‚Äù <br><br><pre> <code class="bash hljs">sudo service fastcgi-daemon2 start all</code> </pre><br>  It is also important that in the event of an unexpected crash of your application, it will be automatically restarted. <br><br><h2>  Benchmarks </h2><br>  Curiosity decided to compare the performance of Fastcgi Daemon and NodeJS.  To do this, sketched a similar application on JS: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.writeHead(<span class="hljs-number"><span class="hljs-number">200</span></span>, {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = url.parse(req.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).query; res.end(<span class="hljs-string"><span class="hljs-string">'Hello '</span></span> + (query.name ? query.name : <span class="hljs-string"><span class="hljs-string">'stranger'</span></span>)); }).listen(<span class="hljs-number"><span class="hljs-number">1337</span></span>, <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Server running at http://127.0.0.1:1337/'</span></span>);</code> </pre><br>  For the purity of the experiment, I configured proxy_pass in nginx to work with node. <br>  Tested with Apache Bench: <br><br><pre> <code class="bash hljs">ab -c 100 -n 20000 http://IPorURL/hellofastcgi?name=Nikolay</code> </pre><br>  and <br><br><pre> <code class="bash hljs">ab -c 100 -n 20000 http://IPorURL/?name=Nikolay</code> </pre><br>  Results: <br><br>  Fastcgi daemon <br><br><pre> <code class="bash hljs">Concurrency Level: 100 Time taken <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tests: 15.181 seconds Complete requests: 20000 Failed requests: 0 Write errors: 0 Non-2xx responses: 20000 Total transferred: 6460000 bytes HTML transferred: 3440000 bytes Requests per second: 1317.45 [<span class="hljs-comment"><span class="hljs-comment">#/sec] (mean) Time per request: 75.904 [ms] (mean) Time per request: 0.759 [ms] (mean, across all concurrent requests) Transfer rate: 415.56 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.5 0 4 Processing: 12 75 31.2 68 474 Waiting: 9 73 31.4 66 471 Total: 12 76 31.3 68 475 Percentage of the requests served within a certain time (ms) 50% 68 66% 80 75% 85 80% 88 90% 96 95% 106 98% 114 99% 125 100% 475 (longest request)</span></span></code> </pre><br><br>  Nodejs <br><br><pre> <code class="bash hljs">Concurrency Level: 100 Time taken <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tests: 23.038 seconds Complete requests: 20000 Failed requests: 0 Write errors: 0 Total transferred: 2700000 bytes HTML transferred: 260000 bytes Requests per second: 868.12 [<span class="hljs-comment"><span class="hljs-comment">#/sec] (mean) Time per request: 115.192 [ms] (mean) Time per request: 1.152 [ms] (mean, across all concurrent requests) Transfer rate: 114.45 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.6 0 52 Processing: 39 114 21.7 109 306 Waiting: 28 112 21.5 107 305 Total: 40 115 21.7 109 306 Percentage of the requests served within a certain time (ms) 50% 109 66% 117 75% 125 80% 130 90% 145 95% 155 98% 168 99% 186 100% 306 (longest request)</span></span></code> </pre><br>  It is worth mentioning that all this is spinning on VirtualBox, which is allocated one core from Core i7. <br>  As a result, we got a difference of one and a half times in favor of Fastcgi Daemon, which, I think, is not so bad for NodeJS.  That's just the CPU consumption at NodeJS reached 50%, and the memory - up to 45 MB (5.6 MB at rest).  While Fastcgi Daemon ate up no more than 20% of the processor and 9.5 MB of RAM (4.5 MB at rest).  That is, to the resources of the latter is more friendly, which is not surprising.  It's clear that the comparison turned out to be quite spherical in a vacuum.  In an amicable way, it is necessary to make more saturated code, connect the database, run both applications in multithreaded mode.  But for the beginning and that's enough. <br><br><h2>  Instead of conclusion </h2><br>  In my opinion, a very interesting project came out of the depths of Yandex.  Besides the fact that Fastcgi Daemon greatly simplifies writing web applications in C ++, it also contains the necessary init.d scripts for convenient management of ready-made applications.  Next time I will describe the creation of a service for authorization based on Fastcgi Daemon with sessions, databases and templates. </div><p>Source: <a href="https://habr.com/ru/post/216181/">https://habr.com/ru/post/216181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216167/index.html">Chromebook + Haswell = Acer C720</a></li>
<li><a href="../216169/index.html">Interaction of vulnerability scanners with Metasploit. Part 2</a></li>
<li><a href="../216173/index.html">Samba4 as AD + file server</a></li>
<li><a href="../216177/index.html">How I did USB MFP wireless</a></li>
<li><a href="../216179/index.html">Data collection methods for analyzing the effectiveness of contextual advertising in offline sales</a></li>
<li><a href="../216185/index.html">Work with Korutins in Unity</a></li>
<li><a href="../216187/index.html">Kohana-form: module of management and form generation</a></li>
<li><a href="../216189/index.html">Undefined behavior in C ++</a></li>
<li><a href="../216191/index.html">Develop.re - social link aggregator for programmers</a></li>
<li><a href="../216193/index.html">Asterisk + Cisco SPA5XX, SPA3XX - DND with server notification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>