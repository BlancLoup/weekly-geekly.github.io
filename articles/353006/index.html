<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing tasks from Odnoklassniki on JPoint 2018</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aloha! 

 Probably the most interesting event this week in the Java world was the JPoint conference, which was held at the World Trade Center in Mosco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing tasks from Odnoklassniki on JPoint 2018</h1><div class="post__text post__text-html js-mediator-article">  Aloha! <br><br>  Probably the most interesting event this week in the Java world was the <a href="https://jpoint.ru/">JPoint</a> conference, which was held at the World Trade Center in Moscow.  Classmates suggested that visitors also participate in the development of the most highly loaded system in Java and help our developers in solving practical problems that they face in their work. <br><br>  The eleven people who best solved these puzzles have already received prizes from us, but for the rest, we wrote down this post with an analysis of solutions. <br><a name="habracut"></a><br>  To make it easier for you to first try to solve the puzzles yourself, we hid the correct answers under the spoiler.  Chur, open only after they themselves have thought of a solution ;-) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Go! <br><br><h2>  The Vadim and score task </h2><br>  Vadim wrote the following code for partitioning music tracks across servers.  What did he do wrong?  Correct the Vadim error in the code: <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> partition between 0 inclusive * and partitions exclusive */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">partition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Track track, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> partitions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> track != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> partitions &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> track.hashCode() % partitions; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  The obvious problem in Vadim's code is that track.hashCode () can return both positive and negative values. <br><br>  Vadim is a neat person (you see how many asserts!), It means that he also wrote a comment to the method carefully, and there it was indicated that the method would return a number in the interval from 0 to partitions exclusively. <br><br>  An obvious way to fix the problem would be a slightly different ending of the method, for example, like this: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.abs( track.hashCode() ) % partitions;</code> </pre><br>  It would seem - cheers and in production!  But there is one less obvious problem - according to the hashCode () specification, it can easily return Integer.MIN_VALUE to itself, and an attempt to take Math.abs from such a number will not lead to anything good. <br><br>  Oh, my mother said, watch the brackets, son!  It will be right like this: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.abs( track.hashCode() % partitions );</code> </pre><br>  Another, more serious problem of Vadim is much less obvious.  The method he chose to distribute data across servers is inconsistent: when the number of partitions changes (for example, when servers are added) all tracks are redistributed throughout the cluster almost completely.  If there are few tracks, there are few problems, and if the cluster is large and there are hundreds of terabytes of tracks, all of them need to be moved between servers.  And Vadim has already flooded terabytes of tracks for a hundred ‚Äî another server ... <br><br>  Oh, Vadim, Vadim!  You would use any of the variants of <a href="https://medium.com/%40dgryski/consistent-hashing-algorithmic-tradeoffs-ef6b8e2fcae8">consistent hashes</a> , you would not have a headache now. <br></div></div><br><h2>  Leonid works as a janitor </h2><br>  Leonid wrote such code to clean up temporary files from the directory.  What did he do wrong? <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cleanup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Path dir)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Path file : Files.newDirectoryStream(dir)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file.endsWith(<span class="hljs-string"><span class="hljs-string">".tmp"</span></span>)) { Files.delete(file); } } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  Leonid was in a hurry to roll out the garbage collection in production and inattentively studied the documentation for the DirectoryStream.  DirectoryStream implements AutoCloseable.  That is, it has a close () method.  And if something has such a method, it should be called.  The consequences were not long in coming - rolling out a new version in production, he found a leak of native memory in the java process. <br><br>  Since the release included not only this code, the source of the leak could not be unambiguously determined, and Leonid had to learn <a href="http://goog-perftools.sourceforge.net/doc/heap_profiler.html">how to identify native leaks</a> .  When profiling, a leak was found when calling the native method __alloc_dir, which is called as a result of calling Files.newDirectoryStream.  Leonid slapped his forehead and corrected the problem: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cleanup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Path dir)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ( DirectoryStream&lt;Path&gt; stream = Files.newDirectoryStream(dir) ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Path file : stream) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file.endsWith(<span class="hljs-string"><span class="hljs-string">".tmp"</span></span>)) { Files.delete(file); } } } }</code> </pre><br>  - ‚ÄúHooray!‚Äù, Said Leonid and rolled out the release.  And hurried again. <br>  After all, it would be nice to check that the file from the stream is a file and not a directory, for example, by adding a condition with Files.isRegularFile (file). <br><br>  Leonid also forgot that Files.delete can throw an IOException, and the cleaning process will be interrupted - something needs to be done with this too. <br><br>  "In vain I went to the wipers," Leonid thought to himself ... <br></div></div><br><h2>  Poor dasha </h2><br>  Dasha is migrating code from Java 10 to a legacy system running under Java 8. What should she replace <code>var</code> in order for the program to compile? <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>);</code> </pre><br>  Choose the appropriate answers: <br><br><ol><li> <code>List&lt;?&gt;</code> </li> <li> <code>List&lt;? super Comparable&gt;</code> </li> <li> <code>List&lt;? extends Comparable&gt;</code> </li> <li> <code>List&lt;? extends Comparable &amp; Serializable&gt;</code> </li> <li> <code>List&lt;? super Comparable &amp; Serializable&gt;</code> </li> </ol><br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  ‚ÄúGod, what do I spend my life on,‚Äù Dasha thought and quickly found the right options: of course, first, second and third. <br></div></div><br><h2>  Anton, soup and limits </h2><br>  Anton limits the number of requests to <a href="https://habrahabr.ru/company/odnoklassniki/blog/350566/">the face detector on user photos with the</a> following code.  How can he implement a limit change on the fly in a thread-safe way? <br><br><pre> <code class="java hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConcurrencyLimiter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DEFAULT_LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Semaphore semaphore = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Semaphore(DEFAULT_LIMIT); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable task)</span></span></span><span class="hljs-function"> </span></span>{ semaphore.acquireUninterruptibly(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { task.run(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { semaphore.release(); } } <span class="hljs-comment"><span class="hljs-comment">// Implement me void setLimit(int newLimit) { assert newLimit &gt; 0; // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Implementation pending } }</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Decision</b> <div class="spoiler_text">  ‚ÄúMultithreading is difficult‚Äù - Anton once again read the wisdom of the ancients from a poster and composed the following code: <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// Implemented final AtomicInteger limit = new AtomicInteger(DEFAULT_LIMIT); void setLimit(int newLimit) { assert newLimit &gt; 0; final int previous = limit.getAndSet(newLimit); if (newLimit &gt;= previous) { semaphore.release(newLimit - previous); } else { semaphore.acquireUninterruptibly(previous - newLimit); } }</span></span></code> </pre><br>  Naturally, it is not the only true one; different variations are possible here, for example, without CAS, but with synchronization of the entire setLimit, this is not fundamental. <br><br>  But Anton did not take into account that he announced the semaphore unfair at the very beginning, and an attempt to get many permits at once with the expression semaphore.acquireUninterruptibly (previous - newLimit) may never be completed, especially if there are a lot of tasks for identifying people, and the semaphore never not enough permit for 1 time. <br><br>  Anton can solve this problem with the help of such a cycle, which takes the characters one by one: <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// Implemented final AtomicInteger limit = new AtomicInteger(DEFAULT_LIMIT); void setLimit(int newLimit) { assert newLimit &gt; 0; final int previous = limit.getAndSet(newLimit); if (newLimit &gt;= previous) { semaphore.release(newLimit - previous); } else { // magic goes here: for ( int i = 0; i &lt; previous - newLimit; i++) semaphore.acquireUninterruptibly(1); } }</span></span></code> </pre><br>  ‚ÄúOr maybe this is not the best solution?‚Äù Anton wondered, because ‚ÄúMultithreading is difficult‚Äù - Anton once again read the wisdom of the ancients from a poster hanging over his table ... <br></div></div><br>  That's all!  Thank you all for taking part in solving our problems.  Special thanks to those who wrote us their opinion about our tasks, came to our booth and argued with us about solutions! <br><br>  Or maybe you know the best solutions?  Welcome to the comments! </div><p>Source: <a href="https://habr.com/ru/post/353006/">https://habr.com/ru/post/353006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352992/index.html">Thymeleaf Tutorial: Chapter 20. Appendix C: Markup Selector Syntax</a></li>
<li><a href="../352994/index.html">Better way To Code</a></li>
<li><a href="../352996/index.html">Why put up a management interface or attack on a Cisco Smart Install on the Internet</a></li>
<li><a href="../352998/index.html">The path of the IT-manager (part # 2)</a></li>
<li><a href="../353002/index.html">Mass Attack on Cisco Equipment</a></li>
<li><a href="../353008/index.html">Overview of cases of interesting Big Data implementations in financial sector companies</a></li>
<li><a href="../353010/index.html">N + 6 useful books</a></li>
<li><a href="../353012/index.html">Do I need to collect NAS?</a></li>
<li><a href="../353014/index.html">Introducing the new dialog item</a></li>
<li><a href="../353016/index.html">More than a state: British East India Trading Company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>