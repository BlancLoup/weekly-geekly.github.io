<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transcend Library 4: How the architecture is organized</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, today I want to continue to talk about my library, in the hope of finding supporters of the idea. 
 This post is a continuation of Tra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transcend Library 4: How the architecture is organized</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, today I want to continue to talk about my library, in the hope of finding supporters of the idea. <br>  This post is a continuation of <a href="http://habrahabr.ru/post/151812/">Transcend Library 4: Introduction</a> , or rather the logical development of the discussion in the comments. <br><a name="habracut"></a><br><h4>  Why am I writing a new post instead of opening the code </h4><br>  - has a simple cause.  The reasons. <br><ul><li>  After the next architecture refactor (June 2012) the library does not work.  More precisely, half of the methods simply do not exist.  I understand that a quarter is solved by copy-paste from previous versions, but the fact remains. </li><li>  Refactoring is not complete yet.  Half of the library was translated under the new standard, and half is only being prepared, they simply did not reach out. </li><li>  The code is not documented, and at this stage it is not clear in some places. </li><li>  Yes, and it will be easier to start the development knowing at least in general terms the idea than gnawing the code from scratch. </li></ul><br><br><h4>  Disclaimer </h4><br>  I am ambitious, young, stupid and self-confident.  Maximalism is not yet dead, and at times arises.  But still, after more or less sensible reasoning, opening the code and going into Open Source seems to me a simpler and more realistic way to find fellow developers than to make money from the first sales and hire staff. <br><br><h4>  Patterns </h4><br>  Most of what I used has a widespread pattern.  Something is not, but very common.  In any case, I hope that any site will be clear to those who do not know them.  For those who are familiar - I will next add the name. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Tl4 </h4><br><h5>  Asynchrony </h5><br><h6>  Nature of the network </h6><br>  The nature of the network is asynchronous.  There are no concepts of "simultaneously" and "instantly."  All effects of calling functions occur with delays depending on many reasons.  Your right to wait for the result, or perform your actions at this time (blocking and non-blocking sockets), but the fact will not change.  In the meantime, how you want to open a connection, and how it actually opens will take considerable time.  And that's bad. <br>  But there is good news, you can simultaneously order a lot of actions to be done, and wait for the first one to end.  At the same time, the number of actions does not greatly affect the execution time of each. <br>  All this directly asks to design a library with event support, but that's not all. <br><br><h6>  Request congestion </h6><br>  There is another price for using the network - every call is worth the time.  Big time.  It is spent on the release of the resource, the resolution in the operating system queue and the like.  For example, we want to make 1000 dns requests.  Let each call cost 1ms (adequate time, sometimes more), this means that we will lose a second only on calls.  At this time, our application running in the same thread will ‚Äúslacken off‚Äù via FPS, and the user will see the hang-up on level ground. <br>  And in fact, the driver makes 50 (number from the ceiling) requests every second, for all applications in the system. <br>  I understand that somewhere it may be justified to do this (and there is a setting that would happen), but the system was designed for realtime applications, and in them this is unacceptable. <br><br><h6>  The order of the task </h6><br>  When you request an OpenConnection, the library does nothing other than allocating memory and setting the job in turn.  All operations take place in the local address space and local stream, because of this they are fast. <br>  The actual delegation occurs when calling Response, which scans the tasks and executes one by one, before the timeout. <br>  In our example, this allows, after the first 50 requests, to start establishing a connection, and it is possible (if it has time) to begin (or even complete) the exchange of information before receiving all 1000 addresses. <br>  <i>The internal structure can be compared to an <b>event-driven</b> architecture, except that the notification of events does not occur according to the <b>observer</b> pattern.</i> <br><br><h5>  The priority of the job </h5><br>  Let us play an online game like WoW.  Also, let the administration not want to sell new items through patches.  What is the use of downloading to millions of players a sword that God forbid will receive 10 zadrots, but will God see 1000 passers-by? <br>  Let this sword fell in battle, when the battle is not over.  Let the same voice communication sewn into the game. <br>  Immediately visible several simultaneous data streams: damage to the boss, the level of lives of all around, their movements, voice and sword.  (Data sorted by increase in volume) <br>  The transfer priorities should be the following: displacement, standard of living, voice, damage, sword. <br>  It would be a shame if the library did not provide such functionality. <br><br><h5>  Related tasks </h5><br>  <u>The feature is not provided either in the release or in the architecture, but it will fit in harmoniously there.</u> <br>  The characteristics of the sword, the texture, the model, and the icon without each other do not make much sense.  But at the same time, it would be logical to transfer the characteristics and the pictogram, making it possible to use a weapon, without waiting for the model to load. <br>  The texture and model will inherit the priority of the parent, when transmitted, and their priority will be set by relative offset.  It remains to choose the coefficients so that the transfer would occur in a timely manner. <br><br><h5>  Dynamic priority </h5><br>  Let our multi-gigabyte voyage come to an end, and have a low priority in the system.  And at this very moment ( <b>99.9%</b> ) it became necessary to transfer several megabytes of urgent data.  Despite the fact that the imaginary gig turned into a dozen kilobytes. <br>  Here it would be extremely reasonable to change the priority of the task depending on the remaining and buffered amount of data. <br>  <i>I don‚Äôt like my current decision in the library, I need to think about it and if I can improve it.</i> <br><br><h4>  Memory device </h4><br><h5>  Data storage model </h5><br>  In a complex system, you may need access to the same resources from different places.  For example, a chat_listener and attack_listener will want to send a message.  And each has its own set of connections. <br>  To avoid duplication and desynchronization of data, storage of keys to the database in objects given to the user is used (the <i>closest thing here is <b>Bridge</b> , only for stored data</i> ). <br>  The database is one for the virtual network (this is why data operations within the same network are not safe), and, like all data stored in it, is managed through <b>shared_self_controlled</b> . <br><br><h5>  Responsibility for memory </h5><br>  Due to the nature of the task, the user cannot retain full control over the allocated memory. <br>  The idea of ‚Äã‚Äãthe library - ‚Äúto put on the shipment and be sure that it will reach‚Äù is somewhat poisoned, if you also have to watch it and when it reaches and delete it. <br>  Oddly enough, the library in the general case also does not know when exactly the object should be deleted.  She knows that he should be transferred, knows when this transfer will end, but should it be deleted after that?  It knows only the object.  ( <u>oh gods he uses delete this</u> ) <br><br><h5>  Garbage collector </h5><br>  Big words that do not reflect the essence of what is happening.  But it is remotely so - as soon as the object is not needed by anyone, it is deleted.  <i>You can cut it off with <b>shared_ptr</b> , except that the object itself is both a container and an object.</i> <br>  shared_self_conrolled literally means the following.  An object can be separated (as opposed to a simple self_controlled), and it must follow when it needs to self-destruct (as opposed to shared). <br>  Once the object has been transferred, the library does not need it; it deletes itself from the list of users.  If they become zero - no one else can turn to the object, it is not needed. <br><br><h5>  Data processing </h5><br><h6>  Deferred reading </h6><br>  Suppose we need to transfer a file of several megabytes in size per kilobyte connection.  Should the file be uploaded to memory for a few minutes?  Or even so, our file weighs several gigabytes. <br>  The point of this example is that data is not always worth processing instantly.  It is better to postpone work for tomorrow, because today the end of the world may come, right?  ;) <br><br><h6>  Thread tension </h6><br>  If we want to pull the machine by the rope (such a toy), it will go only when the entire thread is pulled.  Strength will be transferred from one layer to another, evenly.  If in some place the stiffness is less than others - it will stretch, taking all the load on itself. <br>  When data handlers line up we are not interested in what happens in the middle.  Only movement at the ends. <br>  Suppose we have a decompress handler that decompresses the compressed data, and the client needs 30 bytes.  During decompression, only 5 bytes of input data were used to obtain this volume.  The moral is that each link knows how much is needed from the next, and nothing more.  This is reflected in the library - the whole calculation takes place on request. <br><br><h6>  Caching </h6><br>  Suppose we need to process data that is requested every few seconds.  It is logical to create such a chain: <br>  download =&gt; calculation =&gt; save to temporary file =&gt; download from temporary file =&gt; transfer <br>  In this case, only the data necessary for processing will be stored in memory, and only ready for transmission in the file. <br>  It is foolish to wait a few seconds to find out how much data is needed, it is necessary that they are ready. <br>  The logical solution is obvious - in your free time, drag the data so that it is the minimum number at the calculation and loading stage, and the maximum in the temporary file. <br>  For this, there are container parameters: minimize to, maximize to.  (This means that if the limit is violated, it will stop sending requests further) <br>  Another great example is the proxy.  It is not necessary to download data faster than we can issue it, it will increase the memory consumption on the local machine, it does not suit us. <br><br><h4>  Conclusion </h4><br>  I hope this post I was able to reveal a bit of those ideas that were the reason for creating the library, and why it seems to me competitively capable.  I also believe that several brave souls will want to take part in the creation of something so wonderful (IMHO) as the architecture proposed here. <br>  It‚Äôs definitely not all the ideas hidden in the project, some of them went into the subconscious and hid in the bone marrow, it seems obvious.  This is only the most significant, and come to mind. <br>  <i>‚ÄúWe are taught to remember not a <s>project of a</s> person, but an idea, because a person is weak and can be caught, he can be killed and put to oblivion.</i>  <i>But the idea and 400 years later can change the world. "</i> " V means Vendetta " <br>  Have a great weekend. </div><p>Source: <a href="https://habr.com/ru/post/151958/">https://habr.com/ru/post/151958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151951/index.html">Mikrotik + IPSec + Cisco = Peace, Friendship, Gum</a></li>
<li><a href="../151953/index.html">Open webOS ported to Raspberry Pi microcomputer</a></li>
<li><a href="../151954/index.html">Solving a traveling salesman problem on a plane by a recursive greedy algorithm</a></li>
<li><a href="../151955/index.html">Asus S46 Ultrabooks Video Review (S56)</a></li>
<li><a href="../151957/index.html">HiFiMAN HM-801: big sound in your pocket</a></li>
<li><a href="../151959/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ23 (September 15 - 21, 2012)</a></li>
<li><a href="../15196/index.html">Useful software to protect your computer</a></li>
<li><a href="../151960/index.html">Apple lost in the German trial of Motorola and Samsung</a></li>
<li><a href="../151961/index.html">"Heroes of Mat and Fur" ported to javascript</a></li>
<li><a href="../151962/index.html">Remembering the past</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>