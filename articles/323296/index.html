<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We connect VKontakte SDK for Xamarin.Forms</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, we looked at the issue of connecting native SDKs from Facebook in your applications on Xamarin.Forms for easy user authorization....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We connect VKontakte SDK for Xamarin.Forms</h1><div class="post__text post__text-html js-mediator-article">  In the last article, we looked at the issue of connecting native SDKs from Facebook in your applications on Xamarin.Forms for easy user authorization.  Today, as promised, we will consider connecting native SDKs for the social network VKontakte.  The new SDK will connect to the project that we described in the <a href="https://aka.ms/habr_323296_2">last article</a> . <br><br><img src="https://habrastorage.org/files/66c/449/6b4/66c4496b45134cf78428b8671f8dce35.jpg"><br><a name="habracut"></a><br><h2>  Create an application in VKontakte </h2><br>  In general, the integration process of VK will strongly resemble work with Facebook, so feel free to go to <a href="https://aka.ms/habr_323296_3">the application management page</a> . <br><br>  Click "Create an application" and select "Standalone-application". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/9bd/dcb/2d3/9bddcb2d34b447c7911b8b5f5c2bf71a.png"><br><br>  Next, go to Settings and enter information about the application.  The "certificate fingerprint" is Key Hashes, which we received in the last article. <br><br><img src="https://habrastorage.org/files/733/ef1/734/733ef17348884c34aef9e185b75616f4.png"><br><br>  This preparatory part is completed. <br><br><h2>  We connect VKontakte SDK to iOS and Android projects </h2><br>  There are a lot of ready-made bindings available for Xamarin, however, a full-featured <a href="https://aka.ms/habr_323296_4">VKontakte SDK</a> appeared quite recently.  The library has been in the beta stage for some time and is now ready for use.  Thanks a lot Matthew Leibowitz! <br><br><img src="https://habrastorage.org/files/f79/7fd/509/f797fd50937341658af917ad839506a7.png"><br><br><h4>  We connect in iOS </h4><br>  We make changes to <code>Info.plist</code> .  <code>CFBundleURLTypes</code> values ‚Äã‚Äãfor VKontakte: <br><br><pre> <code class="cpp hljs">&lt;key&gt;CFBundleURLTypes&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;dict&gt; &lt;key&gt;CFBundleURLName&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;vk5874073&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;key&gt;CFBundleURLSchemes&lt;/key&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;fb1102463466549096&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;vk5874073&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;/<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt; &lt;/dict&gt; &lt;/<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&gt;</code> </pre> <br>  Add new <code>LSApplicationQueriesSchemes</code> : <br><br><pre> <code class="cpp hljs"> &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;vk&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;vk-share&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;vkauthorize&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;</code> </pre> <br>  And also the new domain in <code>NSAppTransportSecurity</code> : <br><br><pre> <code class="cpp hljs">&lt;key&gt;vk.com&lt;/key&gt; &lt;dict&gt; &lt;key&gt;NSExceptionRequiresForwardSecrecy&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">false</span></span>/&gt; &lt;key&gt;NSIncludesSubdomains&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>/&gt; &lt;key&gt;NSExceptionAllowsInsecureHTTPLoads&lt;/key&gt; &lt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>/&gt; &lt;/dict&gt;</code> </pre> <br>  After that, we make changes to <code>AppDelegate.cs</code> . <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinishedLaunching</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIApplication app, NSDictionary options)</span></span></span><span class="hljs-function"> </span></span>{ Xamarin.Forms.Forms.Init(); LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); Facebook.CoreKit.Profile.EnableUpdatesOnAccessTokenChange(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); Facebook.CoreKit.ApplicationDelegate.SharedInstance.FinishedLaunching(app, options); VKSdk.Initialize(<span class="hljs-string"><span class="hljs-string">"5874073"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> base.FinishedLaunching(app, options); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenUrl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIApplication application, NSUrl url, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sourceApplication, NSObject annotation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> VKSdk.ProcessOpenUrl(url, sourceApplication) || Facebook.CoreKit.ApplicationDelegate.SharedInstance.OpenUrl(application, url, sourceApplication, annotation) || base.OpenUrl(application, url, sourceApplication, annotation); }</code> </pre> <br>  This completes the initial initialization of iOS. <br><br><h4>  Connect to Android </h4><br>  But for Android, you will have to additionally override your <code>Application</code> class to correctly initialize the SDK. <br><br><pre> <code class="cpp hljs"> [Application] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainApplication</span></span></span><span class="hljs-class"> :</span></span> Application { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainApplication</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IntPtr handle, JniHandleOwnership transer)</span></span></span><span class="hljs-function"> :</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handle, transer)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ base.OnCreate(); VKSdk.Initialize(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).WithPayments(); } }</code> </pre> <br>  Now add the application ID to <code>strings.xml</code> : <br><br><pre> <code class="cpp hljs"> &lt;integer name=<span class="hljs-string"><span class="hljs-string">"com_vk_sdk_AppId"</span></span>&gt;<span class="hljs-number"><span class="hljs-number">5874073</span></span>&lt;/integer&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> name=<span class="hljs-string"><span class="hljs-string">"vk_data_theme"</span></span>&gt;vk5874073&lt;/<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;</code> </pre> <br><br>  Add some code to <code>AndroidManifest.xml</code> between <code>&lt;application ..&gt; ‚Ä¶</code> : <br><br><pre> <code class="cpp hljs"> &lt;activity android:name=<span class="hljs-string"><span class="hljs-string">"com.binwell.login.MainActivity"</span></span> android:exported=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.VIEW"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span> /&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.BROWSABLE"</span></span> /&gt; &lt;data android:scheme=<span class="hljs-string"><span class="hljs-string">"@string/vk_data_theme"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/activity&gt;</code> </pre> <br>  And complete the extension <code>MainActivity</code> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> override async </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, Result resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> vkResult; var task = VKSdk.OnActivityResultAsync(requestCode, resultCode, data, out vkResult); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!vkResult) { base.OnActivityResult(requestCode, resultCode, data); AndroidFacebookService.Instance.OnActivityResult(requestCode, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)resultCode, data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { var token = await task; <span class="hljs-comment"><span class="hljs-comment">// Get token } catch (Exception e) { // Handle exception } }</span></span></code> </pre> <br><h2>  Integrating with Xamarin.Forms </h2><br>  By analogy with Facebook, we will create our own interface in a PCL project to work with the new SDK. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface IVkService { Task&lt;LoginResult&gt; Login(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><h4>  Implementation for iOS </h4><br>  For iOS, the implementation will look like this: <br><br><pre> <code class="cpp hljs">[assembly: Dependency(typeof(AppleVkService))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Login.iOS { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppleVkService</span></span></span><span class="hljs-class"> :</span></span> NSObject, IVkService, IVKSdkDelegate, IVKSdkUIDelegate { readonly <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[] _permissions = { VKPermissions.Email, VKPermissions.Offline }; LoginResult _loginResult; TaskCompletionSource&lt;LoginResult&gt; _completionSource; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppleVkService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ VKSdk.Instance.RegisterDelegate(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); VKSdk.Instance.UiDelegate = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;LoginResult&gt; Login() { _completionSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;LoginResult&gt;(); VKSdk.Authorize(_permissions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _completionSource.Task; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _loginResult = null; _completionSource = null; } [Export(<span class="hljs-string"><span class="hljs-string">"vkSdkTokenHasExpired:"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenHasExpired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VKAccessToken expiredToken)</span></span></span><span class="hljs-function"> </span></span>{ VKSdk.Authorize(_permissions); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">new</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ VKSdk.Instance.UnregisterDelegate(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); VKSdk.Instance.UiDelegate = null; SetCancelledResult(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AccessAuthorizationFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VKAuthorizationResult result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Token == null) SetErrorResult(result?.Error?.LocalizedDescription ?? @<span class="hljs-string"><span class="hljs-string">"VK authorization unknown error"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _loginResult = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { Token = result.Token.AccessToken, UserId = result.Token.UserId, Email = result.Token.Email, ExpireAt = Utils.FromMsDateTime(result.Token.ExpiresIn), }; Task.Run(GetUserInfo); } } <span class="hljs-function"><span class="hljs-function">async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ var request = VKApi.Users.Get(NSDictionary.FromObjectAndKey((NSString)@<span class="hljs-string"><span class="hljs-string">"photo_400_orig"</span></span>, VKApiConst.Fields)); var response = await request.ExecuteAsync(); var users = response.ParsedModel as VKUsersArray; var account = users?.FirstObject as VKUser; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != null &amp;&amp; _loginResult != null) { _loginResult.FirstName = account.first_name; _loginResult.LastName = account.last_name; _loginResult.ImageUrl = account.photo_400_orig; _loginResult.LoginState = LoginState.Success; SetResult(_loginResult); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> SetErrorResult(@<span class="hljs-string"><span class="hljs-string">"Unable to complete the request of user info"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserAuthorizationFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SetErrorResult(@<span class="hljs-string"><span class="hljs-string">"VK authorization unknown error"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShouldPresentViewController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UIViewController controller)</span></span></span><span class="hljs-function"> </span></span>{ Device.BeginInvokeOnMainThread(() =&gt; Utils.GetCurrentViewController().PresentViewController(controller, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, null)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedCaptchaEnter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VKError captchaError)</span></span></span><span class="hljs-function"> </span></span>{ Device.BeginInvokeOnMainThread(() =&gt; VKCaptchaViewController.Create(csaptchaError).PresentIn(Utils.GetCurrentViewController())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCancelledResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Canceled }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetErrorResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorString)</span></span></span><span class="hljs-function"> </span></span>{ SetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Failed, ErrorString = errorString }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoginResult result)</span></span></span><span class="hljs-function"> </span></span>{ _completionSource?.TrySetResult(result); _loginResult = null; _completionSource = null; } }</code> </pre> <br><h4>  Implementation for android </h4><br>  For Android, too, nothing unusual. <br><br><pre> <code class="cpp hljs">[assembly: Dependency(typeof(AndroidVkService))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Login.Droid { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AndroidVkService</span></span></span><span class="hljs-class"> :</span></span> Java.Lang.Object, IVkService { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AndroidVkService Instance =&gt; DependencyService.Get&lt;IVkService&gt;() as AndroidVkService; readonly <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[] _permissions = { VKScope.Email, VKScope.Offline }; TaskCompletionSource&lt;LoginResult&gt; _completionSource; LoginResult _loginResult; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Task&lt;LoginResult&gt; Login() { _completionSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;LoginResult&gt;(); VKSdk.Login(Forms.Context as Activity, _permissions); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _completionSource.Task; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _loginResult = null; _completionSource = null; VKSdk.Logout(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUserToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VKAccessToken token)</span></span></span><span class="hljs-function"> </span></span>{ _loginResult = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { Email = token.Email, Token = token.AccessToken, UserId = token.UserId, ExpireAt = Utils.FromMsDateTime(token.ExpiresIn) }; Task.Run(GetUserInfo); } <span class="hljs-function"><span class="hljs-function">async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUserInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ var request = VKApi.Users.Get(VKParameters.From(VKApiConst.Fields, @<span class="hljs-string"><span class="hljs-string">"photo_400_orig,"</span></span>)); var response = await request.ExecuteAsync(); var jsonArray = response.Json.OptJSONArray(@<span class="hljs-string"><span class="hljs-string">"response"</span></span>); var account = jsonArray?.GetJSONObject(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (account != null &amp;&amp; _loginResult != null) { _loginResult.FirstName = account.OptString(@<span class="hljs-string"><span class="hljs-string">"first_name"</span></span>); _loginResult.LastName = account.OptString(@<span class="hljs-string"><span class="hljs-string">"last_name"</span></span>); _loginResult.ImageUrl = account.OptString(@<span class="hljs-string"><span class="hljs-string">"photo_400_orig"</span></span>); _loginResult.LoginState = LoginState.Success; SetResult(_loginResult); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> SetErrorResult(@<span class="hljs-string"><span class="hljs-string">"Unable to complete the request of user info"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetErrorResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> errorMessage)</span></span></span><span class="hljs-function"> </span></span>{ SetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Failed, ErrorString = errorMessage }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCanceledResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SetResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult { LoginState = LoginState.Canceled }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoginResult result)</span></span></span><span class="hljs-function"> </span></span>{ _completionSource?.TrySetResult(result); _loginResult = null; _completionSource = null; } } }</code> </pre> <br><h4>  We connect to Xanarin.Forms </h4><br>  Everything.  VKontakte works! <br><br><img src="https://habrastorage.org/files/32e/8d2/86e/32e8d286e93344d497fb7887ed808daf.jpg"><br><br>  We remind you that for the publication of applications (so that someone other than you can log in), you must perform additional actions for each social network. <br><br><h2>  We use </h2><br>  Today we learned how to authorize users using native VKontakte SDK.  If you need more functionality to work with this social network, we recommend that you study the <a href="https://aka.ms/habr_323296_5">examples of Matthew himself</a> . <br><br>  The full code of the project with the connected native SDK for Facebook and VKontakte can be found <a href="https://aka.ms/habr_323296_6">at</a> . <br><br>  In the next article, we will look at universal ways to authorize users through OAuth in Xamarin.Forms applications.  Stay in touch, ask your questions in the comments and join the <a href="https://aka.ms/habr_323296_7">Xamarin Developers</a> group <a href="https://aka.ms/habr_323296_7">in Telegram</a> . <br><br><h3>  about the author </h3><br><img src="https://habrastorage.org/files/f70/e9c/e7a/f70e9ce7a2bd45a98e19652a08b15e26.JPG" align="left" width="120">  Vyacheslav Chernikov - head of development at <a href="https://aka.ms/habr_321454_4">Binwell</a> .  In the past, he was one of the Nokia Champion and Qt Certified Specialists, currently he is the Xamarin and Azure platform specialist.  He came to the sphere of mobile in 2005, since 2008 he has been developing mobile applications: he started with Symbian, Maemo, Meego, Windows Mobile, then switched to iOS, Android and Windows Phone. <br><br>  Articles Vyacheslav you can also read the <a href="https://aka.ms/habr_323296_8">blog on Medium</a> . <br><br>  <b>Other articles by the author:</b> <br><ul><li>  <a href="https://habrahabr.ru/company/microsoft/blog/332970">OAuth Authorization for Xamarin Applications</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/329908/">Deploy mobile software with Microsoft devops pipeline</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/325184/">DevOps in the service of man</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/327900/">Automate non-automated, or about Xamarin in real projects</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/310704/">Convenient REST for Xamarin Applications</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/281897/">Quickly create MVP (minimum viable product) based on Microsoft Azure and Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/303630/">Preparing Xamarin.Forms: Setting Up the Environment and First Steps</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/304678/">Increase work efficiency in Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/307890/">Working with screen states in Xamarin.Forms</a> </li><li>  <a href="https://habrahabr.ru/company/microsoft/blog/321454/">Connecting Facebook SDK for Xamarin.Forms</a> </li></ul><br><br><h2>  Xamarin Meetup: Complex Interfaces in Xamarin.Forms </h2><br>  If you want to talk with the Xamarin Developers community, as well as personally with Vyacheslav, on March 9 in Moscow there will be a meeting on the topic ‚ÄúComplex interfaces in Xamarin Forms‚Äù. <br><br>  Program mitap: <br><br>  18:00 - 18:30 Registration <br>  18:30 - 19:30 Vyacheslav Chernikov // Connecting RecyclerView / UICollectionView for layout of complex interfaces <br>  19:30 - 19:40 Coffee break <br>  19:40 - 20:40 Yury Nevalenyy // Collections and lists on Xamarin Forms, virtualization patterns and fast cells (Android, iOS, Windows) <br><br>  Participation is free, <a href="https://aka.ms/habr_323296_1">registration is required</a> . </div><p>Source: <a href="https://habr.com/ru/post/323296/">https://habr.com/ru/post/323296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323286/index.html">IBM will add deep learning for mainframes</a></li>
<li><a href="../323288/index.html">Ransomware Development Projections for 2017</a></li>
<li><a href="../323290/index.html">Overview uniset2-testsuite - a small bike for functional testing</a></li>
<li><a href="../323292/index.html">How to hack telecom providers: analysis of a real attack</a></li>
<li><a href="../323294/index.html">Testing problems: why 100% code coverage is bad</a></li>
<li><a href="../323298/index.html">Windows Server 2016 and Hyper-V Integration Services</a></li>
<li><a href="../323300/index.html">The Turing Competition for Student Theory. computer science and discrete mathematics</a></li>
<li><a href="../323302/index.html">Encryption algorithm based on elementary cellular automata</a></li>
<li><a href="../323304/index.html">We are looking for and analyzing errors in the code Media Portal 2</a></li>
<li><a href="../323306/index.html">How IT professionals work. Leonid Vyhovsky, systems architect, LiveTex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>