<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple electronic recorder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At first there was an idea 
 At work (I work in medicine) two electromechanical recorders are puffing and suffering, and I, along with them: mascara, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple electronic recorder</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/22b57039/5f421e35/bb6ace68/c491f6e5.jpg"><br><h5>  At first there was an idea </h5><br>  At work (I work in medicine) two electromechanical recorders are puffing and suffering, and I, along with them: mascara, mechanics - whether you know it's unpleasant.  One day, the idea came to my head: why not replace the two recorders choking with old age with a simple data collection system consisting of an ADC controller and a PC (even if weak and old) with the appropriate software with output capability to a printer?  And then it started in my head and spun ... <br><br><a name="habracut"></a><h5>  Lyrics </h5><br>  Since, apart from the idea, I had nothing: neither experience, nor special knowledge in circuit engineering and electronics, I had to shovel a fair amount of literature and search the open spaces of the network.  Also, the project was supposed to be a budget one, and therefore I had to master the LUT method, learn how to etch the boards, drill and solder - I don‚Äôt regret it at all.  Thus, I walked some, albeit small, path ‚Äî a path of trial and error; I cite some observations made by me in the process; maybe someone will compare them with his own and agree, or he may not agree: <br><ul><li>  a quick start like this will not work, you should not build illusions - you will have to sweat; </li><li>  it is better not to use emulators like Proteus at first, it is much more useful to experiment on real hardware, touch your hands, taste it and taste it.  For the simplest debugging, UART is sufficient; </li><li>  circuit boards - brr, I prefer <a href="http://easyelectronics.ru/sozdanie-pechatnoj-platy-metodom-lazernogo-utyuga.html">LUT</a> + ferric chloride + drilling, it turns out a little longer, but it gives a clear understanding of what you are doing; </li><li>  I advise you not to get involved in the installation of smd cases and the ‚Äúminimization‚Äù of circuit boards - it is quite difficult for a beginner, sometimes it is easier to reconnect the board in an ‚Äúincreased scale‚Äù with a simple mounted installation (again, more useful for understanding). </li></ul><br><br><h5>  About ADC theory and first attempt </h5><br>  After some research it turned out that it is possible to implement the conceived idea in several ways.  The simplest solutions are given in the Patrick Gell book (see the basement), the basics of analog-digital signal conversion are also explained there.  I give a typical scheme taken from there: <img src="https://habrastorage.org/storage1/3aaf19c4/9b88c0ac/a4c0cc38/d8d59a83.jpg"><br>  The circuit is based on the ADC chip.  The interaction with the PC is realized at the software level by forming control pulse sequences on the modem lines of the RS-232 interface of the PC.  This circumstance limits the data transfer rate and increases the likelihood of transmission error.  The measurement accuracy is determined by the ADC digit capacity (8 bits in this case), the accuracy of the reference voltage supplied to the ADC (the LT 1009 CZ ion is used here).  The speed of signal digitization depends on the time of ADC conversion and, again, on the accuracy of the interface organization by the developer.  Actually, this implementation was my first combat experience (see photo below), but soon I was disappointed because I felt the need for a more elegant solution.  The control program (driver) was written under DOS on pascal. <img src="https://habrastorage.org/storage1/13a525a1/f1fc95cd/cfbd130e/e1959283.jpg"><br>  Such schemes, despite their viability, in view of these shortcomings are practically not used, ADC chips are usually used together with a microcontroller, which already organizes data transfer at the hardware level, simultaneously performing any control operations or primitive data processing.  A good example of such a solution is <a href="http://dikoy44.narod.ru/projects/vkr11.htm">such</a> an AVR microcontroller based circuit: <br><img src="https://habrastorage.org/storage1/e6009d26/5c5164e6/142c11c5/445c0b6f.png"><br>  The circuit is based on Atmega8 microcontroller, FT232BM USB interface chip, AD7876 ADC chip, and REF195GP ION.  At the input, a differentiator based on an operational amplifier drives the input signal to the range of 0-5V (reference voltage of the ADC).  Analog-to-digital conversion of the signal is performed by the AD7876 ADC microcircuit and transmits data via the SPI interface to the microcontroller, which, in turn, ‚Äúthrows‚Äù the result into the usb-port via the UART and the FT232BM interconnect chip. <br>  As part of my task, I need to use 4 ADC channels.  An attractive possibility is the use of a built-in ADC microcontroller with a switched input, which will make it possible to abandon the use of an external ADC microcircuit and provide the necessary number of channels - a cheap and simple solution.  It is not necessary to include a differentiator in the circuit, since the amplitude of the signal at each of the inputs does not exceed 2-2.5 V. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  The scheme of my device </h5><br>  The ADC controller is based on the AVR Atmega8 microcontroller.  MK has a sufficient number of legs in order to connect 4 ADC channels, signal LEDs, PC interface board.  The circuit uses an external ION L1009CZ.  The interface board with the PC through the <a href="http://easyelectronics.ru/svyaz-mikrokontrollera-s-kompyuterom-cherez-rs232.html">RS-232 interface is</a> based on the MAX232 chip and is separated from the main module, if necessary, can be replaced with a board with an <a href="http://easyelectronics.ru/preobrazovatel-usb-uart-na-ftdi-ft232rl.html">FT232</a> on board for pairing via USB, or with any bluetooth module (type <a href="http://forum.easyelectronics.ru/viewtopic.php%3Ff%3D17%26t%3D3510">BTM-222</a> , <a href="http://habrahabr.ru/blogs/DIY/125214/">HC-04</a> ) for communication via blootooth interface.  The figure below shows a schematic diagram of the device being developed: <br><img src="https://habrastorage.org/storage1/6c589b4e/bdf00da6/db7080f2/e97d6936.jpg"><br>  The power scheme is standard - based on the 78L05 linear stabilizer, the HL1 signaling LED is present.  The schematic diagram is drawn using sPlan, the layout of the board is in Sprint Layout.  At the end of the technological chain - LUT + etching + drilling + soldering we get: <br><img src="https://habrastorage.org/storage1/859a201d/70304d64/d7c8fb3a/e95969f4.jpg"><br>  Bottom view: <br><img src="https://habrastorage.org/storage1/b0b8a8c0/ff14a343/57b40775/8b1dda63.jpg"><br><br><h5>  Software part </h5><br>  For coding I used AVRStudio + WinAVR (AVR-GCC) under Windows, an alternative for Linux - Eclipse + AVR-GCC.  I tried CodeVisionAVR - not bad for a start, it has a built-in code generator, a code limit of 2 KB. <br>  The firmware works according to the following algorithm: <br><ul><li>  initialization: functions - UART_init, ADC_init, LED_init; </li><li> sequential interrogation of channels in an infinite interrupt cycle and data transfer via UART to the PC com port. </li></ul><br>  In order to debug the text test messages are distributed.  Switching the polling channel is highlighted by the corresponding LED.  During initialization, all 4 LEDs flash simultaneously.  In order to switch the LEDs was noticeable to the eye deliberately put a delay. <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* WinAVR version... Chip: ATmega8 Memory Model: SMALL Data Stack Size: 256 bytes Clock frequency: 4.0000 MHz PCO - PC3 - Channels */</span></span> <span class="hljs-comment"><span class="hljs-comment">// ATmega8 I/O register definitions #include &lt;avr/io.h&gt; #include &lt;util/delay.h&gt; #include &lt;avr/interrupt.h&gt; #include &lt;stdio.h&gt; #define ADC_VREF_TYPE 0x40 #define ADC_CH1_MUX 0x1 #define ADC_CH2_MUX 0x2 #define ADC_CH3_MUX 0x3 // Counter of channel's changes uint8_t i = 0; void LED_init(void){ printf("Led initialization....\r\n"); char j = 0; DDRD|= (1&lt;&lt;DDD7); DDRB|= ((1&lt;&lt;DDB0)|(1&lt;&lt;DDB1)|(1&lt;&lt;DDB2)); for(j=0;j&lt;5;j++) { PORTD|=(1&lt;&lt;PD7); PORTB|=(1&lt;&lt;PB0)|(1&lt;&lt;PB1)|(1&lt;&lt;PB2); _delay_ms(600); PORTB&amp;= ~((1&lt;&lt;PB0)|(1&lt;&lt;PB1)|(1&lt;&lt;PB2)); PORTD&amp;= ~(1&lt;&lt;PD7); _delay_ms(600); } } //Sending of single char static int my_putchar(char c, FILE *stream){ while((UCSRA&amp;(1&lt;&lt;UDRE)) == 0); UDR = c; return 0; } void myUART_init(void){ // USART initialization // Communication Parameters: 8 Data, 1 Stop, No Parity // USART Receiver: Off // USART Transmitter: On // USART Mode: Asynchronous // USART Baud rate: 9600 UCSRA=0x00; UCSRB=0x08; UCSRC=0x86; UBRRH=0x00; UBRRL=0x19; //Redirection of stdout static FILE mystdout = FDEV_SETUP_STREAM(my_putchar, NULL, _FDEV_SETUP_WRITE); stdout = &amp;mystdout; printf("UART initialization....\r\n"); } void ADC_init(void){ // ADC initialization // ADC Voltage Reference: AREF pin // ADC High Speed Mode: Off // ADC Auto Trigger Source: None // Select ADC input 0 printf("ADC initialization....\r\n"); ADMUX=ADC_VREF_TYPE; ADCSRA=0x8E; } // ADC interrupt service routine ISR(ADC_vect){ // Here is sending data in RS-232 printf("I'am in interrupt...\r\n"); uint16_t data = ADCL; data+= (ADCH&lt;&lt;8); printf("Ch_%u=%u\r\n",i,data); //Control of ADMUX's state uint8_t pr = ADMUX; printf("ADMUX = %u\r\n",pr); data = 0; if (i == 3) { i = 0; ADMUX&amp;= ~ADC_CH3_MUX; PORTB&amp;= ~(1&lt;&lt;PB2); PORTD|=(1&lt;&lt;PD7); //Change of channel data = ADMUX; printf("3to0,ADMUX = %u\r\n",data); data=0; _delay_ms(25); } else { if (i == 0) { ADMUX|= ADC_CH1_MUX; PORTD&amp;= ~(1&lt;&lt;PD7); PORTB|= (1&lt;&lt;PB0); //Change of channel data = ADMUX; printf("0to1,ADMUX = %u\r\n",data); data=0; } if (i == 1) { ADMUX&amp;= ~ADC_CH1_MUX; ADMUX|= ADC_CH2_MUX; PORTB&amp;= ~(1&lt;&lt;PB0); PORTB|= (1&lt;&lt;PB1); //Change of channel data = ADMUX; printf("1to2,ADMUX = %u\r\n",data); data=0; } if (i == 2) { ADMUX&amp;= ~ADC_CH2_MUX; ADMUX|= ADC_CH3_MUX; PORTB&amp;= ~(1&lt;&lt;PB1); PORTB|= (1&lt;&lt;PB2); //Change of channel data = ADMUX; printf("2to3,ADMUX = %u\r\n",data); data=0; } i++; _delay_ms(25); } // Start a new AD conversion ADCSRA|=0x40; }; int main(void) { myUART_init(); ADC_init(); LED_init(); printf("I'am in main...\r\n"); // Global enable interrupts sei(); // Start the first AD conversion ADCSRA|=0x40; while (1); }</span></span></code> </pre> <br><br>  After debugging is complete, test messages need to be commented out and unnecessary delays removed.  The code was written buried in <a href="http://www.atmel.com/dyn/products/product_docs.asp%3Fcategory_id%3D163%26family_id%3D607%26subfamily_id%3D760%26part_id%3D2004">datasheet</a> , everything is written in detail. <br><br><h5>  Programmer </h5><br>  The simplest programmer <a href="http://easyelectronics.ru/programmator-stk200300-dlya-mikrokontrollerov-avr.html">STK200</a> was used for the firmware, and the wiring of the board had to be done on its own in order to facilitate the soldering.  Stitched avrdude.  I tried avreal - an excellent alternative, there were no difficulties either. <br><img src="http://habrastorage.org/storage1/d681272e/4003765c/17ec8ad6/d8c0c2bb.jpg"><br><img src="http://habrastorage.org/storage1/763e3cb6/962b5632/93bed055/0b6b9307.jpg"><br><br><h5>  Finally - it works! </h5><br>  After debugging the code, several erase / write cycles of the MK device came to life and blinked the LEDs to my great joy. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/6EGkOT40cgk%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhj-CLwR4UeYrmPuzOGh7dg4Z8b1Dg" frameborder="0" allowfullscreen=""></iframe><br>  On the PC, used a text terminal to work with the COM port.  They are in bulk in the network, if you wish, you can write yourself, for example, using QT + <a href="http://qt-apps.org/content/show.php%3Fcontent%3D112039">QSerialDevice</a> (a wonderful library for working with com ports, written by our compatriot Denis Shienkov), or whatever. <br><br><h5>  Finally </h5><br>  The plans left only writing software for the PC.  Actually, I'm already writing, using QT + QSerialDevice + <a href="http://qwt.sourceforge.net/">QWT</a> in conjunction, and soon, soon, I feel my graphics will <a href="http://qwt.sourceforge.net/">crawl</a> across the display.  And still thinking about how to implement the hardware on the MK STM32F series, taking as a basis the STM32VLDISCOVERY mentioned already on the <a href="http://habrahabr.ru/blogs/controllers/123791/">Habr√©</a> ‚Äî I want to master the new hardware. <br><br><h5>  Useful literature </h5><br>  Will help digest all the above books: <br>  P. Horowitz, W. Hill.  ‚ÄúThe Art of Circuit Engineering‚Äù is a classic thing; <br>  Patrick Gell.  How to turn a personal computer into a measuring complex is mentioned above. </div><p>Source: <a href="https://habr.com/ru/post/125907/">https://habr.com/ru/post/125907/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125900/index.html">We publish Google+ Stream on your site</a></li>
<li><a href="../125903/index.html">FluentOpenXml - Foxby</a></li>
<li><a href="../125904/index.html">Ruby Conference in Kiev</a></li>
<li><a href="../125905/index.html">Review of fresh materials, June 2011</a></li>
<li><a href="../125906/index.html">TOP 7 - for 7 days. Marketing iPad apps on the Apple Store</a></li>
<li><a href="../125908/index.html">Appiny - not for "blondes"!</a></li>
<li><a href="../125912/index.html">Code organization with introspection in the context of obfuscation and refactoring</a></li>
<li><a href="../125915/index.html">How to motivate yourself when enthusiasm ended</a></li>
<li><a href="../125916/index.html">Microsoft promotes Google Chrome?</a></li>
<li><a href="../125917/index.html">10 blunders novice online businessman</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>