<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extreme migration to PostgreSQL: without stopping, losing and testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just a month ago, Yandex.Money ended the relocation of the user profile service from Oracle to PostgreSQL. So now we have a proven solution to migrate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extreme migration to PostgreSQL: without stopping, losing and testing</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/395/b2b/b1f/395b2bb1fd554205aec1830fc249e4a6.png"></p><br><p>  Just a month ago, Yandex.Money ended the relocation of the user profile service from Oracle to PostgreSQL.  So now we have a proven solution to migrate large amounts of data <strong>without loss</strong> and <strong>stop</strong> using their service. </p><br><p>  Under the cut, I will tell you more about how it all happened, why we chose to migrate SymmetricDS and why we still couldn‚Äôt do without ‚Äúmanual‚Äù efforts.  I will also share some developments on the auxiliary code for migration. <a name="habracut"></a></p><br><blockquote>  For the first migration and run-in of the solution, we chose a service serving user profiles.  The profile includes the payment history, favorites, reminders, and other such things - all important, but not critical for the operation of the system.  We have a database without embedded logic, so we only needed to transfer the data and sequences to the new platform. </blockquote><br><h1 id="itak-cherez-3-mesyaca-profili-polzovateley-dolzhny-rabotat-bez-oracle">  So, after 3 months, user profiles should work without Oracle </h1><br><p>  In connection with the impending releases on other projects, they decided to complete the transfer in three months.  The migration team consisted of 4 people, but these were Senior level developers and DBA specialists.  So that a small team could manage in a short period of time, they looked for the most automated solution for the project: without writing the data migration code, manually assembling the database schema, etc.  The database contains about 50 tables, so the probability of human error is especially high with manual conversions. </p><br><p>  Usually such migrations are performed with the service stopped - during off hours.  But Yandex.Money payments take place around the clock, so it was impossible to stop the system for the sake of internal "optimizations".  In fact, for this component, the business agreed to a one or two minute suspension for us, without losing data. </p><br><h1 id="v-poiskah-idealnogo-instrumenta">  Looking for the perfect tool </h1><br><p>  The quarterly term of the project did not leave room for the invention of its own quasi-bicycles.  Therefore, by brainstorming, we collected and screened out a list of suitable products for migration: </p><br><ol><li><p>  <strong>Oracle GoldenGate</strong> - it may seem that this is the silver bullet.  At least until familiarization with the price. </p><br></li><li><p>  <strong>SymmetricDS</strong> - there is a scheme migration, it will be created or updated during the registration of the PostgreSQL node in the Oracle master node.  It is possible to transform the data when uploading or downloading using BASH, Java or SQL. </p><br></li><li><p>  <strong>Full Convert</strong> - can migrate the scheme and data, but the possibilities of customization are limited, there are no variable transformers (the code for changing data during migration). </p><br></li><li><p>  <strong>Oracle to PostgreSQL Migration</strong> - transfers schema, data, foreign keys, indexes.  Semi-automatic replication, no transformation, but you can set the type correspondence in different databases. </p><br></li><li><p>  <strong>ESF Database Migration Toolkit</strong> - migrates all the same as Oracle to PostgreSQL Migration.  Data is transmitted in batch mode, the ability to migrate to multiple threads is missing. </p><br></li><li><p>  <strong>Ora2Pg</strong> - transfers the scheme, data, foreign keys, indexes, migration in several streams is possible.  From minuses: slow transfer of tables with blob / clob types (about 200 records / s), no transformer. </p><br></li><li>  <strong>SQLData Tool</strong> - migrates only the schema, limited customization options. </li></ol><br><p>  The rest of the products on the market are either already abandoned by the developers, or do not have developed support in the community. </p><br><p>  As a result, we chose <strong>Ora2Pg</strong> to migrate the database schema and <strong>SymmetricDS</strong> for data migration.  In general, the latter is designed more to synchronize different DBMS than to transfer data.  But in our case, he allowed to provide migration without stopping services. </p><br><h1 id="tysyacha-i-odna-meloch-dlya-migracii">  Thousand and one little thing to migrate </h1><br><p>  When we were running migration on copies of the production base, we found a whole set of ‚Äúfeatures‚Äù and oddities in the migration solution.  PostgreSQL did not correctly work out some queries that passed without problems in Oracle.  For example, <strong>SELECT *</strong> caused an error and stopped the operation of the entire database service.  In general, such requests are bad form, in fact they were different, and I cited these as merely a legal example.  It turned out that this is most likely a Java driver problem, so at the time of the project implementation it was easier not to use problematic queries.  Later <a href="https://github.com/pgjdbc/pgjdbc/pull/451%26sa%3DD%26ust%3D1492597727640000%26usg%3DAFQjCNHzqHKKSFh3oIE8OdFKw9eH9K2rKw">this bug was</a> fixed. </p><br><p>  There were difficulties with transactions with the <strong>AutoCommit-OFF</strong> flag <strong>set</strong> .  In PostgreSQL, the code crashed if, when it was executed, the transaction was not previously opened.  Oracle behaved differently: the transaction was rolled back or ended with code that came into the same thread of execution.  The solution for PostgreSQL is to write code that checks for an explicitly open transaction for all data change requests. </p><br><p>  When executing queries, the user profile service did not specify the sorting order of the displayed values ‚Äã‚Äã(ORDER BY), since in Oracle, the absence of a sign indicates the output in chronological order.  And on this we slipped into PostgreSQL, which output the results of the query separately - combed the code so that ORDER BY is everywhere. </p><br><p><img src="https://habrastorage.org/files/cf2/377/51d/cf237751d06c4d48baeb59209c62dcba.png" alt="image alt text"></p><br><p>  An interesting nuance was with composite transactions that changed data in both the original Oracle database and the instance transferred to PostgreSQL.  To ensure that both bases have the same values, our team has developed a special transaction manager.  He synchronously opened and closed transactions in both DBMSs.  If errors occurred in such transactions, then they had to be solved manually. </p><br><h1 id="i-poneslos">  And it started </h1><br><p>  Data migration was phased - according to a pre-approved list of 50 tables.  They decided to do the switching at the level of each table in the database, which made it possible to achieve high flexibility and decomposition of the process.  That is, at a certain moment, after the data was transferred, a special flag was set for the table, according to which the Ya.Money service switched to a data instance in PostgreSQL. </p><br><p>  For successful migration of Oracle-PostgreSQL, it is important to plan in advance so that no annoying little thing is forgotten.  We had such a plan, here it is under the spoiler: </p><br><div class="spoiler">  <b class="spoiler_title">Oracle-PostgreSQL Migration Checklist</b> <div class="spoiler_text"><p>  <strong>What the developer needs to do:</strong> </p><br><ol><li><p>  get DDL tables on PostgreSQL; </p><br></li><li><p>  highlight the interface for the DAO class; </p><br></li><li><p>  create a DAO class for working with PostgreSQL; </p><br></li><li><p>  create a flag to switch work from Oracle DAO to PostgreSQL DAO; </p><br></li><li><p>  write tests for a new DAO with a coverage of 80% (using the jOOQ mechanism to avoid errors in the syntax of SQL queries).  More is better; </p><br></li><li><p>  roll in migration on a test bench; </p><br></li><li><p>  perform migrations at the acceptance stand, make sure that the acceptance tests pass; </p><br></li><li>  Release changes to the combat environment. </li></ol><br><p>  <strong>Manual for DBA:</strong> </p><br><ol><li><p>  get from the developer DDL of the table being migrated to the PostgreSQL database, create the table and all related entities; </p><br></li><li><p>  specify the migration method from the developer - is it necessary to first download the old data and synchronize the new records? <br>  If there is a lot of data, then by what criteria it is possible to limit the volume of the initial load; </p><br></li><li><p>  configure SymmetricDS to synchronize the table; </p><br></li><li><p>  in one transaction, start the initial download (if required) and synchronize new records; </p><br></li><li><p>  periodically check the status of download and synchronization; </p><br></li><li>  just before switching services to PostgreSQL, move the sequences in the destination table for the stock by primary keys. </li></ol><br><p>  <strong>What you need to not forget the person responsible for the process:</strong> </p><br><ol><li><p>  make sure that the production supports PostgreSQL for a specific table; </p><br></li><li><p>  check that production has successfully completed the initial data download and synchronization of new records is turned on; </p><br></li><li><p>  ask the DBA to move the sequences to PostgreSQL; </p><br></li><li><p>  switch one instance of the service to work with PostgreSQL, make sure that there are no errors in the logs and the logic of the service; </p><br></li><li><p>  switch the remaining instances of the service; </p><br></li><li>  after a full switch, ask DBA to rename the migrated tables in Oracle.  Carefully monitor the errors in the system - some "forgotten" logic of the service may still try to work with Oracle. </li></ol></div></div><br><p>  During the migration, some of the 50 tables worked on Oracle, the other on PostgreSQL.  This is where SymmetricDS came in handy, which migrated data from Oracle to PostgreSQL and thus ensured consistency both for logic with transferred tables, and for those that still worked according to the old scheme. </p><br><p>  After the data was transferred in the service, the checkbox ‚Äúwork with PostgreSQL‚Äù was set for each specific table, and the queries went to the new DBMS.  First, the switching was checked on the dev-stand, then on the acceptance one.  If OK - switch to production and rename the table in Oracle (to see if the old table is still being used). </p><br><p><img src="https://habrastorage.org/files/518/b37/b54/518b37b542b3436e9fd43248a774d94e.png" alt="image alt text"></p><br><p>  <em>The diagram shows the essence of the idea: after creating a duplicate of the database on PostgreSQL, the service sets the flag new db, after which all calls go to the new database.</em> </p><br><p>  But the most difficult was to choose the right moment of switching.  In fact, we had 3 migration options, depending on the criticality and complexity of the table: </p><br><ol><li><p>  <strong>Transfer table entirely with the subsequent switching</strong> .  The option was suitable in cases where part of the requests could be lost (the user may be asked to click the button again, or the automatic continuation of the operation will work). </p><br></li><li><p>  <strong>At the level of data center</strong> (DC, a total of 2).  A way to transfer critical tables, in which we first translate the first data center to PostgreSQL, and in the process of turning it on, turn off the second (from Oracle).  At the time of the start - stop Oracle and PostgreSQL could work in parallel, so the synchronization and data switching mechanisms were useful here.  There was no idle service at the same time. </p><br></li><li>  <strong>According to the method of "residual pressure</strong> . <strong>"</strong>  We leave 2 copies: Oracle for processing late requests for switching and the new PostgreSQL.  New tasks were processed in the new database, and old ones were deleted after execution in the remaining Oracle.  This is how the base queues moved - auto payments, reminders, etc. </li></ol><br><p>  Not without complications.  During the initial formation of the database schema for PostgreSQL, the converter did not produce a 100% ready-made version, as expected, in general.  It was necessary to manually change some types of columns, correct the sequences and break the scheme into tables and indexes.  However, the latter is for order and general aesthetics. </p><br><p>  A little later, it turned out that SymmetricDS does not synchronize tables of more than 150 GB.  Therefore, I had to sit down at the code and create a workaround for the transfer to such cases. </p><br><p>  However, there was no silver bullet either.  SymmetricDS did not transfer the CLOB \ BLOB fields if, because of them, the total size of the table was exceeded, so I had to write manual migration queues.  Faced with quite exotic cases, when the migration from Oracle to PostgreSQL led to a sharp decline in performance.  Nothing remained but to manually disassemble each individual case.  For example, for one table, it was necessary to allocate the CLOB field into a separate table, transfer it to an SSD disk and read this field only if necessary. </p><br><p>  Since it was necessary to maintain simultaneously active old and new copies of the database, for new ones we made a reserve for sequences to prevent layering and transfer of duplicate keys to PostgreSQL. </p><br><p><img src="https://habrastorage.org/files/263/962/c9a/263962c9a14a479e86762f4220969ea7.png"><br>  <em>The diagram shows a schematic depiction of a new table in PostgreSQL with a ‚Äúpadding‚Äù between old and new data of 1000 keys.</em> </p><br><p>  That is, if the last key in the table was 100, then another 1,000 were added to this value, so that SymmetricDS could freely synchronize keys 101, 102 and all the others without overwriting new data. </p><br><h1 id="finishnaya-lentochka">  Finishing Ribbon </h1><br><p> For the planned quarter, our small team transferred 80% of the tables to PostgreSQL.  The remaining 20% ‚Äã‚Äãare large tables (on average more than 150 GB), including a collection table with CLOB \ BLOB volume fields.  All this had to finish manually the next 1.5 months.  Nevertheless, a bunch of SymmetricDS and Ora2Pg did most of the routine work, which was required by the conditions of the problem.  Our development team has fairly replenished the internal moneybox ‚Äúrake‚Äù for this project, some of which at the time of publication of the article probably remained behind the scenes. </p><br><p>  But Yandex.Money is already preparing a landing party for the upcoming <strong>PG Day'17</strong> conference, which will be held in St. Petersburg.  Come to the advanced report and prepare tricky questions. </p><br><p>  <strong>However, I propose to raise the most burning topics right here, in the comments.</strong>  <strong>It is very curious to read about your migration experience and, perhaps, about what we have lost sight of.</strong> </p><br><p>  In <a href="https://github.com/yandex-money/oracle-to-postgres-migration-utils">the Yandex.Money repository</a> you will find some code for the solutions described in the article: </p><br><ul><li><p>  Transaction Manager Sources </p><br></li><li>  The code of the class checking the presence of a transaction. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326998/">https://habr.com/ru/post/326998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326984/index.html">How Reddit created r / Place</a></li>
<li><a href="../326986/index.html">What is this GraphQL?</a></li>
<li><a href="../326990/index.html">Looking for fast local storage</a></li>
<li><a href="../326994/index.html">Guide for a novice project manager: drive a bike that burns</a></li>
<li><a href="../326996/index.html">Logical replication in PostgreSQL 10</a></li>
<li><a href="../327000/index.html">... And Justice for All</a></li>
<li><a href="../327002/index.html">LinqToSolr - use LINQ to get data from Solr</a></li>
<li><a href="../327004/index.html">All you need to know about detecting changes in Angular</a></li>
<li><a href="../327008/index.html">GeekUniversity is Russia's first online university with guaranteed employment.</a></li>
<li><a href="../327010/index.html">Analysis of the entrance exam ShAD-2015 and memories of the graduate of 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>