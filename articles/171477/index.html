<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Webrtc, Peer Connection - creating a full-fledged video chat in the browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Webrtc on Habr√© has been repeatedly mentioned, I would like to tell a little about the technical part of the implementation and highlig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Webrtc, Peer Connection - creating a full-fledged video chat in the browser</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d14/e63/2a6/d14e632a65ed412b95b5c0a096842ce8.png"><br><h4>  Introduction </h4><br>  Webrtc on Habr√© has been repeatedly mentioned, I would like to tell a little about the technical part of the implementation and highlight the creation of a small video chat.  I want to immediately state that the implementation of webrtc is constantly changing, including the names of the api functions, their parameters. <br>  Anyone who would just like to see how it all works, here: <a href="https://apprtc.appspot.com/">apprtc.appspot.com demo from Google</a> all you need is to follow the link and send it to someone else with the room number.  At the end you need to change the numbers if it turns out that the room is full.  Who cares how it all works welcome under the cat <br><a name="habracut"></a><br><br><h4>  a common part </h4><br>  API webrtc itself consists of three parts: <br><ol><li>  getUserMedia (MediaStream), if simplified, then this is a video stream capture in the browser, for example, just look at yourself;). <br>  On Habr√© <a href="http://habrahabr.ru/post/163527/">there is a good article</a> . </li><li>  RTCPeerConnection is used to communicate between browsers directly.  Actually, the RTCPeerConnection will be mainly discussed further. </li><li>  RTCDataChannel: necessary for the exchange of various data: text, files and others.  At the moment they write that it is available in 25 chrome only in the test version, without the inclusion of flags it will be available only in 27 chrome. </li></ol><br><br><h4>  Peer connection </h4><br>  So, let's begin.  In fact, in order not to reinvent the wheel, it was decided to take the code from this demo, make it a bit more universal (it is tied to the google app engine) and simplify in a couple of places.  Another adapter.js library is connected here - it is needed for some unification of the code, because a lot of things are written with prefixes, and also differ for the main browsers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The RTCPeerConnection itself is called quite simply: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Stun          ,    NAT,  , , google    . var pc_config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]}; var pc_constraints = {"optional": [{"DtlsSrtpKeyAgreement": true}]}; pc = new RTCPeerConnection(pc_config, pc_constraints); pc.onicecandidate = onIceCandidate; pc.onaddstream = onRemoteStreamAdded;</span></span></code> </pre> <br>  In the old version, slightly different parameters were passed to RTCPeerConnection (). <br><br><h4>  Initialize and Run RTCPeerConnection </h4><br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//          localVideo = document.getElementById("localVideo"); miniVideo = document.getElementById("miniVideo"); remoteVideo = document.getElementById("remoteVideo"); //                PeerConnection getUserMedia( {'audio':true, 'video':{"mandatory": {}, "optional": []}}, function(localVideo, stream){ //   PeerConnection. localVideo.src = window.URL.createObjectURL(stream); if (initiator) maybeStart(); }, function(error){console.log("Failed to get access to local media. Error code was " + error.code);} ); if (initiator) maybeStart(); sendMessage(); }</span></span></code> </pre><br><br><h4>  Message exchange </h4><br>  At this stage, browsers exchange different messages to learn how to communicate with each other.  In messages of the type of candidate come different options, including those received from the stun server. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//           . S-&gt;C: {"type":"candidate","label":1,"id":"video","candidate":"a=candidate:2437072876 1 udp 2113937151 192.168.1.2 35191 typ host generation 0\r\n"} S-&gt;C: {"type":"candidate","label":0,"id":"audio","candidate":"a=candidate:941443129 1 udp 1845501695 111.222.111.222 35191 typ srflx raddr 192.168.1.2 rport 35191 generation 0\r\n"}</span></span></code> </pre><br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// CallBack ,    RTCPeerConnection     ,      . ,        -   websokets,  ajax. pc.onicecandidate = onIceCandidate; function onIceCandidate(event) { if (event.candidate) { sendMessage({type: 'candidate', label: event.candidate.sdpMLineIndex, id: event.candidate.sdpMid, candidate: event.candidate.candidate}); } else { console.log("End of candidates."); } }</span></span></code> </pre><br><br>  Our function of sending a message through the server is quite simple, so it was decided to use the Ajax as a simpler and more accessible option for writing a small test version and for implementing the server part: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgString = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(message); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'C-&gt;S: '</span></span> + msgString); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/chat/tv"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">room</span></span>:room, <span class="hljs-attr"><span class="hljs-attr">user_id</span></span>:user_id, <span class="hljs-attr"><span class="hljs-attr">last</span></span>:last, <span class="hljs-attr"><span class="hljs-attr">mess</span></span>:msgString, <span class="hljs-attr"><span class="hljs-attr">is_new</span></span>:is_new }, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log([<span class="hljs-string"><span class="hljs-string">'data.msg'</span></span>, data.msg]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( data.last) last = data.last; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.msg){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = data.msg[res]; processSignalingMessage(msg[<span class="hljs-number"><span class="hljs-number">2</span></span>]); } } }); is_new = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">repeat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ timeout = setTimeout(repeat, <span class="hljs-number"><span class="hljs-number">5000</span></span>); sendMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!timeout) repeat(); }</code> </pre><br><br>  If the request is successful, then the response comes from the accumulated messages from another browser: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processSignalingMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//               . //        peeronnection var msg = JSON.parse(message); if (msg.type === 'offer') { if (!initiator &amp;&amp; !started){ if (!started &amp;&amp; localStream ) { createPeerConnection(); pc.addStream(localStream); started = true; if (initiator) pc.createOffer(setLocalAndSendMessage, null, {"optional": [], "mandatory": {"MozDontOfferDataChannel": true}}); } pc.setRemoteDescription(new RTCSessionDescription(msg)); pc.createAnswer(setLocalAndSendMessage, null, sdpConstraints); } else if (msg.type === 'answer' &amp;&amp; started) { pc.setRemoteDescription(new RTCSessionDescription(msg)); } else if (msg.type === 'candidate' &amp;&amp; started) { var candidate = new RTCIceCandidate({sdpMLineIndex:msg.label, candidate:msg.candidate}); pc.addIceCandidate(candidate); } else if (msg.type === 'bye' &amp;&amp; started) { pc.close(); } } function setLocalAndSendMessage(sessionDescription) { //  preferOpus  . sessionDescription.sdp = preferOpus(sessionDescription.sdp); pc.setLocalDescription(sessionDescription); sendMessage(sessionDescription); }</span></span></code> </pre><br><br>  In general, this is practically all, it now remains to assign the video stream to the &lt;video&gt; element and do not forget to call the function initializing the launch of the entire code. <br><pre> <code class="javascript hljs">pc.onaddstream = onRemoteStreamAdded; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRemoteStreamAdded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ remoteVideo.src = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL.createObjectURL(event.stream); remoteStream = event.stream; } setTimeout(initialize, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br><br><h4>  Server part </h4><br>  Our backend must be fairly simple; the server must coordinate the browsers before they can communicate directly. <br>  And another nuance, the parameter var initiator = {{initiator}} determines which of the browsers will establish a connection, and which one waits. <br>  That is, one should have 0, respectively, the other 1. <br><br>  The server part is quite simple, for a GET request we create a room in the database, transfer its id to the template, if it is not in the database, create a new one. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(room)</span></span></span><span class="hljs-function">:</span></span> doc = db.chat.find_one({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:room}) initiator = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> doc: initiator = <span class="hljs-number"><span class="hljs-number">0</span></span> doc = {<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:room, <span class="hljs-string"><span class="hljs-string">'mess'</span></span>: []} db.chat.save(doc) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> templ(<span class="hljs-string"><span class="hljs-string">'rtc.tpl'</span></span>, initiator = initiator, room=room)</code> </pre><br><br>  On a POST request, we receive data from the client and if the client has sent a non-empty message, then we enter its content into the room, then we check that the messages received ‚Äúfrom the counter visitor in the chat‚Äù and they are new then return them to their browser. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chat_post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> lst = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; msg = [] room = get_post(<span class="hljs-string"><span class="hljs-string">'room'</span></span>) user_id= get_post(<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>) last= float(get_post(<span class="hljs-string"><span class="hljs-string">'last'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) mess= get_post(<span class="hljs-string"><span class="hljs-string">'mess'</span></span>) doc = db.chat.find_one({<span class="hljs-string"><span class="hljs-string">'_id'</span></span>:room}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> mess: doc[<span class="hljs-string"><span class="hljs-string">'mess'</span></span>].append((time.time(), mess, user_id)) db.chat.save(doc) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i_time, i_msg, i_user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> doc[<span class="hljs-string"><span class="hljs-string">'mess'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i_user != user_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i_time &gt; last: lst = i_time msg.append((i_time, i_user, i_msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> lst: lst = last <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps({<span class="hljs-string"><span class="hljs-string">'result'</span></span>: <span class="hljs-string"><span class="hljs-string">'ok'</span></span>, <span class="hljs-string"><span class="hljs-string">'last'</span></span>: lst, <span class="hljs-string"><span class="hljs-string">'msg'</span></span>: msg})</code> </pre><br>  On this description of the northern part can be completed. <br><br>  Sources: <br>  <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">Help on webrtc at html5rocks.com</a> <br>  <a href="http://www.webrtc.org/">Official site webrtc</a> </div><p>Source: <a href="https://habr.com/ru/post/171477/">https://habr.com/ru/post/171477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171463/index.html">Why lay CloudFlare</a></li>
<li><a href="../171467/index.html">The second issue of the magazine TsODy.RF</a></li>
<li><a href="../171471/index.html">Boost Signals - Signals and Slots for C ++</a></li>
<li><a href="../171473/index.html">Qualcomm claims Snapdragon 800 beats Nvidia Tegra 4 easily</a></li>
<li><a href="../171475/index.html">Performance test: amazing and simple</a></li>
<li><a href="../171479/index.html">About modularity, good architecture, dependency injection in C / C ++ and multicolored circles</a></li>
<li><a href="../171481/index.html">Review NOOK Simple Touch with GlowLight</a></li>
<li><a href="../171483/index.html">PoolLiveAid shows the trajectory of the billiard ball</a></li>
<li><a href="../171485/index.html">Videobook Ultrabook ASUSPRO BU400V</a></li>
<li><a href="../171487/index.html">Askhat Urazbayev and Viktor Strelkov will hold a Scrum master class as part of DevCon 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>