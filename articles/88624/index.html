<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shaping traffic in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Under the cat described how to shape traffic in Linux and what you need to know. 
 We will perform traffic shaping using the tc utility from the iprou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shaping traffic in Linux</h1><div class="post__text post__text-html js-mediator-article"> Under the cat described how to shape traffic in Linux and what you need to know. <a name="habracut"></a><br>  We will perform traffic shaping using the tc utility from the iproute2 package. <br>  Knowledge without which it is impossible to realize the fullness of traffic management in Linux: <br>  <b>Shape can only be outgoing traffic from the interface.</b>  (in connection with which there is a problem with nat, we will talk about it later).  Suppose that there is a router between the "Internet" and the subscriber.  Two network cards are stuck in the router: eth0 looks at the subscriber, and eth1 into the world.  To limit the ‚Äúdownload speed‚Äù, the rules of shaping are described on eth0, to limit the ‚Äúreturn‚Äù - on eth1. <br>  <b>It is necessary to understand the difference between rate and ceil.</b>  Rate - guaranteed band skipping, Ceil - the maximum band a given class can receive, the rate can not exceed ceil <br>  <b>The rate and ceil parameters for the root class must match.</b>  Thus we define the total bandwidth. <br>  <b>The sum of the rates of descendant classes should not exceed the rate of the parent class.</b>  Of course you can not do this point, but then there may be problems with the provision of "guaranteed bandwidth." <br>  <b>Class IDs are in hexadecimal and must be between 2 and 2 ^ 16</b> <br>  <b>For intermediate classes it is not necessary to create disciplines and filters.</b> <br>  <b>Class identifiers within an interface must be unique.</b> <br><br>  In a simple form of presentation, the traffic cutting algorithm looks like this: <br>  1. Create a root discipline for the interface and specify the class where the unclassified traffic will fall. <br>  2. Create a root class and determine the width of the channel. <br>  3. Create a child class for subscriber shaping. <br>  4. Create a shaping discipline for the subscriber class. <br>  5. Create a filter to classify subscriber traffic. <br><br>  In principle, everything is simple, but in real life you have to spend a lot of nerves to achieve the desired result. <br>  One of the ways to achieve results without spending a lot of nerves is to use the htbinit script (you can take it from <a href="http://sourceforge.net/projects/htbinit/">sourceforge.net/projects/htbinit</a> ).  The syntax of configs is simple, creating classes is also easy. <br>  To build configurations of average complexity is enough. <br>  Example. <br>  There is a local network, medium size.  You need to limit the speed of subscribers according to the price list, address translation (NAT) occurs on another server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Getting htbinit <br> <code><a href=""></a> debian:~# wget downloads.sourceforge.net/project/htbinit/HTB.init/0.8.5/htb.init-v0.8.5?use_mirror=surfnet <br> debian:~# mv htb.init-v0.8.5 /usr/local/sbin/ <br> debian:~# cd /usr/local/sbin/ <br> debian:/usr/local/sbin# mv htb.init-v0.8.5 htb.init <br> debian:/usr/local/sbin# chmod +x htb.init</code> <br>  By default, htbinit stores configs in the / etc / sysconfig / htb folder. <br> <code>debian:~# mkdir -p /etc/sysconfig/htb</code> <br>  We create horse discipline for interface eth0 (the interface looks to the local network, "at the subscriber") <br> <code>debian:~# touch /etc/sysconfig/htb/eth0 <br></code> <br>  Specify which class will get traffic that does not fall into any of the filters <br> <code>debian:~# mcedit /etc/sysconfig/htb/eth0 <br> DEFAULT=42</code> <br>  Create a root class <br> <code>debian:~# touch /etc/sysconfig/htb/eth0-2.root <br> debian:~# mcedit /etc/sysconfig/htb/eth0-2.root <br> RATE=100Mbit</code> <br>  You can not specify the CEIL, then it will be equal to the machine RATE. <br><br>  Create a class for unclassified traffic. <br> <code>debian:~# touch /etc/sysconfig/htb/eth0-2:42.root <br> debian:~# mcedit /etc/sysconfig/htb/eth0-2:42.root <br> RATE=4Kbit</code> <br> <br>  We create the general client class.  Let his ID be equal to ‚ÄúD‚Äù and we will allocate 10 Mbps for all subscribers. <br> <code>debian:~# touch /etc/sysconfig/htb/eth0-2:D.sumamry_cilents_class <br> debian:~# mcedit /etc/sysconfig/htb/eth0-2:D.sumamry_cilents_class <br> RATE=10Mbit</code> <br> <br>  Now you can do subscribers. <br>  To limit the download speed of 512 kbps, subscriber Vasily needs to: <br>  Create a class for the subscriber Basil.  Let the client IDs begin with 255. It is very useful if you need to create some kind of "system" class. <br> <code>debian:~# touch /etc/sysconfig/htb/eth0-2:D:100.client_login</code> <br>  The interface, class identifier and parent classes are described in the name of the config. <br>  The entry eth0-2: D: 100.client_login means that <br>  <b>eth0-</b> This class belongs to the interface eth0 <br>  <b>2</b> Root class <br>  <b>D</b> Parent class (In our case, the general client class) <br>  <b>100</b> Class Class ID <br>  <b>client_login The</b> mnemonic component of the file name carries a meaning, is not used in class generation <br><br>  The file name is generated this way: <br>  1. Interface to which the class belongs. <br>  2. Separator "-" (minus) <br>  3. ID root class <br>  4. Separator ":" (colon) <br>  5. Parent class ID <br>  6. Separator ":" (colon) <br>  7. Client class ID <br>  8. Separator "." (Dot) <br>  9. The mnemonic component of the file name <br>  Points 5 and 6 may be missing, depending on the shaping strategy you choose. <br><br> <code>debian:~# mcedit /etc/sysconfig/htb/eth0-2:D:100.client_login <br> RATE=512Kbit <br> LEAF=sfq <br> RULE=0.0.0.0/0,client_ip/32 <br></code> <br>  At least in the config should be 3 lines. <br>  RATE - the band provided by the subscriber. <br>  LEAF - a pointer to the fact that the class is final and it is necessary to create a discipline for it, in our case sfq (‚Äúpseudo-fair‚Äù distribution of the band) <br>  RULE - we define what falls into the class. You can filter by IP addresses, subnets IP addresses, ports.  The number of RULE entries may be more than one. <br><br>  If we need to map traffic and natit on the same root, then instead of RULE you need to use MARK.  The only thing you have to label packages. <br>  An example of the script generating configs for htbinit in the configuration with NAT. <br> <code>#!/bin/bash</code> <br>  # define variables <br> <code>declare -a rules <br> inif="eth0" <br> outif="eth1" <br> vlan="10" <br> workdir="/home/netup" <br> vardir="${workdir}/var" <br> htb_dir="/etc/sysconfig/htb"</code> <br> <code>mysql="/usr/bin/mysql -h host -u user -ppassword -D base" <br> ipt="/usr/local/sbin/iptables" <br> IPT_UNLIM="UNLIM_"${vlan} <br> utm_rules="${vardir}/htb_rules_htb" <br> htb_rules="${vardir}/htb_rules_utm"</code> <br>  # prepare configs when you first start <br> <code>[ -e ${htb_rules} ] || touch ${htb_rules}</code> <br>  # complete regeneration of configs <br> <code>if [ "${1}" = "zopa" ];then <br> echo ""&gt; ${htb_rules}; <br> fi</code> <br>  # get data (id in hex system) <br> <code>echo "select id,ip,mask,speed from view_shaper order by id;"|$mysql|sed '1d' &gt; ${utm_rules};</code> <br>  # if you have reached the base and there is a difference with the current config <br> <code>exp="${utm_rules} ${htb_rules}" <br> [ -s ${utm_rules} ] &amp;&amp; if [ -n "`diff ${exp}`" ] <br> then</code> <br>  # delete configs need in which is no longer <br> <code>for i in `diff ${exp}|awk '{if (NF==5)print $2}'|sort -n|uniq` <br> do <br> inshaper=${htb_dir}/${inif}-2:${i}.rule_${i}; <br> [ -e ${inshaper} ] &amp;&amp; rm ${inshaper}; <br> outshaper=${htb_dir}/${outif}-2:${i}.rule_${i}; <br> [ -e ${outshaper} ] &amp;&amp; rm ${outshaper}; <br> done;</code> <br>  # form new configs <br> <code>rules=(`diff ${exp}|grep "&lt;"|awk '{if (NF==5)print $2,$3,$4,$5}'`) <br> for i in `seq 1 4 ${#rules[@]}`; <br> do <br> id=${rules[$i-1]}; <br> ip=${rules[$i]}; <br> mask=${rules[$i+1]}; <br> rate=${rules[$i+2]}; <br></code> <br>  # Generate the names of configs <br> <code>inshaper=${htb_dir}"/"${inif}-2:${id}.rule_${id}; <br> outshaper=${htb_dir}/${outif}-2:${id}.rule_${id};</code> <br>  # Calculate brand for packages <br> <code>inmark="0x"`echo "obase=16; $((0x${id}*2))"|bc` <br> outmark="0x"`echo "obase=16; $((0x${id}*2+1))"|bc`</code> <br>  # Remove "old" labeling rules <br> <code>${ipt} -t mangle -S ${IPT_UNLIM}|grep -w ${ip}|awk -v ipt=${ipt} '{$1="-D";system(ipt" -t mangle "$0)}';</code> <br>  # Create config and rules on the internal interface <br> <code>if [ -e ${inshaper} ]; then <br> #echo "RULE="0.0.0.0/0,"${ip}"/"${mask}"&gt;&gt; ${inshaper} <br> ${ipt} -t mangle -A ${IPT_UNLIM} -s ${ip} -j MARK --set-mark ${inmark} <br> else <br> echo "RATE=4096bit" &gt; ${inshaper} <br> echo "CEIL="$((${rate}*1024))"bit" &gt;&gt;${inshaper} <br> echo "LEAF=sfq" &gt;&gt; ${inshaper} <br> #echo "RULE=0.0.0.0/0,"${ip}"/"${mask}&gt;&gt; ${inshaper}; <br> echo "MARK="${inmark}&gt;&gt; ${inshaper}; <br> ${ipt} -t mangle -A ${IPT_UNLIM} -d ${ip}/${mask} -j MARK --set-mark ${inmark} <br> fi</code> <br>  # Create config and rules on the internal interface <br> <code>if [ -e $outshaper ]; then <br> #echo "RULE="${ip}"/"${mask}",0.0.0.0/0" &gt;&gt; ${outshaper} <br> ${ipt} -t mangle -A ${IPT_UNLIM} -s ${ip}/${mask} -j MARK --set-mark ${outmark} <br> else <br> echo "RATE=4096bit" &gt; ${outshaper} <br> echo "CEIL="$((${rate}*1024))"bit" &gt;&gt; ${outshaper} <br> echo "LEAF=sfq" &gt;&gt; ${outshaper} <br> #echo "RULE="${ip}"/"${mask}",0.0.0.0/0" &gt;&gt; ${outshaper} <br> echo "MARK="${outmark}&gt;&gt; $outshaper; <br> ${ipt} -t mangle -A ${IPT_UNLIM} -s ${ip}/${mask} -j MARK --set-mark ${outmark} <br> fi <br> echo $ip <br> done; <br> cp ${exp} <br> [ -e /var/cache/htb.init ] &amp;&amp; rm /var/cache/htb.init <br> /usr/local/sbin/htb.init restart <br> fi</code> <br> <br>  For configurations up to 1000-1500 filters, this option is suitable.  For larger ones, you already need to use fast hash filters, I will tell you about traffic prioritization in the next article. </div><p>Source: <a href="https://habr.com/ru/post/88624/">https://habr.com/ru/post/88624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88611/index.html">Treasury providers</a></li>
<li><a href="../88612/index.html">Habitual things, unusual functionality</a></li>
<li><a href="../88618/index.html">SharePoint Business Connectivity Services: New Features</a></li>
<li><a href="../88619/index.html">TrackChecker - mail monitoring. A year and a half of development</a></li>
<li><a href="../88620/index.html">Dirty job: Entry. Refill HP Color Inkjet Print Cartridges</a></li>
<li><a href="../88627/index.html">NVIDIA Optimus Technology and ASUS UL50VF Notebook Review</a></li>
<li><a href="../88628/index.html">RBS World Pay hackers arrested. Will extradite?</a></li>
<li><a href="../88629/index.html">Trove4j: high-performance collections</a></li>
<li><a href="../88632/index.html">How many hours a day do you sleep during the work week?</a></li>
<li><a href="../88633/index.html">Sandisk has released a 32 Gb microSDHC card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>