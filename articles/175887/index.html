<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Get rid of code repetition with DRY CRUD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Ruby on Rails framework simply fascinates me, but until recently some difficulty was the generation of CRUD controllers. 

 Almost always I needed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Get rid of code repetition with DRY CRUD</h1><div class="post__text post__text-html js-mediator-article">  The Ruby on Rails framework simply fascinates me, but until recently some difficulty was the generation of CRUD controllers. <br><br>  Almost always I needed to implement lists with sorting, filtering and pagination, and I did not find a standard way to achieve this in the rails.  I tried several options and none satisfied me: <br><ul><li>  standard generator scaffold_controller - there is nothing like that, CRUD with the simplest design </li><li>  <a href="https://github.com/ryanb/nifty-generators">nifty Scaffold</a> - its development is suspended, but still there is no filtering and sorting </li><li>  heme for <a href="http://editor.datatables.net/release/DataTables/extras/Editor/examples/REST.html">DataTable</a> - not taken root, it provides only the presentation of data, and the code for filtering and sorting would have to be written </li></ul><br>  For a long time, I couldn‚Äôt find anything similar to the CGridView widget from my Yii framework.  Already almost put up with the need to write my bike, but I came across <a href="https://github.com/codez/dry_crud">DRY CRUD</a> and I want to share my experience of using it.  Maybe it will be useful to someone, and maybe someone will tell even more suitable tool. <br><a name="habracut"></a><br><h4>  Installation </h4><br>  DRY CRUD is a gem that, using a generator, creates its own controller class in the project, after this generation, the gems can be turned off, and the code generated by them can be changed if necessary. <br>  To install, just enter the gem in the gemfile <br><pre><code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'dry_crud'</span></span>, <span class="hljs-string"><span class="hljs-string">'= 1.7.0'</span></span></code> </pre> <br>  run <br><pre> <code class="bash hljs">bundle install</code> </pre><br>  and generator <br><pre> <code class="bash hljs">rails generate dry_crud --templates haml --tests rspec</code> </pre><br><br><h4>  Demonstration of opportunities </h4><br>  As a demonstration, I created an application from two User and Post models, connected by a one-to-many relationship. <br><pre> <code class="bash hljs">rails generate model User name:string email:string pass:string rails generate model Post author_id:<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> title:string content:text is_draft:boolean</code> </pre><br>  For a more comprehensible for a person mapping, I defined the method <i>to_s</i> and I got this model code: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#user.rb class User &lt; ActiveRecord::Base attr_accessible :email, :name, :pass has_many :posts def to_s "#{name}" end end #post.rb class Post &lt; ActiveRecord::Base attr_accessible :user_id, :content, :is_draft, :title belongs_to :user def to_s "#{title}" end end</span></span></code> </pre><br>  then in the <i>/ app / controllers</i> folder it is enough to create a controller file and inherit it from <i>CrudController</i> .  You can also specify which columns provide filtering. <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#users_controller.rb class UsersController &lt; CrudController self.search_columns = [:name, :email] end</span></span></code> </pre><br>  That's all, it is not necessary even to create a folder for views, until more complex functionality is required.  We start the application and get a working CRUD with sorting (clickable columns) and filtering (if <i>self.search_columns is</i> set in the controller), and pagination can be screwed with <a href="https://github.com/codez/dry_crud">minimal effort</a> and it will be compatible with the filter and with sorting. <br><img src="http://habrastorage.org/storage2/4ee/209/e29/4ee209e29ca614078833e3e20e8ab3d9.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The editing form also did not disappoint, it defines the type of each field and uses the corresponding control for the boolean, string and text fields, as well as for the ‚Äúbelongs_to‚Äù connection: <br><img src="http://habrastorage.org/storage2/fb4/434/dbf/fb4434dbf2d8862ae45dca843892a3c1.png"><br>  and of course all this can be customized! <br><br><h5>  Twitter bootstrap connection </h5><br>  Many of my projects use Twitter bootstrap and the DRY CRUD adaptation is very simple, just connect <i>the twitter-bootstrap-rails gems</i> , set with a generator <br><pre> <code class="bash hljs">rails generate bootstrap:install less</code> </pre><br>  remove <i>app / views / layouts / crud.html.haml</i> and <i>/app/assets/stylesheets/sample.scss</i> and rewrite <i>/app/views/layouts/application.html</i> .  Who cares, can see the source of the project. <br>  As a result, we get a recognizable design: <br><img src="http://habrastorage.org/storage2/276/6e7/ba5/2766e7ba5751609e0f39db31dd1a71f0.png"><br><br><h5>  Hiding columns </h5><br>  If for example you need to hide the <i>created_at</i> and <i>updated_at columns</i> in all controllers, it is enough to change the helper of the base class. <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/helpers/list_helper.rb def default_attrs attrs = model_class.column_names.collect(&amp;:to_sym) attrs - [:id, :position, :password, :created_at, :updated_at] #&lt;   end</span></span></code> </pre><br><br><h5>  Change column set </h5><br>  Now in Users we hide the <i>pass</i> column and add the <i>created_at</i> .  To do this, you need to create a folder <i>/ app / views / users</i> copy the common partial into it <i>/app/views/crud/_form.html.haml</i> <br>  In the first and only row <code>= crud_table</code> add a list of columns that we want to see: <br><pre> <code class="ruby hljs">= crud_table <span class="hljs-symbol"><span class="hljs-symbol">:name</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:email</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span></code> </pre><br>  Result: <br><img src="http://habrastorage.org/storage2/848/6f2/2ca/8486f22ca4e8ebd93e931170fa1410fd.png"><br><br><h5>  Formatting cell contents </h5><br>  By default, the content of posts is displayed in full: <br><img src="http://habrastorage.org/storage2/8f8/8bc/faa/8f88bcfaa8d30d346ffd75f1bac50d1e.png"><br>  To make it trim up to 100 characters, it‚Äôs enough to create the format_ method in the helper. <pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/helpers/post_helper.rb module PostHelper def format_content(post) truncate(post.content, :length =&gt; 100, :omission =&gt; '...') end end</span></span></code> </pre><br>  result: <br><img src="http://habrastorage.org/storage2/511/d51/477/511d51477b0bc9fe00d50290375e1fa3.png"><br><br><h5>  Localization </h5><br>  You can change the inscriptions for the fields without changing the presentation using the capabilities of the rail L18n.  To do this, you must set the default language: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/config/application.rb .... module DryCrudSample class Application &lt; Rails::Application ... I18n.default_locale = :ru end end</span></span></code> </pre><br><br>  I used the l18n_generator gem to generate language files <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#Gemfile group :development do gem 'i18n_generators' end</span></span></code> </pre><br><br>  download the locale file from the rails-i18n repository <br><pre> <code class="bash hljs">rails generate i18n_locale ru</code> </pre><br><br>  we copy the <i>/config/locales/en_crud.yml</i> translation file generated by installing DRY CRUD into <i>ru_crud.yml</i> and translate. <br>  Generating a YAML file for our models. <br><pre> <code class="bash hljs">rails generate i18n_translation ru</code> </pre><br>  get the file <i>/config/locales/translation_ru.yml</i> which I prefer to rename to <i>ru_models.yml</i> <br>  It remains only to write the desired names for the fields of our <a href="">models.</a> <br><br>  After restarting the application, we get the localized interface: <br><img src="http://habrastorage.org/storage2/808/75b/b71/80875bb717e1ebcdeed0425ed0a74504.png"><br><br><h5>  Change behavior after editing </h5><br>  Pictures are over, a deeper adjustment begins. <br>  By default, after successfully creating or editing a record, redirect occurs to view this record (the ‚Äúshow‚Äù action) I was more accustomed to, in such a case, the redirect would occur to the ‚Äúindex‚Äù solution: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/controllers/crud_controller.rb def update(options = {}, &amp;block) assign_attributes updated = with_callbacks(:update, :save) { entry.save } #respond_with(entry, options.reverse_merge(:success =&gt; updated), &amp;block) #&lt;-  respond_with(entry, options.reverse_merge(:success =&gt; updated, :location=&gt; index_url), &amp;block) # end</span></span></code> </pre><br>  A similar replacement was needed in the <code>create</code> method. <br><br>  Then in the project, after editing the record, it was necessary to return to its own editing form.  To implement this in our Posts controller, all you need to do is override the <code>update</code> method in which you pass the desired URL: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/controllers/posts_controller.rb def update super location: edit_post_path(params[:id]) end</span></span></code> </pre><br><br><h5>  Adding buttons to the action column </h5><br>  On one of the projects, it was necessary to implement the record cloning function.  This functionality, as far as I understand, is missing by default, so I implemented it as follows.  Using the Post example, first defined a new action in the resource route: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#routes.rb resources :posts do get :clone, :on =&gt; :member end</span></span></code> </pre><br>  This action should receive the <code>id</code> copied record and display the creation form with the fields already filled in.  Submit the form to the <code>create</code> action. <br>  I placed the model cloning code in the base class: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/controllers/crud_controller.rb def duplicate_entry() set_model_ivar( find_entry.dup() ) end</span></span></code> </pre><br><br>  The button generation code is located in the helper: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/helpers/crud_helper.rb def action_col_clone(table, &amp;block) action_col(table) do |e| link_table_action('list-alt', action_path(e, &amp;block)) #       end end</span></span></code> </pre><br><br>  The code for adding a new button to a column is a place in the view: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/app/views/posts/_list.html.haml = crud_table :title, :content, :is_draft do |t| - action_col_clone t do |e| - clone_post_path e #    </span></span></code> </pre><br>  It all worked.  Only two functions have been added, and now for the whole project you can add the ‚Äúclone‚Äù button with just one line! <br><br><h4>  Conclusion </h4><br>  In fact, using the ‚Äúdeep_cloneable‚Äù heme, you can duplicate ActiveRecord along with its dependencies.  And in the form, you can edit not only the record itself, but also its related via has_many.  And to make the filter more complicated, not one textfield but several selects.  And all this is quite simple, partially described in the documentation, partially comprehended by studying the source code. <br><br>  I came to the conclusion that DRY CRUD is very flexible and powerful. <br><br>  It is a little embarrassing that in order to make some changes, you have to edit the ‚Äúsource code‚Äù, even though it is inside the project, perhaps this may complicate the use of updates from the author.  But so far I have not come across such a need, and the volume of changes is small, so that it would be a real problem. <br><br><h4>  Links </h4><br>  <a href="https://github.com/codez/dry_crud">DRY CRUD heme instructions</a> <br>  <a href="https://github.com/charger/dry_crud_sample">GitHub example source</a> </div><p>Source: <a href="https://habr.com/ru/post/175887/">https://habr.com/ru/post/175887/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175875/index.html">Application Competition on open police data</a></li>
<li><a href="../175877/index.html">Hakyll for beginners</a></li>
<li><a href="../175881/index.html">"Human" entropy for a random number generator</a></li>
<li><a href="../175883/index.html">Facebook Game On in Moscow on April 15</a></li>
<li><a href="../175885/index.html">As I once taught programming not everything</a></li>
<li><a href="../175889/index.html">Once plywood, atmega, yes raspberry</a></li>
<li><a href="../175895/index.html">Centralized configuration of the lock screen and operating system power plan</a></li>
<li><a href="../175897/index.html">FullHD Butterfly Review: HTC Butterfly</a></li>
<li><a href="../175899/index.html">Script for receiving information from remote unix-like servers</a></li>
<li><a href="../175911/index.html">Win32 / Gapz: the last episode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>