<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring Linux system calls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are an engineer in an organization that uses Linux for industrial use, I have two small questions for you. 


1. How many unique outgoing TCP c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring Linux system calls</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/be5/302/6fb/be53026fb4d54b87994d6aa6be91f9c6.png"><br><p><br>  If you are an engineer in an organization that uses Linux for industrial use, I have two small questions for you. </p><br><ol><li>  How many unique outgoing TCP connections have your servers established in the last hour? </li><li>  What processes and users initiated the installation of these connections? </li></ol><br><p>  If you are able to answer both questions, well, then you can stop reading.  And if there is no answer, <a href="https://github.com/slackhq/go-audit">go-audit</a> will help you with this information. </p><a name="habracut"></a><br><hr><br><p>  <a href="https://filippo.io/linux-syscall-table/">System calls (syscalls)</a> is a means of communication between user programs and the Linux kernel.  They are used for things like connecting network sockets, reading files, loading kernel modules, creating new processes, etc., etc. If you have ever used <em>strace</em> , <em>dtrace</em> , <em>ptrace</em> or something like that with the word <em>trace</em> in the title, the system calls you are no longer new. </p><br><p>  Most people use the mentioned <em>trace-</em> tools to debug isolated individual cases, while in Slack we collect system calls as a source of data for continuous monitoring, which we advise you. </p><br><hr><br><p>  <a href="https://people.redhat.com/sgrubb/audit/">Linux Audit has</a> been added to the kernel since version 2.6. (14?).  The audit system consists of two main components: a kernel code for monitoring system calls and a daemon that logs the events associated with these calls. </p><br><p><img src="https://habrastorage.org/files/7e2/7cb/5b3/7e27cb5b3e234c86bd67308c562c1f96.png">  <em>Kauditd</em> and <em>go-audit</em> architecture </p><br><p> Let's look at an example of using <em>auditd</em> .  Suppose we want to log events to read the file <em>/data/topsecret.data</em> .  ( <em>Please do not store sensitive information in a file called topsecret.data</em> ).  When using <em>auditd,</em> you must first inform the kernel about our desire to receive information about events of interest.  This is done using the <code>auditctl</code> , which runs as the superuser: </p><br><pre> <code class="bash hljs">auditctl -w /data/topsecret.data -p rwxa</code> </pre> <br><p>  Now the kernel will generate an event every time someone gets access to <code>/data/topsecret.data</code> (including via <em>symlink</em> ).  This event is sent to a process in user space (usually <em>auditd</em> ) via something called a <em>netlink</em> socket.  ( <em>In other words,</em> netlink <em>is when you tell the kernel to send messages to a process using its PID on the corresponding socket.</em> ) </p><br><p>  In most Linux distributions, the user-space process <em>auditd</em> writes data to <code>/var/log/audit/audit.log</code> .  If there is no connected network process connected to the <em>netlink</em> socket, messages will appear in the console and can be viewed using <code>dmesg</code> . </p><br><p>  All this is great, but observing a single file is too simple an example.  Let's take something more interesting, something related to the network. </p><br><p>  Daemons ( <em>and even a poor netcat</em> ) usually use the <code>listen</code> system call to arrange for incoming network connections.  For example, if Apache wants to listen to port 80, it sends the corresponding request to the kernel.  To log these events, we again inform the kernel about our intentions using <code>auditctl</code> : </p><br><pre> <code class="bash hljs">auditctl -a <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>,always -S listen</code> </pre> <br><p>  Now, <em>every</em> time the process starts listening on any socket, we get the corresponding message.  Great!  Such logging can be configured to any system call.  To solve the questions indicated at the beginning of this article, we need <code>connect</code> .  To organize the monitoring of each new process and team, you can use <code>execve</code> . </p><br><p>  <em>Supermarking.</em>  <em>We are not limited to user actions.</em>  <em>Think about such interesting events as running Apache <code>bash</code> or creating an outgoing connection to some incomprehensible IP address, and what these actions can mean.</em> </p><br><hr><br><p>  So now we have a number of events in <code>/var/log/audit/audit.log</code> , but the log files are not yet a monitoring system.  What do we do with all the data we collect?  Unfortunately, the <em>auditd</em> log <em>format</em> has features that make it difficult to handle. </p><br><ol><li>  The data format is mainly represented as ‚Äúkey = value‚Äù. </li><li>  An event can span one or more lines. </li><li>  Events can intertwine and appear out of order. </li></ol><br><p><img src="https://habrastorage.org/files/2e8/ca8/691/2e8ca8691d994f0b9fc18d823455b7ae.png">  Sample <em>auditd</em> output </p><br><p>  There are several tools for handling log events (for example, <code>aureport</code> and <code>ausearch</code> ), but they seem to focus on investigating an already happened event, rather than on constant monitoring. </p><br><hr><br><p>  We have seen a lot of usefulness options from <em>auditd</em> data.  But it was necessary to think of a way to scale such a monitoring system.  As a result, as a replacement for the user-space <em>auditd</em> part, we decided to create a <a href="https://github.com/slackhq/go-audit">go-audit</a> .  Here are the goals that we focused on: </p><br><ol><li>  Convert multi-line <em>auditd</em> events into one JSON-blob. </li><li>  Communicating with the kernel directly using netlink. </li><li>  High performance. </li><li>  Minimization (or complete exclusion) of filtering events on the observed nodes. </li></ol><br><p>  The first three conditions are most likely obvious and understandable, and the latter requires clarification. </p><br><hr><br><p>  Here are two main questions that we must answer when discussing the fourth paragraph: </p><br><ul><li>  <em>Why don't you want to filter events on every server?</em> </li><li>  <em>Will you forward a lot of extra information?</em> </li></ul><br><p>  Imagine that <code>curl</code> installed on your servers ( <em>probably the way it is</em> ).  During the next exercise, a comrade from the ‚Äúred team‚Äù (red team) uses <code>curl</code> to load the rootkit and then to upload the data.  After receiving this lesson, you start logging each command and filtering everything except <code>curl</code> , at the start of which an alarm is raised every time. </p><br><p>  There are several problems with this approach. </p><br><ol><li>  There are about 92,481,124.5 ways to download a rootkit and unload data without using <code>curl</code> .  We can‚Äôt even list them. </li><li>  A cracker might look at your <em>auditd</em> rules and notice that you are following <code>curl</code> . </li><li>  There are legitimate uses for <code>curl</code> . </li></ol><br><p>  We need something better ... </p><br><p>  Instead of sending all the data to a centralized logging and alert system, instead of filtering specific teams in the field?  This approach has several surprisingly useful properties. </p><br><ol><li>  The hacker does not know which system calls you are interested in.  ( <em>And as aptly noticed by <a href="https://twitter.com/mubix">Rob Fuller</a> , invisible traps cause nightmares for hackers.</em> ) </li><li>  We can analyze the interrelation of various events in order to understand when the execution of <code>curl</code> is completely legal and when not. </li><li>  New rules can be evaluated and tested on archived data. </li><li>  Now we have an external independent repository of forensic information. </li></ol><br><hr><br><p>  So, friends, welcome - <a href="https://github.com/slackhq/go-audit">go-audit</a> .  We release this tool as open source software.  It can be used freely and completely free of charge.  The guys from our Secops team created the first version of the <em>go-audit</em> more than a year ago, and we use it in commercial operation almost as much.  This is a small but very important element of our monitoring infrastructure.  <a href="https://slack.engineering/distributed-security-alerting-c89414c992d6">I recommend to look at my previous article about our approach to working with alerting (alerting).</a> </p><br><p>  The <em>go-audit</em> repository contains many <a href="https://github.com/slackhq/go-audit/tree/master/examples">examples</a> of configuration and data collection.  Here in Slack, we use <em>rsyslog</em> + <em>relp</em> , because we want to remove data from the server as soon as possible, but still be able to write events to disk if <em>syslog is</em> temporarily unable to transmit them over the network.  We could easily switch to another log-delivery mechanism and we will be glad to hear your ideas. </p><br><p>  We invite new members to the project and hope that the <em>go-audit</em> will be useful not only for us.  During the year, this repository was opened to a certain number of people outside Slack, and some of our friends already use it in commercial operation. </p><br><hr><br><p>  You may have noticed that the word ‚Äúsecurity‚Äù has never been encountered in this article.  Let's discuss this.  I believe that many general-purpose tools can often be used to provide security, but the opposite is usually not true.  <em>Auditd</em> provides security monitoring data in such a way that it is difficult to use it in any other way, and the <em>go-audit</em> was designed as a general-purpose tool.  Its usefulness is immediately apparent to service engineers and developers, who can use a <em>go-audit</em> to solve problems on a whole variety of modern, including very large systems. </p><br><p>  Let's return to the questions posed at the beginning of the article.  Any company with IDS / IPS / Netflow / PCAP, etc. on the network gateway can say a lot about its network connections and, perhaps, answer the first question.  But none of these solutions will provide the context in the form of <em>user / pid / command</em> , necessary to answer the second question.  And it is precisely the difference between ‚Äúsomeone launched something somewhere in our network, and it connected to such IP‚Äù and ‚ÄúMallory launched <em>curl</em> as <em>root</em> on <em>bigserver01</em> and connected to 1.2.3.4, port 1337 ". </p><br><p>  In Slack, we often say: "Do not let the best become the enemy of the good."  <em>Go-audit is</em> not perfect, but we believe that this tool is really very good, and we are glad to share it with you. </p><br><hr><br><h4 id="faq">  FAQ: </h4><br><h5 id="pochemu-auditd-a-ne-sysdig-ili-osquery">  Why auditd, but not sysdig or osquery? </h5><br><p>  <em>Osquery</em> is a great tool.  In fact, in Slack, we also use it.  But for combat servers, we prefer <em>go-audit</em> .  The reason is that these systems operate 24/7, and we need to constantly transfer data.  With <em>osquery,</em> we get a snapshot of the current state of the machine.  If something has completed execution in the interval between polls, there is every chance to skip it.  I think this model is good for laptops and other user devices, but for high-availability systems I prefer to transmit data in a continuous stream. </p><br><p>  <em>Sysdig is</em> also a great debugging tool, and I used it quite actively.  The main problem is that it requires a kernel module on each machine.  <em>Sysdig Falco</em> seems useful, but they prefer to filter events at each monitoring site.  And, as mentioned above, it is more interesting for us to keep the rules centrally, out of reach of the hacker who has gained access to the system. </p><br><p>  <em>Auditd</em> is good because it has been <em>around</em> for a long time and is part of the main kernel.  This is the most common mechanism for auditing system calls in the Linux world.  That's why we chose it. </p><br><h5 id="chto-nam-delat-so-vsemi-etimi-signalami-trevogi">  What do we do with all these alarms? </h5><br><p>  They are sent to the Elasticsearch cluster.  There, we use <a href="https://github.com/Yelp/elastalert">ElastAlert</a> to generate alarms based on the analysis of constantly incoming data and for general monitoring.  You can also look at other popular journaling systems that can work with large amounts of data, but ( <em>my personal opinion does not have to coincide with the opinion of my employer</em> ) <em>I have fundamental problems with the monetary valuation of structures that encourage less data to be recorded in journals in order to save finances .</em> </p><br><h5 id="o-zhurnalah-kakogo-razmera-idet-rech">  What size magazines are we talking about? </h5><br><p>  The short answer is: the value can vary within very wide limits. </p><br><p>  Long answer: depends on which system calls log and how many servers will do it.  We write hundreds of gigabytes per day.  It seems to be a lot, but at the moment we have constantly logged events from 5500 cars.  You should also consider allocating additional resources to the cluster to repel attacks such as DoS. </p><br><h5 id="pochemu-rsyslog">  Why rsyslog? </h5><br><p>  We have considerable experience with <em>rsyslog</em> , which has several useful features.  We strongly recommend using version 8.20+, where we fixed a few bugs.  We had the opportunity to entrust the execution of message delivery and the <em>go-audit itself</em> , but the benefits of this approach did not outweigh the benefits of using a tool that has been serving us regularly for several years. </p><br><h5 id="blagodarnosti">  Thanks </h5><br><ul><li>  My colleague <a href="https://twitter.com/nbrownus">Nate Brown</a> , who did a <em>go-audit is</em> much better. </li><li>  The <a href="https://github.com/mozilla/audit-go">audit-go</a> guys from Mozilla for inspiring us to this project. </li><li>  A lot of people have read this article and have written helpful reviews. </li><li>  <a href="http://cubs.com/">Chicago Cubs</a> for winning the championship. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/316902/">https://habr.com/ru/post/316902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316886/index.html">PIN cards of bank cards. How modern technology replaces paper mail</a></li>
<li><a href="../316888/index.html">What is more profitable to open to the developer: IP or LLC? Small Check Sheet</a></li>
<li><a href="../316890/index.html">Domain-Driven Design: tactical design. Part 2</a></li>
<li><a href="../316894/index.html">5 best books novice entrepreneur + 1 advice</a></li>
<li><a href="../316898/index.html">Monitoring driven operation</a></li>
<li><a href="../316906/index.html">Observations that indicate an enterprise‚Äôs determination to change</a></li>
<li><a href="../316908/index.html">Drunk database: as at 1 base, we made 7 test pads, each with its own increment and diff</a></li>
<li><a href="../316910/index.html">Indoor navigation - first steps with indoo.rs NavigationSDK</a></li>
<li><a href="../316912/index.html">How the Skype vulnerability repaired</a></li>
<li><a href="../316914/index.html">The book "Microsoft Visual C #. Detailed guide. 8th edition "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>