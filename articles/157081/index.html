<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vreen is a simple and convenient library for working with vk.api</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to you a new Qt library for working with vk api, which can be useful to you when creating any desktop and mobile applications that interact ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vreen is a simple and convenient library for working with vk.api</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/840/938/27c/84093827c70d58193ad9fa034805fe19.png" align="right"><br>  I present to you a new Qt library for working with vk api, which can be useful to you when creating any desktop and mobile applications that interact with vk.  The project was born from the vkontakte plugin for qutIM and has grown into a separate independent library, which everyone can now use. <br><a name="habracut"></a><br><br><h4>  Short review </h4><br><br>  Vreen is a wrapper over vk.com api, written in C ++ 11 / Qt, designed for quick and easy creation of mobile and desktop applications, as well as embedding interaction with vk.com api into existing applications.  The library supports several authorization methods and allows you to add your own if necessary.  Also in vreen there is a full binding to qml, which allows you to create applications without writing a single line in C ++.  To reduce the number of required dependencies, all authorization methods are moved to separate static libraries. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Key features: </h5><br><ol><li>  Support any kind of dialogue including group chats. </li><li>  Support viewing news feeds, walls. </li><li>  Work with comments, including uploads, likes and reposts. </li><li>  Support work with attachments. </li><li>  Support roster including tracking the status of interlocutors. </li><li>  Audio support. </li><li>  The ability to directly work with the API from qml in the usual for many XHTTPRequest style. </li><li>  Extensibility </li><li>  A free LGPL license allowing use of a library with proprietary applications. </li></ol><br><br><h5>  Basics: </h5><br>  Base classes for working with API: <br><ul><li>  Connection is a class based on QNetworkAccessManager that performs authorization and directly implements API requests. </li><li>  Reply - the class tracks the execution of the request. </li><li>  Longpoll is a class that polls the server for events. </li><li>  Roster is a class that manages the list of friends. </li><li>  Client is a base class that stitches everything together. </li></ul><br>  Performing API requests: <br>  Simple request: <br><pre><code class="cpp hljs">QVariantMap args; args.insert(<span class="hljs-string"><span class="hljs-string">"uids"</span></span>, join(ids)); args.insert(<span class="hljs-string"><span class="hljs-string">"fields"</span></span>, fields.join(<span class="hljs-string"><span class="hljs-string">","</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> reply = d-&gt;client-&gt;request(<span class="hljs-string"><span class="hljs-string">"users.get"</span></span>, args); reply-&gt;connect(reply, SIGNAL(resultReady(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariant&amp;)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(_q_friends_received(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariant&amp;)));</code> </pre> <br>  The resultReady signal is thrown if the request is completed and in response contains a response from a server converted to QVariant json or nothing in case of an error, the error code in this case is contained in reply-&gt; error () <br>  In addition, you can hide the result processing from the recipient by adding a result handler function to the reply; in this case, the result can be obtained by calling the reply-&gt; result () method, the result will be returned in the form of a QVariant, so you will need to add more convert using QVariant :: fromValue. <br><pre> <code class="cpp hljs"> QVariantMap args; <span class="hljs-comment"><span class="hljs-comment">//TODO add chat messages support and contact check args.insert("uid", message.toId()); args.insert("message", message.body()); args.insert("title", message.subject()); return request ("messages.send", args, [](const QVariant &amp;response) -&gt; QVariant { return response.toInt(); });</span></span></code> </pre><br>  In order to clearly indicate the type of return value, you can use the following template magic: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> ReplyBase&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; SendMessageReply; QVariantMap args; <span class="hljs-comment"><span class="hljs-comment">//TODO add chat messages support and contact check args.insert("uid", message.toId()); args.insert("message", message.body()); args.insert("title", message.subject()); return request&lt;SendMessageReply&gt; ("messages.send", args, [](const QVariant &amp;response) -&gt; QVariant { return response.toInt(); });</span></span></code> </pre><br>  As a result, in the slot, SendMessageReply :: result () will return an int instead of QVariant. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> reply = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Vreen::SendMessageReply*&gt;(sender()); m_unreachedMessagesCount--; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = reply-&gt;result();</code> </pre><br>  In general, all interaction with the API is simple and transparent. <br><br><h4>  Receiving and assembling </h4><br>  Vreen uses submodules and therefore the most optimal way to get the source is. <br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://github.com/gorthauer/vreen.git $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> vreen $ git submodule update --init</code> </pre><br>  The build requires cmake 2.8, Qt 4.7.4, and any compiler with basic C ++ 11 support (gcc 4.4+, clang 3.0+, msvc2010 +). <br>  The assembly itself is quite trivial: <br><pre> <code class="bash hljs">$ mkdir build $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build $ cmake .. -DCMAKE_INSTALL_PREFIX=/usr $ make $ make install (sudo)</code> </pre><br>  If you have questions regarding the build release or debug version, it‚Äôs best to simply refer to the cmake documentation.  As an experimental option, build with qbs is supported.  It is possible to build a library with qmake ', but this method is not officially supported. <br><br><h4>  Use in C ++ project </h4><br><h5>  Connection </h5><br>  To connect to other projects in Vreen, pkg-config is used, so to connect vreen with the standard authorization method through a browser, it is enough to add a line to the pro file. <br><pre> <code class="bash hljs">CONFIG += link_pkgconfig PKGCONFIG += vreen \ vreenoauth</code> </pre><br>  In the case of systems that do not support pkgconfig, you can either manually add LIBS and INCLUDEPATH or write a find script for cmake or qbs. <br>  Those interested can help me write a prf file for Qt. <br><br><h5>  Using </h5><br>  Let's write as an example a small console application that will pull out all the phone numbers from the list of friends. <br><br>  To begin with, we simply initialize the client, indicating to it the connection method, application identifier, and also ask it to independently create a window with permission for access from the application to the api. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vreen::OAuthConnection(<span class="hljs-number"><span class="hljs-number">3220807</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  clientId   auth-&gt;setConnectionOption(Vreen::Connection::ShowAuthDialog, true); //     . auth-&gt;setConnectionOption(Vreen::Connection::KeepAuthData, true); //     setConnection(auth); connect(this, SIGNAL(onlineStateChanged(bool)), SLOT(onOnlineChanged(bool))); connect(roster(), SIGNAL(syncFinished(bool)), SLOT(onSynced(bool)));</span></span></code> </pre><br>  After the client successfully connects to the api, the onOnlineChanged slot will be called in which we will request a list of friends from the roster.  When prompted, you can select the fields you want to receive.  There are several macros with the most common VK_COMMON_FIELDS, VK_EXTENDED_FIELDS and VK_ALL_FIELDS options for all known fields. <br>  The description of the fields and the resulting properties can be read <a href="https://vk.com/developers.php%3Foid%3D-1%26p%3Dfriends.get">here</a> u. <br>  In this case, we are only interested in three fields and there is no need to strain the server with more difficult requests. <br><pre> <code class="cpp hljs"> roster()-&gt;sync(QStringList() &lt;&lt; QLatin1String(<span class="hljs-string"><span class="hljs-string">"first_name"</span></span>) &lt;&lt; QLatin1String(<span class="hljs-string"><span class="hljs-string">"last_name"</span></span>) &lt;&lt; QLatin1String(<span class="hljs-string"><span class="hljs-string">"contacts"</span></span>));</code> </pre><br>  After successful completion of the synchronization of the roster, simply display the result: <br><pre> <code class="cpp hljs"> qDebug() &lt;&lt; tr(<span class="hljs-string"><span class="hljs-string">"-- %1 contacts recieved"</span></span>).arg(roster()-&gt;buddies().count()); foreach (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> buddy, roster()-&gt;buddies()) { QString homeNumber = buddy-&gt;property(<span class="hljs-string"><span class="hljs-string">"_q_home_phone"</span></span>).toString(); QString mobileNumber = buddy-&gt;property(<span class="hljs-string"><span class="hljs-string">"_q_mobile_phone"</span></span>).toString(); qDebug() &lt;&lt; tr(<span class="hljs-string"><span class="hljs-string">"name: %1, home: %2, mobile: %3"</span></span>).arg(buddy-&gt;name()) .arg(homeNumber.isEmpty() ? tr(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>) : homeNumber) .arg(mobileNumber.isEmpty() ? tr(<span class="hljs-string"><span class="hljs-string">"unknown"</span></span>) : mobileNumber); }</code> </pre><br>  All properties that have not yet been implemented properly for contacts will have the _q_ prefix, the rest can be obtained via getters or through the names specified in Q_PROPERTY. <br><br>  As a second example, try using qml api and get a list of friends. <br>  We import the support of Vreen into qml: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.vk.api <span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre><br>  And create a client: <br><pre> <code class="javascript hljs"> Client { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: client connection: conn <span class="hljs-comment"><span class="hljs-comment">//        C++   } OAuthConnection { id: conn Component.onCompleted: { //        ,      photoview' setConnectionOption(Connection.ShowAuthDialog, true); setConnectionOption(Connection.KeepAuthData, true); } clientId: 3220807 displayType: OAuthConnection.Popup //        }</span></span></code> </pre><br>  We will simply connect via client.connectToHost, in the confirmation window that appears, you will be able to enter your login and password, so you can not create separate fields for input, but confine ourselves to an extremely concise invitation. <br><img src="http://habrastorage.org/storage2/73b/1b3/1f0/73b1b31f05babb07fce656ca98b53a22.png"><br>  To display a list of dialogs, you can use the finished model from com.vk.api 1.0: <br><pre> <code class="javascript hljs"> DialogsModel { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: dialogsModel client: client }</code> </pre><br>  To get the list of the last conversations, it is rather easy to request the list after connecting: <br><pre> <code class="javascript hljs"> Connections { <span class="hljs-attr"><span class="hljs-attr">target</span></span>: client onOnlineChanged: { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.online) { client.roster.sync(); dialogsModel.getDialogs(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    15, //  160 //   ); } } }</span></span></code> </pre><br>  The properties of the model available to the delegate can be seen in the code for its implementation: <br><pre> <code class="javascript hljs"> roles[SubjectRole] = <span class="hljs-string"><span class="hljs-string">"subject"</span></span>; roles[BodyRole] = <span class="hljs-string"><span class="hljs-string">"body"</span></span>; roles[FromRole] = <span class="hljs-string"><span class="hljs-string">"from"</span></span>; roles[ToRole] = <span class="hljs-string"><span class="hljs-string">"to"</span></span>; roles[ReadStateRole] = <span class="hljs-string"><span class="hljs-string">"unread"</span></span>; roles[DirectionRole] = <span class="hljs-string"><span class="hljs-string">"incoming"</span></span>; roles[DateRole] = <span class="hljs-string"><span class="hljs-string">"date"</span></span>; roles[IdRole] = <span class="hljs-string"><span class="hljs-string">"mid"</span></span>; roles[AttachmentRole] = <span class="hljs-string"><span class="hljs-string">"attachments"</span></span>; roles[ChatIdRole] = <span class="hljs-string"><span class="hljs-string">"chatId"</span></span>;</code> </pre><br>  Using these fields you can get a quite neat looking list of dialogs: <br><img src="http://habrastorage.org/storage2/b14/58c/1fb/b1458c1fbccd6b29300ac611ec16746f.png"><br><br>  Similarly, create a photo album: <br><img src="http://habrastorage.org/storage2/e2b/6fc/5ca/e2b6fc5cac48f47e7b88809efd9bd474.png"><br>  And I would like to note that in the case of creating a photo album, we work through qml directly with vk.api <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ownerId, count, offset</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!offset) offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!count) count = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> args = { <span class="hljs-string"><span class="hljs-string">"owner_id"</span></span> : ownerId, <span class="hljs-string"><span class="hljs-string">"offset"</span></span> : offset, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : count, <span class="hljs-string"><span class="hljs-string">"extended"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reply = client.request(<span class="hljs-string"><span class="hljs-string">"photos.getAll"</span></span>, args) reply.resultReady.connect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count = response.shift() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> response) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> photo = response[index] model.append(photo) } }) }</code> </pre><br>  It turns out very briefly and concisely. <br><br><h4>  Conclusion </h4><br>  The current version of vreen is 0.9.5, that is, in fact, it is almost a release, which means that the API for the most part will no longer change and binary compatibility between versions will be maintained, which means you can already safely join the use and testing in real conditions. <br>  At the moment, API support is still very incomplete, but the writing of wrappers over it is simplified as much as possible, so that I will be happy with all the patches with the implementation of various features. <br>  For other questions, ready to answer in a personal or jabber'e, which can be found in the profile. <br>  <a href="https://github.com/gorthauer/vreen">Fork me with github</a> . </div><p>Source: <a href="https://habr.com/ru/post/157081/">https://habr.com/ru/post/157081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157067/index.html">Internet math from Yandex</a></li>
<li><a href="../157069/index.html">Review of the Soviet electromechanical gaming machine "Torpedo attack"</a></li>
<li><a href="../157071/index.html">The best ways to hide a password during registration</a></li>
<li><a href="../157077/index.html">Review of fresh materials, July-September 2012</a></li>
<li><a href="../157079/index.html">Unmanned vehicle tried to overtake professional racer</a></li>
<li><a href="../157083/index.html">Teaching without a teacher in an African village</a></li>
<li><a href="../157085/index.html">TechCrunch: Crunchies Awards 2012 has started. We nominate Russian projects!</a></li>
<li><a href="../157087/index.html">Introduction to SVG graphics</a></li>
<li><a href="../157089/index.html">The tale of Skype, free-speech, Ballmer and Stallman</a></li>
<li><a href="../157093/index.html">Fuel UX - Twitter controls Bootstrap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>