<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The practice of using digital filters</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am doing a project here and there is this problem. I get data from the ADC (delta-sigma) chip in which the controller and the filter are built in, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The practice of using digital filters</h1><div class="post__text post__text-html js-mediator-article">  I am doing a project here and there is this problem.  I get data from the ADC (delta-sigma) chip in which the controller and the filter are built in, but this filter has a rather poor frequency response, as a result there is a dam on HF from 60Hz and beyond.  It looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/e2b/2ee/122/e2b2ee122c31eaae48b77b148d12e79e.jpg" alt="image"><br><br>  Those.  This uneven frequency response clearly does not suit us (does not pass on technical requirements), although it is possible to increase the sampling rate from 250Hz to 500Hz to even out the frequency response, but then the amount of data that still needs to be averaged increases, which will affect the performance (project on STM32F103VE) systems in general and on total energy consumption (battery power).  But there is another way. <br><a name="habracut"></a><br>  You can align the frequency response using a parametric digital filter, in this case, the RF.  That is, this is the same as the equalizer, we raise some frequencies, while others do not touch (or fill up).  This method is certainly good, but because  we are trying to recover information, part of which was destroyed by another input filter (the one on the chip), will inevitably increase the level of interference at high frequencies, because  together with the signal we will strengthen them too, but how much? <br><br>  So, the idea of ‚Äã‚Äãsolving the problem is, there is implementation.  What do we remember about digital filters (for those who did not have any practice with them) from the university course?  Is that such words as convolution, Z-transform, impulse response, etc.  In general, it‚Äôs not clear from which end to even come up, it‚Äôs necessary to count some factors, but what‚Äôs not clear and why, you‚Äôll have to raise the course and sit with books on DSP (there is one 800 pages), the project is worth it and you need to do something , and fast. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, a little googling find such a resource on the <a href="http://www-users.cs.york.ac.uk/~fisher/mkfilter/trad.html">Internet.</a>  This is a site for calculating digital filters (and not only!) Online, but it was made by a certain Dr Anthony J. Fisher. <br><br>  So we ask the requirements that we need and enter on the site.  Firstly, we need a smooth characteristic, so the first-order Butterworth is clearly a highpass.  Secondly, sample rate, i.e.  the number of ADC conversions per second, or sampling rate, we have is 250 Hz.  We enter.  And finally, thirdly, the cut-off frequency (-3dB) is 50 Hz, because  The inlet filter cuts around here.  Click send and get this characteristic of our future filter: <br><img src="https://habrastorage.org/getpro/habr/post_images/eb6/175/094/eb61750945892f026bf0b7e75582903b.png" alt="image"><br>  The red graph shows the amplitude versus Nyquist frequency, the blue phase change.  0.5 corresponds to half the sampling rate. <br><br>  We also get a C code with calculated coefficients: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NZEROS 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NPOLES 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GAIN 1.726542528e+00 static float xv[NZEROS+1], yv[NPOLES+1]; static void filterloop() { for (;;) { xv[0] = xv[1]; xv[1] = next input value / GAIN; yv[0] = yv[1]; yv[1] = (xv[1] - xv[0]) + ( 0.1583844403 * yv[0]); next output value = yv[1]; } }</span></span></code> </pre> <br>  But this is only a filter, remember that we need to increase the frequencies from 50Hz and higher to straighten the frequency response, and this function in this form does not help us, therefore, by simple manipulations, we bring the function to this form: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NZEROS 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NPOLES 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GAIN 1.726542528e+00F #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OUR_GAIN 2.1F </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  .   float xv[NZEROS+1], yv[NPOLES+1]; int void filterloop( int data ) { xv[0] = xv[1]; xv[1] = (float)data / GAIN; yv[0] = yv[1]; yv[1] = ( xv[1] - xv[0] ) + ( 0.1583844403F * yv[0] ); return (int)(( yv0[1] * OUR_GAIN ) + (float)data ); }</span></span></span></span></code> </pre> <br><br>  Everything.  To use the filter, we throw data into the function parameters, and it returns the filtered data.  Gain OUR_GAIN select empirically, taking readings from the ADC and measuring the frequency response. <br><br>  Thus, I managed to raise the frequency response with almost no additional load on the controller and my project went through technical requirements (in the medical field, they are not quite frail).  I was afraid that the level of interference would increase greatly, but it increased from 4-5¬µV to about 6-8¬µV, which suits us.  In conclusion, I can recommend another free program for calculating digital filters - WinFilter, you can download it <a href="http://www.winfilter.20m.com/">here</a> .  I don‚Äôt know how efficient it is, I didn‚Äôt check it, but it can issue a code in VHDL (and in C naturally), which is probably useful for FPGAs.  There is also a program from Texas Instuments, according to the calculation of the coefficients of digital filters, it is called <a href="http://www.ti.com/tool/coefficient-calc">TIBQ</a> .  Everything.  Good luck in designing digital filters. <br><br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/148326/">https://habr.com/ru/post/148326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148318/index.html">Auto-Renewable Subscription in iOS: proper implementation and pitfalls</a></li>
<li><a href="../148319/index.html">Recognition of numbers by 4 points</a></li>
<li><a href="../148323/index.html">Bot for browser Angry Pets</a></li>
<li><a href="../148324/index.html">Sublime Text 2: How to create a snippet?</a></li>
<li><a href="../148325/index.html">Computational geometry, or how I became involved in Olympiad programming. Part 2</a></li>
<li><a href="../148327/index.html">‚ÄúDiv‚Äù blocks of the same height</a></li>
<li><a href="../148329/index.html">What have you spent your best karma on?</a></li>
<li><a href="../148331/index.html">Remote wipe on Android and Exchange ActiveSync</a></li>
<li><a href="../148332/index.html">Create a feedback form using Google Forms</a></li>
<li><a href="../148334/index.html">Black screen internet. An example of a minimal useful web application.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>