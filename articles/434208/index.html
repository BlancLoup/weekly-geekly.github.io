<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Go saved our ‚ÄúBlack Friday‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier, we already talked about the fact that as the load grows, we gradually abandoned the use of Python in the back end of critical services in pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Go saved our ‚ÄúBlack Friday‚Äù</h1><div class="post__text post__text-html js-mediator-article">  Earlier, we already talked about the fact that as the load grows, we gradually abandoned the use of Python in the back end of critical services in production, replacing it with Go.  And today, I, Denis Girko, the team leader of the Madmin development team, want to share the details: how and why this happened on the example of one of the most important services for our business - price calculation taking into account discounts on coupons. <br><br><img src="https://habrastorage.org/webt/8q/bo/y4/8qboy4stjrxnm432zasibweeyqe.jpeg"><br><a name="habracut"></a><br>  The mechanics of working with coupons are probably presented by anyone who has made purchases at online stores at least once.  On a special page or directly in the basket you enter the coupon number, and the prices are recalculated in accordance with the promised discount.  The calculation depends on what kind of coupon it provides - as a percentage, in the form of a fixed amount or using some other mathematics (for example, loyalty program points, store promotions, types of goods, etc., are additionally taken into account).  Naturally, the order is issued with new prices. <br><br>  Business is delighted with all these mechanisms of working with prices, but we want to talk about the service from a slightly different point of view. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How it works </h2><br>  For the calculation of prices, taking into account all these difficulties on the back end, we now have a separate service.  However, it was not always independent.  The service appeared a year or two after the start of the online store, and by 2016 it was part of a large monolith in Python, which included a variety of components for marketing activity (Madmin).  In an independent ‚Äúblock‚Äù, he stood out later, as he moved towards the microservice architecture. <br><br>  As is usually the case with monoliths, Madmin was modified and partially corresponded by a large number of developers.  There were integrated third-party libraries, which simplified development, but often not in the best way affected performance.  However, at that time we didn‚Äôt really care about the resistance to heavy loads during sales, because the service did an excellent job with the task.  But 2016 has changed everything. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e40/3a3/3e1/e403a33e16fea41905491776c8b0c26e.jpg"><br><br>  In the USA, ‚ÄúBlack Friday‚Äù has been known since the 60s of the last century.  In Russia, it began to be launched in the 2010s, while the action had to actually be created from scratch - the market was not quite ready for it.  However, the efforts of the organizers were not in vain, and with each passing year the user traffic to our website increased during sales.  Therefore, our collision with a load that was beyond the power of that version of the pricing service was only a matter of time. <br><br><h2>  "Black Friday" 2016. And we overslept her </h2><br>  Since the idea of ‚Äã‚Äãsales has earned its full potential, ‚Äúblack Friday‚Äù differs from any other day of the year in that by about midnight the weekly audience of the site arrives at the store.  This is a difficult period for all services.  Even in those of them that function smoothly throughout the year, problems sometimes come out. <br><br>  Now we are preparing for each new ‚ÄúBlack Friday‚Äù, imitating the expected load, but in 2016 we still acted differently.  Testing Madmin before an important day, we tested the resistance to stress using scenarios of user behavior on ordinary days.  As it turned out, this test does not quite reflect the real situation, since on ‚ÄúBlack Friday‚Äù comes a lot of people with the same coupon.  As a result, the pricing service with this discount, unable to cope with the threefold (as compared to ordinary days) load, at the hottest peak of the sale, blocked our ability to serve customers for two hours. <br><br>  Service "lay down" an hour before midnight.  It all started with a disconnection of the connection to the database (at that time, MySQL), after which not all running copies of the pricing service were able to connect back.  And those that are still connected, could not stand the incoming load and stopped responding to requests, stuck on the base locks. <br><br>  By coincidence, a junior remained on duty, who was on the way home from the office at the time of the fall of the service.  He was able to connect to the problem only by arriving at the site and calling in "heavy artillery" - the reserve duty officer.  Together, they normalized the situation, but only after two hours. <br><br>  As the proceedings began to open details about how far the service was not optimal.  For example, it turned out that for the calculation of one coupon 28 requests were made to the database (not surprisingly, everything worked with a 100% CPU load).  The above-mentioned users with the same coupon of ‚ÄúBlack Friday‚Äù did not simplify the situation, especially then for all the coupons we had a counter of applications - so each use increased the load by referring to this counter. <br><br>  2016 gave us a lot of food for thought - mainly about how to adjust our work with coupons and tests so that this situation does not happen again.  And in numbers, that Friday is best described by this picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75e/310/1fc/75e3101fca74fc4e8b220673619eaada.jpg"><br>  <i>Results Black Friday 2016</i> <br><br><h2>  ‚ÄúBlack Friday‚Äù 2017. We were preparing seriously, but ... </h2><br>  Having received a good lesson, we prepared for the next ‚ÄúBlack Friday‚Äù in advance, seriously rebuilding and optimizing the service.  For example, we finally created two types of coupons: limit and unlimited - to avoid blocking on simultaneous access to the database, we removed the entry into the database from the scenario of using the popular coupon.  In parallel, 1‚Äì2 months before ‚ÄúBlack Friday‚Äù, we switched from MySQL to PostgreSQL in service, which, together with code optimization, reduced the number of calls to the database from 28 to 4‚Äì5. These improvements made it possible for the service to reach SLA requirements ‚Äî answer 3 seconds at 95 percentile at 600 RPS. <br><br>  Having no idea how much our improvements have accelerated the work of the old version of the production service, at that time two versions of the Python code were being prepared for Black Friday ‚Äî a highly optimized existing version and a completely new code written from scratch.  In production, they rolled out the second one, which they had been testing before and on nights and nights.  However, as it turned out already ‚Äúin battle‚Äù, they were slightly untested. <br><br>  On the day of "emergency" with the advent of the main stream of customers, the load on the service began to grow exponentially.  Some requests were processed up to two minutes.  Due to the long processing of some requests, the load on other workers increased. <br><br>  Our main task was to handle such valuable business traffic.  But it became obvious that ‚Äúthrowing with iron‚Äù does not solve the problem and from minute to minute the number of busy workers will reach 100%.  Not knowing exactly what we were facing, we decided to activate harakiri in uWSGI and just nail down long requests (which are processed for more than 6 seconds) in order to free up resources for normal ones.  And it really helped to resist - the workers began to be freed literally a couple of minutes before they were completely exhausted. <br><br>  A little later, we figured out the situation ... It turned out that these were requests with very large baskets - from 40 to 100 products - and with a specific coupon that has restrictions on the range.  This situation was poorly handled by the new code.  It found incorrect work with an array, which turned into infinite recursion.  It is curious that we then tested the case with large baskets, but not in combination with a clever coupon.  As a solution, we simply switched to a different version of the code.  True, it happened about three hours before the end of ‚ÄúBlack Friday‚Äù.  From this point on, all baskets began to be processed correctly.  And although we had fulfilled the sales plan at that time, we were able to avoid global problems due to the burden that was five times larger than a typical day. <br><br><h2>  Black Friday 2018 </h2><br>  By 2018, for high-load services serving the site, we gradually began to implement Go.  Given the history of the previous "Black Fridays", the discount calculation service was one of the first candidates for processing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f2/257/86a/2f225786a88b927c087c904c36702203.jpg"><br><br>  Of course, we could save the already ‚Äútried-and-tested‚Äù version of Python, and before the new Black Friday we could turn off the heavy libraries and discarding the suboptimal code.  However, by that time Golang had already taken root and looked more promising. <br><br>  We switched to the new service this summer, so before the next sale we managed to test it well, including on the increasing load profile. <br><br>  During testing, it turned out that the weak point in terms of high loads remains our base.  Too long transactions caused us to select the entire pool of connections, and requests were queued.  So we had to alter the logic of the application a little, reducing the use of the database to a minimum (referring to it only when there is no way without it) and caching directories from the database and data on coupons that are popular on Black Friday. <br><br>  However, this year we made a mistake with forecasts of a load in a big way: we were preparing for 6-8 times growth in peaks and achieved good work of services specifically for such a volume of requests (they added caches, disconnected the experimental functions, simplified some things, deployed additional Kubernetes nodes and even the database servers for the replicas, which in the end were not required).  In fact, the surge of user interest was less, so everything went as usual.  The service response time did not exceed 50 ms at the 95 percentile. <br><br>  For us, one of the most important characteristics is how the application is scaled due to the lack of resources of one copy.  Go spends hardware resources more efficiently, so with the same load, fewer copies are required to run (ultimately servicing more requests for the same hardware resources).  This year, at the very peak of sales, 16 copies of the application worked, which processed an average of 300 requests per second with peaks of up to 400 requests per second, which is approximately twice as high as the normal load.  I note that last year, the Python service required 102 instances. <br><br>  It would seem that the service on Go from the first approach closed all our needs.  But Golang is not a "universal solution to all problems."  It was not without some features.  For example, we had to limit the number of threads that the service can start on the multiprocessor node Kubernetes so that when scaling it does not interfere with the ‚Äúneighboring‚Äù applications on the production (by default, Go has no limits on how many processors it will take).  To do this, we set GOMAXPROCS in all applications on Go.  We will be happy to comment on how useful this was - in our team this was only one of the hypotheses about how to deal with the degradation of the ‚Äúneighbors‚Äù. <br><br>  Another ‚Äúsetting‚Äù is the number of connections that are held as Keep-Alive.  The default http and database clients in Go keep only two connections by default, so if there are a lot of concurrent requests and you need to save on the TCP connection setup traffic, it makes sense to increase this value by specifying MaxIdleConnsPerHost and SetMaxIdleConns, respectively. <br><br>  However, even with these manual "twists" Golang provided us with a large stock of performance for future sales. </div><p>Source: <a href="https://habr.com/ru/post/434208/">https://habr.com/ru/post/434208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434198/index.html">Selecting the operation of the web server on personal experience</a></li>
<li><a href="../434200/index.html">Is it so scary Rust, as it is painted</a></li>
<li><a href="../434202/index.html">4 secrets how not to lose work in data science</a></li>
<li><a href="../434204/index.html">OneWeb offers Russia a share in the project in exchange for frequencies</a></li>
<li><a href="../434206/index.html">Distributor ok.ru/music</a></li>
<li><a href="../434210/index.html">Analysis of the quiz contest on Android from the HeadHunter booth at Mobius 2018 Moscow</a></li>
<li><a href="../434212/index.html">Tesla Tower. What happens in and near the skyscraper when lightning strikes?</a></li>
<li><a href="../434214/index.html">Dynamic Java Proxy: What is it and how to use it?</a></li>
<li><a href="../434216/index.html">Brute-force attacks using Kali Linux</a></li>
<li><a href="../434218/index.html">Simple Java bot-clicker on the example of the game World of Warcraft 3.3.5a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>