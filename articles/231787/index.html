<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>I still love graphics programming.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year ago I wrote a story about one of my bikes, which I called ‚Äú I love graphics programming ‚Äù. In that story, I tried to show the development...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>I still love graphics programming.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/322/48f/553/32248f5538274f418c9f8ebad039f07e.jpg"><br><br>  About a year ago I wrote a story about one of my bikes, which I called ‚Äú <a href="http://habrahabr.ru/post/190458/">I love graphics programming</a> ‚Äù.  In that story, I tried to show the development process ‚Äúfrom the romantic side‚Äù, a little poshutiv over myself, they say everything is so fun and funny when you program graphics.  I told the story only from ‚ÄúWow!  Polosatenko ... ‚Äù, and now, almost a year later, I decided to share with you a story about how it all worked and how it ended.  I want to immediately warn you that this is still a story about bicycles.  This is not a story about revolutionary technologies or super-mega smart solutions.  This is a story about how I, at my own pleasure, intentionally wrote a bicycle. <br><br>  The story again is a little confused and everyone who doesn‚Äôt like Android, C ++, Live Wallpaper, Minecraft, bicycles, a stream of consciousness that is loosely tied to the topic and everything, I want to immediately warn you that they can be upset by the content of this post, so keep reading at one's own risk. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Past story? </h4><br>  For those who do not know and do not want to read the previous article, I will tell you briefly what it was about.  I wrote Live Wallpaper for Android, in the style of Minecraft.  In fact, just a picture of the landscape in the style of the game Minecraft, which you can flip through with your finger and in which there is a change of day and night. <br><br><h4>  Little about bikes </h4><br>  In the past, my story I made a digression to talk about the game, which I wrote many years ago because of nostalgic feelings, and in this story I decided not to differ in particular originality and to start with the same. <br>  In 2006, I was the happy owner of the CCP.  The VGA screen and all the other buns of this device provided quite ample opportunities and at that time I wrote several applications for Windows Mobile. <br>  One of the applications that I wrote was a game that in my childhood was called ‚ÄúEgg Killer‚Äù and which spent a lot of childhood time and children's nerves.  Without going into details, I took a set of images from the emulator and made a game based on them: <br><br><img src="https://habrastorage.org/files/cfb/413/432/cfb413432c5b4e9088c2cc5147a46245.jpg"><br><br>  But I am not telling this in order to advertise the PDA and not only from nostalgic feelings.  This is a story about bicycles - about bicycles that are created intentionally. <br><br>  At that time, I had enough experience in software development to write such a simple game in less than a day.  As I said before, the Rafik and the soundtrack were taken from the emulator, the logic is simple to the point, and the output to the screen of 10 sprites certainly did not make any problems.  Perhaps the fact that the implementation was too simple was for me the main problem.  After all, I decided to write this game for myself - not for sale, not for someone, but just for myself, which means I have to get something more than a ready-made game from it.  The process was supposed to be fun. <br><br>  Here bicycles came to the rescue ... Its image format, for sprites that should be displayed on the screen (on top of the background image).  Its process of displaying these sprites with the effect of white noise.  And everything was implemented through FrameBuffer, i.e.  through an array of pixels.  And now the task has already taken about 4 days and has become much more interesting. <br><br>  I will quote myself from the previous article: <br><blockquote>  I wrote it, it worked exactly as I remembered, I played it once, I quit it, because  already ‚Äúplayed up‚Äù in the process of debugging. </blockquote>  But for me it has become a kind of tradition ... <br><blockquote>  You see, every year on December 31, my friends and I go to the bathhouse.  This is our tradition. </blockquote>  I began to realize things from time to time, for myself, so that, as they say, ‚Äústretch the brain‚Äù.  And this process gives me a lot of pleasure, so I immediately want to give an answer to those who like to scream in the comments: ‚ÄúPhe-poo-pooh, why so ?!  Yes, you need perlin noise and fractal generation of areas! ‚Äù.  - Yes, for everything that I describe in this story, I have my own methods and my own tools - I know that very well.  My implementation has nothing to do with the fact that I do not know about the existence of ready-made solutions.  The essence is in the implementation of their decisions. <br><br><h4>  Back to the topic </h4><br>  It was written a simple application Live wallpaper, which simply painted over the screen in a certain color.  I will not tell you how to do this, because  This is the part that can be easily found in search engines.  In the application, the ‚Äúdraw‚Äù method was responsible for drawing, which did something like the following: <br><br><img src="https://habrastorage.org/files/bc5/3b3/28c/bc53b328ced842a7a72cbb45df3fc7b4.png"><br><br>  Here began the first problems with performance ... <br><br><h4>  SDK Features </h4><br>  Initially, the question was how to get an image from JNI and the most logical solution seemed to get an array of int, which would represent a bitmap with a 32-bit pixel representation (32bpp).  This approach was also driven by the fact that Java offers a method for outputting such an array on canvas: <br><br><img src="https://habrastorage.org/files/62f/656/006/62f656006ce441d1bb0cd37c0237497f.png"><br><br>  I proceeded from this logic - an array of pixels can be obtained from a Bitmap object, but it will definitely be longer than just transferring an array and drawing an array using a method that was specially made for that. <br><br>  Here I was in for a surprise from Android: the drawBitmap method was drawing a picture (720x1280) for about 21ms, so if I want to draw 30 frames per second (even if without delays - taking up the entire processor), then my implementation would have to fit in 12ms (and Yes, here I do not even take into account the fact that drawing itself is not the only thing that takes time).  This arrangement certainly did not suit me, so I had to experiment and look for other options.  The solution was to transfer the Bitmap object to JNI, which in the drawing method was processed as follows: <br><br><img src="https://habrastorage.org/files/886/2b6/90d/8862b690d8a5416ab3b995d6f527e2c4.png"><br><br>  So, transferring an object like Bitmap, getting information about it (AndroidBitmap_getInfo), getting an array of pixels (AndroidBitmap_lockPixels / AndroidBitmap_unlockPixels) and the actual JNI call itself (without my drawing), now took no more than 1ms.  At this stage, the problem of transferring the image to JNI and back has been resolved.  I didn't find anything in the documentation about why using the drawBitmap method with an array of pixels works so long, but it can be assumed that in that case, just before drawing, a Bitmap object is created. <br><br>  Overhead costs somehow remained because  receiving and releasing a Canvas object with each drawing takes approximately 1-2 ms.  And the Bitmap output itself using the drawBitmap method takes another 3-4m: <br><br><img src="https://habrastorage.org/files/ec3/d95/567/ec3d95567b8f4666b39256f78ccba6e5.png"><br><br>  In total, about 5-6ms have to be given for additional operations, but then I could not do anything and had to accept. <br><br>  This is probably the only interesting technical aspect that was encountered in Java, so the further narrative goes to JNI and to the implementation of the landscape generation algorithms. <br><br><h4>  Skyline and cyclical </h4><br>  The landscape itself was displayed cyclically, i.e.  the image is a closed ribbon that can be scrolled endlessly in any direction (horizontally).  From the point of view of the algorithm, it is possible to generate a landscape of any length, but the length is limited so as not to consume too much memory. <br><br>  From the point of view of implementation, everything is very simple here: <br>  If it is necessary to generate a region whose points extend beyond the map (horizontally), then these points are simply transferred to the other side of the map (for x &lt;0, x + = width and for x&gt; = width, x - = width).  The question of the implementation of the horizon level is a bit more interesting - the horizon should be random, but the start and end points should converge so that there is no such effect: <br><br><img src="https://habrastorage.org/files/c80/dfa/d72/c80dfad727ff45c491a0a8c08b9a3ec7.jpg"><br><br>  To solve the problem, the following algorithm was written: <br><ul><li>  Randomly choose y coordinate of the starting point. </li><li> The next point can have one of the offsets relative to the previous point: {-2, -1, 0, 1, 2}, for each of the offsets it is checked whether it is possible to return to the starting point for the remaining number of transitions.  The offset, the choice of which does not allow to go to the starting point, is removed from the list. </li><li>  A random offset value is selected from the list. </li><li>  Repeat from the second point, until you come to the beginning. </li></ul><br><br>  In practice, this approach allows us to generate both flat surfaces of the landscape and ‚Äúmountains‚Äù.  To tell the truth, I know that the algorithm is the most optimal and that it should have been based on the distortions of the straight line, but at that time, the solution seemed sufficient. <br><br><h4>  Caves and other elements </h4><br>  One of the main tasks was the generation of caves, and various blocks (coal, sand, etc.).  There are quite a few algorithms for solving this problem, but I decided to write everything myself, as it comes to my mind. <br><br>  The implementation was similar to the implementation of the flood fill algorithm, only with some element of randomness: <br><ol><li>  Select a random point, set the ‚Äúweight‚Äù for this point (random number). </li><li>  Check the availability of neighboring points (process each of the neighboring points, reducing the ‚Äúweight‚Äù randomly) - whether the point is outside the screen, if the point was not processed previously. </li></ol><br><br>  The ‚Äúweight‚Äù of neighboring points is determined by a random number ranging from (‚Äúweight‚Äù of the parent point / 2) to the ‚Äúweight‚Äù of the parent point.  Additionally, the ability to create more random regions was added to the generation algorithm by adding the ‚Äúextra randomness‚Äù condition, where the child points are not considered with 20% probability. <br><br>  The process of traversing points is quite clearly possible to show with the help of animation: <br><br><img src="https://habrastorage.org/files/f1a/a9f/109/f1aa9f1090ba43da841432966b2b7400.gif"><br><br>  A bit different animation, which shows the process of reducing the "weight" from the center: <br><br><img src="https://habrastorage.org/files/d20/a6c/186/d20a6c186f8241c28eaf7fd4c63c0b4c.gif"><br><br>  At its core, the algorithm is recursive, but a queue was used for implementation.  The starting point is added to the processing queue and the loop is executed as long as there are points in the queue.  Available adjacent points with a weight greater than 0 are added to the queue.  In general, everything is pretty standard, in terms of solving the problem of excessive depth of the call stack. <br><br>  This algorithm is performed in several passes - it creates several initial points from which the child points are processed.  As a result, the regions are randomly interconnected, creating more complex regions.  Here is an example of creating five regions (the points of each region are marked with numbers from one to five, the starting point of the region has a red frame): <br><br><img src="https://habrastorage.org/files/baa/07e/35e/baa07e35ea6745cd811068f45dd3d62c.png"><br><br>  This algorithm is the basis for most of the landscape, only the number of starting points (the points from which separate regions are created), the starting ‚Äúweight‚Äù for the starting points, and the position of the starting points (this is done so that certain regions are created only within a certain depths, for example, only near the bottom). <br><br>  The starting points of the regions were also used to place lighting elements (torches).  In the earlier version, the torches were located at the initial points of the region, but then I decided to lower them ‚Äúto the ground‚Äù and if the initial point of the region is higher than in two blocks from the ‚Äúfloor‚Äù, then the torch was placed exactly in two blocks from the floor.  This approach made the lighting more interesting (large parts of the region could remain dimly lit). <br><br><h4>  Again about performance </h4><br>  The whole development process I struggled with performance.  It was necessary to alter quite a lot, when at the testing stage it became clear that the drawing required too much time.  I did not invent anything particularly original, I implemented only the process of identifying changed areas, so that only the area that really needs to be redrawn was involved in the drawing.  The rest was taken from the past image.  So, for example, when turning over, the most part remained unchanged, and only the segment that needed to be added was drawn (in the image, the blocks that need to be drawn are marked in red): <br><br><img src="https://habrastorage.org/files/8d3/3c2/1ff/8d33c21ff2364edd99b51bbda7e4618d.gif"><br><br>  The algorithm was responsible not only for the offset, but also for the area, the lighting of which changed with the change of time: <br><br><img src="https://habrastorage.org/files/8a6/c5a/ebd/8a6c5aebd7514327a208a3ba961457b5.gif"><br><br><h4>  Pseudo 3d </h4><br>  ‚ÄúPseudo-oboe‚Äù was also created quite simply - the position of the block is always fixed - in addition to the front face, you can see the side face (on the left) and the top face.  For each type of blocks, 5 images were generated from textures, which together created the illusion of volume: <br><br><img src="https://habrastorage.org/files/936/d83/be5/936d83be56194f0e92ad0161aba5e8ea.png"><br><br>  In total, there are 5 different variants of block arrangement (black is the block that needs to be drawn, the neighboring blocks are shown in gray, the place where there is no neighboring block is shown in white): <br><br><img src="https://habrastorage.org/files/585/e2e/4cf/585e2e4cfda641b28d9a329dade6b118.png"><br><br>  In each of the options you need to draw a specific set of images: <br>  1. a, b, c, d1, d2 <br>  2. a, c, d2 <br>  3. a, c <br>  ... <br><br>  An example of drawing, where the block segments are marked with different colors: <br><br><img src="https://habrastorage.org/files/d0e/6ab/936/d0e6ab936e16490a85817a64392ba911.png"><br><br>  The values ‚Äã‚Äãof the visible edges of the block were calculated at the stage of generating the landscape, which means that when drawing it was necessary only to draw what was necessary. <br><br><h4>  About random numbers </h4><br>  To generate ‚Äúrandom‚Äù numbers, a class was written that generated a set of numbers based on a given string (seed) and an additional parameter.  For example, when generating caves, a combination of seed and ‚Äúcaves‚Äù was used, for trees - seed and ‚Äútrees‚Äù.  This approach provided an opportunity to turn off the generation of a specific area (for example, not to generate blocks of coal or iron), but not to affect the appearance of the other elements, which are based on random numbers. <br><br>  I built the algorithm on the crc32 checksum calculation algorithm, since  at the same time, it allowed me to get a number from any data and I had its realization on hand. <br><br><h4>  Briefly about the results </h4><br>  Application installations per year: 16553 (+ 81 (paid)): <br><br><img src="https://habrastorage.org/files/f29/e9b/aab/f29e9baab4b54e41b810130c35ecfd3e.png"><br><br>  The total income from the application amounted to <b>2794.91 rubles</b> .  In general, if I earned a living by writing bicycles, then I would have died of starvation. <br><br>  On the development process, I can say that it was very interesting to solve problems that we usually do not encounter in our work.  Of course, it was possible to take one of the ready-made engines and, based on it, to do something similar, with an honest 3d and without the described perversions, but again I hope that this will push someone else to create something with their own hands, and not just using ready-made frameworks and libraries. <br><br>  <b>Thank you all for your attention!</b> </div><p>Source: <a href="https://habr.com/ru/post/231787/">https://habr.com/ru/post/231787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231773/index.html">How to convince visitors of your site to buy a product using competitors? Part 2</a></li>
<li><a href="../231775/index.html">Task ‚ÄúReliability of Logic Circuits‚Äù</a></li>
<li><a href="../231777/index.html">Work by the sea</a></li>
<li><a href="../231783/index.html">How we check the security of mobile applications, and why it is not easy. Security in Yandex</a></li>
<li><a href="../231785/index.html">How in the Cloud Mail.Ru appeared protection against viruses</a></li>
<li><a href="../231791/index.html">Samsung introduced the flagship UHD-monitor 9th series U32D970Q</a></li>
<li><a href="../231793/index.html">"Social proof" should be on your side</a></li>
<li><a href="../231795/index.html">Registration of Official Bloggers ‚Ñ¢ in Russia is open.</a></li>
<li><a href="../231797/index.html">Investing for Dummies</a></li>
<li><a href="../231799/index.html">PFLink: effective link enhancement with custom transitions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>