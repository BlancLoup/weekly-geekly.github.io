<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grab - new interface for working with DOM-tree of HTML-document</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Historical excursion 
 Earlier, I wrote on Habr√© about Grab - a framework for writing parser sites: one , two , three , four . In a nutshell, Grab is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grab - new interface for working with DOM-tree of HTML-document</h1><div class="post__text post__text-html js-mediator-article"><h2>  Historical excursion </h2><br>  Earlier, I wrote on Habr√© about <a href="http://grablib.org/">Grab</a> - a framework for writing parser sites: <a href="http://habrahabr.ru/post/127584/">one</a> , <a href="http://habrahabr.ru/post/134918/">two</a> , <a href="http://habrahabr.ru/post/139435/">three</a> , <a href="http://habrahabr.ru/post/142288/">four</a> .  In a nutshell, Grab is a handy wrapper on top of two libraries: pycurl for networking and lxml for parsing HTML documents. <a name="habracut"></a><br><br>  The lxml library allows you to make XPATH queries to the DOM tree and get the results in the form of ElementTree objects that have a lot of useful properties.  A few years ago, I developed a few simple methods that allowed us to apply xpath queries to a document loaded through the hornbeam.  I will illustrate with the code: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Grab &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru/'</span></span>) &lt;grab.response.Response object at <span class="hljs-number"><span class="hljs-number">0x7fe5f7189850</span></span>&gt; &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.xpath_text(<span class="hljs-string"><span class="hljs-string">'//title'</span></span>)    /  / </code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is essentially the same as the following code: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlopen &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> lxml.html <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fromstring &gt;&gt;&gt; data = urlopen(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru/'</span></span>).read() &gt;&gt;&gt; dom = fromstring(data) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> dom.xpath(<span class="hljs-string"><span class="hljs-string">'//title'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].text_content()    /  / </code> </pre><br><br>  The convenience of the xpath_text method is that it is automatically applied to a document loaded via Grab, you do not need to build a tree, it is done automatically, you also do not need to manually select the first element, the xpath_text method does it automatically, and this method automatically extracts text from all nested elements .  Next, I list all the methods of the Grab library with their brief description: <br><br><ul><li>  grab.xpath - return the first element that satisfies the condition </li><li>  grab.xpath_list - return all items </li><li>  grab.xpath_text - take the first element that satisfies the condition and extract text content from it, also allows you to set the default value that is returned if the element is not found </li><li>  grab.xpath_number - take the result of grab.xpath_text and find the number in it </li></ul><br><br>  Not without embarrassment.  The method grab.xpath - returns the first element of the selection, while the xpath method of the ElementTree object returns the entire list.  People repeatedly ran across this rake.  I also want to note that there was exactly the same set of methods for working with css requests i.  grab.css, grab.css_list, grab.css_text, etc., but I personally refused to use CSS expressions in favor of XPATH.  XPATH is a more powerful tool and it often makes sense to use it and I did not want to see in the code a jumble of CSS and XPATH expressions. <br><br>  The above methods had a number of drawbacks: <br><br>  First, when it was required to bring the code of the selection of elements into a separate function, there was a temptation to transfer into it the entire Grab object in order to call these functions from it.  In another way: either we pass a Grab object or we pass a bare DOM object that has no useful functions, such as xpath_text. <br><br>  Secondly, the output of the functions grab.xpath and grab.xpath_list are bare ElementTree elements that no longer have methods of type xpath_text. <br><br>  Thirdly, although this is more likely a problem of the framework extensions, one way or another, the Grab object namespace is clogged with many of the methods described above. <br><br>  And, yes, and fourth.  I was shaken by the question of how to get the HTML code of elements found using the grab.xpath and grab.xpath_list methods.  The people did not want to understand that grab is just a wrapper around lxml and that you just need to read the manual on <a href="http://lxml.de/">lxml.de</a> <br><br>  The new interface for working with the DOM tree is designed to eliminate these shortcomings.  If you use the Scrapy framework, then the things described below will already be familiar to you.  I want to talk about selectors. <br><br><h2>  Selectors </h2><br><br>  Selectors, what is it?  These are wrappers around ElementTree elements.  The original wrapper wraps the entire DOM document tree i.  The wrapper is built around the root html element.  Next, we can use the select method to get a list of elements that satisfy the XPATH expression, and each such element will again be wrapped in a Selector wrapper. <br><br>  Let's see what we can do with selectors.  First, we design the selector <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab.selector <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Selector &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> lxml.html <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fromstring &gt;&gt;&gt; root = Selector(fromstring(<span class="hljs-string"><span class="hljs-string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Header&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Item 1&lt;/li&gt;&lt;li&gt;&lt;li&gt;item 2&lt;/li&gt;&lt;/ul&gt;&lt;span id="color"&gt;green&lt;/span&gt;'</span></span>))</code> </pre><br><br>  Now let's make a selection using the select method, get a list of new selectors.  We can refer to the desired selector by index, there is also a one () method for selecting the first selector.  Notice that in order to access the ElementTree element directly, we need to refer to the node attribute of any selector. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>root.select(<span class="hljs-string"><span class="hljs-string">'//ul'</span></span>) &lt;grab.selector.selector.SelectorList object at <span class="hljs-number"><span class="hljs-number">0x7fe5f41922d0</span></span>&gt; &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt;grab.selector.selector.Selector object at <span class="hljs-number"><span class="hljs-number">0x7fe5f419bed0</span></span>&gt; &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].node &lt;Element ul at <span class="hljs-number"><span class="hljs-number">0x7fe5f41a7a70</span></span>&gt; &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul'</span></span>).one() &lt;grab.selector.selector.Selector object at <span class="hljs-number"><span class="hljs-number">0x7fe5f419bed0</span></span>&gt;</code> </pre><br><br>  What actions are available on the found selectors?  We can extract text content, try to find numeric content, and even apply a regular expression. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].text() <span class="hljs-string"><span class="hljs-string">'Item 1'</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].number() <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li/text()'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].rex(<span class="hljs-string"><span class="hljs-string">'(\w+)'</span></span>).text() <span class="hljs-string"><span class="hljs-string">'Item'</span></span></code> </pre><br><br>  Note that we use an index to refer to the first selector found.  All these entries can be reduced without specifying an index, then, by default, the first selector will be used. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li'</span></span>).text() <span class="hljs-string"><span class="hljs-string">'Item 1'</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li'</span></span>).number() <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li/text()'</span></span>).rex(<span class="hljs-string"><span class="hljs-string">'em (\d+)'</span></span>).text() <span class="hljs-string"><span class="hljs-string">'1'</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul/li/text()'</span></span>).rex(<span class="hljs-string"><span class="hljs-string">'em (\d+)'</span></span>).number() <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br>  What else?  The html method for getting the HTML code of the selector, the exists method for checking the existence of the selector.  You can also call the select method on any selector. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>root.select(<span class="hljs-string"><span class="hljs-string">'//span'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].html() <span class="hljs-string"><span class="hljs-string">u'&lt;span id="color"&gt;green&lt;/span&gt;'</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//span'</span></span>).exists() <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//god'</span></span>).exists() <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &gt;&gt;&gt; root.select(<span class="hljs-string"><span class="hljs-string">'//ul'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].select(<span class="hljs-string"><span class="hljs-string">'./li[3]'</span></span>).text() <span class="hljs-string"><span class="hljs-string">'item 2'</span></span></code> </pre><br><br>  How to work with the selector directly from the Grab object?  With the help of the doc attribute, you can access the root selector of the DOM tree and then use the select method for the desired sample: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> grab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Grab &gt;&gt;&gt; g = Grab() &gt;&gt;&gt; g.go(<span class="hljs-string"><span class="hljs-string">'http://habrahabr.ru/'</span></span>) &lt;grab.response.Response object at <span class="hljs-number"><span class="hljs-number">0x2853410</span></span>&gt; &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.doc.select(<span class="hljs-string"><span class="hljs-string">'//h1'</span></span>).text()   ,      MIT    &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.doc.select(<span class="hljs-string"><span class="hljs-string">'//div[contains(@class, "post")][2]'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].select(<span class="hljs-string"><span class="hljs-string">'.//div[@class="favs_count"]'</span></span>).number() <span class="hljs-number"><span class="hljs-number">60</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> g.doc.select(<span class="hljs-string"><span class="hljs-string">'//div[contains(@class, "post")][2]'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].select(<span class="hljs-string"><span class="hljs-string">'.//div[@class="favs_count"]'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].html() &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">favs_count</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class">=" ,    "&gt;60&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br><br>  The current implementation of selectors in Grab is still quite raw, but I can already understand and appreciate the new interface. <br><br>  In the version of Grab, available through pypi selectors yet.  If you want to play <a href="https://bitbucket.org/lorien/grab">around</a> with selectors, put Grab from the repository: <a href="https://bitbucket.org/lorien/grab">bitbucket.org/lorien/grab</a> .  Specifically, the implementation of selectors is <a href="https://bitbucket.org/lorien/grab/src/tip/grab/selector/selector.py%3Fat%3Ddefault">here.</a> <br><br>  I represent the company <a href="http://grablab.org/">GrabLab</a> - we are engaged in parsing sites, parsing with the help of Grab and not only.  If your company uses Grab, you can contact us about the Grab customization to suit your needs. </div><p>Source: <a href="https://habr.com/ru/post/173509/">https://habr.com/ru/post/173509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173493/index.html">The Internet Protection League will announce threats to the freedom of the Web, following the example of Batman</a></li>
<li><a href="../173495/index.html">MongoDB 2.4 release</a></li>
<li><a href="../173499/index.html">US Supreme Court ruled in favor of student selling textbooks on eBay</a></li>
<li><a href="../173501/index.html">Burn-in rutovy shell in Vesta IP cameras and not only</a></li>
<li><a href="../173503/index.html">The first attempt to state regulation of Bitcoin</a></li>
<li><a href="../173513/index.html">Configuring EMC VNX 5100 Storage</a></li>
<li><a href="../173517/index.html">Death of proprietary software</a></li>
<li><a href="../173519/index.html">Humble Weekly Sale: Bastion</a></li>
<li><a href="../173521/index.html">New design Python.org</a></li>
<li><a href="../173525/index.html">A note on the registry of prohibited sites has been added to the registry of prohibited sites.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>