<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Non-obvious features of the storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Colleagues, there was a desire to share practical experience in the use of virtualization environments and related systems. 

 This article will discu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Non-obvious features of the storage</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/991/da5/638/991da56383eec311a47c5e14c08ee465.jpg" alt="image"><br><br>  Colleagues, there was a desire to share practical experience in the use of virtualization environments and related systems. <br><br>  This article will discuss the features of the storage systems.  In principle, this information also applies to physical servers using storage systems, but mostly it will be about virtualization, and about VMWare in particular. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why VMWare?  It's simple, I am a specialist in this virtualization environment, I have the status of VCP5.  For a long time he worked with large customers and had access to their systems. <br><br>  So let's start with the origins.  I will try not to strain readers abstruse words and complex calculations.  Not all are experts in the field, and the material can be useful to many. <br><a name="habracut"></a><br>  What is virtualization (in the server area)?  This is a kind of software and hardware system that allows separating computing resources from the hardware at the logical level.  In the classical form, only one operating system can be operated on a single server that manages this server.  All computing resources are given to this operating system, and it owns them exclusively.  In the case of virtualization, we have added a layer of software that allows us to emulate some of the server's computing resources in the form of an isolated container, and there may be many such containers (virtual machines).  Each container can have its own operating system installed, which, probably, will not suspect that its hardware server is actually a virtual container.  This layer of software is called the hypervisor, a medium for creating containers, or virtual servers. <br><br>  How does a hypervisor work?  Conventionally, all requests from operating systems in containers (guest operating systems) are accepted by the hypervisor and processed in turn.  This applies both to working with processor power and working with RAM, network cards, as well as with data storage systems.  On the latter just will be discussed further. <br>  As disk resources that are provided by the hypervisor to operating systems in containers, disk resources of the hypervisor itself are usually used.  It can be both disk systems of the local physical server, and disk resources connected from external storage systems.  The connection protocol is secondary here and will not be considered. <br><br>  All disk systems, in fact, characterize 3 characteristics: <br>  1. The width of the data channel <br>  2. Maximum number of I / O operations <br>  3. The value of the average delay at maximum load <br><br>  1. The channel width is usually determined by the storage connectivity interface and the performance of the subsystem itself.  In practice, the average load on the width is extremely small and rarely exceeds 50 ... 100 megabytes per second, even for a group of 20-30 virtual servers.  Of course, there are also specialized tasks, but we are now talking about the average temperature in the hospital.  Practice points to exactly these numbers.  Naturally, there are peak loads.  At such moments, the bandwidth may not be enough, so when sizing (planning) your infrastructure, you need to focus on the maximum possible load. <br><br>  2. I / O operations can be divided into single-threaded and multi-threaded.  Given the fact that modern operating systems and applications polls have learned to work multi-threaded, we assume that the entire load is multi-threaded.  Further, I / O operations can be divided into sequential and random.  With random access, everything is clear, but with sequential?  Given the load from a large number of virtual machines, and even multi-threaded from each machine, we end up with almost completely random access to the data.  Of course, variants of specific cases with sequential access and a small number of threads are possible, but again, we consider the average temperature.  Finally, I / O operations can be divided into read and write.  The classic model tells us about 70% of reads and 30% of write operations.  Perhaps it is for applications inside virtual machines.  And in fact, many, when testing and sizing, take these statistics as the basis for testing storage systems.  And make a huge mistake.  People confuse access statistics for applications, and access statistics for the disk subsystem.  This is not the same thing.  In practice, the following division is observed for a disk system: about 30% of operations for reading and 70% for writing. <br><img src="https://habrastorage.org/getpro/habr/post_images/7fa/ccd/4af/7faccd4afd26f64b9ee314554b28302b.png" alt="image"><br>  Where does this difference come from ?!  It is due to the work of caches of different levels.  The cache may be at the application itself, at the operating system of the virtual machine, at the hypervisor, at the controller, at the disk array, and finally at the disk itself.  As a result, part of the operations for reading falls into the cache of any level and does not reach the physical disks.  And write operations always come.  This must be clearly remembered and understood when sizing storage systems. <br><br>  3. Delays, or latency of the storage system, is the time during which the guest operating system will receive the requested data from its disk.  The request from the application is schematically and simplified as follows: Application-Operating System-Virtual Machine-Hypervisor-Storage System-Hypervisor-Virtual Machine-Operating System-Application.  In fact, there are 2-3 times more intermediate chain links, but let's omit deep technical subtleties. <br>  What might be the most interesting thing in this thread?  First of all, the answer of the storage system itself and the work of the hypervisor with the virtual machine.  With a storage system, everything seems to be clear.  If we have SSD drives, then time is spent reading data from the desired cell and in fact everything.  Latency is minimal, about 1 ms.  If we have SAS disks 10k or 15k, then the access time to the data will consist of many factors: the depth of the current queue, the head position relative to the next track, the angular position of the disk plate relative to the head, etc.  The head is positioned, waiting for the disk to turn, when the necessary data will be under it, performs a read or write operation and flies to a new position.  The smart controller stores the data access queue on the disks, adjusts the reading sequence depending on the flight path of the head, swaps the positions in the queue, and tries to optimize the work.  If the drives are in a RAID array, the access logic becomes even more complex.  For example, a mirror has 2 copies of data on 2 halves, so why not read different data from different locations at the same time with two halves of the mirror?  Controllers behave similarly with other types of RAID.  As a result, for high-speed SAS disks, the standard latency is 3-4 ms.  For the slow counterparts of NL-SAS and SATA, this indicator worsens to 9 ms. <br><br>  Now consider the chain link hypervisor-virtual machine.  Virtual machines have virtual hard disk controllers, usually they are SCSI devices.  And the guest operating system communicates with its disk also by iSCSI commands.  When the disk is accessed, the virtual machine is blocked by the hypervisor and does not work.  At this time, the hypervisor intercepts the SCSI commands of the virtual controller, and then resumes the virtual machine.  Now the hypervisor itself accesses the data file of the virtual machine (the virtual machine disk file) and performs the necessary operations with it.  After that, the hypervisor stops the virtual machine again, again generates SCSI commands for the virtual controller and, on behalf of the virtual machine disk, responds to a recent request from the guest operating system.  These fake I / O operations require about 150-700 CPU cycles of the physical server, that is, they take about 0.16 microseconds.  On the one hand, not so much, but on the other hand?  What if the machine has active I / O?  Let's say 50.000 IOPS.  And what if it communicates with the network as intensively?  Add here a fairly probable loss of data from the processor's cache, which could have changed while waiting for a fake request by the hypervisor.  Or something good, the performing core has changed.  As a result, we have a significant decrease in the overall performance of the virtual machine, which is quite unpleasant.  In practice, I received a performance drop of up to 40% of the nominal value due to the influence of hyperactive I / O of the virtual machine over the network and disk system. <br>  The slow operation of the disk system has an enormous effect on the operation of applications inside the guest machines.  Unfortunately, many experts underestimate this effect, and when sizing the hardware, they try to save on the disk subsystem: they try to install inexpensive, large and slow disks, save on controllers, and fault tolerance.  Loss of computing power leads to trouble and downtime.  Losses at the disk system level can lead to the loss of everything, including business.  Remember this. <br><br>  But back to the read and write operations, as well as the peculiarities of working with them at various RAID levels.  If you take stripe as 100% of performance, then the following types of arrays have indicators: <br><br>  Operation Array Type Efficiency <br>  Reading <br>  RAID0 100% <br>  RAID10 100% <br>  RAID5 ‚âà90% <br>  RAID6 ‚âà90% <br>  Record <br>  RAID0 100% <br>  RAID10 50% <br>  RAID5 25% <br>  RAID6 16% <br><br>  As we can see, RAID5 and RAID6 have a huge performance loss in writing.  Here we must not forget that I / O operations load the disk system together, and they cannot be considered separately.  Example: in RAID0 mode, a certain hypothetical system has a performance of 10,000 IOPS.  We collect RAID6, we load with classical loading of the virtualization environment, 30% reading and 70% of record.  We get 630 IOPS reads with simultaneous 1550 IOPS records.  Not thick, right?  Of course, the presence in the storage systems and cache controllers in write-back write mode slightly increases performance, but everything has limits.  IOPS must be read correctly. <br><br>  A few words about reliability, which have already been repeatedly said.  When large and slow disks fail, an array rebuild process occurs (did we take care of hot swapping?).  On 4TB disks, the Rebuild RAID 5 and 6 process takes about a week!  And if the load on the array is large, then even more.  The rebuild process is also associated with a sharp increase in the load on the disks of the array, which increases the probability of another disk crashing.  In the case of RAID 5, this will lead to irretrievable data loss.  In the case of RAID 6, we face high risks of losing the third disk.  For comparison, in RAID10 when rebuild an array, in fact, simply copy data from one half of the mirror (one disk) to the other.  This is a much simpler process and takes relatively little time.  For a 4 TB disk with an average load, the rebuild time will be about 10-15 hours. <br><br>  I would like to add that there are in nature smart storage systems like the Dell Compellent SC800, which have a very flexible approach to storing data based on various custom Tier levels.  For example, this system can write new data only on SCL SSD drives in the RAID10 mode, and then, in the background, redistribute the data blocks to other types of disks and RAID levels depending on the statistics of access to these blocks.  These systems are quite expensive and are aimed at a specific consumer. <br><br>  Summing up, it remains to determine the following theses: <br>  - Storage system for virtualization should be fast and reliable, with minimal latency <br>  - When designing a virtualization environment, about 40% of the total hardware budget must be put on the storage system <br>  - When sizing a storage system, in general, you should focus on RAID10 <br>  - Backups will save the world! </div><p>Source: <a href="https://habr.com/ru/post/225183/">https://habr.com/ru/post/225183/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225169/index.html">Introducing Sencha Ext JS 5</a></li>
<li><a href="../225173/index.html">Designing the physical infrastructure of the data center - from science to art</a></li>
<li><a href="../225175/index.html">New invariant number. The study of the natural number series (NPS)</a></li>
<li><a href="../225177/index.html">Rule number N + 0: do not be afraid to dig deeper</a></li>
<li><a href="../225179/index.html">Speech recognition in Asterisk using the Yandex SpeechKit HTTP API</a></li>
<li><a href="../225187/index.html">Zetes: Java with a multi-platform GUI, but without an Oracle JVM</a></li>
<li><a href="../225189/index.html">Multimodule Java-project with Gradle. Step by step</a></li>
<li><a href="../225191/index.html">Chinese Internet: a brief overview of near-social services</a></li>
<li><a href="../225193/index.html">The history of joint trips in Russia and abroad</a></li>
<li><a href="../225195/index.html">Crucial MX100: 256GB SSD for 110 dollars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>