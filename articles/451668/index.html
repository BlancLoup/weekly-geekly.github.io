<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ACPI: Adding devices without recompiling the kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As it turns out, few people know about the existence of overlay mode in ACPICA and their support in Linux OS. I want to fill this gap with the example...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ACPI: Adding devices without recompiling the kernel</h1><div class="post__text post__text-html js-mediator-article">  As it turns out, few people know about the existence of overlay mode in ACPICA and their support in Linux OS.  I want to fill this gap with the example of adding I2C slaves to the system without recompiling. <br><a name="habracut"></a><br><h4>  <font color="blue">Initial conditions</font> </h4><br>  Let's say at startup <br><br><pre><code class="bash hljs">i2cdetect -y -r 0</code> </pre> <br>  we have this picture: <br><br><div class="spoiler">  <b class="spoiler_title">I2cdetect output</b> <div class="spoiler_text"><pre>      0 1 2 3 4 5 6 7 8 9 abcdef
 00: - - - - - - - - - - - - - 
 ten: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
 20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
 thirty: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
 40: - - - - - - - - - - - - - - - - 
 50: - - - 53 - - - 57 - - - - - - - - 
 60: - - - - - - - - - - - - - - - - 
 70: - - - - - - - -                         
</pre><br></div></div><br>  where at the address 0x53 the accelerometer ADXL345 is detected, and at address 0x57 - the 24c128 memory chip EEPROM.  Descriptions of these devices are missing in ACPI, namely in the <abbr title="Differentiated System Description Table">DSDT</abbr> table. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <font color="blue">Adding accelerometer ADXL345</font> </h4><br>  All we need to know here is the address to which the device responds, its ID supported by the driver, the frequency of the bus on which it should work.  <i>Please note that the frequency of the I2C bus on the driver side is often set to the minimum that is supported by all slave devices on this bus!</i> <br><br>  Oh yes, there was a time when the <abbr title="Industrial IO">IIO</abbr> subsystem <abbr title="Industrial IO">did</abbr> not exist, and the ADXL345 driver was already there.  So, we use a <a href="">new</a> one that is available through the IIO subsystem. <br><br>  Total <br><br><ul><li>  Address: 0x53 </li><li>  Bus frequency: 400kHz </li><li>  Link to the master (controller) device: \ _SB.PCI0.I2C1 </li><li>  ID: adi, adxl345 </li></ul><br>  It should be noted that we use here a special identifier that is intended for systems with <abbr title="Open firmware">OF</abbr> .  As a layer, a special identifier <b>PRP0001</b> was added to ACPI, which ensures compatibility with the drivers written earlier for OF. <br><br>  We translate this information into <abbr title="ACPI Source Language">ASL</abbr> : <br><br><div class="spoiler">  <b class="spoiler_title">ASL code for the accelerometer ADXL345</b> <div class="spoiler_text"><pre> <code class="cpp hljs">DefinitionBlock (<span class="hljs-string"><span class="hljs-string">"adxl345.aml"</span></span>, <span class="hljs-string"><span class="hljs-string">"SSDT"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"ADXL345"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) { External (_SB_.PCI0.I2C1, DeviceObj) Scope (\_SB.PCI0.I2C1) { Device (ACL0) { Name (_HID, <span class="hljs-string"><span class="hljs-string">"PRP0001"</span></span>) Name (_DDN, <span class="hljs-string"><span class="hljs-string">"Analog Devices ADXL345 3-axis accelerometer"</span></span>) Name (_CRS, ResourceTemplate () { I2cSerialBusV2 ( <span class="hljs-number"><span class="hljs-number">0x0053</span></span>, <span class="hljs-comment"><span class="hljs-comment">// I2C Slave Address ControllerInitiated, 400000, // Bus speed AddressingMode7Bit, "\\_SB.PCI0.I2C1", // Link to ACPI I2C host controller 0 ) }) Name (_DSD, Package () { ToUUID("daffd814-6eba-4d8c-8a91-bc9bbf4aa301"), Package () { Package () { "compatible", "adi,adxl345" }, } }) } } }</span></span></code> </pre><br></div></div><br><h4>  <font color="blue">Add EEPROM 24c128</font> </h4><br>  Just as in the previous case, we obtain the necessary information about the device and its driver: <br><br><ul><li>  Address: 0x57 </li><li>  Bus frequency: 400kHz </li><li>  Link to the master (controller) device: \ _SB.PCI0.I2C1 </li><li>  ID: INT3499 </li><li>  Extent: 1024 </li><li>  Page Size: 32 </li></ul><br><div class="spoiler">  <b class="spoiler_title">ASL code for EEPROM 24c128</b> <div class="spoiler_text"><pre> <code class="cpp hljs">DefinitionBlock (<span class="hljs-string"><span class="hljs-string">"at24.aml"</span></span>, <span class="hljs-string"><span class="hljs-string">"SSDT"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"AT24"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) { External (_SB_.PCI0.I2C1, DeviceObj) Scope (\_SB.PCI0.I2C1) { Device (EEP0) { Name (_HID, <span class="hljs-string"><span class="hljs-string">"INT3499"</span></span>) Name (_DDN, <span class="hljs-string"><span class="hljs-string">"Atmel AT24 compatible EEPROM"</span></span>) Name (_CRS, ResourceTemplate () { I2cSerialBusV2 ( <span class="hljs-number"><span class="hljs-number">0x0057</span></span>, <span class="hljs-comment"><span class="hljs-comment">// I2C Slave Address ControllerInitiated, 400000, // Bus speed AddressingMode7Bit, "\\_SB.PCI0.I2C1", // Link to ACPI I2C host controller 0 ) }) Name (_DSD, Package () { ToUUID("daffd814-6eba-4d8c-8a91-bc9bbf4aa301"), Package () { Package () { "size", 1024 }, Package () { "pagesize", 32 }, } }) } } }</span></span></code> </pre><br></div></div><br>  Note the difference with the previous option.  It uses the ACPI ID directly, which is allocated in the space controlled by Intel, thanks to the Intel Galileo platform.  The second difference is that we pass additional device parameters in the form of key-value strings. <br><br><h4>  <font color="blue">Possible initialization options</font> </h4><br>  What to do now with this?  The algorithm is simple.  First, you need to compile the resulting files in the ASL bytecode.  Achieved by calling the command <br><br><pre> <code class="bash hljs">iasl adxl345.asl</code> </pre> <br>  and by analogy for eeprom.  Secondly, choose the method of initializing the new table.  There are actually three of them: 1) joining the initramfs, 2) loading on the work system via ConfigFS, 3) loading the table from the EFI variable.  Consider the first two of them below. <br><br><h5>  <font color="blue">Joining <i>initramfs</i></font> </h5><br>  We will not do anything with the <i>initramfs</i> archive <i>itself</i> , however, it is recommended to keep the original somewhere aside. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ACPI    cpio . #      /kernel/firmware/acpi  . #       . mkdir -p kernel/firmware/acpi cp adxl345.aml kernel/firmware/acpi cp at24.aml kernel/firmware/acpi #         initramfs: find kernel | cpio -H newc --create &gt; /boot/instrumented_initramfs-vX.Y cat /boot/initramfs-vX.Y &gt;&gt; /boot/instrumented_initramfs-vX.Y</span></span></code> </pre><br>  After this procedure, you can replace the old archive with a new one and restart the computer. <br>  It should appear in the dmesg output of something like: <br><br><pre> <code class="plaintext hljs">[ 0.000000] ACPI: Table Upgrade: install [SSDT- - ADXL345] [ 0.000000] ACPI: SSDT 0x000000003F4FF5C4 0000A6 (v05 ADXL345 00000001 INTL 20170303)</code> </pre><br>  Note that the kernel only supports a chain of up to 64 such archives. <br><br><h5>  <font color="blue">ConfigFS download</font> </h5><br>  This feature is available when the kernel is built with the CONFIG_ACPI_CONFIGFS option and ConfigFS mounted.  Assuming that it is mounted in the <i>/ sys / kernel / config</i> subdirectory, the following example shows how to load the table. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /sys/kernel/config/acpi/table mkdir adxl345 cat ~/adxl354.aml &gt; adxl345/aml</code> </pre><br><h4>  <font color="blue">Conclusion</font> </h4><br>  Although the ASL language requires more brackets than analogs, it nevertheless provides no less opportunity for describing devices.  So, there are a number of examples in the <a href="https://github.com/westeri/meta-acpi/tree/master/recipes-bsp/acpi-tables/samples">meta-acpi</a> project, where in particular you can find descriptions of LEDs and buttons connected to GPIO lines, memory chips, and even the description of the <a href="">Adafruit 2.8 "</a> module - TFT touch-screen display! </div><p>Source: <a href="https://habr.com/ru/post/451668/">https://habr.com/ru/post/451668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45164/index.html">We will pay your fines</a></li>
<li><a href="../451640/index.html">"Game of Thrones": building an infographic about murders, sex, traveling around V√§ster√•s and much more</a></li>
<li><a href="../451650/index.html">Part I. Ask your mother: How to communicate with customers and confirm the correctness of their business ideas, if everyone is lying around?</a></li>
<li><a href="../451658/index.html">Non fiction. What to read?</a></li>
<li><a href="../451666/index.html">We do the countdown timer in Google tables</a></li>
<li><a href="../451676/index.html">Performance tuning and troubleshooting databases these days</a></li>
<li><a href="../45168/index.html">How I bought a laptop on ebay.</a></li>
<li><a href="../451688/index.html">From programmer to businessmen</a></li>
<li><a href="../45169/index.html">Search music q00p</a></li>
<li><a href="../451690/index.html">Reading for owls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>