<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience starting AHCI in VxWorks653</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 I develop applications and drivers for various aviation applications. Aviation uses operating systems with stricter reliability require...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience starting AHCI in VxWorks653</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  I develop applications and drivers for various aviation applications.  Aviation uses operating systems with stricter reliability requirements (ARINC 653), such as VxWorks653, PikeOS, or LynkOS.  While developing avionics applications, there was a problem of slow access to data on solid-state drives connected via the ATA interface.  This was due to the use of the slow ATA software interface.  I solved this problem by implementing the AHCI driver. <br><br>  In this article I want to briefly describe the work of AHCI. <br><br><img src="https://habrastorage.org/files/49e/b57/016/49eb570164c54b748c3875bba6da6f17.PNG"><br>  <i>Device architecture with AHCI controller.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h2>  AHCI Description </h2><br>  Advanced Host Controller Interface (AHCI) is a mechanism used to connect data storage devices using the Serial ATA protocol. <br><br>  To work with the device in AHCI mode, you must perform the following steps: <br><ul><li>  Configure AHCI Controller </li><li>  Fill management structure </li><li>  Set the start flag in the controller </li><li>  Wait until the controller reads the structures with the list of commands from the memory through DMA and then returns the data to the buffers specified in the structures.  After performing all the actions, the transaction completion flag is set. </li><li>  Profit! </li></ul><br><br>  All interaction with AHCI registers occurs through the PCIe BAR5 window.  It is called ABAR (AHCI Base Address Region). <br><br><img src="https://habrastorage.org/files/5cd/851/737/5cd8517379cd464da2a2d09c47106d7a.PNG"><br>  <i>The distribution of the address space ABAR.</i> <br><br><h3>  AHCI Controller Configuration </h3><br>  The protocol specification is publicly available at: <a href="http://www.intel.com/content/www/us/en/io/serial-ata/ahci.html">www.intel.com/content/www/us/en/io/serial-ata/ahci.html</a> <br>  Current latest version of AHCI is 1.3.1 <br><br>  First we look for all the mass storage controllers on the PCIe bus.  We are interested in devices with class id 0x01 (mass storage device) and subclass id 0x06 (serial ATA). <br><br>  Controller configuration is as follows: <br><ul><li>  Reset controller; </li><li>  Enable AHCI </li><li>  Write the physical addresses of the command lists and FIS to ABAR </li><li>  Set required flags </li><li>  Configure interrupts </li></ul><br><br>  Through registers AHCI - ABAR, you can make a limited number of actions - set up AHCI, read its version, etc.  Access to the configuration of the data carrier and to the data itself through these registers is not possible. <br><br>  To gain access, special command lists are used.  Lists of commands are stored in the RAM of the calculator.  The physical address of these lists is written to the AHCI controller.  The AHCI controller itself calls on the DMA to the RAM of the calculator, reads the lists of commands, executes them, and reads and writes the memory blocks from the RAM.  The memory allocation architecture is shown in the figure below.  The OS initialization should allocate the necessary arrays in memory, calculate their physical address and, at the initialization stage, write their addresses to the corresponding ABAR registers. <br><br><img src="https://habrastorage.org/files/3c8/587/ebc/3c8587ebcd4e413f83a206faad8f645c.PNG"><br>  <i>Memory allocation in ABAR - HBA</i> <br><br><h3>  Filling management structures </h3><br>  For each port in ABAR, 2 structures must be specified - a list of commands and FIS. <br><br>  The command list consists of 2 parts - one command list header. <br>  The header indicates the size of the command list, the size of the FIS, and a link to the physical address of the command list itself. <br>  The list of commands contains the addresses of the buffers that will be needed when executing the command specified in the FIS and from the sizes. <br><br><img src="https://habrastorage.org/files/dc8/847/d63/dc8847d6394741ed837edf3f01d6e07b.PNG"><br>  <i>AHCI Port Structures</i> <br><br>  Command header generation: <br> <code>opts = (20 &gt;&gt; 2) | (sg_count &lt;&lt; 16); <br> pp-&gt;cmd_slot-&gt;opts = cpu_to_le32(opts); <br> pp-&gt;cmd_slot-&gt;status = 0; <br> pp-&gt;cmd_slot-&gt;tbl_addr = cpu_to_le32(pp-&gt;cmd_tbl &amp; 0xffffffff); <br> pp-&gt;cmd_slot-&gt;tbl_addr_hi = 0; <br></code> <br>  Here, the CFL field is filled with the FIS size value (I have a constant of 20) in double words.  The PRDTL field is filled with the number of 4Mb buffers used. <br><br><img src="https://habrastorage.org/files/079/093/a0c/079093a0cec7485596c93a1b1fdd24dd.PNG"><br>  <i>Command list header format</i> <br><br>  Formation of the command table: <br><pre> <code class="cpp hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_DATA_BYTE_COUNT (4*1024*1024) sg_count = ((buf_len - 1) / MAX_DATA_BYTE_COUNT) + 1; for (i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; sg_count; i++) { ahci_sg-&gt;addr = cpu_to_le32((uint32_t) buf + i * MAX_DATA_BYTE_COUNT); ahci_sg-&gt;addr_hi = 0; ahci_sg-&gt;flags_size = cpu_to_le32(0x3fffff &amp; (buf_len &lt; MAX_DATA_BYTE_COUNT ? (buf_len - 1) : (MAX_DATA_BYTE_COUNT - 1))); ahci_sg++; buf_len -= MAX_DATA_BYTE_COUNT; } return sg_count;</span></span></span></span></code> </pre><br>  The function fills the structure in which it indicates which buffers will participate in data transfer.  Since the size of the buffer in the record can not exceed 4Mb, the function divides the buffer into several, if its size exceeds 4Mb. <br><br><img src="https://habrastorage.org/files/78b/be1/40b/78bbe140b9064dcf9a018fdfd3a84f31.PNG"><br>  <i>Command Table Format</i> <br><br>  Description FIS in the documentation for AHCI no.  You should look for it in the description on SATA.  The FIS structure describes the operation code (Read identification, read, write, etc.) and parameters (offset, size, etc.). <br><br><img src="https://habrastorage.org/files/d8c/ca1/34d/d8cca134d64f4620826cd063fca0dd42.PNG"><br>  <i>FIS structure</i> <br><br>  When reading the identification information about the drive, the following FIS is generated: <br><pre> <code class="cpp hljs"> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(fis, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); fis[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x27</span></span>; fis[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; fis[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ATA_CMD_IDENT;</code> </pre><br><br>  When a data block record is requested, the FIS is generated: <br><pre> <code class="cpp hljs"> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(fis, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Construct the FIS */</span></span> fis[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x27</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Host to device FIS. */</span></span> fis[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Command FIS. */</span></span> fis[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ATA_CMD_WR_DMA; <span class="hljs-comment"><span class="hljs-comment">/* Command byte. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* LBA address, only support LBA28 in this driver */</span></span> fis[<span class="hljs-number"><span class="hljs-number">4</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">7</span></span>] = (((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>)) &amp; <span class="hljs-number"><span class="hljs-number">0x0f</span></span>) | <span class="hljs-number"><span class="hljs-number">0xe0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count */</span></span> fis[<span class="hljs-number"><span class="hljs-number">12</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) blocks &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">13</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (blocks&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>;</code> </pre><br><br>  When a read request for a data block is generated FIS: <br><pre> <code class="cpp hljs"> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(fis, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Construct the FIS */</span></span> fis[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x27</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Host to device FIS. */</span></span> fis[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Command FIS. */</span></span> fis[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ATA_CMD_RD_DMA; <span class="hljs-comment"><span class="hljs-comment">/* Command byte. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* LBA address, only support LBA28 in this driver */</span></span> fis[<span class="hljs-number"><span class="hljs-number">4</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">8</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">16</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">7</span></span>] = (((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (start&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>)) &amp; <span class="hljs-number"><span class="hljs-number">0x0f</span></span>) | <span class="hljs-number"><span class="hljs-number">0xe0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sector Count */</span></span> fis[<span class="hljs-number"><span class="hljs-number">12</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) count &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>; fis[<span class="hljs-number"><span class="hljs-number">13</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (count &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>))&amp;<span class="hljs-number"><span class="hljs-number">0xff</span></span>;</code> </pre><br><br><h3>  Run for execution </h3><br>  After the controller has been configured via ABAR, all the lists in the memory are prepared; it is enough to write 0x1 to PORT_CMD_ISSUE and wait until the flag is cleared.  You can wait in a loop (I did just that) or by interrupt. <br><br>  Immediately after writing to the PORT_CMD_ISSUE, the controller through DMA will access the processor's RAM and perform the actions that were expected of it. <br><br>  So as a result of the read operation, we will get the data from the media in the buffers specified in the command list. <br><br><h2>  Conclusion </h2><br>  Before using AHCI in the project, the read / write speed was: ~ 100kb / s <br>  After using AHCI in the project, the read / write speed was: 30/10 Mb / s </div><p>Source: <a href="https://habr.com/ru/post/280254/">https://habr.com/ru/post/280254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280234/index.html">Rules for working with Tasks API. Part 1</a></li>
<li><a href="../280236/index.html">We make our friGate with anonymity and without advertising</a></li>
<li><a href="../280238/index.html">Web Scraping with python</a></li>
<li><a href="../280248/index.html">Vivaldi builds you might not have noticed</a></li>
<li><a href="../280250/index.html">Quick start 1C Trade management for Kazakhstan (Trade and Warehouse)</a></li>
<li><a href="../280256/index.html">Wearable Smart Gateway - wearable device for emergency services</a></li>
<li><a href="../280258/index.html">The digest of interesting materials for the mobile # 146 developer (March 21-27)</a></li>
<li><a href="../280262/index.html">Efficient data structures for PHP 7</a></li>
<li><a href="../280264/index.html">5 tips for preparing your application for multiwindow mode in Android N</a></li>
<li><a href="../280266/index.html">Casual workouts for Swift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>