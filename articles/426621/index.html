<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compact strings in Java 9</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again! We opened another set in the now ninth group ‚ÄúJava Developer‚Äù (and the tenth group in the plans, suddenly, stands at 31.12) and prepared ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compact strings in Java 9</h1><div class="post__text post__text-html js-mediator-article">  Hello again!  We opened another set in the now ninth group <a href="https://otus.pw/4qgF/">‚ÄúJava Developer‚Äù</a> (and the tenth group in the plans, suddenly, stands at 31.12) and prepared interesting materials and <a href="https://otus.pw/dXvO/">an open lesson</a> for you. <br><br>  So go. <br><br>  Want to reduce the amount of memory used by your Java application?  See how you can improve performance with the compact strings available in Java 9. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of the performance improvement solutions introduced in the JVM (Oracle HotSpot, to be exact), as part of Java SE 9, was compact strings.  Their task is to reduce the size of String-objects, which allows to reduce the total amount (footprint) of memory consumed by the application.  As a result, it can reduce the amount of time spent collecting garbage. <br><br><img src="https://habrastorage.org/webt/zp/zr/wo/zpzrwogqmvawhhq3xcbbvvdn7l4.png"><a name="habracut"></a><br><br>  The function is based on the observation that many String objects do not require 2 bytes to encode each character, since most applications use only Latin-1 characters.  Therefore, instead of this: <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/**       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> value[];</code> </pre> <br>  <code>java.lang.String</code> now has this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] value; <span class="hljs-comment"><span class="hljs-comment">/** *        * {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@code</span></span></span><span class="hljs-comment"> value}.      : * * LATIN1 * UTF16 * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@implNote</span></span></span><span class="hljs-comment">     .    * ‚Äú‚Äù,   String - .   *      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> coder;</code> </pre> <br>  In other words, this function replaces the value in the <code>char</code> array (where each element uses 2 bytes) with a byte array with an extra byte to determine the encoding (Latin-1 or UTF-16).  This means that in most applications using only Latin-1 characters, only half of the heap will be used.  The user will not notice the differences, but the associated APIs, for example, <code>StringBuilder</code> , will automatically take advantage of this. <br><br>  To see this change in terms of the size of a String object, I will use the Java Object Layout, a simple utility to visualize the structure of the object on the heap.  From this point of view, we are interested in the footprint of the array (stored in the value variable above), and not just the link (the byte array reference, like the symbol array reference, uses 4 bytes).  The code below displays information using JOL <code>GraphLayout</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOLSample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(GraphLayout.parseInstance(<span class="hljs-string"><span class="hljs-string">"abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz"</span></span>).toFootprint()); } }</code> toFootprint ().); <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOLSample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(GraphLayout.parseInstance(<span class="hljs-string"><span class="hljs-string">"abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz"</span></span>).toFootprint()); } }</code> </pre> <br>  Running the code above in Java 8 and then in Java 9 shows the difference: <br><br><pre> <code class="java hljs">$java -version java version <span class="hljs-string"><span class="hljs-string">"1.8.0_121"</span></span> Java(TM) <span class="hljs-function"><span class="hljs-function">SE Runtime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Environment</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1.8</span></span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">.0</span></span></span></span><span class="hljs-function"><span class="hljs-params">_121-b13)</span></span></span><span class="hljs-function"> Java </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HotSpot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TM)</span></span></span><span class="hljs-function"> 64-Bit Server </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VM</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">25.121</span></span></span></span><span class="hljs-function"><span class="hljs-params">-b13, mixed mode)</span></span></span><span class="hljs-function"> $java -cp lib\jol-cli-0.9-full.jar</span></span>;. test.JOLSample java.lang.String@<span class="hljs-number"><span class="hljs-number">4554617</span></span>cd footprint: COUNT AVG SUM DESCRIPTION <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">432</span></span> <span class="hljs-number"><span class="hljs-number">432</span></span> [C <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> java.lang.String <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">456</span></span> (total) ... $java -version java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) <span class="hljs-function"><span class="hljs-function">SE Runtime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Environment</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">9</span></span></span></span><span class="hljs-function"><span class="hljs-params">+</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">181</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Java </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HotSpot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TM)</span></span></span><span class="hljs-function"> 64-Bit Server </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VM</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">9</span></span></span></span><span class="hljs-function"><span class="hljs-params">+</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">181</span></span></span></span><span class="hljs-function"><span class="hljs-params">, mixed mode)</span></span></span><span class="hljs-function"> $java -cp lib\jol-cli-0.9-full.jar</span></span>;. test.JOLSample java.lang.String@<span class="hljs-number"><span class="hljs-number">73035e27</span></span>d footprint: COUNT AVG SUM DESCRIPTION <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">224</span></span> <span class="hljs-number"><span class="hljs-number">224</span></span> [B <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> java.lang.String <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">248</span></span> (total)</code> </pre> <br>  Ignoring the 24-byte size of the internal components of java.lang.String (header plus links), we see that due to its compactness, the size has decreased almost twice. <br>  If we replace the line above with another one using UTF-16 characters, for example, \ u0780, and then restart the code above, then both Java 8 and Java 9 will show the same footprint, since compactness will no longer be used. <br><br>  This feature can be disabled by passing the <code>-XX:-CompactStrings</code> to the <code>java</code> command. <br><br>  As always, we are waiting for your comments and questions here, as well as inviting you to <a href="https://otus.pw/dXvO/">an open lesson</a> . </div><p>Source: <a href="https://habr.com/ru/post/426621/">https://habr.com/ru/post/426621/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426609/index.html">In Office 365 and other MS products will add voice I / O mode for dyslexics</a></li>
<li><a href="../426611/index.html">Integration with SAP ERP, for example with Django-python, using the oData (rest) protocol</a></li>
<li><a href="../426613/index.html">Do not let the 3D printer lazy</a></li>
<li><a href="../426615/index.html">We write CLI on NodeJS</a></li>
<li><a href="../426617/index.html">License to drive a car, or why applications should be Single-Activity</a></li>
<li><a href="../426623/index.html">This is an electric bus: what do we know about transport with a battery</a></li>
<li><a href="../426625/index.html">Multilingual trees in Yii2 on the example of creating a menu module</a></li>
<li><a href="../426627/index.html">Flexbox usage examples</a></li>
<li><a href="../426629/index.html">Trump's Tax Reform Philosophy</a></li>
<li><a href="../426631/index.html">How to update the code of smart contracts in Ethereum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>