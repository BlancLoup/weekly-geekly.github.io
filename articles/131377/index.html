<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SoX port for Android or trying to create the perfect player</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habrayuzer! 

 A few months ago, I had the idea of ‚Äã‚Äãcreating a player for Android with a huge amount of effects. The only one at that time (I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SoX port for Android or trying to create the perfect player</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habrayuzer! <br><img src="https://habrastorage.org/storage1/f1eb096a/b076954e/0f768f7b/984512af.png"><br>  A few months ago, I had the idea of ‚Äã‚Äãcreating a player for Android with a huge amount of effects.  The only one at that time (I don‚Äôt know how it is now :), the player, with at least some sound processing, was PowerAMP, but the amount of audio effects in it was meagerly mild.  I tried to implement this idea.  Little has come of this, but I‚Äôll tell you what happened in this topic.  So, anyone interested, please under the cat. <a name="habracut"></a><br><br><h5>  Looking for a library ... </h5><br><br>  For a start, I decided to find the very OpenSource library that can flexibly process sound using various effects.  In the end, I accidentally met <a href="http://sox.sourceforge.net/">SoX</a> .  At first glance, it was an ideal library for the implementation of such a project, but it turned out that not everything is so simple ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  First problems </h5><br><br>  In the course of my acquaintance with SoX, I discovered the following problems: <br>  1. The library works fine on all major operating systems, but it is not optimized for ARM. <br>  2. The description of the library's API, as well as the API itself, was rather poor; almost all functions were easier to implement via the command line. <br>  3. SoX, instead of using one FFmpeg for decoding, uses a number of libraries (you can look at the official site).  Consequently, all these libraries also have to be collected under the Android NDK. <br>  4. SoX perfectly reproduced and decoded almost any formats, but when applying effects, the audio could either be decoded into a file or byte array, or played through Alsa / CoreAudio.  The third option did not fit unambiguously, since in theory Alsa Android is, in theory, but it does not always work and, in general, this is not the recommended method of sound reproduction.  Therefore, the only option is to decode everything in the byte array and give it to Java (AudioTrack).  But even this turned out to be quite difficult to realize, as ... I will explain with an example :) <br>  Here is part of the official sound processing application example using effects: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_init() == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> = sox_open_read(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/* Change "alsa" in this line to use an alternative audio device driver: */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>= sox_open_write("default", &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, "alsa", <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)); chain = sox_create_effects_chain(&amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>, &amp;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>); e = sox_create_effect(sox_find_effect("input")); args[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-type"><span class="hljs-type">char</span></span> *)<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_effect_options(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, args) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_add_effect(chain, e, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal) == SOX_SUCCESS); e = sox_create_effect(sox_find_effect("trim")); args[<span class="hljs-number"><span class="hljs-number">0</span></span>] = "10", <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_effect_options(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, args) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_add_effect(chain, e, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal.rate != <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;signal.rate) { e = sox_create_effect(sox_find_effect("rate")); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_effect_options(e, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_add_effect(chain, e, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, &amp;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;signal) == SOX_SUCCESS); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal.channels != <span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;signal.channels) { e = sox_create_effect(sox_find_effect("channels")); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_effect_options(e, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_add_effect(chain, e, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, &amp;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;signal) == SOX_SUCCESS); } e = sox_create_effect(sox_find_effect("output")); args[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-type"><span class="hljs-type">char</span></span> *)<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_effect_options(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, args) == SOX_SUCCESS); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_add_effect(chain, e, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;signal, &amp;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>-&gt;signal) == SOX_SUCCESS); sox_flow_effects(chain, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>);</code> </pre> <br>  In this case, the audio is decoded, and several effects are applied, then everything is output through ALSA.  As you can see, in order to create an effect_chain, you must first have 2 threads: for reading and for displaying information.  Here is the official example of decoding an audio file in parts in a byte array: <br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_init() == SOX_SUCCESS); <span class="hljs-comment"><span class="hljs-comment">/* Open the input file (with default parameters) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> = sox_open_read(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)); #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined FIXED_BUFFER <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> = sox_open_mem_write(<span class="hljs-keyword"><span class="hljs-keyword">buffer</span></span>, buffer_size, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">signal</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"sox"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)); #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> = sox_open_memstream_write(&amp;<span class="hljs-keyword"><span class="hljs-keyword">buffer</span></span>, &amp;buffer_size, &amp;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">signal</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"sox"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)); #endif <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((number_read = sox_read(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>, samples, MAX_SAMPLES))) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(sox_write(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>, samples, number_read) == number_read);</code> </pre><br>  As you can see, in this case, the audio is decoded in parts, and the program receives a buffer.  This example is completely working, BUT it is almost impossible to apply effects (which is the purpose of the program), because for this you would have to create a read and write stream to another buffer for each part of the audio (size 16484 bytes) and then process those streams.  It did not work out for me, and in no example has this feature been described. <br>  Then it would be logical to decode all the audio with the use of effects in one buffer, but this option uses a lot of RAM (when I tested it reached 100 MB when decoding a small audio file of 10-11 megabytes). <br><br><h5>  But still decided to try ... </h5><br><br>  Despite these problems, I decided to start porting SoX and all related libraries.  The week went to get acquainted with the Android NDK.  In principle, porting was not a complicated, one-type process, which I described in the last article.  Some libraries have already been compiled (for example, FFmpeg).  In the end, I got a compiled sox.so, which really worked and is working now :) The time has come to solve problem 3. Everything turned out to be not too difficult - I created a separate stream that sends it to the Java program as the buffer fills, and she plays it.  The memory problem is almost solved (after all, it is used a lot, but the application does not drop it).  I got an application that reproduces almost all audio formats and adds effects to it (now a flanger, you can add any other).  On the one hand, it is already possible to continue development, BUT I received two new problems at once: <br><br>  1. The program uses the processor too much (reaches 80% when decoding).  I do not know how to optimize C code under ARM, so I do not see it possible to solve this myself. <br>  2. The program is unstable.  Approximately 1-2 of 10 launches it does not play anything (tested on the Galaxy Tab).  I also could not solve this problem ... <br><br>  Total, so that the work is not lost, I decided to publish all the code on GitHub and write an article here.  <a href="https://github.com/Kyborg2011/SoxPlayer">Link to code.</a>  If someone sees an opportunity to solve these problems - write me in email or in lichku.  I hope my idea will interest someone :) </div><p>Source: <a href="https://habr.com/ru/post/131377/">https://habr.com/ru/post/131377/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131370/index.html">Who is stronger - a whale or an elephant?</a></li>
<li><a href="../131371/index.html">Productivity Future Vision (2011)</a></li>
<li><a href="../131372/index.html">How to use C ++ AMP from C #</a></li>
<li><a href="../131374/index.html">Acer Iconia Tab A100 - video review of the first 7-ki on Honeycomb</a></li>
<li><a href="../131376/index.html">Presentation of Samsung Galaxy Nexus and Android 4.0 (Russian translation)</a></li>
<li><a href="../131378/index.html">People as "sensors"</a></li>
<li><a href="../131380/index.html">Creating your own "television" based on torrent-trackers</a></li>
<li><a href="../131381/index.html">How to decorate your Android for Halloween</a></li>
<li><a href="../131382/index.html">Video interview with Alena Popova with ReactOS project coordinator</a></li>
<li><a href="../131385/index.html">Game Battlefield 3 simulator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>