<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ESP8266 as MQTT Broker for Mobile Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As they say, laziness is the engine of progress. To make life easier, I am currently making myself a small device in the form of an ESP8266 module and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ESP8266 as MQTT Broker for Mobile Application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6bc/00f/9c8/6bc00f9c8df24dcdb0f9798999960df8.jpg" align="left" width="200">  As they say, laziness is the engine of progress.  To make life easier, I am currently making myself a small device in the form of an ESP8266 module and an RS485 converter for communicating with gas analyzers using the Modbus protocol.  In production, there is always a need to connect to devices to perform various kinds of diagnostics using the 485 interface, but each time it is inconvenient to carry a laptop with you, but the mobile phone is always in your pocket. <br><br>  In the process of development, we got a library that allows you to connect directly from the phone to the module and exchange data through the client's MQTT application.  Perhaps someone will also find this solution useful, because there is no need to have a third-party MQTT broker (whether it be a local Raspberry broker or an Internet broker) and an internet connection, which in my case is the most important thing. <br><a name="habracut"></a><br>  <b>Phone application</b> <br><br>  I chose IoTmanager as an application.  The main feature is a very flexible configuration of widgets using HTML5 + CSS, all settings are made in devices, not in the application.  Topics are sent in JSON format and contain header names, values ‚Äã‚Äãand display styles.  Maybe someone will be uncomfortable, but I liked this approach. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The application can work on two MQTT libraries: Paho.js and MQTT.js.  On the move, I managed to establish a WebSocket connection through the Paho library, and I stayed to work on it.  If you select in the MQTT settings, the connection does not occur, I suspect that you need to dig in the WebSocketServer library. <br><br>  <b>I despised Arduino for a long time, but still gave up</b> <br><br>  I don‚Äôt want to make a discussion about the choice of environment, I‚Äôll just say that for me an important role in choosing the Arduino IDE for writing the ESP8266 firmware was played by the presence of tons of ready-made libraries and documentation.  Everything is simple and fast, the benefit of the project promises to be easy. <br><br><div class="spoiler">  <b class="spoiler_title">Offtopic</b> <div class="spoiler_text">  Believe it or not, even the rockets fly into space with microcontrollers programmed in the Arduino environment.  The decisive role is often played by the speed of development - connected ready-made libraries and go. <br></div></div><br>  <b>Open source is our everything</b> <br><br>  <a href="https://github.com/xDWart/MQTTbroker">Repository on github</a> .  The library is still damp, in some cases, the settings of the widgets cause IoTmanager'a reconnect, the reason for which I cannot find yet, perhaps the joint development will go faster. <br><br>  The project contains two library implementations: <br><br>  <b>MQTTbroker.h</b> is an attempt to implement a real broker with subscription controls.  Ie when a message arrives in a topic, the broker goes through all clients and their subscriptions and searches for matches (including the masks / + /) and sends messages only to those whose subscriptions match the name of the topic, not forgetting about themselves. <br><br>  <b>MQTTbroker_lite.h</b> works slightly faster due to the lack of automatic subscription processing logic.  All incoming messages are redirected to the callback function of the main program, and already there, if necessary, we process them ourselves.  For my particular case, this is exactly what is needed: one device - one plug-in client, I know what it is signed for and what it expects from me. <br><br>  <b>Work example</b> <br><br><img src="https://habrastorage.org/files/98e/322/ff8/98e322ff89214dcaa9223c99325290ed.PNG" width="200" align="right"><img src="https://habrastorage.org/files/c16/89d/dab/c1689ddabea040ef8a9cb645715c4c1a.PNG" width="200" align="right">  We take any module from ESP8266 (I have this NodeMcu) and load the example sketch from the library into it.  I propose to disable the debugging port in the Arduino IDE tools, otherwise the library will send a bunch of debugging messages, then look at them.  Open the serial port and observe the IP address. <br><br>  On the phone, connect to the created Wi-Fi access point.  In the IoTmanager application, we go into the connection settings: select the PAHO engine, drive in the module IP address, port 80, the topic prefix / IoTmanager and turn off SSL / TLS just below. <br><br>  We press on the speedometer in the corner, after a small delay, it should connect and display the switches.  If it does not connect, try to kill and re-launch the application.  On the first switch I have an LED set up (see video). <br><br>  Sometimes there is a delay in connecting.  I think this is due to the fact that IoTmanager issues all initial messages at once, ESP hangs a little, processing them, and then it works without brakes. <br><br>  <b>Short description</b> <br><br>  Both parts of the library are very similar, I will give a description of the _lite version: <br><br><pre><code class="javascript hljs">typedef <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(*callback_t)(uint8_t num, Events_t event , <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> topic_name, uint8_t * payload, uint8_t length_payload); <span class="hljs-comment"><span class="hljs-comment">// callback'a     MQTTbroker_lite(WebSocketsServer * webSocket); //     WebSocket void setCallback(callback_t cb); //  callback'a void begin(void); //  ( ) void parsing(uint8_t num, uint8_t * payload, uint8_t length); //   WS  void publish(uint8_t num, String topic, uint8_t* payload, uint8_t length); //   num void disconnect(uint8_t num); //  bool clientIsConnected(uint8_t num); //   </span></span></code> </pre> <br>  <b>Video demo</b> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d3HHZ1MDf8c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Thanks for attention.  Join the development, the library is still damp. <br>  For help, you can contact Telegram <a href="https://habrahabr.ru/users/owart/" class="user_link">oWart</a> <br><br>  <b>References:</b> <br><br>  1. <a href="https://github.com/xDWart/MQTTbroker">Project on GitHub</a> <br>  2. <a href="http://iotmanager.ru/ru/widgets-guide/">Description of IoTmanager widgets</a> <br>  3. <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/csprd02/mqtt-v3.1.1-csprd02.html">MQTT v.3.1.1 protocol specification</a> </div><p>Source: <a href="https://habr.com/ru/post/326794/">https://habr.com/ru/post/326794/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326784/index.html">What famous companies use Docker in production and for what?</a></li>
<li><a href="../326786/index.html">Do not believe the navigator: GPS and GLONASS vulnerabilities</a></li>
<li><a href="../326788/index.html">GA Measurement Protocol - complete guide</a></li>
<li><a href="../326790/index.html">About safety, nuclear physics and love: about the contradictions of modern IT architecture of front-end solutions</a></li>
<li><a href="../326792/index.html">Online Ticket Act: Let's Put A Point? Electronic money and aggregators</a></li>
<li><a href="../326796/index.html">Fighting HTTPS traffic interception. Experience Yandex Browser</a></li>
<li><a href="../326798/index.html">Why should you go?</a></li>
<li><a href="../326802/index.html">Dictionary Browser Extension: More Than an Online Translator</a></li>
<li><a href="../326804/index.html">Hello, Habr</a></li>
<li><a href="../326806/index.html">RubyMine 2017.1: Docker, RuboCop, autogenerate Rails tests, improvements for Puppet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>