<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gitphp in badoo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Badoo is a project with a giant git repository, in which there are thousands of branches and tags. We use a highly modified GitPHP ( http://gitphp.org...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gitphp in badoo</h1><div class="post__text post__text-html js-mediator-article">  Badoo is a project with a giant git repository, in which there are thousands of branches and tags.  We use a highly modified GitPHP ( <a href="http://gitphp.org/">http://gitphp.org</a> ) version 0.2.4, which we have done a lot of add-ons (including integration with our workflow in JIRA, organization of the review process, etc.).  In general, we were satisfied with this product until we began to notice that our main repository opens for more than 20 seconds.  And today we will talk about how we investigated the performance of GitPHP and what results we achieved by solving this problem. <br><br><h4>  Timer setting </h4><br>  When developing badoo.com in a developer environment, we use a very simple debug panel for setting up timers and debugging SQL queries.  Therefore, the first thing we did was remake it in GitPHP and began to measure the execution time of the code sections, not taking into account the nested timers.  This is what our debug panel looks like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/467/877/439/4678774393e550ee0d2eadd5df17eae7.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first column contains the name of the method (or action) being called, the second contains additional information: arguments for starting, beginning of the output of the command and trace.  The last column is the time spent on the call (in seconds). <br><a name="habracut"></a><br>  Here is a short excerpt from the implementation of the timers themselves: <br><br><pre><code class="hljs bash">&lt;?php class GitPHP_Log { // ... public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timerStart</span></span></span></span>() { array_push(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;timers, microtime(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> timerStop(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>, <span class="hljs-variable"><span class="hljs-variable">$value</span></span> = null) { <span class="hljs-variable"><span class="hljs-variable">$timer</span></span> = array_pop(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;timers); <span class="hljs-variable"><span class="hljs-variable">$duration</span></span> = microtime(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) - <span class="hljs-variable"><span class="hljs-variable">$timer</span></span>; //      ,     foreach (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;timers as &amp;<span class="hljs-variable"><span class="hljs-variable">$item</span></span>) <span class="hljs-variable"><span class="hljs-variable">$item</span></span> += <span class="hljs-variable"><span class="hljs-variable">$duration</span></span>; <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;Log(<span class="hljs-variable"><span class="hljs-variable">$name</span></span>, <span class="hljs-variable"><span class="hljs-variable">$value</span></span>, <span class="hljs-variable"><span class="hljs-variable">$duration</span></span>); } // ... }</code> </pre> <br>  Using this API is very simple.  At the beginning of the measured code, <code>timerStart()</code> is called, at the end - <code>timerStop()</code> with the name of the timer and optional additional data: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> $Log = </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">new</span></span></span><span class="php"> GitPHP_Log; $Log-&gt;timerStart(); $result = </span><span class="hljs-number"><span class="php"><span class="hljs-number">0</span></span></span><span class="php">; $mult = </span><span class="hljs-number"><span class="php"><span class="hljs-number">4</span></span></span><span class="php">; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">for</span></span></span><span class="php"> ($i = </span><span class="hljs-number"><span class="php"><span class="hljs-number">1</span></span></span><span class="php">; $i &lt; </span><span class="hljs-number"><span class="php"><span class="hljs-number">1000000</span></span></span><span class="php">; $i+=</span><span class="hljs-number"><span class="php"><span class="hljs-number">2</span></span></span><span class="php">) { $result += $mult / $i; $mult = -$mult; } $Log-&gt;timerStop(</span><span class="hljs-string"><span class="php"><span class="hljs-string">"PI computation"</span></span></span><span class="php">, $result);</span></span></code> </pre><br>  In this case, calls can be nested, and the above class will take this into account when calculating. <br><br>  For easier debugging of the code inside Smarty, we made ‚Äúauto-timers‚Äù.  They make it easy to measure the time spent on the work of methods with multiple exit points (many places where return is performed): <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-class"><span class="hljs-keyword"><span class="php"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="php"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-class"><span class="hljs-title">GitPHP_DebugAutoLog</span></span></span></span><span class="php"><span class="hljs-class"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">private</span></span></span><span class="php"> $name; </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">public</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;name = $name; GitPHP_Log::GetInstance()-&gt;timerStart(); } </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">public</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ GitPHP_Log::GetInstance()-&gt;timerStop(</span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">$this</span></span></span><span class="php">-&gt;name); } }</span></span></code> </pre><br>  Using such a class is very simple: you need to insert <code>$Log = new GitPHP_DebugAutoLog('timer_name');</code>  the time of its execution will be automatically measured at the beginning of any function or method, and when exiting the function: <br><br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="php"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="php"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="php"><span class="hljs-function"><span class="hljs-title">doSomething</span></span></span></span><span class="hljs-params"><span class="php"><span class="hljs-function"><span class="hljs-params">($a)</span></span></span></span><span class="php"><span class="hljs-function"> </span></span></span><span class="php">{ $Log = GitPHP_DebugAutoLog(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'doSomething'</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">if</span></span></span><span class="php"> ($a &gt; </span><span class="hljs-number"><span class="php"><span class="hljs-number">5</span></span></span><span class="php">) { </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">echo</span></span></span><span class="php"> </span><span class="hljs-string"><span class="php"><span class="hljs-string">"Hello world!\n"</span></span></span><span class="php">; sleep(</span><span class="hljs-number"><span class="php"><span class="hljs-number">5</span></span></span><span class="php">); </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">return</span></span></span><span class="php">; } sleep(</span><span class="hljs-number"><span class="php"><span class="hljs-number">1</span></span></span><span class="php">); }</span></span></code> </pre><br><h4>  Thousands of calls to git cat-file -t &lt;commit&gt; </h4><br>  Thanks to the set timers, we were quickly able to find where GitPHP version 0.2.4 was spending most of the time.  For each tag in the repository, one call to <code>git cat-file -t</code> only to find out the type of commit and whether this commit is a ‚Äúlightweight tag‚Äù ( <a href="http://git-scm.com/book/en/Git-Basics-Tagging">http://git-scm.com/book/en/Git-Basics -Tagging # Lightweight-Tags</a> ).  Lightweight tags in Git is a type of tag that is created by default and contains a link to a specific commit.  Since no other tag types were present in our repository, we simply removed this check and saved a couple of thousand <code>git cat-file -t,</code> calls <code>git cat-file -t,</code> took about 20 seconds. <br><br>  How did it happen that GitPHP needed to find out for each tag in the repository whether it is ‚Äúlightweight‚Äù?  It's pretty simple. <br><br>  On all GitPHP pages, near the commit, there are branches and tags that point to it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a9/a89/ea4/7a9a89ea4e47536d608ad436041c75f2.png"><br><br>  To do this, the <code>GitPHP_TagList</code> class has a method that is responsible for getting a list of tags that reference the specified commit: <br><br><pre> <code class="hljs perl">&lt;?php class GitPHP_TagList extends GitPHP_RefList { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... public function GetCommitTags($commit) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$commit) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array(); $commitHash = $commit-&gt;GetHash(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$this-&gt;dataLoaded) $this-&gt;LoadData(); $tags = array(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($this-&gt;refs as $tag =&gt; $hash) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset($this-&gt;commits[$tag])) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $tagObj = $this-&gt;project-&gt;GetObjectManager()-&gt;GetTag($tag, $hash); $tagCommitHash = $tagObj-&gt;GetCommitHash(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($tagCommitHash == $commitHash) { $tags[] = $tagObj; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $tags; } // ... }</code> </pre><br>  Those.  For each commit for which you want to get a list of tags, the following is done: <br><br><ol><li>  The first call loads a list of all tags in the repository (call LoadData ()). </li><li>  Enumerates all tags. </li><li>  For each tag, the corresponding object is loaded. </li><li>  GetCommitHash () is called on the tag object and the resulting value is compared with the desired one. </li></ol><br>  Apart from the fact that you can first create a map of the form <code>array( commit_hash =&gt; array(tags) )</code> , you need to pay attention to the <code>GetCommitHash()</code> method: it calls the <code>Load($tag)</code> method, which, when implemented using an external Git utility, does the following: <br><br><pre> <code class="hljs bash">&lt;?php class GitPHP_TagLoad_Git implements GitPHP_TagLoadStrategy_Interface { // ... public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> Load(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>) { // ... <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-string"><span class="hljs-string">'-t'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$tag</span></span>-&gt;GetHash(); <span class="hljs-variable"><span class="hljs-variable">$ret</span></span> = trim(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;exe-&gt;Execute(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>-&gt;GetProject()-&gt;GetPath(), GIT_CAT_FILE, <span class="hljs-variable"><span class="hljs-variable">$args</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ret</span></span> === <span class="hljs-string"><span class="hljs-string">'commit'</span></span>) { // ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array(/* ... */); } // ... <span class="hljs-variable"><span class="hljs-variable">$ret</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;exe-&gt;Execute(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>-&gt;GetProject()-&gt;GetPath(), GIT_CAT_FILE, <span class="hljs-variable"><span class="hljs-variable">$args</span></span>); // ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array(/* ... */); } }</code> </pre><br>  Those.  To show which branches and tags are included in a commit, GitPHP loads a list of all tags and calls git cat-file -t for each one.  Not bad, Christopher, keep it up! <br><br><h4>  Hundreds of git rev-list calls --max-count = 1 ... &lt;commit&gt; </h4><br>  The situation is similar with the commit information.  To load the date, the commit message, the author, etc., each time git rev-list was called - max-count = 1 ... &lt;commit&gt;.  This operation is also not free: <br><br><pre> <code class="hljs bash">&lt;?php class GitPHP_CommitLoad_Git extends GitPHP_CommitLoad_Base { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> Load(<span class="hljs-variable"><span class="hljs-variable">$commit</span></span>) { // ... /* get data from git_rev_list */ <span class="hljs-variable"><span class="hljs-variable">$args</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-string"><span class="hljs-string">'--header'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-string"><span class="hljs-string">'--parents'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-string"><span class="hljs-string">'--max-count=1'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-string"><span class="hljs-string">'--abbrev-commit'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$args</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$commit</span></span>-&gt;GetHash(); <span class="hljs-variable"><span class="hljs-variable">$ret</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;exe-&gt;Execute(<span class="hljs-variable"><span class="hljs-variable">$commit</span></span>-&gt;GetProject()-&gt;GetPath(), GIT_REV_LIST, <span class="hljs-variable"><span class="hljs-variable">$args</span></span>); // ... <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( // ... ); } // ... }</code> </pre><br><h4>  Solution: batch commit loading (git cat-file --batch) </h4><br>  In order not to make many single calls to git cat-file, Git allows you to load many commits at once using the --batch option.  At the same time, it takes a list of commits to stdin, and writes the result to stdout.  Accordingly, you can first write to the file all the hashes of commits that we need, run <code>git cat-file --batch</code> and load all the results at once. <br><br>  Here is an example of the code that does this (the code is given for the version of GitPHP 0.2.4 and the operating systems of the * nix family): <br><br><pre> <code class="hljs perl">&lt;?php class GitPHP_Project { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... public function BatchReadData(array $hashes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!count($hashes)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array(); $outfile = tempnam(<span class="hljs-string"><span class="hljs-string">'/tmp'</span></span>, <span class="hljs-string"><span class="hljs-string">'objlist'</span></span>); $hashlistfile = tempnam(<span class="hljs-string"><span class="hljs-string">'/tmp'</span></span>, <span class="hljs-string"><span class="hljs-string">'objlist'</span></span>); file_put_contents($hashlistfile, implode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, $hashes)); $Git = new GitPHP_GitExe($this); $Git-&gt;Execute(GIT_CAT_FILE, array(<span class="hljs-string"><span class="hljs-string">'--batch'</span></span>, <span class="hljs-string"><span class="hljs-string">' &lt; '</span></span> . escapeshellarg($hashlistfile), <span class="hljs-string"><span class="hljs-string">' &gt; '</span></span> . escapeshellarg($outfile))); <span class="hljs-keyword"><span class="hljs-keyword">unlink</span></span>($hashlistfile); $fp = fopen($outfile, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">unlink</span></span>($outfile); $types = $contents = array(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($fp)) { $ln = rtrim(fgets($fp)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$ln) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; list($hash, $type, $n) = explode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, rtrim($ln)); $contents[$hash] = fread($fp, $n); $types[$hash] = $type; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array(<span class="hljs-string"><span class="hljs-string">'contents'</span></span> =&gt; $contents, <span class="hljs-string"><span class="hljs-string">'types'</span></span> =&gt; $types); } // ... }</code> </pre><br>  We began to use this function for most of the pages where information about commits is displayed (i.e., we collect a list of commits and load them all with one call to <code>git cat-file --batch</code> ).  This optimization reduced the average page load time from more than 20 seconds to 0.5 seconds.  So we solved the problem of slow GitPHP in our project. <br><br><h4>  Open-source: optimizing GitPHP 0.2.9 (master) </h4><br>  A little thought, we realized that it was possible not to rewrite all the code to use <code>git cat-file --batch</code> .  Although not documented, this command allows you to download information one commit at a time, without losing performance!  During operation, one line is read from the standard input and the results are sent to the standard output without buffering.  This means that we can open <code>git cat-file --batch</code> via <code>proc_open()</code> and get the results immediately, without reworking the architecture! <br><br>  Here is an excerpt from the implementation (error handling is removed for readability): <br><br><pre> <code class="hljs bash">&lt;?php // ... class GitPHP_GitExe implements GitPHP_Observable_Interface { // ... public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> GetObjectData(<span class="hljs-variable"><span class="hljs-variable">$projectPath</span></span>, <span class="hljs-variable"><span class="hljs-variable">$hash</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$process</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;GetProcess(<span class="hljs-variable"><span class="hljs-variable">$projectPath</span></span>); <span class="hljs-variable"><span class="hljs-variable">$pipes</span></span> = <span class="hljs-variable"><span class="hljs-variable">$process</span></span>[<span class="hljs-string"><span class="hljs-string">'pipes'</span></span>]; <span class="hljs-variable"><span class="hljs-variable">$data</span></span> = <span class="hljs-variable"><span class="hljs-variable">$hash</span></span> . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; fwrite(<span class="hljs-variable"><span class="hljs-variable">$pipes</span></span>[0], <span class="hljs-variable"><span class="hljs-variable">$data</span></span>); fflush(<span class="hljs-variable"><span class="hljs-variable">$pipes</span></span>[0]); <span class="hljs-variable"><span class="hljs-variable">$ln</span></span> = rtrim(fgets(<span class="hljs-variable"><span class="hljs-variable">$pipes</span></span>[1])); <span class="hljs-variable"><span class="hljs-variable">$parts</span></span> = explode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, rtrim(<span class="hljs-variable"><span class="hljs-variable">$ln</span></span>)); list(<span class="hljs-variable"><span class="hljs-variable">$hash</span></span>, <span class="hljs-variable"><span class="hljs-variable">$type</span></span>, <span class="hljs-variable"><span class="hljs-variable">$n</span></span>) = <span class="hljs-variable"><span class="hljs-variable">$parts</span></span>; <span class="hljs-variable"><span class="hljs-variable">$contents</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (strlen(<span class="hljs-variable"><span class="hljs-variable">$contents</span></span>) &lt; <span class="hljs-variable"><span class="hljs-variable">$n</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$buf</span></span> = fread(<span class="hljs-variable"><span class="hljs-variable">$pipes</span></span>[1], min(4096, <span class="hljs-variable"><span class="hljs-variable">$n</span></span> - strlen(<span class="hljs-variable"><span class="hljs-variable">$contents</span></span>))); <span class="hljs-variable"><span class="hljs-variable">$contents</span></span> .= <span class="hljs-variable"><span class="hljs-variable">$buf</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'contents'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$contents</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$type</span></span>, ); } // ... }</code> </pre><br>  Considering that we can now very quickly load the contents of objects without making a call to the git command each time, it became easy to get a big performance boost: you just need to change all the <code>git cat-file</code> and <code>git rev-list</code> calls to a call to our optimized function. <br><br>  We collected all the changes into one commit and sent a pull-request to the GitPHP developer.  After some time, the patch was accepted!  Here is this commit: <br><br>  <a href="http://source.gitphp.org/projects/gitphp.git/commitdiff/3c87676b3afe4b0c1a1f7198995cecc176200482">source.gitphp.org/projects/gitphp.git/commitdiff/3c87676b3afe4b0c1a1f7198995cec17170000482</a> <br><br>  The author made some corrections to the code (by separate commits), and now in the master branch there is a significantly accelerated version of GitPHP!  To use optimizations, you need to turn off the ‚Äúcompatibility mode‚Äù, that is, set <code>$compat = false;</code>  in the configuration. <br><br>  Yuri <a href="https://habrahabr.ru/users/yourock/" class="user_link">youROCK,</a> Nasretdinov, PHP developer, Badoo <br>  Eugene <a href="https://habrahabr.ru/users/ezh/" class="user_link">eZH</a> Makhrov, QA Engineer, Badoo </div><p>Source: <a href="https://habr.com/ru/post/200946/">https://habr.com/ru/post/200946/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200930/index.html">Nibbler is a computer of 17 chips. With discrete TTL processor</a></li>
<li><a href="../200934/index.html">Timelapse with elements of video surveillance</a></li>
<li><a href="../200936/index.html">Batch data retrieval in Sharepoint 2010</a></li>
<li><a href="../200940/index.html">How we officially became the media</a></li>
<li><a href="../200942/index.html">Launch ChromeOS from USB stick</a></li>
<li><a href="../200948/index.html">Pick 3: How to "open" the microcircuit and what's inside? Soviet Z80, TTL Logic, FPGA Altera Cyclone I and others</a></li>
<li><a href="../200950/index.html">Training data architects: designing and modeling information systems using ER / Studio</a></li>
<li><a href="../200952/index.html">We work with the developer version of CKEditor 4</a></li>
<li><a href="../200954/index.html">Recommendations for using SQLite on mobile devices</a></li>
<li><a href="../200956/index.html">IKEA self-assembling stools and tomorrow's substance programming technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>