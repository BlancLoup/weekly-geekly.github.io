<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We include support for TLS v1.3 in Nginx using the example of Debian 9</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 

 This post was written as a result of the victory of the desire to get to the bottom of fatigue, sleepiness, the temptation to over...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We include support for TLS v1.3 in Nginx using the example of Debian 9</h1><div class="post__text post__text-html js-mediator-article">  Good day to all! <br><br>  This post was written as a result of the victory of the desire to get to the bottom of fatigue, sleepiness, the <s>temptation to overturn another bottle of beer on Friday evening.</s>  I‚Äôll say right away that I don‚Äôt reveal anything super complicated, just the inclusion of TLS v1.3 in Nginx. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/j4/4k/mw/j44kmwpwfgiemhc7njcfvhcy7_o.png" alt="image"></div><br>  Surely there will be on Habr√© those who have already done it 100 times, so this article is more for beginners or for those who want to find a ready-made solution in the form of a manual without spending a lot of time searching, like me, for example.  Remembering that he hadn‚Äôt written on Habr√© for a long time and putting the article ‚Äútutorial‚Äù on the article, set to work. <br><a name="habracut"></a><br>  A quick search on Habr showed that there were no posts on this topic, and there was a <a href="https://toster.ru/q/442843">topic</a> on the ‚Äútoaster‚Äù where the questioner was answered in the comments in the style of ‚Äúthe fool himself‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It turns out that the question remains unanswered, at least I did not find working manuals in open access.  Not good, you need to fix the situation :) <br><br>  It all started with the fact that once again setting up an SSL certificate from Letsencrypt (the certificate issuer is completely irrelevant for this article), when everything seemed to be fine, <br><img src="https://habrastorage.org/webt/xl/qf/8i/xlqf8i8gqmgesfvc_acd9qz8u4k.jpeg" alt="image"><br>  <i>(test SSL certificate settings on ssllabs.com, review)</i> <br><br>  and it would be easy to close the task in Jira and go home, but then my eye was drawn to the item on support for TLS 1.3.  More precisely, it was stated there that this very support for TLS 1.3 is just not there! <br><br><img src="https://habrastorage.org/webt/59/cr/rh/59crrhm7t4cwz0igrgac2ulmb74.jpeg" alt="image"><br>  <i>(test SSL certificate settings on ssllabs.com, details)</i> <br><br>  Well, as they say, <br><br><img src="https://habrastorage.org/webt/0x/-y/-n/0x-y-nz9ennchgbdbo8r07vjtyw.jpeg" alt="image"><br><br>  Of course, I have seen this point before, but somehow did not attach any importance, everything was not up to that.  And this time he said to himself mentally: ‚Äúenough is to endure it!‚Äù We still have to figure out how to enable the new protocol. <br><br>  A little background.  Exit TLS v1.3 is not the news of the last days, work on the new version has been going on for many years.  Almost 10 years have passed since the announcement of TLS v1.2.  And so, <a href="http://mailman.nginx.org/pipermail/nginx-announce/2017/000195.html">in April 2017,</a> the nginx version 1.13.0 was released, which supports TLS v1.3. <br><br>  If a respected reader thinks that it is enough to install nginx&gt; = 1.13.0 and prescribe <br><br><pre><code class="bash hljs">ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;</code> </pre> <br>  in the virtualhost settings, do not rush to draw conclusions and disperse, I also fell for this ‚Äúdivorce‚Äù :) <br><br>  With the installed version of nginx&gt; = 1.13.0 and in the presence of the above line in the config <br><br><pre> <code class="bash hljs">nginx -t</code> </pre> <br>  no errors, this is a plus, but the <a href="https://www.ssllabs.com/ssltest/">ssllabs</a> test shows that TLS 1.3 is still not included, and this is a big minus. <br><br>  Later, having studied the requirements, I realized that it is possible to make the new version of the protocol work by compiling nginx&gt; = 1.13.0 with support for openssl&gt; = 1.1.1, which is currently being developed, and the <a href="https://github.com/openssl/openssl/tree/tls1.3-draft-18">draft version of the protocol is strictly 18.</a> If you take other versions of draft, the result will be different.  I didn‚Äôt go into details, for some reason at the moment they were based on the 18th version of the draft, which ssllabs kindly reports in my disclaimer in the test results <br><br><img src="https://habrastorage.org/webt/2l/vc/en/2lvcen1uvci0sturli4x3vzdjqs.jpeg" alt="image"><br>  <i>(test SSL certificate settings on ssllabs.com, details)</i> <br><br>  <b>Procedure:</b> <br><br>  1. Save the contents of <b>/ etc / nginx</b> somewhere in / backup, if you have already configured the required virtualhost, so as not to do it all over again.  You can immediately make <br><br><pre> <code class="bash hljs">apt-get remove --purge nginx</code> </pre> <br>  2. Download and unpack the sources of openssl 1.1.1 <a href="">tls1.3 draft 18.</a> <br><br><pre> <code class="bash hljs">wget https://github.com/openssl/openssl/archive/tls1.3-draft-18.zip</code> </pre> <br>  3. Preparatory work for openssl <br><br><pre> <code class="bash hljs">apt-get install build-essential libpcre3 libpcre3-dev zlib1g-dev checkinstall</code> </pre> <br>  4. Build openssl. <br><br>  Go to the directory with the unzipped contents of the openssl archive <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> openssl-tls1.3-draft-18</code> </pre> <br><pre> <code class="bash hljs">./config</code> </pre> <br><pre> <code class="bash hljs">make &amp;&amp; make install</code> </pre> <br>  5. Preparatory work for nginx <br><br><pre> <code class="bash hljs">apt-get build-dep nginx</code> </pre> <br><pre> <code class="bash hljs">apt-get install libossp-uuid-dev</code> </pre> <br><pre> <code class="bash hljs">apt-get install libxml2 libxml2-dev</code> </pre> <br><pre> <code class="bash hljs">apt-get install libxslt-dev</code> </pre> <br><pre> <code class="bash hljs">apt-get install libgd-dev</code> </pre> <br><pre> <code class="bash hljs">apt-get install libgeoip-dev</code> </pre> <br><pre> <code class="bash hljs">wget http://nginx.org/download/nginx-1.13.7.tar.gz</code> </pre> <br><pre> <code class="bash hljs">tar xvf nginx-1.13.7.tar.gz</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.13.7</code> </pre> <br><pre> <code class="bash hljs">./configure --with-cc-opt=<span class="hljs-string"><span class="hljs-string">'-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2'</span></span> --with-ld-opt=<span class="hljs-string"><span class="hljs-string">'-Wl,-z,relro -Wl,-z,now'</span></span> --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --modules-path=/usr/lib/nginx/modules --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-file-aio --with-threads --with-http_addition_module --with-http_geoip_module=dynamic --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_secure_link_module --with-http_sub_module --with-http_xslt_module=dynamic --with-stream=dynamic --with-stream_ssl_module --with-mail=dynamic --with-mail_ssl_module --with-ld-opt=-lossp-uuid --with-cc-opt=-I/usr/include/ossp --with-openssl=/root/openssl-tls1.3-draft-18 --with-openssl-opt=<span class="hljs-string"><span class="hljs-string">'enable-tls1_3'</span></span></code> </pre> <br>  When running the nginx configurator, it is important to specify the correct path to the unpacked openssl source code of the version we need.  I have this /root/openssl-tls1.3-draft-18, if you have a different path to the openssl source directory, then make changes to the option --with-openssl =. <br><br>  At the stage of execution of the openssl and / or nginx configurator, errors may appear, mainly treated with ordinary googling.  As a rule, there will be some lack of lib, nothing special. <br>  90% is solved by taking the name of the component / package that the configurator did not find and do <br><br><pre> <code class="bash hljs">apt-get install [ ]-dev</code> </pre> <br>  and run the configurator again.  Repeat the procedure until the configurator runs without errors. <br><br>  Then <br><br><pre> <code class="bash hljs">gawk -i inplace <span class="hljs-string"><span class="hljs-string">'/pthread/ { sub(/-lpthread /, ""); sub(/-lpthread /, ""); sub(/\\/, "-lpthread \\"); print } ! /pthread/ { print }'</span></span> <span class="hljs-string"><span class="hljs-string">"objs/Makefile"</span></span></code> </pre> <br>  The last command fixes the nginx compilation bug.  It is connected with the fact that openssl v1.1.1 is now only at the development stage, and in nginx about this something is <a href="https://github.com/openssl/openssl/issues/3884">not taken into account at the moment</a> . <br><br>  6. Compiling nginx <br><br>  Run <br><br><pre> <code class="bash hljs">make</code> </pre> <br>  After successful compilation do not rush to <b>make make install</b> , it is better to make everything beautiful <br><br><pre> <code class="bash hljs">mkdir /usr/lib/nginx</code> </pre> <br><pre> <code class="bash hljs">mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/</code> </pre> <br><pre> <code class="bash hljs">mkdir -p /var/lib/nginx/body</code> </pre> <br><pre> <code class="bash hljs">checkinstall --pkgname=nginx --pkgversion=1.13.7 --nodoc</code> </pre> <br>  It is necessary to create directories before performing checkinstall, since after building the deb package, an attempt will be made to install it into the system, if some directory is not enough, it will fail. <br><br>  At this stage, nginx should be installed on the system, but if you run <br><br><pre> <code class="bash hljs">nginx -t</code> </pre> <br>  will indicate that nginx - there is no such command / binary.  Do not be in a hurry to get upset, the whole thing is that it is not installed completely along the standard PATH path, but here it is / usr / share / nginx / sbin / nginx <br><br>  Therefore, it is necessary to perform <br><br><pre> <code class="bash hljs">/usr/share/nginx/sbin/nginx -t</code> </pre> <br>  To be beautiful, we will do <br><br><pre> <code class="bash hljs">ln -s /usr/share/nginx/sbin/nginx /usr/sbin/nginx</code> </pre> <br>  and then we run <br><br><pre> <code class="bash hljs">nginx -t</code> </pre> <br>  yourself on health and without mistakes. <br><br>  A small minus - after the installation of nginx there is neither an init.d script, nor a config for systemd. <br>  It is treated as follows (one of the ways): <br><br><pre> <code class="bash hljs">vim /lib/systemd/system/nginx.service</code> </pre> <br>  this is a new file, we create it ourselves, enter the contents <br><br><pre> <code class="bash hljs">[Unit] Description=A high performance web server and a reverse proxy server After=network.target [Service] Type=forking PIDFile=/run/nginx.pid ExecStartPre=/usr/share/nginx/sbin/nginx -t -q -g <span class="hljs-string"><span class="hljs-string">'daemon on; master_process on;'</span></span> ExecStart=/usr/share/nginx/sbin/nginx -g <span class="hljs-string"><span class="hljs-string">'daemon on; master_process on;'</span></span> ExecReload=/usr/share/nginx/sbin/nginx -g <span class="hljs-string"><span class="hljs-string">'daemon on; master_process on;'</span></span> -s reload ExecStop=-/sbin/start-stop-daemon --quiet --stop --retry QUIT/5 --pidfile /run/nginx.pid TimeoutStopSec=5 KillMode=mixed [Install] WantedBy=multi-user.target</code> </pre> <br>  Then <br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> nginx.service</code> </pre> <br>  Returning the nginx directory from / backup to / etc, it is better to remove / etc / nginx before this, since something was put there after running checkinstall and dpkg -i <br><br>  Ready to run nginx <br><br><pre> <code class="bash hljs">systemctl start nginx</code> </pre> <br>  Everything should go up, if not, a little troubleshooting will even be useful. <br><br>  Another little touch.  You need to tweak nginx virtualhost, activate the new cipher suite. <br><br>  I don‚Äôt remember exactly, but it took more than an hour to find the source where the ciphers were mentioned, and that in TLS 1.3 they should be like this: <br><br><pre> <code class="bash hljs">ssl_ciphers TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-256-GCM-SHA384:ECDHE:!COMPLEMENTOFDEFAULT;</code> </pre> <br>  In general, the nginx configuration I got is this: <br><br><pre> <code class="bash hljs">server { listen 443 ssl http2; server_name tls1.3.netforce.ua; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/tls1.3.netforce.ua_access.log combined; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/tls1.3.netforce.ua_error.log; ssl on; ssl_dhparam /etc/nginx/dhparam.pem; ssl_certificate <span class="hljs-string"><span class="hljs-string">"/etc/nginx/ssl/server.crt"</span></span>; ssl_certificate_key <span class="hljs-string"><span class="hljs-string">"/etc/nginx/ssl/server.key"</span></span>; add_header Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000"</span></span>; ssl_ciphers TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-256-GCM-SHA384:ECDHE:!COMPLEMENTOFDEFAULT; ssl_prefer_server_ciphers on; ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; root /var/www/tls1.3; index index.html; } server { listen 80; server_name tls1.3.netforce.ua; rewrite ^(.*)$ https://tls1.3.netforce.ua<span class="hljs-variable"><span class="hljs-variable">$1</span></span> permanent; }</code> </pre><br>  This is not a ready-made configuration for the production environment, there is no caching, compression, and other useful and important things.  Let me remind you, the purpose of the article is to activate TLS 1.3 only. <br><br>  After editing, we check that everything is fine <br><br><pre> <code class="bash hljs">nginx -t</code> </pre> <br>  If so, restart nginx and run the ssllabs test.  It should be like this <br><br><img src="https://habrastorage.org/webt/7u/tt/cr/7uttcr795nxxgsqsait4zg1ttp4.jpeg" alt="image"><br><br>  and so <br><br><img src="https://habrastorage.org/webt/0l/_f/lq/0l_flqrpjo82k_izj3h7vbnxoh8.jpeg" alt="image"><br><br>  How to enable TLS 1.3 support in Chrome and Firefox browsers, in order to test the new protocol it was possible directly on the local machine, you can find it <a href="https://www.ghacks.net/2017/06/15/how-to-enable-tls-1-3-support-in-firefox-and-chrome/">here.</a> <br><br>  On this you can just calm down and go home :) <br><br>  I hope someone will be useful.  Thank! </div><p>Source: <a href="https://habr.com/ru/post/345364/">https://habr.com/ru/post/345364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345348/index.html">Adapting RoboVM for compiling for iOS from Windows / Linux</a></li>
<li><a href="../345350/index.html">Adding 3D objects to video</a></li>
<li><a href="../345356/index.html">Universal Dumper / Injector Unity3D (Mono, Android)</a></li>
<li><a href="../345358/index.html">Creating a Christmas animation with Wolfram Language</a></li>
<li><a href="../345362/index.html">Monte Carlo option premium calculation vs Black-Scholes formula</a></li>
<li><a href="../345366/index.html">Richard Hamming: "There are thoughts you can't think about"</a></li>
<li><a href="../345368/index.html">A selection of tutorials on AR / VR</a></li>
<li><a href="../345370/index.html">POWA-like PostgreSQL Monitoring with Prometheus</a></li>
<li><a href="../345372/index.html">Dagger 2 for novice Android developers. Dagger 2. Advanced. Part 1</a></li>
<li><a href="../345374/index.html">Mikrotik RoS 6.41: Big Changes in Bridging and VLAN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>