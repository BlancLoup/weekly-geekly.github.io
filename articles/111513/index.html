<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering android applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will try to tell you about reverse-engineering applications for android. This process is somewhat different from the one for win-app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering android applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/70/05/700561b03dd827013e69fb68e7f33778.png" alt="Picture"><br><a name="habracut"></a><br><br>  In this article I will try to tell you about reverse-engineering applications for android.  This process is somewhat different from the one for win-applications: there is no debugger and no assembler, instead LogCat and byte-code appear.  As you may have guessed, we will explore the application with the aim of hacking it, or, more simply, ‚Äúquack‚Äù. <br><br><h2>  BRIEFING </h2><br>  As a guinea pig, I chose the Multi Mount SD-Card program.  Its essence is to mount the flash drive of the device while simultaneously accessing the system and the user.  The fact is that by default, android does not have access to the currently mounted drive.  For Eclair users, this is not so critical, but here Froyo + users <strike>pee with boiling water are</strike> not happy when the programs installed on the card crash when mounted.  Actually, this program was written to solve this problem.  Oh yeah, the program needs <strong>root</strong> rights. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, we need a distribution package of the program, so that there is something to break.  But where to get it?  After all, you need to buy it.  Well, or beg for someone who has already bought.  Such a person became <a href="http://4pda.ru/forum/index.php%3Fshowuser%3D587074">creage</a> from the forum <a href="http://4pda.ru/forum/index.php%3Fact%3Didx">w3bsit3-dns.com</a> , which was kindly shared by the purchased apk. <br><br>  So, <a href="http://db.tt/g3feJvG">we have a distribution kit</a> , we have already installed the program, we start ... And then bang!  We see a <a href="">window</a> with an offer to buy a license.  From this it follows that the test goes via the Internet, we try to disable it - it does not help.  The buyer does not give the application any keys and logins, which tells us about the binding to something like hardware_id or google-account.  Consequently, we have several options for hacking: either zakardkodit in the program knowingly correct verified information, or cut out of the code all areas that check the validity of the license.  I chose the second option, because I like it more. <br><br><h2>  Tools </h2><br>  To work we need tools.  I wanted to talk about them along the way, but still changed my mind and decided to write about everything in advance.  Actually, today we will need the following list of tools: <br><ul><li>  <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D695701">Apk manager</a> </li><li>  <a href="http://code.google.com/p/dex2jar/">dex2jar</a> </li><li>  <a href="http://java.decompiler.free.fr/">jd-gui</a> </li></ul><br><br><h2>  Introduction </h2><br>  Before proceeding, I will explain a little the structure of android applications.  Each application has a file with the apk extension, packed with a zip.  It contains application resources, AndroidManifest.xml and classes.dex.  What is the last one?  This is a program bytecode compiled specifically for the dalvik virtual machine.  You cannot get pure source code from java from it, but you can get <a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">dalvik opcodes</a> - a set of commands for a virtual machine, roughly speaking, this is a local assembler.  You can also turn a dex file into a jar, then decompile it and get more or less readable java code.  What we are going to do now. <br><br><h2>  Decompilation </h2><br>  We will carry out all manipulations with apk with the help of the Apk Manger utility.  This is a kind of single front-end for a set of libraries working with apk.  <font color="#A5A5A5">Let me remind you that you need to have installed drivers for the device and enable <a href="http://www.groovypost.com/howto/mobile/how-to-enable-usb-debugging-android-phone/">USB debugging</a> mode.</font>  Let's get started <br><ol><li>  Copy multimount.apk to the apk_manager \ place-apk-here-for-modding folder and launch Script.bat.  <font color="#A5A5A5">If all is well, a <a href="">console</a> with green text will appear.</font> </li><li>  It is necessary to decompile apk.  Select the item 9 of the same name. <font color="#A5A5A5">After that, we do not close the console.</font> </li><li>  Open multimount.apk with the archiver and copy the classes.dex file to the dex2jar folder, then drag it to dex2jar.bat.  <font color="#A5A5A5">Total Commander dragging does not work.</font> </li><li>  Appear classes.dex.dex2jar.jar open with jd-gui.  <font color="#A5A5A5">The window is not closed yet, it will be needed later.</font> </li></ol><br><br><h2>  Begin analysis </h2><br>  For initial information about the application, take a look at its manifest.  From it you can understand that the main activations are settings.  So the code offering to buy the application is somewhere there.  You can also notice a strange line at the bottom: <br><blockquote><ol><li> <code><font color="black"><font color="#009900"><font color="#800000"><b>&lt;uses-permission</b></font> <font color="#000066">android:name</font> = <font color="#ff0000">"com.android.vending.CHECK_LICENSE"</font> <font color="#800000"><b>/&gt;</b></font></font></font></code> </li> </ol></blockquote><br>  What is this?  As Google suggests, this line hints that <a href="http://developer.android.com/guide/publishing/licensing.html">LVL is</a> used in the application, that is, the android license manager.  Well, this is even good, because we have documentation.  Having read that, it is important to understand that this LVL not only manages licenses, but also subjects obfuscation code, which will significantly complicate our work. <br><br>  Well, okay, let's proceed directly to the analysis of the code.  Switch to jd-gui, expand the tree, and see three namespaces: the first is something related to advertising, the second is a set of LVL classes, the third is what we need. <br>  We go into it and see the effects of obfuscation.  Open MultiMountSDCardConfigure, briefly review the code.  A long line with some kind of hash immediately catches the eye.  This is the base64 public key.  And around it there are also other lines checking the license.  We need to cut them. <br><blockquote><ol><li>  com.  <font color="#006633">android</font> .  <font color="#006633">vending</font>  <font color="#006633">licensing</font> .  <font color="#006633">h</font> localh <font color="#339933">=</font> <font color="#000000"><b>new</b></font> com.  <font color="#006633">android</font> .  <font color="#006633">vending</font>  <font color="#006633">licensing</font> .  <font color="#006633">h</font> <font color="#009900">(</font> arrayOfByte, str4, str3 <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  v localv <font color="#339933">=</font> <font color="#000000"><b>new</b></font> v <font color="#009900">(</font> <font color="#000000"><b>this</b></font> , localh <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  m localm1 <font color="#339933">=</font> <font color="#000000"><b>new</b></font> m <font color="#009900">(</font> <font color="#000000"><b>this</b></font> , localv, <font color="#0000ff">"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAg1 ..."</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  f <font color="#339933">=</font> localm1 <font color="#339933">;</font> </li><li>  m localm2 <font color="#339933">=</font> f <font color="#339933">;</font> </li><li>  j localj <font color="#339933">=</font> e <font color="#339933">;</font> </li><li>  localm2.  <font color="#006633">a</font> <font color="#009900">(</font> localj <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br><br>  Open apk_manager \ projects \ multimount.apk \ smali \ com \ rafoid \ multimountsdcard \ widget \ MultiMountSDCardConfigure.smali and see the byte code.  Before reading further, I advise you to first see the <a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">list of</a> commands.  We need to find the very lines and comment them out.  Here they are: <br><blockquote><ol><li>  ... </li><li>  # iput-object v1, p0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; e: Lcom / android / vending / licensing / j; </li><li></li><li>  # new-instance v1, Lcom / android / vending / licensing / m; </li><li></li><li>  # new-instance v2, Lcom / android / vending / licensing / v; </li><li></li><li>  # new-instance v3, Lcom / android / vending / licensing / h; </li><li></li><li>  # sget-object v4, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; d: [B </li><li></li><li>  # invoke-virtual {p0}, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; getPackageName () Ljava / lang / String; </li><li></li><li>  # move-result-object v5 </li><li></li><li>  # invoke-direct {v3, v4, v5, v0}, Lcom / android / vending / licensing / h; -&gt; &lt;init&gt; ([BLjava / lang / String; Ljava / lang / String;) V </li><li></li><li>  # invoke-direct {v2, p0, v3}, Lcom / android / vending / licensing / v; -&gt; &lt;init&gt; (Landroid / content / Context; Lcom / android / vending / licensing / n;) V </li><li></li><li>  # const-string v0, "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCg ..." </li><li></li><li>  # invoke-direct {v1, p0, v2, v0}, Lcom / android / vending / licensing / m; -&gt; &lt;init&gt; (Landroid / content / Context; Lcom / android / vending / licensing / k; Ljava / lang / String;) V </li><li></li><li>  # iput-object v1, p0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; f: Lcom / android / vending / licensing / m; </li><li></li><li>  # iget-object v0, p0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; f: Lcom / android / vending / licensing / m; </li><li></li><li>  # iget-object v1, p0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; e: Lcom / android / vending / licensing / j; </li><li></li><li>  # invoke-virtual {v0, v1}, Lcom / android / vending / licensing / m; -&gt; a (Lcom / android / vending / licensing / j;) V </li><li>  ... </li></ol></blockquote><br>  We zamenchivaem, save.  It seems like everything can be used.  It remains only to compile and install. <br><br><h2>  Compile and install </h2><br>  For this, we will use the already familiar Apk Manager. <br><ol><li>  If you have not yet closed the console window, switch to it and select item 14. <font color="#A5A5A5">The script itself compiles, signs and installs apk on the device.</font> </li><li>  We start the application and see that now we are not offered to buy anything, but the window with the verification process hangs and does not close. </li></ol><br><br><h2>  Again analysis </h2><br>  Now we need to detect and delete the code that shows the dialogue we do not need.  Switch to jd-gui and find the following lines a little higher: <br><blockquote><ol><li>  rogressDialog localProgressDialog = ProgressDialog.show (this, str1, str2, 1, 0); </li><li>  b = localProgressDialog; </li></ol></blockquote><br>  Now you need to find them in MultiMountSDCardConfigure.smali.  Here they are: <br><blockquote><ol><li>  ... </li><li>  # invoke-static {p0, v0, v1, v6, v7}, Landroid / app / ProgressDialog; -&gt; show (Landroid / content / Context; Ljava / lang / CharSequence; Ljava / lang / CharSequence; ZZ) Landroid / app / ProgressDialog; </li><li></li><li>  # move-result-object v0 </li><li></li><li>  # iput-object v0, p0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardConfigure; -&gt; b: Landroid / app / ProgressDialog; </li><li>  ... </li></ol></blockquote><br>  We comment, save, compile, install, run.  Hooray!  Everything is working.  But after a short test, we understand that not everything works, namely the auto-mount function.  Switch to jd-gui, open MultiMountSDCardWidget $ UpdateService and see the following curve code: <br><blockquote><ol><li></li><li>  if (MultiMountSDCardWidget.b.booleanValue ()); </li><li>  int j; </li><li>  for (int i = 0;; j = 1) </li><li>  { </li><li>  Boolean localBoolean = Boolean.valueOf (i); </li><li>  RemoteViews localRemoteViews = MultiMountSDCardWidget.a (this, localBoolean); </li><li>  Class localClass = MultiMountSDCardWidget.a; </li><li>  ComponentName localComponentName = new ComponentName (this, localClass); </li><li>  AppWidgetManager.getInstance (this) .updateAppWidget (localComponentName, localRemoteViews); </li><li>  return; </li><li>  } </li><li></li></ol></blockquote><br>  This service is responsible for auto-mounting.  At the very beginning, we see some kind of check, as a result of which this mount is performed.  The code checks the variable b from the main activation, the very variable whose declaration we comment, deleting the dialog.  We will do the same with this check - we comment it to hell. <br>  This time, open MultiMountSDCardWidget $ UpdateService.smali and fill in the following lines: <br><blockquote><ol><li>  ... </li><li>  .method public onStart (Landroid / content / Intent; I) V </li><li>  .locals 3 </li><li></li><li>  # sget-object v0, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardWidget; -&gt; b: Ljava / lang / Boolean; </li><li></li><li>  # invoke-virtual {v0}, Ljava / lang / Boolean; -&gt; booleanValue () Z </li><li></li><li>  # move-result v0 </li><li></li><li>  # if-eqz v0,: cond_0 </li><li></li><li>  const / 4 v0, 0x0 </li><li></li><li>  : goto_0 </li><li>  invoke-static {v0}, Ljava / lang / Boolean; -&gt; valueOf (Z) Ljava / lang / Boolean; </li><li></li><li>  move-result-object v0 </li><li></li><li>  invoke-static {p0, v0}, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardWidget; -&gt; a (Landroid / content / Context; Ljava / lang / Boolean;) Landroid / widget / RemoteViews; </li><li></li><li>  move-result-object v0 </li><li></li><li>  new-instance v1, Landroid / content / ComponentName; </li><li></li><li>  sget-object v2, Lcom / rafoid / multimountsdcard / widget / MultiMountSDCardWidget; -&gt; a: Ljava / lang / Class; </li><li></li><li>  invoke-direct {v1, p0, v2}, Landroid / content / ComponentName; -&gt; &lt;init&gt; (Landroid / content / Context; Ljava / lang / Class;) V </li><li></li><li>  invoke-static {p0}, Landroid / appwidget / AppWidgetManager; -&gt; getInstance (Landroid / content / Context;) Landroid / appwidget / AppWidgetManager; </li><li></li><li>  move-result-object v2 </li><li></li><li>  invoke-virtual {v2, v1, v0}, Landroid / appwidget / AppWidgetManager; -&gt; updateAppWidget (Landroid / content / ComponentName; Landroid / widget / RemoteViews;) V </li><li></li><li>  return-void </li><li></li><li>  #: cond_0 </li><li></li><li>  const / 4 v0, 0x1 </li><li></li><li>  goto: goto_0 </li><li>  .end method </li><li>  ... </li></ol></blockquote><br>  We start and we are glad that we saved as much as 30 rubles on the purchase of this most useful program. <br><br><h2>  Notes </h2><br>  The process is described entirely for Windows, but can easily be repeated on Linux, since all the necessary libraries are cross-platform. <br>  After writing this article, I came across <a href="http://blog.in16.ru/index.php/2010/08/26/lvl-cracking/">this</a> hacking method, but, as far as I understand, it is relevant for earlier versions of LVL. <br><br>  <i>All information is presented for informational purposes only.</i>  <i>And also for developers to improve software protection.</i> </div><p>Source: <a href="https://habr.com/ru/post/111513/">https://habr.com/ru/post/111513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111508/index.html">Clever cache deletion (php 5 + Mongodb + memcached)</a></li>
<li><a href="../111509/index.html">Role information modeling in programming</a></li>
<li><a href="../111510/index.html">A simple implementation of RC4 in C #</a></li>
<li><a href="../111511/index.html">Android PC Game Controller</a></li>
<li><a href="../111512/index.html">Threats Inside: we initialize channels of leakage of corporate information</a></li>
<li><a href="../111514/index.html">Mt: C language for heavily loaded servers</a></li>
<li><a href="../111515/index.html">Corporate colors of sites and companies</a></li>
<li><a href="../111518/index.html">Where startups are hosted</a></li>
<li><a href="../111523/index.html">Note of a lazy typesetter on SCSS and Compass Framework</a></li>
<li><a href="../111524/index.html">Code Quality Assessment Tool in MS Visual Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>