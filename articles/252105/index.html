<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Different versions of JIT in .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every C # developer is aware that the C # compiler translates the program source code into an intermediate language called Intermediate Language (IL)....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Different versions of JIT in .NET</h1><div class="post__text post__text-html js-mediator-article">  Every C # developer is aware that the C # compiler translates the program source code into an intermediate language called Intermediate Language (IL).  And for turning IL into a sequence of machine commands, the Just-In-Time compiler (JIT) is most often responsible.  Yes, today there is NGen, Mono AOT, .NET Native, but JIT compilation still leads the world of .NET applications.  But this is the very JIT, they know not all.  If we take into account only the implementation of .NET from Microsoft, then it is worth distinguishing between JIT-x86 and JIT-x64.  And behind the door stands RyuJIT which very soon will take the honorable place of the main JIT compiler.  And if you like the old versions of .NET, then it is useful to know that the JIT logic was different in different versions of the CLR.  Our sources are now open, you can <a href="https://github.com/dotnet/coreclr/tree/master/src/jit">see</a> them and realize how much this is a big and complex topic.  Today we will not try to cover it, but only briefly look at a few interesting features of the individual versions of the JIT compilers.  So, today in the room: <ul><li>  Why the short method may not be inline and how to avoid it </li><li>  JIT-bugs: dangerous and merciless </li><li>  Who and how unwinds cycles </li><li>  What is the difference between unwinding small and large cycles </li></ul><br><img src="https://habrastorage.org/files/6e5/5ac/20f/6e55ac20f59d4888815876e5991934ad.png"><a name="habracut"></a><br><br><h3>  JIT-x86 and starg </h3><br>  Open the <code>Decimal</code> constructor <a href="http://referencesource.microsoft.com/">source</a> with an <code>int</code> parameter from the .NET Reference Source: <br><br><pre> <code class="hljs pgsql">// Constructs a <span class="hljs-type"><span class="hljs-type">Decimal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> an <span class="hljs-type"><span class="hljs-type">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>. // <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">Decimal</span></span>(<span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { // JIT today can<span class="hljs-string"><span class="hljs-string">'t inline methods that contains "starg" opcode. // For more details, see DevDiv Bugs 81184: x86 JIT CQ: Removing the inline striction of "starg". int value_copy = value; if (value_copy &gt;= 0) { flags = 0; } else { flags = SignMask; value_copy = -value_copy; } lo = value_copy; mid = 0; hi = 0; }</span></span></code> </pre><br>  Intrigued?  And the thing is that JIT-x86 does not know how to inline methods whose IL-code contains instructions <code>starg</code> or <code>ldarga</code> .  The decimal constructor is very desirable to be inlined, so the developers of the standard class went to the trick: they copied the parameter to a local variable to avoid the ‚Äúbad‚Äù instruction.  In JIT-x64, this feature was removed.  For those interested, it is recommended to study: <ul><li>  <a href="http://aakinshin.net/ru/blog/dotnet/inlining-and-starg/">The story about inlining under JIT-x86 and starg</a> </li><li>  <a href="http://referencesource.microsoft.com/">.NET Reference Source: Constructs a Decimal from an integer value</a> </li><li>  <a href="">CoreCLR, JIT sources: flowgraph.cpp (Feb 26, 2015)</a> </li><li>  <a href="">CoreCLR, JIT sources: importer.cpp (Feb 26, 2015)</a> </li><li>  <a href="https://msdn.microsoft.com/library/system.reflection.emit.opcodes.starg.aspx">MSDN: starg</a> </li><li>  <a href="https://msdn.microsoft.com/library/system.reflection.emit.opcodes.ldarga.aspx">MSDN: ldarga</a> </li><li>  <a href="http://stackoverflow.com/questions/26369163/net-local-variable-optimization">Stackoverflow: .NET local variable optimization</a> </li></ul><br><h3>  Strange bug in JIT-x64 </h3><br>  Dear experts, attention, question: what will the following code for <code>step=1</code> ? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> bar; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void Foo(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">step</span></span>; i++) { bar = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">step</span></span>; j += <span class="hljs-keyword"><span class="hljs-keyword">step</span></span>) Console.WriteLine(j + <span class="hljs-number"><span class="hljs-number">10</span></span>); } }</code> </pre><br>  The correct answer: depends.  Most likely you expect to see <code>10 11</code> , but a bug in optimizing JIT-x64 will ruin everything and give us <code>10 21</code> .  In JIT-x86 and RyuJIT, everything works well.  With the bug will have to accept, Microsoft does not want to fix it.  The example is very fragile, stumble upon it in real life is extremely problematic.  Someone will ask: but if this is a rare bug, then why know about it?  Why bother with such things at all?  If you are a funny person, you can use the bug for your own purposes.  For example, determine which version of JIT is currently used in runtime: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> JitVersion { Mono, MsX86, MsX64, RyuJit } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JitVersionInfo</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JitVersion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetJitVersion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsMono()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JitVersion.Mono; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsMsX86()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JitVersion.MsX86; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsMsX64()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JitVersion.MsX64; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JitVersion.RyuJit; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsMsX64</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> step = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; step; i++) { bar = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> * step; j += step) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = j + <span class="hljs-number"><span class="hljs-number">10</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-number"><span class="hljs-number">20</span></span> + step; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsMono</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Type.GetType(<span class="hljs-string"><span class="hljs-string">"Mono.Runtime"</span></span>) != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsMsX86</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !IsMono() &amp;&amp; IntPtr.Size == <span class="hljs-number"><span class="hljs-number">4</span></span>; } }</code> </pre><br>  Additional reading material: <br><br><ul><li>  <a href="http://aakinshin.net/ru/blog/dotnet/subexpression-elimination-bug-in-jit-x64/">Story about a bug in JIT-x64</a> </li><li>  <a href="http://aakinshin.net/ru/blog/dotnet/jit-version-determining-in-runtime/">JIT version detection in runtime</a> </li><li>  <a href="http://stackoverflow.com/questions/20701701/jit-net-compiler-bug">StackOverflow: JIT .Net compiler bug?</a> </li><li>  <a href="https://connect.microsoft.com/VisualStudio/feedback/details/812093/x64-jitter-sub-expression-elimination-optimizer-bug">MS Connect: x64 jitter sub-expression elimination optimizer bug</a> </li><li>  <a href="http://stackoverflow.com/q/721161/184842">StackOverflow: How to detect which .NET runtime is being used (MS vs. Mono)?</a> </li><li>  <a href="http://stackoverflow.com/q/22422021/184842">StackOverflow: How do I verify that ryujit is jitting my app?</a> </li></ul><br><h3>  Unwinding cycles </h3><br>  Unwinding cycles is such a very good optimization that many compilers love to do.  The bottom line is that we replace the view loop. <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) Foo(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>);</code> </pre><br>  on <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> += <span class="hljs-number"><span class="hljs-number">4</span></span>) { Foo(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); Foo(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>); Foo(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>); Foo(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span>); }</code> </pre><br>  In addition to reducing the number of increment operations, we have improved conditions for additional operations at the processor level (for example, branch prediction and instruction-level parallelism).  Alas, JIT-x86 and RyuJIT do not really know how to unwind the average cycle.  But JIT-x64 can sometimes, although it does so in its own special way.  For example, if the number of iterations is divisible by 2 or 3, then the code <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> += i; Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>);</code> </pre><br>  turn into something of a kind <br><br><pre> <code class="hljs matlab">; int sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC8710090 sub rsp,<span class="hljs-number"><span class="hljs-number">28</span></span>h ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC8710094 xor ecx,ecx <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC8710096 mov edx,<span class="hljs-number"><span class="hljs-number">1</span></span> ; edx = <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC871009B nop dword ptr [rax+rax] <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100A0 lea eax,[rdx<span class="hljs-number"><span class="hljs-number">-1</span></span>] ; eax = <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> ; sum += <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>; <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100A3 add ecx,eax ; sum += <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100A5 add ecx,edx ; sum += <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100A7 lea eax,[rdx+<span class="hljs-number"><span class="hljs-number">1</span></span>] ; eax = <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100AA add ecx,eax ; sum += <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100AC lea eax,[rdx+<span class="hljs-number"><span class="hljs-number">2</span></span>] ; eax = <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100AF add ecx,eax ; sum += <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100B1 add edx,<span class="hljs-number"><span class="hljs-number">4</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> += <span class="hljs-number"><span class="hljs-number">4</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100B4 cmp edx,<span class="hljs-number"><span class="hljs-number">401</span></span>h <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100BA jl <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC87100A0</code> </pre><br>  This is quite important information.  For example, many are looking forward to switching from JIT-x64 to RyuJIT, because Microsoft promises us a lot of tasty things: SIMD support and accelerated JIT compilation.  But about the performance of the code itself, they are somehow silent.  It should be understood that the lack of some optimizations in RyuJIT (compared to JIT-x64) can slightly reduce the speed of your program.  Useful links: <ul><li>  <a href="http://aakinshin.net/ru/blog/dotnet/ryujit-ctp5-and-loop-unrolling/">RyuJIT CTP5 and unwinding cycles</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B7%25D0%25BC%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B0_%25D1%2586%25D0%25B8%25D0%25BA%25D0%25BB%25D0%25B0">Wikipedia: unwinding cycle</a> </li><li>  <a href="http://en.wikipedia.org/wiki/Loop_unrolling">Wikipedia: Loop unrolling</a> </li><li>  <a href="https://www.researchgate.net/publication/2449271_Generalized_Loop-Unrolling_a_Method_for_Program_Speed-Up">JC Huang, T. Leng, Generalized Loop-Unrolling: a Method for Program Speed-Up (1998)</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25B4%25D1%2581%25D0%25BA%25D0%25B0%25D0%25B7%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C_%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D1%2585%25D0%25BE%25D0%25B4%25D0%25BE%25D0%25B2">Wikipedia: Transition Prediction (branch prediction)</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2580%25D0%25B0%25D0%25BB%25D0%25BB%25D0%25B5%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25BC_%25D0%25BD%25D0%25B0_%25D1%2583%25D1%2580%25D0%25BE%25D0%25B2%25D0%25BD%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4">Wikipedia: instruction-level parallelism (instruction-level parallelism)</a> </li><li>  <a href="http://en.wikipedia.org/wiki/Inline_expansion">Wikipedia: Inline expansion</a> </li><li>  <a href="http://en.wikipedia.org/wiki/CPU_cache">Wikipedia: Cache miss</a> </li><li>  <a href="http://stackoverflow.com/questions/2349211/when-if-ever-is-loop-unrolling-still-useful">StackOverflow: http://stackoverflow.com/questions/2349211/when-if-ever-is-loop-unrolling-still-useful</a> </li><li>  <a href="http://blogs.msdn.com/b/dotnet/archive/2013/09/30/ryujit-the-next-generation-jit-compiler.aspx">Blogs.Msdn: RyuJIT: The next-generation JIT compiler for .NET</a> </li></ul><br><h3>  More interesting JIT bugs </h3><br>  Here you have another problem: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Point { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> X; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Y; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Print</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Point p</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(pX + <span class="hljs-string"><span class="hljs-string">" "</span></span> + pY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pX = <span class="hljs-number"><span class="hljs-number">0</span></span>; pX &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; p.X++) Print(p); }</code> </pre><br>  This cycle can also be unwound.  There are only two iterations, so you can get rid of the conditional transitions altogether: it is enough to repeat the body of the loop twice.  An interesting fact: in the CLR2 JIT-x86 there was a bug that spoiled life and instead of <code>0 1 1 0</code> produced <code>2 0 2 0</code> .  Stumble upon it is not so difficult.  Fortunately, in the CLR 4 it was corrected, and in other versions of JIT it was not at all.  Keep in mind that if you are working under .NET Framework 3.5 (yes, some still have to), this implies CLR2.  You need to be prepared that such a simple code will turn into <br><br><pre> <code class="hljs perl">; var p = new Point(); <span class="hljs-number"><span class="hljs-number">05</span></span>C5178C <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi <span class="hljs-number"><span class="hljs-number">05</span></span>C5178D <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi,esi ; pY = <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pX = <span class="hljs-number"><span class="hljs-number">0</span></span>; pX &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; p.X++) <span class="hljs-number"><span class="hljs-number">05</span></span>C5178F lea edi,[esi+<span class="hljs-number"><span class="hljs-number">2</span></span>] ; pX = <span class="hljs-number"><span class="hljs-number">2</span></span> ; Print(p); <span class="hljs-number"><span class="hljs-number">05</span></span>C51792 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi ; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> pY <span class="hljs-number"><span class="hljs-number">05</span></span>C51793 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> pX <span class="hljs-number"><span class="hljs-number">05</span></span>C51794 call dword ptr ds:[<span class="hljs-number"><span class="hljs-number">54607</span></span>F4h] ; Print(p) <span class="hljs-number"><span class="hljs-number">05</span></span>C5179A <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi ; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> pY <span class="hljs-number"><span class="hljs-number">05</span></span>C5179B <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> pX <span class="hljs-number"><span class="hljs-number">05</span></span>C5179C call dword ptr ds:[<span class="hljs-number"><span class="hljs-number">54607</span></span>F4h] ; Print(p) <span class="hljs-number"><span class="hljs-number">05</span></span>C517A2 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> esi <span class="hljs-number"><span class="hljs-number">05</span></span>C517A3 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> edi <span class="hljs-number"><span class="hljs-number">05</span></span>C517A4 <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebp <span class="hljs-number"><span class="hljs-number">05</span></span>C517A5 ret</code> </pre><br>  In general, the topic of unwinding small cycles is of particular interest.  While JIT-x86 likes to unwind them (this is a big cycle, unwinding is difficult, but with a little everything is much easier), RyuJIT (which is based on the 32-bit JIT codebase) refuses to unwind them.  But JIT-x64 here we can please.  Let's say he can take the code <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> += i; Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>);</code> </pre><br>  and prefetch the value: <br><br><pre> <code class="hljs perl">; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3EC<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsp</span></span></span><span class="hljs-function">,28</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">h</span></span></span><span class="hljs-function"> </span></span>; Console.WriteLine(sum); <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3EC4 mov ecx,<span class="hljs-number"><span class="hljs-number">6</span></span> ; sum = <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3EC9 call <span class="hljs-number"><span class="hljs-number">00007</span></span>FFD273DCF1<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3ECE nop <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3ECF add rsp,<span class="hljs-number"><span class="hljs-number">28</span></span>h <span class="hljs-number"><span class="hljs-number">00007</span></span>FFCC86F3ED3 ret</code> </pre><br>  But do not think that RyuJIT is worse at all than JIT-x64.  Yes, with optimizations in the JIT compiler of the new generation, everything is not so good, but on average, the code in the hospital is more sane.  You can learn more about unwinding small cycles here: <ul><li>  <a href="http://aakinshin.net/ru/blog/dotnet/unrolling-of-small-loops-in-different-jit-versions/">Unwinding small cycles in different JIT versions</a> </li><li>  <a href="http://stackoverflow.com/q/2056948/184842">StackOverflow: .NET JIT potential error?</a> </li></ul><br><h3>  Want to know more about .NET internals? </h3><br>  Then come to us at the light!  In a short time in Moscow (April 03‚Äì04), Yekaterinburg (May 17) and St. Petersburg (May 29‚Äì30) a series of <a href="http://clrium.ru/%3Futm_source%3Daakinshin%26utm_medium%3Ddirect%26utm_campaign%3Dhabr">CLRium # 2</a> seminars will be held (live streaming is on).  We will discuss the future of .NET: let's talk about the anatomy of the new CoreCLR, features of RyuJIT, hardcore examples of working with Roslyn and CoreFx giblets!  An endless stream of interesting and useful knowledge will help you not only understand better how your own C # programs work, but also prepare you for a brighter .NET future in which you can use the power of the platform to the fullest! <br><br> <a href="http://clrium.ru/%3Futm_source%3Daakinshin%26utm_medium%3Ddirect%26utm_campaign%3Dhabr"><img src="http://clrium.ru/img/banner.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/252105/">https://habr.com/ru/post/252105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252091/index.html">Internet security: are users ready to counter cyber threats?</a></li>
<li><a href="../252095/index.html">The vulnerability of the "thumb": I hack your finger on the photo</a></li>
<li><a href="../252099/index.html">?.: when properties in C # can be null</a></li>
<li><a href="../252101/index.html">Documenting code efficiently with Doxygen</a></li>
<li><a href="../252103/index.html">Saga of E_RPC_DISCONNECT</a></li>
<li><a href="../252109/index.html">The announcement of the free game engine Source 2, as well as Steam Link, the release date of Steam Machines</a></li>
<li><a href="../252115/index.html">How we provided communication at the largest airports</a></li>
<li><a href="../252117/index.html">RSConf: Review and video frontend conference in Minsk</a></li>
<li><a href="../252119/index.html">Upload a user's photo in Active Directory using PowerShell</a></li>
<li><a href="../252121/index.html">Epson at the exhibition of applications and modern technologies MATE 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>