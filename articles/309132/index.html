<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once again about the benefits of backups or the story of my failure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is always nice to remember how we managed to solve some non-trivial task. But it happens the other way around. The task was seemingly understandabl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once again about the benefits of backups or the story of my failure</h1><div class="post__text post__text-html js-mediator-article">  It is always nice to remember how we managed to solve some non-trivial task.  But it happens the other way around.  The task was seemingly understandable, but it could not be solved.  Below I will tell a sad story from my practice.  She is sad because I still do not know how to solve this problem.  The story, once again, will remind you how important it is to pay due attention to backing up and carefully considering your actions.  Well, if someone from the readers tells me what could have been done to achieve a better result, then it will be just great. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/878/aad/b76/878aadb76bb04975aeab71e0e99d22e2.jpg" alt="image"></div><br>  So, there was a system administrator and he had an Active Directory domain.  Since the infrastructure was small and inherited a long time ago, there was only one domain controller with Windows Server 2003 installed on it. There were not enough resources, so a rather large number of applications were used on the same server that the administrator himself used and some of his colleagues.  Well, the cherry on the cake - backups in this company has never been done.  What could go wrong?  Details under the cut. <br><a name="habracut"></a><br>  Nothing can stay the same forever and the technical management has decided that it is time to switch to a more recent version of Active Directory, which means you need to update the domain controller.  How to switch to a more recent version of Windows Server in your domain, if you have only one controller, on which there is a lot of additional software and for which there are no backups?  Of course - in-place upgrade!  During the update, something went wrong and the process was interrupted with an error.  After that, errors from various systems and applications fell down, and our hero, realizing that the old controller was in trouble, decided to correct the situation by adding a new controller (it‚Äôs a pity that he didn‚Äôt start with this).  A new server with Windows Server 2008 was raised and he tried to enter it into the domain in order to make it a controller.  Having received the next error message, the administrator realized that it was time to seek outside help. <br><br>  This is where our acquaintance with him begins.  A small remark - in the process of finding a way to help him, several people participated, but in order to simplify the narration, I will not focus on this attention, especially since it will not add any technical details. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For ethical reasons, I cannot show screenshots from someone else‚Äôs work environment.  Therefore, to write the story, I (now already knowing what had broken down) reproduced the situation in the test lab.  For those who wish, at the end of the article will be told how you can do the same if you want to try your hand at solving this problem.  Thus, our patients will be the domain <b>Test.local</b> , Windows Server 2003 controller <b>TESTDC</b> , Windows Server 2008 server <b>TESTNEWDC</b> . <br><br><h3>  DNS </h3><br>  When trying to enter a new server into the domain, the following error was issued: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/40c/a90/927/40ca909274d54fb6a6233991370cfee7.PNG"></div><br><br>  As usual, problems with Active Directory start with DNS.  Looking into the DNS management snap-in at TESTDC we saw an empty server with no zones.  So obviously it should not be, since this is the only controller, in combination was the only DNS server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/377/9b6/a67/3779b6a674fa4803b66c1170a9d3b329.PNG"></div><br>  So, task number one is to restore DNS functionality.  Without it, a working domain is out of the question.  Just in case, they specified at the customer that all zones were Active Directory integrated.  So finding their files on the server itself will not succeed.  DNS data must be loaded from the Active Directory partitions of the database.  But it seems that this was a problem.  Looked into the System and Application logs to see what happens when the DNS service starts.  So it is - in the logs were filled with errors <a href="https://technet.microsoft.com/en-us/library/cc735673(v%3Dws.10).aspx">Event ID 4000</a> and <a href="https://technet.microsoft.com/en-us/library/cc774603(v%3Dws.10).aspx">Event ID 4007</a> , characteristic of problems with the operation of AD integrated zone: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/33a/573/df0/33a573df01a34502be638bb5ce3ac463.PNG"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8a3/8e7/a24/8a38e7a246a8492bbfd02d88c8d5d114.PNG"></div><br>  It was a very unpleasant sign, since the impossibility of downloading information from the Active Directory database of the only available controller hinted at the severity of the incident.  However, there was hope that it would turn out to make it all work with your hands.  When trying to create a zone again, the idea was confirmed that the DNS could not get anything from Active Directory.  He could not even get a list of domain controllers on which the relevant sections are stored: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7f3/acb/6a9/7f3acb6a9067427a95ac73f0ffb4f5e7.PNG"></div><br>  As a workaround, it was decided to try to replace the native DNS zone with a local stub.  It is clear that it will not contain all the necessary information, but the controller can be forced to update the DNS records for Active Directory, and everything else could wait for now.  So, the local main zone <b>test.local</b> was created and dynamic updates were enabled in it.  The easiest way that <a href="https://support.microsoft.com/en-us/kb/556002">Microsoft offers</a> for registering DNS records of a domain controller is to restart NetLogon service on it.  This was done.  As a result, a local zone was obtained with the necessary entries: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/566/b05/e2a/566b05e2af1b4397a77d31731a781b09.PNG"></div><br><h3>  New DC </h3><br>  Here we took a pause.  The customer checked the functionality of applications and systems in their environment.  Everything worked.  users can use their accounts regularly.  The customer was slightly relieved from the heart - at least people could get back to work. <br><br>  But the main problem was not solved.  We are back to trying to enter a new server in the domain.  For the introduction to the domain, the domain administrator‚Äôs <b>test.local \ administrator</b> account was used, which successfully logged into the old controller.  Error again.  True, this time, the other.  Now "Login Failure: The target account name is incorrect". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/470/ac0/42e/470ac042e7814625a624b1f43ec03e97.PNG"></div><br>  Remembering the problem of downloading information from Active Directory, here we had an idea to try instead of a domain account a local administrator account from the old <b>testdc \ administrator</b> controller.  It is clear that, in fact, this is the same account, because when creating a domain, the local built-in administrator of the first controller becomes a built-in administrator of the domain, but, nevertheless, it worked.  The server was successfully entered into the domain and its account appeared in the Active Directory database: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/054/880/7dd/0548807dde6f47b2befadaf2e0236348.PNG"></div><br>  It's time to try to make it a controller.  Error again.  The process of obtaining the controller role via dcpromo ended with the message ‚ÄúAccess denied‚Äù: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/094/48d/f79/09448df7991840f196e119fa2603be73.PNG"></div><br>  In Active Directory, the logs of the old controller often encountered the error message Event ID 40960 - again the problem with the account, this time with the record of the controller itself: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bd7/57c/2b0/bd757c2b0c5e4168bbc107bac3c12fd9.PNG"></div><br>  In general, thoughts about this possibility appeared at the stage of detecting <a href="https://support.microsoft.com/en-us/kb/2751452">errors with DNS</a> , but I really didn‚Äôt want to believe in it. <br><br><h3>  Accounts </h3><br>  So, it finally became clear what went wrong during the in-place upgrade ‚Äî the data on the domain account of the controller that was stored locally on it was lost.  As a result, we had a partially workable domain, but there was no domain controller.  There was only a server on which the Active Directory database was stored.  Since he did not remember his computer password, for the domain he, in fact, was nobody.  Above was a link to a Microsoft article that offers a method for solving this problem: <br><br><ul><li>  Stop the KDC service on the damaged controller </li><li>  Run the admin command netdom resetpwd / server: &lt;PDC.domain.com&gt; / userd: &lt;Domain \ domain_admin&gt; / passwordd: * </li><li>  Reboot controller </li></ul><br>  The problem is that for this you need to have a second working controller, but it was not there. <br><br>  In general, since we have a problem with the discrepancy between the login-password pairs stored locally and in the Active Directory database, then to solve it, we need to be able to somehow change this data. <br><br>  With the local version of the account, everything is simple.  There is a great utility from Joeware - <a href="http://www.joeware.net/freetools/tools/machinepwd/">machinepwd</a> .  It allows you to set an arbitrary computer recording password (and if this record is not yet broken, then not only locally, but also in the AD database). <br><br>  Harder to write in AD.  Since controller accounts are critical to this service, it protects them from any encroachment.  We tried the following: <br><br><ul><li>  The easiest way is to <b>reset the</b> computer account via Active Directory Users and Computers (if you do a Reset, the password is reset to its default value, while creating a new computer - COMPUTERNAME $).  The operation gave an access error. <br><br></li><li>  <b>nltest</b> .  This tool allows you to manage secure channel properties (the same login-password pair) for computers in Active Directory.  Generally speaking, it allows you to reset the password on both sides.  Error finding domain <b>I_NetLogonControl failed: Status = 1355 0x54b ERROR_NO_SUCH_DOMAIN</b> <br><br></li><li>  <b>dsmod</b> .  A utility for working with a computer account in the Active Directory itself buz.  Error <b>Internal Error</b> . <br><br></li><li>  <b>admod</b> .  Another utility for working with objects in AD.  <b>Unwilling</b> error <b>to perform</b> . <br><br></li><li>  <b>ktpass</b>  An interesting tool that allows you to generate <a href="https://kb.iu.edu/d/aumh">keytab</a> files (a kind of offline Kerberos token).  One of the features of this utility is the ability to change the password of the account for which you are creating a keytab file.  Access error again. </li></ul><br>  The last hope was to get the current controller password from Active Directory.  After that, you could set the same local password value.  There are many tools for extracting this information (for example: <a href="https://adsecurity.org/%3Fp%3D2053">Mimikatz DC sync</a> ).  However, even with administrator access, you can retrieve the password in the clear only if the <b><a href="https://technet.microsoft.com/en-us/library/hh994559(v%3Dws.11).aspx">Store passwords using reversible encryption</a></b> setting has been enabled <b><a href="https://technet.microsoft.com/en-us/library/hh994559(v%3Dws.11).aspx">prior</a></b> to its last shift.  In our case, it was turned off.  Since the password belonged to a computer account, there was no chance to pick it up using the dictionary with the NTLM hash in hand. <br><br><h3>  Summarizing </h3><br>  It is unpleasant to admit it, but I never figured out how to remedy the situation in this situation.  The customer was forced to lift the domain on holidays (in principle, there was no rush - with the local DNS zone, users did not even notice that something was wrong, so that he could calmly prepare for this operation).  It did not even work out the migration tools ‚Äî they required a trusting relationship between the old and the new domains to transfer the passwords, but a live domain controller is needed to establish these relationships.  It is clear that the man himself angry Pinocchio and did not so all that was possible, but still I was hurt. <br><br>  I hope you enjoyed this story with a bit of a sad ending.  As an afterword, a few reminders to novice Active Directory administrators: <br><br><ul><li>  You can use a single domain controller only if you have a VERY good reason (as a rule, lack of money for another Windows Server license).  You get a single point of failure, problems with which completely disable your infrastructure. <br><br></li><li>  No matter how many controllers you have, but especially if there is only one, ALWAYS make backup copies.  Information carriers are now so cheap that there can be no reason to save on this. <br><br></li><li>  Do not install applications on a domain controller unless absolutely necessary.  This is not the same server on which you can put something at the same time. <br><br></li><li>  Once again, I repeat - never start the in-place upgrade procedure without having a backup copy of the server.  This procedure in itself carries more risks than migration, so there is no need to expose yourself even more, losing even the possibility of reversing the changes. </li></ul><br>  <strong>PS</strong> If you want to get a test environment with the same problem, then all you need is to raise a Windows Server 2003 domain controller, download the machinepwd utility, the link to which I gave above, disable the network connection on the controller, stop the KDC service and, with the help machinepwd, set a new computer password. <br><br>  PPS If you know how to fix the connection between the controller and the domain in such a situation, please share it with the audience.  Your feat will not be forgotten! <br><br>  UPDATE: As a result of the discussion in the comments, it turned out that I was wrong - manually changing the computer password via MachinePWD is not a complete emulation of what happened.  In the case of a password change through this utility, the controller can be revived simply by stopping the KDC and running netdom resetpwd without shamanism.  Unfortunately, I could not find the original image of the server to continue the experiments.  It turned out very disappointing. </div><p>Source: <a href="https://habr.com/ru/post/309132/">https://habr.com/ru/post/309132/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309118/index.html">Alexey Ragozin on JVM diagnostic interfaces on jug.msk.ru</a></li>
<li><a href="../309124/index.html">LXC in QoS service (replace ifb with veth)</a></li>
<li><a href="../309126/index.html">How to work with MS Access in Linux</a></li>
<li><a href="../309128/index.html">Automating the maintenance of correspondence between the names of layers in the editor and code using CodeDom</a></li>
<li><a href="../309130/index.html">Communication Arrangements</a></li>
<li><a href="../309136/index.html">ADM interface - what is ‚ÄúTetrad‚Äù</a></li>
<li><a href="../309138/index.html">Learning OpenGL ES2 for Android Lesson ‚Ññ4. Textures</a></li>
<li><a href="../309142/index.html">Private unstructured types and type reuse</a></li>
<li><a href="../309144/index.html">About alignment of memory on ARM processors on a simple example</a></li>
<li><a href="../309150/index.html">Constants do not change: a small excursion into the depths of dotNet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>