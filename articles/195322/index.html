<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a bot client for schemaverse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√©, there was already a mention of SQL games. But I was all busy and only recently decided to figure out what it is. Quite by chance I chose a s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a bot client for schemaverse</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b8f/1c9/473/b8f1c947375695a9f0877b6324740737.png" alt="image" align="left">  On Habr√©, there was already a <a href="http://habrahabr.ru/post/185124">mention</a> of SQL games.  But I was all busy and only recently decided to figure out what it is.  Quite by chance I chose a <a href="https://schemaverse.com/tw/index.php">schemaverse</a> about which was also already <a href="http://habrahabr.ru/post/185124">mentioned</a> on the habr. <br><br>  As I understand it, you get all the fun of the game when you write a bot for it.  For this, I chose one of my most favorite languages ‚Äã‚Äã- javascript.  I also decided to visualize the map to see how my ships fly and capture the enemy planets.  I will not give a lot of code and SQL queries so as not to inflate an article, you can always see them in the <a href="https://github.com/peinguin/schemaverse_bot">repository</a> . <br><a name="habracut"></a><br>  I chose the bot behavior algorithm to be very simple - build getters, build invaders, and when invaders become enough - fly to capture.  Also, along the way, engineers are being built who repair the ships and, if there is enough money, I carry out fleet upgrades. <br><br>  From the very beginning, I decided to use third-party libraries to a minimum.  So, first establish a connection with the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config.js'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Postgres connection var pg = require('pg'), conn = "pg://"+config.username+":"+config.password+"@db.schemaverse.com:5432/schemaverse"; var UserModel = require('./models/user'); var CommandProcessor = require('./command_processor'); pg.connect(conn, function(err, client) { if (!err){ var userModel = new UserModel.constructor(client); CommandProcessor(userModel); } else { console.log(err); } });</span></span></code> </pre> <br>  After the connection is established, the user is initialized and so that you can view some statistics in the console and launch the visualizer, I added a command handler. <br>  When a user initializes, information about his planets is collected.  Building the miners / invaders / engineers produces each planet for itself.  And refueling / upgrade for all ships. <br>  This is a step-by-step strategy, and I could not follow the dependence of the course duration.  Therefore, I check if the turn is completed, depending on the duration of the previous move.  At the beginning of the new turn, the status of the ships is checked and the handlers are called to subscribe to the "tic" event.  Information about the capture of the new planet is obtained from the list of events.  In order to capture the planet rather successfully extract fuel from it.  This is the only resource of the game.  Also, each course recovers course and speed of all flying ships. <br>  When capturing a new planet, it is added to the list of planets and subscribes to the "tic" event. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tick = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ repair_damaged(); create_miners(); create_attackers(); go_to_conqueror(); } <span class="hljs-comment"><span class="hljs-comment">//constructor user.on(tick);</span></span></code> </pre><br>  It‚Äôs not very interesting to follow all of this on console output.  I added the CommandProcessor module with which you can check the status of the game at any time.  At any time, you can expand the list of supported commands.  But in more detail I want to tell about the visualizer and the problems that I had to face. <br><br>  After entering the ‚Äúmap‚Äù command, the web and websocket servers are first created. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>).createServer(handler), io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>).listen(app, { <span class="hljs-attr"><span class="hljs-attr">log</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> });</code> </pre><br>  The visualizer also subscribes to the ‚Äútic‚Äù event and sends a message to customers that it is possible to update the map. <br>  In fact, a web server is needed only for the transfer of statics, that is, the websocket of the client. <br>  Existing visualizers only display a general map.  My goal was to also display the fleet. <br><br>  It looks like this: <br><img src="https://habrastorage.org/storage3/60e/4b3/661/60e4b3661bf17fd654e9c7d58efce2aa.jpg" alt="image"><br>  I did when the circles of the planets approached more, because they were closed by ships. <br><br>  On a larger scale, the map is updated for a very long time.  If you move or increase it, you also have to wait a long time.  I do not update the map with every sneeze, but wait until the user enters the new desired coordinates.  The card responds to the mouse wheel and shuffle.  The client transmits the magnification, offset and size of the desired pattern.  The server, based on this data, requests objects from the base, draws them to the canvas and sends them back to the client. <br><br><pre> <code class="javascript hljs">get_map_base64( data.x, data.y, data.w, data.h, data.zoom, data.render_planets, data.render_ships, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">img</span></span></span><span class="hljs-function">)</span></span>{ socket.emit(<span class="hljs-string"><span class="hljs-string">'draw'</span></span>, img); } );</code> </pre><br>  In theory, the server can draw only ships or only planets, but I do not use it yet. <br><br>  It was possible to optimize the update rate of the map if: storing the list of planets locally and changing individual planets according to the conquer event, and if not taking all the maps from the base, but split them into squares and taking one per square. <br>  But there are a lot of them to store locally, I decided to save memory, and if you take one by one from the square, then with a large scale you can not see your initial planet.  Therefore, I decided not to optimize the process.  In addition, with a high magnification, everything is updated fairly quickly. <br><br>  Link to the repository of the project - <a href="https://github.com/peinguin/schemaverse_bot">https://github.com/peinguin/schemaverse_bot</a> </div><p>Source: <a href="https://habr.com/ru/post/195322/">https://habr.com/ru/post/195322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195312/index.html">VLC 2.1 released</a></li>
<li><a href="../195314/index.html">How Moscow helps IT-entrepreneurs</a></li>
<li><a href="../195316/index.html">IBM Trial Software</a></li>
<li><a href="../195318/index.html">The announcement of the Cloud OS Summit conference is all about the Microsoft cloud. Participation is free, registration is open.</a></li>
<li><a href="../195320/index.html">6 XSS on Habrahabr and methods of protection with their consequences</a></li>
<li><a href="../195330/index.html">A real-life challenge: How to restore a process tree in Linux</a></li>
<li><a href="../195334/index.html">DataPro will open its first data center in Tver this year</a></li>
<li><a href="../195338/index.html">Using Paint as a level editor</a></li>
<li><a href="../195340/index.html">Organization of electronics and robotics group in Moscow</a></li>
<li><a href="../195342/index.html">We work with documents in the browser with the help of jDoc</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>