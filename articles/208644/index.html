<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chrome extension over the weekend</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problem 
 As usual, late at night, getting on the bus, I took out the phone, and while I was typing ‚Äúhabr ...‚Äù he was cut off. I thought out loud: ‚ÄúBu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chrome extension over the weekend</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b4d/882/272/b4d882272171d9aa49c846a8a0140d70.png" alt="image"><br><br><h5>  Problem </h5><br>  As usual, late at night, getting on the bus, I took out the phone, and while I was typing ‚Äúhabr ...‚Äù he was cut off.  I thought out loud: ‚ÄúBut I couldn‚Äôt say before?‚Äù, I was a little sorry that the phones rarely squeak while they are discharged.  And then‚Ä¶ <br><br>  Then my friend and I decided to approach the issue like a man.  He wrote a program for android, and I expanded Chrome.  About the latter and will be discussed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Task </h5><br>  So, the idea: an android application monitors the battery status and periodically notifies the server about the level of charge.  Moreover, it does this somehow rationally so that the charge does not suffer from this.  The chrome extension puts its icon in a specially designated place, the icon shows the charge of the android battery and draws attention in every way if it is almost completely discharged.  And so that everything does not seem too simple, one had to realize the idea in one weekend.  Otherwise, the value / effort balance fell out of the free app. <br><br>  Thus, the choice of approach to the task turned out to be even more important than the speed of ten-finger printing. <br><a name="habracut"></a><br>  For the cause. <br><br><h5>  Decision </h5><br>  Expand Chrome was not so difficult, but I had to do everything as quickly as possible.  Weekend alone, but a lot of hotelok.  To speed up development, I wanted not to bathe with event handling and updating HTML and <a href="http://knockoutjs.com/">knockout</a> here came up better than anyone.  And since all the logic for the Chrome extension is written in javascript, <a href="http://www.typescriptlang.org/">typescript</a> helps to avoid many rakes.  These two of the casket immediately went into circulation.  With the technology ahead, now the most important thing.  A lot of payload was not expected, but a vegetable garden can be made of spaghetti here too.  The easiest and most reliable option was seen in the MVC pattern.  With a knockout, he didn‚Äôt bite a bit, that is MVVM itself, but it was clear that the management would be conducted from the background page (more on that later) on which there would be no knockout.  The choice is made.  Forward - to code.  Time is already an hour less. <br><br><h5>  Execution </h5><br>  I started by creating a new project in Visual Studio 2013, for simplicity I chose an ASP.NET Empty application.  I saw that fathers use a more appropriate template here - HTML Application with TypeScript - I did not have it, so I had to sweat with setting <a href="http://typescript.codeplex.com/wikipage%3Ftitle%3DCompile-on-Save">typescript compile-on-save</a> <br><br>  Bleed the project with a minimum of libraries and their typescript declarations.  Buddy Boris Yankov helped a lot with a <a href="https://github.com/borisyankov/DefinitelyTyped">chic set of typescript declarations</a> , although some had to be finished myself along the way. <br><br><h6>  Further MVC components: </h6><br>  M: models made two, one for the whole list, one for a separate android device (PopupViewModel and DeviceStatusViewModel).  In essence, they are ViewModel, but hereinafter simply Model <br>  V: view 2 break more hassle than good, just popup.html created <br>  C: well, he called himself that - Controller <br><br>  I also did a DeviceStatus - this is a structure that is sent between the extension and the server, as well as between the Controller and the Model. <br><br>  The super-important file is <a href="http://developer.chrome.com/extensions/manifest.html">manifest.json</a> , which Chrome needs to recognize the extension. <br><br>  A couple more manipulations, and this is how the picture came out: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66a/639/d97/66a639d975d769cd769489808bf7023c.png" alt="image"><br><br>  Now it was necessary to fill all this with meaning, that is, with classes.  Chrome limits the capabilities of its extensions and diligently puts the rake everywhere, so the controller I went to the background page right away, because it is he who talks to the server, and this can only be done from the background.  About this corresponding entry in manifest.json: <br><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"background"</span></span>: { <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: [<span class="hljs-string"><span class="hljs-string">"lib/jquery-1.7.2.min.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"src/DeviceStatus.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"src/Controller.js"</span></span>] }</code> </pre> <br><br>  After a couple of cones, it became clear that the files should be listed in the order of dependence on each other (jQuery is needed here for simplicity ajax requests and a couple more trifles). <br><br>  The client part, as expected, was spartan.  It appears only when you click on the icon and it does not have many tasks: add a device and set a charge threshold. <br><br>  Like that: <br><img src="https://habrastorage.org/getpro/habr/post_images/207/eb1/584/207eb1584070f932b6a90529d29ac39f.png" alt="image"><br><br>  First of all, you need to let Chrome know through manifest.json what to open and when: <br><br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"browser_action"</span></span>: { <span class="hljs-string"><span class="hljs-string">"default_icon"</span></span>: <span class="hljs-string"><span class="hljs-string">"images/icon.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"default_popup"</span></span>: <span class="hljs-string"><span class="hljs-string">"views/popup.html"</span></span> },</code> </pre><br><br>  The presentation code (popup.html) is extremely simple - some HTML and attributes to bind to the knockout model.  The boring details lowered, they can be, and so look at the living example.  One thing is important here - just because Chrome does not work with knockout, it needs to be given authority through manifest.json: <br><br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"content_security_policy"</span></span>: <span class="hljs-string"><span class="hljs-string">"script-src 'self' 'unsafe-eval'; object-src 'self'"</span></span>,</code> </pre><br><br>  this unsafe-eval is needed for knockout.  <a href="https://groups.google.com/forum/">Details here</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8c/43b/a4c/d8c43ba4c4d6442ecc0bc2befab90994.png" alt="image"><br><br>  Meat has already grown enough to connect to Chrome and watch what happens - it helps a lot to forget about dinner and keep working.  Chrome has a great button for this ‚Äî the Load Unpacked Extension; I sent it to the root of the VS project.  After a couple of adjustments, manifest.json managed to get a button in the right place and a test image. <br><br>  Inspiration is spurred, then - the model.  It is also very simple - all the properties from the DeviceStatus class are wrapped in observable and a couple of event handlers are adding a device, deleting a device and selecting the active one.  Along the way, we decided that we would support several devices, and which one the icon at the top corresponds to - let us decide for the user (hence the division into PopupViewModel and DeviceStatusViewModel). <br><br>  Now it looked like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/239/853/4e0/2398534e0eb2fa8254dcef23c82a4afe.png" alt="image"><br><br>  It's time to teach my main UI to get data.  Another Chrome rake was planted in the form of the inability to directly call the methods of the background page (I have a Controller sitting there).  All communication passes through the corresponding API Chrome and only asynchronously. <br><br>  Calls look like this: <br><br><pre> <code class="cs hljs"> chrome.extension.sendMessage({ method: <span class="hljs-string"><span class="hljs-string">"GetAllDevices"</span></span> }, (allDevices: DeviceStatus[]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!allDevices || allDevices.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { console.info(<span class="hljs-string"><span class="hljs-string">"Received empty device list"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } ... });</code> </pre><br><br>  And on the background page, a small bike scatters these messages according to the Controller methods: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Controller(); chrome.extension.onMessage.addListener( function (request: any, sender: any, sendResponse: (result: any) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> server[request.method].call(server, request.data, sendResponse); });</code> </pre><br><br>  Calls did not take much: <br><ul><li>  give all registered devices (immediately with statuses) </li><li>  Add a new device, it's the same - show this device on the icon </li><li>  delete device </li><li>  save sensitivity threshold for device </li></ul><br><br>  The responsibilities of the controller are slightly wider: <br><ul><li>  I woke up (Chrome started), read all registered devices and request their status on the server </li><li>  periodically request the status of all devices and update the icon in accordance with the status of the active device </li><li>  respond to UI calls </li><li>  if any device has a charge below a given limit, let it know via the icon and desktop notifications, in case the user suddenly switched to Firefox / CounterStrike / Visual Studio. </li><li>  at every opportunity to save the state somewhere where you can read when you wake up </li></ul><br><br>  Naturally, the first time it did not work and had to debug the code.  And simultaneously on the background page and in the client part.  With the client part, everything is simple - right click on the extension button and ‚ÄúInspect popup‚Äù, here you can see both the debugger and the DOM, and what is very important - typescript gave me a bunch of * .map files, and Chrome picked them up itself, and in the Chrome console I debugged typescript, not javascript.  I really liked it, except for one thing - typescript prudently creates the _this variable and writes a reference to this into it.  This allows you to work without loss within objects, but the debugger did not know this and often gave out all sorts of nonsense when I tried to watch the values ‚Äã‚Äãof variables.  After a few cones, I realized that during debugging, all this should be changed to _this, in order to see the true meaning, then everything fell into place. <br><br>  Now the background page.  At first I used console.log, but very soon it began to be missed, and a very useful link came up here - on the extensions page, as it turned out (and why not an hour earlier?) There is this line: <br>  <b>Inspect views: <a href="https://habr.com/ru/post/208644/">background page</a> ,</b> <br>  on it the background debugger opened. <br><br>  Keeping and reading the state turned out to be quite simple, Chrome provided the API, and even claims that it will be synchronized with the rest of the data between different Chroms, if configured.  Synchronization did not check.  And it looks like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback: (</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.devices = []; chrome.storage.sync.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>([<span class="hljs-string"><span class="hljs-string">"aid"</span></span>, <span class="hljs-string"><span class="hljs-string">"ds"</span></span>], (storedValues: any) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (storedValues.aid != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; storedValues.aid != <span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.deviceId = storedValues.aid; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> devicesJson = storedValues.ds; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.devices = JSON.parse(devicesJson); callback(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { chrome.storage.sync.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>({ <span class="hljs-string"><span class="hljs-string">"aid"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.deviceId, <span class="hljs-string"><span class="hljs-string">"ds"</span></span>: JSON.stringify(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.devices) }); }</code> </pre><br><br>  Request status from the server - a completely normal ajax: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestStatus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any, successCallback: (status: DeviceStatus</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> , errorCallback: (error: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { $.ajax({ url: <span class="hljs-string"><span class="hljs-string">"https://localhost/cbs/"</span></span> + data.deviceId, type: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, success: successCallback, error: (xhr, error) =&gt; { console.error(error); errorCallback(error); } }); }</code> </pre><br><br>  One of the most sophisticated rakes on the way met while debugging the model binding to the view.  Knockout didn‚Äôt want to register an event handler; instead, it called it on the spot.  Another Chrome extension, <a href="https://chrome.google.com/webstore/detail/knockoutjs-context-debugg/oddcpmchholgcjgjdnfjmildmlielhof%3Fhl%3Den">knockout context debugger,</a> helped detect the problem. <br><br>  And with the notifications I had to sweat.  Chrome provides an API for notifications, but with one significant limitation - it only hangs on the screen for 5 seconds, after which almost nothing is left of it, only a small bell in the system tray.  And this is not configurable.  After several unsuccessful attempts, the problem was resolved through webkit notifications. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = webkitNotifications.createNotification(opt.iconUrl, opt.title, opt.message); n.onclose = () =&gt; { ... }; n.show();</code> </pre><br><br>  And then Chrome began to remind the battery something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/03c/f1d/9d7/03cf1d9d7c827e16bbac09507db86130.png" alt="image"><br><br>  With the icon above, too, everything is simple, Chrome again provided the API, and with the help of simple manipulations with the icon, hint and text everything worked like a clock: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updateIcon) { chrome.browserAction.setIcon({ path: path }); chrome.browserAction.setTitle({ title: title }); chrome.browserAction.setBadgeText({ text: <span class="hljs-string"><span class="hljs-string">"!"</span></span> }); }</code> </pre><br><br>  After that, it remained only to marry the code format from the android application with the extension.  Chose a 12-character code to avoid repetitions. <br><br>  By midnight on Sunday the first version was ready. <br><br>  Then there were 3 more small updates with buns and insecticides, so it would not be quite honest to say that only the weekend and nothing more was spent, but the main task was completed on time. <br><br>  Update: <br>  if anyone is interested in writing a client under iOS, let me know </div><p>Source: <a href="https://habr.com/ru/post/208644/">https://habr.com/ru/post/208644/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208634/index.html">Calendar IT-RENEWAL-2014 under Windows 8.1</a></li>
<li><a href="../208636/index.html">Six Reasons for Apple to Embed Video Trailers on the App Store</a></li>
<li><a href="../208638/index.html">Selenium: from instrument to standard</a></li>
<li><a href="../208640/index.html">Disposal of batteries. Community initiative</a></li>
<li><a href="../208642/index.html">New rival Google Glass from Epson</a></li>
<li><a href="../208650/index.html">Containers are the future of clouds.</a></li>
<li><a href="../208652/index.html">The Ministry of Culture proposes to impose heavy fines for violating the procedure for blocking pirated content</a></li>
<li><a href="../208658/index.html">GDC Europe and Gamescom - which is more useful?</a></li>
<li><a href="../208662/index.html">Twitter app. Sending tweets and private messages</a></li>
<li><a href="../208664/index.html">Rust 0.9 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>