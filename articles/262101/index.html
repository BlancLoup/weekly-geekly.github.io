<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Advanced Exim and Dovecot configuration with OpenLDAP binding</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses Exim, Dovecot, and OpenLDAP advanced collaboration settings based on my experience with these applications. Perhaps, someone wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Advanced Exim and Dovecot configuration with OpenLDAP binding</h1><div class="post__text post__text-html js-mediator-article">  This article discusses Exim, Dovecot, and OpenLDAP advanced collaboration settings based on my experience with these applications.  Perhaps, someone will find for themselves something interesting and new - this was the purpose of writing another howto on this topic. <br><br>  Why Exim and OpenLDAP, and not Postfix and MySQL, for example?  Postfix works fine out of the box, but if something extraordinary is needed, very soon Postfix turns into a hulking monster hung with pearl scripts, Exim has a monstrous meta configuration language and allows you to do without third-party scripts and crutches.  I considered MySQL redundant for my tasks and replaced with standard OpenLDAP, especially LDAP is used for the work of the address book.  Dovecot is very smart and easy to set up, plus it integrates well with both Exim and OpenLDAP. <br><a name="habracut"></a><br>  So, install the necessary software, everything is standard here (apt-get, yum, etc.).  I used Gentoo, so emerge openldap dovecot exim (exim and dovecot must have ldap support). <br><br>  Used USE flags when building: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs sql">net-nds/openldap-2.4.40-r3::x-overlay <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span>=<span class="hljs-string"><span class="hljs-string">"berkdb crypt gnutls overlays samba sasl ssl syslog mail-mta/exim-4.85::gentoo USE="</span></span>dkim dnsdb dovecot-sasl dsn exiscan-acl gnutls ldap lmtp maildir pam pkcs11 prdr spf ssl syslog net-mail/dovecot<span class="hljs-number"><span class="hljs-number">-2.2</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>::gentoo <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span>=<span class="hljs-string"><span class="hljs-string">"bzip2 caps ldap maildir managesieve pam sieve ssl zlib</span></span></code> </pre> <br>  The first in the queue will be OpenLDAP, all mail accounts, groups and aliases will be stored in its database, and OpenLDAP will also be used as an address book for mail clients.  For simplicity and convenience, I do not use slapd-config, but I store all the settings in the text slapd.conf. <br><br>  Since the standard OpenLDAP does not have a suitable mailing scheme, I used my modified version of <a href="http://pastebin.com/cYZ3mgx5">phamm.schema</a> and the default <a href="http://open.rhx.it/phamm/schema/phamm-vacation.schema">phamm-vacation.schema</a> . <br><br><h4>  OpenLDAP configuration </h4><br>  I omit the primary configuration, the creation basedn dc = domain, dc = com and ssl certificates for OpenLDAP, since everything is standard here. <br><br><div class="spoiler">  <b class="spoiler_title">Slapd.conf config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/core.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/cosine.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/corba.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/inetorgperson.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/nis.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/misc.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/phamm.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/openldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/phamm-vacation.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> pidfile /run/openldap/slapd.pid argsfile /run/openldap/slapd.args #        TLS TLSCACertificateFile /etc/openldap/ssl/cacert.pem TLSCertificateFile /etc/openldap/ssl/newcert.pem TLSCertificateKeyFile /etc/openldap/ssl/newkey.pem TLSProtocolMin <span class="hljs-number"><span class="hljs-number">3.1</span></span> TLSVerifyClient allow <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> bdb #   bdb , ,  . cachesize <span class="hljs-number"><span class="hljs-number">100000</span></span> suffix "dc=domain,dc=com" rootdn "uid=manager,dc=domain,dc=com" #   rootpw **** directory /var/lib/openldap-data <span class="hljs-keyword"><span class="hljs-keyword">checkpoint</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> idletimeout <span class="hljs-number"><span class="hljs-number">120</span></span> writetimeout <span class="hljs-number"><span class="hljs-number">120</span></span> loglevel <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> overlay syncprov #    syncprov syncprov-<span class="hljs-keyword"><span class="hljs-keyword">checkpoint</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> syncprov-sessionlog <span class="hljs-number"><span class="hljs-number">100</span></span> #   <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uid,accountActive,vacationActive,createMaildir eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cn,givenName,sn,mail pres,eq,sub <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uidNumber,gidNumber,memberUid eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> entryCSN,entryUUID eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> objectClass,member,uniqueMember eq #      # ,    limits dn="uid=replicator,ou=services,dc=domain,dc=com" size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited # ,  phpldapadmin limits dn="uid=ldapadmin,ou=services,dc=domain,dc=com" size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited #  exim limits dn="uid=exim,ou=services,dc=domain,dc=com" size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited #  nsswitch limits dn="uid=proxyagent,ou=services,dc=domain,dc=com" size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited #       <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> attrs=userPassword <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=replicator,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=proxyagent,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> anonymous auth <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> attrs=mail <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> users <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> anonymous auth</code> </pre> <br></div></div><br>  Be sure to set up replication for OpenLDAP (again, everything is standard here, so I omit the details).  The only thing I had to collect OpenLDAP with my hands to support sssvlv (Server Side Sorting and Virtual List View) in the address book (./configure - enable-ipv6 = no - enable-syncprov = yes - enable-sssvlv = yes - with-tls = yes). <br>  Also, in order for sssvlv to work correctly in an autlux, I had to patch the OpenLDAP sources. <br><div class="spoiler">  <b class="spoiler_title">Patch</b> <div class="spoiler_text"><pre> <code class="hljs objectivec">--- servers/slapd/schema_prep.c <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span><span class="hljs-number"><span class="hljs-number">-25</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">29.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0200</span></span> +++ servers/slapd/schema_prep.c <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span><span class="hljs-number"><span class="hljs-number">-29</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span>:<span class="hljs-number"><span class="hljs-number">57.000000000</span></span> +<span class="hljs-number"><span class="hljs-number">0200</span></span> @@ <span class="hljs-number"><span class="hljs-number">-915</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> +<span class="hljs-number"><span class="hljs-number">915</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ offsetof(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> slap_internal_schema, si_ad_name) }, { <span class="hljs-string"><span class="hljs-string">"cn"</span></span>, <span class="hljs-string"><span class="hljs-string">"( 2.5.4.3 NAME ( 'cn' 'commonName' ) "</span></span> <span class="hljs-string"><span class="hljs-string">"DESC 'RFC4519: common name(s) for which the entity is known by' "</span></span> + <span class="hljs-string"><span class="hljs-string">"ORDERING caseIgnoreOrderingMatch "</span></span> <span class="hljs-string"><span class="hljs-string">"SUP name )"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @@ <span class="hljs-number"><span class="hljs-number">-924</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> +<span class="hljs-number"><span class="hljs-number">925</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> @@ <span class="hljs-string"><span class="hljs-string">"DESC 'RFC4519: user identifier' "</span></span> <span class="hljs-string"><span class="hljs-string">"EQUALITY caseIgnoreMatch "</span></span> <span class="hljs-string"><span class="hljs-string">"SUBSTR caseIgnoreSubstringsMatch "</span></span> + <span class="hljs-string"><span class="hljs-string">"ORDERING caseIgnoreOrderingMatch "</span></span> <span class="hljs-string"><span class="hljs-string">"SYNTAX 1.3.6.1.4.1.1466.115.121.1.15{256} )"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, (END)</code> </pre></div></div><br><br>  The second server will work as an address book in read-only mode. <br><br><div class="spoiler">  <b class="spoiler_title">Slapd.conf config for second LDAP server</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/corba.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/core.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/cosine.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/inetorgperson.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/misc.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/nis.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> #  slapd         <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/phamm-vacation.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /etc/ldap/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>/phamm.<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> dynamic backend modules: #modulepath /usr/lib/ldap #moduleload back_hdb.so #moduleload sssvlv.so # sssvlv     Outlook idletimeout <span class="hljs-number"><span class="hljs-number">120</span></span> threads <span class="hljs-number"><span class="hljs-number">8</span></span> sizelimit <span class="hljs-number"><span class="hljs-number">1000</span></span> pidfile /var/run/slapd/slapd.pid argsfile /var/run/slapd/slapd.args loglevel <span class="hljs-number"><span class="hljs-number">0</span></span> #        TLS TLSCACertificateFile /etc/ldap/ssl/ca.pem TLSCertificateFile /etc/ldap/ssl/ab.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com_crt.pem TLSCertificateKeyFile /etc/ldap/ssl/ab.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com_key.pem TLSProtocolMin <span class="hljs-number"><span class="hljs-number">3.1</span></span> TLSVerifyClient allow <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> hdb #     hdb cachesize <span class="hljs-number"><span class="hljs-number">100000</span></span> suffix "dc=domain,dc=com" rootdn "cn=replicator,ou=services,dc=domain,dc=com" rootpw ***** directory /var/lib/ldap <span class="hljs-keyword"><span class="hljs-keyword">checkpoint</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> idletimeout <span class="hljs-number"><span class="hljs-number">120</span></span> writetimeout <span class="hljs-number"><span class="hljs-number">120</span></span> overlay sssvlv #    TLS,  syncrepl syncrepl rid=<span class="hljs-number"><span class="hljs-number">001</span></span> # ID  provider=ldaps://<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com #  ldaps:// ,    starttls     self-signed  <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=refreshOnly <span class="hljs-type"><span class="hljs-type">interval</span></span>=<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> searchbase="dc=domain,dc=com" scope=sub schemachecking=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> bindmethod=simple binddn="uid=replicator,ou=services,dc=domain,dc=com" #   posix   ou=services,   slapd.conf credentials=**** tls_cacertdir=/etc/ssl/certs tls_cacert=/etc/ldap/ssl/ca.pem tls_cert=/etc/ldap/ssl/ab.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com_crt.pem tls_key=/etc/ldap/ssl/ab.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.com_key.pem tls_reqcert=allow <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uid,accountActive,vacationActive eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cn,givenName,sn,mail pres,eq,sub <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> uidNumber,gidNumber,memberUid eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> entryCSN,entryUUID eq <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> objectClass,member,uniqueMember eq #       limits dn="uid=replicator,ou=services,dc=domain,dc=com" size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited #        limits users size=unlimited <span class="hljs-type"><span class="hljs-type">time</span></span>=unlimited #    <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> attrs=userPassword <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=replicator,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=proxyagent,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> anonymous auth <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> attrs=mail <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=replicator,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> attrs=cn <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=replicator,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=ldapadmin,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> dn.base="uid=replicator,ou=services,dc=domain,dc=com" <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> users <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> anonymous auth</code> </pre></div></div><br>  To administer the LDAP database, I use phpldapadmin, since it is lightweight, convenient and has support for XML templates, which allows the flexibility to customize the necessary templates for creating accounts.  Unfortunately, the project has long been abandoned by the author and no longer develops. <br><br>  For example, an example of a template for creating an email account. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClasses</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"top"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inetOrgPerson"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"posixAccount"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag">&gt;</span></span> #  posix  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"VirtualMailAccount"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag">&gt;</span></span> #      phamm  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vacation"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClass</span></span></span><span class="hljs-tag">&gt;</span></span> #    phamm-vacation  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objectClasses</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attributes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"givenName"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span>First Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">icon</span></span></span><span class="hljs-tag">&gt;</span></span>ldap-uid.png<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">icon</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sn"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span>Last Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(cn;%givenName% %sn%)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(uid;%givenName|0-1/l%%sn/l%)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(loginShell;/sbin/nologin)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(FTPStatus;enabled)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cn"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span>Common Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span>3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uid"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span>UID<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">display</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(homeDirectory;/home/%uid%)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(mailbox;/home/%uid%/Maildir)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(mail;%uid%@domain.com)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span>=autoFill(company;My Company)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span>4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spacer</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spacer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">attribute</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  When creating, I use the following LDAP database schema: <br><br>  ou = people, dc = domain, dc = com - container for storing mail accounts; <br>  ou = groups, dc = domain, dc = com - container for storing posix groups; <br>  ou = services, dc = domain, dc = com - container for storing system service accounts (posix accounts); <br>  ou = aliases, dc = domain, dc = com is a container for storing mail aliases. <br><br>  When creating an email account, many attributes of the phamm scheme I modified are used, the use of which is beyond the scope of this article (for example, createMaildir or Backup).  I will mark only those that are used in search filters. <br>  accountActive = TRUE | FALSE - allows you to temporarily enable / disable an account or alias; <br>  vacationInfo - contains the text Out of Office message; <br>  vacationActive - allows you to enable / disable the OoO message; <br>  quota - here and so it is clear (for example: quota = 4G) <br><br>  So, OpenLDAP is configured and running, replication is working, and using phpldapadmin, the first test account ipupkin with the email address ipupkin@domain.com has been created.  In the future, only one domain.com domain will be used, so we create a domain group in our ou = groups posix container and add ipupkin to this group. <br><br>  In this example, all services work on the same Linux server and it is logical to use the Led database to identify the user in the system, so we place this procedure on the shoulders of the Name Service Switch (nss) or System Security Services Daemon (sssd).  The advantage of this solution is also easy adaptation with the Samba domain, if necessary. <br>  First you need to make sure that the nss_ldap package (or libnss-ldapd) is installed on the system. <br>  In /etc/nsswitch.conf we change the lines from compat to ldap (or winbind in the case of a Samba domain) <br>  passwd: files ldap <br>  shadow: files ldap <br>  group: files ldap <br><br>  Create a file /etc/ldap.conf with the following content: <br><br><div class="spoiler">  <b class="spoiler_title">ldap.conf</b> <div class="spoiler_text">  uri ldap: //127.0.0.1 <br>  uri ldap: //192.168.0.1 # Second fallback ldap server <br><br>  base dc = domain, dc = com <br>  binddn uid = proxyagent, ou = services, dc = domain, dc = com # Pre-created in ou = services posix account specified in slapd.conf <br>  bindpw ***** <br><br>  pam_filter objectclass = posixAccount <br>  pam_login_attribute uid <br>  pam_check_host_attr no <br>  pam_lookup_policy no <br>  pam_member_attribute memberUid <br>  pam_min_uid 1000 <br>  pam_max_uid 65535 <br>  ssl start_tls # use TLS instead of SSL <br>  # Specify certificate paths <br>  tls_cacert /etc/openldap/ssl/ca.pem <br>  tls_key /etc/openldap/ssl/mail_crt_new.pem <br>  tls_cert /etc/openldap/ssl/mail_key_new.pem <br>  tls_reqcert allow <br>  tls_checkpeer no <br>  tls_ciphers TLSv1 <br>  scope sub <br>  timelimit 5 <br>  bind_timelimit 5 <br>  bind_policy soft <br>  nss_reconnect_tries 4 <br>  nss_reconnect_sleeptime 1 <br>  nss_reconnect_maxsleeptime 16 <br>  nss_reconnect_maxconntries 2 <br></div></div><br>  We check that nss works and the home directory is created (mkdir -m 700 / home ipupkin &amp;&amp; chown ipupkin: domain / home / ipupkin). <br>  &gt; id ipupkin <br>  uid = 1057 (ipupkin) gid = 1000 (domain) groups = 1000 (domain) <br>  &gt; ls -ld / home / ipupkin <br>  drwx ------ 3 ipupkin domain 4096 Jun 22 15:50 / home / ipupkin <br><br>  Now that the ipupkin user is recognized by the system, ipupkin needs to be able to receive and send mail. <br><br><h4>  Dovecot setup </h4><br>  When configuring Dovecot, I deleted all the nested monstrous default configs and, for convenience, created only two - dovecot.conf and dovecot-ldap.conf. <br><br><div class="spoiler">  <b class="spoiler_title">dovecot.conf</b> <div class="spoiler_text">  auth_cache_negative_ttl = 10 mins <br>  auth_debug = no <br>  auth_debug_passwords = no <br>  auth_mechanisms = plain login # Used by TLS, so we allow plain <br>  base_dir = / var / run / dovecot / <br>  default_vsz_limit = 1024 M <br>  disable_plaintext_auth = no <br>  dotlock_use_excl = yes <br>  lda_mailbox_autocreate = yes # Required <br>  lda_mailbox_autosubscribe = yes # Required <br>  listen = * <br>  mmap_disable = yes <br>  mail_fsync = always <br>  mail_nfs_storage = no <br>  mail_nfs_index = no <br>  mail_debug = no <br>  mail_location = maildir: ~ / Maildir # Where to search for a mailbox, the maildir value is taken from the homeDirectory attribute (in our case, this is / home / ipupkin), the full path will be / home / ipupkin / Maildir. <br>  mail_plugins = $ mail_plugins quota notify expire <br>  managesieve_notify_capability = mailto <br>  managesieve_sieve_capability = fileinto reject envelope encoder; ia; ascii-numeric relational regex imap4flags <br>  ssl_ca = &lt;/etc/dovecot/ssl/ca.pem <br>  ssl_cert = &lt;/etc/dovecot/ssl/mail_crt_new.pem <br>  ssl_key = &lt;/etc/dovecot/ssl/mail_key_new.pem <br>  ssl_verify_client_cert = no <br>  verbose_ssl = no <br><br>  protocols = imap pop3 sieve <br><br>  userdb { <br>  args = /etc/dovecot/dovecot-ldap.conf # Connecting our ldap config <br>  driver = ldap <br>  } <br><br>  passdb { <br>  args = /etc/dovecot/dovecot-ldap-pass.conf # As recommended by the authors of dovecot, a symbolic link to dovecot-ldap.conf <br>  driver = ldap <br>  } <br><br>  service auth { <br>  unix_listener auth-userdb { <br>  mode = 0666 <br>  } <br>  } <br><br>  service imap-login { <br>  process_min_avail = 6 <br>  service_count = 0 <br>  } <br><br>  service pop3-login { <br>  process_min_avail = 6 <br>  service_count = 0 <br>  } <br><br>  # Used managesieve by roundcube webmail plugin <br>  service managesieve-login { <br>  process_min_avail = 6 <br>  service_count = 0 <br>  inet_listener sieve { <br>  port = 4190 <br>  } <br>  } <br><br>  service managesieve { <br>  } <br><br>  service dict { <br>  unix_listener dict { <br>  mode = 0666 <br>  } <br>  } <br><br>  # When filling mailbox by 90%, the following script is executed <br>  service quota-warning { <br>  executable = script /etc/dovecot/quota-warning.sh # The script itself looks like this <br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="hljs mel">#!/bin/sh PERCENT=$1 USER=$2 cat &lt;&lt; EOF | /usr/libexec/dovecot/dovecot-lda -d $USER -o <span class="hljs-string"><span class="hljs-string">"plugin/quota=maildir:User quota:noenforcing"</span></span> From: postmaster@domain.com Subject: Your mailbox is $PERCENT% full Content-Type: <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>/plain; charset=<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span> X-Priority: <span class="hljs-number"><span class="hljs-number">2</span></span> Warning! Your mailbox is now $PERCENT% full. EOF</code> </pre><br></div></div><br><br>  unix_listener quota-warning { <br>  mode = 0666 <br>  } <br>  } <br><br>  protocol imap { <br>  imap_client_workarounds = delay-newmail # Hack for Autluk <br>  mail_plugins = quota imap_quota mail_log notify <br>  } <br><br>  protocol pop { <br>  pop3_client_workarounds = outlook-no-nuls oe-ns-eoh # Different hacks for Autluk <br>  # pop3_uidl_format =% 08Xu% 08Xv # Used when Autluk stores mail on the server, this format has problems with Outlook 2013 <br>  pop3_uidl_format =% g <br>  pop3_fast_size_lookups = yes # Details <a href="http://wiki2.dovecot.org/POP3Server">here is the</a> section Maildir perfomance. <br>  mail_plugins = <br>  } <br><br>  # Logical Delivery Agent (LDA) service used by Exim for mail delivery. <br>  protocol lda { <br>  hostname = domain.com <br>  mail_fsync = optimized <br>  mail_plugins = sieve quota <br>  postmaster_address = postmaster@domain.com <br>  log_path = <br>  info_log_path = <br>  } <br><br>  protocol sieve { <br>  } <br><br>  # Various optional additives <br>  plugin { <br>  quota = maildir: User quota <br>  quota_rule = *: storage = 1M <br>  quota_rule2 = Trash: ignore <br>  quota_rule3 = Deleted Items: ignore <br>  quota_rule4 = Junk E-mail: ignore <br>  quota_rule5 = Archive: ignore <br>  quota_rule6 = archive: ignore <br>  quota_warning = storage = 90 %% quota-warning 90% u # Specify the percentage of filling in the mailbox at which the quota-warning.sh script is triggered <br>  sieve = ~ / Maildir / .dovecot.sieve <br>  sieve_dir = ~ / Maildir / sieve <br>  expire_dict = proxy :: expire <br>  expire = Trash <br>  expire2 = Deleted Items <br>  expire3 = Junk Email <br>  expire_cache = yes <br>  } <br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">dovecot-ldap.conf</b> <div class="spoiler_text">  hosts = 127.0.0.1 <br>  dn = uid = proxyagent, ou = services, dc = domain, dc = com <br>  dnpass = ***** <br>  tls = no <br>  auth_bind = no <br>  auth_bind_userdn = uid =% u, ou = people, dc = domain, dc = com <br>  ldap_version = 3 <br>  base = dc = domain, dc = com <br>  deref = never <br>  scope = subtree <br>  user_attrs = homeDirectory = home, uidNumber = uid, gidNumber = gid, quota = quota_rule = *: storage =% $ <br>  user_filter = (&amp; (objectClass = VirtualMailAccount) (accountActive = TRUE) (uid =% n) (mail = *)) <br>  pass_attrs = uid = user, userPassword = password <br>  pass_filter = (&amp; (objectClass = VirtualMailAccount) (accountActive = TRUE) (uid =% u) (mail = *)) <br>  default_pass_scheme = SSHA <br></div></div><br><br>  We check that there are no errors (dovecot -a) and run dovecot. <br><br><h4>  Final: Exim Setup </h4><br>  The main goal in setting up Exim was the maximum rejection of any scripts and the implementation of all the functionality using only Exim tools.  Only as an exception are Debian greylistd on python and pearl barley amavisd-new used. <br>  When configuring Exim, two files will also be used - the main exim.conf and acl_smtp for the ACL rules. <br>  Also optionally in the config there is a router and transport for mailman. <br><br><div class="spoiler">  <b class="spoiler_title">exim.conf</b> <div class="spoiler_text">  CONFIG_PREFIX = / etc / exim <br>  ACL_PREFIX = CONFIG_PREFIX / acls # all ACL configs are stored here <br>  DB_PREFIX = / var / spool / exim / db # to increase performance, it is desirable to use tmpfs <br><br>  # Templates are the strength of Exim and make it easy to replace a long line with a short word. <br>  # Define templates for mailman <br>  MM_HOME = / var / lib / mailman <br>  MM_UID = mailman <br>  MM_GID = mailman <br>  MM_WRAP = / usr / lib / mailman / mail / mailman <br>  MM_LISTCHK = MM_HOME / lists / $ {lc :: $ local_part} /config.pck <br><br>  ldap_default_servers = /var/run/openldap/slapd.sock: 192.168.0.1 # Specify how to connect to Ledap servers, the second server will be used as fallback. <br><br>  INTERFACE = your_external_ip # Specify the external ip on which Exim will hang <br>  BASEDN = dc = domain, dc = com # basedn ldap server <br><br>  # This section lists the most important templates that define the logic of Exim <br><br>  # Checking the alias, whether the alias address matches the value of the mail attribute in the aliases container, the alias must also belong to the VirtualMailAlias ‚Äã‚Äãclass and be TRUE for the accountActive attribute <br>  CHECK_1 = $ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = aliases, dc = domain, dc = com? Mail? sub? (&amp; (objectClass = VirtualMailAlias) (accountActive = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  # Check account if the recipient's address matches the value of the mail attribute in the people container, the account must also belong to the VirtualMailAccount class and be TRUE for the accountActive attribute <br>  CHECK_2 = $ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = people, dc = domain, dc = com? Mail? sub? (&amp; (objectClass = VirtualMailAccount) (accountActive = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  # Check the suspended account, the account can not receive mail, but remains in the system (relevant for employees on the maternity leave) <br>  CHECK_3 = $ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = people, dc = domain, dc = com? Mail? sub? (&amp; (objectClass = VirtualMailAccount) (accountActive = TRUE) (accountSuspend = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  # List of participants of the alias, to whom to send mail, the value of the maildrop attribute <br>  CHECK_DATA = $ {lookup ldapm {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = aliases, dc = domain, dc = com? Maildrop? sub? (&amp; (objectClass = VirtualMailAlias) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  # Path to mailbox, mailbox attribute value <br>  CHECK_MAILDIR = $ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = people, dc = domain, dc = com? Mailbox? sub? (&amp; (objectClass = VirtualMailAccount) (accountActive = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  # Text of OoO message, value of the vacationInfo attribute <br>  CHECK_VACATION = $ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = people, dc = domain, dc = com? VacationInfo? sub? (&amp; (objectClass = VirtualMailAccount) (vacationActive = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}} <br><br>  #Hack for double commas in OoO message, exim's bug 660 - it seems they have not fixed it <br>  VACATION = $ {sg {$ {lookup ldap {user = "uid = exim, ou = services, dc = domain, dc = com" pass = *** ldap: /// ou = people, dc = domain, dc = com? vacationInfo? sub? (&amp; (objectClass = VirtualMailAccount) (vacationActive = TRUE) (mail = $ {quote_ldap: $ local_part @ $ domain}))}}} {,,} {,}} <br><br>  domainlist_cache virt_domains = domain.com # Since we have only one domain, we specify it.  If multiple domains are used, then you need to create a domain selection template from the ldap database. <br>  domainlist_cache local_domains = localhost: mail.domain.com <br>  hostlist relay_from_hosts = 127.0.0.1: 192.168.0.0/16 <br>  addresslist noautoreply_senders = DB_PREFIX / autoreply.noanswer.db <br><br>  sender_unqualified_hosts = 127.0.0.1: 192.168.0.0/16 <br>  recipient_unqualified_hosts = 127.0.0.1: 192.168.0.0/16 <br><br>  local_interfaces = 0.0.0.0.25: 0.0.0.0.26: 0.0.0.0.465: 0.0.0.0.587: 127.0.0.1.10025 <br>  tls_on_connect_ports = 465 <br><br>  acl_smtp_connect = acl_check_connect <br>  acl_smtp_helo = acl_check_helo <br>  acl_smtp_mail = acl_check_mail <br>  acl_smtp_rcpt = acl_check_rcpt <br>  acl_smtp_data = acl_check_data <br>  acl_smtp_dkim = acl_check_dkim <br><br>  accept_8bitmime <br>  auth_advertise_hosts =! 127.0.0.1 # Do not offer SMTP AUTH localhost <br>  bounce_message_file = CONFIG_PREFIX / bounce.msg # Specify the format of the bounce message, I have this: <br><br><div class="spoiler">  <b class="spoiler_title">bounce msg</b> <div class="spoiler_text">  Subject: Mail delivery failed $ {if eq {$ sender_address} {$ bounce_recipient} {: return message to sender}} <br>  **** <br>  This message was created automatically by mail delivery software. <br><br>  A message $ {if eq {$ sender_address} {$ bounce_recipient} {that you sent} {sent by <br><br>  &lt;$ sender_address&gt; <br><br>  }} could not be delivered to all of its recipients. <br>  The following address (es) failed: <br>  **** <br>  The following text was generated during the delivery attempt (s): <br>  **** <br>  - This is a copy of the message, including all the headers.  - **** <br>  - The body of the message is $ message_size characters long;  only the first <br>  - $ return_size_limit or so are included here. <br>  **** <br></div></div><br>  bounce_return_size_limit = 100K <br>  delay_warning = 15m: 1h: 99d <br>  deliver_queue_load_max = 40 <br>  disable_ipv6 <br>  exim_group = vmail # It is desirable that all mail services (dovecot, spamassassin, clamav, etc.) work under one gid <br>  exim_user = vmail # It is desirable that all mail services (dovecot, spamassassin, clamav, etc.) work under one uid <br>  headers_charset = UTF-8 # It is advisable to enable <br>  ignore_bounce_errors_after = 0s <br>  local_scan_timeout = 0s <br>  message_size_limit = 50M <br>  never_users = root <br>  no_message_logs <br>  no_smtp_enforce_sync <br>  no_syslog_duplication <br>  primary_hostname = mail.domain.com <br>  qualify_domain = domain.com <br>  queue_only_load = 12 <br>  queue_run_max = 5 <br>  recipients_max = 500 <br>  recipients_max_reject <br>  remote_max_parallel = 2 <br>  return_size_limit = 10000 <br>  rfc1413_query_timeout = 0s <br>  smtp_accept_max = 500 <br>  smtp_accept_max_per_host = 500 <br>  smtp_accept_queue = 500 <br>  smtp_accept_queue_per_connection = 1000 <br>  smtp_accept_reserve = 15 <br>  smtp_banner = $ primary_hostname ESMTP ready $ tod_full <br>  smtp_connect_backlog = 40 <br>  smtp_load_reserve = 20 <br>  smtp_return_error_details <br>  split_spool_directory <br>  strip_excess_angle_brackets <br>  strip_trailing_dot <br>  syslog_facility = mail # Logs are sent to the syslog service <br>  syslog_processname = exim <br>  system_filter = DB_PREFIX / exim.filter # Global exim filter, mostly not used for me <br>  timeout_frozen_after = 7d <br>  tls_advertise_hosts =! 127.0.0.1 # Do not offer TLS to localhost <br><br>  # Specify certificate paths <br>  tls_certificate = /etc/exim/ssl/mail_crt_new.pem <br>  tls_privatekey = /etc/exim/ssl/mail_key_new.pem <br>  tls_verify_certificates = /etc/exim/ssl/ca.pem <br><br>  # Determine the format of the letter header <br>  received_header_text = "Received: \ <br>  $ {if def: sender_rcvhost {from INTERFACE \ n \ t} \ <br>  {$ {if def: sender_ident {from relay}} \ <br>  $ {if def: sender_helo_name {(helo = $ {sender_helo_name}) \ n \ t}}}} \ <br>  by $ {qualify_domain} \ <br>  id $ {message_id} \ <br>  $ {if def: received_for {\ n \ tfor &lt;$ received_for&gt;}} <br><br>  # We connect antivirus and antispam directly, since LDAP is not used here, then everything is standard, so we omit the setting. <br>  # av_scanner = clamd: / tmp / clamd <br>  # spamd_address = 127.0.0.1 783 <br><br>  begin acl <br><br>  # Connect our ACL config (see below) <br>  .include ACL_PREFIX / acl_smtp <br><br>  # Create routers <br>  begin routers <br><br>  # Router for outgoing mail <br>  dnslookup: <br>  driver = dnslookup <br>  domains =! + local_domains:! + virt_domains <br>  transport = remote_smtp <br>  ignore_target_hosts = 0.0.0.0: 127.0.0.0/8 <br>  no_more <br><br>  # Routers for incoming mail <br><br>  # Opitsonalny transport for amavis (we will make one exception a pearl :)) <br>  #amavis: <br>  # driver = manualroute <br>  # condition = $ {if or {\ <br>  # {eq {$ interface_port} {10025}} \ <br>  # {eq {$ received_protocol} {spam-scanned}} \ <br>  # {eq {$ sender_address} {}} \ <br>  # {eq {$ sender_address_domain} {domain.com}} \ <br>  # {eq {$ sender_address_domain} {kaspersky.com}} \ <br>  # {eq {$ {lc: $ dkim_verify_status}} {pass}} \ <br>  # {match {$ sender_address_local_part} {- bounces}} \ <br>  #} {0} {1}} <br>  # domains = + virt_domains <br>  # senders = !:! postmaster @ *:! mailer-daemon @ *:! nagios @ *:! monit @ * <br>  # no_verify <br>  # no_expn <br>  # transport = amavis <br>  # route_list = "* localhost byname" <br>  # self = send <br><br>  autorespond: <br>  driver = accept <br>  domains = + virt_domains <br>  senders = !:! + noautoreply_senders # Do not respond to the local host and senders specified in autoreply.noanswer.db <br>  condition = $ {if and {\ <br>  {! eq {CHECK_VACATION} {}} \ # Our template <br>  {! match {$ h_precedence:} {junk | bulk | list}} \ # Do not respond to mailings <br>  {! def: header_Auto-Submitted:} \ <br>  {! def: header_List-Id:} \ <br>  }} <br>  no_verify <br>  no_expn <br>  unseen <br>  transport = auto_responder <br><br>  # Suspended accounts, all incoming mail for a suspended account is sent to the "black hole" <br>  suspended: <br>  driver = redirect <br>  domains = + virt_domains <br>  condition = CHECK_3 <br>  forbid_file <br>  forbid_pipe <br>  forbid_filter_reply = true <br>  data =: blackhole: <br>  no_more <br><br>  # Virtual alias <br>  aliases: <br>  driver = redirect <br>  domains =! + local_domains <br>  condition = CHECK_1 # There is a double check here (the first in acl_smtp), if the current account has an alias, I have not thought of anything better <br>  forbid_file <br>  forbid_pipe <br>  forbid_filter_reply = true <br>  data = CHECK_DATA # To send letters <br>  allow_fail <br>  allow_defer <br><br>  mailman_router: <br>  driver = accept <br>  domains = domain.com <br>  require_files = MM_LISTCHK # Instead of checking the file, you can check by the value of the attribute aliasType = DL, for example <br>  local_part_suffix_optional <br> local_part_suffix = -admin: \ <br> -bounces: -bounces+*: \ <br> -confirm: -confirm+*: \ <br> -join: -leave: \ <br> -owner: -request: \ <br> -subscribe: -unsubscribe <br> transport = mailman_transport <br><br> system_aliases: <br> driver = redirect <br> domains = +local_domains <br> errors_to = <br> no_verify <br> data = ${lookup{$local_part}partial0-dbm{DB_PREFIX/aliases.db}{$value}fail} <br> file_transport = address_file <br> pipe_transport = address_pipe <br> allow_fail <br> allow_defer <br><br> localuser: <br> driver = accept <br> domains = +local_domains: +virt_domains <br> check_local_user <br> transport = dovecot_lda #         dovecot lda <br> cannot_route_message = Unknown account # Dovecot  ,  <br> no_more <br><br> ############################################################### <br> begin transports <br> ############################################################### <br><br> remote_smtp: <br> driver = smtp <br> helo_data = mail.domain.com <br> max_rcpt = 500 <br> # DKIM <br> dkim_domain = domain.com <br> dkim_selector = dkim <br> dkim_private_key = DB_PREFIX/dkim.private.key <br> dkim_canon = relaxed <br><br> auto_responder: <br> driver = autoreply <br> from = "${local_part}@${domain}" <br> to = "${reply_address}" <br> once = "/var/spool/exim/autoreply/${local_part}@${domain}" <br> once_repeat = 1d #      ,       LDAP (. phamm-vacation.schema) <br> headers = ¬´Content-Type: text/plain; charset=utf-8\nContent-Transfer-Encoding: 8bit¬ª <br> subject = ${rfc2047:Auto-Reply: $h_subject:} <br> text = VACATION #     OoO  <br> body_only <br> no_return_message <br><br> #     dovecot <br> dovecot_lda: <br> driver = pipe <br> command = /usr/libexec/dovecot/dovecot-lda -f "$sender_address" -d "$local_part@$domain" <br> home_directory = /home/$local_part <br> delivery_date_add <br> envelope_to_add <br> return_path_add <br> log_output <br> log_defer_output <br> return_fail_output <br> freeze_exec_fail <br> temp_errors = 64: 69: 70: 71: 72: 73: 74: 75: 78 <br><br> address_pipe: <br> driver = pipe <br> return_output <br><br> address_file: <br> driver = appendfile <br> current_directory = SPOOL <br> home_directory = SPOOL <br> create_directory <br> directory_mode = 0700 <br> maildir_format <br> user = vmail <br> group = vmail <br> mode = 0600 <br> no_check_owner <br> no_mode_fail_narrower <br><br> address_reply: <br> driver = autoreply <br><br> maillist_pipe: <br> driver = pipe <br> group = mail <br> return_fail_output <br> user = vmail <br><br> mailman_transport: <br> driver = pipe <br> command = MM_WRAP \ <br> '${if def:local_part_suffix \ <br> {${sg{$local_part_suffix}{-(\\w+)(\\+.*)?}{<span>$</span>1}}} \ <br> {post}}' \ <br> $local_part <br> current_directory = MM_HOME <br> home_directory = MM_HOME <br> user = MM_UID <br> group = MM_GID <br><br> #amavis: <br> # driver = smtp <br> # port = 10024 <br> # allow_localhost <br><br> begin retry <br> * quota <br> * rcpt_4xx senders=: F,1h,10m <br> * * F,2h,10m; G,16h,1h,1.5; F,4d,6h <br><br> #         <br> begin rewrite <br> root@* collector@domain.com Ttbcr <br><br> #  SMTP AUTH <br> begin authenticators <br> plain: <br> driver = plaintext <br> public_name = PLAIN <br> server_prompts =: <br> server_condition = "${lookup ldap{user=uid=${quote_ldap_dn:$auth2},ou=people,BASEDN pass=${quote:$auth3} \ <br> ldap:///ou=people,BASEDN?uid?sub?(&amp;(uid=$auth2)(objectClass=VirtualMailAccount)(accountActive=TRUE))}{yes}fail}" <br> server_set_id = $auth2 <br><br> login: <br> driver = plaintext <br> public_name = LOGIN <br> server_prompts = ¬´Username::: Password::¬ª <br> server_condition = "${lookup ldap{user=uid=${quote_ldap_dn:$auth1},ou=people,BASEDN pass=${quote:$auth2} \ <br> ldap:///ou=people,BASEDN?uid?sub?(&amp;(uid=$auth1)(objectClass=VirtualMailAccount)(accountActive=TRUE))}{yes}fail}" <br> server_set_id = $auth1 <br><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exim's main caliber cannon is the Access Control Lists. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, the whole article was started for the sake of a single construction in the smtp_rcpt section.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acl_smtp</font></font></b> <div class="spoiler_text"> acl_check_connect: <br> accept hosts =: +relay_from_hosts: net-dbm;DB_PREFIX/whitelist_hosts.db <br> deny message = $sender_host_address is listed in $dnslist_domain ${if def:dnslist_text {($dnslist_text)}} <br> dnslists = sbl.spamhaus.org: xbl.spamhaus.org: bl.spamcop.net <br> accept <br><br> acl_check_dkim: <br> warn log_message = DKIM: Sender without DKIM signature <br> sender_domains = gmail.com: autodesk.com: paypal.com <br> dkim_signers = gmail.com: autodesk.com: paypal.com <br> dkim_status = none:invalid:fail <br> accept <br><br> acl_check_helo: <br> accept hosts =: +relay_from_hosts <br><br> #HELO is an open proxy <br> deny condition = ${if and {\ <br> {isip{$sender_helo_name}}\ <br> {eq{$sender_helo_name}{$sender_host_address}}\ <br>  }} <br> message = Open Proxy in HELO/EHLO (HELO was $sender_helo_name) <br> delay = 10s <br><br> #HELO is my hostname <br> deny condition = ${if match{$sender_helo_name}{$primary_hostname}} <br> message = Bad HELO ‚Äî Host impersonating [$sender_helo_name] <br><br> #HELO is my address <br> deny condition = ${if eq{$interface_address}{$sender_helo_name}} <br> message = $interface_address is my address <br> accept <br><br> acl_check_mail: <br><br> accept hosts =: +relay_from_hosts <br> discard senders = dbm;DB_PREFIX/banned_senders.db: dbm;DB_PREFIX/scammers.db <br><br> #HELO required before MAIL <br> deny condition = ${if eq{$sender_helo_name}{}} <br> message = HELO/EHLO required before MAIL <br><br> accept <br><br> acl_check_rcpt: <br><br> #stub address <br> discard condition = ${if match{$local_part@$domain}{blackhole@domain.com}} # blackhole  <br><br> deny message = Restricted characters in address <br> local_parts = ^[.]: ^.*[@%!/|] <br><br> #Reverse DNS check <br> warn condition = ${if and{{def:sender_host_address}{!def:sender_host_name}}{yes}{no}} <br> !hosts =: +relay_from_hosts: net-dbm;DB_PREFIX/whitelist_hosts.db <br> control = no_pipelining <br> delay = 10s #    10   ,      <br> log_message = X-Host-Lookup-Failed: Reverse DNS lookup failed for $sender_host_address <br><br> # RATELIMIT SECTION <br><br> #Keep authenticated users under control <br> warn authenticated = * <br> ratelimit = 100 / 5m / strict / $authenticated_id <br> set acl_m100 = ${eval: ${sg{$sender_rate}{[.].*}{}} ‚Äî $sender_rate_limit + 10}s <br> delay = $acl_m100 <br> log_message = Ratelimit: Delay $acl_m100 for $authenticated_id. Rate limit $sender_rate / $sender_rate_period <br><br> #Limit local senders, exclude mailing-list agent <br> warn condition = ${if !match{$sender_address_local_part}{bounces}} <br> hosts =: 127.0.0.1 <br> ratelimit = 1000 / 1h / per_rcpt / strict / $sender_host_address <br> set acl_m101 = ${eval: ${sg{$sender_rate}{[.].*}{}} ‚Äî $sender_rate_limit}s <br> delay = $acl_m101 <br> log_message = Ratelimit: Delay $acl_m101 for $sender_address ($sender_host_address). Rate $sender_rate / limit $sender_rate_limit <br><br> #Limit fast senders <br> hosts = !127.0.0.1: +relay_from_hosts <br> ratelimit = 100 / 5m / per_rcpt / strict <br> set acl_m102 = ${eval: ${sg{$sender_rate}{[.].*}{}} ‚Äî $sender_rate_limit + 5}s <br> delay = $acl_m102 <br> log_message = Ratelimit: Delay $acl_m102 for $sender_address ($sender_host_address). Rate $sender_rate / limit $sender_rate_limit <br><br> #Limit DSNs <br> warn condition = ${if and{\ <br> {&lt;{$recipients_count}{0}}\ <br> {!eq{$sender_address_domain}{domain.com}}\ <br>  }} <br> senders =: postmaster@*: mailer-daemon@* <br> delay = 10s <br> log_message = Ratelimit: DSN delay 10s for $sender_address ($sender_host_address) <br><br> # END RATELIMIT SECTION <br><br> #Predefined acl variables for smtp_data level <br> warn set acl_m0 = $sender_address_domain <br> warn set acl_m1 = $domain <br> warn set acl_m2 = $sender_host_address <br> warn set acl_m3 = $sender_address <br> warn set acl_m4 = $local_part@$domain <br><br> #Verify recipient for our domains. <br> deny message = Unknown or disabled account <br> domains = +virt_domains <br> !local_parts = postmaster: *-admin: *-bounces: *-bounces+*: *-confirm: *-confirm+* :\ <br> *-join: *-leave: *-owner: *-request: *-subscribe: *-unsubscribe <br><br> #     ,        check_rcpt,      . <br> !recipients = CHECK_1: CHECK_2 <br><br> accept hosts =: +relay_from_hosts <br> control = dkim_disable_verify <br> #        <br> accept authenticated = * <br> control = dkim_disable_verify <br><br> #    ,  ,  10   . <br> deny message = relay not permitted <br> !domains = +local_domains: +virt_domains <br> delay = 10s <br><br> #        ,    ,  <br> #Deny non-authorized senders with our own domain prefix <br> deny condition = ${if match{$sender_address_domain}{domain.com}} <br> !hosts =: +relay_from_hosts: +adobe_hosts: +microsoft_hosts: net-dbm;DB_PREFIX/whitelist_hosts.db <br> message = Sender domain is not allowed here <br> log_message = Sender $sender_address is not authenticated <br><br> #Dictionary attack protection <br> #Start <br> warn condition = ${if &gt; {${eval:$rcpt_fail_count}}{4}{yes}{no}} <br> log_message = Ratelimit: Detected Dictionary Attack (Let $rcpt_fail_count bad recipients though before engaging) <br> set acl_m7 = 1 <br><br> warn condition = ${if eq {${acl_m7}}{1}{1}{0}} <br> ratelimit = 0 / 1h / strict / per_conn <br> log_message = Ratelimit: Increment Connection Ratelimit ‚Äî $sender_fullhost because of Dictionary Attack <br><br> drop condition = ${if eq {${acl_m7}}{1}{1}{0}} <br> log_message = Ratelimit: Number of failed recipients exceeded <br> #End <br><br> #       ,        exim      lastchange   "%Y%m%d"   .       ,     . <br>     ,   log_message,   ,  . <br> #Alias statistic <br> warn <br> domains = +virt_domains <br> log_message = ALIAS: $local_part@$domain <br> recipients = CHECK_1 <br><br> #     <br> #Greylist section <br> defer message = $sender_host_address is not yet authorized to deliver \ <br> mail from &lt;$sender_address&gt; to &lt;$local_part@$domain&gt;. Please try later <br> log_message = Sender $sender_address greylisted <br> domains = +virt_domains <br> !sender_domains = partial1()dbm;DB_PREFIX/whitelist_grey_domains.db <br> !authenticated = * <br> condition = ${readsocket{/var/run/greylistd/socket}\ <br> {--grey %s $sender_address $local_part@$domain}{5s}{}{false}} <br><br> accept <br><br> acl_check_vrfy_expn_etrn: <br><br> accept hosts = 127.0.0.1 <br><br> deny <br><br> acl_check_data: <br><br> #   spamassassin, .      SPAM      Exim. <br><br>  exim.filter    : <br><br><div class="spoiler"> <b class="spoiler_title">exim.filter</b> <div class="spoiler_text"> if first_delivery then <br> headers remove X-Spam-Score:X-Spam-Report:X-Spam-Checker-Version:X-Spam-Status:X-Spam-Level <br><br> if "${if def:header_X-New-Subject: {there}}" is there <br> then <br> headers remove Subject <br> headers add ¬´Subject: $rh_X-New-Subject:¬ª <br> headers remove X-New-Subject <br> endif <br><br> endif <br><br></div></div><br>  # <br> # no antispam check for relay hosts and authenticated users <br> # accept hosts =: +relay_from_hosts <br> # accept authenticated = * <br>  # <br> # Antispam scan <br> # warn <br> # condition = ${if and {\ <br> # {&lt;{$message_size}{50k}}\ <br> ## {!eq{${mask:$acl_m2/16}}{192.168.0.0/16}}\ <br> # {!eq{$sender_address}{}}\ <br> ## {!match_address{$sender_address}{dbm;DB_PREFIX/whitelist_spam_senders.db}}\ <br> # {!match_domain{$acl_m0}{partial1()dbm;DB_PREFIX/whitelist_grey_domains.db}}\ <br> ## {match_domain{$acl_m1}{dbm;DB_PREFIX/domains_spam.db}}\ <br> # }} <br> # spam = nobody:true/defer_ok <br> # set acl_m6 = $spam_score_int <br><br> # add new subj for global exim filter <br> # message = X-New-Subject: SPAM[$spam_score_int/80]: $rh_subject: <br> # condition = ${if and {\ <br> # {def:spam_score_int}\ <br> # {&gt;{$spam_score_int}{80}}\ <br> # }} <br><br> accept <br></div></div><br><br>  That's all. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We run Exim, send an email to ipupkin, look at the logs ... </font></font></div><p>Source: <a href="https://habr.com/ru/post/262101/">https://habr.com/ru/post/262101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262089/index.html">Adding an OpenCV library to an Android Studio project</a></li>
<li><a href="../262091/index.html">Mikrotik VRF + NAT - Managing devices with the same IP address from one host</a></li>
<li><a href="../262093/index.html">Gangbang, protein window and poker with ballerinas: Robots Office Dictionary</a></li>
<li><a href="../262095/index.html">7 steps to launch gh-pages for AngularJS projects created using Yeoman</a></li>
<li><a href="../262097/index.html">Algorithms of attack and protection of mobile advertising network</a></li>
<li><a href="../262103/index.html">Why we encrypt</a></li>
<li><a href="../262105/index.html">Checking JSON using decorators in TypeScript</a></li>
<li><a href="../262113/index.html">Insane experiences on the "implementation" of Windows 3.11 continues</a></li>
<li><a href="../262115/index.html">Icinga2 and agentless monitoring of Windows servers using WMI</a></li>
<li><a href="../262117/index.html">We improve the form of payment with the help of design and animation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>