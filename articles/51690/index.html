<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of the system of separation of access rights in the web application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After writing the last article about the implementation of the system of separation of access rights in a web application , a lot of interesting comme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of the system of separation of access rights in the web application</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="http://zcn.ru/tmp/rights.png">  After writing the last article about the <a href="http://habrahabr.ru/blogs/webdev/51327/">implementation of the system of separation of access rights in a web application</a> , a lot of interesting comments appeared.  They mostly argued that it could be made even better. <br><br>  In fact, the system is not optimized now and cannot be used on servers with high attendance (since the previous article was written more for review). <br>  Let's try to fix it. <br><br>  In this article I will review: <br>  1. Bit fields optimization <br>  2. Serialize with denormalization of DB tables <br>  3. You will learn how a system similar to Zend ACL works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h3>  Where did we leave off </h3><br>  We stopped at the fact that for each object in the database we have the rights for a specific action by the user or group. <br>  It clearly looks like a two-dimensional table (action, group): <br><table><tbody><tr><td></td><td>  message_view </td><td>  message_create </td><td>  message_delete </td><td>  message_edit </td></tr><tr><td>  User21 </td><th>  + </th><th>  + </th><th></th><th>  + </th></tr><tr><td>  Ban </td><th>  - </th><th>  - </th><th>  - </th><th>  - </th></tr><tr><td>  Users </td><th>  + </th><th></th><th></th><th></th></tr><tr><td>  Admin </td><th>  + </th><th>  + </th><th>  + </th><th>  + </th></tr></tbody></table>  The first thing that came to mind was the possibility of combining bits for each user into groups. <br><br><h3>  The transformation is the first.  The use of bit masks. </h3><br>  We can have as many users as we want.  And the number of actions with the object is constant. <br>  Consequently, it is possible to record all actions for a specific user in the form of a binary mask in the database at once. <br><br>  Instead of pluses there will be 1, no action 0. <br><br><h4>  What do we win? </h4>  A variety of actions in a web application usually does not exceed more than 64. Therefore, for most cases, 64 bits will be more than enough.  (8 bytes) <br>  For comparison, each cell of such a database will occupy 40 bytes.  This is the same as if we keep each action separately, only in this case, we will have several entries per user.  Face savings :) <br>  The new table will now look like this: <br><table><tbody><tr><td></td><th>  allow </th><th>  disallow </th></tr><tr><td>  User21 </td><th>  1101 </th><th>  0000 </th></tr><tr><td>  Ban </td><th>  0000 </th><th>  1111 </th></tr><tr><td>  Users </td><th>  1000 </th><th>  0000 </th></tr><tr><td>  Admin </td><th>  1111 </th><th>  0000 </th></tr></tbody></table>  It became less obvious for a person, but more clearly for a computer. <br><br>  Now our (described in the last article) database looks like: <br><table><tbody><tr><th colspan="4">  rights_action </th></tr><tr><th>  ObjectRightsID: int (pk) </th><th>  UserGroupID: int (fk) </th><th>  Allow: VARBINARY (4) </th><th>  Disallow: VARBINARY (4) </th></tr><tr><th colspan="4">  rights_group (sets groups to users) </th></tr><tr><th>  UserRightsID: int (pk) </th><th>  UserGroupID: INT </th></tr></tbody></table>  When combining the rights of sub-objects with global categories of objects, one can use simple OR (A | B for allow) and SUB (A &amp;! B for disallow) operations. <br><br>  Now let's deal with the interface problems for the programmer so that the bits in our program are not confused. <br>  We introduce a bit definition for the action: <br><blockquote><code><font color="black"><font color="#0000ff">public</font> $actions=array(); <br> <br> <font color="#008000">/* SetAction</font> <br> <font color="#008000">  </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">@param {int} bitNumber -    </font> <br> <font color="#008000">@return {Object ObjRights} -    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> SetAction($ActionName, $bitNumber){ <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> (array_search($bitNumber, $ <font color="#0000ff">this</font> -&gt;actions)) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#008000">//    </font> <br> $clone = clone $ <font color="#0000ff">this</font> ; <br> $clone-&gt;actions[$ActionName]=$bitNumber; <br> <br> <font color="#0000ff">return</font> $clone; <br> }</font></code> </blockquote>  Let's do a little class refactoring from the last article.  First we divide user classes and actions.  This is necessary because our actions should not be connected to the user, but they will be tied to objects.  (For example, message objects will have actions of reading, deleting, editing. Objects of user accounts - actions of merging, viewing, etc.) <br><br><h4>  What to do so that the bits of the action do not overlap? </h4>  In the case when each action was determined not by the number of bits, but by a string (for example, 'message_view'), everything was completely clear to programmers.  There was a certain agreement (for example, to define actions. <b>Name of the object: name of the action</b> ), which gave clarity to which object it belonged and multiple options for the absence of intersection. <br><br>  To maintain compatibility in the database, you can use either a separate common database. <b>Object type-&gt; action-&gt; bit number</b> , or agree to use one file for all. <br><br>  I will give an example of such a file: <br><blockquote> <code><font color="black"><font color="#008000">//        </font> <br> $MessageRights= <font color="#0000ff">new</font> ObjRights(); <br> <br> <font color="#008000">//     </font> <br> $MessageRights=$MessageRights-&gt;SetAction( <font color="#A31515">'message_view'</font> ,1)-&gt;SetAction( <font color="#A31515">'message_read'</font> ,2)-&gt;SetAction( <font color="#A31515">'message_edit'</font> ,3)-&gt;SetAction( <font color="#A31515">'message_delete'</font> ,4)-&gt;SetAction( <font color="#A31515">'message_create'</font> ,5); <br> <br> <font color="#008000">//  </font> <br> $MessageRights=$MessageRights-&gt;SetAction( <font color="#A31515">'comment_view'</font> ,6)-&gt;SetAction( <font color="#A31515">'comment_create'</font> ,7)-&gt;SetAction( <font color="#A31515">'comment_delete'</font> ,8); <br> <br> <font color="#008000">//...       ,      .</font> <br> <font color="#008000">//        </font> <br> $UserRights= <font color="#0000ff">new</font> ObjRights(); <br> <br> $UserRights=$UserRights-&gt;SetAction( <font color="#A31515">'user_edit'</font> ,1)-&gt;SetAction( <font color="#A31515">'user_delete'</font> ,2)-&gt;SetAction( <font color="#A31515">'user_create'</font> ,3);</font></code> </blockquote> <br>  Now it's time to deal with our users and get a ready, working program. <br>  In the case of users, nothing changes.  The only change is that we will need to use the user rights object for different classes separately. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//   </font> <br> <font color="#0000ff">class</font> UsrRights{ <br> <font color="#0000ff">public</font> $groupID=array(); <br> <font color="#0000ff">function</font> __construct($rightsID){ <br> <font color="#008000">//      () ,    </font> <br> $result=mysql_query( <font color="#A31515">"SELECT `group_rights`.groupID FROM `group_rights` WHERE `group_rights`.rightsID = $rightsID"</font> ); <br> <br> $ <font color="#0000ff">this</font> -&gt;groupID = array(); <br> <font color="#0000ff">while</font> ($t=mysql_fetch_assoc($result)){ <br> <font color="#008000">//  ID </font> <br> $ <font color="#0000ff">this</font> -&gt;groupID[] = $t[ <font color="#A31515">'groupID'</font> ]; <br> } <br> mysql_free_result($result); <br> } <br> } <br> <br> <font color="#008000">//      </font> <br> <font color="#0000ff">class</font> ObjRights{ <br> <font color="#0000ff">public</font> $actions=array(); <br> <font color="#0000ff">public</font> $groupallow=array(),$groupdisallow=array(); <br> <font color="#008000">/* SetAction</font> <br> <font color="#008000">  </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">@param {int} bitNumber -    </font> <br> <font color="#008000">@return {Object ObjRights} -    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> SetAction($ActionName, $bitNumber){ <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> (array_search($bitNumber, $ <font color="#0000ff">this</font> -&gt;actions)) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#008000">//    </font> <br> $clone = clone $ <font color="#0000ff">this</font> ; <br> $clone-&gt;actions[$ActionName]=$bitNumber; <br> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#008000">/* include_right</font> <br> <font color="#008000">   </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} RightsID -  </font> <br> <font color="#008000">@return {Object ObjRights} -    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> include_right($RightsID){ <br> $clone=clone $ <font color="#0000ff">this</font> ; <br> $result=mysql_query( <font color="#A31515">"SELECT * FROM `action_rights` WHERE `action_rights`.rightsID = $RightsID"</font> ); <br> <font color="#0000ff">while</font> ($t=mysql_fetch_assoc($result)){ <br> <font color="#008000">//     </font> <br> $clone-&gt;calculate_allow($t[ <font color="#A31515">'groupID'</font> ],$t[ <font color="#A31515">'allow'</font> ],$t[ <font color="#A31515">'disallow'</font> ]); <br> } <br> mysql_free_result($result); <br> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#008000">/* calculate_allow</font> <br> <font color="#008000">   ,   </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} GroupID -  </font> <br> <font color="#008000">@param {string} AllowMask -      </font> <br> <font color="#008000">@param {string} DisallowMask -       </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">function</font> calculate_allow($GroupID, $AllowMask, $DisallowMask){ <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID])){ <br> <font color="#008000">// -    -  </font> <br> $len=min(strlen($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]),strlen($AllowMask)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;$len;$i++) <br> <font color="#008000">//Allow |= Mask</font> <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$i}=chr(ord($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$i})|ord($AllowMask{$i})); <br> <br> <font color="#008000">// -    -  </font> <br> $len=min(strlen($ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]),strlen($DisallowMask)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;$len;$i++) <br> <font color="#008000">//Disallow |= Mask</font> <br> $ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$i}=chr(ord($ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$i})|ord($DisallowMask{$i})); <br> } <font color="#0000ff">else</font> { <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]=$AllowMask; <br> $ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]=$DisallowMask; <br> } <br> } <br> <font color="#008000">/* isAllow</font> <br> <font color="#008000">          </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {Object UsrRights} UserRights -  ,    </font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">@return {bool} -      ?</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> isAllow($UserRights, $ActionName){ <br> <font color="#008000">// ?</font> <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <font color="#008000">//    </font> <br> $Actionbit=$ <font color="#0000ff">this</font> -&gt;actions[$ActionName]; <br> <br> <font color="#0000ff">foreach</font> ($UserRights-&gt;groupID <font color="#0000ff">as</font> $grpname){ <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt;checkgrp($grpname,$Actionbit)) <br> <font color="#008000">//     ,   </font> <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> <font color="#008000">/* checkgrp</font> <br> <font color="#008000">    </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} GroupID -  </font> <br> <font color="#008000">@param {int} bit -  </font> <br> <font color="#008000">@return {bool} -       </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">function</font> checkgrp($GroupID, $bit){ <br> <font color="#008000">//  ?</font> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID])){ <br> <font color="#008000">//   Allow &amp; NOT Disallow &amp; bit</font> <br> <font color="#0000ff">if</font> ((ord($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$bit&gt;&gt;3})&amp;(~ord($ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$bit&gt;&gt;3}))&amp;(1&lt;&lt;($bit&amp;7)))!=0){ <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  Using this library is easy.  You must first allocate the permissible rights to the object classes (example above), and then initializing the user (me, his identifier for groups of rights), check him with the necessary rights in the object: <br><blockquote> <code><font color="black"><font color="#008000">//  </font> <br> $MessageRights = <font color="#0000ff">new</font> ObjRights(); <br> $MessageRights = $MessageRights-&gt;SetAction( <font color="#A31515">'message_view'</font> ,0)-&gt; <br> SetAction( <font color="#A31515">'message_read'</font> ,1)-&gt; <br> SetAction( <font color="#A31515">'message_edit'</font> ,2)-&gt; <br> SetAction( <font color="#A31515">'message_delete'</font> ,3)-&gt; <br> SetAction( <font color="#A31515">'message_create'</font> ,4); <br> <font color="#008000">//...</font> <br> <br> <font color="#008000">//    ()</font> <br> $CurrentUserRights = <font color="#0000ff">new</font> UseRights($CurrentUser-&gt;rightsID); <br> <br> <font color="#008000">//...</font> <br> <br> <font color="#008000">//  ,      .</font> <br> $PageRights = $MessageRights-&gt;include_right($MainPage-&gt;rightsID); <br> <br> <font color="#008000">//,     ?</font> <br> <font color="#0000ff">if</font> ($PageRights-&gt;isAllow($CurrentUserRights, <font color="#A31515">'message_view'</font> )){ <br> <font color="#008000">//, .     ?</font> <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">foreach</font> ($MainPage-&gt;Messages <font color="#0000ff">as</font> $msg){ <br> <font color="#008000">//    (parent),    (child)</font> <br> $MsgRights = $PageRights-&gt;include_right($msg-&gt;rightsID); <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;isAllow($CurrentUserRights, <font color="#A31515">'message_view'</font> )){ <br> <font color="#008000">//   ,      ?</font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;isAllow($CurrentUserRights, <font color="#A31515">'message_edit'</font> )) <br> $msg-&gt;editable_flag = 1; <br> <font color="#008000">//  ?</font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;isAllow($CurrentUserRights, <font color="#A31515">'message_delete'</font> )) <br> $msg-&gt;delete_flag = 1; <br> <br> DrawMessage($msg); <br> } <br> } <br> }</font></code> </blockquote> <br>  As a result, compared to the example from the first article, we have several times accelerated access to the database and reduced the number of hits. <br><br>  But is it even faster? <br>  Yes, you can make a few more code optimizations, but I will not, so as not to lose visibility (and so the code has come over too much :)). <br>  We will just go another way, improving the algorithm ... <br><br><h3>  The transformation is the second.  Getting ready PHP objects from the database. </h3><br>  Now we will talk about how builders of sites with high user traffic optimize their code. <br>  The creators of PHP have created two functions with which you can save and get ready-made structures (arrays, objects) data. <br>  These are the functions serialize and unserialize. <br><br><h4>  And how will they help us? </h4>  Now in our code, when selecting each message (object) that has (unchanged) its rights, there is an additional selection from the rights_action table.  For each object - this sample is the same until we decide to change it (adding new rights to the object).  In one change of the rights of our object, there are more than a thousand / millions of readings. <br>  Why do several unnecessary conversions to the format we need?  This is how each reading occurs.  Thus, this can be done only once (when generating / changing rights) and save the finished result.  To save the result and restore, the functions serialize / unserialize will help us. <br><br>  We will finalize our library: <blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">function</font> include_right($grp){ <br> <font color="#008000">//     (child)</font> <br> $clone=clone $ <font color="#0000ff">this</font> ; <br> <br> <font color="#008000">//   ,   </font> <br> $result=unserialize($grp); <br> <br> <font color="#008000">//   array('GroupID'=&gt;array('allow_bits','disallow_bits'),'GroupID2'=&gt;array('allow_bits','disallow_bits'),...)</font> <br> <font color="#0000ff">foreach</font> ($result <font color="#0000ff">as</font> $groupID=&gt;$allow) <br> <font color="#008000">//   ,    </font> <br> $clone-&gt;include_action($groupID,$allow[0],$allow[1]); <br> <br> <font color="#0000ff">return</font> $clone; <br> }</font></code> </blockquote>  It became easier and clearer! <br>  True in this case, we have the problem of changing the rights (for each mask).  Let's try to write functions for this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">function</font> export_object_rights(){ <br> <font color="#0000ff">return</font> serialize($this-&gt;selfrights); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> allow_group($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> $bit=$ <font color="#0000ff">this</font> -&gt;actions[$ActionName]; <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$bit&gt;&gt;3}|=(1&lt;&lt;($bit&amp;8)); <br> } <font color="#0000ff">else</font> { <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$bit&gt;&gt;3}=(1&lt;&lt;($bit&amp;8)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;($bit&gt;&gt;3);$i++) <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$i}=chr(0); <br> } <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][0]{$bit&gt;&gt;3}|=(1&lt;&lt;($bit&amp;8)); <br> } <font color="#0000ff">else</font> { <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID]=array(); <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][0]{$bit&gt;&gt;3}=(1&lt;&lt;($bit&amp;8)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;($bit&gt;&gt;3);$i++) <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][0]{$i}=chr(0); <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][1]= <font color="#A31515">""</font> ; <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> reset_group($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> $bit=$ <font color="#0000ff">this</font> -&gt;actions[$ActionName]; <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$bit&gt;&gt;3}&amp;=255^(1&lt;&lt;($bit&amp;8)); <br> } <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$bit&gt;&gt;3}&amp;=255^(1&lt;&lt;($bit&amp;8)); <br> } <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][0]{$bit&gt;&gt;3}&amp;=255^(1&lt;&lt;($bit&amp;8)); <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][1]{$bit&gt;&gt;3}&amp;=255^(1&lt;&lt;($bit&amp;8)); <br> <br> $nul= <font color="#0000ff">true</font> ; <br> <font color="#0000ff">for</font> ($i=0;$i&lt;strlen(selfrights[$GroupID][0]);$i++) <br> <font color="#0000ff">if</font> (selfrights[$GroupID][0]{$i}) <br> $nul= <font color="#0000ff">false</font> ; <br> <br> <font color="#0000ff">for</font> ($i=0;$i&lt;strlen(selfrights[$GroupID][1]);$i++) <br> <font color="#0000ff">if</font> (selfrights[$GroupID][1]{$i}) <br> $nul= <font color="#0000ff">false</font> ; <br> <br> <font color="#0000ff">if</font> ($nul) <br> unset(selfrights[$GroupID]); <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> disallow_group($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;actions[$ActionName])) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> $bit=$ <font color="#0000ff">this</font> -&gt;actions[$ActionName]; <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$bit&gt;&gt;3}|=(1&lt;&lt;($bit&amp;8)); <br> } <font color="#0000ff">else</font> { <br> $ <font color="#0000ff">this</font> -&gt;groupdisallow[$GroupID]{$bit&gt;&gt;3}=(1&lt;&lt;($bit&amp;8)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;($bit&gt;&gt;3);$i++) <br> $ <font color="#0000ff">this</font> -&gt;groupallow[$GroupID]{$i}=chr(0); <br> } <br> <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID])){ <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][1]{$bit&gt;&gt;3}|=(1&lt;&lt;($bit&amp;8)); <br> } <font color="#0000ff">else</font> { <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID]=array(); <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][1]{$bit&gt;&gt;3}=(1&lt;&lt;($bit&amp;8)); <br> <font color="#0000ff">for</font> ($i=0;$i&lt;($bit&gt;&gt;3);$i++) <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][1]{$i}=chr(0); <br> $ <font color="#0000ff">this</font> -&gt;selfrights[$GroupID][0]= <font color="#A31515">""</font> ; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Eerie looks, is not it true-Lee?  I didn‚Äôt even check this code :), I was just scared - everything is so creepy.  Such code in red and white tells us that something in the architecture is wrong. <br>  I propose to cut off unnecessary and unnecessary tails!  Make the code readable and more versatile. <br><br><h4>  Mode extra tails! </h4><br>  Our structure now looks like this: <br>  array (/ * GroupID * / 1 =&gt; array (allow =&gt; 0b100101000100100010 / * bits * /, disallow =&gt; 0b100010010000010001010), 4 =&gt; ...) <br><br>  In this form, it serializes to it and it is written to the object. <br>  But, firstly, it is difficult to work with actions (you have to add new ones by editing the PHP file). <br>  Secondly, the search for bits is not so easy.  And let's try to return to the original version, discussed in the previous article. <br><br>  That is, now the access rights will look like this: <br>  array (/ * GroupID * / 1 =&gt; array (/ * Actions * / 'message_read' =&gt; 1 / * + * /, 'message_edit' =&gt; 0 / * - * /), 4 =&gt; ...) <br>  Thereby: <br>  1) The search for the desired action is done by one command $ array [GroupID] [ActionName].  (I am sure that this will help speed up the search process) <br>  2) No need to add action.  All of them will be stored in our facility. <br>  3) Sampling will occur in one cycle, only by user groups. <br>  4) User groups themselves can take on a human appearance. <br>  The only visual negative - the structure will take up more space.  Poorly?  Yes, but in optimization it is always the case - either the load on the CPU, or the amount of memory.  Yes, and the memory of the database it does not eat much, so we proceed. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//      </font> <br> <font color="#0000ff">class</font> ObjRights{ <br> <font color="#0000ff">public</font> $groups=array(); <br> <font color="#0000ff">public</font> $selfgroups=array(); <br> <br> <font color="#008000">/*    */</font> <br> <br> <font color="#008000">/* include_right</font> <br> <font color="#008000">   </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {serialize array} RightsID -   </font> <br> <font color="#008000">@return {Object ObjRights} -    </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> include_right($RightsID){ <br> $clone=clone $ <font color="#0000ff">this</font> ; <br> <br> <font color="#008000">//  SQL-,      </font> <br> $clone-&gt;selfgroups = unserialize($RightsID); <br> <br> <font color="#0000ff">foreach</font> ($clone-&gt;selfgroups <font color="#0000ff">as</font> $groupID=&gt;$actions){ <br> <font color="#0000ff">if</font> (isset($clone-&gt;groups[$groupID])){ <br> <font color="#008000">//  ,       </font> <br> <font color="#0000ff">foreach</font> ($actions <font color="#0000ff">as</font> $actname=&gt;$allow){ <br> <font color="#0000ff">if</font> (isset($clone-&gt;groups[$groupID][$actname])) <br> <font color="#008000">// 1 - allow, 0 - disallow</font> <br> $clone-&gt;groups[$groupID][$actname]&amp;=$allow; <br> <font color="#0000ff">else</font> <br> $clone-&gt;groups[$groupID][$actname]=$allow; <br> } <br> } <font color="#0000ff">else</font> <br> <font color="#008000">//  ,   </font> <br> $clone-&gt;groups[$groupID]=$actions; <br> <br> } <br> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#008000">/* isAllow</font> <br> <font color="#008000">          </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {array} UserRights -  ,    </font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">@return {bool} -      ?</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> isAllow($UserRights, $ActionName){ <br> <br> <font color="#0000ff">foreach</font> ($UserRights <font color="#0000ff">as</font> $groupname){ <br> <font color="#008000">//  </font> <br> <font color="#0000ff">if</font> (isset ($ <font color="#0000ff">this</font> -&gt;groups[$groupname]) &amp;&amp; <br> isset ($ <font color="#0000ff">this</font> -&gt;groups[$groupname][$ActionName]) &amp;&amp; <br> $ <font color="#0000ff">this</font> -&gt;groups[$groupname][$ActionName]) <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> <font color="#008000">/* export_rights</font> <br> <font color="#008000">      . (serialize array)</font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@return {string} - serialize array</font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> export_rights(){ <br> <font color="#0000ff">return</font> serialize($ <font color="#0000ff">this</font> -&gt;selfgroups); <br> } <br> <br> <br> <font color="#008000">/*    */</font> <br> <br> <font color="#008000">/* allow</font> <br> <font color="#008000">     </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} GroupID -  </font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> allow($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID])) <br> $ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID]=array(); <br> $ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID][$ActionName] = 1; <br> } <br> <br> <font color="#008000">/* disallow</font> <br> <font color="#008000">      </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} GroupID -  </font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> disallow($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID])) <br> $ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID]=array(); <br> $ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID][$ActionName] = 0; <br> } <br> <br> <font color="#008000">/* reset</font> <br> <font color="#008000">      </font> <br> <font color="#008000">&nbsp;&nbsp;</font> <br> <font color="#008000">@param {int} GroupID -  </font> <br> <font color="#008000">@param {string} ActionName -  </font> <br> <font color="#008000">*/</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">function</font> reset($GroupID, $ActionName){ <br> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID]) &amp;&amp; isset($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID][$ActionName])) <br> unset($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID][$ActionName]); <br> <font color="#0000ff">if</font> ($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID] === array()) <br> unset ($ <font color="#0000ff">this</font> -&gt;selfgroups[$GroupID]); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  All these records will be stored in the database, right in a separate field of the table object.  That is, like this: <br><table><tbody><tr><th colspan="5">  page </th></tr><tr><th>  pageID </th><th>  page_name </th><th>  page_rights <br>  (rights in the serialize form) </th></tr><tr><th colspan="5">  messages </th></tr><tr><th>  messID </th><th>  pageID </th><th>  message_rights <br>  (rights in the serialize form) </th><th>  message_header </th><th>  message_text </th></tr></tbody></table><br><h4>  What else can you do? </h4><br><br>  For fans of JSON, you can use instead of serialize / unserialize =&gt; json_encode / json_decode, which in theory should work faster and take up less space in the database. <br><br>  For lovers of more humane group names, nothing is required in order to change the whole GroupID from int to string. <br><br>  You can use $ _SESSION, if the user has logged in, to memorize all his rights $ User-&gt; current_user-&gt; rights (and other user information), in order not to access the database and not to perform unnecessary actions.  The only drawback is that in order for the user to change access rights, he will need to log in. <br><br><h3>  Working example </h3><br>  Bitmasks: <br>  <a href="http://zcn.ru/examples/rights2/test0.php">Working example</a> <br>  <a href="http://zcn.ru/examples/rights2/">test0.php</a> <br>  <a href="http://zcn.ru/examples/rights2/">rights0.php</a> <br><br>  Serialize: <br>  <a href="http://zcn.ru/examples/rights2/test.php">Working example</a> <br>  <a href="http://zcn.ru/examples/rights2/">test.php</a> <br>  <a href="http://zcn.ru/examples/rights2/">rights.php</a> <br><br><h3>  Afterword </h3><br>  Zend offers a very similar mechanism for working with rights (the latest example of Serialize). <br>  You have already learned the basics here (how it functions and where your legs grow from). <br>  Zend_Acl offers a similar interaction description library.  Who exactly how to use Zend_Acl can read on the <a href="http://www.google.com/search%3Fhl%3Dru%26client%3Dopera%26rls%3Den%26hs%3DXrO%26q%3DZend_Acl%26btnG%3D%25D0%259F%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%26lr%3D">Internet</a> .  I think that after this article you will quickly understand. <br><br>  <b>ps</b> thanks to everyone who left comments on the last article on this topic.  Without you there would not be this article. </div><p>Source: <a href="https://habr.com/ru/post/51690/">https://habr.com/ru/post/51690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51682/index.html">Wonderful thing for only 271 rubles</a></li>
<li><a href="../51685/index.html">freedom of choice</a></li>
<li><a href="../51686/index.html">Microsoft Small Basic 0.3 Release Released</a></li>
<li><a href="../51688/index.html">Acer has updated Aspire One to version AOD150</a></li>
<li><a href="../51689/index.html">Software developer</a></li>
<li><a href="../51691/index.html">International Year of Astronomy - film "Eyes on the Skies"</a></li>
<li><a href="../51692/index.html">Experiment with Habr and Alexa. The truth is somewhere near!</a></li>
<li><a href="../51693/index.html">Briefly about the main</a></li>
<li><a href="../51694/index.html">Yandex. Photos for iPhone / iPod touch</a></li>
<li><a href="../51695/index.html">Questions for interviews with Internet Explorer architect Alexei Mogilevsky</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>