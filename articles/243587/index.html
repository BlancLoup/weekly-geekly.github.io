<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analytical report on Microsoft SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 
 Identify bottlenecks when working with databases. Make a report on the performance of sql queries, analyze errors and dea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analytical report on Microsoft SQL Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/578/f95/ab4/578f95ab42f54c4fb3ae43ca8fb80a56.png" alt="Analytical report on Microsoft SQL Server"><br><br><h3>  Formulation of the problem </h3><br>  Identify bottlenecks when working with databases.  Make a report on the performance of sql queries, analyze errors and deadlocks, make comparative reports, calculate the degree of coverage of the stored procedures with tests, build charts. <br><br>  Testing is carried out regularly.  Therefore, reports should be generated automatically, be standardized, easily compared with each other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Used technologies: <br><ul><li>  <b>Microsoft SQL Server</b> ; </li><li>  <b>Microsoft Office Excel</b> ; </li><li>  Complex sql queries organized in the project <b>SQLProfilerReportHelper</b> ; </li><li>  Load testing tool with the ability to execute sql query ( <b>JMeter</b> , <b>Visual Studio Ultimate</b> , ...); </li></ul><br><br>  <b>Level 300</b> (for professionals). <br><br>  In short, the procedure for generating reports on a finished trail is: <br><ol><li>  run <b>SQLProfilerReportHelper</b> , click on the buttons; </li><li>  perform a selection of records from the table-reports, copy the results to the clipboard; </li><li>  run <b>Microsoft Office Excel</b> , insert records from the buffer into an automatically formatted table and save the document report. </li></ol><br>  The tool and report template are available for download <a href="https://github.com/polarnik/SQLProfilerReportHelper">SQLProfilerReportHelper</a> . <br>  If you are interested in reading the description of the tool and reports and the order in which they are compiled, read on. <br><a name="habracut"></a><br><br>  I'll tell you about two main reports: <br><ul><li>  statistics of stored procedures (Draft report); </li><li>  statistics of all requests (Detail report). </li></ul><br><br><h3>  1. Tracing </h3><br><blockquote>  The process cannot be understood by stopping it.  Understanding must move with the process, merge with its flow and flow with it. <br>  - from the novel ‚ÄúDune‚Äù by Frank Herbert <br></blockquote><br><img src="https://habrastorage.org/files/cd5/b0d/29c/cd5b0d29c6cf443599a295a567384988.png" alt="Tracing"><br>  Tracing, the results of which are analyzed automatically, implies the presence of specific events and columns.  Convenient software start at the start of the load test.  This is the way I use, other options are possible. <br><br>  When profiling a loaded <a href="https://ru.wikipedia.org/wiki/OLTP">OLTP</a> system, it is better to save traces to files.  By downloading trace files to a table, the database is already after testing.  This creates a lesser additional load on <b>SQL Server</b> than when writing a trace to the database (how much less it did not measure).  And less space is consumed (trace files are 3.9-4 times smaller than a similar trace table).  Further it is assumed that OLTP and load testing are being tested. <br>  When profiling an <a href="https://ru.wikipedia.org/wiki/OLAP">OLAP</a> system, when the load is low, you can write traces directly to the database. <br><br><h4>  1.1.  Auto start </h4><br><img src="https://habrastorage.org/files/f8d/d21/7fb/f8dd217fb7974a76a88a4af1e43b80f2.png" alt="Automatic start of load test"><br>  It is convenient to start profiling in the event of the beginning of the load test.  In the context of a load test, determine the parameters whose values ‚Äã‚Äãare conveniently changed without changing the code of the load test: <br><ul><li>  <b>useSQLProfiling</b> (true / false) - use tracing when running a test (for example, true) </li><li>  <b>pathSQLPrifiling</b> - path to the directory on the server with <b>Microsoft SQL Server</b> for saving trace files (for example, D: \ Traces \ Synerdocs \) </li><li>  database names (four parameters) - I use to filter profiling events ( <b>tempdb</b> and three databases of the system under test) </li></ul><br>  From the context of the load test, the name of the load profile is also extracted, which is reflected in the name of the trace files.  And the load profile is extracted test duration, to calculate the moment of completion of the trace. <br><br>  A parameterized <b>Script.01.Start trace.sql</b> request <b>is executed</b> (see the <b>scripts \ start trace \</b> directory in the project folder or in the box below). <br><div class="spoiler">  <b class="spoiler_title">Script.01.Start trace.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Script.01.Start trace.sql -- : -- @traceDuration, Int, " ( )" --      ,   . -- @fileName, nvarchar(256), "   " --      ,      . -- D:\Traces\Synerdocs\ServiceLoadTestBigFiles.2014.01.21 08.30.10 -- @db1, nvarchar(256),      -- @db2, nvarchar(256),      -- @db3, nvarchar(256),      -- @db4, nvarchar(256),      -- Create a Queue declare @rc int declare @TraceID int declare @maxfilesize bigint declare @stopTraceTime datetime declare @traceFileName nvarchar(256) declare @traceOptions int -- Create 100 MBytes files set @maxfilesize = 100 -- Duration of trace set @stopTraceTime = DATEADD(second, @traceDuration, SYSDATETIME()) -- Trace filename set @traceFileName = @fileName -- TRACE_FILE_ROLLOVER set @traceOptions = 2 exec @rc = sp_trace_create @TraceID output, @traceOptions, @traceFileName, @maxfilesize, @stopTraceTime if (@rc != 0) goto error -- Set the events declare @on bit set @on = 1 -- 162. User Error Message. Displays error messages that users see in the case of an error or exception. exec sp_trace_setevent @TraceID, 162, 1, @on -- TextData. ntext. exec sp_trace_setevent @TraceID, 162, 4, @on -- TransactionID. bigint. exec sp_trace_setevent @TraceID, 162, 9, @on -- ClientProcessID. int. exec sp_trace_setevent @TraceID, 162, 10, @on -- ApplicationName. nvarchar. exec sp_trace_setevent @TraceID, 162, 11, @on -- LoginName. nvarchar. exec sp_trace_setevent @TraceID, 162, 12, @on -- SPID. int. exec sp_trace_setevent @TraceID, 162, 20, @on -- Severity. exec sp_trace_setevent @TraceID, 162, 14, @on -- StartTime. datetime. exec sp_trace_setevent @TraceID, 162, 31, @on -- Error. int. exec sp_trace_setevent @TraceID, 162, 35, @on -- DatabaseName. nvarchar. exec sp_trace_setevent @TraceID, 162, 49, @on -- RequestID. int. exec sp_trace_setevent @TraceID, 162, 50, @on -- XactSequence. bigint. -- 148. Deadlock Graph. Occurs when an attempt to acquire a lock is canceled because the attempt was part of a deadlock and was chosen as the deadlock victim. Provides an XML description of a deadlock. exec sp_trace_setevent @TraceID, 148, 1, @on -- TextData. ntext. exec sp_trace_setevent @TraceID, 148, 4, @on -- TransactionID. bigint. Not used. exec sp_trace_setevent @TraceID, 148, 11, @on -- LoginName. nvarchar. exec sp_trace_setevent @TraceID, 148, 12, @on -- SPID. int. exec sp_trace_setevent @TraceID, 148, 14, @on -- StartTime. datetime. -- 10. RPC:Completed. Occurs when a remote procedure call (RPC) has completed. exec sp_trace_setevent @TraceID, 10, 1, @on -- TextData. ntext. exec sp_trace_setevent @TraceID, 10, 4, @on -- TransactionID. bigint. exec sp_trace_setevent @TraceID, 10, 9, @on -- ClientProcessID. int. exec sp_trace_setevent @TraceID, 10, 10, @on -- ApplicationName. nvarchar. exec sp_trace_setevent @TraceID, 10, 11, @on -- LoginName. nvarchar. exec sp_trace_setevent @TraceID, 10, 12, @on -- SPID. int. exec sp_trace_setevent @TraceID, 10, 13, @on -- Duration. bigint. exec sp_trace_setevent @TraceID, 10, 14, @on -- StartTime. datetime. exec sp_trace_setevent @TraceID, 10, 15, @on -- EndTime. datetime. exec sp_trace_setevent @TraceID, 10, 16, @on -- Reads. bigint. exec sp_trace_setevent @TraceID, 10, 17, @on -- Writes. bigint. exec sp_trace_setevent @TraceID, 10, 18, @on -- CPU. int. exec sp_trace_setevent @TraceID, 10, 31, @on -- Error. int. exec sp_trace_setevent @TraceID, 10, 34, @on -- ObjectName. nvarchar. exec sp_trace_setevent @TraceID, 10, 35, @on -- DatabaseName. nvarchar. exec sp_trace_setevent @TraceID, 10, 48, @on -- RowCounts. bigint. exec sp_trace_setevent @TraceID, 10, 49, @on -- RequestID. int. exec sp_trace_setevent @TraceID, 10, 50, @on -- XactSequence. bigint. -- 12. SQL:BatchCompleted. Occurs when a Transact-SQL batch has completed. exec sp_trace_setevent @TraceID, 12, 1, @on -- TextData. ntext. exec sp_trace_setevent @TraceID, 12, 4, @on -- TransactionID. bigint. exec sp_trace_setevent @TraceID, 12, 9, @on -- ClientProcessID. int. exec sp_trace_setevent @TraceID, 12, 11, @on -- LoginName. nvarchar. exec sp_trace_setevent @TraceID, 12, 10, @on -- ApplicationName. nvarchar. exec sp_trace_setevent @TraceID, 12, 12, @on -- SPID. int. exec sp_trace_setevent @TraceID, 12, 13, @on -- Duration. bigint. exec sp_trace_setevent @TraceID, 12, 14, @on -- StartTime. datetime. exec sp_trace_setevent @TraceID, 12, 15, @on -- EndTime. datetime. exec sp_trace_setevent @TraceID, 12, 16, @on -- Reads. bigint. exec sp_trace_setevent @TraceID, 12, 17, @on -- Writes. bigint. exec sp_trace_setevent @TraceID, 12, 18, @on -- CPU. int. exec sp_trace_setevent @TraceID, 12, 31, @on -- Error. int. exec sp_trace_setevent @TraceID, 12, 35, @on -- DatabaseName. nvarchar. exec sp_trace_setevent @TraceID, 12, 48, @on -- RowCounts. bigint. exec sp_trace_setevent @TraceID, 12, 49, @on -- RequestID. int. exec sp_trace_setevent @TraceID, 12, 50, @on -- XactSequence. bigint. -- Set the Filters exec sp_trace_setfilter @TraceID, 35, 0, 6, @db1 exec sp_trace_setfilter @TraceID, 35, 1, 6, @db2 exec sp_trace_setfilter @TraceID, 35, 1, 6, @db3 exec sp_trace_setfilter @TraceID, 35, 1, 6, @db4 -- Set the trace status to start exec sp_trace_setstatus @TraceID, 1 -- display trace id for future references select TraceID=@TraceID goto finish error: select ErrorCode=@rc finish:</span></span></code> </pre> <br></div></div><br>  Return Values: <br><ul><li>  TraceID, int, trace session identifier, useful to stop tracing later; </li><li>  ErrorCode, int, error code, if the trace has not started, see Return Code Values ‚Äã‚Äãfor <a href="http://msdn.microsoft.com/en-us/library/ms190362">sp_trace_create</a> . </li></ul><br><br>  The way a query is executed in a load test event depends on the testing tool and development language.  Both in Java and in C # it becomes simply.  You can write a separate manual.  Some features in two sentences: <br><ol><li>  Events are executed on the load agent, when there are several load agents, in the parameters of the load test the name of the agent that will perform the start and early completion of profiling is set, the agent learns about its purpose by name. </li><li>  If the <b>SQL Server</b> is located behind the <a href="https://ru.wikipedia.org/wiki/DMZ_%2528%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25BF%25D1%258C%25D1%258E%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D1%2581%25D0%25B5%25D1%2582%25D0%25B8%2529">DMZ</a> , then the agent working with <b>SQL Server</b> is placed on the Edge Server, and a zero load profile is assigned to the agent, but it is simpler not to use the DMZ on the load bench. </li></ol><br>  Experts familiar with stress testing will understand the previous two sentences.  If you could not understand, then you do not have agents, DMZ, or it is easier for you to run the trace in semi-automatic and manual mode. <br><br><h5>  1.1.1.  Tracing stop </h5><br><img src="https://habrastorage.org/files/6da/2bb/e13/6da2bbe135a74740a06117fd5636feaf.png" alt="Established tracing stop"><br>  Tracing runs on time.  The moment of completion of the trace is determined by the duration of the test (the <b>traceDuration</b> parameter) and is calculated in the <b>Script.01.Start trace.sql</b> script.  It is assumed that load testing also runs for a while, has a duration that can be obtained programmatically. <br><br><h5>  1.1.2.  Early termination </h5><br><img src="https://habrastorage.org/files/a49/d68/d83/a49d68d837f049f39f7e74e94ed2d7aa.png" alt="Early termination tracing"><br>  When running <b>Script.01.Start trace.sql, TraceId is</b> returned.  If testing stops early, in the test termination event, the <b>TraceId</b> value <b>is</b> passed to the script: <br><pre> <code class="sql hljs"> <span class="hljs-comment"><span class="hljs-comment">-- Stops the specified trace. EXEC sp_trace_setstatus @traceid = @traceid , @status = 0 -- Closes the specified trace and deletes its definition from the server. EXEC sp_trace_setstatus @traceid = @traceid , @status = 2</span></span></code> </pre><br><br><h4>  1.2.  Semi-automatic start </h4><br><img src="https://habrastorage.org/files/4ac/5ea/dab/4ac5eadabfb24429ace5be58dc8cdf0a.png"><br>  If it is not possible to automatically execute the sql query at the start of the test, then the <b>Script.01.Start trace.sql query</b> can be executed manually from <b>SQL Management Studio by</b> defining the script parameters. <br><br>  If the stop time cannot be calculated at the start of the trace, then the <b>stopTraceTime</b> parameter <b>should</b> not be passed to the <b>sp_trace_create</b> procedure (see Script.01.Start trace.sql: 29). <br><h5>  1.2.1.  Tracing stop </h5><h5><img src="https://habrastorage.org/files/b51/433/2c8/b514332c8da648d595a366876ff8d369.png"><br>  You can also stop profiling by a script by selecting the tracing session to be stopped, for example, by directory (D: \ Traces \ Synerdocs \): <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Script.02.Stop trace.sql DECLARE @traceid INT SET @traceid = (SELECT TOP 1 [id] FROM sys.traces WHERE [path] LIKE 'D:\Traces\Synerdocs\%') IF @traceid IS NOT NULL BEGIN -- Stops the specified trace. EXEC sp_trace_setstatus @traceid = @traceid , @status = 0 -- Closes the specified trace and deletes its definition from the server. EXEC sp_trace_setstatus @traceid = @traceid , @status = 2 END SELECT * FROM sys.traces</span></span></code> </pre><br><br></h5><h4>  1.3.  Manual start </h4><br><img src="https://habrastorage.org/files/33b/445/ec3/33b445ec353d49d586c68c7ded0dc017.png"><br>  <b>Microsoft SQL Server Profiler</b> allows you to collect a large number of events. <br>  See <b>sp_trace_setevent</b> ( <a href="http://msdn.microsoft.com/ru-ru/library/ms186265.aspx">http://msdn.microsoft.com/ru-ru/library/ms186265.aspx</a> ). <br>  As the most interesting events, I will highlight errors, blocking, execution of procedures and queries: <br><table><tbody><tr><th>  ID (EventID) </th><th>  Event (Event Name) </th><th>  Description (Event description) </th></tr><tr><td>  162 </td><td>  User Error Message </td><td>  Error message exception </td></tr><tr><td>  148 </td><td>  Deadlock graph </td><td>  It is canceled when it comes to deadlock. </td></tr><tr><td>  ten </td><td>  RPC: Completed </td><td>  Occurs when a remote procedure call (RPC) has completed. </td></tr><tr><td>  12 </td><td>  SQL: BatchCompleted </td><td>  Occurs when a Transact-SQL batch has completed. </td></tr></tbody></table><br><br>  Selected events have the most interesting columns: <br><table><tbody><tr><th>  Columnid </th><th>  ColumnName </th><th>  Type </th><th>  Errors </th><th>  Locks </th><th>  Procedures </th><th>  Requests </th></tr><tr><td>  one </td><td>  Textdata </td><td>  ntext </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  13 </td><td>  Duration </td><td>  bigint </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  14 </td><td>  Starttime </td><td>  datetime </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  sixteen </td><td>  Reads </td><td>  bigint </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  17 </td><td>  Writes </td><td>  bigint </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  18 </td><td>  CPU </td><td>  int </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  31 </td><td>  Error </td><td>  int </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr><tr><td>  34 </td><td>  ObjectName </td><td>  nvarchar </td><td></td><td></td><td>  + </td><td></td></tr><tr><td>  35 </td><td>  Databasename </td><td>  nvarchar </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr></tbody></table><br>  I include additional columns in the trace, they are not used in the reports, but they come in handy with manual analysis: <br><table><tbody><tr><th>  Columnid </th><th>  ColumnName </th><th>  Type </th><th>  Errors </th><th>  Locks </th><th>  Procedures </th><th>  Requests </th></tr><tr><td>  four </td><td>  TransactionID </td><td>  bigint </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  9 </td><td>  ClientProcessID </td><td>  int </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr><tr><td>  ten </td><td>  Applicationname </td><td>  nvarchar </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr><tr><td>  eleven </td><td>  LoginName </td><td>  nvarchar </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  12 </td><td>  SPID </td><td>  int </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  15 </td><td>  Endtime </td><td>  datetime </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  48 </td><td>  Rowcounts </td><td>  bigint </td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td>  49 </td><td>  RequestID </td><td>  int </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr><tr><td>  50 </td><td>  XactSequence </td><td>  bigint </td><td>  + </td><td></td><td>  + </td><td>  + </td></tr></tbody></table><br>  Tracing filtered by <b>DatabaseName</b> ( <b>ColumnID</b> 35) is performed only for selected <b>SQL Server databases</b> (on test servers, often there are many databases, you only need to select the ones you need): <br><ul><li>  <b>tempdb</b> ; </li><li>  database of the application under test. </li></ul><br>  Filtering and grouping is also convenient to do by <b>LoginName</b> . <br>  If you are comfortable with the manual start of tracing, then <b>Microsoft SQL Server Profiler</b> will allow you to view the results of profiling immediately. <br><br><h4>  1.3.1.  Converting customized parameters to a script for automation </h4><br>  If you have another set of events, columns and filters.  And you want to automate the launch of tracing with such a set of parameters, then <b>SQL Server Profiler</b> will help here. <br><img src="https://habrastorage.org/files/216/dd2/cfb/216dd2cfbbdd4ce691463368422bf213.png"><br>  Configure automatic tracing: <br><ol><li>  Launch <b>Microsoft SQL Server Profiler</b> . </li><li>  Select the events to be profiled, select the attributes of the events to be profiled. </li><li>  Set filtering parameters (by <b>DatabaseName</b> or by <b>LoginName</b> ), parameters are opened by pressing the <b><u>Column Filters ...</u></b> button. </li><li>  Save the trace settings specified in the <b>Events Selection</b> tab of the ‚ÄúTrace Properties‚Äù window using the menu item ‚Äú <i>File / Export / Script Trace Definition / For SQL Server 2005 - 2008 R2 ...</i> ‚Äù. </li></ol><br>  The result is a script.  Similar to the script text: <br><div class="spoiler">  <b class="spoiler_title">Generated script with profiling settings</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/****************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Created by: SQL Server 2008 R2 Profiler */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Date: 21/01/2014 10:23:02 */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">-- Create a Queue declare @rc int declare @TraceID int declare @maxfilesize bigint set @maxfilesize = 5 -- Please replace the text InsertFileNameHere, with an appropriate -- filename prefixed by a path, eg, c:\MyFolder\MyTrace. The .trc extension -- will be appended to the filename automatically. If you are writing from -- remote server to local drive, please use UNC path and make sure server has -- write access to your network share exec @rc = sp_trace_create @TraceID output, 0, N'InsertFileNameHere', @maxfilesize, NULL if (@rc != 0) goto error -- Client side File and Table cannot be scripted -- Set the events declare @on bit set @on = 1 exec sp_trace_setevent @TraceID, 162, 31, @on exec sp_trace_setevent @TraceID, 162, 1, @on exec sp_trace_setevent @TraceID, 162, 9, @on exec sp_trace_setevent @TraceID, 162, 49, @on exec sp_trace_setevent @TraceID, 162, 10, @on exec sp_trace_setevent @TraceID, 162, 14, @on exec sp_trace_setevent @TraceID, 162, 50, @on exec sp_trace_setevent @TraceID, 162, 11, @on exec sp_trace_setevent @TraceID, 162, 35, @on exec sp_trace_setevent @TraceID, 162, 4, @on exec sp_trace_setevent @TraceID, 162, 12, @on exec sp_trace_setevent @TraceID, 162, 20, @on exec sp_trace_setevent @TraceID, 148, 11, @on exec sp_trace_setevent @TraceID, 148, 4, @on exec sp_trace_setevent @TraceID, 148, 12, @on exec sp_trace_setevent @TraceID, 148, 14, @on exec sp_trace_setevent @TraceID, 148, 1, @on exec sp_trace_setevent @TraceID, 10, 15, @on exec sp_trace_setevent @TraceID, 10, 31, @on exec sp_trace_setevent @TraceID, 10, 16, @on exec sp_trace_setevent @TraceID, 10, 48, @on exec sp_trace_setevent @TraceID, 10, 1, @on exec sp_trace_setevent @TraceID, 10, 9, @on exec sp_trace_setevent @TraceID, 10, 17, @on exec sp_trace_setevent @TraceID, 10, 49, @on exec sp_trace_setevent @TraceID, 10, 10, @on exec sp_trace_setevent @TraceID, 10, 18, @on exec sp_trace_setevent @TraceID, 10, 34, @on exec sp_trace_setevent @TraceID, 10, 50, @on exec sp_trace_setevent @TraceID, 10, 11, @on exec sp_trace_setevent @TraceID, 10, 35, @on exec sp_trace_setevent @TraceID, 10, 4, @on exec sp_trace_setevent @TraceID, 10, 12, @on exec sp_trace_setevent @TraceID, 10, 13, @on exec sp_trace_setevent @TraceID, 10, 14, @on exec sp_trace_setevent @TraceID, 12, 15, @on exec sp_trace_setevent @TraceID, 12, 31, @on exec sp_trace_setevent @TraceID, 12, 16, @on exec sp_trace_setevent @TraceID, 12, 48, @on exec sp_trace_setevent @TraceID, 12, 1, @on exec sp_trace_setevent @TraceID, 12, 9, @on exec sp_trace_setevent @TraceID, 12, 17, @on exec sp_trace_setevent @TraceID, 12, 49, @on exec sp_trace_setevent @TraceID, 12, 10, @on exec sp_trace_setevent @TraceID, 12, 14, @on exec sp_trace_setevent @TraceID, 12, 18, @on exec sp_trace_setevent @TraceID, 12, 50, @on exec sp_trace_setevent @TraceID, 12, 11, @on exec sp_trace_setevent @TraceID, 12, 35, @on exec sp_trace_setevent @TraceID, 12, 4, @on exec sp_trace_setevent @TraceID, 12, 12, @on exec sp_trace_setevent @TraceID, 12, 13, @on -- Set the Filters declare @intfilter int declare @bigintfilter bigint exec sp_trace_setfilter @TraceID, 35, 0, 6, N'ServiceDB' exec sp_trace_setfilter @TraceID, 35, 1, 6, N'ClientDB' exec sp_trace_setfilter @TraceID, 35, 1, 6, N'LogsDB' exec sp_trace_setfilter @TraceID, 35, 1, 6, N'Tempdb' -- Set the trace status to start exec sp_trace_setstatus @TraceID, 1 -- display trace id for future references select TraceID=@TraceID goto finish error: select ErrorCode=@rc finish: go</span></span></code> </pre></div></div><br>  The parameters from the <b>General</b> tab of the ‚ÄúTrace Properties‚Äù window do not fall into the preparation of the trace script.  There are the necessary parameters that are added to the script manually: <br><ul><li>  <b>Save to file</b> ; </li><li>  <b>Set maximum file size (MB)</b> ; </li><li>  <b>Enable file rollover</b> ; </li><li>  <b>Enable trace stop time</b> . </li></ul><br><br>  The file name and tracing stop time is set from the load test code, and the maximum file size and a sign that it will be necessary to create new files is conveniently set by a constant.  This is exactly how <b>Script.01.Start trace.sql</b> , described above, was created. <br>  Description of the parameters <b>Set maximum file size (MB)</b> and <b>Enable file rollover</b> : <a href="http://msdn.microsoft.com/en-us/library/ms191206.aspx">http://msdn.microsoft.com/en-us/library/ms191206.aspx</a> . <br><br><h2>  Uploading trace files to the database </h2><br>  To generate reports, trace files are loaded into a database table. <br><br>  A database is pre-created, traces will be loaded into the tables of this database, and tables with reports will be created in it.  You can call the <b>ProfilerResults</b> database.  The database name is convenient to reflect the name of the project, reports on which will be accumulated in it.  The project I'm working on was once called Midway, so the database was called <b>MidwayProfilerResults</b> .  To create a database, it is convenient to use <b>SQL Management Studio</b> , where there is a wizard for creating a database, a couple of clicks and you're done. <br><br>  For loading the system function fn_trace_gettable is used. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-string"><span class="hljs-string">"ProfilerResults"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"EventClass"</span></span> , <span class="hljs-string"><span class="hljs-string">"TextData"</span></span> , <span class="hljs-string"><span class="hljs-string">"Duration"</span></span> , <span class="hljs-string"><span class="hljs-string">"StartTime"</span></span> , <span class="hljs-string"><span class="hljs-string">"Reads"</span></span> , <span class="hljs-string"><span class="hljs-string">"Writes"</span></span> , <span class="hljs-string"><span class="hljs-string">"CPU"</span></span> , <span class="hljs-string"><span class="hljs-string">"Error"</span></span> , <span class="hljs-string"><span class="hljs-string">"ObjectName"</span></span> , <span class="hljs-string"><span class="hljs-string">"DatabaseName"</span></span> , <span class="hljs-string"><span class="hljs-string">"TransactionID"</span></span> , <span class="hljs-string"><span class="hljs-string">"ClientProcessID"</span></span> , <span class="hljs-string"><span class="hljs-string">"ApplicationName"</span></span> , <span class="hljs-string"><span class="hljs-string">"LogiName"</span></span> , <span class="hljs-string"><span class="hljs-string">"SPID"</span></span> , <span class="hljs-string"><span class="hljs-string">"EndTime"</span></span> , <span class="hljs-string"><span class="hljs-string">"RowCounts"</span></span> , <span class="hljs-string"><span class="hljs-string">"RequestID"</span></span> , <span class="hljs-string"><span class="hljs-string">"XactSequence"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"SOAP.v2.3.1.5577"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ::fn_trace_gettable(N<span class="hljs-string"><span class="hljs-string">'D:\Traces\Synerdocs\LoadTest.SOAP.Trace.StartOn 2013.01.21 08.30.00.trc'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>)</code> </pre><br>  The <b>fn_trace_gettable</b> parameters specify the path to the first trace file, and the second <b>default</b> parameter means that all files from the same trace session will be loaded into the table (not just the specified file of 100 MB in size). <br><br><img src="https://habrastorage.org/files/046/2ee/c66/0462eec66f5647b987deaa1628ad9c13.png"><br>  The name of the profiling table is set to reflect the version of the system under test and the load profile (in the example: "SOAP.v2.3.1.5577").  Created tables with reports will contain in the name the name of the profiling table according to which they are formed.  And in order to further find the desired table with the report among many others, it is better to set a meaningful name to the table. <br><br>  Download may take a long time, depending on the equipment.  On the server used, the download speed is as follows: 160-190 MBytes / minute or 1.5 - 2 trace files per minute (one file - 100 MBytes).  Measurements from two recent operations of loading trace files into the database (normal load profile and load profile with large files). <br><table><tbody><tr><th>  Trace files size (MB) </th><th>  Download duration (h: min: s) </th><th>  Average download speed (MB / min) </th><th>  Trace table size (MB) </th><th>  Number of lines </th><th>  The average size of the row table (KB) </th><th>  The increase in size after loading the table </th></tr><tr><td>  7,598 </td><td>  00:45:17 </td><td>  168,8 </td><td>  29 478.3 </td><td>  766 370 </td><td>  39.4 </td><td>  3.9 </td></tr><tr><td>  67,062 </td><td>  05:46:32 </td><td>  193.8 </td><td>  268 875.7 </td><td>  2,861,599 </td><td>  96.2 </td><td>  4.0 </td></tr></tbody></table><br><br><h2>  2. Summary Report on Procedures (RPC: Completed) - ‚ÄúDraft Report‚Äù </h2><br><blockquote>  Excessively careful analysis distorts the truth. <br>  - an ancient Frimenian maxim from Frank Herbert's The Messiah of the Dunes <br></blockquote><br><img src="https://habrastorage.org/files/81c/7ac/deb/81c7acdeba174c82a892c61cc5457243.png" alt="Draft report.  Sample"><br>  If work with the database is carried out mainly through the database API (a set of stored procedures and functions), then this report is the first thing worth building. <br><br>  The report is a grouping of <b>RPC: Completed</b> events from the trace table by the database name ( <b>DatabaseName</b> ) and the name of the stored procedure or function ( <b>ObjectName</b> ) with statistics and texts of fast and slowest queries.  Statistics for <b>SQL: BatchCompleted is</b> also in the report, but this is only one line - the string NULL, without detail.  Therefore, this report is called ‚ÄúDraft Report‚Äù. <br><br>  To automate the construction of the ‚ÄúDraft Report‚Äù report, an auxiliary tool <b>Tools.SQLProfilerReportHelper is used</b> . <br><br><h3>  2.1.  Preparation for the formation of the report "Draft Report" </h3><br><img src="https://habrastorage.org/files/1e9/45c/ec9/1e945cec934d421c98d99fc1fa00f3fe.png" alt="Preparation for the formation of the report"><br>  Preparation is reduced to pressing buttons on the form <b>Tools.SQLProfilerReportHelper</b> : <br><ol><li>  Launch <b>Tools.SQLProfilerReportHelper</b> . </li><li>  Specify the <b>SQL Server</b> name and profiler in the <b>SQL Server</b> and <b>Database</b> fields.  In the example, this is ‚ÄúSQL Server‚Äù and ‚ÄúProfilerResults‚Äù.  Click the <b><u>Connect</u></b> button.  Windows authentication using <b>SQL Server</b> is used, the user must be the profiling database administrator. </li><li>  Select from the <b>Profiling Table</b> list a table with profiling results.  In the example, this is ‚ÄúTraceTable.v2.7.LoadProfile1.2010.10.10‚Äù. </li><li>  Create a new <b>TextKey</b> column in the profiling table - check the presence / absence of a column in the table by clicking the <b><u>Check</u></b> button, and if the column does not exist (the <b><u>Create</u></b> button becomes available), click the <b><u>Create</u></b> button. </li><li>  Press the <b><u>Start</u></b> button <b><u>: SP</u></b> .  Clicking will copy the values ‚Äã‚Äãfrom the <b>ObjectName</b> column to the <b>TextKey</b> column. </li></ol><br>  While copying the <b>ObjectName</b> to the <b>TextKey</b> column, how many records are left to process.  And the remaining duration of the operation is calculated.  The process can be interrupted by pressing the <b><u>Stop: SP</u></b> button. <br><br><h3>  2.2.  Formation of the report "Draft Report" </h3><br><img src="https://habrastorage.org/files/6ec/0c4/4b6/6ec0c44b646e41608186230f9dc23055.png"><br>  After copying is complete, create a draft report.  To do this, click the <b><u>Check</u></b> button (check the presence / absence of a table with a report), and if there is no table with a report, then click the <b><u>Create</u></b> button.  As a result, a table will be created with the ending ‚ÄúDraftStat‚Äù in the name, in our example, <b>TraceTable.v2.7.LoadProfile1.2010.10.10.DraftStat</b> .  The size of the table is relatively small (10-30 MBytes).  The table is intended for long-term storage of statistics on the performance of stored procedures and functions. <br><br>  The contents of the table get a query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> <span class="hljs-string"><span class="hljs-string">"ProfilerResults"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"dbo"</span></span>.<span class="hljs-string"><span class="hljs-string">"TraceTable.v2.7.LoadProfile1.2010.10.10.DraftStat"</span></span></code> </pre><br><img src="https://habrastorage.org/files/717/bdc/66c/717bdc66ce4647aba5d3ac8ddbc2d536.png"><br>  The query is convenient to execute in <b>SQL Management Studio</b> . <br><br>  Copy to the clipboard all columns, except the text query <b>columns TextData -....</b> <br><br><div class="spoiler">  <b class="spoiler_title">The composition of the columns of the table DtaftStat (report Draft Report)</b> <div class="spoiler_text"><table><tbody><tr><th>  Speaker </th><th>  Type of </th><th>  Description </th></tr><tr><td>  <b>Databasename</b> </td><td>  nvarchar (256) </td><td>  Database (grouping key). </td></tr><tr><td>  <b>ObjectName</b> -key </td><td>  nvarchar (256) </td><td>  The name of the stored procedure or function (grouping key). </td></tr><tr><td>  <b>avg (CPU) -key</b> </td><td>  int </td><td>  CPU time (average) in milliseconds used by the event. </td></tr><tr><td>  <b>avg (Duration) -key</b> </td><td>  bigint </td><td>  The duration of the event (average) in milliseconds. </td></tr><tr><td>  <b>% Duration-key</b> </td><td>  float </td><td>  The proportion of the total duration of the event (sort key). </td></tr><tr><td>  <b>avg (Reads) -key</b> </td><td>  bigint </td><td>  The number of logical disk reads (average) performed by the server for the event. </td></tr><tr><td>  <b>Count-key</b> </td><td>  int </td><td>  The number of calls (pieces). </td></tr><tr><td>  ObjectName </td><td>  nvarchar (256) </td><td>  The name of the stored procedure or function (grouping key). </td></tr><tr><td>  avg (CPU) </td><td>  int </td><td>  The average value for the CPU column (average CPU time in milliseconds used by the event). </td></tr><tr><td>  max (CPU) </td><td>  int </td><td>  Maximum CPU time in milliseconds used by the event. </td></tr><tr><td>  sum (CPU) </td><td>  int </td><td>  Total CPU time in milliseconds used by the event. </td></tr><tr><td>  % CPU </td><td>  float </td><td>  The proportion of the total CPU time of the event. </td></tr><tr><td>  min (Duration) </td><td>  bigint </td><td>  The event duration (mini) in milliseconds. </td></tr><tr><td>  avg (Duration) </td><td>  bigint </td><td>  Event duration (average) in milliseconds. </td></tr><tr><td>  max (duration) </td><td>  bigint </td><td>  Event duration (maximum) in milliseconds. </td></tr><tr><td>  sum (duration) </td><td>  bigint </td><td>  Event duration (total) in milliseconds. </td></tr><tr><td>  % Duration </td><td>  float </td><td>  The proportion of the total duration of the event. </td></tr><tr><td>  min (Reads) </td><td>  bigint </td><td>  The number of logical disk reads (minimum) performed by the server for the event. </td></tr><tr><td>  avg (Reads) </td><td>  bigint </td><td>  The number of logical disk reads (average) performed by the server for the event. </td></tr><tr><td>  max (Reads) </td><td>  bigint </td><td>  The number of logical disk reads (maximum) performed by the server for the event. </td></tr><tr><td>  sum (Reads) </td><td>  bigint </td><td>  The number of logical disk reads (total) performed by the server for the event. </td></tr><tr><td>  % Reads </td><td>  float </td><td>  The proportion of the number of logical disk reads performed by the server for an event. </td></tr><tr><td>  min (Writes) </td><td>  bigint </td><td>  The number of physical disk writes to write (mini) made by the server for the event. </td></tr><tr><td>  avg (Writes) </td><td>  bigint </td><td>  The number of physical disk accesses for writing (average) made by the server for the event. </td></tr><tr><td>  max (Writes) </td><td>  bigint </td><td>  The number of physical disk writes to write (maximum) made by the server for the event. </td></tr><tr><td>  sum (Writes) </td><td>  bigint </td><td>  The number of physical disk accesses for writing (total) performed by the server for the event. </td></tr><tr><td>  % Writes </td><td>  float </td><td>  The proportion of the number of physical drives accessed by the server for the event. </td></tr><tr><td>  Count </td><td>  int </td><td>  The number of events. </td></tr><tr><td>  % Count </td><td>  float </td><td>  The proportion of the number of events. </td></tr><tr><td>  <i>TextData-min (Duration)</i> </td><td>  ntext </td><td>  Query text for which the duration of the execution is minimal. </td></tr><tr><td>  <i>TextData-max (Duration)</i> </td><td>  ntext </td><td>  Query text for which the execution time is maximum. </td></tr><tr><td>  <i>TextData-min (Reads)</i> </td><td>  ntext </td><td>  Query text for which the number of logical disk reads performed by the server is minimal. </td></tr><tr><td>  <i>TextData-max (Reads)</i> </td><td>  ntext </td><td>  Request text for which the maximum number of logical disk reads performed by the server is performed. </td></tr><tr><td>  <i>TextData-min (CPU)</i> </td><td>  ntext </td><td>  Query text for which the CPU time is minimal. </td></tr><tr><td>  <i>TextData-max (CPU)</i> </td><td>  ntext </td><td>  Query text for which the CPU time is maximum. </td></tr><tr><td>  <i>TextData-min (Writes)</i> </td><td>  ntext </td><td>  The text of the request for which the number of physical disk accesses made by the server is minimal. </td></tr><tr><td>  <i>TextData-max (Writes)</i> </td><td>  ntext </td><td>  The text of the request, for which the number of server physical disk accesses to write to the maximum. </td></tr></tbody></table></div></div><br><br>  Open report template in <b>Microsoft Office Excel</b> (table with automatic formatting of cells - highlighting values ‚Äã‚Äãfrom bad to good).  Paste the contents of the clipboard into the document. <br><br>  The document will look like a large colored table, sorted in descending order in the <b>% Duration</b> column. <br><br>  The first six columns are separated from the rest (and duplicate them) are the main ones.  These six main columns are conveniently copied from an <b>Excel</b> document to a <b>Word</b> document. <br><br><img src="https://habrastorage.org/files/430/53c/1b8/43053c1b8fef4b449d21b8f4be70f4d9.png"><br>  The strings with the ‚ÄúNULL‚Äù key and the ‚Äúsp_executesql‚Äù key are statistics on query calls ( <b>SQL: BatchCompleted</b> ) and queries executed by calling the stored procedure <b>sp_executesql</b> .  If there are few such requests (the <b>Count</b> column) and the proportion of the duration of their execution is small (the <b>% Duration</b> column), then a detailed report can be left unlimited by analyzing the draft report. <br><br><h3>  2.3.  Analysis of the report "Draft Report" </h3><br><img src="https://habrastorage.org/files/482/a0e/a78/482a0ea7877840c591a58b4b59cea0bd.png"><br>  Pay attention to stored procedures with a maximum value of <b>% Duration</b> and <b>avg (Reads)</b> . <br><br><img src="https://habrastorage.org/files/048/ba7/616/048ba7616dbe4ac2a31237129a8576bc.png"><br>  Often such calls can be sped up by adding missing indexes.  <b>SQL Management Studio</b> will tell you exactly which indexes to add.  The correctness of the advice is not absolute, but high. <br><br>  There was a case that the query was optimal and the indices were in place, but in the text of the stored procedure all the records of a large table were selected (for debugging) - from this, the query was in the lead in the report on <b>% Duration</b> .  Query execution in <b>SQL Management Studio</b> reveals such cases of huge samples.  According to the report, such moments cannot be identified, I do not include statistics on the <b>RowCount</b> column in the report (it would be necessary to include it). <br><br><img src="https://habrastorage.org/files/41c/6ba/4b3/41c6ba4b351d4fb78a3dd8efe3624663.png"><br>  I suppose sometimes you can cache calls with a high value of <b>% Duration</b> and <b>Count</b> (you can sort the records in descending order of the ‚Äú% Duration‚Äù x ‚ÄúCount‚Äù). <br><br>  It is possible that in calls with a high value of <b>% Duration</b> and <b>avg (CPU)</b> there is non-optimal work with strings, mathematics, recursion. <br><br>  Calls with a high value of <b>% Duration</b> and <b>avg (Write)</b> may not optimally use temporary tables.  Or point to an insert in a table where there are too many indexes and complex triggers. <br><br>  Query texts with minimum and maximum values ‚Äã‚Äãof duration, number of logical reads, CPU time are extracted from the columns of the table-report (there are no these columns in the report document): <br><ul><li>  TextData-min (Duration); </li><li>  TextData-max (Duration); </li><li>  TextData-min (Reads); </li><li>  TextData-max (Reads); </li><li>  TextData-min (CPU); </li><li>  TextData-max (CPU); </li><li>  TextData-min (Writes); </li><li>  TextData-max (Writes). </li></ul><br>  Texts are analyzed in <b>SQL Management Studio</b> . <br><br><h2>  3. Summary Report on Queries (RPC: Completed + SQL: BatchCompleted) - Detail Report </h2><br><img src="https://habrastorage.org/files/5ea/503/806/5ea503806c42481ba963556d1efa99ed.png"><br><br>  If in the <b>Draft Report, the</b> lines with the ‚ÄúNULL‚Äù and ‚Äúsp_executesql‚Äù keys did not hide the execution details for many queries.  Then in the <b>Detail Report</b> group will be executed as detailed as possible. <br>  Report formation <b>Detail Report</b> assumes that the <b>Draft Report</b> has already been generated and the preparatory actions have been completed. <br><br><h3>  3.1.  Preparing for the formation of the Detail Report </h3><br><img src="https://habrastorage.org/files/a7d/a67/f04/a7da67f04dc34fe18fbc7eac60bcfe66.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft Report is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> formed, then it is enough:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrepareTextData</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">is in the database by clicking the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Function PrepareTextData</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> group </font><font style="vertical-align: inherit;">(create a function if necessary by clicking the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">).</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generate grouping keys by query text (for grouping </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> events </font><b><font style="vertical-align: inherit;">: BatchCompleted</font></b><font style="vertical-align: inherit;"> by </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TextData</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> column </font><font style="vertical-align: inherit;">) by clicking the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start: SQL</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">.</font></font></li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otherwise, you need to do everything from the beginning: connect to the database with the profiling table, select the profiling table, create the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TextKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> column </font><font style="vertical-align: inherit;">, press the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start: SP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">to fill the grouping keys by stored procedures. </font><font style="vertical-align: inherit;">Actions are performed by clicking on the available buttons on the tool form. </font><font style="vertical-align: inherit;">Buttons that do not need to be pressed become inaccessible.</font></font><br><br><h3>  3.2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Report Formation </font></font></h3><br><img src="https://habrastorage.org/files/970/eca/5af/970eca5af9a6419c9c086cee5bccb99b.png"><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check the status of the existence of a detailed report by clicking the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detail report status</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a report if there is none (if the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">is available for pressing, then click it).</font></font></li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, a new table-report will be created, the name of which will end with ‚ÄúDetailStat‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The description of the columns is the same as the description of the columns for Draft Report. </font><font style="vertical-align: inherit;">But there are more rows in this table (more detailed report). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The data from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DetailStat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><b><font style="vertical-align: inherit;">is</font></b><font style="vertical-align: inherit;"> also copied to the clipboard and inserted into the report template as for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft Report</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h3>  3.3.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Report analysis </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analysis of the detailed report (Detail report) is similar to the analysis of the draft report (Draft Report). </font><font style="vertical-align: inherit;">But there is an additional opportunity to view and download the texts of requests. </font></font><br><img src="https://habrastorage.org/files/970/eca/5af/970eca5af9a6419c9c086cee5bccb99b.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clicking on the </font></font><b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">opens a window with the contents of a detailed report.</font></font><br><br><img src="https://habrastorage.org/files/448/2a1/40e/4482a140ec744adfb6682aba16669842.png">  . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the "ReportViewForm" window, you can view the records, sort. Query texts that are clicked are saved as files in the program folder. And on the tabs you can see the query text, the first 10,000 characters of the query text. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This method of downloading query texts was made to enable the analysis of large queries. So if the operations of creating documents with a size of 100-700 MB, then the query texts for these operations are huge in tres. They are so huge that even the RAM may not be enough for the select * from ... DetailStat request. When working with the </font><b><font style="vertical-align: inherit;">DetailStat</font></b><font style="vertical-align: inherit;"> report </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">table</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">through such a special viewer, records are retrieved by separate requests, and not by one general. </font><font style="vertical-align: inherit;">This allows you to upload texts of large queries. </font><font style="vertical-align: inherit;">If there are no large queries in the report, then working from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Management Studio is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> more convenient. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential unloading of query texts into files allows us to solve the problem of lack of memory when working with large query texts (downloaded query texts of 500 MBytes or more).</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Industrial exploitation </font></font></h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The described method of collecting and analyzing </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft SQL Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traces was </font><font style="vertical-align: inherit;">tested when testing two products. </font><font style="vertical-align: inherit;">Both products are related to accounting.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OLTP system (Synerdocs) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frequent sampling of small portions of data, frequent updates of individual records (incoming / outgoing, documents, signatures). Many users (1000-2000 test users). Many calls to stored procedures and functions (API databases). Few sql query calls that are not stored procedure calls. Requests during the load testing recruited several hundred thousand. Requests are collected in a hundred groups. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collection of the trace starts for the duration of the load test (a couple of hours). Then dozens of gigabytes of traces are analyzed and turned into reports.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing is carried out regularly. </font><font style="vertical-align: inherit;">At some point, finding obvious bottlenecks has become difficult. </font><font style="vertical-align: inherit;">It took the tool for detailed analysis. </font><font style="vertical-align: inherit;">And so that the reports are easily compared with each other (grouping keys must be short in order to be inserted into the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> column </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">So there were reports, which are described above.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OLAP system (Prestima) </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sampling and grouping large portions of data, updating individual records (budgeting, accounts, postings). Relatively few users during testing (the load is created by real people who run the formation of reports). Many dynamically formed queries (long query text, the differences between the two queries can only be on the 200th character in the section with JOINs or on the 250th in the WHERE section). Queries are analytical, to a set of tables, with different conditions. The distinct impact of the query criteria on the duration. The longest request from the fastest may differ not in the structure of the request, but in the values ‚Äã‚Äãof the parameters. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collection of the trace starts for the duration of the functional and volume testing (perhaps a couple of days). Periodically, traces are analyzed and turned into reports.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To statistics for complex queries do not fall into one group, the grouping keys must be accurate. </font><font style="vertical-align: inherit;">In the PrepareTextData procedure, you can specify the length of the calculated key. </font><font style="vertical-align: inherit;">And with a small amount of traces, the use of long grouping keys is quite normal (the speed of generating reports will remain high).</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Authorship and links </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analytical reports presented in the article are descendants of the sql query written by Mikhail Izvekov (the developer of NPO Computer). </font><font style="vertical-align: inherit;">The request is simple and beautiful:</font></font><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--    REPLACE        X.  @Len   , --        .     , --       ,   ,        . --    26    IContents         "select distinct X as Ob", --      ,        , --      4000,        -- ( ,       ..). declare @Hours float; declare @CPUSumm int; declare @Len int = 26; select @CPUSumm = SUM(CPU) from Test -- ,    . select @Hours = CAST(MAX(StartTime) - MIN(StartTime) as float) * 24 from Test -- ,    . select SUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(CAST(TextData as nvarchar(4000)),'0','X'),'1','X'),'2','X'),'3','X'),'4','X'),'5','X'),'6','X'),'7','X'),'8','X'),'9','X'),'XX','X'),'XX','X'),'XX','X'), 1, @Len) as [Query Pattern], sum(CPU) / 1000 as CPU_sec_SUM, avg(CPU) as CPU_msec_AVG, max(CPU) as CPU_msec_MAX, min(CPU) as CPU_msec_MIN, avg(Duration) / 1000 as [AVG_Duration (msec)], avg(Reads) as [Avg Reads], avg(Writes) as [Avg Writes], count(1) as TotalQnt, round(count(1) / @Hours, 2) as Count_per_hour, round(cast(SUM(CPU) as float) / @CPUSumm * 100, 3) as ImpactCPUPerf from Test -- ,    . where EventClass in (10, 12) and ISNULL(ApplicationName, 'Unknown') in ('SBRSE', 'IS-Builder', 'Unknown') group by SUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(CAST(TextData as nvarchar(4000)),'0','X'),'1','X'),'2','X'),'3','X'),'4','X'),'5','X'),'6','X'),'7','X'),'8','X'),'9','X'),'XX','X'),'XX','X'),'XX','X'), 1, @Len)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request Michael, in its original form, could not be used. The analysis of the 30-40 GBytes trace takes a long time. And the texts of the requests in the trays were such that they did not want to be grouped. With a short key (10 characters), all select and update requests were mixed. And with a long key (30 characters or more), calls to stored procedures with GUID parameters created thousands of similar grouping keys:</font></font><br><pre> <code class="sql hljs">exec [dbo].[getDoc] @id="128500FF-8B90-D060-B490-00CF4FC964FF" <span class="hljs-comment"><span class="hljs-comment">--exec [dbo].[getDoc] @id="XFF-X exec [dbo].[getDoc] @id="AABBCCDD-0E0E-1234-B491-0D43C5F6C0F6" --exec [dbo].[getDoc] @id="AABBC</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Began to try various options for calculating the grouping key. The results were recorded in the new column of the profiling table. And this column has already grouped the results. So it all began. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More recently, on Friday, sat with Misha talked about a difficult life, but his beard is thick. And I forgot to tell him that I will write an article. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From that, I don‚Äôt know yet what license for Michael‚Äôs script. And the license for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLProfilerReportHelper</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tool </font><font style="vertical-align: inherit;">is BSD, free. Embed trace scripts in load tests, analyze traces, generate reports. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The tool is available on Github: </font></font><a href="https://github.com/polarnik/SQLProfilerReportHelper"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/polarnik/SQLProfilerReportHelper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The report pictures presented in the article are old, and therefore not very secret. </font><font style="vertical-align: inherit;">If you notice a discrepancy between the picture of the report and the composition of the columns in the table-report formed by the tools, treat with understanding.</font></font><br><br><h2>  Completion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The guide describes the process of generating grouping reports based on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> profiling data </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is only one tenth of the performance testing. </font><font style="vertical-align: inherit;">But bright and important. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the next part of the article I will talk about other reports that are formed on the basis of traces.</font></font></div><p>Source: <a href="https://habr.com/ru/post/243587/">https://habr.com/ru/post/243587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243573/index.html">Check your website availability from Africa</a></li>
<li><a href="../243577/index.html">IBM launches a joint master‚Äôs program in the field of Big Data with leading Russian universities</a></li>
<li><a href="../243579/index.html">Eskimo - Node.js boilerplate to create prototypes</a></li>
<li><a href="../243581/index.html">Literal operator templates for strings</a></li>
<li><a href="../243585/index.html">Apple released iOS 8.1.1</a></li>
<li><a href="../243589/index.html">Vagrant for PHP project</a></li>
<li><a href="../243593/index.html">Golang and OOP</a></li>
<li><a href="../243595/index.html">Textbook on programming language D. Part 3</a></li>
<li><a href="../243597/index.html">Tester's verdict or system quantification by test results</a></li>
<li><a href="../243599/index.html">Hackathon in Kazan: how to do something and not to score on it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>