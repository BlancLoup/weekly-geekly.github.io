<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practical use of the Advanced Camera API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, we began to consider the API, the output of which was announced at the exhibition MWC - 2013. In today's article we will look at practical e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practical use of the Advanced Camera API</h1><div class="post__text post__text-html js-mediator-article">  Recently, we <a href="http://habrahabr.ru/company/Nokia/blog/172265/">began to consider the</a> API, the output of which was announced at the exhibition MWC - 2013. In today's article we will look at practical examples of the use of the Advanced Camera API. <br><br><img src="https://habrastorage.org/storage2/df8/54c/917/df854c917d45df6553a848c90fc14064.jpg"><br><a name="habracut"></a><br><br><h4>  Windows Phone 8 Advanced Photo Capture API </h4><br>  Windows Phone 8 allows you to very finely configure the camera settings.  The main entry point for new camera features is the <code>Windows.Phone.Media.Capture.PhotoCaptureDevice</code> class, which provides the following methods: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - Request and adjust the settings of the supported camera parameters. <br><br>  ‚Ä¢ <code>static CameraCapturePropertyRange SupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code> <br>  ‚Ä¢ <code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId) <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code></code> <code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </h4> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <h4> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </h4> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> <pre> <code class="hljs kotlin"><code>static IReadOnlyList <br> ‚Ä¢ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code><code><code><code><code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia <span class="hljs-number"><span class="hljs-number">820</span></span>  <span class="hljs-number"><span class="hljs-number">920</span></span>. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataContext</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameters</span></span></span><span class="hljs-class"> </span></span>{ ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.MainPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Canvas x:Name=<span class="hljs-string"><span class="hljs-string">"VideoCanvas"</span></span>&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name=<span class="hljs-string"><span class="hljs-string">"videoBrush"</span></span>/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"capture"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"captureButton_Click"</span></span> ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo</span></span></span></span>(NavigationEventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_dataContext.Device == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, CenterY = <span class="hljs-number"><span class="hljs-number">0.5</span></span>, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(<span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-number"><span class="hljs-number">480</span></span>); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void captureButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_manuallyFocused) { await AutoFocus(); } await Capture(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task AutoFocus() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async Task Capture() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_capturing) { _capturing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(<span class="hljs-number"><span class="hljs-number">1</span></span>); sequence.Frames[<span class="hljs-number"><span class="hljs-number">0</span></span>].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class=<span class="hljs-string"><span class="hljs-string">"CameraExplorer.PreviewPage"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"LayoutRoot"</span></span> ... &gt; ... &lt;Grid x:Name=<span class="hljs-string"><span class="hljs-string">"ContentPanel"</span></span> ... &gt; &lt;Image x:Name=<span class="hljs-string"><span class="hljs-string">"image"</span></span> Stretch=<span class="hljs-string"><span class="hljs-string">"UniformToFill"</span></span>/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text=<span class="hljs-string"><span class="hljs-string">"save"</span></span> Click=<span class="hljs-string"><span class="hljs-string">"saveButton_Click"</span></span> ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewPage</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage</span></span></span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void saveButton_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _dataContext.ImageStream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll(<span class="hljs-string"><span class="hljs-string">"CameraExplorer_"</span></span> + DateTime.Now.ToString() + <span class="hljs-string"><span class="hljs-string">".jpg"</span></span>, _dataContext.ImageStream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INotifyPropertyChanged { ... protected Parameter</span></span></span></span>(PhotoCaptureDevice device, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PhotoCaptureDevice Device { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool Supported { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter</span></span></span></span>(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (range == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Minimum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Maximum { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_value.Equals(value)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Device.SetProperty(_propertyId, (T)value); _value = value; ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExposureCompensationParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RangeParameter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, <span class="hljs-string"><span class="hljs-string">"Exposure compensation"</span></span>) { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameterOption</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption(<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> value, string name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> Value { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string Name { ... } ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Parameter</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameterOption</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayParameterOption _selectedOption; ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void Refresh() { ... _options.Clear(); _selectedOption = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PopulateOptions(); Supported = _options.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { Supported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } ... } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> List&lt;ArrayParameterOption&gt; Options { ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArrayParameterOption SelectedOption { ... <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != value) { ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_selectedOption != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { SetOption(value); } _selectedOption = value; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void PopulateOptions(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code><code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value)</code> . <br> <br> <code class="cs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SceneModeParameter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArrayParameter { public SceneModeParameter</span></span></span></span>(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, <span class="hljs-string"><span class="hljs-string">"Scene mode"</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void PopulateOptions() { IReadOnlyList&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> value = Device.GetProperty(PropertyId); foreach (<span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i.Equals(value)) { SelectedOption = option; } } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name=<span class="hljs-string"><span class="hljs-string">"FocusIndicator"</span></span> Stroke=<span class="hljs-string"><span class="hljs-string">"Red"</span></span> Opacity=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> Width=<span class="hljs-string"><span class="hljs-string">"80"</span></span> Height=<span class="hljs-string"><span class="hljs-string">"80"</span></span> StrokeThickness=<span class="hljs-string"><span class="hljs-string">"5"</span></span> Visibility=<span class="hljs-string"><span class="hljs-string">"Collapsed"</span></span>/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> async void videoCanvas_Tap(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    ,       .     </span></span><code><span class="hljs-comment"><span class="hljs-comment">FocusAsync</span></span></code><span class="hljs-comment"><span class="hljs-comment"> ,    ,    .  ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">WaitOne</span></span></code><span class="hljs-comment"><span class="hljs-comment"> , ,    ,    </span></span><code><span class="hljs-comment"><span class="hljs-comment">false</span></span></code><span class="hljs-comment"><span class="hljs-comment">  ‚Äî  ,    . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">    </span></span><br><span class="hljs-comment"><span class="hljs-comment">      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><code class="cs"><span class="hljs-comment"><span class="hljs-comment">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</span></span></code><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">  ,     Lens Picker,      .  ,   Lens Picker    </span></span><code><span class="hljs-comment"><span class="hljs-comment">Assets</span></span></code><span class="hljs-comment"><span class="hljs-comment"> .         ,      </span></span><a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx"><span class="hljs-comment"><span class="hljs-comment">Lens design guidelines for Windows Phone</span></span></a><span class="hljs-comment"><span class="hljs-comment"> . </span></span><br><span class="hljs-comment"><span class="hljs-comment"> </span></span><br><span class="hljs-comment"><span class="hljs-comment">         Maps API.</span></span></code></code></code></code></code></code> </pre> <code><code><code><code><code><code><code>static IReadOnlyList <br> ‚Ä¢ object GetProperty(Guid propertyId)</code> <br> ‚Ä¢ <code>void SetProperty(Guid propertyId, object value)</code> <br> <br> ‚Äî  ,     . <br> <br> ‚Ä¢ <code>static bool IsFocusSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>static bool IsFocusRegionSupported(CameraSensorLocation sensor)</code> <br> ‚Ä¢ <code>IAsyncOperation FocusAsync() <br> ‚Ä¢ IAsyncOperation ResetFocusAsync() <br> <br> ‚Äî        . <br> <br> ‚Ä¢ static IReadOnlyList GetAvailablePreviewResolutions() <br> ‚Ä¢ static IReadOnlyList GetAvailableCaptureResolutions() <br> ‚Ä¢ IAsyncAction SetPreviewResolutionAsync(Size value)</code> <br> ‚Ä¢ <code>IAsyncAction SetCaptureResolutionAsync(Size value)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>event TypedEventHandler&lt;ICameraCaptureDevice, Object&gt; PreviewFrameAvailable</code> <br> ‚Ä¢ <code>void GetPreviewBufferArgb(out int[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferY(out byte[] pixels)</code> <br> ‚Ä¢ <code>void GetPreviewBufferYCbCr(out byte[] pixels)</code> <br> <br> ‚Äî   . <br> <br> ‚Ä¢ <code>CameraCaptureSequence CreateCaptureSequence(uint numberOfFrames)</code> <br> ‚Ä¢ <code>IAsyncAction PrepareCaptureSequenceAsync(CameraCaptureSequence sequence)</code> <br> <br>          ‚Äî    .            .     API     .       GUID.      ,                 . <br>    ,    <code>ID_CAP_ISV_CAMERA</code>  WMAppManifest.xml    .   <code>ID_CAP_MEDIALIB_PHOTO</code>      . <br> <br>     Lumia <br>         Nokia Lumia 820  920. <br> <img src="https://habrastorage.org/storage2/1f3/483/e88/1f3483e88cda19e69da86bd73f0a9366.png"> <br> <br>  <a href="http://www.developer.nokia.com/Resources/Library/Lumia/">Camera Explorer</a> ‚Äî  ,     <code>PhotoCaptureDevice</code>  .     ,                 . <br> <br> <img src="https://habrastorage.org/storage2/12d/121/f92/12d121f92d7876ab4ffa9c6ef00caac6.jpg"> <img src="https://habrastorage.org/storage2/a33/463/b50/a33463b50ee8f7afe320cffcfcfd0164.jpg"> <img src="https://habrastorage.org/storage2/a13/20d/6a9/a1320d6a94c34c507eb16a75a0f1001d.jpg"> <br> <br>      ,     Camera Explorer. <br> <br> <img src="https://habrastorage.org/storage2/edb/e58/4bf/edbe584bf1167f50b5643e68a000e4b6.png"> <br> <br>        Windows Phone    <code>DataContext</code>     ,    <code>Settings</code>   <code>PhotoCaptureDevice</code> . <br>     ‚Äî    <code>PhotoCaptureDevice</code>  DataContext, ,      ,     <code>PhotoCaptureDevice</code> ,     ,   MainPage,    . <br> <br>           Camera Explorer      . <br>  ,  PhotoCaptureDevice     ,     Camera Explorer.  ,         ,          .        <a href="https://projects.developer.nokia.com/cameraexplorer"> </a> . <br> <br>    DataContext,   ,     . <br> <br> <code class="cs">... class DataContext : INotifyPropertyChanged { ... public static DataContext Singleton { ... } public ObservableCollection&lt;Parameter&gt; Parameters { ... } public PhotoCaptureDevice Device { ... } public MemoryStream ImageStream { ... } }</code> <br> <br>    <br> ,  <code>PhotoCaptureDevice</code>           .  MainPage xaml   <code>Canvas</code>   <code>VideoBrush</code> ,   . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.MainPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Canvas x:Name="VideoCanvas"&gt; &lt;Canvas.Background&gt; &lt;VideoBrush x:Name="videoBrush"/&gt; &lt;/Canvas.Background&gt; &lt;/Canvas&gt; ... &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="capture" Click="captureButton_Click" ... /&gt; ... &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br>   C# MainPage <code>PhotoCaptureDevice</code>   <code>InitializeCamera</code> ,       DataContext.      ,     XAML,  ,     . <br> <br> <code class="cs">... public partial class MainPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; ... protected async override void OnNavigatedTo(NavigationEventArgs e) { if (_dataContext.Device == null) { ... await InitializeCamera(CameraSensorLocation.Back); ... } videoBrush.RelativeTransform = new CompositeTransform() { CenterX = 0.5, CenterY = 0.5, Rotation = _dataContext.Device.SensorLocation == CameraSensorLocation.Back ? _dataContext.Device.SensorRotationInDegrees : - _dataContext.Device.SensorRotationInDegrees }; videoBrush.SetSource(_dataContext.Device); ... } private async Task InitializeCamera(CameraSensorLocation sensorLocation) { Windows.Foundation.Size initialResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size previewResolution = new Windows.Foundation.Size(640, 480); Windows.Foundation.Size captureResolution = new Windows.Foundation.Size(640, 480); PhotoCaptureDevice d = await PhotoCaptureDevice.OpenAsync(sensorLocation, initialResolution); await d.SetPreviewResolutionAsync(previewResolution); await d.SetCaptureResolutionAsync(captureResolution); d.SetProperty(KnownCameraGeneralProperties.EncodeWithOrientation, d.SensorLocation == CameraSensorLocation.Back ? d.SensorRotationInDegrees : -d.SensorRotationInDegrees); _dataContext.Device = d; } private async void captureButton_Click(object sender, EventArgs e) { if (!_manuallyFocused) { await AutoFocus(); } await Capture(); } private async Task AutoFocus() { if (!_capturing &amp;&amp; PhotoCaptureDevice.IsFocusSupported(_dataContext.Device.SensorLocation)) { ... await _dataContext.Device.FocusAsync(); ... _capturing = false; } } private async Task Capture() { if (!_capturing) { _capturing = true; MemoryStream stream = new MemoryStream(); CameraCaptureSequence sequence = _dataContext.Device.CreateCaptureSequence(1); sequence.Frames[0].CaptureStream = stream.AsOutputStream(); await _dataContext.Device.PrepareCaptureSequenceAsync(sequence); await sequence.StartCaptureAsync(); _dataContext.ImageStream = stream; ... } ... } ... }</code> <br> <br>        <br>      .  Camera Explorer  ,   XAML Image   <code>BitmapImage</code> .         ,   ,   ,    <code>void MediaLibrary.SavePictureToCameraRoll(string name, Stream source)</code> ,      . <br> <br> <code class="cs">&lt;phone:PhoneApplicationPage x:Class="CameraExplorer.PreviewPage" ... &gt; ... &lt;Grid x:Name="LayoutRoot" ... &gt; ... &lt;Grid x:Name="ContentPanel" ... &gt; &lt;Image x:Name="image" Stretch="UniformToFill"/&gt; &lt;/Grid&gt; &lt;/Grid&gt; &lt;phone:PhoneApplicationPage.ApplicationBar&gt; &lt;shell:ApplicationBar&gt; &lt;shell:ApplicationBarIconButton Text="save" Click="saveButton_Click" ... /&gt; &lt;/shell:ApplicationBar&gt; &lt;/phone:PhoneApplicationPage.ApplicationBar&gt; ... &lt;/phone:PhoneApplicationPage&gt;</code> <br> <br> <code class="cs">... public partial class PreviewPage : PhoneApplicationPage { private CameraExplorer.DataContext _dataContext = CameraExplorer.DataContext.Singleton; private BitmapImage _bitmap = new BitmapImage(); protected override void OnNavigatedTo(NavigationEventArgs e) { ... _bitmap.SetSource(_dataContext.ImageStream); image.Source = _bitmap; ... } private void saveButton_Click(object sender, EventArgs e) { try { _dataContext.ImageStream.Position = 0; MediaLibrary library = new MediaLibrary(); library.SavePictureToCameraRoll("CameraExplorer_" + DateTime.Now.ToString() + ".jpg", _dataContext.ImageStream); } catch (Exception) { ... } ... } }</code> <br> <br>   Camera Explorer ,      <code>ArrayParameters</code>  <code>RangeParameters</code> ,     <code>Parameters</code> .              ,        ,   <code>ComboBox</code> , <code>Slider</code>  <code>Text</code> .      ,        . <br>      <code>Parameter</code>   ,    . <br> <br> <code class="cs">... public abstract class Parameter : INotifyPropertyChanged { ... protected Parameter(PhotoCaptureDevice device, string name) { ... } public PhotoCaptureDevice Device { ... } public string Name { ... } public bool Supported { ... } public abstract void Refresh(); ... }</code> <br> <br>   ,      .         <code>_propertyId</code> ,     <code>static CameraCapturePropertyRange PhotoCaptureDevice.GetSupportedPropertyRange(CameraSensorLocation sensor, Guid propertyId)</code>    .         <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code> .           <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public abstract class RangeParameter&lt;T&gt; : Parameter { private Guid _propertyId; private T _value; ... protected RangeParameter(PhotoCaptureDevice device, Guid propertyId, string name) : base(device, name) { ... } public override void Refresh() { try { CameraCapturePropertyRange range = PhotoCaptureDevice.GetSupportedPropertyRange( Device.SensorLocation, _propertyId); if (range == null) { Supported = false; } else { Minimum = (T)range.Min; Maximum = (T)range.Max; _value = (T)Device.GetProperty(_propertyId); Supported = true; } } catch (Exception) { Supported = false; } ... } public T Minimum { ... } public T Maximum { ... } public T Value { ... set { if (!_value.Equals(value)) { try { Device.SetProperty(_propertyId, (T)value); _value = value; ... } catch (Exception) { ... } } } } ... }</code> <br> <br>   <code>ExposureCompensationParameter</code> ,  <code>Guid RangeParameter</code>   <code>KnownCameraPhotoProperties.ExposureCompensation</code> , ‚Äî ,         .      ,      <code>Int32</code> ,             . <br> <br> <code class="cs">... public class ExposureCompensationParameter : RangeParameter&lt;Int32&gt; { public ExposureCompensationParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.ExposureCompensation, "Exposure compensation") { } ... }</code> <br> <br>  Camera Explorer       <code>ArrayParameter</code> .         .    ‚Äî     <code>void PopulateOptions()</code>  <code>void SetOption(ArrayParameterOption option)</code> ,         . <br> <br> <code class="cs">... public class ArrayParameterOption { ... public ArrayParameterOption(dynamic value, string name) { ... } public dynamic Value { ... } public string Name { ... } ... } public abstract class ArrayParameter : Parameter, IReadOnlyCollection&lt;ArrayParameterOption&gt; { private List&lt;ArrayParameterOption&gt; _options = new List&lt;ArrayParameterOption&gt;(); private ArrayParameterOption _selectedOption; ... public ArrayParameter(PhotoCaptureDevice device, string name) : base(device, name) { ... } public override void Refresh() { ... _options.Clear(); _selectedOption = null; try { PopulateOptions(); Supported = _options.Count &gt; 0; } catch (Exception) { Supported = false; } ... } protected List&lt;ArrayParameterOption&gt; Options { ... } public ArrayParameterOption SelectedOption { ... set { if (_selectedOption != value) { ... if (_selectedOption != null)) { SetOption(value); } _selectedOption = value; } } } protected abstract void PopulateOptions(); protected abstract void SetOption(ArrayParameterOption option); ... }</code> <br> <br> ,           ,      ,           .           <code>void PopulateOptions()</code> ,       ,    <code>ArrayParameterOption</code> <code>SelectedOption</code> ,   <code>void SetOption(ArrayParameterOption option)</code> .  ,  <code>static IReadOnlyList     ,  KnownCameraPhotoProperties.SceneMode</code>  <code>object PhotoCaptureDevice.GetProperty(Guid propertyId)</code>     .          <code>void PhotoCaptureDevice.SetProperty(Guid propertyId, object value)</code> . <br> <br> <code class="cs">... public class SceneModeParameter : ArrayParameter { public SceneModeParameter(PhotoCaptureDevice device) : base(device, KnownCameraPhotoProperties.SceneMode, "Scene mode") { } protected override void PopulateOptions() { IReadOnlyList&lt;object&gt; supportedValues = PhotoCaptureDevice.GetSupportedPropertyValues( Device.SensorLocation, PropertyId); object value = Device.GetProperty(PropertyId); foreach (dynamic i in supportedValues) { CameraSceneMode csm = (CameraSceneMode)i; ArrayParameterOption option = new ArrayParameterOption(csm, csm.ToString()); Options.Add(option); if (i.Equals(value)) { SelectedOption = option; } } } protected override void SetOption(ArrayParameterOption option) { Device.SetProperty(PropertyId, option.Value); } ... }</code> <br> <br> Tap-to-focus <br>           ¬´¬ª. Tap-to-focus    ,      ,   ,        .   ,   Tap-to-focus . <br> <br>     <code>Rectangle</code>  <code>Canvas</code> ,     : <br> <br> <code class="cs">&lt;Rectangle x:Name="FocusIndicator" Stroke="Red" Opacity="0.7" Width="80" Height="80" StrokeThickness="5" Visibility="Collapsed"/&gt;</code> <br> <br>   ,    . <br>         Canvas Tap: <br> <br> <code class="cs">public MainPage() { ... VideoCanvas.Tap += new EventHandler&lt;GestureEventArgs&gt;(videoCanvas_Tap); ... }</code> <br> <br>          .       API-   ,  <code>VideoCanvas</code> ,     ,     . <br> <br>    ,     .    ,     ,        ,     . <br> <br> ,          ,   ,  ,   . <br> <br> <code class="cs">private async void videoCanvas_Tap(object sender, GestureEventArgs e) { System.Windows.Point uiTapPoint = e.GetPosition(VideoCanvas); if (PhotoCaptureDevice.IsFocusRegionSupported(_dataContext.Device.SensorLocation) &amp;&amp; _focusSemaphore.WaitOne(0)) { //      . Windows.Foundation.Point tapPoint = new Windows.Foundation.Point(uiTapPoint.X, uiTapPoint.Y); double xRatio = VideoCanvas.ActualWidth / _dataContext.Device.PreviewResolution.Width; double yRatio = VideoCanvas.ActualHeight / _dataContext.Device.PreviewResolution.Height; //  ,     Windows.Foundation.Point displayOrigin = new Windows.Foundation.Point( tapPoint.X - _focusRegionSize.Width / 2, tapPoint.Y - _focusRegionSize.Height / 2); //        canvas Windows.Foundation.Point viewFinderOrigin = new Windows.Foundation.Point( displayOrigin.X / xRatio, displayOrigin.Y / yRatio); Windows.Foundation.Rect focusrect = new Windows.Foundation.Rect( viewFinderOrigin, _focusRegionSize); //    Windows.Foundation.Rect viewPortRect = new Windows.Foundation.Rect( 0, 0, _dataContext.Device.PreviewResolution.Width, _dataContext.Device.PreviewResolution.Height); focusrect.Intersect(viewPortRect); _dataContext.Device.FocusRegion = focusrect; //    FocusIndicator.SetValue(Shape.StrokeProperty, _notFocusedBrush); FocusIndicator.SetValue(Canvas.LeftProperty, uiTapPoint.X - _focusRegionSize.Width / 2); FocusIndicator.SetValue(Canvas.TopProperty, uiTapPoint.Y - _focusRegionSize.Height / 2); FocusIndicator.SetValue(Canvas.VisibilityProperty, Visibility.Visible); CameraFocusStatus status = await _dataContext.Device.FocusAsync(); if (status == CameraFocusStatus.Locked) { FocusIndicator.SetValue(Shape.StrokeProperty, _focusedBrush); _manuallyFocused = true; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.Exposure &amp; AutoFocusParameters.Focus &amp; AutoFocusParameters.WhiteBalance); } else { _manuallyFocused = false; _dataContext.Device.SetProperty( KnownCameraPhotoProperties.LockedAutoFocusParameters, AutoFocusParameters.None); } _focusSemaphore.Release(); } }</code> <br> <br>    ,       .     <code>FocusAsync</code> ,    ,    .  ,    <code>WaitOne</code> , ,    ,    <code>false</code>  ‚Äî  ,    . <br> <br>    <br>      ,   ¬´¬ª,   Lens Picker. ¬´¬ª             ,   .        Lens Picker,   XML          App: <br> <br> <code class="cs">&lt;Extensions&gt; &lt;Extension ExtensionName="Camera_Capture_App" ConsumerId="{5B04B775-356B-4AA0-AAF8-6491FFEA5631]" TaskId="_default" /&gt; &lt;/Extensions&gt;</code> <br> <br>  ,     Lens Picker,      .  ,   Lens Picker    <code>Assets</code> .         ,      <a href="http://msdn.microsoft.com/library/windowsphone/design/jj662922(v%3Dvs.105).aspx">Lens design guidelines for Windows Phone</a> . <br> <br>         Maps API.</code></code></code></code></code></code> </div><p>Source: <a href="https://habr.com/ru/post/174307/">https://habr.com/ru/post/174307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174295/index.html">Why problems arise in communications in big cities and how they are solved</a></li>
<li><a href="../174297/index.html">Fuel - the world's smallest "emergency" charger</a></li>
<li><a href="../174299/index.html">The Third Round of Windows Phone Next App Star Voting Round Started</a></li>
<li><a href="../174303/index.html">AppClub {build, monetize} # 5 will gather mobile experts and startups again</a></li>
<li><a href="../174305/index.html">Layout Automation</a></li>
<li><a href="../174309/index.html">Video analytics: a pragmatic view</a></li>
<li><a href="../174311/index.html">Digest of upcoming IT events for April 2013</a></li>
<li><a href="../174315/index.html">Getting ready to turn off Google Reader</a></li>
<li><a href="../174317/index.html">CamBoard Pico - the next generation of gesture control interface</a></li>
<li><a href="../174319/index.html">What I hate outsourcing system administration for. Customer perspective</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>