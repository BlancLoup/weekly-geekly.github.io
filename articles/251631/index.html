<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The maze output program at 13 ... no. 10 bytes!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the past, having found an interesting solution when writing a demo, I quietly used it or boasted to a narrow circle of friends in the demoscene. Bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The maze output program at 13 ... no. 10 bytes!</h1><div class="post__text post__text-html js-mediator-article">  In the past, having found an interesting solution when writing a demo, I quietly used it or boasted to a narrow circle of friends in the demoscene.  But now my opportunities to achieve something at the demostsena have come to an end, and minimalist programming tournaments are not held, so I decided to write a blog about my achievement: a maze generator with just 13 bytes of x86 machine code. <br><br>  To understand the essence of the achievement, you need to know about the team 10 PRINT.  This is a line of Commodore 64 BASIC code that, when launched, creates an infinite maze.  Of course, its conclusion is not a real labyrinth, there is no entrance and exit there, and it is full of enclosed spaces and dead ends.  But it looks like a labyrinth.  It is amazing how a simple command produces an infinitely complex pattern. <br><a name="habracut"></a><br>  Also under the name ‚Äú10 PRINT‚Äù a book of 324 pages was published.  She talks about code, art, perception, culture, chance, mazes and everything else.  It is recommended for reading to anyone who is interested in programming - for everyone there will be interesting topics that are also very well lit and decorated. <br><br><h4>  42 bytes </h4><br>  Let's go back to the code.  In the book ‚Äú10 PRINT‚Äù I read that the code from BASIC can be represented in a more compact form in the machine code C64.  There was also a problem for readers.  The record was set up by 4-Mat and Wisdom comrades, who pushed the solution into 15 bytes.  I wondered how this can be done on x86.  So I wrote the first version of this program: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">;  ,    <span class="hljs-string"><span class="hljs-string">"10 PRINT"</span></span> ;     <span class="hljs-string"><span class="hljs-string">""</span></span>     ;     . ;        ;       ;        . init: mov ax,<span class="hljs-number"><span class="hljs-number">0001</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>h ;   <span class="hljs-number"><span class="hljs-number">40</span></span>x25 xor bh,bh ; ,  vidpage=<span class="hljs-number"><span class="hljs-number">0</span></span> mov cx,(<span class="hljs-number"><span class="hljs-number">40</span></span>*<span class="hljs-number"><span class="hljs-number">23</span></span>) ;    getrnd: xor ax,ax ;  al=<span class="hljs-number"><span class="hljs-number">0</span></span> pushf cli ; ,      out <span class="hljs-number"><span class="hljs-number">43</span></span>h,al ;   in al,<span class="hljs-number"><span class="hljs-number">40</span></span>h ; lobyte  mov ah,al in al,<span class="hljs-number"><span class="hljs-number">40</span></span>h ; hibyte  popf ;  xchg ah,al ;  <span class="hljs-number"><span class="hljs-number">8253</span></span> raw <span class="hljs-number"><span class="hljs-number">16</span></span>-bit word pickch: shr ax,<span class="hljs-number"><span class="hljs-number">1</span></span> ;BIOS   count-by<span class="hljs-number"><span class="hljs-number">-2</span></span>,    lo shr ax,<span class="hljs-number"><span class="hljs-number">1</span></span> ; carry = <span class="hljs-string"><span class="hljs-string">""</span></span>  mov al,<span class="hljs-string"><span class="hljs-string">'\' jc writec ;  ,   mov al,'</span></span>/<span class="hljs-string"><span class="hljs-string">' ;    writec: mov ah,0eh ;     int 10h loop getrnd int 20h ;  DOS</span></span></code> </pre> <br><br>  This code behaves ‚Äúdecently‚Äù, does not make assumptions about the state of the processor and quits (the original version 10 PRINT worked indefinitely).  A random number is more or less well generated from the iron timer, which counts from 65535 to 0 every second. When compiling a86, the 42-byte .COM file comes out <br><br>  The size is very different from C64 in two places: a random number generator and symbol selection.  The C64 has an advantage in symbols, since  both slashes are next to PETSCII.  If you have a random bit, you can simply add it to the first slash, and get either it or the second slash.  When using ASCII, this does not work, you have to use a condition. <br><br>  Then, for optimization, I decided to remove the selection condition.  When you shift the code of one of the slashes, both slashes start to differ in just one bit. <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"/"</span></span>=<span class="hljs-number"><span class="hljs-number">2f</span></span>  <span class="hljs-string"><span class="hljs-string">"\"=5c 2f=00101111 5c=01011100</span></span></code> </pre><br><br>  Therefore, it is possible to replace the pickch piece: <br><br><pre> <code class="cpp hljs">pickch: shr ax,<span class="hljs-number"><span class="hljs-number">1</span></span> ;BIOS   count-by<span class="hljs-number"><span class="hljs-number">-2</span></span>,    lo push cx ;   mov cl,al ;    cl <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cl,<span class="hljs-number"><span class="hljs-number">1</span></span> ;cl  <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">1</span></span> mov al,<span class="hljs-string"><span class="hljs-string">'\' ;  '</span></span>\<span class="hljs-string"><span class="hljs-string">' shr al,cl or al,cl ; cl=1,  '</span></span>\<span class="hljs-string"><span class="hljs-string">'   '</span></span>/<span class="hljs-string"><span class="hljs-string">',  ‚Äì  </span></span></code> </pre><br><br>  It was cool, but as a result, the size increased to 48 bytes.  I had to drop the idea. <br><br>  Another optimization is to remove the writec output procedure, and just push the bytes into the video memory.  This removed two bytes from the output procedure, but added 4 bytes to the tuning (and 5, if it remained within the 8086 standard), so it also had to be discarded. <br><br><h4>  25 bytes </h4><br>  I took a closer look at the largest segment of the program - the random number generator.  It is obvious that the quality of the generator does not concern us much - the main thing is that there should be no obvious repetitions.  Therefore, I replaced the ‚Äúgetrnd‚Äù block with a single LODSB instruction.  It takes out a byte from memory and goes to the next one, so you can read the sequence from memory.  And the place from which I started reading is where DS: SI shows when the program starts.  For a COM file in DOS, it indicates the beginning of the program itself.  Therefore, my "random" stream was determined by the compiled code itself, and all kinds of garbage from other programs.  As a result, the code is greatly reduced to 25 bytes. <br><br><h4>  15 bytes </h4><br>  Here I already got excited - an opportunity to approach the size of the C64 version appeared.  I got rid of all kinds of gestures such as changing video mode, clean output (now the program works forever) and register initialization.  At the end it looked like this: <br><br><pre> <code class="cpp hljs">init: mov ah,<span class="hljs-number"><span class="hljs-number">0</span></span>eh ;<span class="hljs-number"><span class="hljs-number">10</span></span>h       getrnd: lodsb ;    ,   DS:SI pickch: shr al,<span class="hljs-number"><span class="hljs-number">1</span></span> ;carry = <span class="hljs-string"><span class="hljs-string">""</span></span>  mov al,<span class="hljs-string"><span class="hljs-string">'\' jc writec ;  ,   mov al,'</span></span>/<span class="hljs-string"><span class="hljs-string">' ;    writec: int 10h ;  jmp getrnd ; </span></span></code> </pre><br><br>  15 bytes is a success! <br><br><h4>  13 bytes </h4><br>  Everything seemed to me that I could improve the pickch block.  The block starts with assigning a random variable to the carry flag, but the 8086 has a parity flag, which is automatically set in some cases.  Unfortunately, LODSB flags are not cocked.  A mathematical operation would have raised the parity flag, but such an operation would have taken more space.  If you could find a single-byte instruction that does the same thing as LODSB and cocks the parity flag depending on the input data ... <br><br>  There is such an instruction!  SCAS - loads a byte, compares it with AL, and cocks the flag according to the results of the comparison.  It is intended for use in a loop, but no one bothers to use it without a loop.  And as a result: <br><br><pre> <code class="cpp hljs">init: mov ah,<span class="hljs-number"><span class="hljs-number">0</span></span>eh ;<span class="hljs-number"><span class="hljs-number">10</span></span>h       getrnd: scasb ;   ES:DI    AL ;    pickch: mov al,<span class="hljs-string"><span class="hljs-string">'\' ;  jc writec ;  ,   mov al,'</span></span>/<span class="hljs-string"><span class="hljs-string">' ;    writec: int 10h ;  jmp getrnd ; </span></span></code> </pre><br><br>  And here you are 13 bytes.  It even works on old IBM PCs, since it does not use instructions from 80186+.  Approximate output: <br><br><img src="https://habrastorage.org/files/edf/05b/b3c/edf05bb3c1b74b688d02930563b30386.png"><br><br><h4>  12 bytes </h4><br>  Reader Peter Ferier has managed to improve my achievement by one byte. <br><br><pre> <code class="cpp hljs">init: mov ax,<span class="hljs-number"><span class="hljs-number">0e5</span></span>ch ; AH  cmd <span class="hljs-string"><span class="hljs-string">" "</span></span>  AL  <span class="hljs-string"><span class="hljs-string">'\' scasb ;   ES:DI    AL ;this sets flags similar to a subtraction pickch: jp writec ;   ,      AL mov al,'</span></span>/<span class="hljs-string"><span class="hljs-string">' ;    writec: int 10h ;   AL jmp init ; </span></span></code> </pre><br><br>  Bravissimo.  However, the reader herm1t noted that if we use int 29h to output a character, then the code is reduced to <br><br><h4>  11 bytes </h4><br><pre> <code class="cpp hljs">init: mov al, <span class="hljs-string"><span class="hljs-string">'\' scasb jp writec mov al, '</span></span>/<span class="hljs-string"><span class="hljs-string">' writec: int 29h jmp init</span></span></code> </pre><br><br>  Cleverly.  But wait a minute, that's not all! <br><br><h4>  10 bytes </h4><br><pre> <code class="cpp hljs">init: scasb salc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al,<span class="hljs-string"><span class="hljs-string">'\'-'</span></span>/<span class="hljs-string"><span class="hljs-string">' add al,'</span></span>/<span class="hljs-string"><span class="hljs-string">' int 29h jmp init</span></span></code> </pre><br><br>  Peter struck back and cracked another byte (this code will not work on non-Intel processors such as the NEC V20 or V30). </div><p>Source: <a href="https://habr.com/ru/post/251631/">https://habr.com/ru/post/251631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251619/index.html">How we started monitoring the domains and what came of it</a></li>
<li><a href="../251623/index.html">Chemistry gamedev or how to manipulate players</a></li>
<li><a href="../251625/index.html">New utorrent bugs or what Bittorrent programmers are preparing for us</a></li>
<li><a href="../251627/index.html">Creating a world map</a></li>
<li><a href="../251629/index.html">Understanding the LCD screen LPH9157-2 from Siemens C75 / ME75</a></li>
<li><a href="../251647/index.html">Futuristic thinking</a></li>
<li><a href="../251649/index.html">Another way to organize OOP in JS</a></li>
<li><a href="../251653/index.html">McPaintio - a program that converts an image into a set of mouse commands that draw this image</a></li>
<li><a href="../251659/index.html">Backup Linux and restore it on another hardware</a></li>
<li><a href="../251663/index.html">How can a sysadmin stay out of work</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>