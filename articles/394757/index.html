<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing IoT devices using Bluetooth LE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bluetooth technology is energetically making its way into the Internet of Things area. Part of this technology, called Bluetooth LE ( Bluetooth Low En...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing IoT devices using Bluetooth LE</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/054/28f/426/05428f4260bd302f20e5a277359c591e.png"></div><br><br>  <b>Bluetooth</b> technology is energetically making its way into the Internet of Things area.  Part of this technology, called <font color="#C00000"><b>Bluetooth</b> <font color="#C00000">LE</font></font> ( <b>Bluetooth Low Energy</b> , also known as <b>Bluetooth Smart</b> , also <b>BLE</b> ), directly positions itself as an ideal choice for <b>IoT</b> ( <b>Internet of things</b> ).  It is hard not to agree.  <b>BLE</b> already knows how to route Internet traffic, determine coordinates in premises, connect industrial programmable logic controllers, support <b>WEB</b> servers, connect scales, thermometers, heart rate monitors, oximeters, tonometers and a lot of other things.  C <b>BLE</b> automatically solves many problems inherent in solutions using <b>Wi-Fi</b> .  Not long until the moment when devices with <b>BLE</b> can be organized in the <a href="https://ru.wikipedia.org/wiki/%25D0%25AF%25D1%2587%25D0%25B5%25D0%25B8%25D1%2581%25D1%2582%25D0%25B0%25D1%258F_%25D1%2582%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%258F">MESH network</a> , according to technology similar to <b>ZigBee</b> .  This is already reflected in the <b>Bluetooth 5.0</b> specification. <a name="habracut"></a><br><br>  Therefore, when developing my <b>IoT</b> module, I gave absolute preference to <b>BLE</b> as opposed to using <b>Wi-Fi</b> .  I will consider the peripheral part of the <b>BLE</b> network using the example of the <b>K66BLEZ</b> debug module. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here I would like to describe my development route from almost complete ignorance of <b>BLE</b> to the release of a serial product. <br><br>  An introduction to the <b>K66BLEZ1</b> module was started in these articles: <br><blockquote>  <a href="https://geektimes.ru/post/274100/">Universal controller module for the Internet of things.</a>  <a href="https://geektimes.ru/post/274100/">Breathing life</a> <br>  <a href="https://geektimes.ru/post/274416/">Universal controller module for the Internet of things.</a>  <a href="https://geektimes.ru/post/274416/">FatFs Testing</a> <br>  <a href="https://geektimes.ru/post/276098/">Universal controller module for the Internet of things.</a>  <a href="https://geektimes.ru/post/276098/">Basics of programming</a> <br>  <a href="https://github.com/Indemsys/K66BLEZ1/blob/master/PCB/K66BLEZv1.pdf">Module circuit</a> <br>  <a href="https://github.com/Indemsys/K66BLEZ1">Project repository</a> </blockquote><br>  The <b>K66BLEZ</b> module uses the <a href="http://www.nxp.com/products/microcontrollers-and-processors/arm-processors/kinetis-cortex-m-mcus/w-series-wireless-m0-plus-m4/kinetis-kw40z-2.4-ghz-dual-mode-ble-and-802.15.4-wireless-radio-microcontroller-mcu-based-on-arm-cortex-m0-plus-core:KW40Z">MKW40Z160</a> chip ( <b><i>48 MHz Cortex-M0 +, 160 KB Flash, 20 KB RAM</i></b> ) manufactured by <b>NXP</b> as a <b>BLE</b> transceiver.  The chip is interesting because along with BLE it can work as a transceiver of <b>802.15.4</b> signals.  And the <b>802.15.4 standard</b> , as is known, is a carrier in <b>ZigBee</b> technology.  The <b>ZigBee</b> stack for <b>MKW40Z itself is</b> not released, but it is already offered to the firmware where <b>802.15.4</b> works simultaneously with <b>BLE</b> . <br><br>  Diagram of the part of the module with the BLE chip is shown below. <br> <a href=""><img align="left" width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/b5d/0c0/158/b5d0c01586e8bc42182a764c0b7e8716.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br>  <b>Replacing the MKW40</b> chip, there is already a <b>MKW41</b> chip with a 128 kB RAM, 512 kB Flash capacity and support for all popular protocols: <b>BLE 4.2, BLE Mesh, ZigBee, Thread, IPv6 6LoBLE</b> .  The new chip has no open documentation yet, but it promises to be pin compatible with the MKW40. <br><br>  The BLE chip MKW40 on the module is connected to the main microcontroller MK66 SPI and I2C interfaces.  The I2C interface also connects the chip with a charger chip.  The main communication channel is implemented on the SPI interface with a bit rate of 6 Mbit / s. <br><br>  Debugging of the program in the MKW40 chip can be performed via the SWD interface using the JTAG adapter and via the UART0 debugging interface also brought to the X4 debugger connector. <br>  NXP provides more than two dozen examples of the implementation of various applications on the MKW40 chip, including: pressure meters, glucose levels, temperatures, proximity sensors, heart rate meters, etc.  There are applications for wireless UART and wireless loader. <br><br>  I have done a deep refactoring of the NXP framework for these chips and created new profiles with Windows PC demo programs that do not require a separate adapter on the PC side.  But more about that later. <br><br>  Bluetooth LE is hard to learn.  The reason is the volume specification and a large number of its brief retellings in the documentation of manufacturers, immediately starting with unusual terminology.  So let's start with it. <br><br><h1>  Decoding and translation of terms and abbreviations, slang. </h1><br><ul><li>  <b><font color="#C00000">Pairing</font></b> - binding (peyring).  The process of creating pairs of BLE devices of one or more shared secret keys for subsequent encryption of traffic.  The user is involved in this process when the system asks for a PIN code. </li><li>  <b><font color="#C00000">Bonding</font></b> - binding (bonding).  The process of retaining shared secret keys for use in subsequent trusted connections of pairs of BLE devices. </li><li>  <b><font color="#C00000">Device</font> <font color="#C00000">authentication</font></b> - verification (authentication) that two devices have the same secret keys. </li><li> <b><font color="#C00000">Advertising</font></b> - The process of broadcasting a BLE device by means of an alert package (advertising).  In these packages, the device reports its name and address, reports on the services it provides, as well as specific information. </li><li>  <b><font color="#C00000">Scanning</font></b> - The process of receiving packets of overwriting from other BLE devices during passive scanning.  With active scanning, sending packets of requests for additional information from devices working in the advertising mode. </li><li>  <b><font color="#C00000">Profile</font></b> - profile.  A set of lists of functions, properties, behaviors, and roles for a set of levels of a specific protocol stack. </li><li>  <b><font color="#C00000">UUID</font></b> - universally unique identifier.  128-bit unique attribute identifier. </li><li>  <b><font color="#C00000">BLE</font> <font color="#C00000">Host</font></b> - host.  The part of the BLE stack software running on the main processor on which the main application is running and the bridge functionality to the main application is running.  The host contains GAP, GATT, GATT, L2CA database. </li><li>  <b><font color="#C00000">BLE</font> <font color="#C00000">Controller</font></b> - controller.  A piece of software stack BLE running on a Bluetooth radio chip. </li><li>  <b><font color="#C00000">HCI</font></b> - Host Controller Interface.  Protocol or API depending on the context for communication between the BLE host and the BLE controller. </li><li>  <b><font color="#C00000">GAP</font></b> - Generic Access Profile, typical access profile.  This is usually called a layer immediately.  But it is rather strange to call a profile a layer.  In the source it is presented as a set of macros, declarations and functions for establishing and maintaining communication between BLE devices. </li><li>  <b><font color="#C00000">GATT</font></b> - Generic Attribute Profile, a generic attribute profile.  In source, this is a set of functions for exchanging data between devices.  Attributes are data units of different types (strings, numbers, structures ...) organized in a hierarchical tree whose nodes are services, characteristics, descriptors, etc.  The attribute is characterized by the fact that it has a unique identifier UUID. </li><li>  <b><font color="#C00000">L2CA</font></b> - Logical Link Control and Adaptation Layer.  The program layer with the appropriate protocol is responsible for establishing and maintaining logical communication channels.  Engaged in forwarding scheduling, error checking, packet segmentation, flow control, packet multiplexing between upper layer protocols.  It is part of the BLE host. </li><li>  <b><font color="#C00000">SMP</font></b> - Security Manager Protocol.  The protocol used for peering.  Works on a dedicated channel in L2CA. </li><li>  <b><font color="#C00000">LTK</font></b> - Long-Term Key.  The secret key used to encrypt BLE traffic. </li><li>  <b><font color="#C00000">IRK</font></b> - Identity Resolving Key.  The key to decrypt the real address of the device from the confusing public. </li><li>  <b><font color="#C00000">CSRK</font></b> - Connection Signature Resolving Key.  Key for signing messages. </li><li>  <b><font color="#C00000">RAND</font></b> - 64-bit random variable, used to form LTK </li><li>  <b><font color="#C00000">EDIV</font></b> - 16-bit random variable, used to form LTK </li><li>  <b><font color="#C00000">MITM</font></b> - man-in-the-middle.  Attempting to open by a third party the joint secret key of two devices being introduced into the communication channel between devices as an intermediate link. </li><li>  <b><font color="#C00000">Message</font> <font color="#C00000">integrity</font></b> - protection against message falsification. </li><li>  <b><font color="#C00000">The framework</font></b> is what I call software in source code here, designed to simplify the creation of applications on a specific hardware platform with specific libraries of communication protocol stacks.  It usually includes BSP (board support package), HAL (hardware abstraction layer), OSA (OS abstraction layer), middleware (middleware) such as: memory managers, file systems, schedulers and timers, and so on. </li></ul><br><h1>  Competitive Decision Analysis </h1><br>  When choosing a chip for BLE, I conducted a small analysis of offers from the most well-known manufacturers.  Most of all I was interested in the composition of the proposed software, frameworks and tools for compiling-assembling-debugging projects under the ARM core.  An important factor was continuity with the IAR environment and the <b>RTOS MQX</b> framework, which are used when developing the application on the main processor of the module. <br><br><h2>  <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF5-SDK">NORDIC SEMICONDUCTOR</a> </h2>  provides an SDK for the <b>nRF51822</b> chip with a <font color="#C00000"><b>Cortex</b> - <font color="#C00000">M0 core</font></font> .  Compiled in IAR, KEIL, GCC.  The BLE stack is represented by a monolithic library without source codes called <b>SoftDevice</b> where all APIs are implemented: GAP, GATT, L2CA, HCI.  A framework with drivers is being built around this library.  The framework comes with two RTOSs: <a href="http://www.keil.com/rl-arm/kernel.asp">RL-ARM RTX</a> from Keil, and <a href="http://www.freertos.org/">FreeRTOS</a> .  The framework uses <a href="https://github.com/google/protobuf">protobuf</a> serialization <a href="https://github.com/google/protobuf">technology</a> and <a href="https://habrahabr.ru/post/259205/">Segger RTT</a> debugging. <br><br>  In addition, the proposed package <b>nrf5 IoT SDK</b> .  It includes the sources of the MQTT, COAP, TLS protocols (taken from the MBED project), cJSON, lwip (a free TCP / IPv4 / IPv6 protocol stack), an interface of sockets, an adapter for IPv6.  There are <b>6LoWPAN</b> , but without the source code. <br><br><h2>  <a href="">Texas Instruments</a> </h2>  on ARM makes only 2-core BLE chips <b><a href="http://www.ti.com/product/cc2640">CC2640</a></b> ( <b>Cortex-M3 and Cortex-M0</b> ), but the corresponding <b>Bluetooth 4.2</b> specifications. For downloading provides the SDK <a href="http://www.ti.com/lit/ug/swru393c/swru393c.pdf">SimpleLink Bluetooth low energy Software Stack 2.2.0</a> Compiled by its own development environment Code Composer Studio, as well as in the IAR environment.  It comes with its own RTOS <a href="http://www.ti.com/tool/ti-rtos">TI-RTOS 2.16</a> and a developed framework around the BLE stack libraries.  SDK as one of the scenarios involves the use of an external application processor - Simple Application Processor (SAP).  The <b>CC2640</b> chip <b>itself is</b> referred to as the Simple Network Processor (SNP).  Communication is established between them using a protocol called the <b>Unified Network Processor Interface</b> (NPI).  On the CC2640 side, TI-RTOS is required, on the SAP processor side, you can use RTOS optionally.  The NPI source code is supplied with the SDK for both the SAP side and the SNP side.  This is <b>SimpleLink</b> technology. <br><br>  The BLE stack itself is divided into 3 precompiled libraries without source code: host, controller, HCI.  All three libraries work only on the Cortex-M3 processor, which is part of the CC2640 chip.  In addition to studying TI-RTOS, the user will need to study a special software mechanism or protocol for interacting with the BLE stack called iCall. <br><br><h2>  <a href="http://www.atmel.com/devices/ATBTLC1000.aspx%3Ftab%3Ddocuments">Microchip-atmel</a> </h2>  manufactures Bluetooth LE chips <b>ATBTLC1000</b> on the core <b>Cortex-M0</b> .  The entire stack of chips is written in ROM.  No open tools for programming these chips were found on the Atmel website.  Atmel instead suggests using an external microcontroller to interact with the ATBTLC1000.  Software for an external microcontroller and examples are in the Atmel Software Framework package.  Compiled in <b>Atmel Studio</b> (shell for GCC) or in IAR. <br><br><h2>  <a href="http://www.cypress.com/products/bluetooth-low-energy-ble-connectivity-solutions">Cypress Semiconductor Corp.</a> </h2>  manufactures <b>Cortex-M0</b> - <a href="http://www.cypress.com/documentation/datasheets/psoc-4-psoc-4xx8-ble-42-family-datasheet-programmable-system-chip-psoc%3Fsource%3Dsearch%26cat%3Dtechnical_documents">PSoC 4</a> <b>cores of</b> programmable BLE chips on the core <a href="http://www.cypress.com/documentation/datasheets/psoc-4-psoc-4xx8-ble-42-family-datasheet-programmable-system-chip-psoc%3Fsource%3Dsearch%26cat%3Dtechnical_documents">: <b>PSoC 4XX8</b></a> and <a href="http://www.cypress.com/documentation/datasheets/proc-ble-cybl1xx7x-family-datasheet-programmable-radio-chip-bluetooth-low%3Fsource%3Dsearch%26cat%3Dtechnical_documents"><b>PRoC CYBL1XX7X</b></a> supporting <b>Bluetooth 4.2</b> specifications.  Projects for chips are created in a special IDE <a href="http://www.cypress.com/products/psoc-creator-integrated-design-environment-ide">PSoC Creator</a> .  Chips differ from Cypress in that there is no ready configuration of the periphery (UART, SPI, I2S, PWM, etc.), it needs to be created from library elements in the circuit editor with the addition of program libraries.  This is intended to provide some flexibility.  Although the developer adds a considerable amount of work.  A configured project can be compiled by one of the toolchains: GCC, IAR, Keil.  BLE there is one of the libraries.  The BLE stack comes in the form of a precompiled monolithic library without source code combining the BLE host, BLE controller and HCI.  However, the company posted the source code for Android and iOS applications working with BLE. <br><br><h2>  <a href="http://www.silabs.com/products/wireless/bluetooth/efr32-blue-gecko/Pages/blue-gecko-bluetooth-smart-soc.aspx">Siliconon labs</a> </h2>  manufactures <a href="http://www.silabs.com/products/wireless/bluetooth/efr32-blue-gecko/Pages/blue-gecko-bluetooth-smart-soc.aspx">EFR32 Blue Gecko Bluetooth Smart SoCs</a> on the ARM <b>Cortex-M4 core</b> supporting <b>Bluetooth 4.2</b> specifications. The <a href="https://www.silabs.com/Support%2520Documents/RegisteredDocs/EFR32BG1-DataSheet.pdf">EFR32BG1P332F256GMxx</a> type <a href="https://www.silabs.com/Support%2520Documents/RegisteredDocs/EFR32BG1-DataSheet.pdf">chips</a> can <a href="https://www.silabs.com/Support%2520Documents/RegisteredDocs/EFR32BG1-DataSheet.pdf">deliver</a> power up to <b>19.5 dBm</b> and combine a separate radio channel at 868 MHz with power up to 20 dBm and sensitivity -121.4 dBm.  The chip of Silicon Labs chips is a huge selection of alternative pin functions and a system called the <b>Peripheral Reflex System</b> (PRS).  Although the periphery cannot be created like Cypress chips, but its connection to the pins is almost arbitrary, the presence of PRS makes it possible to interact with the periphery without the involvement of the processor.  Silicon Labs' BLE stack is capable of accepting the results of profile generation by the <a href="https://www.bluetooth.com/~/media/developer-studio/index">Bluetooth Developer Studio</a> , which will be discussed below.  Silicon Labs offers two Bluetooth stacks.  One of them is designed for Bluegiga modules and supports, in addition to BLE, also regular Bluetooth.  The second stack complies with specification 4.2 and only LE.  BLE stack comes as a monolithic precompiled library without source code.  For the version with an external microcontroller, a serial protocol and API in the source code are offered.  Both GCC and IAR and Keil can compile.  Everything is done in a single development environment <b>Simplicity Studio V4</b> .  The accompanying framework stack is not supported by RTOS.  But in the source code of Simplicity Studio you can find such pearls as Speex at 8 kbps suitable for voice over BLE and a powerful windowed GUI from Segger. <br><br><h2>  <a href="http://www.st.com/content/st_com/en/products/wireless-connectivity/bluetooth-bluetooth-low-energy/bluenrg.html">STMicroelectronics</a> </h2>  makes the <b>Cortex-M0</b> based <b>BlueNRG</b> network controller chips containing the BLE stack according to the <b>Bluetooth 4.1</b> specification. <br><br>  The chips themselves are not programmed, but have a serial application command interface (ACI) through which the external microcontroller must communicate with them.  A framework has been developed for ACI, and it can be included as an integral part of the STM32Cube proprietary development environment from ST. <br><br><h2>  <a href="http://www.csr.com/products/bluetooth-smart-csr101x-product-family">CSR PLC</a> </h2>  does not make BLE chips on ARM Cortex, but interested in its implementation of the <b>MESH network on Bluetooth</b> modules.  The video is <a href="https://www.youtube.com/watch%3Fv%3DSmdM0gVjCLg">here</a> .  Laid out the source of various BLE applications for Android and iOS.  There is an SDK. <br><br><h2>  <a href="https://www.renesas.com/en-us/products/microcontrollers-microprocessors/rl78/rl78g1x/rl78g1d.html">Renesas</a> </h2>  makes BLE chips on its 16-bit <b>RL78</b> core.  BLE stack is issued only to premium users.  All yours - compiler, RTOS, host microcontroller.  But there is a plugin for <a href="https://www.bluetooth.com/~/media/developer-studio/index">Bluetooth Developer Studio</a> <br><br><h2>  <a href="http://www.dialog-semiconductor.com/products/connectivity/bluetooth-low-energy/smartbond-da14580">Dialog Semiconductor</a> </h2>  offer, as they claim, <b>the smallest BLE chips</b> .  However, the chips with <a href="http://www.dialog-semiconductor.com/sites/default/files/da14583-datasheet.pdf"><b>DA14583</b></a> Flash memory (the rest are only from ROM) cannot be called the smallest - 5x5 mm.  Core <b>Cortex-M0</b> .  Maximum power <b>0 dBm</b> .  Support <b>Bluetooth 4.1</b> specification <b>.</b>  To get the SDK from the company, you need to register and get tested.  But with such chip parameters I didn‚Äôt even try to get the SDK. <br><br>  So, the sources MQTT, COAP, TLS, SPEEX, LwIP and so on.  We are of little interest in the various SDKs, and so you can freely find them on Github without reference to specific frameworks.  Supporting the Bluetooth 4.2 specification does little because on the PC this is not yet possible to use. <br><br>  Niche RTOS like TI-RTOS or special planners will make it harder for us to master, we try to avoid such solutions. <br><br>  I was pleased that I chose the solution on Kinetis. <br><br><h1>  What is interesting about the Bluetooth LE stack from NXP for the Kinetis family? </h1><br>  The BLE stack for Kinetis, like the others, comes in the form of precompiled libraries.  A multitasking framework is built around these libraries, including a driver and a layer of hardware abstraction in source code independent of the operating system.  The framework can be configured to work without an operating system, or it can be used.  Immediately in the delivery framework is adapted for FreeRTOS.  But it interacts with FreeRTOS through an auxiliary set of functions, called the abstraction layer from the operating system (OS abstraction, OSA). <br><br>  Thanks to OSA, instead of FreeRTOS, you can substitute any other operating system that supports message queuing, preemption, flags, and timer.  For example, RTOS MQX.  The stack is compiled, oddly enough, only in the IAR environment.  Fortunately, in my case, this is not a problem. <br><br>  More interesting is that the stack is divided into two libraries - BLE host and BLE controller.  And the BLE host library can work on another chip. <br><br>  The libraries interact with each other in this case through the HCI protocol.  Those.  where other manufacturers come up with another communication protocol for the application to communicate on an external microcontroller with the BLE stack (recall SimpleLink), NXP offers a standard solution.  And most importantly, with this approach, moving BLE host to a more powerful external microcontroller, we significantly increase the capabilities of our GATT database and services. <br><br><h1>  BLE in brief </h1><br>  An open version of the Bluetooth specification version 4.2 is available <a href="https://www.bluetooth.com/specifications/adopted-specifications">here</a> .  The description of the BLE lower level ( <b>Controller</b> level) is included as <b>‚ÄúVol.6 Core System Package [Low Energy Controller volume]‚Äù</b> from page 2544. The upper level ( <b>Host</b> level) with the description of the ATT protocol and the GATT profile is in the <b>‚Äúvol.3‚Äù</b> part <b>Core System Package [Host volume] "</b> document from page 1693. <br><br>  The range of frequencies used <br> <a href=""><img align="left" width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/3fb/e8a/e0e/3fbe8ae0e3e35ab16e27593cef024fff.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br>  Three frequencies (in the figure above are indicated by channel numbers 37,38,39) are allocated for broadcast indirective parcels, and the rest for packet transmission when establishing logical communication channels between devices.  A well-known feature of Bluetooth is that during the transmission of packets, each next packet is transmitted on a different frequency of the selected pseudo-randomly from the list of allowed ones. <br><br>  All data in BLE packets can be encrypted and authenticated.  Dynamic random generation of device addresses and their identification using hashing, i.e.  Having intercepted the device address on the air, we will not be able to use it for longer than 15 minutes, since the address will change in this time according to an algorithm unknown to us. <br><br>  BLE modules can operate as unidirectional transmitters, i.e.  without setting up a bidirectional connection, it‚Äôs easy to broadcast some data in the form of ad packets, for example, temperature.  For this, the data type in the <b>Advertising</b> packages designated as <b>Manufacturer Specific Data</b> can be used.  A computer or tablet can receive data from hundreds of such transmitters without unnecessary preliminary steps in searching, establishing a connection, entering a pincode, and so on. <br>  Another possibility to transfer data without setting a communication channel is to transmit in the request-response mode (request - <b>ScanRequest</b> package, module response - <b>ScanResponce</b> package).  This <b>BLE is</b> significantly different from <b>Wi-Fi</b> , where even for the simplest thermometer it is necessary to establish a connection that takes away the resources of the router. <br><br><h1>  BLE protocol stack </h1><br>  The figure below shows the <b>BLE</b> representation as seen by the microcontroller programmer.  The BLE stack consists of two software parts: <b>Host</b> and <b>Controller</b> .  The software part of the <b>Host</b> deals with high-level functions of organizing and managing data and connections, while the <b>Controller</b> controls the physical peripherals of the transceiver, works with secret keys, and deals with other low-level functions.  The named parts are connected by the <b>HCI</b> ( <b>Host Controller Interface</b> ) software interface.  In the PC implementation, the <b>Host</b> part works on the computer, and the <b>Controller</b> part works in the <b>Bluetooth</b> hardware transceiver, and the <b>HCI</b> protocol is most often transmitted via <b>USB</b> .  In the implementation on the microcontroller, both parts work on the same chip, and the <b>HCI</b> interface simply turns into direct data transfer from the task (software module) of the host to the task (software module) of the controller and vice versa. <br>  In fact, the programmer sees several sets of APIs running at the <b>Host</b> : level called <b>GATT</b> , <b>GAP, L2CA, SMP, HCI</b> .  With the help of the <b>GAP API</b> , the device operation mode is set to <b><i>Central, Peripheral, Observer, Broadcaster</i></b> and the connection is established when needed.  And with the help of the <b>GATT API</b> , direct transfer and reception of useful data and their analysis is performed. <br> <a href=""><img align="left" width="691" src="https://habrastorage.org/getpro/geektimes/post_images/4df/ce8/06a/4dfce806ac92c29f99024ede56bba3d6.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br>  Most existing devices still support version BLE 4.1, despite the existence of version 4.2. <br><br>  All the differences between version 4.2 and the previous one concern precisely the improvements in the part of BLE: increase in speed, the ability to transmit IP protocol and HTTP traffic, increased cryptographic protection and unrecognizability for external observers. <br><br>  An important feature of BLE in comparison with Wi-Fi is the specification of not only the communication channel, but also the application itself using it.  This is called profiles and services.  Profiles with services describe the roles of devices, the purpose of the data, the composition and format of the data, the protection of data, the order, the types and events of the exchange, and not just how the data is transmitted.  This makes it possible not to reinvent the wheel from protocols when developing, for example, a body temperature sensor or a pulse meter.  The specifications have already been given, it remains on the side of the device only to fill in the necessary fields to send the measurement results.  Clients of such devices in the form of smartphones, tablets, PCs or kitchen appliances will recognize this data automatically and display it or use it accordingly.  All due to the fact that all manufacturers are guided by the same BLE specifications regarding how temperature and pulse data are presented and how to work with them.  But there is still room for the developer‚Äôs imagination, since profiles have mechanisms for extending functionality. <br><br>  Below is a rough attribute hierarchy in a BLE device. <br> <a href=""><img align="left" width="609" src="https://habrastorage.org/getpro/geektimes/post_images/7df/ca0/0fe/7dfca00fe6427b57e47b1ba1e10c4767.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br>  Below is a slightly more detailed typical attribute tree.  This is not a complete tree, most are omitted because it would take too much space.  The colors of the tree are highlighted, each attribute has a unique number - UUID.  The entry of standard numbers is reduced to 16 bits.  In this picture, all rooms are standard.  GAP and GATT profiles are also presented as services with their standard features.  Each service can have its own security model and authorization.  The entire tree in the device is stored as a database called the GATT database, usually in the form of a simple table with cross-references. <br><br> <a href=""><img align="left" width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/3b1/d8c/5e7/3b1d8c5e7718f9e8e334af7de0a694b7.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br>  Service characteristics have many characteristics, as shown below.  Here you have to apologize for the tautology, but in BLE there really is some sort of crisis of terminology.  In short, the characteristics belonging to the service can be specified tolerances for reading, writing, the need for notices, confirmations, signatures, and so on. <br><br> <a href=""><img align="left" width="752" src="https://habrastorage.org/getpro/geektimes/post_images/c7b/dd6/c8c/c7bdd6c8cc8b066c8390a00634a7927f.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br>  BLE is a serious technology, so much has been done to ensure security and maximum formalization, which should in turn facilitate the achievement of compatibility. <br><br>  Data exchange between BLE devices is performed by writing and reading characteristic values.  There are no streaming channels such as TCP or UART.  And if the devices have them, then it means they are organized by software add-ons of a higher level. <br><br><h1>  Development tools </h1><br>  <b>Development Tools with the proposed Bluetooth Special Interest Group (Bluetooth SIG) site</b> <font color="#BA5555">-</font> <a href="https://www.bluetooth.com/develop-with-bluetooth/developer-resources-tools">https://www.bluetooth.com/develop-with-bluetooth/developer-resources-tools</a> <br><br>  The website of the main organization of standardization - <b>Bluetooth SIG</b> offers the following useful tools: <br><br><h2>  Bluetooth Developer Studio </h2><br>  <a href="https://www.bluetooth.com/~/media/developer-studio/index">Bluetooth Developer Studio</a> is a tool that allows you to correctly form and insert profiles, services, features and descriptors into the <b>BLE</b> device implementation, i.e.  create a database.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you buy an additional </font></font><a href="https://bluetoothstore.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hardware Bluetooth adapter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for $ 99, the </font></font><a href="http://blog.bluetooth.com/bluetooth-developer-studio-adds-packet-capture/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">program allows you to intercept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decrypt and display Bluetooth protocol packets. There are in the program and opportunities for debugging and testing the services created. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approved profiles are described in great detail, even minor errors regarding format, numbering, accessibility, and so on. these profiles will cause compatibility issues. But also for non-standard profiles it is very difficult to do without a tool that accurately constructs the tree of services, characteristics, descriptors in compliance with all specifications. It is easy to get lost in the names of services, characteristics, descriptors and their multibyte unique numbers - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result of the tool in particular are the generated </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XML</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> files describing the profiles, services, characteristics and descriptors in the user project. These XML files are directly used by Silicon Labs' Simplicity IDE development environment for integration into embedded projects for their chips.</font></font><br><br> <a href=""><img align="left" width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/a38/1de/850/a381de850e5724e57c5e607d78568eff.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another result of the tool can be the source code for the device working with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> database </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But for this the user needs to write his plugin in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The program also provides plug-in user access to the database through a special </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are </font></font><a href="https://www.bluetooth.com/develop-with-bluetooth/developer-resources-tools/bluetooth-developer-plugins%3F_ga%3D1.126048653.1659608677.1470034246"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a number of ready-made plug-ins</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that form the output of various source text files suitable for compiling in third-party software frameworks. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There </font><font style="vertical-align: inherit;">are no plugins </font><font style="vertical-align: inherit;">for solutions based on the </font></font><a href="http://www.nxp.com/products/microcontrollers-and-processors/arm-processors/kinetis-cortex-m-mcus/w-series-wireless-m0-plus-m4/kinetis-kw40z-2.4-ghz-dual-mode-ble-and-802.15.4-wireless-radio-microcontroller-mcu-based-on-arm-cortex-m0-plus-core:KW40Z%3Ffpsp%3D1%26tab%3DDesign_Tools_Tab"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NXP Kinetis KW40Z Connectivity Software</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> framework </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Application accelerator </font></font></h2><br> <a href="https://www.bluetooth.com/develop-with-bluetooth/developer-resources-tools/app-acc-2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application accelerator 2.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a set of sample projects with source texts for different </font></font><font color="#C00000"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android </font></font></b> <font color="#C00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></font><font style="vertical-align: inherit;"></font><font color="#C00000"><font style="vertical-align: inherit;"></font></font><font style="vertical-align: inherit;"></font><font color="#C00000"><font style="vertical-align: inherit;"></font></font><font style="vertical-align: inherit;"></font><font color="#C00000"><font style="vertical-align: inherit;"></font></font> <font color="#C00000"><font style="vertical-align: inherit;"></font></font><font style="vertical-align: inherit;"></font><font color="#C00000"><font style="vertical-align: inherit;"></font></font> <font color="#C00000"><font style="vertical-align: inherit;"></font></font><font style="vertical-align: inherit;"></font><font color="#C00000"><font style="vertical-align: inherit;"></font></font> <font color="#C00000"><font style="vertical-align: inherit;"></font></font> <font color="#C00000"><font style="vertical-align: inherit;"></font></font> <font color="#C00000"><font style="vertical-align: inherit;"></font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operating systems </font><font color="#C00000"><font style="vertical-align: inherit;">. </font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">0</font></font></font><font color="#C00000"><font style="vertical-align: inherit;"> , </font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">Blackberry</font></font></font><font color="#C00000"><font style="vertical-align: inherit;"> , </font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">iOS </font></font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">9</font></font></font><font color="#C00000"><font style="vertical-align: inherit;"> , </font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">Tizen </font></font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">2</font></font></font><font color="#C00000"><font style="vertical-align: inherit;"> . </font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">4 </font></font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">and </font></font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">Windows </font></font></font><font color="#C00000"><font color="#C00000"><font style="vertical-align: inherit;">10</font></font></font><font style="vertical-align: inherit;"> . For </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projects are only for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visual Studio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> development environment </font><font style="vertical-align: inherit;">under the </font><b><font style="vertical-align: inherit;">Universal Windows Platform (UWP)</font></b><font style="vertical-align: inherit;"> architecture </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></b>  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">these projects cannot be compiled under </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Forms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WPF</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.NET</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And bridges for transferring ordinary Windows applications to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UWP are</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> only being created. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should be noted that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UWP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to place applications in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but it does not create a simple executable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file, which you can simply copy and run. The first launch of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UWP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application is </font><font style="vertical-align: inherit;">always accompanied by the installation. All this creates difficulties for the developer. And the functionality of the demonstration projects leaves much to be desired.</font></font><br><br><div style="text-align:center;"> <a href=""><img width="376" src="https://habrastorage.org/getpro/geektimes/post_images/fd8/213/747/fd82137474453134c3bd6744473908a8.png"></a> </div> <a href=""><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The above is a screenshot of the only demo application for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows - BLEServiceBrowser</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gateway smart satarter kit </font></font></h2><br> <a href="https://www.bluetooth.com/develop-with-bluetooth/developer-resources-tools/gateway"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Starter Kit the Smart Gateway </font></font></a> <font color="#BA5555"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font></font> <font color="#000F00"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project </font></font></b> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gateway </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devices </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WEB </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itself </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WEB </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server</font></font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implements the </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user </font></font></font> <font color="#000F00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the network </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devices. Everything is implemented in the Node.js environment. It is proposed to </font><b><font style="vertical-align: inherit;">deploy</font></b><font style="vertical-align: inherit;"> on a microcomputer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raspberry Pi 2 model B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the operating system </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raspbian Jessie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Directly to connect the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raspberry Pi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devices, </font><font style="vertical-align: inherit;">use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bluetooth HCI</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sockets interface to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2CAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font><b><font style="vertical-align: inherit;">USB HCI</font></b><font style="vertical-align: inherit;"> levels</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adapter. </font><font style="vertical-align: inherit;">To run under </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you need to install a special substitute for the standard </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bluetooth</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver </font><b><font style="vertical-align: inherit;">HCI</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The solution works on a very limited number of hardware adapter types due to the limitations of the HCI driver.</font></font><br><img src="https://habrastorage.org/getpro/geektimes/post_images/156/371/75e/15637175e9313970bef4ee048bc18b56.png"><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Peryton </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Among commercial tools, the </font></font><a href="http://www.perytons.com/index.php/protocol-analyzers/bluetooth-smart/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE traffic analyzer from Perytons is interesting.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The analyzer program runs Windows PCs from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7 </font><a href="http://www.perytons.com/index.php/protocol-analyzers/bluetooth-smart/"><font style="vertical-align: inherit;">onwards</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is an important point, since native BLE drivers for Windows work only starting from version 8. </font><font style="vertical-align: inherit;">The analyzer works with a limited </font></font><a href="http://www.perytons.com/index.php/protocol-analyzers/resources/supported-hardware/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">list of hardware BLE adapters</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When working with adapters, there are also limitations in the analysis caused by traffic encryption in BLE.</font></font><br><br> <a href=""><img align="left" width="1010" src="https://habrastorage.org/getpro/geektimes/post_images/1e3/c09/488/1e3c094883e576474a719aff13a0b422.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, even from the trial version of the program you can get a lot of benefits. </font><font style="vertical-align: inherit;">The program is accompanied by demonstration records of interceptions of the exchange of real devices. </font><font style="vertical-align: inherit;">These records after loading into the program give a detailed picture of the work of the entire stack of BLE protocols. </font><font style="vertical-align: inherit;">Viewing one such interception replaces the study of all Bluetooth specifications.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bus hound </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you just need to somehow monitor the activity between the computer and the BLE device and you can do without a detailed analysis of the protocol, then the well-known Windows driver traffic interceptor called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bus Hound will do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the screenshot below you can see the stream of received advertizing packets. </font><font style="vertical-align: inherit;">Well noticeable irregularity of time intervals for receiving packets. </font><font style="vertical-align: inherit;">This indicates a significant packet loss. </font><font style="vertical-align: inherit;">The advertisy interval for the BLE device was set to 20 ms.</font></font><br><br> <a href=""><img align="left" width="784" src="https://habrastorage.org/getpro/geektimes/post_images/302/242/408/30224240815c37125998cb7eabbb7184.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The screenshot below shows the BLE device view in the Bus Hound window after peering from a PC. </font><font style="vertical-align: inherit;">For each device service after peering, a logical communication channel appears. </font><font style="vertical-align: inherit;">Here you can see the UUID of the device and services.</font></font><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/0ac/28d/99d/0ac28d99d49e38dea38c2da5caa46658.png"><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Analyzer BLE traffic (sniffer) USB-KW40Z </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a tool from the Kinetis development support kit. Therefore, I will focus on it in more detail. </font></font><a href="http://www.nxp.com/products/interface-and-connectivity/wireless-connectivity/sub-1-ghz-wireless-solutions/packet-sniffer-usb-dongle-development-board-for-kinetis-kw0x:USB-KW019032"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sniffer page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the NXP website. </font></font><br><img src="https://habrastorage.org/getpro/geektimes/post_images/ef1/108/1c9/ef11081c9b38097c1b2fdcd91cb01094.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sniffer was developed by NXP (or rather the former Freescale) and can be purchased inexpensively at popular on-line stores of radio components: Mouser, Digi-Key, Farnell ... It is offered by NXP as a tool for monitoring radio packets sent by BLE devices. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using this device, you can study the structure of packets, record them in a log, and analyze traffic density. The sniffer scheme is open for study, but the microcontroller program is supplied as a binary file. Sniffer allows you to filter packets by address value.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PC software can be downloaded to the sniffer by the following search request at </font></font><a href="http://www.nxp.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.nxp.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinetis_Protocol_Analyzer_Adapter.exe.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Since the sniffer besides the main function can also be a debugging platform for different applications, it contains binary files of the base firmware, with which You can restore the functionality of the sniffer after experiments. The files come with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KW40Z Connectivity Software</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">, which is downloaded from the site </font></font><a href="http://www.nxp.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.nxp.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the search query KW40Z_Connectivity_Software. The files will be called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sniffer_processing_core_usbkw40z_k22f.bin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (for the MK22FN512 microcontroller on the sniffer board) and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sniffer_radio_core_usbkw40z_kw40z.bin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for the MKW40Z microcontroller on the sniffer board). Files are programmed using SWD debuggers: JLink, STLink, OpenSDA ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the PC side, the device is perceived as a composite USB device with one COM port and one debugging port according to the specification, OpenSDA with CMSIS-DAP firmware. Thus, in the IAR environment, it is possible to freely program and debug a sniffer's MKW40Z chip using its other MK22FN512 chip as a carrier of debug adapter functionality. But both chips on the board have standard SWD connectors for an external debug adapter.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sniffer does not guarantee reception of all packets transmitted over the air. It is easy to flood it, after which it ceases to accept any packets, so it is recommended to enable filtering at the address in order to receive only packets from the node of interest with a rather rare traffic. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below is a packet sniffer window. The window includes interception on all three channels:</font></font><br><br> <a href=""><img align="left" width="746" src="https://habrastorage.org/getpro/geektimes/post_images/900/756/ae8/900756ae87aa2a06256d83774460fbd5.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When installing the analyzer software on a PC, it creates a virtual Ethernet adapter that converts packets captured through the virtual COM port of the sniffer into an Ethernet packet view. </font><font style="vertical-align: inherit;">In my case, such a virtual adapter automatically got a simple name - Ethernet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To see the packets, you also need to install the Wireshark Ethernet packet sniffer program. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View of the main window of the Wireshark program while monitoring traffic. </font><font style="vertical-align: inherit;">Wireshark describes in detail all the bit fields of the Low Layer Link Layer Protocol (LE LL) packets, however, after the connection between devices is established and the L2CAP protocol starts working, the contents of the packets are not recognized because it is transmitted encrypted.</font></font><br><br> <a href=""><img align="left" width="736" src="https://habrastorage.org/getpro/geektimes/post_images/762/d12/cde/762d12cdec62b23d94b1f5e254d19c4f.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View of the Wireshark program window with decryption of the announcement package</font></font></b> <div class="spoiler_text"> <a href=""><img align="left" width="745" src="https://habrastorage.org/getpro/geektimes/post_images/37a/bbd/8ba/37abbd8ba6306e22b6c2dbd50e92f3c2.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scan Request Package Contents</font></font></b> <div class="spoiler_text"> <a href=""><img align="left" width="740" src="https://habrastorage.org/getpro/geektimes/post_images/5d7/4fb/fd5/5d74fbfd589f42c9ebaed86c0bef7f3a.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scan Responce Package Contents</font></font></b> <div class="spoiler_text"> <a href=""><img align="left" width="741" src="https://habrastorage.org/getpro/geektimes/post_images/012/627/201/012627201de64dfc530926aa9241c20c.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The contents of the package Connection Request with the parameters that determine the speed of the communication channel</font></font></b> <div class="spoiler_text"> <a href=""><img align="left" width="755" src="https://habrastorage.org/getpro/geektimes/post_images/7a8/032/eeb/7a8032eeb21f6834f6f9bfc19d6bfd8e.png"><br clear="left"></a>  <a href=""><em>(Click to enlarge)</em></a> <br><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sequence of packets when establishing a connection</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/geektimes/post_images/7e7/baf/5c9/7e7baf5c91ecdc461aa878c8148a6d48.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comments, additions, corrections and objections to the information in this article are welcome. </font></font></div><p>Source: <a href="https://habr.com/ru/post/394757/">https://habr.com/ru/post/394757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../394747/index.html">AlphaGo to play go with Chinese champion Ke Jie</a></li>
<li><a href="../394749/index.html">A critical hole in the heart of cellular networks</a></li>
<li><a href="../394751/index.html">Production of speaker cases: Overview of materials</a></li>
<li><a href="../394753/index.html">Games for programmers</a></li>
<li><a href="../394755/index.html">Knowledge of physics helps beat casino roulette</a></li>
<li><a href="../394759/index.html">How the US Department of Defense protects the ears of soldiers</a></li>
<li><a href="../394761/index.html">The ‚ÄúMorecard‚Äù wireless adapter the size of a credit card will allow the iPhone to remain in the networks of two operators simultaneously</a></li>
<li><a href="../394763/index.html">Tesla Gigafabrika opens July 29</a></li>
<li><a href="../394765/index.html">A criminal case was filed against a resident of Bratsk for buying a voice recorder in a Chinese online store</a></li>
<li><a href="../394767/index.html">Messengers "eat up" telecom operators, they are preparing a retaliatory strike</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>