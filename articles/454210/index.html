<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forgotten enchantjs + new 1C-Bitrix = Game for customer motivation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Promotions in online stores are different, but how to make them visually interesting for a client is always a question, we tried to turn a common stoc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forgotten enchantjs + new 1C-Bitrix = Game for customer motivation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/94/gi/n_/94gin_i6my8nbvx-zqugqrjelce.png" alt="image"><br><br>  Promotions in online stores are different, but how to make them visually interesting for a client is always a question, we tried to turn a common stock in which there are regular client statistics into a game in Dendy styles. <br><a name="habracut"></a><br>  <i>Here we will talk about how marketing ideas on customer motivation can be visualized in a small browser game.</i> <br><br><h3>  Stage 1. From idea to understanding what is needed </h3><br>  One fine day (before the beginning of the summer), in the marketing department, the idea of ‚Äã‚Äãorganizing a motivating action for the wholesale distribution of customers matured.  From the initial data, as usual, we had the following: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Some customer id </li><li>  Customer records <br><ul><li>  What is the total amount the client purchased for a certain period of time </li><li>  What brands were purchased by the client during this period </li><li>  How ‚Äúhonestly‚Äù and responsibly the client fulfills his obligations to us as to the suppliers of products. </li><li>  What are the ‚Äúspecial‚Äù pricing conditions the client has on the basis of his work with us </li></ul></li><li>  Some set of motivation tools <br><ul><li>  A list of ‚Äúgifts‚Äù that we can offer to the client for his cooperation and performance </li><li>  ‚ÄúImprovers‚Äù of his current price offers </li><li>  Some ‚ÄúSuper Prize‚Äù to the most ... most ... most responsible and active client. </li></ul><br></li><li>  The point of concentration of customers is a personal account with an online ordering system, where we can offer something and report something important. </li><li>  Accounting program (‚ÄúYellow‚Äù) - where there is general information on each customer identifier and its indicators. </li></ol><br>  With such a data set it would be possible to organize on the go in your personal account: <br><br><ol><li>  Banner + ‚ÄúBuy this and get this‚Äù </li><li>  Or a table with client parameters, where once a day you can upload data from the accounting program </li><li>  Since the site is on 1C-Bitrix, you can make complex ‚ÄúBasket rules‚Äù to apply some discounts, subject to certain conditions, depending on the client ID, or make your logic within the API with some statistics output. </li></ol><br>  All this we have done and are doing to inform customers.  But in this case, I wanted to try something else - to create a game - where the indicators will be visualized into abstract values. <br><br><h3>  Stage 2. So, we make the game and now the TK will sound like this </h3><br>  Our theme is spare parts and for the most part - wholesale auto parts, so the following structure of game logic was determined: <br><br><ol><li>  In the center of attention - the track on which the car should move </li><li>  The track starts somewhere and ends (start and finish), that is, the track has a predetermined length in km. </li><li>  Start is the starting point of the indicator - ‚Äúthe distance traveled‚Äù </li><li>  The finish is the end point by which we can give the client a special privilege or a very valuable prize. </li><li>  There should be stopping points on the track (this can be an obstacle, a stop for making a decision). </li><li>  The decision point (checkpoint) - should give the client a ‚Äúbun‚Äù and return to the start or rejection of the ‚Äúbun‚Äù and move on. </li><li>  Obstacle - must change some indicators. </li><li>  Fuel will be used to drive the car. </li><li>  Fuel is an abstraction, the liters of which are received by the client for compliance with the terms of sales + for completing the task / quests. </li><li>  Fuel consumption per 100 km.  the car is also an abstraction which depends on the indicators of the ‚Äúhonesty‚Äù and ‚Äúresponsibility‚Äù of the client, while respecting their obligations to us as suppliers. </li><li>  Fuel consumption should be in some gradation and within reasonable limits. </li></ol><br>  With the help of the ‚Äúgreat and mighty‚Äù it turned out to be a big task to divide it into small subtasks and come to an understanding of the choice of implementation tool.  In order not to create a ‚Äútwo-wheeled‚Äù for the organization of the mechanics of the movement of the car, the choice was made to use the JavaScript framework. <br><br>  The requirements for the game framework, which we have defined for ourselves, are the following: <br><br><ol><li>  2D map </li><li>  Sprite overlay on the map </li><li>  Event model </li><li>  "Fast start" </li><li>  Documentation </li></ol><br>  A total of 3-5 well-known solutions were reviewed and tested (including the little-known PointJS).  All that was considered were really great engines for creating games, but something easy was needed and enchantjs was chosen. <br><br>  Enchantjs is a simple engine with the necessary set of tools for creating a simple 2D game. <br><br><h3>  Stage 3. Technical design </h3><br>  After playing with Enchantjs, it's time to sketch out a small structure of the application. <br><br>  <i>- Tables and data you need to save (talking about MySQL)</i> <br><br><ol><li>  Summary table of current player data (data that affect the current parameters of the game).  Partially this table is modified during the game, partly from the accounting program. </li><li>  Changes liters of gasoline.  These are the abstractions that the client can fill in his virtual car.  This data should come only from the accounting program. <br></li><li>  The history of mileage change.  To where the client got in his car, where he ran out of gas, where he took the checkpoint. </li><li>  Changes in fuel consumption.  For example, today the client consumes a car 9 liters.  100km, and tomorrow there were comments to the client and his car increased consumption to 11 liters.  100 km. </li><li>  Information block in 1C-Bitrix, where marketing experts will enter tasks for customers. (Do it ... then ... here it is ..., confirm with a photo or a link and you will get candy or reduced consumption) </li><li>  Table with completed tasks of clients. </li><li>  Checkpoint table. (Required for drawing sprites with checkboxes on the game map) </li><li>  A table of gifts that we can provide to the customer at the checkpoint. </li><li>  A table of collected checkpoints.  (the client reached the checkpoint, chose a gift and we wrote it down) </li><li>  History of consumption / arrival of liters of gasoline.  Ie when driving there is an expense, when refueling the cans - there is the arrival of fuel.  These data are needed to inform the client. </li></ol><br>  <i>- Component 1C - Bitrix</i> <br><ol><li>  Common component template </li><li>  Processing user requests during the game </li><li>  Handling of events occurring on the field of the game </li><li>  Processing actions performed by the user in the game control interface </li></ol><br>  <i>- Module 1C - Bitrix</i> <br><ol><li>  ORM of all required tables </li><li>  Some service operations </li><li>  Agents </li></ol><br>  <i>- API for exchange with the accounting program</i> <br>  Processing requests for data about the game by the accounting program. <br>  Processing requests for the provision of data on players accounting program. <br><br><h3>  Stage 4. Realization of the game scene </h3><br>  In the implementation I will give an example of only that with regards to enchantjs and scenes with the game. <br><br>  First we need to create a scene and create a map for the game. <br><br>  The map is constructed from an array of arrays, where each nested array characterizes the cell number from the original sprite of the map material. <br><br>  <i>Parts of the map that will be used in building the game scene</i> <br><br><div class="spoiler">  <b class="spoiler_title">Sprite map source</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fw/pw/8l/fwpw8lj2a1iyw8rren9qk3a_ahm.gif" alt="image"><br></div></div><br><pre><code class="javascript hljs">enchant();<span class="hljs-comment"><span class="hljs-comment">//   var game = new Game(800,700);//     800   700 game.fps = 28; //   game.scale = 1; //  // (, ) game.preload('red_car.gif'); game.preload('airport.gif'); game.preload('flag.gif'); //  game.onload = function() { var scene=new SceneGame();//   game.pushScene(scene); }; game.start();</span></span></code> </pre> <br>  Got the basic syntax for creating a scene with the game and running the game. <br><br>  The bottom line is that we on the HTML page draw a rectangle on which we will be manipulating sprites. <br><br>  <i>Immediately I would like to say that when implementing the game, I had to abandon the enchant event model and the concept that all actions take place as part of the scene change under the influence of the fps value.</i> <br><br>  We define the main scene of the game, draw the map, set the flags and set the machine to the start. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** *     * @type {Scene} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SceneGame=Class.create(Scene,{ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span>:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ Scene.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); game = Game.instance; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> label=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Label(<span class="hljs-string"><span class="hljs-string">'   '</span></span>);<span class="hljs-comment"><span class="hljs-comment">//    var map = new Map(32,32);//  map.gif    1-   var car =new Car();//   var points_list=[]; //      //             for(var point_km in app_user.check_point){ var flag_position=curent_odometr_to_coordinat(point_km);//  ,      x  y -      . var red_flag=new Redflag();//  1-   red_flag.x=flag_position.x;// 1-   x red_flag.y=flag_position.y;// 1-   y red_flag.rotation=0;//     points_list.push(red_flag); delete red_flag; } this.red_flag=red_flag; this.car=car; map.image = game.assets['map.gif'];//    //  ,      map.gif var baseMap = [ [24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24], [ 4, 1, 1, 1, 5, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 4, 1, 1, 1, 1, 5, 24, 24, 24, 24], [12, 24, 24, 24, 0, 24, 51, 47, 5, 24, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24, 12, 24, 24, 24, 24], [12, 24, 24, 24, 0, 24, 24, 24, 0, 24, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24, 12, 24, 24, 24, 24], [12, 24, 24, 24, 0, 24, 24, 25, 0, 24, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24, 12, 24, 24, 24, 24], [12, 24, 24, 24, 0, 24, 24, 25, 0, 24, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24, 12, 24, 24, 24, 24], [12, 24, 24, 24, 0, 24, 24, 25, 24, 24, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 8, 1, 1, 1, 5, 47, 22, 44, 4, 1, 1, 1, 5, 0, 24, 24, 24, 24, 11, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 0, 24, 24, 24, 0, 0, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 0, 24, 24, 24, 0, 0, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 24, 0, 24, 24, 24, 0, 24, 24, 24, 0, 0, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 24, 8, 1, 1, 1, 9, 24, 24, 24, 12, 0, 24, 24, 24, 24, 8, 1, 1, 1, 8], [12, 24, 24, 24, 24, 24, 24, 4, 9, 57, 57, 24, 24, 24, 12, 24, 12, 8, 1, 1, 1, 1, 5, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 0, 49, 24, 24, 24, 24, 24, 12, 24, 12, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 0, 59, 50, 50, 50, 24, 24, 12, 24, 12, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 8, 1, 1, 1, 1, 5, 24, 12, 24, 12, 24, 24, 24, 24, 24, 0, 24, 24, 24, 24], [12, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 8, 1, 9, 24, 12, 51, 51, 51, 51, 24, 0, 24, 24, 24, 24], [11, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 8, 1, 1, 1, 1, 1, 9, 24, 24, 24, 24] ]; } map.loadData(baseMap); this.addChild(map);//    this.addChild(car); for(var index_flag in points_list){//   -  this.addChild(points_list[index_flag]); } });</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Map image</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/uh/bz/jd/uhbzjdidbx9olxxnldmrapwqfey.png" alt="image"><br></div></div><br>  As a result, we get a scene with a map on which there is a road.  In the screenshot, the flags are not indicated and the vehicle is not installed at the start (lower left corner). <br><br>  Each object in the sprite enchantjs at least constantly contains information about the position in the coordinate system, the angle of rotation of the sprite. <br><br><div class="spoiler">  <b class="spoiler_title">Outline map</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/da/s6/59das69okndmoy8rjmebvoueiam.png" alt="image"><br></div></div><br>  Those.  to implement the movement of the car on the drawn map, it took: <br><br><ol><li>  Describe his actions in space when the track bends. </li><li>  Describe the actions of the car and the direction of movement depending on the angle of rotation of the sprite. </li></ol><br>  Ie if we have a rotation angle of 0 and since our car sprite starts from the bottom up, then we move to the zero point of the coordinate point on the Y axis. Then we meet the bend of route 1 and we must rotate the car sprite by 90 degrees.  Further, knowing that we are located at an angle of 90 degrees - we move along the X axis until the bend of the route No. 2, etc. <br><br>  So we taught the car to move along the drawn coordinate system. <br><br>  In order to bring the interaction of the car with the road to our usual values ‚Äã‚Äã- at a distance of km traveled, it was necessary to write an additional function that takes the number of kilometers.  0 to 3000 and returns the coordinates of a point on the road. <br><br>  To move the car, we used <i>setInterval</i> which increases the values ‚Äã‚Äãof x or y while the car is moving. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  var start=setInterval(function(){ var position=car.getElementMap(car.x,car.y); position.map_num=map.checkTile(car.x,car.y); var move_result=car.move_car(position); //      var fuel_one_km=fuel_consumption(app_user.fuel_road);//  1 app_storage.fuel -=fuel_one_km; app_storage.fuel=parseFloat((app_storage.fuel).toFixed(2)); if(app_storage.fuel&lt;=0){ //   clearInterval(start); console.log(' !'); //   ,       } var check_point_km=check_car_checkpoint(app_storage.km) //  if(typeof check_point_km.point_km!=='undefined') { console.log('!'); //   ,       } if(position.car_x&gt;780) { clearInterval(start); } },app_conf().game.move_car_fps);</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Map, typewriter, flags</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/iv/as/zy/ivaszyohi8xa38b80k9vz676wiu.png" alt="image"><br></div></div><br>  During the movement, on the game scene the following events occur: <br><br><ol><li>  Hitting the flags </li><li>  End of fuel </li><li>  Reaching the finish </li></ol><br>  Upon reaching these events, events are created that are processed in the control script of the 1C-Bitrix component. <br><br><h3>  Next ... next </h3><br>  The following steps to complete the gaming system were: <br><br><ol><li>  Creating an interface with control buttons </li><li>  Reaction to events on the field with the game </li><li>  Changes of game parameters depending on user actions </li><li>  Check car parameters on the back end </li></ol><br>  The result was this game in LK <br><br><div class="spoiler">  <b class="spoiler_title">Screen lk</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bv/j3/tw/bvj3twfbzm2kfrzu1ol3h8quo2o.png" alt="image"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">And some video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/FfRk1mDhheU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/454210/">https://habr.com/ru/post/454210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454198/index.html">Creation of multi-module Gradle project SpringBoot + Angular in IDEA</a></li>
<li><a href="../4542/index.html">Seven Tips for Choosing a Name for a Web 2.0 Startup</a></li>
<li><a href="../454204/index.html">Behavioral crawling - not a panacea?</a></li>
<li><a href="../454206/index.html">PHDays 9: AI CTF Parsing</a></li>
<li><a href="../454208/index.html">RISC-V from scratch</a></li>
<li><a href="../454214/index.html">I hate almost all software.</a></li>
<li><a href="../454216/index.html">Found evidence that all changes are a mixture of order and chance</a></li>
<li><a href="../454220/index.html">Two-digit thermometer</a></li>
<li><a href="../454222/index.html">Upgrade the disk subsystem of the old server with a PCIe 1.0 bus - 2.0</a></li>
<li><a href="../454224/index.html">Recommendations in Okko: how to earn hundreds of millions by multiplying a couple of matrices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>