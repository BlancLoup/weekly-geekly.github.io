<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploying the site to Django using FastCGI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From translator 
 I read this article on Django Advent, Django 1.2, timed to coincide with the imminent release, and it seemed so interesting to me th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploying the site to Django using FastCGI</h1><div class="post__text post__text-html js-mediator-article"><h4>  From translator </h4><br>  I read this article on <a href="http://djangoadvent.com/1.2/deploying-django-site-using-fastcgi/">Django Advent,</a> <a href="http://docs.djangoproject.com/en/dev/releases/1.2/">Django 1.2,</a> timed to coincide with the imminent release, and it seemed so interesting to me that I decided to translate it.  Further, the text of the article. <br><br>  When you develop a site on Django, it is so easy to just open the console and type: <br><br> <code>python manage.py runserver</code> <br> <br>  With this simple command to manage your media files, admin site is supported correctly, PYTHONPATH is properly configured and includes the root folder of our project, and an automatically restarting web server is running on the port we specified (from the translator: port 8000 by default).  So simple! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is not surprising that people are so disappointed when it comes time to put their website on the battle server: there are so many steps in this process and therefore it‚Äôs difficult to learn all of them and make everything right.  Not surprisingly, all this complexity leads to the fact that many articles have been written about the deployment of the Django website.  But almost all of these articles focus on deploying the site using Apache and <a href="http://code.google.com/p/modwsgi/">mod_wsgi</a> or <a href="http://www.modpython.org/">mod_python</a> . <br><br>  However, sometimes Apache is not the perfect solution.  Maybe your <a href="http://en.wikipedia.org/wiki/Virtual_private_server">VPS</a> has only 256 MB of memory, and maybe you want to avoid the complexity of configuring Apache during installation.  Or maybe you just do not like Apache.  For any of these reasons, we can turn our attention to <a href="http://www.fastcgi.com/drupal/">FastCGI</a> . <br><a name="habracut"></a><br><br><h4>  First of all </h4><br>  Before we begin our deployment, we need to make sure that the foundation of our system is established.  First, we need a server on which we deploy our application.  It can be any server and operating system, but for the sake of simplicity, we assume that it is Ubuntu Linux. <br>  Let's install the base system, including some compilers, python header files and <a href="http://pypi.python.org/pypi/setuptools">setuptools</a> <br><br> <code>sudo apt-get install build-essential python-dev python-setuptools</code> <br> <br>  We also put <a href="http://nginx.org/">Nginx</a> as our web server.  This can be done like this: <br><br> <code>sudo apt-get install nginx</code> <br> <br>  You should also put <a href="http://cr.yp.to/daemontools.html">daemontools</a> - a collection of tools for managing services.  We will use them to make sure that our services will remain running (or at least come back to life) even in the event of an error or a restart of the server.  To install daemontools type: <br><br> <code>sudo apt-get install daemontools</code> <br> <br>  Unfortunately, the daemontools package requires our little extra work to automatically restart on reboot.  First, create the file <code>/etc/event.d/svscanboot</code> with the following contents: <br><br> <code>start on runlevel 2 <br> start on runlevel 3 <br> start on runlevel 4 <br> start on runlevel 5 <br> stop on runlevel 0 <br> stop on runlevel 1 <br> stop on runlevel 6 <br> respawn <br> exec /usr/bin/svscanboot</code> <br> <br>  Then create the <code>/etc/service</code> folder by running the following command: <br><br> <code>sudo mkdir /etc/service</code> <br> <br>  <code>daemontools</code> , run <code>daemontools</code> by running this command: <br><br> <code>sudo initctl start svscanboot</code> <br> <br>  Let's create a new user for our site: <br><br> <code>adduser mysite</code> <br> <br>  If we want to use the sudo command with our user, then we also need to edit <code>/etc/sudoers</code> .  Find the <code>root ALL=(ALL) ALL</code> line <code>root ALL=(ALL) ALL</code> in this file and add below it: <br><br> <code>mysite ALL=(ALL) ALL</code> <br> <br>  Now we can switch to our user: <br><br> <code>su - mysite</code> <br> <br>  So, the basis of our system is ready.  We deliberately do not talk about the database, mail servers, version control systems, memcached and other various services, because they can vary greatly depending on personal preferences. <br><br><h4>  Setting up our virtual environment for Python </h4><br>  Now that the foundation of our system is established, we can focus on interesting things.  First, we are going to put virtualenv - a tool for creating an isolated environment for Python.  We will use <a href="http://pypi.python.org/pypi/virtualenv">virtualenv</a> to create an isolated environment for our application. <br><br> <code>sudo easy_install virtualenv</code> <br> <br>  With our fresh copy of virtualdev, we can go ahead and set up a new virtual environment: <br><br> <code>mkdir ~/virtualenvs <br> virtualenv ~/virtualenvs/mysite</code> <br> <br>  We created a virtualenvs directory in our home folder and inside it we created a virtual environment called mysite.  Now let's start using it and install <a href="http://pypi.python.org/pypi/pip">pip</a> to easily install Python packages: <br><br> <code>source ~/virtualenvs/mysite/bin/activate <br> easy_install pip</code> <br> <br>  Now we need to make sure that we have the <a href="http://trac.saddi.com/flup">Flup</a> package <a href="http://trac.saddi.com/flup">installed</a> .  This is a set of useful tools for working with WCGI applications, including an adapter to turn a WSGI application into FastCGI (both SCGI and AJP ... but this is beyond the scope of this article).  Django requires Flup to be installed before you can use the runfcg control command.  Using pip we can easily install it: <br><br> <code>pip install flup</code> <br> <br>  If we want to use database adapters, graphic libraries or xml parsers installed along the Python system path, we need to make sure that they are accessible from our virtual environment.  To do this, we add the .pth file to the site-packages virtual environment directory: <br><br> <code>echo "/usr/lib/python2.6/dist-packages/" &gt; ~/virtualenvs/mysite/lib/python2.6/site-packages/fix.pth</code> <br> <br>  The next step is to clone the Django code on our server (obviously, <code>git</code> can be replaced with <code>mercurial, svn</code> or even <code>rsync</code> ): <br><br> <code><a href=""></a> git clone github.com/myusername/mysite.git</code> <br> <br>  If your project has a <a href="http://pip.openplans.org/requirement-format.html">pip requirements</a> file, you can now use it: <br><br> <code>pip install -U -r mysite/requirements.txt</code> <br> <br>  Or, if you do not have the <code>requirements file</code> , you can install the dependencies manually.  For example: <br><br> <code>pip install -U Django simplejson python-memcached</code> <br> <br><h4>  Choosing options for our FastCGI server </h4><br>  Wow  We have come a long way in setting up our system and have not even told us about the FastCGI part yet.  Do not worry, we are ready to do it now.  Let's decide what options we want when we run our FastCGI server. <br><br>  The first choice that needs to be made is which parallelization method we want to use: <br><ul><li>  threaded: <br>  Execution of streaming server in one process for all HTTP requests.  This saves a lot of memory, but all threads run into the problem of one <a href="http://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock</a> (GIL).  This means that performance may be limited by processor-intensive processing.  Note that I / O operations occur outside of the GIL, so intensive loading with I / O operations does not rest on the GIL problem.  Also, some python extensions were not supposed to be thread safe, which means that they cannot be used with this contention method. <br></li><li>  prefork: <br>  Execution of a branching server of a process generating a pool, each with its own copy of a jung and a python loaded into memory.  This means that more memory will be used, but there are no aforementioned problems with GIL or thread-safety. </li></ul><br>  Let's assume that we are interested in FastCGI, because we have a server with a small memory size.  Since the prefork method will use more memory, we will therefore choose the threaded method. <br><br>  Now we will select several options that tell the server how to act under load: <br><ul><li>  minspare: <br>  What is the minimum number of processes / threads the server will support ready and waiting for future requests? <br></li><li>  maxspare: <br>  What is the maximum number of processes / threads the server will support ready and waiting for future requests? <br></li><li>  maxrequests (only for prefork method): <br>  How many requests each process will serve before it is killed and restarted.  To prevent memory leaks, until it becomes a problem.  It is a good idea to set this option. <br></li><li>  maxchildren (only for prefork method): <br>  How many child processes can support queries at any given time? </li></ul><br>  Our server runs on a small VPS with 265 MB of memory, so we will choose very modest settings: 2 for <br>  <code>minspare</code> , 4 for <code>maxspare</code> , 6 for <code>maxchildren</code> and 500 for <code>maxrequests</code> . <br><br>  At the end we choose our last few settings: <br><ul><li>  host <br>  Host name (hostname), which will listen to incoming connections? <br></li><li>  port <br>  On which port to listen to incoming connections? <br></li><li>  pidfile <br>  When the FastCGI server starts, it creates a file with its process ID.  This process ID is the <a href="http://en.wikipedia.org/wiki/Process_identifier">pid of the</a> main thread / process.  This is a process that will support OS signals, such as <a href="http://en.wikipedia.org/wiki/SIGHUP">SIGHUP</a> .  This option determines the location of this file. </li></ul><br>  After we have made our choices, we can start the server by running the <code>runfcgi</code> command: <br><br> <code>python manage.py runfcgi method=threaded host=127.0.0.1 port=8080 pidfile=mysite.pid minspare=4 maxspare=30 daemonize=false</code> <br> <br>  Notice that we added the <code>daemonize=false</code> flag <code>daemonize=false</code> .  It should always be installed (according to the author, skipping this option is a miscalculation in the runfcgi command).  Also note that the result of running this command will create a <code>mysite.pid</code> file in our project directory, so it's a good idea to make sure that your version control system ignores this file. <br><br>  Now that we have verified that our FastCGI server is running correctly, let's stop it and proceed to the next step: use <code>daemontools</code> to run this command and keep the server running all the time in the background. <br><br><h4>  Daemontools runs our fastcgi server </h4><br>  Daemontools will look in all the subdirectories in the / etc / service directory and in each of them it will look for an executable file called run.  If he finds such a file, he launches it and restarts it if he dies.  So let's create a mysite directory: <br><br> <code>sudo mkdir /etc/service/mysite</code> <br> <br>  Now, let's make a small script that runs our fastcgi server.  Use your favorite text editor to write this text in <code>/etc/service/mysite/run</code> : <br><br> <code>#!/usr/bin/env bash <br> <br> source /home/mysite/virtualenvs/mysite/bin/activate <br> cd /home/mysite/mysite <br> exec envuidgid mysite python manage.py runfcgi method=threaded host=127.0.0.1 port=8080 pidfile=mysite.pid minspare=4 maxspare=30 daemonize=false</code> <br> <br>  There is nothing tricky here.  First we check that we are in the right virtual environment (virtualenv), then we change the current directory to <code>mysite</code> and then we run the <code>runfcgi</code> command, which we discussed earlier.  <code>envuidgid mysite</code> just makes sure that the following command is executed under the <code>mysite</code> user, instead of <code>root</code> . <br><br>  The script must be executable for daemontools to recognize it, so let's execute the following command: <br><br> <code>sudo chmod +x /etc/service/mysite/run</code> <br> <br>  Now we can verify that it is executed using the <code>svstat</code> command: <br><br> <code>sudo svstat /etc/service/mysite/</code> <br> <br>  The result should look something like this: <br><br> <code>/etc/service/mysite/: up (pid 3610) 33 seconds</code> <br> <br>  This means that the process is up, it is assigned a process id = 3610 and it worked for 33 seconds.  You can use the <code>svc</code> command to stop the process: <br><br> <code>sudo svc -d /etc/service/mysite/</code> <br> <br>  Then, if you run svstat again, you will get something like this: <br><br> <code>/etc/service/mysite/: down 4 seconds, normally up</code> <br> <br>  To bring the process back, simply run: <br><br> <code>sudo svc -u /etc/service/mysite/</code> <br> <br>  A full list of svc commands can be found <a href="http://cr.yp.to/daemontools/svc.html">online</a> - this is a very good source if you are going to dive deeper into <code>daemontools</code> . <br><br><h4>  Configuring Nginx to work with our server </h4><br>  We are close to the finish line.  All we have to do is configure nginx to talk with our FastCGI server, get answers from it and send them to the user. <br><br>  Ubuntu comes with a useful <code>/etc/nginx/fastcgi_params</code> file.  Unfortunately, it is not quite correct.  It encodes the <code>SCRIPT_NAME</code> parameter, but what our server really wants is <code>PATH_INFO</code> .  You can search and replace or copy the contents below into the <code>/etc/nginx/fastcgi_params</code> file: <br><br> <code>fastcgi_param QUERY_STRING $query_string; <br> fastcgi_param REQUEST_METHOD $request_method; <br> fastcgi_param CONTENT_TYPE $content_type; <br> fastcgi_param CONTENT_LENGTH $content_length; <br> <br> fastcgi_param PATH_INFO $fastcgi_script_name; <br> fastcgi_param REQUEST_URI $request_uri; <br> fastcgi_param DOCUMENT_URI $document_uri; <br> fastcgi_param DOCUMENT_ROOT $document_root; <br> fastcgi_param SERVER_PROTOCOL $server_protocol; <br> <br> fastcgi_param GATEWAY_INTERFACE CGI/1.1; <br> fastcgi_param SERVER_SOFTWARE nginx/$nginx_version; <br> <br> fastcgi_param REMOTE_ADDR $remote_addr; <br> fastcgi_param REMOTE_PORT $remote_port; <br> fastcgi_param SERVER_ADDR $server_addr; <br> fastcgi_param SERVER_PORT $server_port; <br> fastcgi_param SERVER_NAME $server_name;</code> <br> <br>  Now we will create a definition for our site.  Using a text editor, let's create the file <code>/etc/nginx/sites-available/mysite</code> with the following content: <br><br> <code><a href=""></a> server { <br> listen 80; <br> server_name mysite.com www.mysite.com; <br> access_log /var/log/nginx/mysite.access.log; <br> <br> location /media { <br> autoindex on; <br> index index.html; <br> root /home/mysite/mysite; <br> break; <br> } <br> location / { <br> include /etc/nginx/fastcgi_params; <br> fastcgi_pass 127.0.0.1:8080; <br> break; <br> } <br> }</code> <br> <br>  He says listen to port 80 (standard for HTTP) for <code><a href="http://mysite.com/"></a> mysite.com  http://www.mysite.com/</code>  <code><a href="http://mysite.com/"></a> mysite.com  http://www.mysite.com/</code> .  Requests for / media should be processed immediately from disk in the <code>/home/mysite/mysite/media</code> directory.  And the most important: all other requests will be transmitted via FastCGI to our server. <br><br>  Now let's connect it via symlink: <br><br> <code>sudo ln -s /etc/nginx/sites-available/mysite /etc/nginx/sites-enabled/mysite</code> <br> <br>  Finally, restart nginx for the new settings to take effect: <br><br> <code>sudo /etc/init.d/nginx restart</code> <br> <br><h4>  Conclusion </h4><br>  We set up a minimal server using nginx to serve media files at unbelievable speed and a clean Python FastCGI server to serve dynamic requests without any intermediate layers between them.  Using daemontools we have full control over the FastCGI process and can stop it, restart or change its settings at any time. <br><br>  A really interesting thing - just a few small <a href="http://github.com/benoitc/gunicorn">tweaks</a> are <a href="http://pypi.python.org/pypi/Spawning">enough</a> , and the same stack could be used for <a href="http://github.com/benoitc/gunicorn">gunicorn</a> , <a href="http://pypi.python.org/pypi/Spawning">spawning</a> , or <a href="httpserver">paste</a> solutions.  Instead of using fastcgi_pass, we could use proxy_pass.  We could still use daemontools to keep our process running and in control.  Almost every step of this article will remain the same. <br>  This is a very viable alternative to the often imposed stack from Apache / mod_wsgi, and I hope after reading this article more people will see it as a method of deploying your site to django. <br><br><h4>  About the author of the article </h4><br>  Eric Florenzano is a software developer.  He currently lives in San Francisco and works for Mochi Media.  At the moment he has been participating in the Django and Pinax community for several years.  He is currently co-founder of Django Dose, podcasts about everything related to Django.  From time to time he blogs at <a href="http://www.eflorenzano.com/">www.eflorenzano.com</a> about python, non-relational databases and other interesting topics. </div><p>Source: <a href="https://habr.com/ru/post/85851/">https://habr.com/ru/post/85851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../85839/index.html">Admin and Nagios</a></li>
<li><a href="../85840/index.html">Worldwide Wikipedia Map</a></li>
<li><a href="../85842/index.html">Found German uranium 1943</a></li>
<li><a href="../85844/index.html">Starcraft 2 can be played with AI on several special cards and on different difficulty levels.</a></li>
<li><a href="../85849/index.html">Nvidia ION in the face of Acer Aspire Revolution</a></li>
<li><a href="../85852/index.html">Singleton and Late static binding</a></li>
<li><a href="../85853/index.html">√úr√ºn - another look at online shopping</a></li>
<li><a href="../85856/index.html">Databases in MIDP Part 1: The Concept of Record Management System</a></li>
<li><a href="../85858/index.html">Forms in the Zend Framework</a></li>
<li><a href="../85859/index.html">Transcend T.Sonic 330 (8Gb)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>