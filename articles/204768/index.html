<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3D VDI acceleration in practice. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="3D VDI acceleration in practice. 
 Part 1 - vSGA and vDGA 


 The lack of hardware acceleration of graphics is a significant obstacle in the implement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>3D VDI acceleration in practice. Part 1</h1><div class="post__text post__text-html js-mediator-article"><h4>  3D VDI acceleration in practice. </h4><br><h5>  Part 1 - vSGA and vDGA </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/87c/ac6/10d/87cac610d5af9cae11f5f1f945b2e60e.jpg" title="3D VDI acceleration in practice" alt="3D  VDI  "><br><br>  The lack of hardware acceleration of graphics is a significant obstacle in the implementation of virtualization technologies in companies working in the field of design, engineering, design development, etc. Consider what new opportunities appeared with the release of NVIDIA GRID. <br><br>  <b>Virtualization of workplaces (VDI)</b> has already firmly entered our lives, primarily in the corporate market segment, and confidently fights the way to other segments, including in the form of public cloud services ( <a href="http://www.it-grad.ru/uslugi/daas/virtualnye-rabochie-stantsii-vdi/">Desktop as a Service</a> ).  The lack of hardware-accelerated graphics hinders the use of this technology in industries that could appreciate the benefits of using VDI such as remote accessibility, data security, and simplified personnel outsourcing. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first steps to using <b>3D acceleration in VDI</b> were made quite a long time ago and consisted in forwarding PCI devices to virtual machines, which allowed to issue video cards for VDI installed in the server or connected to the server using external PCIe baskets, such as Dell PowerEdge C410x.  The disadvantages of this solution are obvious - increased use of electricity, space in racks and high cost. <br><br><h4>  NVIDIA GRID Technology at a Glance </h4><br>  With the announcement of NVIDIA GRID technology (NVIDIA VGX at the time of the announcement) last year, interest in using 3D accelerated VDI has increased significantly.  The essence of the GRID technology, which is originally designed specifically for <b>3D acceleration in virtual environments</b> , is quite simple and includes the following principles: <br><br><ul><li>  Aggregation based on one PCIe card of several graphic accelerators; </li><li>  The ability to virtualize graphics accelerators at the hypervisor level; </li><li>  The possibility of virtualization of graphics accelerators using GRID Virtual GPU technology. </li></ul><br>  Currently, NVIDIA has released two video cards based on the NVIDIA Keppler architecture - NVIDIA GRID K1 and K2.  The characteristics of these cards are as follows: <br><br><table border="1" cellpadding="1" cellspacing="1"><tbody><tr><td></td><td>  <b>GRID K1</b> </td><td>  <b>GRID K2</b> </td></tr><tr><td>  <b>GPU number</b> </td><td>  4 Kepler entry level GPU </td><td>  2 Kepler high-end GPU </td></tr><tr><td>  <b>CUDA Kernels</b> </td><td>  768 </td><td>  3072 </td></tr><tr><td>  <b>Total memory size</b> </td><td>  16 GB DDR3 </td><td>  8 GB GDDR5 </td></tr><tr><td>  <b>Maximum power</b> </td><td>  130 W </td><td>  225 W </td></tr><tr><td>  <b>Card Length</b> </td><td>  26.7 cm </td><td>  26.7 cm </td></tr><tr><td>  <b>Map Height</b> </td><td>  11.2 cm </td><td>  11.2 cm </td></tr><tr><td>  <b>Map Width</b> </td><td>  Dual slot </td><td>  Dual slot </td></tr><tr><td>  <b>Display</b> <b><br><br></b>  <b>data input / output</b> </td><td>  Not </td><td>  Not </td></tr><tr><td>  <b>Extra power</b> </td><td>  6-pin connector </td><td>  8-pin connector </td></tr><tr><td>  <b>PCIe</b> </td><td>  x16 </td><td>  x16 </td></tr><tr><td>  <b>PCIe generation</b> </td><td>  Gen3 (compatible with Gen2) </td><td>  Gen3 (compatible with Gen2) </td></tr><tr><td>  <b>Cooling</b> </td><td>  Passive </td><td>  Passive </td></tr><tr><td>  <b>Technical specifications</b> </td><td>  <a href="http://www.nvidia.ru/content/grid/pdf/GRID_K1_BD-06633-001_v02.pdf">GRID K1 board specifications</a> </td><td>  <a href="http://www.nvidia.ru/content/grid/pdf/GRID_K2_BD-06580-001_v02.pdf">GRID K2 board specifications</a> </td></tr></tbody></table><br>  In fact, GRID K1 is four QUADRO K600 cards integrated on one PCIe card, GRID K2 cards are two cards of QUADRO K5000 level.  This allows even without using virtualization to significantly increase the density of graphics cards in servers. <br><br>  The inclusion of various vendors in the GRID server platform, ensuring the installation of up to 4 GRID cards in one server eliminates the need to use external PCIe baskets. <br><br>  Software that supports the GRID technology is VMware, Citrix and Microsoft hypervisors, as well as VMware and Citrix <b>workstation virtualization systems</b> (and Microsoft, if we consider the options for server sharing). <br><br><h4>  Description of our test bench </h4><br>  For our test bench, we decided to use the <b>1U SuperMicro 1027GR-TRFT server.</b> <br>  Its main features are: <br><ul><li>  Dual socket R (LGA 2011) supports Intel¬Æ Xeon¬Æ processor E5-2600 and E5-2600 v2 family </li><li>  Up to 512GB ECC DDR3, up to 1866MHz;  8x DIMM sockets </li><li>  3x PCI-E 3.0 x16 slots (support GPU / Xeon Phi cards), 1x PCI-E 3.0 x8 (in x16) low-profile slot </li><li>  Intel¬Æ X540 10GBase-T Controller </li><li>  4x Hot-swap 2.5 "SATA3 Drive Bays </li><li>  1800W Redundant Power Supplies Platinum Level (94% +) </li></ul><br>  This choice was due to the <b>high density (up to 3 GRID video cards</b> in 1U) and the presence of built-in 10GBase-T network interfaces. <br><br>  SATA basket allows you to use <b>inexpensive SSD drives</b> for Host Based data access caching, which is so useful for VDI loads, with characteristic disk activity peaks at the beginning and end of the working day. <br><br>  With the current prices for the memory modules of eight DIMM slots, this is quite enough in a situation where the density of a VM per server is limited by the CPU and GPU resources. <br><br>  In this server, we installed the <b>NVIDIA GRID K1</b> card.  Here is a photo of the server with a video card ready for installation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2c/cc9/bc8/c2ccc9bc84f15ff990011744ebd96daa.jpg" title="We connect NVIDIA GRID K1 to our server" alt=" NVIDIA GRID K1   " width="500" height="375"><br><br>  As a virtualization platform, <b>VMware vSphere</b> familiar to us was chosen.  Looking ahead, I‚Äôll note that in the second part of this article we will have to use <b>Citrix XenServer</b> , because at the moment only he and only in the Tech Preview status supports GRID Virtual GPU technology. <br><br>  The ESXi hypervisor defines a video card as 4 NVIDIAGRID K1 devices connected via a PCI / PCI bridge, which makes accelerators available for separate use as a passthrough device connected to a VM or as the basis for virtualization at the hypervisor level. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ee/dfc/eab/4eedfceab17a1f5b138806eb8b813293.jpg" title="The ESXi hypervisor defines the video card." alt=" ESXi  "><br><br>  The driver from NVIDIA is installed in the hypervisor: <br><br> <code>~ # esxcli software vib list | grep NVIDIA</code> <br> <code>NVIDIA-VMware_ESXi_5.1_Host_Driver 304.76-1OEM.510.0.0.802205 NVIDIA VMwareAccepted 2013-03-26</code> <br> <br>  All devices that are not put into passthrough mode are initialized and loaded by the NVIDIA driver during the boot process: <br><br> <code>2013-10-28T06:12:42.521Z cpu7:9838)Loading module nvidia ...</code> <br> <code>2013-10-28T06:12:42.535Z cpu7:9838)Elf: 1852: module nvidia has license NVIDIA</code> <br> <code>2013-10-28T06:12:42.692Z cpu7:9838)module heap: Initial heap size: 8388608, max heap size: 68476928</code> <br> <code>2013-10-28T06:12:42.692Z cpu7:9838)vmklnx_module_mempool_init: Mempool max 68476928 being used for module: 77</code> <br> <code>2013-10-28T06:12:42.693Z cpu7:9838)vmk_MemPoolCreate passed for 2048 pages</code> <br> <code>2013-10-28T06:12:42.693Z cpu7:9838)module heap: using memType 2</code> <br> <code>2013-10-28T06:12:42.693Z cpu7:9838)module heap vmklnx_nvidia: creation succeeded. id = 0x410037000000</code> <br> <code>2013-10-28T06:12:42.943Z cpu7:9838)PCI: driver nvidia is looking for devices</code> <br> <code>2013-10-28T06:12:42.943Z cpu7:9838)PCI: driver nvidia claimed device 0000:86:00.0</code> <br> <code>2013-10-28T06:12:42.943Z cpu7:9838)PCI: driver nvidia claimed device 0000:87:00.0</code> <br> <code>2013-10-28T06:12:42.943Z cpu7:9838)PCI: driver nvidia claimed 2 devices</code> <br> <code>NVRM: loading NVIDIA UNIX x86_64 Kernel Module 304.76 Sun Jan 13 20:13:01 PST 2013</code> <br> <code>2013-10-28T06:12:42.944Z cpu7:9838)Mod: 4485: Initialization of nvidia succeeded with module ID 77.</code> <br> <code>2013-10-28T06:12:42.944Z cpu7:9838)nvidia loaded successfully.</code> <br>  After loading the hypervisor <br><br>  Citrix XenDesktop 7 is used as a platform for creating a VDI infrastructure, which is currently used in our production infrastructure providing <a href="http://www.it-grad.ru/uslugi/daas/virtualnye-rabochie-stantsii-vdi/">VDI services</a> to our customers.  The test machines use the HXD 3D Pro technology, which provides efficient packaging and forwarding of the rendered GPU image to the client.  <b>The test virtual server</b> has the following configuration: 4vCPU 2GHz, 8GB RAM, 60GB HDD. <br><br><h4>  VSGA testing </h4><br>  vSGA is a VMware technology that provides virtualization of GPU resources installed in servers running the VMware ESXi hypervisor and the subsequent use of GPU data to provide 3D acceleration for virtual video cards issued for a virtual server. <br><br>  The technology has many limitations in terms of performance and functionality of virtual video cards, however, it allows you to maximize the density of virtual machines per GPU. <br><br>  In fact, we managed to start the machines with close to twofold excess of the amount of virtual video memory compared to the amount of physical video memory on the used GPUs. <br><br>  The functionality of the virtual video card is as follows: <br><ul><li>  Supported APIs: DirectX 9, OpenGL 2.1 </li><li>  maximum amount of video memory: 512MB </li><li>  graphics core performance: dynamic, not controlled. </li></ul><br>  In the case of using VMware View, this virtual machine configuration can be done directly from the View management interface, but in our case, to activate hardware acceleration for a virtual video card, you need to perform two actions: <br><ol><li>  enable 3D support </li><li>  set the size of the video memory in the properties of the video card in the editing machine: </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/adc/774/29e/adc77429eeef229b38e41e563884f373.jpg" title="Enable 3D support in VMware View" alt="  3D  VMware View"><br><br>  and add the parameter mks.use3dRenderer = hardware to its parameters: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/49c/ff4/3c5/49cff43c55c43f20bd57994f0f5bf412.jpg" title="Editing parameters in VMware View" alt="   VMware View"><br><br>  In the guest OS, such a virtual video card is defined as ‚ÄúVMware SVGA 3D‚Äù.  It differs from the usual virtual video card only in memory and in support of the hardware acceleration of the above APIs. <br><br>  <b>The results of the FurMark test</b> on such a VDI machine unequivocally say that you will not have to play on it (it should be noted that during testing a physical video card was used by one virtual machine, that is, all the computing resources of the video card, taking into account the virtualization overhead, were available to the test ): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a43/d7b/d99/a43d7bd99cd85d09670697fb3aaf3291.png" title="FurMark test results on a DVI machine" alt="  FurMark  DVI "><br><br>  From the point of view of AutoCad 2014, the capabilities of the video card are as follows: <br><br> <code>Enhanced 3D Performance: Available and on</code> <br> <code>Smooth display: Available and off</code> <br> <code>Gooch shader: Available and using hardware</code> <br> <code>Per-pixel lighting: Available and on</code> <br> <code>Full-shadow display: Available and on</code> <br> <code>Texture compression: Available and off</code> <br> <code>Advanced material effects: Available and on</code> <br> <code>Autodesk driver: Not Certified</code> <br> <code>Effect support:</code> <br> <code>Enhanced 3D Performance: Available</code> <br> <code>Smooth display: Available</code> <br> <code>Gooch shader: Available</code> <br> <code>Per-pixel lighting: Available</code> <br> <code>Full-shadow display: Available</code> <br> <code>Texture compression: Available</code> <br> <code>Advanced material effects: Available</code> <br> <br>  As you can see, formally all the parameters of hardware acceleration are <b>supported by the driver</b> .  It is assumed that we can see support problems only when using heavier products that use, for example, the CUDA architecture. <br><br>  <b>Cadalyst Benchmark test results:</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/164/00a/c6c/16400ac6c5e2f0a8f251ec9bfd8794d1.png" title="Cadalyst Benchmark Test" alt="  Cadalyst Benchmark"><br><br>  The results are not impressive, but you can use this software, and if you do not need great performance and work with complex models - for example, in the classroom, then high density and low cost of such machines may be useful. <br><br><h4>  VDGA testing </h4><br>  vDGA is the name used by VMware to refer to forwarding a physical video card to a virtual machine. <br><br>  In fact, for this technology, NVIDIA GRID gave one single advantage - a <b>high GPU density</b> , which eliminates the use of external PCIe baskets. <br><br>  For example, in the server used on the test bench it is possible to install three NVIDIA GRID K1 video cards, which will give us <b>12 independent QUADRO K600 accelerators</b> .  This allows you to run 12 virtual servers on the server, which allows you to load server capacity, and, depending on the load profile, it also provides GPU resources for resources compared to CPU resources. <br><br>  To forward a video card to a virtual server, you must enable passthrough mode for this PCIe device in the host configuration and add a PCI device to the virtual machine configuration: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/137/901/2ad/1379012adc28b3230178da966ee96e08.jpg" title="Add PCI service to VMware View" alt=" PCI -  VMware View"><br><br>  Also, you need to install a full memory reservation for this virtual machine. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a1/0d7/129/5a10d7129598d9b214081ca1a6575a8c.jpg" title="Installing full memory backup for a virtual machine" alt="      "><br><br>  and set up pci hole.  On this account there are different opinions, we chose values ‚Äã‚Äãfrom 1200 to 2200: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5c/5a1/32c/b5c5a132c3487e0b50bc0e58a4dcf478.jpg" title="Choosing pci hole values ‚Äã‚Äãin VMware View" alt="  pci hole  VMware View"><br><br>  In the guest OS, in this case, the video card seems to be a full-fledged NVIDIA device and requires the installation of drivers for the GRID video card family. <br><br>  <b>The results of FurMark are close to the results</b> obtained in the vSGA test, which indicates the relative effectiveness of the level of virtualization for this test: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/886/ad3/13b/886ad313b1ad4c0160265facac17794e.jpg" title="the result gave a relative level of virtualization efficiency" alt="     "><br><br>  When <b>using AutoCad 2014, the</b> picture is as follows: <br><br> <code>Current Effect Status:</code> <br> <code>Enhanced 3D Performance: Available and on Smooth display: Available and off</code> <br> <code>Gooch shader: Available and using hardware</code> <br> <code>Per-pixel lighting: Available and on</code> <br> <code>Full-shadow display: Available and on</code> <br> <code>Texture compression: Available and off</code> <br> <code>Advanced material effects: Available and on</code> <br> <code>Autodesk driver: Not Certified</code> <br> <code>Effect support:</code> <br> <code>Enhanced 3D Performance: Available</code> <br> <code>Smooth display: Available</code> <br> <code>Gooch shader: Available</code> <br> <code>Per-pixel lighting: Available</code> <br> <code>Full-shadow display: Available</code> <br> <code>Texture compression: Available</code> <br> <code>Advanced material effects: Available</code> <br> <br>  All features are also expectedly supported, but the card is not certified.  From the GRID series for AutoCad, only K2 is certified. <br><br>  <b>Results of the Cadalyst 2012 benchmark:</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bcb/da6/438/bcbda6438f6c908b045e296be69839e9.jpg" title="The results of the video card and virtualized" alt="    "><br><br>  As we can see, the <b>projected video card actually shows results 4 times larger than the virtualized one</b> .  In this case, it is already possible to use such a machine for the work of a designer. <br><br>  If the performance of the K1 card is not enough, you can install the K2 and get a top range video card inside the virtual server. <br><br><h4>  In the second part of the article </h4><br><br>  We will talk in detail about the possibility of <a href="http://www.it-grad.ru/uslugi/daas/virtualnye-rabochie-stantsii-vdi/">GPU virtualization</a> through NVIDIA technologies, which promise us support for all available physical API cards and performance sufficient for confident work with CAD, we will show a test bench, measure the performance of such video cards and summarize.  To be continued. </div><p>Source: <a href="https://habr.com/ru/post/204768/">https://habr.com/ru/post/204768/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204758/index.html">Digest of news of the Windows Azure platform, November 2013</a></li>
<li><a href="../204760/index.html">Google checks all files uploaded to its services on the basis of hashes - and if necessary, sends data to the police</a></li>
<li><a href="../204762/index.html">New Google and Andy Rubin frontier: robots</a></li>
<li><a href="../204764/index.html">Gothenburg ordered 100 unmanned vehicles by 2017</a></li>
<li><a href="../204766/index.html">Competition among users of the cloud player Listen! for Google Chrome</a></li>
<li><a href="../204770/index.html">YotaPhone went on sale</a></li>
<li><a href="../204772/index.html">Group Policy: what's new? Cheat Sheet for all occasions</a></li>
<li><a href="../204780/index.html">Managed Service Accounts</a></li>
<li><a href="../204782/index.html">Directional lighting and shading in 2D space</a></li>
<li><a href="../204784/index.html">Solving Japanese Crosswords in Wolfram Mathematica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>