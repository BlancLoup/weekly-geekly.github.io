<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Haier air conditioning control based on ESP8266</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the continuation of articles on building a "smart home" ... 



 Haier air conditioning Lightera series has on its board a WiFi module to control i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Haier air conditioning control based on ESP8266</h1><div class="post__text post__text-html js-mediator-article">  In the continuation of <a href="https://habr.com/ru/post/395533/">articles</a> on building a "smart home" ... <br><br><img src="https://habrastorage.org/files/280/6dd/316/2806dd31655941f38656dcdf60dfe906.jpg"><br><br>  Haier air conditioning Lightera series has on its board a WiFi module to control it through an application on the phone that works through an unknown Chinese cloud service.  For older models, the module was an option and was purchased separately, it is connected to the control board in the indoor unit.  On new models, the connector is placed under the decorative overlay and the module is already installed in the Lightera series.  Thus, this device is applicable to many Haier air conditioners. <br><a name="habracut"></a><br>  To control the air conditioner through the native WiFi module, you need to download the application on your smartphone / tablet, register in it, connect your smartphone / tablet to the router via Wi-Fi.  Turn on the air conditioner in cooling mode at 30 degrees with the minimum fan speed, make sure that the Haier-uAC network has appeared, and start the program for searching devices and networks.  The program finds your air conditioner and available networks.  You register your network by selecting it from the list and proceed to registering your model of equipment (air conditioner).  In my home network, the DHCP server is disabled on the router and in order to connect to my WiFi network on the connected device, you need to create a new connection and register there besides the SSID (because it is hidden) and the password also a static IP address.  It is for this reason that I could not add my air conditioner to the application, as it asks me to select only the WiFi access point and password when adding the air conditioner.  The application sends the entered data to the WiFi module of the air conditioner and using these data, it tries to connect to your access point, hoping that it will be given an IP address, but my router is breaking all its hopes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Appearance of the native WiFi module. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fba/97a/5fc/fba97a5fcabe4aea8d7ebba7b4f8ff93.jpg" alt="The appearance of the native module WiFi Haier"></div><br><br>  For the test, I still connected it through another router.  Management through the application works, but there is no possibility to control the air conditioner without the application, through which cloud service it is not clear, there is no personal account.  As a result, Haier, like many manufacturers of equipment, created their hardware with their application without the possibility of integration with other automation systems (without special modules and equipment).  In the end, I decided to make my WiFi module with all the characteristics of a well-known character. <br><br>  The basis was taken by ESP8266 12F, which will work directly with my server using the MQTT protocol.  <a href="http://www.iobroker.net/%3Fpage_id%3D267%26lang%3Dru">IOBroker is</a> installed on the server, which also acts as an MQTT server. <br><br>  It remained to understand the exchange protocol with the air conditioner itself.  Having studied the native module and the control circuit diagrams of previous models, it became clear that the WiFi module communicates with the air conditioner through a regular UART with TTL levels.  By connecting the UART / USB adapter in parallel with the RX / TX line and controlling the air conditioner from the application and from the remote, I read all the data. <br><br>  Photo board native module. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9c7/284/74a/9c728474ac914855a7af1e30a8b95b27.jpg" alt="Haier WiFi module motherboard"></div><br><br>  The board shows a DC / DC 3.3 V converter and logic level converters.  The screen did not shoot that is unknown under it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/415/2ec/a23/4152eca238784c5482da059d7846c0a6.jpg" alt="Haier WiFi module motherboard"></div><br><br>  This is my first experience of reverse protocol, but in my opinion the protocol was very simple. <br>  The exchange rate is 9600/8-N-1.  The WiFi module sends a request every 13 seconds (13 bytes), to which the air conditioner issues a packet (37 bytes) with all the data.  Under the spoiler a list of bytes that turned out to be solved. <br><br><div class="spoiler">  <b class="spoiler_title">Exchange protocol</b> <div class="spoiler_text">  1 - FF start byte <br>  2 - FF start byte <br>  3 - 22 <br>  4 - 00 <br>  5 - 00 <br>  6 - 00 <br>  7 - 00 <br>  8 - 00 <br>  9 - 01 <br>  10 - 01 - when requested, 02 - in response <br>  11 - 4D - at the request, 6D - in the answer <br>  12 - 5F - upon request <br>  13 - 00 <br>  14 - 1A - 26 degrees, 1B - 27, Current temperature <br>  15 - 00 <br>  16 - 00 <br>  17 - 00 <br>  18 - 00 - at request, 7F-in response <br>  19 - 00 <br>  20 - 00 <br>  21 - 00 <br>  22 - 00 <br>  23 - 00 <br>  24 - 00 - smart, 01 - cool, 02 - heat, 03 - ventilation, 04 - DRY, <br>  25 - 00 <br>  26 - 00 - max, 01 - mid, 02 - min, 03 - auto - FanSpeed <br>  27 - 00 <br>  28 - 00 - off, 01 - upper and lower limit on.  02 - left / right incl.  03 - both on <br>  29 - 00 - lock of buttons of the panel off, 80 blocking incl. <br>  30 - 00 - power off, x1 - power on, (1x) - Compressor?  x9 - QUIET <br>  31 - 00 <br>  32 - 00 - fresh off, 01 - fresh on <br>  33 - 00 <br>  34 - 00 <br>  35 - 00 <br>  36 - 00 - 16 degrees, 01 - 17 0E - 30 degrees.  Set temperature <br>  37 - Checksum.  Just the sum of all bytes without two starting. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Short teams</b> <div class="spoiler_text">  FF FF 0A 00 00 00 00 00 01 01 4D 02 5B Switching on <br>  FF FF 0A 00 00 00 00 00 01 01 4D 03 5C Switching off <br>  FF FF 0A 00 00 00 00 00 01 03 00 00 0E Lock the console <br>  FF FF 0A 00 00 00 00 00 01 01 4D 01 5A Poll Status <br></div></div><br>  For example, to set the temperature you need to send: <br>  FF FF 22 00 00 00 00 00 01 01 4D 5F 00 00 00 00 00 00 00 00 00 00 00 00 00 00 D 00 - set to 20 degrees. <br><br>  Draw a schematic diagram.  The circuit is powered by 5 volts from the air conditioner, and since the supply voltage of the ESP8266 is 3.3 volts, the LM1117 linear regulator (AMS1117) is then supplied to the corresponding output voltage.  The elements of R1, Q1, R3 and R2, R3 assembled logic level converters since the RXD TXD of the ESP8266 module is not tolerant to 5 V. To program the ESP, the contacts U2 U3 must be closed together. <br>  Schematic diagram. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/db8/446/88b/db844688b6cc4090baa37009173340c8.jpg" alt="Scheme"></div><br><br>  We part the PCB.  The layout of the board is made for installation in the case of the native WiFi module. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/899/bb3/d26/899bb3d26431439db346242ab24b2dc7.jpg" width="400" alt="Printed circuit board"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5a5/330/caa/5a5330caae44425ea1dd2a4d58aebf98.jpg" width="400" alt="Printed circuit board"></div><br>  The photo below is a test board. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/5dd/195/0ab/5dd1950ab3d344e5b1b1e962decf0e49.jpg"></div><br>  The code is written in the Arduino environment.  The current version is available on <a href="https://github.com/instalator/Haier_WiFi">GitHub</a> . <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre><code class="hljs lua">#include &lt;ESP8266WiFi.h&gt; #include &lt;PubSubClient.h&gt; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* password = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* mqtt_server = <span class="hljs-string"><span class="hljs-string">"xx.xx.xx.xx"</span></span>; // MQTT IPAddress ip(xx,xx,xx,x); //IP  IPAddress gateway(xx,xx,xx,xx); //  IPAddress subnet(xx,xx,xx,xx); //  WiFiClient espClient; PubSubClient client(espClient); #define ID_CONNECT <span class="hljs-string"><span class="hljs-string">"myhome-Conditioner"</span></span> #define LED <span class="hljs-number"><span class="hljs-number">12</span></span> #define LEN_B <span class="hljs-number"><span class="hljs-number">37</span></span> #define B_CUR_TMP <span class="hljs-number"><span class="hljs-number">13</span></span> //  #define B_CMD <span class="hljs-number"><span class="hljs-number">17</span></span> // <span class="hljs-number"><span class="hljs-number">00</span></span>- <span class="hljs-number"><span class="hljs-number">7</span></span>F- ??? #define B_MODE <span class="hljs-number"><span class="hljs-number">23</span></span> //<span class="hljs-number"><span class="hljs-number">04</span></span> - DRY, <span class="hljs-number"><span class="hljs-number">01</span></span> - cool, <span class="hljs-number"><span class="hljs-number">02</span></span> - heat, <span class="hljs-number"><span class="hljs-number">00</span></span> - smart <span class="hljs-number"><span class="hljs-number">03</span></span> -  #define B_FAN_SPD <span class="hljs-number"><span class="hljs-number">25</span></span> // <span class="hljs-number"><span class="hljs-number">02</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span> - mid, <span class="hljs-number"><span class="hljs-number">00</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>, <span class="hljs-number"><span class="hljs-number">03</span></span> - auto #define B_SWING <span class="hljs-number"><span class="hljs-number">27</span></span> //<span class="hljs-number"><span class="hljs-number">01</span></span> -     . <span class="hljs-number"><span class="hljs-number">00</span></span> - . <span class="hljs-number"><span class="hljs-number">02</span></span> - / . <span class="hljs-number"><span class="hljs-number">03</span></span> -   #define B_LOCK_REM <span class="hljs-number"><span class="hljs-number">28</span></span> //<span class="hljs-number"><span class="hljs-number">80</span></span>  . <span class="hljs-number"><span class="hljs-number">00</span></span> -  #define B_POWER <span class="hljs-number"><span class="hljs-number">29</span></span> //on/off <span class="hljs-number"><span class="hljs-number">01</span></span> - on, <span class="hljs-number"><span class="hljs-number">00</span></span> - off (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>)-??? <span class="hljs-number"><span class="hljs-number">09</span></span> - QUIET #define B_FRESH <span class="hljs-number"><span class="hljs-number">31</span></span> //fresh <span class="hljs-number"><span class="hljs-number">00</span></span> - off, <span class="hljs-number"><span class="hljs-number">01</span></span> - on #define B_SET_TMP <span class="hljs-number"><span class="hljs-number">35</span></span> //  int fresh; int power; int swing; int lock_rem; int cur_tmp; int set_tmp; int fan_spd; int Mode; long prev = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> inCheck = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> qstn[] = {<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">77</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>}; //   //<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> start[] = {<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>}; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> data[<span class="hljs-number"><span class="hljs-number">37</span></span>] = {}; //  <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> on[] = {<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">77</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">91</span></span>}; //   <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> off[] = {<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">77</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">92</span></span>}; //   <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> lock[] = {<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">14</span></span>}; //   //<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> buf[<span class="hljs-number"><span class="hljs-number">10</span></span>]; void setup_wifi() { delay(<span class="hljs-number"><span class="hljs-number">10</span></span>); WiFi.begin(ssid, password); WiFi.<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>(ip, gateway, subnet); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() != WL_CONNECTED) { delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); digitalWrite(LED, !digitalRead(LED)); } digitalWrite(LED, HIGH); } void reconnect() { digitalWrite(LED, !digitalRead(LED)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!client.connected()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(ID_CONNECT)) { client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/RAW"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); client.subscribe(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/#"</span></span>); digitalWrite(LED, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } } } void InsertData(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> data[], size_t size){ set_tmp = data[B_SET_TMP]+<span class="hljs-number"><span class="hljs-number">16</span></span>; cur_tmp = data[B_CUR_TMP]; Mode = data[B_MODE]; fan_spd = data[B_FAN_SPD]; swing = data[B_SWING]; power = data[B_POWER]; lock_rem = data[B_LOCK_REM]; fresh = data[B_FRESH]; ///////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fresh == <span class="hljs-number"><span class="hljs-number">0x00</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fresh"</span></span>, <span class="hljs-string"><span class="hljs-string">"off"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fresh == <span class="hljs-number"><span class="hljs-number">0x01</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fresh"</span></span>, <span class="hljs-string"><span class="hljs-string">"on"</span></span>); } ///////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lock_rem == <span class="hljs-number"><span class="hljs-number">0x80</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Lock_Remote"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lock_rem == <span class="hljs-number"><span class="hljs-number">0x00</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Lock_Remote"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); } ///////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power == <span class="hljs-number"><span class="hljs-number">0x01</span></span> || power == <span class="hljs-number"><span class="hljs-number">0x11</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Power"</span></span>, <span class="hljs-string"><span class="hljs-string">"on"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power == <span class="hljs-number"><span class="hljs-number">0x00</span></span> || power == <span class="hljs-number"><span class="hljs-number">0x10</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Power"</span></span>, <span class="hljs-string"><span class="hljs-string">"off"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power == <span class="hljs-number"><span class="hljs-number">0x09</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Power"</span></span>, <span class="hljs-string"><span class="hljs-string">"quiet"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (power == <span class="hljs-number"><span class="hljs-number">0x11</span></span> || power == <span class="hljs-number"><span class="hljs-number">0x10</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Compressor"</span></span>, <span class="hljs-string"><span class="hljs-string">"on"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Compressor"</span></span>, <span class="hljs-string"><span class="hljs-string">"off"</span></span>); } ///////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swing == <span class="hljs-number"><span class="hljs-number">0x00</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Swing"</span></span>, <span class="hljs-string"><span class="hljs-string">"off"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swing == <span class="hljs-number"><span class="hljs-number">0x01</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Swing"</span></span>, <span class="hljs-string"><span class="hljs-string">"ud"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swing == <span class="hljs-number"><span class="hljs-number">0x02</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Swing"</span></span>, <span class="hljs-string"><span class="hljs-string">"lr"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swing == <span class="hljs-number"><span class="hljs-number">0x03</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Swing"</span></span>, <span class="hljs-string"><span class="hljs-string">"all"</span></span>); } ///////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan_spd == <span class="hljs-number"><span class="hljs-number">0x00</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fan_Speed"</span></span>, <span class="hljs-string"><span class="hljs-string">"max"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan_spd == <span class="hljs-number"><span class="hljs-number">0x01</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fan_Speed"</span></span>, <span class="hljs-string"><span class="hljs-string">"mid"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan_spd == <span class="hljs-number"><span class="hljs-number">0x02</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fan_Speed"</span></span>, <span class="hljs-string"><span class="hljs-string">"min"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan_spd == <span class="hljs-number"><span class="hljs-number">0x03</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fan_Speed"</span></span>, <span class="hljs-string"><span class="hljs-string">"auto"</span></span>); } ///////////////////////////////// <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> b[<span class="hljs-number"><span class="hljs-number">5</span></span>]; String char_set_tmp = String(set_tmp); char_set_tmp.toCharArray(b,<span class="hljs-number"><span class="hljs-number">5</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Set_Temp"</span></span>, b); //////////////////////////////////// String char_cur_tmp = String(cur_tmp); char_cur_tmp.toCharArray(b,<span class="hljs-number"><span class="hljs-number">5</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Current_Temp"</span></span>, b); //////////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mode == <span class="hljs-number"><span class="hljs-number">0x00</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>, <span class="hljs-string"><span class="hljs-string">"smart"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mode == <span class="hljs-number"><span class="hljs-number">0x01</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>, <span class="hljs-string"><span class="hljs-string">"cool"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mode == <span class="hljs-number"><span class="hljs-number">0x02</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>, <span class="hljs-string"><span class="hljs-string">"heat"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mode == <span class="hljs-number"><span class="hljs-number">0x03</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>, <span class="hljs-string"><span class="hljs-string">"vent"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mode == <span class="hljs-number"><span class="hljs-number">0x04</span></span>){ client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>, <span class="hljs-string"><span class="hljs-string">"dry"</span></span>); } String raw_str; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> raw[<span class="hljs-number"><span class="hljs-number">75</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">37</span></span>; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data[i] &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>){ raw_str += <span class="hljs-string"><span class="hljs-string">"0"</span></span>; raw_str += String(data[i], HEX); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { raw_str += String(data[i], HEX); } } raw_str.toUpperCase(); raw_str.toCharArray(raw,<span class="hljs-number"><span class="hljs-number">75</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/RAW"</span></span>, raw); /////////////////////////////////// } <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> getCRC(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> req[], size_t size){ <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> crc = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">2</span></span>; i &lt; size; i++){ crc += req[i]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> crc; } void SendData(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> req[], size_t size){ //Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(start, <span class="hljs-number"><span class="hljs-number">2</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(req, size - <span class="hljs-number"><span class="hljs-number">1</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(getCRC(req, size<span class="hljs-number"><span class="hljs-number">-1</span></span>)); } inline unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> toHex( <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> ch ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( ( ch &gt;= <span class="hljs-string"><span class="hljs-string">'A'</span></span> ) ? ( ch - <span class="hljs-string"><span class="hljs-string">'A'</span></span> + <span class="hljs-number"><span class="hljs-number">0xA</span></span> ) : ( ch - <span class="hljs-string"><span class="hljs-string">'0'</span></span> ) ) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; } void callback(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>* payload, unsigned int length) { payload[length] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; String strTopic = String(topic); String strPayload = String((<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*)payload); /////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Set_Temp"</span></span>){ set_tmp = strPayload.toInt()<span class="hljs-number"><span class="hljs-number">-16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (set_tmp &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; set_tmp &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>){ data[B_SET_TMP] = set_tmp; } } ////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Mode"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"smart"</span></span>){ data[B_MODE] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"cool"</span></span>){ data[B_MODE] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"heat"</span></span>){ data[B_MODE] = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"vent"</span></span>){ data[B_MODE] = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"dry"</span></span>){ data[B_MODE] = <span class="hljs-number"><span class="hljs-number">4</span></span>; } } ////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Fan_Speed"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"max"</span></span>){ data[B_FAN_SPD] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"mid"</span></span>){ data[B_FAN_SPD] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"min"</span></span>){ data[B_FAN_SPD] = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"auto"</span></span>){ data[B_FAN_SPD] = <span class="hljs-number"><span class="hljs-number">3</span></span>; } } //////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Swing"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"off"</span></span>){ data[B_SWING] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"ud"</span></span>){ data[B_SWING] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"lr"</span></span>){ data[B_SWING] = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"all"</span></span>){ data[B_SWING] = <span class="hljs-number"><span class="hljs-number">3</span></span>; } } //////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Lock_Remote"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"true"</span></span>){ data[B_LOCK_REM] = <span class="hljs-number"><span class="hljs-number">80</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"false"</span></span>){ data[B_LOCK_REM] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } //////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/Power"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"off"</span></span> || strPayload == <span class="hljs-string"><span class="hljs-string">"false"</span></span> || strPayload == <span class="hljs-string"><span class="hljs-string">"0"</span></span>){ SendData(off, sizeof(off)/sizeof(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"on"</span></span> || strPayload == <span class="hljs-string"><span class="hljs-string">"true"</span></span> || strPayload == <span class="hljs-string"><span class="hljs-string">"1"</span></span>){ SendData(on, sizeof(on)/sizeof(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"quiet"</span></span>){ data[B_POWER] = <span class="hljs-number"><span class="hljs-number">9</span></span>; } } //////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/RAW"</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">75</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> hexbyte[<span class="hljs-number"><span class="hljs-number">3</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; strPayload.toCharArray(buf, <span class="hljs-number"><span class="hljs-number">75</span></span>); int octets[sizeof(buf) / <span class="hljs-number"><span class="hljs-number">2</span></span>] ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">76</span></span>; i += <span class="hljs-number"><span class="hljs-number">2</span></span>){ hexbyte[<span class="hljs-number"><span class="hljs-number">0</span></span>] = buf[i] ; hexbyte[<span class="hljs-number"><span class="hljs-number">1</span></span>] = buf[i+<span class="hljs-number"><span class="hljs-number">1</span></span>] ; data[i/<span class="hljs-number"><span class="hljs-number">2</span></span>] = (toHex(hexbyte[<span class="hljs-number"><span class="hljs-number">0</span></span>]) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) | toHex(hexbyte[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(data, <span class="hljs-number"><span class="hljs-number">37</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/Conditioner/RAW"</span></span>, buf); } data[B_CMD] = <span class="hljs-number"><span class="hljs-number">0</span></span>; data[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; data[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">77</span></span>; data[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">95</span></span>; SendData(data, sizeof(data)/sizeof(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>)); } void setup() { pinMode(LED, OUTPUT); Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); setup_wifi(); client.setServer(mqtt_server, <span class="hljs-number"><span class="hljs-number">1883</span></span>); client.setCallback(callback); } void loop() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Serial.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ Serial.readBytes(data, <span class="hljs-number"><span class="hljs-number">37</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(Serial.available()){ delay(<span class="hljs-number"><span class="hljs-number">2</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data[<span class="hljs-number"><span class="hljs-number">36</span></span>] != inCheck){ inCheck = data[<span class="hljs-number"><span class="hljs-number">36</span></span>]; InsertData(data, <span class="hljs-number"><span class="hljs-number">37</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.connected()){ reconnect(); } client.loop(); long now = millis(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (now - prev &gt; <span class="hljs-number"><span class="hljs-number">5000</span></span>) { prev = now; SendData(qstn, sizeof(qstn)/sizeof(<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>)); //  } }</code> </pre> <br></div></div><br>  After the firmware ESP8266 we put the module in the air conditioner.  Topics are automatically created on the MQTT server: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/559/d53/096/559d53096cd3452890825dc485aa1d79.png" alt="Printed circuit board"></div><br><br>  Air conditioning control panel on the web page. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/e4b/3f0/2e7/e4b3f02e748e4e62b917610f015dbde4.png" alt="Printed circuit board"></div><br>  In addition to the management from the web page, the management of voice commands is organized, as well as through the <a href="http://www.iobroker.net/%3Fpage_id%3D4492%26lang%3Dru">Telegram</a> driver <a href="http://www.iobroker.net/%3Fpage_id%3D4492%26lang%3Dru">for IOBroker.</a> <br>  The cost of the new module cost about 200 rubles. <br><br><a name="anc1"></a><br>  <a href="https://geektimes.ru/post/270012/">The first part - the smart home, the beginning.</a> <br>  <a href="https://geektimes.ru/post/270140/">Part Two - Bathroom Visitor Counter</a> </div><p>Source: <a href="https://habr.com/ru/post/395533/">https://habr.com/ru/post/395533/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../395523/index.html">In the laboratory of the University of Stuttgart printed multi-lens with a diameter of human hair</a></li>
<li><a href="../395525/index.html">AI defeated man in air combat simulation</a></li>
<li><a href="../395527/index.html">Russian scientists have created a magneto-thrombolytic system that breaks blood clots thousands of times more effective than analogs.</a></li>
<li><a href="../395529/index.html">Robotics educational sets MRobot with Intel Inside</a></li>
<li><a href="../395531/index.html">Brief history of hoverboard construction: 5 most famous projects</a></li>
<li><a href="../395537/index.html">Label it</a></li>
<li><a href="../395539/index.html">Brew beer with MP8036multi module</a></li>
<li><a href="../395541/index.html">Spacesuit for landing on Europe and the Moon - what should it be? Interview with Lead Designer Final Frontier Design</a></li>
<li><a href="../395543/index.html">Russia creates an open base of near-Earth objects</a></li>
<li><a href="../395545/index.html">Novgorod archaeologists have discovered an unknown ancient Russian curse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>