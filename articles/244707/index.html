<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to create a DbContext inside Visual Studio, or ‚ÄúWhat if you want something strange?‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starting with version 14.1, XtraReports has built-in support for the ORM Entity Framework. If earlier the developer had to use the standard BindingSou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to create a DbContext inside Visual Studio, or ‚ÄúWhat if you want something strange?‚Äù</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/5db/64d/61f/5db64d61f8a04c5fb0adc744a0c03453.jpg"></div><br><br>  Starting with version 14.1, <a href="https://www.devexpress.com/Products/NET/Reporting/">XtraReports</a> has built-in support for the ORM Entity Framework.  If earlier the developer had to use the standard BindingSource component to bind report elements to data and then manually write code to load data from the EF model, now all he needs is to select a specific context (from the current project or assembly specified in the project's References) and specify the string used connect.  The <a href="https://documentation.devexpress.com/">EFDataSource</a> component itself creates a context with the necessary connection string and returns the data to the report. <br><a name="habracut"></a><br>  What does it give to the developer, besides convenience: <br>  First, it facilitates an initial acquaintance with XtraReports.  No need to think: ‚ÄúBut how can we use data from the Entity Framework here?‚Äù.  There is a simple wizard where it is enough to answer a couple of questions from the ‚ÄúWhat exactly do you need‚Äù series. <br>  Secondly, it gives the opportunity to see the real data in the Preview report in Visual Studio, which facilitates the actual creation of the report itself, since you can always monitor the result without launching a separate application. <br>  Third, the developer can now let the end users of his application generate reports using data from the EntityFramework model. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/37c/fae/dcd/37cfaedcd705404dbbb60fe5559d5ff5.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now, when the preface is complete, you can move on to more interesting things, namely, how it all works and how it works. <br><br>  <i>(Hereinafter, some personal impressions are given in italics, designed to dilute the boring and boring technical details) It would seem that this component is worthless.</i>  <i>Draw a number of forms, come up with a simple API.</i>  <i>However, there is a nuance here - you need to get real data from the model inside Visual Studio.</i>  <i>As Boromir said, ‚ÄúYou cannot just create and create an instance of a custom DbContext in the VisualStudio process‚Äù.</i> <br><br>  By default, the Entity Framework stores the database connection string in app / web.config.  Accordingly, when attempting to create a context from the Visual Studio process, this immediately leads to an error, since the studio devenv.exe.config does not contain the connection string with which the context was created.  This problem could be circumvented by forcing the report designer to create the desired default constructor for the data model, but this is not our way.  It is desirable that in the simplest case (namely, this is the case when the data context was created as a result of the work of Visual Studio and no changes were made to it), no additional actions were required from the developer. <br><br>  In addition, the Entity Framework supports a wide variety of databases through third-party data providers.  To use any data provider other than the default MS SQL, the Entity Framework needs to be properly configured (via app.config or in code) and make available all necessary assemblies by putting them in the GAC or next to the project being launched.  If launched from Visual Studio, this is also not so easy to ensure: <br>  First, the already mentioned problem devenv.exe.config. <br><br>  Secondly, third-party database provider assemblies are often swung by NuGet and are stored locally in the project, and not in the GAC, which also makes it impossible to directly create the user-specified DbContext. <br><br>  So, we need: <ol><li>  Find in the user project a connection string with the specified name </li><li>  Create a custom DbContext, provided that the necessary constructor does not accept the connection string, and the GAC does not have the assemblies on which it depends (primarily EntityFramework.dll) </li><li>  Configure EntityFramework to work with the user DBMS, if it is different from the standard Microsoft SQL Server. </li></ol><br><br>  By default, a connection string is created with the same name as the data model.  However, its name can be easily changed and it is impossible to find out exactly which connection string the developer wanted to use.  There is no way out - you can only ask the developer himself. In general, when developing components, you should try to minimize the number of assumptions and assumptions.  The less your component solves something for the developer, the better.  It is always better to ask than to do wrong. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9b4/c33/9ba/9b4c339ba586435ba0fa9b6f4b557a68.png"></div><br><br>  Next you need to get a specific connection string from the configuration file of the current project - the ConfigurationManager will not help with this.  But, the object automation model VisualStudio <a href="http://msdn.microsoft.com/en-us/library/envdte.aspx">EnvDTE</a> will help us, and in particular the interface Microsoft.VSDesigner.VSDesignerPackage.IGlobalConnectionService (unfortunately, undocumented): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IGlobalConnectionService</span></span> { <span class="hljs-function"><span class="hljs-function">DataConnection[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConnections</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddConnectionToServerExplorer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, DataConnection connection</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddConnectionToAppSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project, DataConnection connection</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveConnectionFromAppSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project, DataConnection connection</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateConnectionInAppSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project, DataConnection oldConnection, DataConnection newConnection</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValidPropertyName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propertyName</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RefreshApplicationSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><br>  Here we are interested in the GetConnections method, which returns an array of DataConnection objects.  Moreover, this method finds strings not only in app.config, but also in Server Explorer and machine.config.  More information about the IGlobalConnectionService can be found in the reflector and Microsoft.VSDesigner assembly. <br><br>  <i>Any reflector (most often I use the free <a href="http://ilspy.net/">ILSpy</a> ) when developing components or plug-ins to the studio is irreplaceable - as a rule, to do something, you have to ‚Äúpry‚Äù the debugger, as Microsoft has implemented similar functionality and then analyze the source code of ‚Äúpeeped ‚ÄùBuilds.</i>  <i>In our case, the required service was suggested by the studio masters Add New DataSet and Add New ADO.NET Entity Data Model.</i> <i><br></i> <br>  And so, we have a connection string.  But what to do with it if the user model does not have a constructor that accepts a connection string?  The answer is both simple and complex - with the help of <a href="http://msdn.microsoft.com/en-us/library/3y322t50(v%3Dvs.110).aspx">Reflection.Emit</a> you need to make a dynamic assembly, create your descendant of a custom data model in it and make the necessary constructor in it.  And here the attentive reader may ask the question: How will we create our constructor in the descendant class, if the constructor with the necessary parameters is not in the base class?  The answer is again simple - in IL, calling the base class constructor is optional, and you can call any constructor of any ancestor in the hierarchy. <br><br><pre> <code class="cs hljs">.class <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> auto ansi DevExpress.DataAccess.Tests.Entity.AdventureWorksCFEntities extends [DevExpress.DataAccess.v14<span class="hljs-number"><span class="hljs-number">.2</span></span>.Tests.MsSqlEF6]DevExpress.DataAccess.Tests.Entity.AdventureWorksCFEntities { .method <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> specialname rtspecialname instance <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> .ctor ( <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> ) cil managed { .maxstack <span class="hljs-number"><span class="hljs-number">2</span></span> IL_0000: ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0001: ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0002: call instance <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> [EntityFramework]System.Data.Entity.DbContext::.ctor(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) IL_0007: ret } }</code> </pre><br>  <i>Yes, it looks like a ‚Äúdirty hack‚Äù - but nonetheless it works and is allowed by IL.</i>  <i>Actually, an alternative way to ‚Äúslip‚Äù the necessary connection string for EntityFramework is not a much more ‚Äúclean‚Äù hack with the Configuration Manager, for example, described <a href="http://stackoverflow.com/questions/1117683/add-a-dbproviderfactory-without-an-app-config">here</a> .</i> <i><br></i> <br><br>  Creating a dynamic assembly, in addition to actually creating a descendant of a user model, also allows you to solve the problem with reference to EntityFramework.dll.  To create a call to System.Data.Entity.DbContext ::. Ctor (string), in any case, you need to load the assembly EntityFramework.dll and get the type DbContext from there.  Looking for it in the GAC or in the current directory is a thankless task because most likely it lies locally somewhere in the NuGet repository.  Therefore, you have to use the studio automation object model again, in particular <a href="http://msdn.microsoft.com/ru-ru/library/system.componentmodel.design.itypediscoveryservice(v%3Dvs.110).aspx">ITypesDiscoveryService</a> , and look for EntityFramework.dll in the project reference.  Looking ahead - there you can also find an assembly of a custom data provider for EntityFramework, if necessary. <br><br>  So, two of the three problems solved.  The simplest but most laborious of all is to register an arbitrary data provider.  As I already wrote, the Entity Framework is able to work with a variety of DBMS through arbitrary data providers.  The easiest way to use them is to register the necessary settings in the app.config.  Another way is to use the <a href="http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbconfiguration(v%3Dvs.113).aspx">DBConfiguration</a> class, which is an implementation of the Chain-of-Responsibility pattern and storing the resolver list <a href="https://entityframework.codeplex.com/wikipage%3Ftitle%3DEF%2520Configuration%2520and%2520Extensibility">IDbDependencyResolver</a> .  Each of them, in turn, implements the Service Locator pattern.  During the initialization procedure, the Entity Framework searches for a <a href="http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbconfiguration(v%3Dvs.113).aspx">DBConfiguration</a> descendant in the same assembly as the data model, and if it finds it, it requests the name of the data provider used, the <a href="http://msdn.microsoft.com/ru-ru/library/system.data.common.dbproviderservices(v%3Dvs.110).aspx">DbProviderServices</a> and <a href="http://msdn.microsoft.com/en-us/library/system.data.common.dbproviderfactory">DbProviderFactory factories</a> , and so on. <br><br>  <i>Even the EF developers themselves in the documentation justify themselves - ‚ÄúYes, we know that the Service Locator is an anti-pattern, but we know what we are doing and in our case its use is justified.‚Äù</i> <br><br>  Here is an example of setting up the Entity Framework to use SqlCE: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SqlCEConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqlCEConfiguration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { SetProviderServices( SqlCeProviderServices.ProviderInvariantName, SqlCeProviderServices.Instance); SetDefaultConnectionFactory( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCeConnectionFactory(SqlCeProviderServices.ProviderInvariantName)); } }</code> </pre><br><br>  Since the descendant of the <a href="http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbconfiguration(v%3Dvs.113).aspx">DbConfiguration</a> class must lie in the same assembly with DbContext, accordingly, it must be created in the same dynamic assembly in which we created the descendant of the user model a little earlier.  Here you have to write a little more complex code, different for different data providers.  And for this, you will need types from the assemblies of the respective data providers - they can be found through the same <a href="http://msdn.microsoft.com/ru-ru/library/system.componentmodel.design.itypediscoveryservice(v%3Dvs.110).aspx">ITypesDiscoveryService</a> , provided that the necessary assemblies are in the project references. <br><br>  Writing code on Reflection.Emit, which creates an assembly with the required IL, is quite a chore - however, the <a href="http://reflectoraddins.codeplex.com/wikipage%3Ftitle%3DReflectionEmitLanguage%26referringTitle%3DHome">ReflectionEmitLanguage</a> plugin for Reflector can greatly facilitate it.  It does not create a 100% working code, but it helps to avoid ‚Äúsilly‚Äù mistakes when rewriting IL instructions. <br><br>  To summarize: Retrieving data from an arbitrary EF model within the Visual Studio process is not easy, because for this you need to ‚Äúslip‚Äù the required connection string and configure the Entity Framework to work with an arbitrary data provider. If you really want to do this, you will have to : <ul><li>  understand the object model of automation VisualStudio <a href="http://msdn.microsoft.com/en-us/library/envdte.aspx">EnvDTE</a> , </li><li>  learn IL programming with <a href="http://msdn.microsoft.com/en-us/library/3y322t50(v%3Dvs.110).aspx">Reflection.Emit</a> , </li><li>  <a href="http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbconfiguration(v%3Dvs.113).aspx">Learn</a> how to configure EF using the <a href="http://msdn.microsoft.com/ru-ru/library/system.data.entity.dbconfiguration(v%3Dvs.113).aspx">DbConfiguration</a> class. </li></ul><br>  It is clear that within the framework of this article it is impossible to highlight the entire experience of working with EF in our company.  Various problems arose (and arise) and not all of them were solved, so not everything depends on us as component developers.  But I believe that this approach, although it does not work in absolutely all cases, still improved the life for our users - software developers. <br><br>  <i>There is another opinion - that components should not allow the developer to work with real data.</i>  <i>There are no fundamental reasons for this, and Visual Studio itself allows it to be done (for example, when creating datasets).</i>  <i>As I think, this is based on just such experience and an understanding of the fact that it will not work out just like that, since there is a rather high probability that you will encounter a problem in any of the areas uncontrolled by yourself - inside Visual Studio, .NET Framework or Entity Framework.</i> <i><br></i> <br>  And finally, the last remark: the described mechanism for creating DbContext inside Visual Studio first appeared in our WPF controls in the <a href="https://documentation.devexpress.com/">Scaffolding</a> mechanism.  It was not intended to receive data, but it originally had an idea with a temporary assembly and generation of a descendant of DbContext in it. <br><br>  That's all that I wanted to tell in this article.  Ready to answer any questions in the comments. <br><br>  Ps.  The author of the title photo with corgi - <a href="https://vk.com/kudma">vk.com/kudma</a> . </div><p>Source: <a href="https://habr.com/ru/post/244707/">https://habr.com/ru/post/244707/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244695/index.html">High Frequency Trading Neighborhood - Part III</a></li>
<li><a href="../244697/index.html">InterSystems iKnow. Part two. Creating a simple domain</a></li>
<li><a href="../244699/index.html">We integrate AutoMapper with DI-containers on the example of Unity</a></li>
<li><a href="../244701/index.html">New version of RubyMine: Chef, Puppet, EditorConfig and more</a></li>
<li><a href="../244705/index.html">OpenVPN Denial of Service Vulnerability</a></li>
<li><a href="../244709/index.html">Saving "many to many" in Yii2 through behavior</a></li>
<li><a href="../244711/index.html">Optional types? Only if very necessary</a></li>
<li><a href="../244713/index.html">10 opportunities to be more productive with Eclipse for Java developers</a></li>
<li><a href="../244715/index.html">The script collapsing comments on Habr√©</a></li>
<li><a href="../244721/index.html">Revised Grunt Beginner's Guide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>