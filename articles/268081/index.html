<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Diagnosing the behavior of "cumulative" (rollup) fields in Microsoft Dynamics CRM 2015</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The ‚Äúcumulative‚Äù data type (rollup) appeared in Microsoft Dynamics CRM 2015. It allows you to receive aggregated information along the descendant-pare...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Diagnosing the behavior of "cumulative" (rollup) fields in Microsoft Dynamics CRM 2015</h1><div class="post__text post__text-html js-mediator-article">  The ‚Äúcumulative‚Äù data type (rollup) appeared in Microsoft Dynamics CRM 2015. It allows you to receive aggregated information along the descendant-parent line.  Such functionality is undoubtedly in demand on the market, since updating the information from the ‚Äúdescendants‚Äù on the ‚Äúparent‚Äù has always represented a technical complexity, but it has been in demand and in demand now in many business tasks. <br><br>  A rollup field is defined as a regular field in CRM, but with a formula for calculating the aggregated values ‚Äã‚Äãof the related records.  When creating and updating a field, a system task is created that calculates the value of this field on all available records with this field.  In the future, the values ‚Äã‚Äãof this field are updated incrementally every hour using another system task, which is also automatically generated by the CRM core.  In this paper, we consider one of the aspects of working with cumulative fields, namely what happens at the moment of creation / update of such a field and what can go wrong. <br><a name="habracut"></a><br>  Information about rollup fields can be found in the <a href="https://msdn.microsoft.com/en-us/library/26ada6f7-3e22-465c-90f8-19d326785eb4">official</a> and <a href="http://www.softwareanswers.co.uk/software_answers/2014/11/microsoft-dynamics-crm-2015-sdk-whats-new.html">not so much</a> information.  There, however, not everything is described.  When a field is created (updated), CRM registers a system job for the initial calculation of the field value in all available records.  This task is automatically scheduled to start in 24 hours.  As the study of traces showed, updating the field leads to the fact that the InitialValueCalculationStatus value for this field in the dbo.RollupPropertiesBase table becomes 0. After the mass update task has completed, this value changes to 3. The set of values ‚Äã‚Äãfor this field does not match the set of _State field values, available via meta date.  The initial state of the ‚Äúaccumulative‚Äù field is not available through the public API, which makes diagnosing the state of such a field difficult for cloud systems where there is no access to the database. <br><br>  The initial calculation of the values ‚Äã‚Äãof the created / updated field is completely controlled within the system.  The administrator can check the presence of the system task, stop or change the time it starts, but there is no possibility to control its execution except by checking its status.  If for some reason the task did not work as it should, but this, as practice has shown, happens, the InitialValueCalculationStatus field does not become 3. At the same time, a regular (incremental) field update through another system task is performed and demonstrates successful behavior - status Success and no mistakes.  This is because the regular update task checks whether the initial field calculation (InitialValueCalculationStatus = 3) was performed before starting the calculations, and if not, then skips this field.  Thus, auto-updated fields may appear in the system, which are not updated and show outdated information. <br>  As a solution, you can use the update field definition either through the CRM interface or through the use of <a href="https://msdn.microsoft.com/en-us/library/microsoft.xrm.sdk.messages.retrieveattributerequest">RetrieveAttributeRequest</a> and <a href="https://msdn.microsoft.com/en-us/library/microsoft.xrm.sdk.messages.updateattributerequest">UpdateAttributeRequest</a> .  Simple re-saving of the field causes resetting the InitialValueCalculationStatus value and creating the task of mass updating field values. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The difficulty lies in diagnosing the existence of the problem as such, especially for cloud systems.  As a solution to this problem, we can suggest checking the latest update dates of the cumulative fields, and if this value is ‚Äúfar‚Äù in the past, then take action.  How "far" depends on specific business processes. <br>  You can get a list of ‚Äúcumulative‚Äù fields through a standard meta-date request: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RetrieveAllEntitiesRequest() { EntityFilters = Microsoft.Xrm.Sdk.Metadata.EntityFilters.Attributes, RetrieveAsIfPublished = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = (RetrieveAllEntitiesResponse)crmService.Execute(request);</code> </pre> <br>  With the subsequent extraction of attributes from the received records (EntityMetadata entity): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rollupAttributes = entity.Attributes.Where(a =&gt; a.SourceType == <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre><br>  Now we need to extract the Date attribute.  Each rollup field consists of three - the field itself with the formula and type 2 (SourceType == 2), the Date field and the State field.  We are interested in the Date field, because it contains the time of the last field update.  Modifying the ‚ÄúCumulative‚Äù fields do not affect the ModifiedOn field. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rollupAttribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rollupAttributes) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dateAttribute = entity.Attributes.Where(a =&gt; a.LogicalName.ToLower() == rollupAttribute.LogicalName.ToLower() + <span class="hljs-string"><span class="hljs-string">"_date"</span></span>).FirstOrDefault(); }</code> </pre><br>  After the list of fields for verification has been received, you can form a query for these fields, sorted by the date the field was updated. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qe = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueryExpression(); qe.EntityName = entity.LogicalName; qe.ColumnSet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ColumnSet(); qe.TopCount = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderExpression(); order.AttributeName = rollupField.DateField.LogicalName; order.OrderType = OrderType.Descending; qe.Orders.Clear(); qe.Orders.Add(order); qe.ColumnSet.Columns.Clear(); qe.ColumnSet.Columns.Add(rollupField.DateField.LogicalName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ec = crmService.RetrieveMultiple(qe);</code> </pre><br>  Having received the list of records, you can process it and decide what to do with rarely updated fields. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ec.Entities.Any()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastUpdateDateRaw = ec.Entities[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes[rollupField.DateField.LogicalName].ToString(); DateTime lastUpdateDate; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DateTime.TryParse(lastUpdateDateRaw, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> lastUpdateDate)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastUpdateDate.ToLocalTime() &lt; DateTime.Today.AddDays(<span class="hljs-number"><span class="hljs-number">-1</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//Put your logic here } } }</span></span></code> </pre><br>  There is a small trick associated with the ability to manually update the value of the ‚Äúcumulative‚Äù field, accessible to users.  In this case, the proposed analysis should be complicated - to display statistics on the set of recent field updates, it is possible to analyze related records, in general, show imagination depending on the circumstances. </div><p>Source: <a href="https://habr.com/ru/post/268081/">https://habr.com/ru/post/268081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268067/index.html">Security Week 40: Invincibility in WinRAR, bug veteran in Firefox, Microsoft update-oops</a></li>
<li><a href="../268069/index.html">Unity - Conceptual ideas and tips for newcomers igrodeva. Simple procedural generation of models for 2D games</a></li>
<li><a href="../268073/index.html">Recommended system on .Net or first steps with MyMediaLite</a></li>
<li><a href="../268077/index.html">Project Fi - what can its subscribers get?</a></li>
<li><a href="../268079/index.html">Playgrounds for browser games</a></li>
<li><a href="../268087/index.html">Critical vulnerabilities discovered in TrueCrypt cryptograph</a></li>
<li><a href="../268089/index.html">It's time. Upgrade to Oracle Database 12</a></li>
<li><a href="../268091/index.html">We write Policy server on C ++ for Unity3d</a></li>
<li><a href="../268093/index.html">Unbearable server burden: to the issue of transition to the IaaS model</a></li>
<li><a href="../268095/index.html">Two types of applications for Bitrix24</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>