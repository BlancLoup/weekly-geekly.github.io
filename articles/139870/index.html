<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once again about the skiplist ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... or how I got "Alenka" for the console application 
 There is a fairly common opinion that performing various test tasks helps to very quickly rais...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once again about the skiplist ...</h1><div class="post__text post__text-html js-mediator-article"><h4>  ... or how I got "Alenka" for the console application </h4><br>  There is a fairly common opinion that performing various test tasks helps to very quickly raise your professional level.  I myself sometimes like to dig out a tricky test thread and solve it in order to be constantly in good shape, as they say.  I once performed a competitive task for an internship at one company, the task seemed to me amusing and interesting, here is its short text: <br><br><blockquote>  Imagine that your colleague-whiner came to talk about his difficult task - he needed not only to sort the set of integers in ascending order, but to give all the elements of an ordered set from L th to R th inclusive! <br>  You stated that this is an elementary task and you need ten minutes to write a solution in C #.  Well, or an hour.  Or two.  Or chocolate "Alenka" </blockquote><br>  It is assumed that duplicates are allowed in the set, and the number of elements will be no more than 10 ^ 6. <br><br>  There are several comments on the evaluation of the decision: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  Your code will be evaluated and tested by three programmers: <br><ul><li>  Bill will run your solution on tests no larger than 10Kb. </li><li>  In Steven‚Äôs tests, the number of requests will be no more than 10 ^ 5, while the number of requests for addition will be no more than 100. </li><li>  In Mark tests, the number of queries will be no more than 10 ^ 5. </li></ul></blockquote>  The solution can be very interesting, so I found it necessary to describe it. <br><a name="habracut"></a><br><h4>  Decision </h4><br>  Suppose we have an abstract repository. <br><br>  Denote by Add (e) to add an item to the repository, and Range (l, r) to take a slice from l to r element. <br><br>  The trivial version of the repository may be: <br><ul><li>  The storage base will be an ordered, ascending dynamic array. </li><li>  Each time you insert a binary search is the position in which you want to insert an element. </li><li>  When requesting Range (l, r), we will simply take an array slice from l through r. </li></ul>  We estimate the complexity of the approach based on a dynamic array. <br><br>  C Range (l, r) - taking a slice can be estimated as O (r - l). <br><br>  C Add (e) - insertion in the worst case will work for O (n), where n is the number of elements.  When n ~ 10 ^ 6, the insertion is a bottleneck.  Below in the article will be proposed an improved version of the repository. <br><br>  An example of the source code can be found <a href="">here</a> . <br><br>  A more suitable option may be, for example: <br><ul><li>  The basis of the repository will be a <a href="http://habrahabr.ru/blogs/algorithm/65617/">self-balancing search tree</a> , having O (ln n) complexity for insert, search, delete operations (AVL tree, RB tree and others). </li><li>  The data structure is expanded by adding to the node information about the number of nodes in the subtree.  This is necessary in order to get the i-th element of the tree for O (ln n). </li><li>  The addition of an element in the tree is rewritten to recalculate the number of nodes in the subtree.  This can be done so that the cost of the add operation remains O (ln n). </li></ul>  I‚Äôve almost gotten ready to open Kormen and start remembering how the RB-tree works, but I stumbled upon an article about <a href="http://en.wikipedia.org/wiki/Skip_list">SkipList on Wikipedia</a> . <br><br><h4>  Skiplist </h4><br>  Skiplist is a randomized alternative to search trees based on several linked lists.  It was invented by William Pugh in 1989.  Searches, inserts and deletes are performed in logarithmically random time. <br><br>  This data structure is not widely known (by the way, it <a href="http://habrahabr.ru/blogs/algorithm/111913/">is written</a> quite clearly about it in <a href="http://habrahabr.ru/blogs/algorithm/111913/">Habr√©</a> ), although it has good asymptotic estimates.  Curiosity for the sake of it wanted to implement, the more there was a suitable task. <br><br>  Then I will give a brief squeeze from all sources that I used to solve. <br><br>  Suppose we have a sorted single-linked list: <br><img src="https://habrastorage.org/storage2/5d8/788/0af/5d87880afa538ea82250a01c735d5475.png"><br>  In the worst case, the search is performed in O (n).  How can you speed it up? <br><br>  In one of the video lectures, which I reviewed when I was working on the puzzle, I gave a wonderful example about express lines in New York: <br><br><img src="https://habrastorage.org/storage2/dee/77e/3ee/dee77e3ee55db10a75421b4dbf2690a6.png"><br><ul><li>  High-speed lines connect some stations. </li><li>  Normal lines connect all stations. </li><li>  There are regular lines between common high-speed line stations. </li></ul>  The idea is as follows: we can add a certain number of levels with a certain number of nodes in them, while the nodes in the levels should be evenly distributed.  Consider an example where half of the elements from the lower level are located on each of the upper levels: <br><br><img src="https://habrastorage.org/storage2/dd9/7a9/e55/dd97a9e55b8a4282e27344b07ca32db7.png"><br>  The example shows the perfect SkipList, in reality it looks like this, but a little bit wrong :) <br><br><h4>  Search </h4><br>  This is the search.  Suppose we are looking for the 72nd element: <br><br><img src="https://habrastorage.org/storage2/29b/594/71f/29b59471f39b30055edd72ceef276207.png"><br><br><h4>  Insert </h4><br>  With an insert all is a little more difficult.  In order to insert an element, we need to understand where to insert it in the lowest list and at the same time push it through to some number of higher levels.  But how many levels should each specific element be pushed through? <br><br>  It is proposed to solve this in the following way: when inserting, we add a new element to the lowest level and start throwing up a coin until it falls out, we push the element to the next higher level. <br>  Let's try to insert an element - 67. First we find where to insert it in the list below: <br><br><img src="https://habrastorage.org/storage2/785/ca6/577/785ca65778909cbc75c15a787e93f589.png"><br><br>  Supposed that the coin fell out twice in a row.  So you need to push the element up two levels: <br><br><img src="https://habrastorage.org/storage2/b96/f64/236/b96f64236a0b5476bb6ccc699fd82449.png"><br><br><h4>  Access by index </h4><br>  To access by index it is proposed to do the following: mark each transition with the number of nodes that lies under it: <br><br><img src="https://habrastorage.org/storage2/628/ac8/27b/628ac827bb6f3f482f5a2a5f02704b71.png"><br><br>  After we get access to the ith element (by the way, we get it for O (ln n)), it is not difficult to make the cut. <br><br>  Let it be necessary to find Range (5, 7).  First we get the element at index five: <br><br><img src="https://habrastorage.org/storage2/202/e83/d8b/202e83d8bb55076a46458bb1c5a2dc53.png"><br>  And now Range (5, 7): <br><br><img src="https://habrastorage.org/storage2/b85/568/bfc/b85568bfceaf7ef16a26b104aade442f.png"><br><h4>  About implementation </h4><br>  It seems a natural implementation when the SkipList node looks like this: <br><blockquote><code><font color="black">SkipListNode { <br> <font color="#0000ff">int</font> Element; <br> SkipListNode[] Next; <br> <font color="#0000ff">int</font> [] Width; <br> } <br></font></code> </blockquote>  Actually, it is made <a href="">in the implementation on the C from William Pug</a> . <br><br>  But in C #, its length is also stored in the array, and I wanted to do it for as little memory as possible (as it turned out, in the conditions of the task, everything was not assessed so strictly).  At the same time, I wanted to make the implementation of SkipList and extended RB Tree occupy approximately the same amount of memory. <br><br>  The answer to how to reduce memory consumption was unexpectedly found upon closer inspection of the <a href="http://fuseyism.com/classpath/doc/java/util/concurrent/ConcurrentSkipListMap-source.html">ConcurrentSkipListMap</a> from the java.util.concurrent package. <br><br><h4>  Two-dimensional skiplist </h4><br>  Let there be a single-linked list of all elements in one dimension.  In the second one there will be ‚Äúexpress lines‚Äù for transitions with links to the lower level. <br><blockquote> <code><font color="black">ListNode { <br> <font color="#0000ff">int</font> Element; <br> ListNode Next; <br> } <br> <br> Lane { <br> Lane Right; <br> Lane Down; <br> ListNode Node; <br> }</font></code> </blockquote> <h4>  Unfair coin </h4><br>  Even to reduce memory consumption, you can use the "dishonest" coin: reduce the likelihood of pushing an item to the next level.  The article by William Pugh considered a cut of several values ‚Äã‚Äãof the probability of pushing.  When considering the values ‚Äã‚Äãof ¬Ω and ¬º in practice, we obtained approximately the same search time with a decrease in memory consumption. <br><br><h4>  A bit about random number generation </h4><br>  Delving into the giblets of ConcurrentSkipListMap, noticed that random numbers are generated as follows: <br><blockquote> <code><font color="black"><font color="#0000ff">int</font> randomLevel() { <br> <font color="#0000ff">int</font> x = randomSeed; <br> x ^= x &lt;&lt; 13; <br> x ^= x &gt;&gt;&gt; 17; <br> randomSeed = x ^= x &lt;&lt; 5; <br> <font color="#0000ff">if</font> ((x &amp; 0x80000001) != 0) <br> <font color="#0000ff">return</font> 0; <br> <font color="#0000ff">int</font> level = 1; <br> <font color="#0000ff">while</font> (((x &gt;&gt;&gt;= 1) &amp; 1) != 0) ++level; <br> <font color="#0000ff">return</font> level; <br> }</font></code> </blockquote>  More information about the generation of pseudo-random numbers using XOR can be found <a href="http://www.jstatsoft.org/v08/i14/paper">in this article</a> .  I did not notice a special increase in speed, so I did not use it. <br><br>  The source of the resulting storage can be found <a href="">here</a> . <br><br>  All together you can pick up from <a href="http://code.google.com/p/pliner/">googlecode.com</a> (project Pagination). <br><br><h4>  Tests </h4><br>  Three types of storage were used: <br><ol><li>  ArrayBased (dynamic array) </li><li>  SkipListBased (SkipList with the ¬º parameter) </li><li>  RBTreeBased (red-ebony: the implementation of my friend, who performed a similar task). </li></ol>  Three types of tests for insertion of 10 ^ 6 elements were carried out: <br><ol><li>  Sorted items ascending </li><li>  Sorted by Descending Items </li><li>  Random items </li></ol>  Tests were conducted on a machine with i5, 8gb ram, ssd and Windows 7 x64. <br>  Results: <br><table><tbody><tr><th></th><th>  Array </th><th>  Rbtree </th><th>  Skiplist </th></tr><tr><td>  Random </td><td>  127033 ms </td><td>  1020 ms </td><td>  1737 ms </td></tr><tr><td>  Ordered </td><td>  108 ms </td><td>  457 ms </td><td>  536 ms </td></tr><tr><td>  Ordered by descending </td><td>  256337 ms </td><td>  358 ms </td><td>  407 ms </td></tr></tbody></table>  Quite expected results.  It can be seen that inserting into an array when an element is inserted somewhere, except at the end, is the slowest.  At the same time, SkipList is slower than RBTree. <br><br>  Measurements were also taken: how much each storage takes up in memory when 10 ^ 6 elements are inserted into it.  A studio profiler was used, for simplicity, the following code was run: <br><blockquote> <code><font color="black"><font color="#0000ff">var</font> storage = ... <br> <font color="#0000ff">for</font> ( <font color="#0000ff">var</font> i = 0; i &lt; 1000000; ++i) <br> storage.Add(i); <br></font></code> </blockquote>  Results: <br><table><tbody><tr><th></th><th>  Array </th><th>  Rbtree </th><th>  Skiplist </th></tr><tr><td>  Total bytes allocated </td><td>  8,389,066 bytes </td><td>  24,000,060 bytes </td><td>  23,985,598 bytes </td></tr></tbody></table>  Also quite expected results: the storage on the dynamic array took the least amount of memory, and SkipList and RBTree took about the same amount. <br><br><h4>  Happy End with Alenka </h4><br>  A colleague-whiner, according to the condition of the problem, lost a bar of chocolate to me.  My decision was credited with the maximum score.  I hope someone this article will be useful.  If you have any questions - I will be glad to answer. <br><br>  PS: I was on an internship at SKB Kontur.  This is not to answer the same questions =) </div><p>Source: <a href="https://habr.com/ru/post/139870/">https://habr.com/ru/post/139870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139860/index.html">DevBar - a pub for employees of the IT-industry and not only (St. Petersburg)</a></li>
<li><a href="../139862/index.html">Amazon Web Services + Ubuntu Server Cloud Guest</a></li>
<li><a href="../139863/index.html">Recommender systems: SVD Part I</a></li>
<li><a href="../139867/index.html">Microscopic 3D printing at 5 meters per second</a></li>
<li><a href="../139868/index.html">Clarification of the great quad-core confusion with Apple A5X</a></li>
<li><a href="../139871/index.html">Photo gallery on Django using Google Picasa as a hosting</a></li>
<li><a href="../139873/index.html">Tele2 and Radio Research Institutes begin two-week LTE testing in Omsk</a></li>
<li><a href="../139874/index.html">My migration experience from VMware Server to ESXi</a></li>
<li><a href="../139875/index.html">Solving the problem of lack of layout in codeigniter</a></li>
<li><a href="../139877/index.html">Microsoft is developing a universal voice translator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>