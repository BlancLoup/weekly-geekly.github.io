<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>History of visiting sites through Mikrotik router logs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my work, I often have to use these routers for solving my tasks. In this case, it was necessary to provide access to the Internet through the route...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>History of visiting sites through Mikrotik router logs</h1><div class="post__text post__text-html js-mediator-article"> In my work, I often have to use these routers for solving my tasks.  In this case, it was necessary to provide access to the Internet through the router RB450G, having the ability to block certain sites by the name mask and save the history of visits.  Next, an example of solving such a problem using free software will be shown. <br><a name="habracut"></a><br>  For a start, it was decided to configure a transparent proxy.  The router has its own Web-proxy, to make it transparent we execute according to the example in the documentation <br><br>  code&gt; ip firewall nat add in-interface = ether1 dst-port = 80 protocol = tcp action = redirect to-ports = 8080 chain = dstnat <br>  ip proxy set enabled = yes port = 8080 <br><br>  that sends requests to the 80 (HTTP) port on the port of the proxy server 8080. Now you can add blocked addresses, for example, 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>/ip proxy access add action=deny redirect-to=192.168.0.1/404 dst-host=:facebook</code> <br> <br>  In this case, requests containing the word ‚Äúfacebook‚Äù will be blocked and redirected to the internal page 192.168.0.1/404 (which is of course optional).  After the colon in the dst-host parameter, regular expressions can also be used. <br><br>  Then the question arose of how to actually accumulate and process the log of visits.  There was no built-in or other product from the manufacturer.  After reading the documentation and searching the thematic forums, the Webproxy-log product was found.  The product is somewhat clumsy, but prompting direction (although for a small load it will also fit perfectly).  How it works: <br>  1. In the logging destination setting, a section is added to transfer to the syslog server. <br><br> <code>/system logging action add name=proxylog target=remote remote=192.168.0.1 src-address=192.168.0.3 <br></code> <br><br>  192.168.0.1 - the address of the syslog server to which we will send the log.  192.168.0.3 - the internal address of the router. <br>  2. Create a section of the journal itself that will use the created destination and send proxy server logs there. <br>  . <br> <code>/system logging add topics=web-proxy action=proxylog</code> <br> <br>  At this stage, the router will send logs like <br><br><blockquote>  web-proxy, account 192.168.0.59 GET <a href="http://imgcdn.ptvcdn.net/pan_img/appDownload/PandoraService/Service_Info">imgcdn.ptvcdn.net/pan_img/appDownload/PandoraService/Service_Info</a> . <br>  xml action = allow cache = MISS <br>  web-proxy, debug GET /pan_img/appDownload/PandoraService/Service_Info.xml HTTP / 1.1 <br>  debug Cache-control web-proxy: no-cache <br>  debug Pragma web-proxy: no-cache <br>  web-proxy, debug Host: imgcdn.ptvcdn.net <br>  web-proxy, debug Accept: text / html, * / * <br>  web-proxy, debug Accept-Encoding: identity <br>  web-proxy, debug User-Agent: Mozilla / 3.0 (compatible; Indy Library) <br>  web-proxy, debug X-Proxy-ID: 1074695054 <br>  web-proxy, debug X-Forwarded-For: 192.168.0.59 <br>  debug Via web-proxy: 1.1 192.168.0.3 (Mikrotik HttpProxy) <br>  web-proxy, debug </blockquote><br><br>  where from the prefix web-proxy, account the address of the user who sent the request will be recorded, and the request itself. <br><br>  3. As a server, you can use the above <a href="https://code.google.com/p/webproxy-log/downloads/list">product</a> , which consists of two parts: <br>  <b>WebProxy Log Catcher</b> - an application (as a service is not installed) a simple syslog server itself that collects logs for further processing and adds time stamps. <br>  <b>WebProxy Log</b> is a log viewing interface that each time it starts importing the accumulated logs into the local database. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/1c7/c77/72b/1c7c7772b01031afc5042e4980a2f911.jpg" alt="image"><br><br>  Setting up the application does not cause difficulties and is sufficiently described in the documentation. <br><br>  Taking into account the simple format of the logs, it is not difficult to write your own log analyzer sent by the router and later a small service with a web interface was written for your own purposes, using Delphi and <a href="http://www.overbyte.be/frame_index.html%3FredirTo%3D/products/ics.html">ICS</a> components, which save logs to the database based on SQL server express. <br><br>  Perhaps all of the above will help you save time in solving such problems and will introduce you a bit to the capabilities of the routers of this manufacturer. </div><p>Source: <a href="https://habr.com/ru/post/179233/">https://habr.com/ru/post/179233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179221/index.html">Protecting open internet: let's keep W3C standards free without DRM</a></li>
<li><a href="../179225/index.html">How to become a programmer 1c</a></li>
<li><a href="../179227/index.html">What happens when a project that receives Kickstarter funding fails?</a></li>
<li><a href="../179229/index.html">Non-standard option of monetization of social services with the involvement of new users</a></li>
<li><a href="../179231/index.html">BitTorrent Bundle and Network Marketing</a></li>
<li><a href="../179235/index.html">Apache Thrift RPC Server. We are friends with C ++ and Java</a></li>
<li><a href="../179237/index.html">Shared laptop with session time limit</a></li>
<li><a href="../179239/index.html">We include Samsung Multi Window in another application</a></li>
<li><a href="../179241/index.html">Integration of 1C and Megaplan or why web services are good</a></li>
<li><a href="../179243/index.html">jQuery EasyUI Datagrid + Yii Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>