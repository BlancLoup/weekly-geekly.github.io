<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Crosswalk Project - replacement of Android WebView. Integration issues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will finish my story about the Crosswalk Project (you can find the first part here ). I will tell you in more detail about my Crossw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Crosswalk Project - replacement of Android WebView. Integration issues</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/272/9dd/d36/2729ddd365b246e1bc0fde65dd99ca95.png" alt="Crosswalkproject"><br><br>  In this article I will finish my story about the Crosswalk Project (you can find the first part <a href="http://habrahabr.ru/post/263649/">here</a> ).  I will tell you in more detail about my Crosswalk integration experience, some of the intricacies of working with it, the problems encountered and their possible solutions. <br><br>  The first and perhaps most obvious solution to all questions is to change the Crosswalk code to fit your needs.  This is possible because  the project is open and you can even help its authors.  However, this is not always necessary and may cause additional difficulties.  In the examples described, I do not consider this option, but it is useful to study the code of the base classes. <br><a name="habracut"></a><br><h2>  Control page loading in XWalkView. </h2><br>  Perhaps the second most important thing in the Crosswalk, after the speed of its work, is the predictability of the call to Kalbeks.  The ability to focus on call logic and have a single algorithm for all versions of Android is just fine.  The difficulties with load control in the system WebView are well described in <a href="http://habrahabr.ru/company/mailru/blog/262167/">this article</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As well as the system class, XWalkView has two helper classes that can receive calls while loading and working with XWalkView - these are XWalkUIClient and XWalkResourceClient.  As I wrote earlier, they have no direct correspondence with the system WebChromeClient and WebViewClient, the methods in them are distributed somewhat differently.  However, for myself, I set the approximate correspondence as WebChromeClient == XWalkUIClient and WebViewClient == XWalkResourceClient. <br><br>  XWalkUIClient also contains methods: <br><ul><li>  onPageLoadStarted - informs about the start of loading the main frame. </li><li>  onPageLoadStopped - informs about the end of loading of the main frame. </li></ul><br>  and: <br><ul><li>  onConsoleMessage </li><li>  onReceivedTitle </li><li>  onConsoleMessage </li><li>  onRequestFocus </li><li>  shouldOverrideKeyEvent </li></ul><br>  As you can see, there are methods included in both the WebViewClient interface and WebChromeClient, but, in general, the XWalkUIClient contains methods that are of importance to the UI. <br><br>  XWalkResourceClient including contains: <br><ul><li>  onDocumentLoadedInFrame - informs that the HTML document is received and processed, is called without waiting for the loading of css, images, etc.  NB!  I note that the method is described in Javadoc and implemented in the master branch, but is not currently in the class when integrated. </li><li>  onLoadStarted - informs you that the resource has started loading at the specified url. </li><li>  onLoadFinished - informs you that the resource has been loaded to the specified url. </li><li>  onProgressChanged - informs about the percentage of the page load. </li><li>  shouldInterceptLoadRequest - similar to the system callback, allows the client to return data for the specified url. </li><li>  shouldOverrideUrlLoading - similar to the system callback, allows the client to seize control before loading the resource. </li></ul><br>  The sequence of calling the main callbacks is as follows: <br><ul><li>  shouldOverrideUrlLoading - for the specified url; </li><li>  onPageLoadStarted; </li><li>  shouldInterceptLoadRequest - loading the main page; </li><li>  onLoadStarted - loading the main page (duplicates shouldInterceptLoadRequest); </li><li>  shouldInterceptLoadRequest paired with onLoadStarted - loading resources for each resource; </li><li>  onPageLoadStopped; </li><li>  onLoadFinished. </li></ul><br>  This sequence will be the same as for the url loaded using the WXalkView method, and to follow the link on the page and even when loading is stopped using stopLoading (). <br><br>  The sequence for downloading a page with a redirect looks almost the same: <br><ul><li>  shouldOverrideUrlLoading - for the specified url; </li><li>  onPageLoadStarted; </li><li>  shouldInterceptLoadRequest - loading the main page; </li><li>  onLoadStarted - loading the main page; </li><li>  shouldOverrideUrlLoading - for the url specified in the redirect; </li><li>  onPageLoadStarted; </li><li>  shouldInterceptLoadRequest paired with onLoadStarted - loading resources; </li><li>  onPageLoadStopped; </li><li>  onLoadFinished. </li></ul><br>  As you can see, during the transition through the redirect, we received additional calls for the same start-up callbacks and, in fact, the logic in this case also did not break. <br><br>  Additionally, you can specify that the onPageLoadStopped method has the following signature: <br><pre><code class="java hljs">onPageLoadStopped(XWalkView view, java.lang.String url, XWalkUIClient.LoadStatus status);</code> </pre> <br>  The additional parameter of the XWalkUIClient.LoadStatus type gives quite important information about how the download ended and has 3 options: <br><ul><li>  CANCELED - in the case of a call to stopLoading (); </li><li>  FAILED - in case of a loading error; </li><li>  FINISHED - normal download completion. </li></ul><br>  It was not without a couple of oddities in the behavior of Crosswalk.  For example, the onLoadFinished method is called only once after loading the entire page and even after onPageLoadStopped.  The logic assumes that the onLoadFinished call should correspond to the onLoadStarted call that occurs for each resource, but this is not the case now. <br><br>  It is also possible that a pair of final methods onPageLoadStopped and onLoadFinished will be called twice.  I found mention of <a href="http://comments.gmane.org/gmane.comp.web.crosswalk.help/1009">such behavior</a> even for Crosswalk of the 11th version, but apparently this problem has not been solved so far. <br><br><h2>  Handling events from the screen and buttons. </h2><br>  One of the first problems you will encounter when integrating XWalkView will be the handling of screen and keyboard events (specifically the Back buttons).  In XWalkView, as well as onActivityResult and onNewIntent methods, the following method is implemented: dispatchKeyEvent (KeyEvent event).  It intercepts events from the Back button to switch from full-screen mode and navigate through the browser history.  Accordingly, you cannot receive this event if you use the methods: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onKeyUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> keyCode, KeyEvent event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBackPressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br>  A solution may be to handle this event also in a dispatchKeyEvent (KeyEvent event).  It is also useful to know if you want to make your own navigation through the navigation history. <br><br>  A similar problem awaits you if you want to use the onTouchEvent listener for your XWalkView.  The solution is similar to the one above - implement event handling in a dispatchTouchEvent (MotionEvent event). <br><br>  Examples added to the test project available on <a href="https://github.com/yaroslav-v/crosswalk-embedded">GitHub</a> . <br><br><h2>  Work with cookie storage. </h2><br>  An important point in the browser and WebView is the handling of cookies.  For example, you want to load some page not through XWalkView, but display it in it and allow the user to work with it.  The page can set its own cookies and for normal operation they will be needed in the XWalkView. <br><br>  In Crosswalk, there is a special component <a href="">XWalkCookieManager</a> , which actually deals with the storage and <a href="">handling of</a> cookies.  Very strange, but it is not described in Javadoc, although it is public and available for use.  Implementation and comments on class methods can be found here. <br><br>  XWalkCookieManager, like the Crosswalk cache, is the same for all XWalkView instances in your application.  The class is quite simple to use and allows you to add and receive cookies for a specific address, clear the vault, and so on. Example of initialization: <br><pre> <code class="java hljs">mXCookieManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XWalkCookieManager(); mXCookieManager.setAcceptCookie(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mXCookieManager.setAcceptFileSchemeCookies(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  However, the simplicity of its implementation has some problems.  For example, the method for setting a cookie looks like this: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCookie</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url, String value)</span></span></span></span>;</code> </pre><br>  Accordingly, you will not be able to specify the lifetime for the cookie, and the domain and path for the cookie will be obtained from the specified url, but with some unpleasant nuances. <br><br>  For example, you want to set a cookie for <a href="https://m.vk.com/">m.vk.com</a> and assume that the cookie will be valid for <a href="https://login.vk.com/">login.vk.com</a> , but in this case it is not.  In order for XWalkCookieManager to adequately work out this point, you must set a cookie for the address <a href="http:">.vk.com</a> . <br><br>  It is also stated that XWalkCookieManager should update the cookie if you install an existing one in the repository, but I have observed that it sometimes duplicates the values.  Obviously some problems in parsing the value when installing.  Therefore, it is worth once again to check the correctness of the work of this class, if you use it. <br><br>  As a simple example of working with XWalkCookieManager, the test project implements the synchronization method with CookieManager. <br><br><h2>  Getting WebSettings and installing them. </h2><br>  As I wrote earlier, WebSettings are not available when working with the XWalkView and have predefined parameters.  More precisely in Crosswalk there is an analogue of this class - <a href="">XWalkSettings</a> , you can learn its methods here.  For some parameters, an exception was made and they are placed in the interface of the XWalkView class itself.  For example, now you can install the User-Agent you need. <br><br>  However, it may be necessary to fine tune.  It may also be necessary, as in my case, to get the User-Agent used by the XWalkView itself.  In this case, you can take the opportunity to get it through reflection. <br><br>  Actually, the XWalkView class itself is a superstructure over the <a href="">XWalkViewInternal</a> implementation and is connected to it via bridge through reflection.  XWalkViewInternal also has a public getSettings () method, which we can use: <br><pre> <code class="java hljs">Method ___getBridge = XWalkView.class.getDeclaredMethod(<span class="hljs-string"><span class="hljs-string">"getBridge"</span></span>); ___getBridge.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); XWalkViewBridge xWalkViewBridge = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; xWalkViewBridge = (XWalkViewBridge) ___getBridge.invoke(webView); XWalkSettings xWalkSettings = xWalkViewBridge.getSettings();</code> </pre><br>  As an example of getting XWalkSettings and working with it, the test project has a method for getting a User-Agent. <br><br><h2>  Get the XWalkView image. </h2><br>  Since XWalkView uses SurfaceView or TextureView for drawing, it‚Äôs not possible to get its image using standard methods.  For example, this option works for the system WebView, but does not work for XWalkView: <br><pre> <code class="java hljs">View view = mWebView.getRootView(); view.setDrawingCacheEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); Bitmap b = Bitmap.createBitmap(view.getDrawingCache()); view.setDrawingCacheEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre><br>  It happens because  standard view methods, such as getDrawingCache () or draw (), work with the software layer, while the XWalkView uses the hardware layer.  That is why developers are asked to set the android: hardwareAccelerated = ‚Äútrue‚Äù flag for applications using Crosswalk.  By the way, now it is set by default and there is no need to prescribe it separately. <br><br>  An XWalkView image is possible when using TextureView as the base, where there is a getBitmap () method.  In short, you need to find the target TextureView in the tree and call this method in it.  An example implementation is also available in the test project. <br><br><h2>  Small nuances. </h2><br>  In the appendage there are several minor points that you may also encounter during the integration process: <br><ul><li>  If you replace the system WebView in the old project and use the JavascriptInterface annotation, do not forget to fix the import.  Otherwise, get errors during the execution of JavaScript code.  Respectively: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.webkit.JavascriptInterface; <span class="hljs-comment"><span class="hljs-comment">// remove import org.xwalk.core.JavascriptInterface; // add</span></span></code> </pre><br></li><li>  If you use several XWalkView, use it in fragments or in some other, more complex than in the example conditions.  In this case, a situation may arise when it will be necessary to directly call methods to wake up the XWalkView timers, after resuming work with it: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeTimers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onShow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre><br></li></ul><br><br><h2>  findings </h2><br>  Using Crosswalk in the development is quite simple and convenient, especially considering the open source code.  A good community and a fairly large spread of the project will solve most problems. <br><br>  If you support Android 4.0+ and want more predictable work of your code on all versions of Android, then I definitely recommend Crosswalk. <br><br>  If you support Android from version 4.4 and especially 5.0, then I would think about using Crosswalk in your projects.  The lack of some new features of the system WebView can make life difficult for you. <br><br>  I hope my experience will help you decide what to use as a WebView for your project :). </div><p>Source: <a href="https://habr.com/ru/post/263655/">https://habr.com/ru/post/263655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263643/index.html">Load Balancing: Firebase + RabbitMQ</a></li>
<li><a href="../263645/index.html">Features of development for Xamarin.Forms</a></li>
<li><a href="../263647/index.html">TargetSummit - evening conference on analytics and promotion of mobile applications</a></li>
<li><a href="../263649/index.html">Crosswalk Project - replacement of Android WebView. Project Integration</a></li>
<li><a href="../263651/index.html">Node-RED node for converting locations into what3words addresses</a></li>
<li><a href="../263657/index.html">Feel Kotlin (and slightly Gradle) on the example of Posting-long-tweets (open source)</a></li>
<li><a href="../263665/index.html">Corporate Laboratories PENTESTIT: Modern IB Threats</a></li>
<li><a href="../263671/index.html">Compare .NET calendars. Experience first acquaintance</a></li>
<li><a href="../263673/index.html">ZeroRPC is a lightweight, reliable library for distributed communication between servers.</a></li>
<li><a href="../263675/index.html">Oracle Form Study with Java Development API (JDAPI)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>