<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Adventures of the Elusive Malvari, Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this article we begin a series of publications about the elusive Malvari. Hacking programs that do not leave an attack mark, also known as filele...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Adventures of the Elusive Malvari, Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/t5/7j/ep/t57jepsiopn5j3zbxlikd2ago-e.jpeg"><br><br>  With this article we begin a series of publications about the elusive Malvari.  Hacking programs that do not leave an attack mark, also known as fileless (‚Äúincorporeal‚Äù, invisible, fileless), usually use PowerShell on Windows systems to secretly execute commands to search and extract valuable content.  Detecting hacker activity without malicious files is a difficult task because  Antiviruses and many other detection systems work on the basis of signature analysis.  But the good news is that such software does exist.  For example, <a href="https://sites.varonis.com/ru/products/datalert/">UBA systems</a> capable of detecting malicious activity in file systems. <br><a name="habracut"></a><br>  When I first began to study the topic of cool hackers who <a href="https://www.varonis.com/blog/living-off-the-it-land-with-malware-less-hacking/">do not use traditional methods of infection</a> , but only tools and software available on the victim‚Äôs computer, I didn‚Äôt suspect that this would soon become a popular attack method.  Security professionals <a href="https://threatpost.com/hard-target-fileless-malware/125054/">say</a> that this is becoming a trend, and the <a href="https://www.csoonline.com/article/3227046/malware/what-is-a-fileless-attack-how-hackers-invade-systems-without-installing-software.html">frightening article headlines</a> are proof of that.  Therefore, I decided to make a series of publications on this topic. <br><br><h2>  Great and terrible PowerShell </h2><br>  I wrote about some of these ideas earlier in <a href="https://www.varonis.com/blog/powershell-obfuscation-stealth-through-confusion-part-i/">the PowerShell obfuscation series</a> , but more on the basis of a theoretical representation.  Later, I came across a <a href="https://www.hybrid-analysis.com/">site for hybrid analysis</a> , where you can find samples of Malvari ‚Äúcaught‚Äù in the wild.  I decided to try using this site to search for fileless malware samples.  And I managed it.  By the way, if you want to go on your own expedition to find malware, you will have to go through a check on this site so that they know that you are doing work as a white hat specialist.  As a blogger who writes about security, I passed it without question.  I'm sure you can too. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition to the samples themselves on the site you can see what these programs are doing.  Hybrid analysis runs malware in its own sandbox and monitors system calls, running processes and network activities, and also extracts suspicious text strings.  For binaries and other executables, i.e.  where you cannot even look at the actual high-level code, the hybrid analysis decides whether the software is malicious or just suspicious based on its activity at run time.  And after that the sample is already estimated. <br><br>  In the case of PowerShell and other sample scripts (Visual Basic, JavaScript, etc.), I was able to see the code itself.  For example, I came across such a PowerShell instance: <br><br><img src="https://habrastorage.org/webt/6l/vo/9a/6lvo9a-5fjn2damwm8vivmh2goc.jpeg"><br><br><p>  <i>You can also run PowerShell with base64 encoding to avoid detection.</i>  <i>Note the use of Noninteractive and Hidden parameters.</i> </p><br>  If you read my obfuscation entries, then you know that the -e option indicates that the content is encoded in base64.  By the way, hybrid analysis also helps with this, decoding everything back.  If you want to try to decode base64 PowerShell (hereinafter - PS) yourself, you need to run this command: <br><br><pre><code class="plaintext hljs">[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))</code> </pre> <br><h2>  Take it deeper </h2><br>  I decoded our PS script using this method, below is the text of the program, albeit slightly modified by me: <br><br><img src="https://habrastorage.org/webt/ro/ef/zi/roefzis_uwim8flbumkfqsvrvlu.jpeg"><br><p>  <i>Note that the creaking was tied to the date of September 4, 2017 and passed session cookies.</i> </p><br>  I wrote about this style of attack in <a href="https://www.varonis.com/blog/powershell-obfuscation-stealth-through-confusion-part-i/">the PS obfuscation series</a> , in which the base64-encoded script itself downloads the <i>missing</i> malware from another site, using the WebClient object from the .Net Framework library to do all the hard work. <br><br>  What is it for? <br><br>  For security software that scans Windows event logs or a firewall, base64 encoding prevents the detection of the ‚ÄúWebClient‚Äù string in a simple text pattern in order to protect against the execution of such a web request.  And since all the ‚Äúevil‚Äù malware is then downloaded and transmitted to our PowerShell, this approach thus makes it possible to completely evade detection.  Rather, I thought so at first. <br><br>  It turns out that with the inclusion of advanced logging in the Windows PowerShell log (see my article), you can see the downloaded line in the event log.  I (like <a href="https://www.wired.com/story/microsoft-powershell-security/">others</a> ) believe that Microsoft should enable this logging level by default.  Therefore, with the extended logging enabled, we will see in the Windows event log a completed boot request from the PS script, as we have described above.  Therefore, it makes sense to activate it, agree? <br><br><h2>  Add additional scripts </h2><br>  Hackers cleverly hide the PowerShell attack in Microsoft Office macros written in Visual Basic and in other scripting languages.  The idea is that the victim receives a message, for example, from a delivery service, with an attached report in the .doc format.  You open this document, which contains a macro, and ultimately it starts the malicious PowerShell. <br><br>  Often, the Visual Basic script itself is obfuscated in such a way that it freely evades antivirus and other malware scanners.  In the spirit of what has already been stated, I decided to code the above PowerShell in JavaScript as an exercise.  Below are the results of my work: <br><br><img src="https://habrastorage.org/webt/z6/4f/ek/z64fekt9zmny-mmfxihe8qgyfy8.jpeg"><br><p>  <i>Obfuscated JavaScript hiding our PowerShell.</i>  <i>Real hackers do it once or twice.</i> </p><br>  This is another technique I‚Äôve come across on the web: using Wscript.Shell to run coded PowerShell.  By the way, JavaScript itself is a <a href="https://nakedsecurity.sophos.com/2016/04/26/ransomware-in-your-inbox-the-rise-of-malicious-javascript-attachments/">means of</a> delivering malware.  Many versions of Windows have a built-in <a href="https://www.microsoft.com/resources/documentation/windows/xp/all/proddocs/en-us/wsh_overview.mspx%3Fmfr%3Dtrue">Windows Script Host</a> , which itself can run JS. <br>  In our case, the malicious JS script is attached as a file with the .doc.js extension.  Windows, as a rule, shows only the first suffix, so it will be displayed to the victim as a Word document. <br><br><img src="https://habrastorage.org/webt/ge/jy/pt/gejyptu4-xcxc87lweigj9yckqq.jpeg"><br><p>  <i>The JS icon is displayed only in the scroll icon.</i>  <i>Not surprisingly, many people will open this attachment, thinking that it is a Word document.</i> </p><br>  In my example, I modified the above PowerShell to download the script from my website.  The remote PS script simply prints "Evil Malware".  As you can see, he is not evil at all.  Of course, real hackers are interested in gaining access to a laptop or server, for example, through a command shell.  In the next article, I will show you how to do this using PowerShell Empire. <br><br>  I hope that for the first introductory article, we are not too deeply immersed in the topic.  Now I‚Äôll let you catch your breath, and next time we‚Äôll start to analyze real examples of attacks using fileless Malvari without unnecessary introductory words and preparation. </div><p>Source: <a href="https://habr.com/ru/post/456440/">https://habr.com/ru/post/456440/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456430/index.html">The eternal question of technical duty</a></li>
<li><a href="../456432/index.html">Security Week 25: Evernote Vulnerability and Hundreds of Hacked Online Stores</a></li>
<li><a href="../456434/index.html">Professions of the future: "Who will you work on Mars?"</a></li>
<li><a href="../456436/index.html">A short JS task for Monday</a></li>
<li><a href="../45644/index.html">Usability when designing a site - who is responsible?</a></li>
<li><a href="../456442/index.html">Recruitment to the St. Petersburg State University undergraduate program with the support of Yandex and JetBrains</a></li>
<li><a href="../456446/index.html">Ceph - from "on the knee" to "production"</a></li>
<li><a href="../456448/index.html">JS framework selection rules</a></li>
<li><a href="../456450/index.html">DO-RA.Avia for monitoring cosmic radiation in aviation</a></li>
<li><a href="../456452/index.html">C ++ code examples before and after Ranges</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>