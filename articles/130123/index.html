<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>mutex, spinlock, buslock. Overhead</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In search of an optimal synchronization mechanism, I often came across posts like mutex vs ..., but I didn‚Äôt get much clarity on these maps in my map....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>mutex, spinlock, buslock. Overhead</h1><div class="post__text post__text-html js-mediator-article">  In search of an optimal synchronization mechanism, I often came across posts like mutex vs ..., but I didn‚Äôt get much clarity on these maps in my map.  Therefore, I decided to write a small test comparing the overhead of different types of blocking mechanisms.  Perhaps we can say that the test measures the latency of the locking mechanisms.  Its essence is that a certain number of threads compete for the resource.  Resource - <pre><code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> incremented;</code> </pre>  ‚ÄúUseful‚Äù work - execute BIG_NUMBER increments. <br>  The purpose of the test is to estimate the costs of synchronization, that is to say, to build graphs of the dependence of time costs on the number of competing threads for different synchronization mechanisms. <br>  Bundles of threads (1..N pieces) perform the same number of increments, synchronizing in different ways. <br><br>  Further on the structure of the test and the results <br><a name="habracut"></a><br><h5>  PINC (Parallel INCrementor). </h5><br>  Sources and results are on <a href="https://github.com/korisk/pinc">githaba.</a>  You can download and run.  Here I do not cite them because they are cumbersome.  Limited to a brief description. <br>  So, there is a global variable incremented.  The volatile modifier is used so that when compiling with -O3, the variable does not fall into a register. <br>  For the sequential version, the test looks like this: <br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(long <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; BIG_NUMBER; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) incremented++;</code> </pre>  In the case of parallel execution, BIG_NUMBER should be equally divided between all threads, so it is convenient to choose it as the factorial of the maximum number of threads. <br>  Factor N! = 1 * 2 * ... * M * ... * (N-1) * N.  If we have M threads, then it is clear that each will get an equal number of increments. <br><br>  Active test blocks (in parentheses are the keywords appearing in the test): <br><ul><li>  The pure sequential increment is executed only in one thread (serial increment): <br><pre> <code class="hljs">incremented++;</code> </pre> </li><li>  Atomic increment (lock increment test) <br><pre> <code class="hljs lisp">__sync_fetch_and_add(<span class="hljs-name"><span class="hljs-name">&amp;incremented</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre>  Here we assume that this function is turned into something like ‚Äúlock xaddl ..‚Äù <br></li><li>  CAS intement (lock compare &amp; swap test) <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span>{ x = incremented; }<span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!__sync_bool_compare_and_swap(&amp;incremented,x , x + <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre>  and this one in ‚Äúlock cmpxchgl ..‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  Spinlock (spinlock test) <br><pre> <code class="hljs lisp">pthread_spin_lock(<span class="hljs-name"><span class="hljs-name">&amp;spin</span></span>)<span class="hljs-comment"><span class="hljs-comment">; incremented++; pthread_spin_unlock(&amp;spin);</span></span></code> </pre><br></li><li>  Mutex (test mutexed) <br><pre> <code class="hljs lisp">pthread_mutex_lock(<span class="hljs-name"><span class="hljs-name">&amp;mut</span></span>)<span class="hljs-comment"><span class="hljs-comment">; incremented++; pthread_mutex_unlock(&amp;mut);</span></span></code> </pre></li></ul><br><h5>  Test structure </h5><br><br>  Three functions are created for each active block.  Init, thread, fini - whose name speaks for itself.  Init is executed before the start of the bundle of threads, fini - after.  Thread - performs its share increments in each thread. <br>  All threads are transferred a data structure containing the number of running threads, the value of a ‚Äúlarge number‚Äù, and its own thread number.  Own thread number is used to bind a thread to a given processor according to the formula: <br> <code> = _ % _</code> <br>  The thread binding to the processor is made to ensure that the threads will be executed on different cores.  Binding is implemented using the pthread_setaffinity_np function. <br>  Each thread performs its share increments and ends.  The execution time is measured in milliseconds.  Next, run the next bunch of threads, or the next test. <br><br><h5>  results </h5><br>  A desktop computer was used as an experimental sample: <br>  CPU model name: Intel¬Æ Core (TM) 2 Duo CPU E8400 @ 3.00GHz <br>  Thread libs: NPTL 2.13 <br>  2 of 2 cores online <br>  Additition threads: 100 <br>  Big number: 11!  = 0x2611500 <br><br>  And this is what he gave out (The pictures are the same, but on different scales): <br>  Every point here is time taken at 11!  increments. <br><img src="http://habrastorage.org/storage1/d290379d/30110eda/dd0e3b38/bdbad86b.png"><br><img src="http://habrastorage.org/storage1/c78412c6/60295832/daefca85/6e1dc9ad.png"><br><img src="http://habrastorage.org/storage1/b9dfbc26/24f3a523/907b3a60/8f1e06d8.png"><br><br>  I will not start a philosophy about the advantages of individual mechanisms, since  everyone is focused on their tasks.  However, looking at the images is easy to estimate the overhead of each of them. <br>  In principle, everything is more or less predictable.  The only surprise is that sometimes spinlock is even better than CAS. <br>  It would be very interesting to see such graphics for machines with a large number of cores.  Unfortunately, I can not get data on a large range of architectures.  Therefore, I urge habra people to download the test from the <a href="https://github.com/korisk/pinc">github</a> and commit the results back or post here. <br><br>  Good luck. <br><br>  <b>Ps.</b>  <i>Using the dough is simple (-h help):</i> <i><br> <code>make;./pinc -f11 -t50</code> <br></i>  <i>Those.</i>  <i>will be executed BIG_NUMBER = 11!</i>  <i>increments for each synchronization mechanism in bundles of threads from 1 to (number_ cores + 50).</i> <i><br></i>  <i>If you get enough material, publish it here.</i>  <i>I think everyone will be interested.</i>  <i>Thank.</i> </div><p>Source: <a href="https://habr.com/ru/post/130123/">https://habr.com/ru/post/130123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130115/index.html">Golden T Game Engine (GTGE) - first acquaintance</a></li>
<li><a href="../130117/index.html">Secondary account authentication on the site</a></li>
<li><a href="../130118/index.html">Video review of Android applications and games - kedDroid</a></li>
<li><a href="../130120/index.html">Characteristic features of the Dart language</a></li>
<li><a href="../130122/index.html">Google Developer Day 2011: sections visited</a></li>
<li><a href="../130124/index.html">RU-CENTER resents</a></li>
<li><a href="../130125/index.html">TP-LINK Wireless Router Vulnerability</a></li>
<li><a href="../130127/index.html">Facebook has released an application for iPad</a></li>
<li><a href="../130128/index.html">Web browser in NeoAxis Engine - Integration of Awesomium and NeoAxis</a></li>
<li><a href="../130130/index.html">Asterisk for the head: how to recoup the investment?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>