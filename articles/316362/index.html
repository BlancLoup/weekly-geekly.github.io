<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GIS utilities: asynchronous model of interaction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to share experiences on interaction with GIS utilities. The next task, after installing a secure connection , was the organization of messa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GIS utilities: asynchronous model of interaction</h1><div class="post__text post__text-html js-mediator-article">  I continue to share experiences on interaction with GIS utilities.  The next task, after <a href="https://habrahabr.ru/post/311062/">installing a secure connection</a> , was the organization of messaging.  The developers of GIS utilities offer two models of interaction: synchronous and asynchronous.  Some developers choose the synchronous model because of its simplicity and accessibility.  In this article I will try to explain why it is necessary to use the asynchronous model and give hints on the implementation in C #. <br><a name="habracut"></a><br><h3>  Selection of interaction model </h3><br>  The synchronous model implies the classic "request-response".  You form the request object, send it to the GIS utilities, and the system keeps the connection until the answer is generated or the connection does not break on timeout. <br><br>  The asynchronous model is based on two operations: setting the task to execute the action and querying the status of the execution of the action (if necessary, repeat several times).  This model of interaction was called by developers of GIS utilities as preferred and recommended.  Next we look at these two operations in detail. <br><br><h4>  Setting a task to perform an action </h4><br>  To receive information or send data to the GIS utilities, you must fill in the request object.  It is there that the information ‚Äúfor which house you need to get information‚Äù or ‚Äúwhich personal accounts you need to create in the GIS utilities‚Äù is located. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The message also indicates the message identifier (MessageGUID), it uniquely identifies the message in the information system.  <b>A request with the same MessageGUID can be sent several times to the GIS utilities, and the GIS utilities ensures that it is executed once</b> .  For example, when setting a task for creating personal accounts, the request fell due to timeout or the connection was suddenly interrupted, we can then send the same request again with the confidence that we will not create unnecessary personal accounts. <br><br>  If you are sending an array of objects, each object is assigned a TransportGUID, it allows you to match the request and response objects.  For example, from the result of processing we will be able to find out why exactly this personal account from the entire message is not accepted by the GIS utilities. <br><br>  In response, we will receive another MessageGUID - request identifier in the GIS utilities.  It is for this identifier that the request execution status will be requested in the GIS utilities. <br><br><h4>  Query the status of the action </h4><br>  To get the execution status, you need to run a short getStateResult request.  It specifies the MessageGUID assigned in the GIS utilities.  This request can be sent several times. <br><br>  In response, we get the message processing status: accepted, in processing, ready.  If the message is processed, the GIS utilities return either the result of processing (the received object or information about sending data), or reports errors that occurred while processing the message.  The most common errors: ‚Äú <i>EXP001000: Internal error.</i>  "," <i>Access denied for the data provider organization "*" authority "*"</i> "," The <i>remote server returned an unexpected response: (502) Bad Gateway.</i>  "," <i>Listening to <a href="https://api.dom.gosuslugi.ru/">api.dom.gosuslugi.ru</a> * did not fulfill any endpoint that could receive the message.</i>  " And so on.  In fact, they divide messages into two types: those that can be sent again and those that no longer need to resend.  For myself, we decided that if we receive a processed GIS utilities error, we do not send the request again.  If the request fell off by timeout or a problem in our code, send the message again. <br><br><h3>  Typical errors GIS utilities </h3><br><ol><li>  The processing of the message on the side of the GIS utilities is not in the transaction. <br>  For example, we send a message to create 30 personal accounts, as a result we get ‚Äú <i>EXP001000: Internal error.</i>  ".  We rightly expect that none of the personal accounts has been created, but during the control check we see that ALL personal accounts have been created. <br><br></li><li>  Some requests ‚Äúhang‚Äù in the status ‚Äúaccepted‚Äù or ‚Äúin processing‚Äù for an indefinite time. <br>  Usually, the result of processing a message can be received in a few seconds, but some messages hang in the unprocessed status for several days; such messages should be marked on their side in order not to ask the processing status again. </li></ol><br>  Due to these "features", the process of sending information to the GIS utilities is divided into three stages: <br><br><ol><li>  We load information from the GIS housing and communal services for verification of a current state </li><li>  Sending the necessary information to the GIS housing and communal services </li><li>  A check check of the downloaded information, maybe something fell again with ‚Äú <i>EXP001000: Internal error.</i>  "And the information was created. </li></ol><br><h3>  The technical side of the interaction </h3><br>  Any process of interaction with GIS utilities consists of three stages: <br><br><ol><li>  Getting information for messages, saving it in the database </li><li>  Creating proxy objects for GIS utilities (remember, we work through WCF), sending a message, processing a response, saving MessageGUID GIS utilities </li><li>  Getting the result of processing, processing the result </li></ol><br><h4>  Posting </h4><br>  For each type of interaction, we create a table in the database, for example, ExportHouseInfoMessages or ImportLsMessages, in it we store all the necessary information to create a proxy message object that will be sent to the GIS utilities.  It is at this stage that we create MessageGuid messages. <br><br>  At this stage, you need to create messages only for those data for which no messages have been created yet or the result of processing has been received, otherwise you can duplicate the data. <br><br>  The main difficulty of this stage is to get the data necessary for sending from its information system.  For example, in GIS utilities need to send all the changes in personal accounts, and we did not have a history of changes in the right section. <br><br><div class="spoiler">  <b class="spoiler_title">C # implementation example</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       -   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TMessageDomain"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TSourceDomain"&gt;</span></span></span><span class="hljs-comment"> ,     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class CreateMessageCoreService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TSourceDomain&gt;</span></span></span><span class="hljs-comment"> where TMessageDomain : MessageDomain { private readonly ISourceService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSourceDomain&gt;</span></span></span><span class="hljs-comment"> _sourceService; private readonly IMessageDomainConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TSourceDomain&gt;</span></span></span><span class="hljs-comment"> _messageDomainConverter; private readonly IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> _messageDomainService; private readonly IOrgPPAGUIDService _orgPPAGUIDService; private readonly IGisLogger _logger; public CreateMessageCoreService(ISourceService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSourceDomain&gt;</span></span></span><span class="hljs-comment"> sourceService, IMessageDomainConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TSourceDomain&gt;</span></span></span><span class="hljs-comment"> messageDomainConverter, IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> messageDomainService, IOrgPPAGUIDService orgPPAGUIDService, IGisLogger logger) { _sourceService = sourceService; _messageDomainConverter = messageDomainConverter; _messageDomainService = messageDomainService; _orgPPAGUIDService = orgPPAGUIDService; _logger = logger; } public void CreateMessages(CoreInitData coreInitData) { var stopWatch = new Stopwatch(); stopWatch.Start(); try { //    ,      var sourceDomains = _sourceService.GetSourceDomains(coreInitData); // senderId   var orgPPAGUID = _orgPPAGUIDService.GetOrgPPAGUID(coreInitData.UkId); //      var messages = _messageDomainConverter.ToMessageDomain(sourceDomains, coreInitData, orgPPAGUID); //     _messageDomainService.InsertMessageDomains(messages); stopWatch.Stop(); _logger.Info(this.GetType(), $" {messages.Count}     {coreInitData.UkId}  {stopWatch.Elapsed}"); } catch (Exception ex) { _logger.Error(this.GetType(), $"    {coreInitData}", ex); } } }</span></span></code> </pre> <br></div></div><br><h4>  Sending messages </h4><br>  At this stage: <br><br><ul><li>  We lift messages from DB which need to be sent to the GIS housing and communal services </li><li>  Create a proxy for them message objects </li><li>  Sent to GIS utilities </li><li>  Get the MessageGUID GIS utilities </li><li>  Save it in the message in the database </li></ul><br><div class="spoiler">  <b class="spoiler_title">C # implementation example</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       -   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TMessageDomain"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TMessageProxy"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TAckProxy"&gt;</span></span></span><span class="hljs-comment">   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class SendMessageCoreService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TMessageProxy, TAckProxy&gt;</span></span></span><span class="hljs-comment"> where TMessageDomain : MessageDomain where TAckProxy : IAckRequestAck { private readonly IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> _messageDomainService; private readonly IMessageProxyConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TMessageProxy&gt;</span></span></span><span class="hljs-comment"> _messageProxyConverter; private readonly ISendMessageProxyProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageProxy, TAckProxy&gt;</span></span></span><span class="hljs-comment"> _sendMessageProxyProvider; private readonly ISendMessageHandler</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TAckProxy&gt;</span></span></span><span class="hljs-comment"> _sendMessageHandler; private readonly IGisLogger _logger; public SendMessageCoreService(IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> messageDomainService, IMessageProxyConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TMessageProxy&gt;</span></span></span><span class="hljs-comment"> messageProxyConverter, ISendMessageProxyProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageProxy, TAckProxy&gt;</span></span></span><span class="hljs-comment"> sendMessageProxyProvider, ISendMessageHandler</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TAckProxy&gt;</span></span></span><span class="hljs-comment"> sendMessageHandler, IGisLogger logger) { _messageDomainService = messageDomainService; _messageProxyConverter = messageProxyConverter; _sendMessageProxyProvider = sendMessageProxyProvider; _sendMessageHandler = sendMessageHandler; _logger = logger; } public void SendMessages(CoreInitData coreInitData) { var stopWatch = new Stopwatch(); stopWatch.Start(); try { //     //      //       var messages = _messageDomainService.GetMessageDomainsForSend(coreInitData); foreach (var messageDomain in messages) { try { //        var proxyMessageRequests = _messageProxyConverter.ToMessageProxy(messageDomain); //   var proxyAck = _sendMessageProxyProvider.SendMessage(proxyMessageRequests); //   _sendMessageHandler.SendSuccess(messageDomain, proxyAck); } catch (Exception exception) { //  _sendMessageHandler.SendFail(messageDomain, exception); } } stopWatch.Stop(); _logger.Info(this.GetType(), $" {messages.Count}    {coreInitData.UkId}  " + $"{messages.Count(x =&gt; x.Status == MessageStatus.Sent)} , " + $"{messages.Count(x =&gt; x.Status == MessageStatus.SendError)}   , " + $"{messages.Count(x =&gt; x.Status == MessageStatus.SendErrorTryAgain)}   ,  {stopWatch.Elapsed}"); } catch (Exception ex) { _logger.Error(this.GetType(), $"    {coreInitData}", ex); } } }</span></span></code> </pre> <br></div></div><br><h4>  Getting the result of processing the message </h4><br>  At this stage: <br><br><ul><li>  Raise messages from the database for which you want to get results </li><li>  We form a proxy object receiving processing status </li><li>  Sent to GIS utilities </li><li>  If the message has not yet been processed, save to the database that the message has not been processed.  If too much time has passed after sending the message, mark the message. </li><li>  If the message has a result, it needs to be processed.  This is usually the preservation of object identifier bindings in the GIS utilities and in our IS. </li></ul><br><div class="spoiler">  <b class="spoiler_title">C # implementation example</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       -    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TMessageDomain"&gt;</span></span></span><span class="hljs-comment">  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TGetStateResultProxy"&gt;</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TResultProxy"&gt;</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="TResult"&gt;</span></span></span><span class="hljs-comment">    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public class GetResultsCoreService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TGetStateResultProxy, TResultProxy, TResult&gt;</span></span></span><span class="hljs-comment"> where TMessageDomain : MessageDomain where TResultProxy : IGetStateResult { private readonly IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> _messageDomainService; private readonly IGetResultProxyProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TGetStateResultProxy, TResultProxy&gt;</span></span></span><span class="hljs-comment"> _getResultProxyProvider; private readonly IGetStateProxyConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TGetStateResultProxy, TMessageDomain&gt;</span></span></span><span class="hljs-comment"> _getStateProxyConverter; private readonly IResultConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResultProxy, TResult&gt;</span></span></span><span class="hljs-comment"> _resultConverter; private readonly ISaveResultService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult, TMessageDomain&gt;</span></span></span><span class="hljs-comment"> _saveResultService; private readonly IGetResultMessageHandler</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TResult&gt;</span></span></span><span class="hljs-comment"> _getResultMessageHandler; private readonly IGisLogger _logger; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,   ,      </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private const int GET_RESULT_TIMEOUT_IN_DAYS = 3; public GetResultsCoreService(IMessageDomainService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain&gt;</span></span></span><span class="hljs-comment"> messageDomainService, IGetResultProxyProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TGetStateResultProxy, TResultProxy&gt;</span></span></span><span class="hljs-comment"> getResultProxyProvider, IGetStateProxyConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TGetStateResultProxy, TMessageDomain&gt;</span></span></span><span class="hljs-comment"> getStateProxyConverter, IResultConverter</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResultProxy, TResult&gt;</span></span></span><span class="hljs-comment"> resultConverter, ISaveResultService</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TResult, TMessageDomain&gt;</span></span></span><span class="hljs-comment"> saveResultService, IGetResultMessageHandler</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TMessageDomain, TResult&gt;</span></span></span><span class="hljs-comment"> getResultMessageHandler, IGisLogger logger) { _messageDomainService = messageDomainService; _getResultProxyProvider = getResultProxyProvider; _getStateProxyConverter = getStateProxyConverter; _resultConverter = resultConverter; _saveResultService = saveResultService; _getResultMessageHandler = getResultMessageHandler; _logger = logger; } public void GetResults(CoreInitData coreInitData) { var stopWatch = new Stopwatch(); stopWatch.Start(); try { //       var messages = _messageDomainService.GetMessageDomainsForGetResults(coreInitData); foreach (var messageDomain in messages) { try { //    getState      var getStateProxy = _getStateProxyConverter.ToGetStateResultProxy(messageDomain); TResultProxy resultProxy; //  . //  false,      // true,      if (_getResultProxyProvider.TryGetResult(getStateProxy, out resultProxy)) { //        -   var result = _resultConverter.ToResult(resultProxy); //    _saveResultService.SaveResult(result, messageDomain); //       _getResultMessageHandler.Success(messageDomain, result); } else { if (messageDomain.SendedDate.HasValue &amp;&amp; DateTime.Now.Subtract(messageDomain.SendedDate.Value).Days &gt; GET_RESULT_TIMEOUT_IN_DAYS) { //        ,  _getResultMessageHandler.NoResultByTimeout(messageDomain); } else { //,      _getResultMessageHandler.NotReady(messageDomain); } } } catch (Exception exception) { //     _getResultMessageHandler.Fail(messageDomain, exception); } } stopWatch.Stop(); _logger.Info(this.GetType(), $" {messages.Count}    {coreInitData.UkId}  " + $"{messages.Count(x =&gt; x.Status == MessageStatus.Done)}  , " + $"{messages.Count(x =&gt; x.Status == MessageStatus.InProcess)}  , " + $"{messages.Count(x =&gt; x.Status == MessageStatus.ResponseTakingError)}   , " + $"{messages.Count(x =&gt; x.Status == MessageStatus.ResponseTakingErrorTryAgain)}   ,  {stopWatch.Elapsed}"); } catch (Exception ex) { _logger.Error(this.GetType(),$"    {coreInitData}", ex); } } }</span></span></code> </pre> <br></div></div><br><h3>  Conclusion </h3><br>  The asynchronous interaction model allows you to control the information sent to the GIS utilities through the agreement "one MessageGUID - one completed action."  Recommend! <br><br>  On <a href="https://github.com/nkochnev/gisframework">github</a> laid out the base classes that we use for interaction, tried to write the most detailed comments.  If you use this approach, it remains only to implement the logic of lifting data from your information system and process the result. </div><p>Source: <a href="https://habr.com/ru/post/316362/">https://habr.com/ru/post/316362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316350/index.html">Employee time tracking: Hard and Hardcore only</a></li>
<li><a href="../316352/index.html">The real truth about comparing CodeSonar and PC-lint</a></li>
<li><a href="../316354/index.html">How I grew up without Kodabra</a></li>
<li><a href="../316358/index.html">React, Web Components, Angular and jQuery are friends forever. Generic JavaScript Components</a></li>
<li><a href="../316360/index.html">What is Flussonic Watcher</a></li>
<li><a href="../316364/index.html">Version autoincrement in pom.xml via Jenkinsfile</a></li>
<li><a href="../316366/index.html">We invite you to a free webinar Oracle Cloud: PaaS Core Services</a></li>
<li><a href="../316368/index.html">Creating a blog engine with Phoenix and Elixir / Part 4. Add processing roles in controllers</a></li>
<li><a href="../316370/index.html">12 billion requests per month for $ 120 in java</a></li>
<li><a href="../316374/index.html">Under the hood of the new crafts Dell + EMC - flash storage at the price of disk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>