<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Design pattern "state" twenty years later</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="State is a behavioral design pattern. It is used in cases when, during the execution of a program, an object must change its behavior depending on its...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Design pattern "state" twenty years later</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/webt/dv/6v/qm/dv6vqmwengodjuefeodp4nvchrs.jpeg">  <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">State</a> is a behavioral design pattern.  It is used in cases when, during the execution of a program, an object must change its behavior depending on its state.  The classic implementation involves creating a base abstract class or interface containing all the methods and one class for each possible state.  The pattern is a special case of the recommendation ‚Äú <a href="https://refactoring.guru/replace-conditional-with-polymorphism">replace conditional statements with polymorphism</a> ‚Äù. <br><br>  It would seem that everything is on the book, but there is a nuance.  How to implement methods that are not relevant for this state?  For example, how to remove goods from an empty basket or pay for an empty basket?  Typically, each state class implements only relevant methods, and in other cases throws an <code>InvalidOperationException</code> . <br><br>  Violation of the principle of substitution Liskov on the face.  Yaron Minsky <a href="https://blog.janestreet.com/effective-ml-revisited/">suggested an alternative approach</a> : <i>make illegal states unrepresentable (make illegal states unrepresentable)</i> .  This makes it possible to postpone error checking from runtime to compile time.  However, the control flow in this case will be organized on the basis of pattern matching, rather than using polymorphism.  Fortunately, <a href="https://habrahabr.ru/post/257283/">partial matching of pattern matching appeared in C # 7</a> . <br><a name="habracut"></a><br><blockquote>  For more details on the example of F #, the topic <i>make illegal states unrepresentable is</i> disclosed on <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/">the Scott Vlashin website</a> . </blockquote><br>  Consider the implementation of the "state" on the example of the basket.  There is no built <a href="https://fsharpforfunandprofit.com/posts/discriminated-unions/">-in union</a> in C #.  Separate data and behavior.  The state itself will be encoded using enum, and the behavior of a separate class.  For convenience, we will declare an attribute connecting the enum and the corresponding behavior class, the base class of the ‚Äústate‚Äù, and we will add an extension method to switch from enum to the behavior class. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Infrastructure </h2><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Field)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type StateType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StateAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type stateType</span></span></span><span class="hljs-function">)</span></span> { StateType = stateType ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(stateType)); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">State</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span>: <span class="hljs-title"><span class="hljs-title">class</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">State</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T entity</span></span></span><span class="hljs-function">)</span></span> { Entity = entity ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(entity)); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> T Entity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateCodeExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> State&lt;T&gt; ToState&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Enum stateCode, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-comment"><span class="hljs-comment">// ,  reflection .   expression tree //  IL Emit    =&gt; (State&lt;T&gt;) Activator.CreateInstance(stateCode .GetType() .GetCustomAttribute&lt;StateAttribute&gt;() .StateType, entity); }</span></span></code> </pre><br><h2>  Subject area </h2><br>  Let's declare the ‚Äúbasket‚Äù entity: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IHasState</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TStateCode</span></span>, <span class="hljs-title"><span class="hljs-title">TEntity</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TEntity</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> { TStateCode StateCode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } State&lt;TEntity&gt; State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Cart</span></span> : <span class="hljs-title"><span class="hljs-title">IHasState</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Cart</span></span>.<span class="hljs-title"><span class="hljs-title">CartStateCode</span></span>, <span class="hljs-title"><span class="hljs-title">Cart</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> User User { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CartStateCode StateCode { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State&lt;Cart&gt; State =&gt; StateCode.ToState&lt;Cart&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Total { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;Product&gt; Products { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Product&gt;(); <span class="hljs-comment"><span class="hljs-comment">// ORM Only protected Cart() { } public Cart(User user) { User = user ?? throw new ArgumentNullException(nameof(user)); StateCode = StateCode = CartStateCode.Empty; } public Cart(User user, IEnumerable&lt;Product&gt; products) : this(user) { StateCode = StateCode = CartStateCode.Empty; foreach (var product in products) { Products.Add(product); } } public Cart(User user, IEnumerable&lt;Product&gt; products, decimal total) : this(user, products) { if (total &lt;= 0) { throw new ArgumentException(nameof(total)); } Total = total; } }</span></span></code> </pre><br>  We implement one class for each state of the basket: empty, active and paid, but we will not declare a common interface.  Let each state implement only relevant behavior.  This does not mean that the classes <code>EmptyCartState</code> , <code>ActiveCartState</code> and <code>PaidCartState</code> cannot implement one interface.  They can, but such an interface should contain only the methods available in each state.  In our case, the <code>Add</code> method is available in <code>EmptyCartState</code> and <code>ActiveCartState</code> , so you can inherit them from the abstract <code>AddableCartStateBase</code> .  However, you can add goods only to the unpaid shopping cart, so there will not be a common interface for all states.  Thus, we guarantee the absence of <code>InvalidOperationException</code> in our code at the compilation stage. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Cart</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CartStateCode: <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> { [State(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EmptyCartState))] Empty, [State(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ActiveCartState))] Active, [State(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(PaidCartState))] Paid } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAddableCartState</span></span> { <span class="hljs-function"><span class="hljs-function">ActiveCartState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span>; IEnumerable&lt;Product&gt; Products { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">INotEmptyCartState</span></span> { IEnumerable&lt;Product&gt; Products { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Total { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddableCartState</span></span>: <span class="hljs-title"><span class="hljs-title">State</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Cart</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IAddableCartState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddableCartState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart entity</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActiveCartState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { Entity.Products.Add(product); Entity.StateCode = CartStateCode.Active; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (ActiveCartState)Entity.State; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Product&gt; Products =&gt; Entity.Products; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EmptyCartState</span></span>: <span class="hljs-title"><span class="hljs-title">AddableCartState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EmptyCartState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart entity</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity</span></span></span><span class="hljs-function">)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ActiveCartState</span></span>: <span class="hljs-title"><span class="hljs-title">AddableCartState</span></span>, <span class="hljs-title"><span class="hljs-title">INotEmptyCartState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ActiveCartState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart entity</span></span></span><span class="hljs-function">): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PaidCartState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> total</span></span></span><span class="hljs-function">)</span></span> { Entity.Total = total; Entity.StateCode = CartStateCode.Paid; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (PaidCartState)Entity.State; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> State&lt;Cart&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Remove</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Product product</span></span></span><span class="hljs-function">)</span></span> { Entity.Products.Remove(product); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Entity.Products.Any()) { Entity.StateCode = CartStateCode.Empty; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Entity.State; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EmptyCartState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Entity.Products.Clear(); Entity.StateCode = CartStateCode.Empty; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (EmptyCartState)Entity.State; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Total =&gt; Products.Sum(x =&gt; x.Price); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PaidCartState</span></span>: <span class="hljs-title"><span class="hljs-title">State</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Cart</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">INotEmptyCartState</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Product&gt; Products =&gt; Entity.Products; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Total =&gt; Entity.Total; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PaidCartState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart entity</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entity</span></span></span><span class="hljs-function">)</span></span> { } } }</code> </pre><br>  States declared nested ( <i>nested</i> ) classes are not accidental.  Nested classes have access to the protected members of the <code>Cart</code> class, which means we don‚Äôt have to sacrifice the encapsulation of the entity to implement the behavior.  In order not to litter the entity class file, I divided the declaration into two: <code>Cart.cs</code> and <code>CartStates.cs</code> using the <code>partial</code> keyword. <br><br><h2>  Pattern matching </h2><br>  Since there is no common behavior between different states, we cannot use polymorphism for control flow.  Here <a href="https://habrahabr.ru/post/257283/">pattern matching</a> comes to the rescue. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetViewResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State&lt;Cart&gt; cartState</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cartState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Cart.ActiveCartState activeState: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(<span class="hljs-string"><span class="hljs-string">"Active"</span></span>, activeState); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Cart.EmptyCartState emptyState: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(<span class="hljs-string"><span class="hljs-string">"Empty"</span></span>, emptyState); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Cart.PaidCartState paidCartState: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(<span class="hljs-string"><span class="hljs-string">"Paid"</span></span>, paidCartState); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(); } }</code> </pre><br>  Depending on the state of the basket, we will use different views.  For an empty basket, we will display the message ‚ÄúYour basket is empty‚Äù.  In the active basket will be a list of products, the ability to change the quantity of goods and remove some of them, the button "checkout" and the total amount of the purchase. <br><br>  The paid basket will look the same as the active one, but without the possibility to edit something.  This fact can be noted by highlighting the <code>INotEmptyCartState</code> interface.  Thus, we not only got rid of the violation of the Liskov substitution principle, but also applied the principle of interface separation. <br><br><h2>  Conclusion </h2><br>  In the application code, we can work on the <code>IAddableCartState</code> and <code>INotEmptyCartState</code> interface links to reuse the code responsible for adding products to the cart and displaying the items in the cart.  I believe that pattern matching is suitable for control flow in C # only when there is nothing in common between types.  In other cases, the work on the base link is more convenient.  A similar technique can be applied not only to encode the behavior of an entity, but also to <a href="https://habrahabr.ru/post/322168/">the data structure</a> . </div><p>Source: <a href="https://habr.com/ru/post/341134/">https://habr.com/ru/post/341134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341122/index.html">Yulmart game theory</a></li>
<li><a href="../341126/index.html">Vibe.js - an attempt to make state management without pain</a></li>
<li><a href="../341128/index.html">Economic experiments in virtual reality</a></li>
<li><a href="../341130/index.html">Chronology of CO level in the atmosphere of the USA (solution of the Kaggle problem using Python + Feature Engineering)</a></li>
<li><a href="../341132/index.html">Environment for developing TypeScript and React web applications: from 'hello world' to modern SPA. Part 2</a></li>
<li><a href="../341138/index.html">Step-by-step tutorial on working with Antlr4 with Maven project for Java through Intellij Idea</a></li>
<li><a href="../341140/index.html">Bonus vs depreirovanie</a></li>
<li><a href="../341142/index.html">We look for typo names in PostgreSQL</a></li>
<li><a href="../341144/index.html">What every C programmer should know about Undefined Behavior. Part 2/3</a></li>
<li><a href="../341146/index.html">$ mol - the best cure for hemorrhoids</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>