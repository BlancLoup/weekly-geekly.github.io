<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart home, as I sunk to such. Part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first three parts, I described how I had the idea (necessity) of building a ‚Äúsmart home‚Äù and how I brought it to life. 

 In this part, I will ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart home, as I sunk to such. Part 4</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/673/c21/49a/673c2149a8f545a489d87fdc79f93d38.png" align="right">  In the <a href="http://habrahabr.ru/post/158911/">first</a> <a href="http://habrahabr.ru/post/167797/">three</a> <a href="https://geektimes.ru/post/258212/">parts,</a> I described how I had the idea (necessity) of building a ‚Äúsmart home‚Äù and how I brought it to life. <br><br>  In this part, I will tell you what shortcomings were identified during the four years of operation of the system, and what other useful things could be implemented. <br><br>  Well, a small spoiler: under the cut there will be a brief description of ‚Äúthe next crafts on esp8266 with preference and courtesans‚Äù. <br><a name="habracut"></a><br>  So, four years have passed (since the beginning of the operation of the first modules, so generally six). In general, the system performed well, but two shortcomings surfaced, however, quite expected. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>The first</b> is centralization.  Yes, this is bad, yes, I knew about it, but there was no experience in the production of end-user devices, and the 1-Wire protocol chosen as the main one did not provide such an opportunity. <br><br>  Accordingly, the central server has become a bottleneck.  Five times because of the failure of the ‚Äúiron‚Äù, the whole system did not work for more than a day (or even two or three) and had to use the backup system (turn on the lights in the switchboard, do without a heated floor, ventilation, recalibrate water meters, etc. d.). <br><br>  Plus, in the house there have been frequent power outages for more than an hour.  The UPS charge ended and the server made an emergency shutdown, and, more precisely, it was very rudely cut down.  After that, its rise was not always smooth, mainly because MySQL does not like such a boorish attitude to itself.  Restoring tables (and there the whole story on all sensors for many years) sometimes took hours and it was not always possible for him to do this without outside intervention.  Yes, this problem, theoretically, can be solved by purchasing a smarter UPS, connecting it to the server and teaching the server to shut down regularly when power is lost.  But my current UPS is quite a vigorous old man, and even the motherboard of the server, for some reason, did not want to work normally in the mode, automatically turning on after power-up, if it was previously turned off. <br><br>  <b>The second</b> is a restriction on the topology of the 1-Wire bus + my inexperience. <br><br>  Yes, I read that there should be a central trunk and only small branches, about which it is written a lot.  But the project was expanding quite unpredictably and at the same time everything seemed to work.  And then, in one ‚Äúwonderful‚Äù moment, it stopped working.  That is, turn off some of the devices, everything is fine, turn on again and the signal starts to "float."  Replaced some of the main lines with shielded ones, minimized the branches, but it is no longer possible to make a full-fledged single tire without a perforator and significant damage to the finish.  As a result, I broke the network into two segments, brought it to two separate controllers, but, nevertheless, once in a couple of months the problem arose again when the devices started falling out of the network.  Only the complete shutdown of the entire system with subsequent switching on helped, but this procedure is not very trivial and my homework is not able to carry it out without me. <br><br>  In the meantime, about two years ago, I came across an <a href="https://geektimes.ru/post/255450/">article</a> and I had an idea to make a peculiar birthday present to my father.  He is keen on breeding various <a href="http://forum.tetis.ru/viewtopic.php%3Ff%3D11%26t%3D73732">exotic plants</a> in the garden and needs constant temperature control in different climatic zones of his garden.  Actually, before the introduction of the system, it was carried out bypassing completely (warm tube lamps :)) analog alcohol thermometers twice a day.  I hatched this idea for several months, then I ordered the necessary components in one well-known (then only in narrow circles) Chinese online store, made a fee, wrote the firmware.  In general, it turned out something like this: <br><br>  The entire system is housed in a standard telephone jack. <br><br><img src="https://habrastorage.org/web/23e/c8b/463/23ec8b463f9b422690f0450114e8f8bd.jpg"><br><br>  Four-wire telephone wiring. <br><br><img src="https://habrastorage.org/web/867/69b/f6a/86769bf6a95c4874b79c0fcef21d21e2.jpg"><br><br>  Power passive.  For the pool ordered a waterproof version of the sensor. <br><br><img src="https://habrastorage.org/web/a02/cfb/1d2/a02cfb1d2afe484fb4152487770ddf49.jpg"><br><br>  Now dad is watching the temperature on the computer. <br><br>  Like this: <br><br><img src="https://habrastorage.org/web/bf8/cc2/ac2/bf8cc2ac299d46828efdde149450e16c.png"><br><br>  Well, with graphs: <br><br><img src="https://habrastorage.org/web/e80/81a/b51/e8081ab518b642d981f137d36f8dd63c.png"><br><br><div class="spoiler">  <b class="spoiler_title">Module circuit</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/527/063/d86/527063d865224257a0972905e113a78e.png"></div></div><br>  In the development process, I really liked this module and I began to think how to use it in my system, and then the problems described in the beginning of the article just came over.  After another couple of experiments with these chips, I began to develop the board, which has now successfully replaced the old system in the three zones of my modest home. <br><br>  So, your attention is ‚Äúesp07_4PIO_6S v2‚Äù. <br><br>  View from above: <br><br><img src="https://habrastorage.org/web/bc6/355/f9e/bc6355f9e1d0428dbe96062bfc45255e.jpg"><br><br>  Bottom view: <br><br><img src="https://habrastorage.org/web/994/af8/090/994af809019345c4825d343ae62f7bee.jpg"><br><br>  The last time a big problem was the selection of the corps, so this time I danced from the corps.  Since there were cases from the old models of the Dune media player, the choice fell on them.  After completion with a file (the holes for the inputs and outputs of the media player are slightly different, it was not possible to connect 220v to the HDMI connector :)) it was perfect.  Only the temperature sensor had to be done outside, as the inside heats up the air. <br><br>  220v inputs and outputs <br><br><img src="https://habrastorage.org/web/ff9/e7e/811/ff9e7e8111054a59b12bf901b3d55b00.jpg"><br><br>  Inputs and Outputs to 5v and 12v <br><br><img src="https://habrastorage.org/web/58b/8a0/634/58b8a063416c4c31ab6032f6f04acdcc.jpg"><br><br>  What can this module and why is it better than the old system? <br><br><ul><li>  No additional wiring is required for installation.  It is powered from the same network that it controls. </li><li>  When the central server or Wi-Fi is disconnected or unavailable, it switches to offline mode and manages offline control (the script for each zone can have its own) </li><li>  Removes data on temperature / humidity / light in the room. </li><li>  It controls 4 devices 220, reads data from 6 sensors of the ‚Äúdry contact‚Äù type. </li><li>  Able to independently send data to thingspeak.com and similar systems. </li><li>  Reacts faster than the old system (not that this was a problem, but earlier each sensor was polled twice per second, which could give a total lag of more than a second).  This system works by interruption. </li><li>  Able to update the firmware "through the air." </li></ul><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/eb8/0e5/be6/eb80e5be61aa4ca48208f5a3d37d5ee5.png"></div></div><br>  It was not possible to dissolve such a fee in one layer, so we had to master a two-sided LUT: <br><br><div class="spoiler">  <b class="spoiler_title">Pay</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/aca/fde/89f/acafde89f1d74d9bb695ee3b2bcc39f2.png"></div></div><br>  Operating experience is already more than six months, plans to replace all the control parts of the system with this module, leave only monitoring to 1-Wire. <br><br>  Considering wishes for past articles, <a href="https://github.com/sashacmc/smarthome-esp">diagrams</a> and <a href="https://github.com/sashacmc/smarthome-esp-nodemcu">code</a> are available on <a href="https://github.com/sashacmc/">github</a> .  The old ones are also there, suddenly someone will come in handy. <br><br>  Something like this.  Put likes and subscribe to new videos :) Joke, anyway, a new article, if it does, then in a couple of years, the Chukchi is not a writer: P <br><br>  Although, if you have questions about the firmware and architecture esp07_4PIO_6S, I will write a detailed article about this craft, there are, in my opinion, some interesting solutions. </div><p>Source: <a href="https://habr.com/ru/post/403973/">https://habr.com/ru/post/403973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../403963/index.html">4D printing: new materials, changing characteristics and shape</a></li>
<li><a href="../403965/index.html">Nothing more: a review of the player HiFiMan MegaMini</a></li>
<li><a href="../403967/index.html">Flag DataArt over Elbrus</a></li>
<li><a href="../403969/index.html">New practical workshop on May 20</a></li>
<li><a href="../403971/index.html">International blockchain-conference Genesis Moscow Conference will be held in Moscow on May 26</a></li>
<li><a href="../403975/index.html">Is it true that the world has become a more dangerous place for children than it was before?</a></li>
<li><a href="../403977/index.html">Satire with brains: for the first time Moscow will host the festival of crazy scientific theories ‚ÄúWell, also science‚Äù</a></li>
<li><a href="../403979/index.html">3D printing of ovaries helped give birth to a sterile mouse</a></li>
<li><a href="../403981/index.html">Universal Yogi. Review of the laptop transformer Lenovo Yoga 720</a></li>
<li><a href="../403983/index.html">Brawex LED Bulbs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>