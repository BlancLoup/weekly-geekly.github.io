<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Minimal mail server based on Postfix and Dovecot. Part 1: Dovecot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objective: get a minimally working mail server using only Postfix and Dovecot, with minimal changes to the default settings. Get the skeleton of the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Minimal mail server based on Postfix and Dovecot. Part 1: Dovecot</h1><div class="post__text post__text-html js-mediator-article">  Objective: get a minimally working mail server using only Postfix and Dovecot, with minimal changes to the default settings.  Get the skeleton of the system, based on which you can, in the future, configure spam filters, work with databases, LDAP ... <br>  The mail system should: <br><ol><li>  Maintain any number of domains and users. </li><li>  Serve users who are not tied to local accounts. </li><li>  Provide access to mailboxes via POP3, IMAP protocols with TLS support. </li><li>  To provide sending and reception of letters via SMTP protocol with TLS support. </li></ol><br>  Setup was carried out in CentOS 6. Postfix 2.6.6, Dovecot 2.0.9.  No OS features applied. <br><a name="habracut"></a><br><h3>  The structure of the postal system </h3><br>  Conventionally, mail systems can be divided according to the method of access to mailboxes and the list of users. <br><table><tbody><tr><td><h4>  Classic mail system </h4>  Postfix, Dovecot have access to the list of users and work in parallel, sharing access to user mailboxes. </td><td><h4>  Simplified Mail System </h4>  Dovecot is a ‚Äúbackend‚Äù for accessing user mailboxes.  With this approach, the location of the mailboxes, the list of users, is known only to Dovecot.  This is the approach we will use to achieve our goal. </td></tr><tr><td> <a href=""><img src="https://habrastorage.org/files/193/307/ec4/193307ec4a44419d8b4f26e1fea27935.png" alt="image"></a> </td><td> <a href=""><img src="https://habrastorage.org/files/efa/1fb/659/efa1fb659aed43f2a6eb5bc240a12223.png" alt="image"></a> </td></tr></tbody></table><br>  The main advantages of the classical system compared to the simplified: <br><ol><li>  Performance.  Postfix has access to mailboxes and can be faster and easier than in the second case, to deliver mail directly to the user. </li><li>  Independence of system parts from each other.  In case Dovecot is disabled, Postfix will continue its main function - to receive letters. </li></ol><br>  The main disadvantages of the classical system compared with the simplified: <br><ol><li>  Mailbox format should be understandable to both programs. </li><li>  It is necessary to synchronize access to mailboxes. </li><li>  Security.  Additional permissions are required for Postfix.  Postfix should have direct access to mailboxes and the list of users. </li><li>  Setup and maintenance is a bit more complicated. </li></ol><br><h3>  Dovecot </h3><br>  Despite the fact that Dovecot is a core system that performs many functions.  Its setup should not cause any difficulties.  Perhaps this is due to the fact that Dovecot only deals with authenticated clients, which is not the case with Postfix.  Names will be set in the format username @ domainname. <br><ol><li>  Create a user "vmail" to store mail, without the "shell" of access, but with the home folder "/ home / vmail". <br><br></li><li>  Configure authentication. <br><pre><code class="cmake hljs">auth_mechanisms = plain login</code> </pre>  (login is the same plain but for Outlook) <br><pre> <code class="cmake hljs">mail_gid = vmail mail_uid = vmail</code> </pre>  Restricting the transfer of a password only after establishing a TLS connection is performed in Dovecot by default and does not require additional settings.  Since we will use TLS, we do not need any other authentication mechanisms, only PLAIN.  The self-signed certificate, in CentOS, is created when Dovecot is installed in the / etc / pki / dovecot / certs / folder, we will use it for now to configure TLS. <br>  <em>I want to draw your attention to one important point.</em>  <em>It is necessary to distinguish the authentication mechanism from the method of storing the authentication data.</em>  <em>Although these two concepts may be called the same, they are two different things.</em>  <em>Details <a href="http://wiki2.dovecot.org/Authentication">here</a> and <a href="http://wiki2.dovecot.org/Authentication/Mechanisms">here</a> .</em> <br><br></li><li>  Set up where we will store user mailboxes. <br>  For each virtual user, set the home folder in the format - / home / vmail / domain / username, <br><pre> <code class="cmake hljs">mail_home = /home/vmail/%d/%n</code> </pre>  and the location of mail in the home folder is / home / vmail / domain / username / Maildir, <pre> <code class="cmake hljs">mail_location = maildir:~/Maildir</code> </pre>  <em>Maildir format Maildir is chosen to simplify the transition to the classical system, if necessary, because</em>  <em>Postfix supports Maildir.</em>  <em>But if you do not plan to return to the classic system, you can choose any mailbox format <a href="http://wiki2.dovecot.org/MailboxFormat">supported by Dovecot</a> .</em> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </li><li>  The following two directives specify where and how Dovecot will look for user names and passwords. <br><pre> <code class="cmake hljs">userdb { args = username_format=%u /etc/dovecot/users driver = passwd-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> } passdb { args = scheme=ssha512 username_format=%u /etc/dovecot/users driver = passwd-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> }</code> </pre>  We used the file / etc / dovecot / users, which has the format of a standard password file / etc / passwd. <br>  Sample password file (password cut off): <br><pre> <code class="cmake hljs">user1@example1.com:{SSHA512}<span class="hljs-number"><span class="hljs-number">2</span></span>YT51xuhilbvb4vYRIb1oj1EvrKFszhf2MNw=:::::: user3@example3.com:{SSHA512}GdBv9GEE1rfFpd4+fzXS+UKh4x6gTpTaH4=::::::</code> </pre>  For security, we do not store user passwords in clear text, but store their salted SHA512.  To fill in the file "/ etc / dovecot / users", we will use this script with two parameters, username and user password. <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo $1:$(doveadm pw -s ssha512 -p $2):::::: &gt;&gt; /etc/dovecot/users</span></span></code> </pre> <br></li><li>  Let's configure services for communication with Postfix. <br>  To search for usernames and SASL authentication. <br><pre> <code class="cmake hljs">service auth { unix_listener /var/spool/postfix/private/auth { group = postfix mode = <span class="hljs-number"><span class="hljs-number">0660</span></span> user = postfix } unix_listener auth-userdb { mode = <span class="hljs-number"><span class="hljs-number">0600</span></span> user = vmail } }</code> </pre>  For access to user mailboxes. <br><pre> <code class="cmake hljs">service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { group = postfix mode = <span class="hljs-number"><span class="hljs-number">0600</span></span> user = postfix } user = vmail } protocol lmtp { postmaster_address = postmaster@example1.ru }</code> </pre>  You can read in more detail: here about <a href="http://wiki2.dovecot.org/LMTP">LMTP</a> , here about <a href="http://wiki2.dovecot.org/HowTo/PostfixDovecotLMTP">LMTP and Postfix</a> , and here about <a href="http://wiki2.dovecot.org/HowTo/PostfixAndDovecotSASL">SASL</a> . <br></li></ol><br><div class="spoiler">  <b class="spoiler_title">Summary ‚Äúdevconf ‚ÄìN‚Äù:</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment"># 2.0.9: /etc/dovecot/dovecot.conf # OS: Linux 2.6.32-504.16.2.el6.x86_64 x86_64 CentOS release 6.6 (Final) auth_mechanisms = plain login mail_gid = vmail mail_home = /home/vmail/%d/%n mail_location = maildir:~/Maildir mail_uid = vmail mbox_write_locks = fcntl passdb { args = scheme=ssha512 username_format=%u /etc/dovecot/users driver = passwd-file } service auth { unix_listener /var/spool/postfix/private/auth { group = postfix mode = 0660 user = postfix } unix_listener auth-userdb { mode = 0600 user = vmail } } service lmtp { unix_listener /var/spool/postfix/private/dovecot-lmtp { group = postfix mode = 0600 user = postfix } user = vmail } ssl_cert = &lt;/etc/pki/dovecot/certs/dovecot.pem ssl_key = &lt;/etc/pki/dovecot/private/dovecot.pem userdb { args = username_format=%u /etc/dovecot/users driver = passwd-file } protocol lmtp { postmaster_address = postmaster@example.com }</span></span></code> </pre><br></div></div><br>  Now it is enough to add user names and passwords to the / etc / dovecot / users file, and mailboxes will be created automatically after the first successful user authentication.  Or, looking ahead, after the user receives the letter. <br>  <a href="http://habrahabr.ru/post/258407/">Part 2: Postfix</a> . </div><p>Source: <a href="https://habr.com/ru/post/258279/">https://habr.com/ru/post/258279/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258265/index.html">Live broadcast of DevCon conference on May 20 and 21</a></li>
<li><a href="../258267/index.html">DevCon 2015. Join the broadcast today from 10:30! What is the first day we cook?</a></li>
<li><a href="../258269/index.html">DevCon 2015. Join the broadcast today at 09:00! What is the second day we cook?</a></li>
<li><a href="../258275/index.html">Modern operating systems. 4th ed</a></li>
<li><a href="../258277/index.html">Virtual reality as a trend, a new report from App Annie, not a word about Apple Watch - and other news of the week for a mobile developer</a></li>
<li><a href="../258281/index.html">Release of a new version of WordPress 4.2 Powell and a security breach</a></li>
<li><a href="../258283/index.html">Install AirSlax on a virtual machine. Work with WiFi</a></li>
<li><a href="../258285/index.html">What is TLS</a></li>
<li><a href="../258287/index.html">Habrahabr appropriated to everyone according to the ‚Äúdog‚Äù</a></li>
<li><a href="../258289/index.html">Cach√© audit log analysis using Cach√© (DeepSee)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>