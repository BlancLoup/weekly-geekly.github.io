<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Christmas music card</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="New Year and Christmas holidays are on the nose, and many are concerned about giving to friends and family. 
 Actually, I was concerned about the same...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Christmas music card</h1><div class="post__text post__text-html js-mediator-article">  New Year and Christmas holidays are on the nose, and many are concerned about giving to friends and family. <br>  Actually, I was concerned about the same question.  And I got such an idea - to make a music card.  Of course, the idea is not new - our Chinese brothers are making them in large quantities and at a low price.  But I was not going to compete with the Chinese, I just wanted to have something of my own.  And, as it seems to me, a good result was obtained: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/MifybJTXKDs%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhiyGJmd2sIPtXvmV9Q7A6vvuefYiw" frameborder="0" allowfullscreen=""></iframe><br><a name="habracut"></a><br><br><h5>  TK </h5><br>  To begin with, I formulated such requirements: <br>  In the open state, the card should play a melody in a circle. <br>  I chose Shchedryk or Carol Of The Bells as the melody. <br>  It is desirable that the melody was polyphonic. <br>  The scheme should be as simple as possible, contain a minimum of parts, easy to repeat, and be inexpensive.  And most importantly - fit in the card. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Analysis </h5><br>  I had long been going to do microcontrollers, and for the experiments I bought several pieces of the cheapest - attiny13, so I decided to make a circuit based on these microcontrollers. <br>  To begin with, I figured out whether it will be possible to realize what was planned on this MK, and if so, in what way.  For this, I found and downloaded <a href="http://makingmusicfun.net/pdf/sheet_music/carol-of-the-bells-piano.pdf">notes</a> , and began to analyze. <br>  The melody in the memory of the MC can be written in many ways, 2 options came to my mind: 1) as a note number in each time interval corresponding to the minimum note duration, and 2) in the format duration ‚Äî note.  The first option is naturally easier to implement.  I think: in the song there are 25 measures, 16 of which are repeated twice, i.e.  total 41 beats.  The minimum note length is 1/8, and the measure size is 3/4, therefore, in one measure, 6 notes of the minimum duration, and the whole melody will contain 6 (notes in measure) * 41 (measure) * 3 (voices) = 738 notes.  If spending one byte on each note leaves a bit too much, since attiny13 contains 1024 bytes of flash memory in total (and you need to place another program and a table of frequencies).  Therefore, it is worth trying the second method.  I think: only 263 notes (including pauses) is already acceptable, even if you use a byte for the duration, and a byte for the height of the note, you get 526 bytes. <br>  I decided to write in assembler - firstly, in order to better understand the MK itself, and secondly - to fit in the remaining 700 bytes. <br>  MK tiny13 has 2 PWM on board, with which you can make a two-part tune.  But for this melody you need 3 voices, so you can‚Äôt use PWM alone to generate sound.  For simplicity, I decided to abandon the use of PWM - at least in the first version of the device. <br><br><h5>  Scheme </h5><br>  At first I decided to display each voice of the melody on a separate leg of the MK.  Therefore, initially the scheme was as follows: <br><br><img src="https://habrastorage.org/storage2/d06/d74/d88/d06d74d88d43bb0a1895c330223b52a0.png"><br><br>  Later it turned out that with this switch on the music sounds very quiet.  To solve this problem, all the voices had to be mixed into one channel, and the result was applied to the two MK outputs in antiphase - thanks to this, the voltage change on the piezoelectric element turned out to be 2 times the supply voltage.  The scheme was even simpler: <br><br><img src="https://habrastorage.org/storage2/c1f/201/9d9/c1f2019d90b10bfcee0329459bc18c98.png"><br><br><h5>  Algorithm </h5><br>  In order to get the sound of a given frequency at the output of the MC, it is necessary to divide its clock frequency into a number-coefficient equal to the frequency of the MC / specified frequency.  Since the division operations (and the calculation of the remainder by module) are absent in the AVR command list, we will divide by the counter.  Initially, the division factor is assigned to the counter, and 1 is subtracted at the next cycle. If the counter is zero, then the signal has changed at the divider, and the value on a specific MK leg must be changed, and the value-coefficient will be written back to the counter. <br>  Divisor counters need 4 pieces: one for each voice, and one more for counting notes (and determining the tempo). <br>  The algorithm works as follows: <br><br>  1) initialize variables <br>  2) if the count-divider of notes is zero, then for each voice, check whether the current note has finished playing, and if it has finished playing, load the next one from memory. <br>  3) for each voice, reduce the counter by 1, if it is zero, reassign the division factor to it, and change the value at the output. <br>  4) transition to 2 <br><br>  In order for this algorithm to work, it is necessary that each program cycle be executed in the same number of cycles.  To do this, it was necessary to calculate all the branches of the branches, and add a nop or empty loop for too ‚Äúnimble‚Äù sections. <br><br>  At first, when the sound was output to the three outputs of the MC, the waveform was in the form of a meander.  Then, when I had to mix all this up and out through 2 pins out of phase (i.e. in fact, through one pin), there was a problem how to mix these three voices.  Therefore, it was decided to make a waveform in the form of short pulses, and sum them with a simple or `a. <br><br><h5>  Program code </h5><br>  The source code of the program can be found <a href="http://pastebin.com/nySbsS4y">here.</a> <br><br><h5>  Iron </h5><br>  When implementing the final version, the following tasks arose: <br>  1) food <br>  2) on-off <br>  Task 1 I solved with the help of a cr2016 lithium battery, which according to this article should have a capacity of approximately 90 mAh.  I placed the battery in a self-made compartment from a paper clip, as I did not find an acceptable size and price for the industrial compartment.  The circuit consumes about 2 mA, so this battery should be enough for 40 hours, which is more than enough. <br>  Task 2, I initially thought to solve using the same clips, but then abandoned this idea in favor of the reed switch and magnet.  The principle of operation is visible on the video. <br><br><h5>  Firmware </h5><br>  I compiled and flashed in AVR Studio 4, with firmware in fusion, I changed only the clock frequency to 4.8 MHz and turned off the division into 8 frequencies of the master oscillator. <br><br><h5>  Budget </h5><br>  Microcontroller - 8 UAH <br>  Piezo element - 2 UAH <br>  Battery - 4 UAH <br>  Reed switch - 2 UAH <br>  Development, debugging of the program - 6 hours <br>  Development, testing scheme - 3 hours <br>  Production of one postcard (in the presence of an etched board) - 1 hour <br><br><h5>  A photo </h5><br><img src="https://habrastorage.org/storage2/36f/f1a/737/36ff1a7371ff24654f04a7b2c49f6772.jpg"><br>  First prototype <br><br><img src="https://habrastorage.org/storage2/046/81e/1bc/04681e1bca7b5edb24f18f869116fa91.jpg"><br>  Second prototype <br><br><img src="https://habrastorage.org/storage2/1dc/43d/c8d/1dc43dc8d0adea03b94cabe564a8f19b.jpg"><br>  Battery mount <br><br><img src="https://habrastorage.org/storage2/311/bdf/841/311bdf8416f5d351ae4d17169f44f8e7.jpg"><br>  Finished device - view from the details <br><br><img src="https://habrastorage.org/storage2/7be/55d/803/7be55d803071a85f3c26a0567660edc6.jpg"><br>  Finished device - view from the back <br><br><img src="https://habrastorage.org/storage2/f1d/a31/d7b/f1da31d7bf3efec9a44502b91f393b23.jpg"><br>  First episode <br><br><h5>  PS </h5><br>  Happy New Year and Merry Christmas! </div><p>Source: <a href="https://habr.com/ru/post/135124/">https://habr.com/ru/post/135124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135117/index.html">Spam in November 2011: New Year crept in unnoticed</a></li>
<li><a href="../135119/index.html">Video: Introduction to MPS</a></li>
<li><a href="../135120/index.html">A gift from the company should also please!</a></li>
<li><a href="../135121/index.html">Launched beta new "Rambler News"</a></li>
<li><a href="../135123/index.html">Simple compilation of Scala code at runtime.</a></li>
<li><a href="../135126/index.html">What happened to google?</a></li>
<li><a href="../135130/index.html">Connecting the network to global IPv6 space</a></li>
<li><a href="../135131/index.html">Multicore CPU for UAVs</a></li>
<li><a href="../135134/index.html">A preliminary review of the tablet Samsung Galaxy Tab 7.7 or "Wow, my favorite size" ;-)</a></li>
<li><a href="../135135/index.html">Determination of resistance by the controller without ADC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>