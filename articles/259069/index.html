<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Memory Optimization DataTable</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many people are familiar with the DataTable class. Subtracting large tables from a database to a client through ADO.NET, sometimes it is neces...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Memory Optimization DataTable</h1><div class="post__text post__text-html js-mediator-article">  I think many people are familiar with the <b>DataTable</b> class.  Subtracting large tables from a database to a client through ADO.NET, sometimes it is necessary to extend the lifetime of instances of this class for a long time.  For example, if you need processing and analysis of the data, without resorting to ORM materialization (yes, it would be better to do this in the database, but not all can sometimes be put there).  When the amount of data is small, there is no particular problem with this.  However, on wide tables with a large number of rows, you can get quite thick objects in memory.  Comparing the amount of data coming from the database and the size of the resulting <b>DataTable</b> , you can come to two conclusions: <br><br><ul><li>  With large amounts of <b>varchar</b> data, among which there is duplication, you can try to organize some kind of internment of string data within the <b>DataTable</b> ; </li><li>  <b>DataTable</b> contains a fairly hefty internal infrastructure.  Manipulating data types and the number of rows in a table, it was possible to establish that the percentage of overhead costs is 15-20% for tables of 100 thousand records.  Most of the infrastructure provides correct editing and other table functionality.  In the case when you require the <b>DataTable to</b> be a simple container for data obtained from the database, then you can write an easy gutted analogue of this class. </li></ul><br><a name="habracut"></a><br>  The question of replacing the <b>DataTable</b> with the internal structure will be discussed in the next article if it is interesting.  Now consider the first item.  As is known, string interning is to eliminate duplicate <b>string</b> in memory (you can read more here).  We will not use the built-in mechanism of internment so that the lines do not hang in the process memory after they no longer need us. <br><br>  The idea is to bypass all the varchar columns in the table, and in each column replace all duplicates with a link from the temporary dictionary, in which the lines will be in a single copy.  The state of the heap before and after will be as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/11c/a87/606/11ca8760639949b088b0922a811034d4.png"><br><br>  It is worth noting that the data in the <b>DataTable is</b> stored in columns, not in rows, as one would expect.  This is due to lower memory costs - because  all the values ‚Äã‚Äãof the same type in the columns can be used for storing regular arrays with constant access time by index.  For speed, we will read directly from these arrays via reflection ( <b>FieldInfo</b> ). <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,            private static readonly FieldInfo StorageField = typeof (DataColumn).GetField("_storage", BindingFlags.Instance | BindingFlags.NonPublic); private static readonly FieldInfo ValuesField = typeof (DataTable).Assembly.GetType("System.Data.Common.StringStorage") .GetField("values", BindingFlags.Instance | BindingFlags.NonPublic);</span></span></code> </pre> <br>  As I mentioned above, we will use a <b>Dictionary</b> to store instances of strings in a single copy in memory. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exclusiveStrings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;();</code> </pre><br>  <b>Key</b> will be needed only for a hash, <b>Value</b> - for a reference to a single instance in memory.  It is worth noting that the resulting collisions <b>Dictionary</b> resolves using the basket method. <br><br>  Full method code: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     .        . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="table"&gt;</span></span></span><span class="hljs-comment">.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">  .</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static DataTable Compact(this DataTable table) { if (table.Rows.Count == 0) return table; var exclusiveStrings = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, string&gt;</span></span></span><span class="hljs-comment">(); for (int column = 0; column </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; table.Columns.Count; ++column) { if (table.Columns[column].DataType == typeof(string)) { //     ( ) var values = (string[])ValuesField.GetValue(StorageField.GetValue(table.Columns[column])); int rowCount = table.Rows.Count; for (int row = 0; row &lt; rowCount; ++row) { var value = values[row]; if (value != null) { string hashed; if (!exclusiveStrings.TryGetValue(value, out hashed)) //    exclusiveStrings.Add(value, value); else //  values[row] = hashed; } } exclusiveStrings.Clear(); } } return table; }</span></span></span></span></code> </pre><br>  We estimate the complexity of the resulting algorithm for a particular column.  The complexity in this case consists of two main parts: bypassing all n values ‚Äã‚Äãand searching the <b>Dictionary</b> by key.  With the first part, everything is clear, but with the search a little more interesting.  In the most fantastically bad case, when all n values ‚Äã‚Äãlead to a collision and lie in one basket, the complexity of the search will be reduced to linear.  But, given the implementation of the hash function for a string in .NET, this thought cannot cause anything but a smile.  The same thing was decided by the <b>Dictionary</b> developers, since  The documentation for <b>TryGetValue declares</b> <b>O (1)</b> complexity.  Thus, within a single column, the expected complexity is reduced to <b>O (n)</b> .  For the entire table, <b>O (mn)</b> , where <b>m</b> is the number of string columns. <br><br>  Consider the speed on real data: <br><br><img src="https://habrastorage.org/files/0b8/d20/595/0b8d205954dd4e719e6c9de629ab9841.png"><br><br>  As can be seen, the complexity is linear, as was evident from the analysis of the algorithm.  Regarding the cost of memory, then for the algorithm at every step, filling the dictionary, creates a new pointer and deletes references to lines if it finds a duplicate. <br><br>  It is easy to see that the efficiency of the algorithm depends on the input data: if there are a lot of duplicates, then more memory will be freed.  In my tasks, memory was reduced by 30-50%.  But, again, you might be different. <br><br>  I hope someone will find this solution as useful as me. </div><p>Source: <a href="https://habr.com/ru/post/259069/">https://habr.com/ru/post/259069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259053/index.html">The second version of the Evernote SDK for Android: new Evernote features in your applications</a></li>
<li><a href="../259055/index.html">We test Spring Rest controllers: simpler, shorter, more reliable. Spring Security Test + JSON Matcher</a></li>
<li><a href="../259057/index.html">SMS chat on my knees</a></li>
<li><a href="../259065/index.html">Digest news of the gaming industry</a></li>
<li><a href="../259067/index.html">Simple Web Service with Jetty Embedded</a></li>
<li><a href="../259071/index.html">New to Wolfram SystemModeler: FMI Import</a></li>
<li><a href="../259073/index.html">Browser history sniffing using favicon</a></li>
<li><a href="../259075/index.html">Creating AUX input for Kenwood GX806EF2 radio with i2c bus grab</a></li>
<li><a href="../259077/index.html">Encryption of personal correspondence. Friday post</a></li>
<li><a href="../259081/index.html">24 hours PASS - review of the SQL conference reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>