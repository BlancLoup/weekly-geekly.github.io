<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your cloud hosting in 5 minutes. Part 1: Ansible, Docker, Docker Swarm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! The last 1.5 years I have been working on my project, which required reliable cloud hosting. Up to this point, I have been engaged in web pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your cloud hosting in 5 minutes. Part 1: Ansible, Docker, Docker Swarm</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/post/261415/"><img src="https://habrastorage.org/files/9da/64c/145/9da64c1451b64c2a837426efc4562666.jpg" alt="Cloud hosting"></a> <br><br>  Hi Habr!  The last 1.5 years I have been working on my project, which required reliable cloud hosting.  Up to this point, I have been engaged in web programming for more than 10 years and when I decided to build my hosting, I had relatively superficial knowledge in this area, and now I am not a system administrator.  All that I will be telling can be done by an ordinary programmer within 5 minutes, simply by running a set of scripts for Ansible, which I prepared specially for you and <a href="https://github.com/vkozlovski/ansible-cloud-hosting">uploaded to GitHub</a> . <br><a name="habracut"></a><br>  My goal is to give you a list of tools and a general understanding that you would know what to build on if you need your own cloud hosting.  When choosing the tools I used, I was guided by simplicity, quality of documentation and stability.  Before you use all this in your production, you should definitely consult with your system administrator ( <i>I use some components that are in BETA status (June 2015)</i> ). <br><br><h4>  <font color="#d62631">Content</font> </h4><br><ul><li>  Part 0: <a href="https://habrahabr.ru/post/277657/">Virtualization</a> </li><li>  Part 1: Ansible, Docker, Docker Swarm </li><li>  Part 2: <a href="http://habrahabr.ru/post/262397/">Service Discovery</a> </li><li>  Part 3: <a href="http://habrahabr.ru/post/264269/">Consul, Registrator, Consul-Template</a> </li><li>  ... </li></ul><br><h1>  <font color="#d62631">Why your hosting?</font> </h1><br>  The main reason - I wanted to get the necessary experience.  I am increasingly moving away from programming and dealing with administrative issues.  A good entrepreneur has to go all the way himself and work, if possible, in all positions, to understand how everything works, how to manage it, from which people and what to demand, how to evaluate their work and themselves. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second reason is the specifics of my project, it is related to the privacy of personal data.  I have no reason for someone to just trust their data, and my users more.  I am very concerned about this issue, and I am concerned that so little attention is paid to it. <br><br>  The last reason in the goals and orientations of a startup in Russian realities.  Here, the main goal is to start making money and get a plus.  No profit - no startup, there is an unprofitable hobby.  Therefore, the third reason is the cost.  I now have ~ 9Tb of traffic and ~ 5Tb of data that I regularly process, costing me all this ~ $ 100 / month ( <i>you can calculate how much it will cost on AWS)</i> .  I know that next month I will have the same value, and I build a project with my own money. <br><br><h1>  <font color="#d62631">Training</font> </h1><br>  The first thing to do is to get 3 servers in one data center ( <i>they should be located as close as possible to each other, so that the ping between them is minimal</i> ).  It does not matter whether they are virtual dedicated servers ( <i>at the time of testing</i> ) or real ones and from which provider you rent them.  I ordered from DigitalOcean, chose a Debian 8.1 x64 installation and indicated to add my SSH key: <br><br><img src="https://habrastorage.org/files/371/171/807/37117180712644e59eca4305d55c5ff3.png"><br><br>  The installation is complete and we have at our disposal 3 ‚Äúbare‚Äù servers: <br><br><img src="https://habrastorage.org/files/3d1/81b/3bb/3d181b3bb1fc4b4f9851faaf7fb83a82.png"><br><br><h1>  <font color="#d62631">Ansible</font> </h1><br>  As you already understood, we will use <a href="http://www.ansible.com/home">Ansible</a> to configure our servers.  If you do not know what it is and how to use it, then on Habr√© there are answers to these questions: <br><br><ol><li>  <a href="http://habrahabr.ru/company/selectel/blog/196620/">Ansible control system</a> </li><li>  <a href="http://habrahabr.ru/post/195048/">Ansible</a> </li><li>  <a href="http://habrahabr.ru/company/express42/blog/254959/">Ansible - let's try</a> </li></ol><br>  No one has canceled the <a href="http://docs.ansible.com/index.html">official documentation</a> ( <i>if you have no problems reading the documentation in English, then I would recommend this source of information</i> ). <br><br>  Ansible is not the only configuration management system (there is <i><a href="https://puppetlabs.com/">Puppet</a> , <a href="https://www.chef.io/">Chef</a> , <a href="http://saltstack.com/">Salt</a> , etc.</i> ), so why exactly is it? <br><br>  As I wrote above, one of the priorities when choosing tools is simplicity.  There is no need to install clients on managed machines ( <i>everything works via SSH</i> ), the scripting language is extremely simple, the project has fresh and detailed documentation, and the module code is written in Python ( <i>which is an advantage for us because Python is the main language in a startup</i> ). <br><br><div class="spoiler">  <b class="spoiler_title">Thoughts of simplicity</b> <div class="spoiler_text">  In general, for me, simplicity is a sign of a deep understanding of the subject.  If one person ( <i>familiar with the subject</i> ) cannot explain to another person ( <i>with a subject not familiar</i> ) how he works, then he himself does not fully understand this subject. <br><br>  This is well revealed in Steve Wozniak's book ‚ÄúSteve Jobs and Me,‚Äù where his father begins to tell the principles of electrical engineering to Steve when he has not yet reached four years (the <i>book will be of interest to all engineers, even if you are not interested in the story of Apple</i> ). <br></div></div><br>  At this stage, Ansible should be installed on your client machine ( <i><a href="http://docs.ansible.com/intro_installation.html">instruction</a></i> ).  I, on OS X 10.9, for this I needed to execute only 2 commands: <br><br><pre><code class="bash hljs">¬ª sudo easy_install pip <span class="hljs-comment"><span class="hljs-comment">#       PIP ¬ª sudo pip install ansible</span></span></code> </pre> <br>  Check that everything is OK: <br><br><pre> <code class="bash hljs">¬ª ansible --version ansible 1.9 configured module search path = None</code> </pre><br><br><h1>  <font color="#d62631">Docker</font> </h1><br><img src="https://habrastorage.org/files/61f/ce7/e62/61fce7e62d934436b306a3bfcbfa7a3c.png" alt="Docker"><br>  This is without a doubt one of the best tools I have met in the last few years.  That <a href="https://www.docker.com/">Docker</a> will be the heart of our cloud hosting, giving it a truly great potential. <br><br>  "Out of the box" we get access to a huge number of <a href="https://registry.hub.docker.com/">ready-made images</a> that we can instantly perform in our cloud.  We have the opportunity to independently run the necessary services of different versions at the same time, to test compatibility or meet the dependencies of our web applications. <br><br>  We can launch 20 containers with the 1st version of our web application, 2 containers with the 2nd version and distribute the load between them, show the new version only ~ 10% of visitors, assessing the stability of work and user reviews. <br><br>  Now you need to install Docker on the client machine, we will need it to manage the future Docker cluster.  The easiest way to do this is to <a href="https://kitematic.com/download">download the Kitematic GUI client</a> ( <i>available for Mac OS X 10.9+ and Windows 7+ 64-bit)</i> , go to the main menu and select Install Docker Commands to install Docker console commands. <br><br><img src="https://habrastorage.org/files/dd1/7d9/1b0/dd17d91b03704bc4a5af68299718286b.png"><br><br>  Alternative installation options can be found in the <a href="http://docs.docker.com/">official documentation</a> ( <i>it is well written and updated in a timely manner</i> ).  To make sure that everything is in order, you can as follows: <br><br><pre> <code class="bash hljs">¬ª docker version Client version: 1.6.2 Client API version: 1.18 Go version (client): go1.4.2 Git commit (client): 7c8fca2 OS/Arch (client): darwin/amd64</code> </pre><br><br><h1>  <font color="#d62631">Docker swarm</font> </h1><br><img src="https://habrastorage.org/files/064/f34/34b/064f3434bba04ad3bb7fbcd091ad810c.png" alt="Docker swarm"><br>  Finally, we have reached the most interesting, to the point that will give our hosting "cloudiness".  Strange, but I did not find any information about <a href="http://docs.docker.com/swarm/">Docker Swarm</a> on Habr√©. <br><br>  Docker Swarm is used to combine multiple Docker hosts into one virtual host and does it elegantly.  Docker Swarm provides a <a href="https://docs.docker.com/reference/api/docker_remote_api/">Docker API</a> compatible <a href="http://docs.docker.com/swarm/api/swarm-api/">REST</a> <a href="https://docs.docker.com/reference/api/docker_remote_api/">API</a> .  Thus, all tools that work with the Docker'a API (Docker'a <i>client, Dokku, Compose, Krane, Flynn, Deis, DockerUI, Shipyard, Drone, Jenkins, etc.</i> ) can work with Docker Swarm, not suspecting that a Docker cluster is behind him, not just one machine. <br><br>  Let's build our cloud and, in practice, take a look at what Docker Swarm is capable of. <br><br><h1>  <font color="#d62631">Getting started</font> </h1><br>  At this point, Ansible and Docker should be installed on your client machine.  There should be 3 servers with authorization by key and Debian 8.1 x64 on board ( <i>you can use any other distribution kit, making minor changes to the script</i> ).  I have prepared a set of scripts for Ansible that will do all the work for you, so you will not need much time. <br><br>  Download a <a href="">set of scripts</a> or clone the repository: <br><br><pre> <code class="bash hljs">¬ª git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vkozlovski/ansible-cloud-hosting ¬ª git checkout v1.x ¬ª <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ansible-cloud-hosting</code> </pre><br>  We open the <b>stage</b> file and replace the IP addresses with the IP of our servers in it: <br><br><pre> <code class="markdown hljs">[cloud] 188.166.16.70 debian<span class="hljs-emphasis"><span class="hljs-emphasis">_release=testing hostname=debian1 188.166.99.31 debian_</span></span>release=testing hostname=debian2 128.199.59.102 debian_release=testing hostname=debian3</code> </pre><br>  In order for Docker Swarm to connect to Docker nodes, they must be accessible from the outside ( <i>by default on port 2375 for HTTP and on 2376 for HTTPS</i> ).  We also need to make the Docker Swarm Manager available outside, so that we can manage the cluster.  HTTP is not suitable for us for these purposes ( <i>we are building a cloud for ourselves, not for any Internet user</i> ), HTTPS remains, or rather TLS ( <i>for more information, see the <a href="https/">official documentation</a></i> ). <br><br>  The principle of operation is the following: we create our own certificate authority ( <i>hereinafter</i> referred to as the <i>CA</i> ), sign certificates for the Docker server and client.  After that, the ‚Äúdemon‚Äù of the docker accepts connections from clients whose certificate is signed by the same CA as the certificate of the ‚Äúdemon‚Äù.  The Docker client performs the same verification and connects only to those Docker servers whose certificate is signed by the same CA.  Docker Swarm Manager uses the same scheme.  This ensures authentication and security of our mini-clouds. <br><br>  The only thing you need to do is generate keys for your CA ( <i>everything else will be executed in automatic mode</i> ).  Just execute the following commands from the project root directory (the <i>password you specify, you need to remember, we will need it</i> ) and fill in the answers to the questions ( <i>there are no specific requirements, you can specify any domain</i> ): <br><br><pre> <code class="bash hljs">¬ª openssl genrsa -aes256 -out certs/ca/ca-key.pem 4096 ¬ª openssl req -new -x509 -days 365 -key certs/ca/ca-key.pem -sha256 -out certs/ca/ca.pem</code> </pre><br>  It remains to fill in the values ‚Äã‚Äãof some variables in the file: <br><br><div class="spoiler">  <b class="spoiler_title">group_vars / all.yml</b> <div class="spoiler_text"><pre> <code class="markdown hljs">certs: ca: password: "YOUR PASSWORD HERE" docker<span class="hljs-emphasis"><span class="hljs-emphasis">_swarm: # docker run --rm swarm create token: "YOUR DOCKER SWARM TOKEN HERE" manager: "YOU DOCKER SWARM MANAGER IP HERE" ssh: users: # user for ansible - user: "support" shell: "/bin/zsh" # for oh-my-zsh groups: "sudo" # mkpasswd --method=SHA-512 password: "YOUR PASSWORD HERE" # cat ~/.ssh/id_</span></span>rsa.pub key: "YOUR PUBLIC KEY HERE"</code> </pre><br></div></div><br>  The variable <b>certs.ca.password</b> should contain the password that we specified when we generated the private key for our certificate authority. <br><br>  The variable <b>docker_swarm.token</b> should contain the identifier of our future cluster, which can be generated by the following command: <br><br><pre> <code class="bash hljs">¬ª docker run --rm swarm create 6856663cdefdec325839a4b7e1de38e8</code> </pre><br>  The variable <b>docker_swarm.manager</b> should contain the IP address of the host where Docker Swarm Manager will be running ( <i>specify the IP address of any of your servers</i> ). <br><br>  The Ansible scripts indicate that you need to create a <b>support</b> user, add him to the <b>sudo</b> group and disable <b>root</b> 's SSH authorization.  The value of the variable <b>ssh.users []. Password</b> must be a password hash for the user specified above.  In order to get it, you need to run the following command on any Linux machine ( <i>you can go to one of your servers via SSH and execute it</i> ): <br><br><pre> <code class="bash hljs">¬ª mkpasswd --method=SHA-512 Password: <span class="hljs-variable"><span class="hljs-variable">$6</span></span><span class="hljs-variable"><span class="hljs-variable">$n0lQGWy2s5437ns1</span></span><span class="hljs-variable"><span class="hljs-variable">$nczULrrTw5r</span></span>.TmhEI/xBz5xYEHWyMbtbQhAJoWshv0rFjSoRxLYZh0zDoMwVM.ZFnChx7ym.4.r182EOIn9Ec/</code> </pre><br>  The <b>ssh.users []. Key</b> value should be your public key, which by default is here <b>~ / .ssh / id_rsa.pub</b> : <br><br><div class="spoiler">  <b class="spoiler_title">~ / .ssh / id_rsa.pub</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDDakR6/NJuIxJGpWZiV5QODuRacuh4VoIdzeOUlH+MC1xxFf/U74gfumoQ1k62d4S0qPqnlpJVqRNg7mQo0CCguujVRuOP+FbRMjdQbbAEfDAjxkSuKXRWnChg6Ds4MX0RO9WUB9pQLrCmbPpI8A0l0zaNi6mp6TaXWCoMPrgk1OfuTYDBTgQya/MtKjjPnWFEdgwTvB3hVusCU83854Gju9OX4I5ucejy/f8/IWGUIFt8miLisrYnDcdFvY/ThzX7E2h4lzsc8JK6ltywyoHVScl3Vdgf1/WbScEnQYWJZk/h2zWDqdFlte/elov7l3yfJDN0axF+dC6BqJGfZMFQsN6xPWHoG8OCPaH2HmTY3XNpQNRLJR5GFWwVriIBDe+GyVjtjzb1/BLdu0WJatv6/PYMsEfArYBgnQ/bHYgfFLF0GPq6nBGJbngytv7C5crBljZAvnC86HQN5sGPbZWfkKdvoG5MbbJYwqFvaD2BEjlXMurbCX4ERrRUHC9875XufaCvdpCiSWaU4S5PM8nr2QCF3co0EtL0bkiciyv95eU0HoQ3cYhPNGwUMxntPp/3z0KRqeSBHPnvV5pmXOwP/xUHxEIvDbqCXtTc3y96iDKZ1T8+jPH1aif6ooVUwmogTHDd1DcW+APtMkqRHdZ7r33wKAYJfNopd+0P8rYF2w==</code> </pre><br></div></div><br>  An example of a completed configuration file can be found below: <br><br><div class="spoiler">  <b class="spoiler_title">group_vars / all.yml</b> <div class="spoiler_text"><pre> <code class="markdown hljs">certs: ca: password: "12345" docker<span class="hljs-emphasis"><span class="hljs-emphasis">_swarm: # docker run --rm swarm create token: "6856663cdefdec325839a4b7e1de38e8" manager: "188.166.16.70" ssh: users: # user for ansible - user: "support" shell: "/bin/zsh" # for oh-my-zsh groups: "sudo" # mkpasswd --method=SHA-512 password: "$6$n0lQGWy2s5437ns1$nczULrrTw5r.TmhEI/xBz5xYEHWyMbtbQhAJoWshv0rFjSoRxLYZh0zDoMwVM.ZFnChx7ym.4.r182EOIn9Ec/" # cat ~/.ssh/id_</span></span>rsa.pub key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDDakR6/NJuIxJGpWZiV5QODuRacuh4VoIdzeOUlH+MC1xxFf/U74gfumoQ1k62d4S0qPqnlpJVqRNg7mQo0CCguujVRuOP+FbRMjdQbbAEfDAjxkSuKXRWnChg6Ds4MX0RO9WUB9pQLrCmbPpI8A0l0zaNi6mp6TaXWCoMPrgk1OfuTYDBTgQya/MtKjjPnWFEdgwTvB3hVusCU83854Gju9OX4I5ucejy/f8/IWGUIFt8miLisrYnDcdFvY/ThzX7E2h4lzsc8JK6ltywyoHVScl3Vdgf1/WbScEnQYWJZk/h2zWDqdFlte/elov7l3yfJDN0axF+dC6BqJGfZMFQsN6xPWHoG8OCPaH2HmTY3XNpQNRLJR5GFWwVriIBDe+GyVjtjzb1/BLdu0WJatv6/PYMsEfArYBgnQ/bHYgfFLF0GPq6nBGJbngytv7C5crBljZAvnC86HQN5sGPbZWfkKdvoG5MbbJYwqFvaD2BEjlXMurbCX4ERrRUHC9875XufaCvdpCiSWaU4S5PM8nr2QCF3co0EtL0bkiciyv95eU0HoQ3cYhPNGwUMxntPp/3z0KRqeSBHPnvV5pmXOwP/xUHxEIvDbqCXtTc3y96iDKZ1T8+jPH1aif6ooVUwmogTHDd1DcW+APtMkqRHdZ7r33wKAYJfNopd+0P8rYF2w=="</code> </pre><br></div></div><br>  Now we are ready to start building a long-awaited cloud: <br><br><pre> <code class="bash hljs">¬ª ansible-playbook -i stage site.yml -u root</code> </pre><br>  Due to the fact that we have disabled the <b>root</b> authorization feature, as well as added <b>support</b> user ( <i>this is written in the Ansible scripts</i> ), all subsequent launches should be performed with the <b>-s</b> ( <i>sudo</i> ) and <b>-K</b> flags ( <i>to request a password for sudo</i> ): <br><br><pre> <code class="bash hljs">¬ª ansible-playbook -i stage site.yml -u support -s -K</code> </pre><br><br><h1>  <font color="#d62631">Check and use</font> </h1><br>  We are ready to test our new cloud: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem info Containers: 4 Images: 3 Storage Driver: Role: primary Strategy: spread Filters: affinity, health, constraint, port, dependency Nodes: 3 debian1: 188.166.16.70:2376 ‚îî Containers: 2 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux stretch/sid, storagedriver=aufs debian2: 188.166.99.31:2376 ‚îî Containers: 1 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux stretch/sid, storagedriver=aufs debian3: 128.199.59.102:2376 ‚îî Containers: 1 ‚îî Reserved CPUs: 0 / 1 ‚îî Reserved Memory: 0 B / 519.2 MiB ‚îî Labels: executiondriver=native-0.2, kernelversion=3.16.0-4-amd64, operatingsystem=Debian GNU/Linux stretch/sid, storagedriver=aufs Execution Driver: Kernel Version: Operating System: CPUs: 3 Total Memory: 1.521 GiB Name: ID: Http Proxy: Https Proxy: No Proxy:</code> </pre><br>  Hooray!  I‚Äôve almost finished this great article, and you‚Äôve successfully finished building your cloud. <br><br>  If you need, you can connect to any of the Docker hosts separately: <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="bash hljs">¬ª docker -H tcp://128.199.59.102:2376 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem info Containers: 2 Images: 7 Storage Driver: aufs Root Dir: /var/lib/docker/aufs Backing Filesystem: extfs Dirs: 11 Dirperm1 Supported: <span class="hljs-literal"><span class="hljs-literal">true</span></span> Execution Driver: native-0.2 Kernel Version: 3.16.0-4-amd64 Operating System: Debian GNU/Linux stretch/sid CPUs: 1 Total Memory: 494.5 MiB Name: debian1 ID: 5XPE:2VWX:QCSA:J3PJ:WMN7:EDXX:3TSS:7K7K:XU4R:Z3AX:TRVX:VTUQ WARNING: No memory <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> support WARNING: No swap <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> support</code> </pre><br></div></div><br>  But we did not go all this way for this, right?  Let's try to run several instances of Nginx in our cloud: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 --name nginx1 nginx bb49018b697fca975d10a5ec31ad2fed65ed12b3ad8fbd61e64474187d8bc6ed ¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 --name nginx2 nginx 2bd86ff97c35d431e9db7f0571d65e17893aefd1d18b1b52194c100a22a49937</code> </pre><br><br>  Checking: <br><img src="https://habrastorage.org/files/0b2/059/b7c/0b2059b7cdb94af6885083a5d74532e2.png" alt="Nginx"><br><br>  Let's try to launch 2 more instances of Nginx: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 --name nginx3 nginx 622b4e199c700cae663bf2e2f326918f94a0cd016c27dc9ff39f4ec4abf7bdb1 ¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem run -d -p 80:80 --name nginx4 nginx FATA[0001] Error response from daemon: unable to find a node with port 80 available</code> </pre><br>  As we can see, the 3rd instance started, but the 4th one is not: <b>FATA [0001] Error response from daemon: unable to find a node with port 80 available</b> .  Docker Swarm Scheduler sees that there are no hosts with a free 80th port. <br><br>  We can see which containers are currently running in our cluster and make sure that each copy of Nginx was running on a different machine: <br><br><pre> <code class="bash hljs">¬ª docker -H tcp://188.166.16.70:8000 --tlsverify=<span class="hljs-literal"><span class="hljs-literal">true</span></span> --tlscacert=certs/ca/ca.pem --tlscert=certs/docker/cert.pem --tlskey=certs/docker/key.pem ps 1 ‚Üµ CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 622b4e199c70 nginx:latest <span class="hljs-string"><span class="hljs-string">"nginx -g 'daemon of 5 minutes ago Up 5 minutes 128.199.59.102:80-&gt;80/tcp, 443/tcp debian3/nginx3 2bd86ff97c35 nginx:latest "</span></span>nginx -g <span class="hljs-string"><span class="hljs-string">'daemon of 16 minutes ago Up 16 minutes 188.166.16.70:80-&gt;80/tcp, 443/tcp debian1/nginx2 bb49018b697f nginx:latest "nginx -g '</span></span>daemon of 17 minutes ago Up 17 minutes 188.166.99.31:80-&gt;80/tcp, 443/tcp debian2/nginx1 148eef0bbe02 library/swarm:latest <span class="hljs-string"><span class="hljs-string">"/swarm manage --tls 2 hours ago Up 2 hours 188.166.16.70:8000-&gt;2375/tcp debian1/docker-swarm-manager 3545322d27b7 library/swarm:latest "</span></span>/swarm join --addr= 2 hours ago Up 2 hours 2375/tcp debian2/docker-swarm faaa78cbedba library/swarm:latest <span class="hljs-string"><span class="hljs-string">"/swarm join --addr= 2 hours ago Up 2 hours 2375/tcp debian3/docker-swarm 0fee12f6a473 library/swarm:latest "</span></span>/swarm join --addr= 2 hours ago Up 2 hours 2375/tcp debian1/docker-swarm</code> </pre><br>  The possibilities of Docker Swarm do not end there, but are just beginning ( <i>you can read about it <a href="https://docs.docker.com/swarm/scheduler/filter/">here</a> and <a href="https://docs.docker.com/swarm/scheduler/strategy/">here</a></i> ). <br><br>  As I wrote at the beginning of the article, my goal is to give you a list of tools and a general understanding that you would know what to build on and I hope that it has been achieved. <br><br>  In the <a href="http://habrahabr.ru/post/262397/">next part,</a> I will tell you what Service Discovery is, how to distribute the load in our cloud and what tools are available for this. <br><br>  That's all.  Thank you all for your attention.  Stable clouds and good luck to you! <br><br>  <a href="https://twitter.com/vkozlovski">Follow me on Twitter</a> , I talk about working in a startup, my mistakes and the right decisions, about python and everything related to web development. <br><br>  PS <i>I'm looking for developers to the company, the details in my <a href="http://habrahabr.ru/users/vladkozlovski/">profile</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/261415/">https://habr.com/ru/post/261415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261397/index.html">10 fatal mistakes of the usability of online stores and something else</a></li>
<li><a href="../261403/index.html">How to treat a malfunctioning cloud provider</a></li>
<li><a href="../261405/index.html">Consolidation of offices in 3CX (Part 1. We use trunks)</a></li>
<li><a href="../261409/index.html">Import substitution, as was said</a></li>
<li><a href="../261413/index.html">Skin Detection in Wolfram Language (Mathematica)</a></li>
<li><a href="../261417/index.html">The Subtleties of ES6: Collections (Part 2)</a></li>
<li><a href="../261419/index.html">CIFS in Android, or how I got files from a broken phone</a></li>
<li><a href="../261421/index.html">The magic of tensor algebra: Part 1 - what is a tensor and what is it for?</a></li>
<li><a href="../261425/index.html">Combining Qt and AdMob</a></li>
<li><a href="../261431/index.html">Remote work or freelancing in the outback. Aspects of communication. Part 2. There is a connection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>