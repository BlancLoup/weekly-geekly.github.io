<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing uLogin module for Kohana 3.2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago on Habr√© there was an article about the uLogin authorization widget. 
 What I really liked about it, is the ability to specify the req...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing uLogin module for Kohana 3.2</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago on Habr√© there was <a href="http://habrahabr.ru/blogs/webdev/130893/">an article</a> about the uLogin authorization widget. <br>  What I really liked about it, is the ability to specify the required fields, while, if they are not received from the provider, the user is invited to fill them in manually.  So there was a desire to write a module in Kohana, which would allow easy user registration using the uLogin widget. <br><br><a name="habracut"></a><br><h5>  A bit about the structure of the modules </h5><br><br>  Each module is placed in a separate folder in the MODPATH folder (default modules) <br>  Inside may be the folder classes, config, and all the same as in the application.  This is the so-called cascade file system, read more <a href="http://kohanaframework.org/3.2/guide/kohana/files">here.</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For our module, you need only the classes and config folders. <br>  In the config folder will be the default configuration file, and, if desired, you can override it in application / config. <br>  The classes folder contains the ulogin.php file, which contains the definition of the Ulogin class: <br><pre><code class="hljs scala">&lt;?php defined(<span class="hljs-symbol"><span class="hljs-symbol">'SYSPAT</span></span>H') or die(<span class="hljs-symbol"><span class="hljs-symbol">'No</span></span> direct script access.'); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ulogin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kohana_Ulogin</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br>  This class is inherited from Kohana_Ulogin, which will, if necessary, override it by placing it in the file application / classes / ulogin.php. <br><br>  Since the base class is called Kohana_Ulogin, it should be in classes / kohana / ulogin.php, since Kohana replaces the underscore with a slash when searching for a class for autoloading. <br><br>  Before use, the module must be connected to bootstrap.php: <br><pre> <code class="hljs php">Kohana::modules(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( ...... <span class="hljs-string"><span class="hljs-string">'ulogin'</span></span> =&gt; MODPATH.<span class="hljs-string"><span class="hljs-string">'ulogin'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// uLogin ));</span></span></code> </pre> <br><br><h5>  Widget display </h5><br>  The authorization widget is displayed as follows: <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> Ulogin::factory()-&gt;render()</code> </pre> <br><br>  What happens when this happens: <br><br>  Static function <br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">factory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ulogin($config); }</code> </pre><br>  It creates an instance of the Ulogin class, while transferring the emu array with the configuration, this is done to be able to overwrite the default settings directly when called. <br><br>  Constructor class: <br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config = array_merge(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config, Kohana::$config-&gt;load(<span class="hljs-string"><span class="hljs-string">'ulogin'</span></span>)-&gt;as_array(), $config); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'redirect_uri'</span></span>] === <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'redirect_uri'</span></span>] = Request::initial()-&gt;url(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br>  Loads the config using Kohana :: $ config-&gt; load Kohans function and checks redirect_uri to NULL.  In the case of a positive test result, the current address that the user contacted is simply set, receiving it by calling Request :: initial () -&gt; url (true).  The true parameter tells Kokhane to include the protocol in the address.  Request :: initial () is used to get the initial address. <br><br>  The render () function: <br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $params = <span class="hljs-string"><span class="hljs-string">'display='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]. <span class="hljs-string"><span class="hljs-string">'&amp;fields='</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, array_merge(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'username'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'fields'</span></span>])). <span class="hljs-string"><span class="hljs-string">'&amp;providers='</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'providers'</span></span>]). <span class="hljs-string"><span class="hljs-string">'&amp;hidden='</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>]). <span class="hljs-string"><span class="hljs-string">'&amp;redirect_uri='</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'redirect_uri'</span></span>]. <span class="hljs-string"><span class="hljs-string">'&amp;optional='</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'optional'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_used_id) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { $view = View::factory(<span class="hljs-string"><span class="hljs-string">'ulogin/first'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_used_id[] = <span class="hljs-string"><span class="hljs-string">'uLogin'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $view = View::factory(<span class="hljs-string"><span class="hljs-string">'ulogin/second'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $uniq_id = <span class="hljs-string"><span class="hljs-string">"uLogin_"</span></span>.rand(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(in_array($uniq_id, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_used_id)); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_used_id[] = $uniq_id; $view-&gt;set(<span class="hljs-string"><span class="hljs-string">'uniq_id'</span></span>, $uniq_id); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $view-&gt;set(<span class="hljs-string"><span class="hljs-string">'cfg'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config)-&gt;set(<span class="hljs-string"><span class="hljs-string">'params'</span></span>, $params)-&gt;render(); }</code> </pre> <br>  First of all, you need to make the parameters for the transfer to the uLogin script.  http_build_query () is not suitable here, since it encodes the data (in particular commas) into their hexadecimal codes (% xx).  Then it is checked whether the first is a launch (in the self :: $ _ used_id array is empty), or not. <br>  If the first one, then the View ulogin / first.php is loaded: <br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">if</span></span></span><span class="php"> ($cfg[</span><span class="hljs-string"><span class="php"><span class="hljs-string">'type'</span></span></span><span class="php">] == </span><span class="hljs-string"><span class="php"><span class="hljs-string">'window'</span></span></span><span class="php">) :</span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uLogin"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ulogin.ru/img/button.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">187</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">30</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ulogin.ru/js/widget.js?&lt;?php echo $params; ?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">else</span></span></span><span class="php">: </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"uLogin"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ulogin.ru/js/widget.js?&lt;?php echo $params; ?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">endif</span></span></span><span class="php">; </span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Depending on the selected mode, it displays the HTML code for calling the widget. <br><br>  If this is a second step, then we generate a unique identifier and load View ulogin / second.php: <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;?php echo $uniq_id; ?&gt;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'text/javascript'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml">uLogin.init('id=</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span></span><span class="xml"><span class="php"> </span></span><span class="hljs-keyword"><span class="xml"><span class="php"><span class="hljs-keyword">echo</span></span></span></span><span class="xml"><span class="php"> $uniq_id; </span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">&amp;</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span></span><span class="xml"><span class="php"> </span></span><span class="hljs-keyword"><span class="xml"><span class="php"><span class="hljs-keyword">echo</span></span></span></span><span class="xml"><span class="php"> $params; </span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">');</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  It just calls the widget according to the documentation located on the official website. <br><br>  That's all that is needed to display the authorization widget <br><br><h5>  Result processing </h5><br><br>  Processing using the module looks like this: <br><pre> <code class="hljs php"> $ulogin = Ulogin::factory(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$ulogin-&gt;mode()) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;template-&gt;content = $ulogin-&gt;render(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $ulogin-&gt;login(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(ORM_Validation_Exception $e) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;template-&gt;errors = $e-&gt;errors(<span class="hljs-string"><span class="hljs-string">''</span></span>); } }</code> </pre> <br><br>  That is, we check the mode by calling mode (), after which we either display the widget or authorize / register the user.  try / catch is needed to verify the user's registration, for example, a matching e-mail / <br><br>  The mode () function simply checks for $ _POST ['token']: <br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'token'</span></span>]); }</code> </pre> <br><br>  C login () is more complicated: <br><pre> <code class="hljs php"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'token'</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Kohana_Exception(<span class="hljs-string"><span class="hljs-string">'Empty token.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!($domain = parse_url(URL::base(), PHP_URL_HOST))) { $domain = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_HOST'</span></span>]) ? $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_HOST'</span></span>] : $_SERVER[<span class="hljs-string"><span class="hljs-string">'SERVER_NAME'</span></span>]; } $s = Request::factory(<span class="hljs-string"><span class="hljs-string">'http://ulogin.ru/token.php?token='</span></span> . $_POST[<span class="hljs-string"><span class="hljs-string">'token'</span></span>] . <span class="hljs-string"><span class="hljs-string">'&amp;host='</span></span> . $domain)-&gt;execute()-&gt;body(); $user = json_decode($s, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $orm_user = ORM::factory(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'identity'</span></span> =&gt; $user[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$orm_user-&gt;loaded()) { $data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $part_of_name) $data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] .= (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user[$part_of_name]) ? <span class="hljs-string"><span class="hljs-string">''</span></span> : (<span class="hljs-string"><span class="hljs-string">' '</span></span>.$user[$part_of_name])); $data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] = trim($data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Kohana_Exception(<span class="hljs-string"><span class="hljs-string">'Username fields not set in config/ulogin.php'</span></span>); $data[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] = <span class="hljs-string"><span class="hljs-string">'ulogin_autogenerated_password'</span></span>; $data[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>] = $user[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>]; $data[<span class="hljs-string"><span class="hljs-string">'network'</span></span>] = $user[<span class="hljs-string"><span class="hljs-string">'network'</span></span>]; $cfg_fields = array_merge(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'fields'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'optional'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($cfg_fields <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $field) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user[$field])) $data[$field] = $user[$field]; } $orm_user-&gt;values($data); $orm_user-&gt;create(); $orm_user-&gt;add(<span class="hljs-string"><span class="hljs-string">'roles'</span></span>, ORM::factory(<span class="hljs-string"><span class="hljs-string">'role'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'login'</span></span>))); Auth::instance()-&gt;force_login($orm_user); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Auth::instance()-&gt;force_login($orm_user); } }</code> </pre> <br><br>  What's going on here: <br>  We re-check the token (if someone just called login ()), then we try to get a host for transmission to uLogin: either from the base address (specified in bootstrap.php in Kohana :: init ()), or through $ _SERVER [ 'HTTP_HOST'] or $ _SERVER ['SERVER_NAME']. <br><br>  Then we make a request to uLogin, to obtain user data: <br><br><pre> <code class="hljs php"> $s = Request::factory(<span class="hljs-string"><span class="hljs-string">'http://ulogin.ru/token.php?token='</span></span> . $_POST[<span class="hljs-string"><span class="hljs-string">'token'</span></span>] . <span class="hljs-string"><span class="hljs-string">'&amp;host='</span></span> . $domain)-&gt;execute()-&gt;body(); $user = json_decode($s, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre> <br>  As a result, we get something like this (Google example): <br><pre> <code class="hljs lisp">array(<span class="hljs-number"><span class="hljs-number">6</span></span>) ( <span class="hljs-string"><span class="hljs-string">"network"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-string"><span class="hljs-string">"google"</span></span> <span class="hljs-string"><span class="hljs-string">"identity"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-string"><span class="hljs-string">"  ,  https://plus.google.com/u/0/google+ /"</span></span> <span class="hljs-string"><span class="hljs-string">"uid"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">21</span></span>) <span class="hljs-string"><span class="hljs-string">"google+ "</span></span> <span class="hljs-string"><span class="hljs-string">"email"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">21</span></span>) <span class="hljs-string"><span class="hljs-string">"e-mail"</span></span> <span class="hljs-string"><span class="hljs-string">"first_name"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-string"><span class="hljs-string">"last_name"</span></span> =&gt; string(<span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-string"><span class="hljs-string">""</span></span> )</code> </pre> <br><br>  Next, we try to find it in the database, use its unique URL: $ user ['identity']: <br><pre> <code class="hljs php">$orm_user = ORM::factory(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'identity'</span></span> =&gt; $user[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>]));</code> </pre> <br>  If found ($ orm_user-&gt; loaded () == true), simply authorize it: <br><pre> <code class="hljs php">Auth::instance()-&gt;force_login($orm_user);</code> </pre> <br>  Otherwise, it must be registered: <br><br><ol><li>  Make up the username: <br><pre> <code class="hljs php">$data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $part_of_name) $data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] .= (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user[$part_of_name]) ? <span class="hljs-string"><span class="hljs-string">''</span></span> : (<span class="hljs-string"><span class="hljs-string">' '</span></span>.$user[$part_of_name])); $data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>] = trim($data[<span class="hljs-string"><span class="hljs-string">'username'</span></span>]);</code> </pre> <br><br></li><li>  Fill in the fields of the model: <br><pre> <code class="hljs php">$data[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] = <span class="hljs-string"><span class="hljs-string">'ulogin_autogenerated_password'</span></span>; $data[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>] = $user[<span class="hljs-string"><span class="hljs-string">'identity'</span></span>]; $data[<span class="hljs-string"><span class="hljs-string">'network'</span></span>] = $user[<span class="hljs-string"><span class="hljs-string">'network'</span></span>]; $cfg_fields = array_merge(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'fields'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;config[<span class="hljs-string"><span class="hljs-string">'optional'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($cfg_fields <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $field) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user[$field])) $data[$field] = $user[$field]; } $orm_user-&gt;values($data);</code> </pre><br></li><li>  Create a user, add the login role to it, and then authorize it: <br><pre> <code class="hljs php">$orm_user-&gt;create(); $orm_user-&gt;add(<span class="hljs-string"><span class="hljs-string">'roles'</span></span>, ORM::factory(<span class="hljs-string"><span class="hljs-string">'role'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'login'</span></span>))); Auth::instance()-&gt;force_login($orm_user);</code> </pre> <br></li></ol><br><br>  Source codes are available on <a href="https://github.com/PomanoB/kohana-ulogin">github.</a> <br><br>  As you can see, the use of uLogin and the writing of modules to Kohana do not pose any difficulties. <br>  Good luck! <br><br>  UPD: Added views <br>  UPD2: Rewritten some code and article, thanks <a href="https://habrahabr.ru/users/dohlik/" class="user_link">dohlik</a> </div><p>Source: <a href="https://habr.com/ru/post/132124/">https://habr.com/ru/post/132124/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132117/index.html">A friend will help</a></li>
<li><a href="../132118/index.html">Sphinx Sample Search on Real Project - Tecdoc Auto Parts Store</a></li>
<li><a href="../132119/index.html">Chamber technology on Yandex.Maps</a></li>
<li><a href="../132120/index.html">What is the new media and how to advance start-ups in social networks</a></li>
<li><a href="../132123/index.html">Automated backup of Windows workstations with rsync and vshadow - Part 1</a></li>
<li><a href="../132125/index.html">German district court found Apple guilty of patent infringement by Motorola</a></li>
<li><a href="../132126/index.html">Aibolit for android</a></li>
<li><a href="../132127/index.html">A little more about P and NP</a></li>
<li><a href="../132128/index.html">Description of the operation of the Shift-OR algorithm to search for substrings in the string</a></li>
<li><a href="../132131/index.html">Panasonic's new Toughpad security tablets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>