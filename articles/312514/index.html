<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do not postpone to the mailbox: 2GIS b2c-messenger</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In September, a new feature appeared on 2gis.ru - b2c-messenger for communication with organizations. The chat is very convenient when searching for a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do not postpone to the mailbox: 2GIS b2c-messenger</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/178/d4d/90f/178d4d90f12b41d9ba4b9e7e359a5086.png"><br><br>  In September, a new feature appeared on 2gis.ru - <a href="https://2gis.ru/novosibirsk/search/2%25D0%25B3%25D0%25B8%25D1%2581/firm/141265769366740/tab/firms%3FqueryState%3Dzoom%252F11">b2c-messenger</a> for communication with organizations.  The chat is very convenient when searching for a product or service: you can write to several companies at once, you do not need to listen to the voices of the answering machine robots or wait on the line until the operator clarifies the price or the balance of the desired product.  Select a company, click on the message icon on the company card, and a chat will open. <br><br>  To make an instant messenger, we had to sort out a little about how chat rooms work and what‚Äôs under the hood of ‚Äúbig brothers‚Äù like WhatsApp or Telegram.  It turned out not so scary. <br><a name="habracut"></a><br><h3>  Why 2GIS Messenger </h3><br>  Perhaps, it‚Äôs worth starting not with the messenger, but with how we came to this idea.  We used to show in the company email directory.  Then added a form of communication with the company directly from the directory.  They write less than they call, but the length of the chain of letters is on average from 2 to 10 messages.  That is, an instant messenger is a logical development of an existing opportunity to send letters to companies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  How it works now </h3><br><img src="https://habrastorage.org/files/51b/a7f/c8d/51ba7fc8d1b749abafd0fd9ec9909316.gif"><br><br>  And even better - just try <a href="https://2gis.ru/novosibirsk/search/2%25D0%25B3%25D0%25B8%25D1%2581/firm/141265769366740/tab/firms%3FqueryState%3Dzoom%252F11">to ask us a question</a> .  We are in Novosibirsk, and when in Moscow at 18:00, we already have 22:00. <br><br><h3>  A quick overview: choose a bike </h3><br>  First we looked at BaaS (Backend as a Service), such as quickblox.com, backendless.com, sendbird.com, etc.  All of them provide tools for adding standard chat functionality to mobile or web applications. <br><br>  The implementation of the main (sending email notifications in the company) and more advanced scenarios based on the existing BaaS solution will require us to both develop our own backends for integration through webbooks and super efforts for integration with the vendor's API.  Therefore, BaaS did not suit us.  In addition, we wanted to have full control over the features, that is, not to depend on third-party solutions.  In the end, we are engineers and decided to experiment to get a new experience for us. <br><br><h3>  And how to deliver messages? </h3><br>  To make your backend for the messenger, you first need to deal with a bunch of questions: how to transfer messages from the client to the server and back, how to store them, how to handle a bunch of simultaneous connections, how to scale the service.  Thought, google, collected ways to deliver messages in the table for comparison. <br><br><div class="spoiler">  <b class="spoiler_title">Table</b> <div class="spoiler_text">  <i>Sorry, but we could not arrange the table in Habrareditor beautifully.</i> <br><table><tbody><tr><td>  <b>The way</b> </td><td>  <b>Description</b> </td><td>  <b>Transport</b> </td><td>  <b>Protocol</b> </td><td>  <b>Browser support</b> </td></tr><tr><td>  WebSockets </td><td>  The client opens a persistent connection to the server using the <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a> API. </td><td>  Websockets API </td><td>  TCP (requires HTTPhandshake to open a connection) </td><td>  <a href="http://caniuse.com/">caniuse.com/#feat=websockets</a> </td></tr><tr><td>  Streaming </td><td>  The client opens a permanent connection to the server. </td><td>  XMLHttpRequest (multipart onload), XMLHttpRequest (onprogress), Iframe tag </td><td>  HTTP </td><td>  <a href="http://caniuse.com/">caniuse.com/#feat=streaming</a> </td></tr><tr><td>  Server Sent Events </td><td>  The client opens a permanent connection to the server using the API <a href="https://en.wikipedia.org/wiki/Server-sent_events">Server Sent Events</a> . </td><td>  API Server Sent Events </td><td>  HTTP </td><td>  No support in IE, <a href="http://caniuse.com/">caniuse.com/#feat=eventsource</a> </td></tr><tr><td>  Polling </td><td>  The client periodically polls the server for new messages. </td><td>  Any available </td><td>  HTTP </td><td></td></tr><tr><td>  Long polling </td><td>  The client opens a long-lived connection to the server, which does not close until a new message appears or the timeout expires.  Immediately after closing the connection, the client opens a new one. </td><td>  XMLHttpRequest <br>  Script tag </td><td>  HTTP </td><td></td></tr><tr><td>  Browser Plugins (Java / Flash) </td><td>  The client opens a permanent connection to the server using the browser plug-in API (Java or Flash). </td><td>  Plugin API </td><td>  TCP / UDP </td><td></td></tr></tbody></table><br></div></div><br>  Most modern chat applications use one of two methods: long polling or websockets.  Websockets has several advantages over long polling (full duplex connection, no extra traffic during reconnections), it is widely supported in browsers and opensource libraries, therefore it seems to be the optimal choice for our task.  There are also disadvantages: implementation differences in different browsers, more complex logic on the server. <br><br>  The most common open general-purpose data transfer protocol is XMPP. <br><table><tbody><tr><td>  <b>Positive sides</b> </td><td>  <b>Negative sides</b> </td></tr><tr><td>  IETF open standard </td><td>  Redundancy of transmitted information </td></tr><tr><td>  A large number of opensource implementations </td><td>  XML </td></tr><tr><td>  Opportunities for customization </td><td>  Will require refinement to the specifics of our task </td></tr></tbody></table><div class="spoiler">  <b class="spoiler_title">Overview of large instant messengers</b> <div class="spoiler_text"><table><tbody><tr><td colspan="2">  <b>Messenger</b> </td><td>  <b>Delivery method</b> </td><td>  <b>Protocol</b> </td><td>  <b>Server</b> </td><td>  <b>Storage system</b> </td></tr><tr><td colspan="2">  Whatsapp </td><td>  Websockets </td><td>  Started with XMPP, but then switched to in-house protocol </td><td>  The entire server infrastructure is built on Erlang + FreeBS, it allows you to keep up to 2kk TCP connections on one server.  We started on ejabberd, but it was very much modified by him afterwards.  Yaws, lighttpd </td><td>  Do not store message history on the server, messages are deleted from the server after being received by the client, mnesia </td></tr><tr><td colspan="2">  Line </td><td>  No web version, only Chrome app </td><td>  Thrift for mobile customers </td><td>  Java, C ++, Nginx </td><td>  We started with a cluster of three Redis instances, after the explosive growth of the user base, ‚Äúcold‚Äù data migrated to Hbase: message history and change history of users / groups / contacts, MySQL for backups and analytics </td></tr><tr><td colspan="2">  Viber </td><td>  No web version </td><td>  In-house </td><td>  C ++, hosted by AWS </td><td>  We started with a samopisny in-memory repository written in C ++, then we switched to Mongo and Redis as a cache.  Mongo did not arrange for performance, eventually migrated to Couchbase </td></tr><tr><td colspan="2">  Facebook messenger </td><td>  Long polling </td><td>  In-house json-based for the web, Thrift for mobile applications </td><td>  Erlang - message queues.  C ++ - presence information service, message history storage.  PHP - frontend, handles all user requests, except for long polling.  Services communicate with each other through Thrift <br></td><td>  Queue on MySQL, HBase </td></tr><tr><td colspan="2">  Slack </td><td>  Websockets </td><td>  In-house json-based </td><td>  Java messaging server, LAMP for core app / APIs, hosted on AWS </td><td>  Redis, MySql, Apache Solr </td></tr></tbody></table></div></div><br>  However, having studied the solutions of various ‚Äúbig‚Äù messengers, we did not find any significant success stories of using XMPP without its subsequent refinement and customization.  After thinking, we decided to develop a simple json-based protocol, which initially takes into account the specifics of our task. <br><br><h3>  Technology stack </h3><br>  Historically, our main backend service, IPI 2GIS, was written in PHP5.  Two years ago we decided to leave PHP, migrate to Scala and Go.  Go makes it very easy to build fairly complex concurrent programs.  This was a decisive factor when choosing it as the main technology of the messenger implementation.  And we already had some development experience on Go. <br><br>  So, we write backend on Go, and frontend - on React + Redux.  We chose RabbitMQ as the messaging system;  for data storage we use Redis and PostgeSQL.  We pack the application in a Docker container and deploy it via Gitlab-CI to the Deis platform. <br><br>  As I said above, we wanted to use web sockets, but when it came to implementation, we slightly rethought the decision.  The fact is that we wanted to release the feature as quickly as possible to test the hypothesis (the notorious MVP).  To speed up, we decided to divide the logic into using web sockets to send data from the client to the server and the simplest REST API in the other direction. <br><br><h3>  What about notifications? </h3><br>  Suddenly, the most difficult to implement were notifications.  It would seem that everything is simple: send a push to the phone, letters to the mail, display the notifications in the browser.  But our task was to ensure that all notifications were read as soon as possible and at the same time did not turn into a stream of spam. <br><br>  There is a solution called the cascade notification system.  For example, we have three main channels: notifications on 2gis.ru, letters and pushes to the phone. <br><br>  In this case, the notification system takes the form: <br><br>  - check if the user is online ‚Üí if yes, then we send him a notification in the browser; <br>  - if the user is not online, we check if the phone is tied up ‚Üí if yes, we try to send a push to a mobile phone, show a notification in the dialogs in the browser, do not send the letter; <br>  - if that didn't work, then we send a letter; <br>  - if the notification concerns the company - we observe the reaction for some time, and if there is no response after the notification in the browser and push, we still send the letter. <br><br>  In fact, we don‚Äôt send push notifications from this scenario right now, but very soon we will learn how to do it. <br><br><h3>  Plans </h3><br>  In the near future we plan to add messenger functionality to 2GIS mobile applications, finish off the main functionality (the ability to attach an attachment to the message, browser pushes), implement advanced communication scripts (for example, request to several companies at once). <br><br>  While companies are not used to the messenger, and not everyone responds quickly to messages.  But we believe that interaction between people and companies through the text has a great future. </div><p>Source: <a href="https://habr.com/ru/post/312514/">https://habr.com/ru/post/312514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312504/index.html">Web Alerts in Loaded Projects</a></li>
<li><a href="../312506/index.html">.NET Portability Analyzer</a></li>
<li><a href="../312508/index.html">Toolkit for front-end development for Linux</a></li>
<li><a href="../312510/index.html">‚ÄúThe world is a collection of facts, not things‚Äù: Wittgenstein and operation-oriented programming</a></li>
<li><a href="../312512/index.html">BizTalk Server Support: helpful tips. Part 2</a></li>
<li><a href="../312516/index.html">Making the Android app loading screen right</a></li>
<li><a href="../312518/index.html">BCP and DRP. The difference is sometimes not obvious.</a></li>
<li><a href="../312520/index.html">Automatic test generation: Excel, XML, XSLT, hereinafter - everywhere</a></li>
<li><a href="../312522/index.html">GLPI in a small organization, part 1. Typical deployment and pitfalls</a></li>
<li><a href="../312524/index.html">Cycle of articles "NetRack Guards: guarding the client's IT infrastructure": the story of the person controlling the system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>