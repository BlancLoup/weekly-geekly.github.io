<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart home: a new dimension of comfort and commitment to excellence. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, I talked about the transition from simply monitoring systems to the smart home itself. At that stage, an understanding of the enorm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart home: a new dimension of comfort and commitment to excellence. Part two</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habr.com/company/sberbank/blog/418423/">In the first part,</a> I talked about the transition from simply monitoring systems to the smart home itself.  At that stage, an understanding of the enormous potential for increasing comfort came, and the possibilities of the chosen technological stack excited excitement in the development and integration of new components. <br><br><img src="https://habrastorage.org/webt/hy/yv/pf/hyyvpfrqg1tx-jp1b5zpbtyzag8.jpeg"><br><a name="habracut"></a><br>  Let us consider the aspect of "excitement".  After the steps taken, the smart home has become difficult to stop in development.  After the USR IOT WiFi devices came the turn of the beloved DIY microcontroller ESP8266.  I used the ESP8266-12 assembly with the LoLin v3 NodeMCU and Wemos D1 mini USB port.  Started by highlighting the picture, which was already mentioned above.  Sketches for ESP8266 are conveniently developed in the Arduino IDE after connecting the appropriate plug-in.  There you can find many examples that make development very simple, even without preparation.  Therefore, by the way, there is no point in listing listings. <br><br>  <i>In the photo LoLin v3 NodeMCU with ESP8266-12.</i>  <i>Connector - micro USB.</i> <br><img src="https://habrastorage.org/webt/6d/gy/9y/6dgy9y-oaxk8jdbqef4jch2z6iq.jpeg" align="left">  It is only important to agree on an interaction protocol with openHAB.  I did not use MQTT, but did the integration directly, since it more closely matches the selected centralized management model. <img src="https://habrastorage.org/webt/sd/xl/bu/sdxlbuwmwlsnbmvfmwg8ycvjy8e.jpeg" align="right">  On the controller with ESP8266, the simplest server rises, which receives the request, parses it and executes the extracted command.  The request is sent by openHAB (either ‚Äúmanually‚Äù or as a result of the rule operation) using the curl utility.  Confirmation of the receipt of the command, the value of the measured parameters, the status of the connected actuators, the controller sends over the local network back to openHAB through its REST API.  In total, at the time of writing the article on similar circuits, 4 ESP8266 based controllers and one on the Arduino with an Ethernet module connected are integrated in the smart home.  Let me remind you that all this is done not simply in order to be able to turn on or turn off something from the smartphone, but, first of all, in order for the devices to turn on automatically when conditions for this come. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>The photo shows a conventional Legrand switch, automated with the Wemos D1 Mini.</i>  <i>All components fit into a standard box for outdoor installation.</i>  <i>At the same time measures temperature / humidity (sensor below) and light (for the future).</i> <br><br>  For example, the picture is turned on only once a day, when the house is disarmed and when the light level is below a certain level and when the time is close to the sunset time.  Moreover, some devices, for example, street lamps do not have physical switches at all and are mainly used in automatic mode. <br><br>  Anyone who has been to Obi or Leroy Merlin must have seen sets of remotely controlled outlets or even starter kits with the loud name ‚Äúsmart home‚Äù.  Most of them integrate 433 MHz communication and this connection is one-way.  Those.  sending a command it is impossible to know whether it was received by the actuator or not.  Low cost compensates for this disadvantage.  For example, you can buy controlled sockets and a flat battery switch for them for <a href="https://brenin.ru/umnaya-distantsionnaya-rozetka-brenin-easy-socket/">1300</a> and <a href="https://brenin.ru/besprovodnoy-distantsionnyy-vyklyuchatel-easy-switch-dau/">1400</a> rubles. <img src="https://habrastorage.org/webt/mi/dk/oh/midkohmwgow3r67kg5ixjkrvk6a.jpeg" align="left">  Such schemes are convenient to use for lighting devices with a separate wire, for being moved or appeared as the design idea develops.  I have such elements as the wall lamp, converted from an antique candlestick and a small floor lamp.  Both in the bedroom.  A switch is conveniently located on the bedside table.  Why such a long introduction?  It makes no sense to abandon the devices that make life more comfortable and fuller, just because they are not supported by the installed smart home system.  It‚Äôs easy to get into this situation by betting on a single supplier or a single technology. <br><br>  <i>The photo shows a set of controlled outlets and a Brenin switch.</i>  <i>433MHz</i> <br><br>  But we have technology agnostic smart home!  Therefore, we boldly look for a device hub for all 433 MHz components.  There are such hubs, <a href="http://www.ibroadlink.com/">Broadlink</a> , for example.  However, their major drawback is the indirect control, the hub must be connected to the cloud.  As you remember from the previous article, I consider this approach wrong, albeit simple and convenient.  As a result, the search ends with the decision to make a simplified hub on the Arduino.  As a peripheral, we connect a 433 MHz receiver and transmitter to the Arduino.  Then, using a special sketch, we listen to the code sent by the transmitter in the Brenin switch and learn to transmit it ourselves.  All sketches are completely based on examples of libraries and do not cause difficulties.  Moreover, the code of the control signal can be represented as a constant in openHAB and, if desired, expand the number of actuators. <br><br><img src="https://habrastorage.org/webt/ca/sn/vz/casnvzcfsiibttvtqa1mbji55py.jpeg" align="right">  <i>Homemade hub for 433 MHz devices.</i>  <i>Over time, motion detection and light control in the boiler room was added to it.</i>  <i>And air conditioning control (IR-LED on the cover).</i>  <i>In addition, to improve the stability of the data exchange with openHAB transferred from nRF24L01 + to the Ethernet-card ENC82J60, visible wire LAN.</i> <br><br>  What happened?  It turned out controlled by a wireless set of lighting in the room.  In addition, the opportunity to manage this lighting from a smart home.  As you remember, the problem with such systems is the lack of feedback.  Partially solved in this case due to the fact that the commands transmitted on the 433 MHz switch can be intercepted by the developed hub and sent them in an openHAB process, in which the rule is triggered and changes the state of the switch in the interface.  Those.  pseudo-feedback system was obtained.  This is better than nothing.  And of course, it is clear that such an approach is not suitable for controlling critical devices.  It is not reliable and insecure from the point of view of interception. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/mu/av/f8muavvft8ct9flkw4ttr8ytzao.png"></div><br>  <i>The design element which appeared with time, a sconce.</i>  <i>Operated by a power outlet and a Brenin switch</i> <br><br>  Further more.  I wanted to make beautiful switches on the second floor.  And of course, remotely controlled.  The choice fell on the touch switches <a href="http://us.livolo.com/">Livolo</a> .  They are also at 433 MHz and, importantly, can be connected "without a zero."  This is true if a full zero and phase are not connected to the sub-platforms, and the switch is in the break of the chandelier's power supply circuit.  Although this is not my case, such input conditions should be taken into account.  As a result, beautiful switches appeared in the house, connected to a smart house with the help of a previously developed hub. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sw/nx/jr/swnxjroitfoeq5a5bhdatpje-nw.jpeg"></div> <br>  <i>Set of two touch switches and a Livolo remote control.</i> <br><br>  However, there are two ‚Äúbut‚Äù.  The first.  Livolo switches really lack feedback, they do not transmit anything.  Those.  If you turn them on in the old fashioned way with your finger, the smart home will not see the state change.  Of course, this is not a barrier for the home-builder, but I decided not to fence the garden of additional sensors, and not integrate more similar Livolo devices.  The second.  The standard library did not manage to decipher the control signals from the Livolo console purchased with the switches, I had to look for libraries developed by enthusiasts specifically for the Livolo switches. <br><br>  I want to end the conversation about integrating new components exactly from what we started in the previous article: from Z-Wave. <img src="https://habrastorage.org/webt/3d/qb/z0/3dqbz0fpnvaekdsen_fp30t_wgo.jpeg" align="left">  No matter how expensive the Z-Wave devices are, their range is gradually expanding and actuating devices appear that there is no point in making oneself or which for some reason the competing technologies do not have.  The most striking example is controlled thermostatic heads for radiators.  Wireless.  Another example is compact relays and dimmers into plug-ins to turn existing switches into smart ones without changing the design.  Moreover, with feedback, i.e.  with mechanical control preserved, the smart home will be able to see the status of the switches. <br>  <i>In the photo Z-Wave thermostatic head Grundfos on the radiator in the hallway.</i> <br><br>  How is the integration?  OpenHAB has the appropriate binding to connect the USB Z-Wave stick.  In addition, the openHAB bundle has a special HABmin application for setting up the network operation of Z-Wave devices.  So, we connect the USB-stick <a href="http://rus.z-wave.me/shop/adapters/z-waveme-z-stick/">Z-Wave.Me</a> , install the binding Z-Wave, run HABmin, add devices to the network.  Further we configure according to documentation to binding corresponding items, we write rules for switches, thermal heads, multi sensors and voila.  It seems simple.  However, it happened only partially.  The problem is that HABmin works only with devices registered <a href="https://products.z-wavealliance.org/">in the open database</a> .  If you bought a new device or a modification of an old one that is not in the database, you will not be able to configure such a device. <img src="https://habrastorage.org/webt/zm/vf/qq/zmvfqqmdnohuze6w20enx-ajbws.jpeg" align="right">  You can make a pull request to this database, but I found this approach to be fundamentally wrong, since Z-Wave devices have self-discovery function.  This is one of the reasons for the high compatibility of devices and controllers from different manufacturers of Z-Wave.  As a result, I had to buy a license for the Z-Wave software controller, the <a href="http://rus.z-wave.me/products-and-solutions">Z-Way server</a> , which I installed on the same server / nettop as openHAB.  It is used only when it is necessary to add / remove a device to the Z-Wave network and / or configure it.  The rest of the time the software controller is turned off. <br><br>  <i>In the photo - conventional switches Legrand.</i>  <i>Automated with the help of Z-Wave micromodules in podrozetniki.</i>  <i>The bottom has become a dimmer.</i> <br><br>  As a result, I had thermal heads on radiators, a dimmer and switches to power sockets, controlled sockets that measure voltage and power, and even a multi-sensor (motion, temperature, light).  It should be noted that I did not set up associations at the Z-Wave level, since I still have a centralized management model.  That is, despite the possibility of direct control of the device-device, they are all centrally controlled from openHAB using rules.  Well, or additionally mechanically, as is the case with switches in the socket. <br><br>  <b>What happened in terms of smart home:</b> <br><br><ol><li>  Automated light control. </li><li>  The movement at the stairs on the second floor is controlled.  Depending on the state of protection, either a set of alarming rules is triggered, or the light on the first floor is lit so that it is light to descend the stairs at night.  Since the multi-sensor is used, the air temperature is also measured. </li><li>  Automated management of multiple radiators.  When arming, they switch to the low temperature set in the settings in order to save electricity due to a more rational distribution of heat.  In addition, the control of night temperature in the bedroom is made - it automatically decreases by 1 degree for a comfortable sleep.  And of course the temperature can be set from a smart home. </li><li>  Control of the heated towel rail is automated.  Now it does not need to manually turn on / off.  In addition, it can be switched on remotely, in advance before arrival. </li></ol><br>  There is something else.  So far, we have been talking about integrating physical components with a smart home.  However, openHAB allows integration with software systems.  For example, with software DVRs or IP cameras.  It's not just about displaying an image in the openHAB interface, which of course has been done, but also about reacting to events.  For example, if a recorder or camera is configured to detect motion, this event can be sent to openHAB and used in management.  The above rule for turning on the light at night when going down stairs uses camera motion detection on the first floor (so as not to turn on the light when I go up the stairs).  Another example: in the security mode, you can take a picture of the intruder and send the photo by mail, and the violation can be fixed with a conventional PIR motion sensor, which is much more efficient than detecting movement by a camera or a DVR.  Moreover, the PIR-sensor can be connected to a smart home using arbitrary technology. <br><br><div class="spoiler">  <b class="spoiler_title">An example of a disturbing email with a photo of the intruder at the guest house.</b> <div class="spoiler_text">  Fortunately, the offender is forty.  Detected by PIR sensor. <br><br><img src="https://habrastorage.org/webt/yk/nn/je/yknnjecws_dpjgvmfds_unmd5mi.jpeg"><br></div></div><br>  Integration with the <a href="https://kodi.tv/">Kodi</a> media center is also made, for this there is a special binding.  When you start a video in the living room lights turn off, when you stop - turns on.  Also made, just in case, control from a smart home by Kodi himself.  It is less convenient to use it than with Kore's standard software console, but it is possible to launch Kodi from the interface of a smart home, which Kore cannot. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/xe/zz/2exezzpreyb2y_wxtnjzzmlisoi.jpeg"></div><br>  <i>Interface page with Kodi control and launch button.</i>  <i>Above shows the status of the player, the name of the song, the remaining time and duration.</i> <br><br><img src="https://habrastorage.org/webt/8a/1m/jg/8a1mjgdhurjmitlmcpda60jg7q4.jpeg" align="left">  Anticipating questions about the use of the MQTT protocol, let me remind you that with a centralized management model, intermediate links between the server and devices are possible, but, of course, reduce reliability.  Therefore, until now, all integration ties were direct, without intermediaries.  However, if we talk about a possible transition in the future or a partial transition to decentralized control, as potentially more extensible and more fault tolerant, then the choice of MQTT is standard.  This is a common transport for peer devices on a local area network. <br><br>  <i>Multifunctional controller based on Raspberry Pi 3B.</i>  <i>Visible temperature and humidity sensor, motion sensor, camera controlled socket, switch, which became the sensor.</i> <br><br>  OpenHAB, of course, has binding for MQTT.  <a href="http://mosquitto.org/">Mosquitto</a> is chosen by itself as the MQTT server itself.  But on what to install it - the question.  If it is implicitly or explicitly to pursue the goal of decentralizing control, then putting Mosquitto on a nettop, which has already become a single point of failure, is wrong.  And here the following logic worked.  The only non-automated room is the garage.  There is something to be done: to detect movement, light the lights inside and outside the house, open and monitor the state of the garage doors, conduct video surveillance, control the outlet for garden equipment.  And even something else that can only be done on a full-fledged operating system and that relates to ensuring information security.  As a result, the choice falls on the Raspberry Pi.  It also has pins for connecting standard DIY peripherals and full-fledged Linux with a huge number of ported applications.  And the video camera can be connected to it and broadcast the stream to the network.  And, importantly, the resources of the system, unlike the Arduino, allow you to build business logic of almost any reasonable complexity, getting rid of openHAB.  And all this can be programmed in familiar programming languages. <br><br>  As a result, all of these tasks have been solved, plus an MQTT server has appeared on the network, through which interaction with openHAB is organized and which will be used later when new devices with decentralized control appear. <br><br><div class="spoiler">  <b class="spoiler_title">Interesting detail</b> <div class="spoiler_text">  In the development process, it became necessary to measure analog signals (light sensor, current sensor, air quality sensor).  Plus, part of the periphery refused to work on regular for Raspberry Pi 3.3V, they need 5V.  These problems were solved simply and cheaply.  The additionally installed Arduino Nano, connected to the Raspberry Pi with wires over the I2C protocol, handled both tasks.  Those.  there is still no logic on the Arduino except for measuring physical parameters and executing commands.  All business logic on Raspberry Pi and openHAB. <br></div></div><br>  What happened in the end, if we describe in standard terms the characteristics of the entire system at the time of this writing? <br><br>  <b>Summary:</b> <br><br><ul><li>  Number of temperature sensors: 25. </li><li>  Number of light control points: 37, including dual switches, dimmer, and points without mechanical switches. </li><li>  In addition to light, a well pump, a DHW recirculation pump, cranes on heating branches, a boiler, a boiler, automatic gates, heating radiators, etc. are operated.  Measured humidity, voltage, current, light, air quality, etc. </li></ul><br>  <b>Used technologies:</b> <br><br><ul><li>  Central software: openHAB with bindings, Xeoma, Z-Way server, TTS, Mosquitto server, Kodi, individual C / C ++ applications.  OS - Ubuntu. </li><li>  Local controllers: Arduino + nRF24L01 +, Arduino + ENC82J60, ESP8266-12, Raspberry Pi 3 B, software written in C ++. </li><li>  Ready devices: USR IOT WiFi devices, Z-Wave (relays, sockets, dimmer, sensor, thermal heads) from different manufacturers, 433 MHz (switches with a Livolo remote control, sockets and a Brenin switch), Schneider Electric TCP-Modbus gateway, opening sensors and etc. </li></ul><br><div class="spoiler">  <b class="spoiler_title">What's next?</b> <div class="spoiler_text">  The next step is to turn off the heating radiators when opening the windows above them, monitoring the air quality in the living room with a fireplace, more confident detection of movement in the living room, etc.  There are more mundane tasks: when the greenhouse appears, automate watering according to the temperature and humidity of the soil. <br></div></div><br>  Instead of a conclusion.  We have not yet considered many aspects, for example, voice control, text-to-speech, air conditioner IR control, etc.  All this is done and working.  The purpose of this article was to show the course of thought, share the experience of choosing solutions, show the benefits of open standards and technologies through the description of ease of integration.  Everything that was done could have been done differently, better or worse, more expensive or cheaper, more functional or more reliable.  You get used to the good things quickly and after some time the questions of family members like: ‚ÄúBut can't you do it from a smartphone?‚Äù Or ‚Äúwhy does this flowerbed need to be watered by hand?‚Äù Make you move on to unattainable perfection. <br><br>  And I also believe in the limitless possibilities of the Internet of Things.  All that is done belongs to this category, but this is only a small part.  If after reading this article the number of IoT enthusiasts grows a little, I will consider my task fully accomplished. </div><p>Source: <a href="https://habr.com/ru/post/419151/">https://habr.com/ru/post/419151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419141/index.html">In the United States is gaining momentum sex phishing</a></li>
<li><a href="../419143/index.html">Creating an emulator arcade machine. Part 4</a></li>
<li><a href="../419145/index.html">Fintech Digest: Apple's capitalization exceeded $ 1 trillion, AI helped eBay raise billions in revenue</a></li>
<li><a href="../419147/index.html">1000-dimensional cube: is it possible to create a computational model of human memory today?</a></li>
<li><a href="../419149/index.html">Mikrotik RoMON Guide</a></li>
<li><a href="../419155/index.html">Porting JS to Elbrus</a></li>
<li><a href="../419161/index.html">Simulation of water surface using FFT and NeuroMatrix DSP-processor</a></li>
<li><a href="../419165/index.html">We send ‚Äúanonymous‚Äù SMS from the Console to the desired number using the bytehand service and C ++</a></li>
<li><a href="../419169/index.html">"World of the Wild West" eyes of the developer</a></li>
<li><a href="../419171/index.html">Disabling runtime status checks in an Android application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>