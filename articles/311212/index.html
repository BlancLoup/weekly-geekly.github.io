<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installation and optimal configuration of Nginx + LAMP (CentOS 7)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently decided to move from hosting to VPS, we will use: CentOS 7, Nginx, Apache, PHP, MySQL. Despite the large number of articles on this topic, ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installation and optimal configuration of Nginx + LAMP (CentOS 7)</h1><div class="post__text post__text-html js-mediator-article">  Recently decided to move from hosting to VPS, we will use: CentOS 7, Nginx, Apache, PHP, MySQL.  Despite the large number of articles on this topic, many aspects are not mentioned, so we lay out this article to hear the opinion of knowledgeable and experienced people.  Configuring the server as you already understood will be the first time, so the relevance of the article can be judged from the comments.  Nginx will give statics, and Apache dynamics (PHP scripts) to reduce server load. <br><br>  <b>Training.</b> <br><br>  We will apply all settings on the working server of our project with the server configuration: CPU - 2 √ó 2000 MHz and RAM - 2048 MB. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To get started, we find a suitable VPS with CentOS 7 preinstalled, we will connect to the server via SSH via <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">PuTTY</a> . <br><br>  Enter the host name and port, click Open: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c0/a0b/36c/4c0a0b36cc171d458fa284a33128f5b9.png" alt="image"><br><br>  Next, enter the login [Enter], then the password (note that the password is not displayed) [Enter]: <br><br><a name="habracut"></a><br>  Upgrade the system, while maintaining outdated versions of packages: <br><blockquote><code>[root@test ~]# yum update</code> </blockquote> <br>  Or upgrade all packages, old packages will be deleted: <br><blockquote> <code>[root@test ~]# yum upgrade</code> </blockquote> <br>  Install the file manager with a text interface - Midnight Commander: <br><blockquote> <code>[root@test ~]# yum install mc</code> </blockquote> <br>  Install the text editor - <a href="https://habrahabr.ru/post/106554/">Nano</a> : <br><blockquote> <code>[root@test ~]# yum install nano</code> </blockquote> <br>  We check how much RAM is available on the server and how much is available, as well as the presence of SWAP.  When the memory runs out, the data is moved to disk, which slows down the server, SWAP operation is undesirable, but allows you to insure yourself: <br><blockquote> <code>[root@test ~]# free -m</code> </blockquote> <br>  <b>We create file structure and users for sites.</b> <br><br>  Create a directory (folder) for files for all sites: <br><blockquote> <code>[root@test ~]# cd / <br> [root@test ~]# mkdir -m 755 website</code> </blockquote> <br>  <u>Under each individual site perform such actions.</u> <br><br>  The content of each site will be in its own directory, so we create a new user and a separate directory to differentiate access rights: <br>  -b folder in which the user directory will be created <br>  -m create directory <br>  -U create a group with the same name as the user <br>  -s / bin / false disable user shell <br><blockquote> <code>[root@test ~]# useradd name.site -b /website/ -m -U -s /bin/false</code> </blockquote> <br>  We create directories for site data (site files, logs and temporary files): <br><blockquote> <code>[root@test ~]# mkdir -p -m 754 /website/name.site/www <br> [root@test ~]# mkdir -p -m 754 /website/name.site/logs <br> [root@test ~]# mkdir -p -m 777 /website/name.site/tmp</code> </blockquote> <br>  Change the owner and group to a directory, including subfolders: <br><blockquote> <code>[root@test ~]# chown -R name.site:name.site /website/name.site/</code> </blockquote> <br>  Change directory permissions - name.site: <br><blockquote> <code>[root@test ~]# chmod 755 /website/name.site</code> </blockquote> <br>  <b>Install Nginx.</b> <br><br>  Installation instructions are provided on the official <a href="http://nginx.org/ru/linux_packages.html">Nginx</a> website. <br><br>  To configure the yum repository in CentOS, create the file /etc/yum.repos.d/nginx.repo: <br><blockquote> <code>[root@test ~]# cd /etc/yum.repos.d <br> [root@test ~]# touch nginx.repo</code> </blockquote> <br>  Open the nginx.repo file: <br><blockquote> <code>[root@test ~]# nano /etc/yum.repos.d/nginx.repo</code> </blockquote> <br>  Paste this content and save the file: <br><blockquote> <code>[nginx] <br> name=nginx repo <br> baseurl=http://nginx.org/packages/centos/7/$basearch/ <br> gpgcheck=1 <br> enabled=1</code> </blockquote> <br>  To verify the signature, download the key and import it into the rpm package manager: <br><blockquote> <code>[root@test ~]# rpm --import http://nginx.org/keys/nginx_signing.key</code> </blockquote> <br>  Install Nginx: <br><blockquote> <code>[root@test ~]# yum install nginx</code> </blockquote> <br>  Run: <br><blockquote> <code>[root@test ~]# systemctl start nginx.service</code> </blockquote> <br><img src="https://habrastorage.org/getpro/habr/post_images/e34/072/e41/e34072e41e8ff8203ebda614dc6bde5f.png" alt="image"><br><br>  Temporarily stop: <br><blockquote> <code>[root@test ~]# systemctl stop nginx.service</code> </blockquote> <br>  <b>Install Apache and PHP.</b> <br><br>  Install Apache (on CentOS - httpd): <br><blockquote> <code>[root@test ~]# yum install httpd</code> </blockquote> <br>  Install PHP: <br><blockquote> <code>[root@test ~]# yum install php</code> </blockquote> <br>  Run Apache: <br><blockquote> <code>[root@test ~]# systemctl start httpd.service</code> </blockquote> <br><img src="https://habrastorage.org/getpro/habr/post_images/b48/dcb/f8d/b48dcbf8dd154b9ef6a7d54e9c7ed869.png" alt="image"><br>  Temporarily stop: <br><blockquote> <code>[root@test ~]# systemctl stop httpd.service</code> </blockquote> <br>  <b>We configure Nginx.</b> <br><br>  Add to autoload: <br><blockquote> <code>[root@test ~]# systemctl enable nginx.service</code> </blockquote> <br>  Open the main configuration file: <br><blockquote> <code>[root@test ~]# nano /etc/nginx/nginx.conf</code> </blockquote> <br>  We edit and save: <br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/nginx.conf</b> <div class="spoiler_text"><blockquote> <code>user nginx; <br> worker_processes 2; <br> pid /var/run/nginx.pid; <br> <br> events { <br> worker_connections 1024; <br> multi_accept on; <br> } <br> <br> http { <br> error_log /var/log/nginx/error.log warn; <br> access_log off; <br> <br> charset utf-8; <br> server_tokens off; <br> <br> include /etc/nginx/mime.types; <br> default_type application/octet-stream; <br> <br> reset_timedout_connection on; <br> client_header_timeout 15; <br> client_body_timeout 30; <br> send_timeout 15; <br> keepalive_timeout 5; <br> keepalive_requests 30; <br> client_max_body_size 8m; <br> <br> limit_rate_after 30M; <br> limit_rate 500K; <br> <br> open_file_cache max=10000 inactive=3m; <br> open_file_cache_min_uses 2; <br> open_file_cache_valid 1m; <br> <br> sendfile on; <br> tcp_nodelay on; <br> tcp_nopush on; <br> <br> include /etc/nginx/conf.d/*.conf; <br> }</code> </blockquote> <br></div></div><br>  From which user we start Nginx: <br><blockquote> <code>user nginx;</code> </blockquote> <br>  Specify the number of working processes (depending on the number of processor cores and the number of hard drives, because the disk head will not be able to move faster): <br><blockquote> <code>worker_processes 2;</code> </blockquote> <br>  Process ID of the running server: <br><blockquote> <code>pid  /var/run/nginx.pid;</code> </blockquote> <br>  Events section: <br><blockquote> <code>events { <br> # <br> }</code> </blockquote> <br>  Inside the events block, the maximum number of simultaneous connections to the server (worker_processes √ó worker_connections): <br><blockquote> <code>worker_connections 1024;</code> </blockquote> <br>  Inside the events block, accept connections as much as possible: <br><blockquote> <code>multi_accept on;</code> </blockquote> <br>  Section http, the rest will be inside it: <br><blockquote> <code>http { <br> # <br> }</code> </blockquote> <br>  Write errors (levels: warn, error, crit, alert) at the specified path: <br><blockquote> <code>error_log /var/log/nginx/error.log warn;</code> </blockquote> <br>  Turning off the access log entry (the hard disk will thank you): <br><blockquote> <code>access_log off;</code> </blockquote> <br>  Set the default encoding: <br><blockquote> <code>charset utf-8;</code> </blockquote> <br>  Disable the display version of Nginx: <br><blockquote> <code>server_tokens off;</code> </blockquote> <br>  Connect mimetypes: <br><blockquote> <code>include /etc/nginx/mime.types;</code> </blockquote> <br>  If the MIME type of the file cannot be determined, then by default the file will be binary: <br><blockquote> <code>default_type application/octet-stream;</code> </blockquote> <br>  Close the connection if the client does not respond: <br><blockquote> <code>reset_timedout_connection on;</code> </blockquote> <br>  Read client request header no more than 15 seconds: <br><blockquote> <code>client_header_timeout 15;</code> </blockquote> <br>  Read client request body no more than 30 seconds - the interval is set not for the entire transfer of the request body, but only between two consecutive reads: <br><blockquote> <code>client_body_timeout 30;</code> </blockquote> <br>  If the client does not accept the response for more than 15 seconds, reset the connection: <br><blockquote> <code>send_timeout 15;</code> </blockquote> <br>  Keep the connection open for no more than five seconds: <br><blockquote> <code>keepalive_timeout 5;</code> </blockquote> <br>  Maximum number of requests with an open connection from one client: <br><blockquote> <code>keepalive_requests 30;</code> </blockquote> <br>  We will not accept requests larger than 8 megabytes: <br><blockquote> <code>client_max_body_size 8m;</code> </blockquote> <br>  To prevent one user from occupying the entire free traffic channel, after 30 MB we impose a limit on the speed of data transfer: <br><blockquote> <code>limit_rate_after 30M;</code> </blockquote> <br>  The maximum speed with the client within one connection after the imposed restrictions will be no more than 500 Kb / s: <br><blockquote> <code>limit_rate 500K;</code> </blockquote> <br>  Set the maximum number of files, information about which will be contained in the cache and deleted if the file is not requested again within 3 minutes: <br><blockquote> <code>open_file_cache max=10000 inactive=3m;</code> </blockquote> <br>  If the file is requested more than 2 times, put in the cache: <br><blockquote> <code>open_file_cache_min_uses 2;</code> </blockquote> <br>  Check cache for every minute: <br><blockquote> <code>open_file_cache_valid 1m;</code> </blockquote> <br>  Give statics without intermediaries: <br><blockquote> <code>sendfile on;</code> </blockquote> <br>  Do not buffer data: <br><blockquote> <code>tcp_nodelay on;</code> </blockquote> <br>  Send headers in one batch: <br><blockquote> <code>tcp_nopush on;</code> </blockquote> <br>  Connect configs: <br><blockquote> <code>include /etc/nginx/conf.d/*.conf;</code> </blockquote> <br>  <b>For each site we create a virtual host Nginx.</b> <br><br>  In order for Nginx to access the site files, add the user nginx to the group name.site: <br><blockquote> <code>[root@test ~]# usermod -a -G name.site nginx</code> </blockquote> <br>  Then we create a configuration file: <br><blockquote> <code>[root@test ~]# touch /etc/nginx/conf.d/name.site.conf</code> </blockquote> <br>  Open the file: <br><blockquote> <code>[root@test ~]# nano /etc/nginx/conf.d/name.site.conf</code> </blockquote> <br>  We edit and save: <br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/name.site.conf</b> <div class="spoiler_text"><blockquote> <code>server { <br> listen 80; <br> server_name name.site www.name.site; <br> #access_log /website/name.site/logs/nginx_access.log; <br> error_log /website/name.site/logs/nginx_error.log; <br> <br> location / { <br> proxy_pass http://127.0.0.1:8080/; <br> proxy_read_timeout 300s; <br> proxy_set_header Host $host; <br> proxy_set_header X-Real-IP $remote_addr; <br> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; <br> proxy_buffering off; <br> } <br> <br> location ~* \.(css|js|png|gif|jpg|jpeg|ico)$ { <br> root /website/name.site/www; <br> expires 1d; <br> } <br> <br> error_page 500 502 503 504 /50x.html; <br> location = /50x.html { <br> root /usr/share/nginx/html; <br> } <br> }</code> </blockquote> <br></div></div><br>  The server listens on port 80: <br><blockquote> <code>listen 80;</code> </blockquote> <br>  The server name, determines in which block the request will be executed, indicate the domain name: <br><blockquote> <code>server_name name.site www.name.site;</code> </blockquote> <br>  Path to the Nginx error log of a specific site: <br><blockquote> <code>error_log /serves/name.site/logs/nginx_error.log;</code> </blockquote> <br>  Redirect Apache Request: <br><blockquote> <code>proxy_pass http://127.0.0.1:8080/;</code> </blockquote> <br>  Disconnect the connection after 300 seconds if the timeout is exceeded while reading the response from the Apache server: <br><blockquote> <code>proxy_read_timeout 300s;</code> </blockquote> <br>  Submit Headers: <br><blockquote> <code>proxy_set_header Host $host;</code> </blockquote> <br>  Transfer client IP: <br><blockquote> <code>proxy_set_header X-Real-IP $remote_addr;</code> </blockquote> <br>  Send the list of servers for which the request was passed and add your own: <br><blockquote> <code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> </blockquote> <br>  Disable buffering of the proxied server: <br><blockquote> <code>proxy_buffering off;</code> </blockquote> <br>  Nginx will give statics: <br><blockquote> <code>location ~* \.(css|js|png|gif|jpg|jpeg|ico)$ { <br> root /serves/name.site/www; <br> expires 1d; <br> }</code> </blockquote> <br>  <b>Configure Apache.</b> <br><br>  See which Apache module you have installed.  I have apache2-mpm-prefork (one process with one thread will handle one connection, recommended as secure with PHP): <br><blockquote> <code>[root@test ~]# apachectl -V</code> </blockquote> <br>  Open httpd.conf: <br><blockquote> <code>[root@test ~]# nano /etc/httpd/conf/httpd.conf</code> </blockquote> <br>  We edit and save: <br><div class="spoiler">  <b class="spoiler_title">httpd.conf</b> <div class="spoiler_text"><blockquote> <code>ServerRoot "/etc/httpd" <br> DocumentRoot "/website" <br> Include conf.modules.d/*.conf <br> <br> User apache <br> Group apache <br> <br> Listen 127.0.0.1:8080 <br> ServerName 127.0.0.1:8080 <br> ServerAdmin root@localhost <br> <br> ServerSignature Off <br> ServerTokens Prod <br> <br> RLimitMEM 786432000 <br> TimeOut 250 <br> <br> AddDefaultCharset utf-8 <br> DefaultLanguage ru <br> <br> KeepAlive Off <br> ContentDigest Off <br> EnableSendfile off <br> <br> ErrorLog "logs/error_log" <br> LogLevel error <br> <br> &lt;IfModule mime_module&gt; <br> TypesConfig /etc/mime.types <br> &lt;/IfModule&gt; <br> <br> &lt;Directory /&gt; <br> DirectoryIndex index.php <br> AllowOverride none <br> Require all denied <br> &lt;/Directory&gt; <br> <br> &lt;IfModule mpm_prefork_module&gt; <br> StartServers 5 <br> MinSpareServers 5 <br> MaxSpareServers 10 <br> MaxClients 30 <br> MaxRequestsPerChild 2500 <br> &lt;/IfModule&gt; <br> <br> &lt;Files ".ht*"&gt; <br> Require all denied <br> &lt;/Files&gt; <br> <br> IncludeOptional sites-enabled/*.conf <br></code> </blockquote><br></div></div><br>  Install the Apache root directory: <br><blockquote> <code>ServerRoot "/etc/httpd"</code> </blockquote> <br>  The directory where the site files will be stored: <br><blockquote> <code>DocumentRoot "/website"</code> </blockquote> <br>  We load configuration files: <br><blockquote> <code>Include conf.modules.d/*.conf</code> </blockquote> <br>  From which user we start the server: <br><blockquote> <code>User apache</code> </blockquote> <br>  From which group we start the server: <br><blockquote> <code>Group apache</code> </blockquote> <br>  Specify the IP and port from which we will receive requests, from the outside this server will not be visible: <br><blockquote> <code>Listen 127.0.0.1:8080</code> </blockquote> <br>  Hostname and port to identify yourself: <br><blockquote> <code>ServerName 127.0.0.1:8080</code> </blockquote> <br>  Email address that is sent to the client in case of errors: <br><blockquote> <code>ServerAdmin root@localhost</code> </blockquote> <br>  Disable sending the version information of the system and the Apache server: <br><blockquote> <code>ServerSignature Off</code> </blockquote> <br>  Disable sending Apache information to the client in the header: <br><blockquote> <code>ServerTokens Prod</code> </blockquote> <br>  We limit memory usage to 750 megabytes: <br><blockquote> <code>RLimitMEM 786432000</code> </blockquote> <br>  Maximum time for receiving a request, processing, sending content to the Nginx server: <br><blockquote> <code>TimeOut 250</code> </blockquote> <br>  Set the encoding: <br><blockquote> <code>AddDefaultCharset utf-8</code> </blockquote> <br>  Set the content language: <br><blockquote> <code>DefaultLanguage ru</code> </blockquote> <br>  Turning off the processing of a large number of requests in one connection: <br><blockquote> <code>KeepAlive Off</code> </blockquote> <br>  Disable the generation of Content-MD5 HTTP headers: <br><blockquote> <code>ContentDigest Off</code> </blockquote> <br>  Apache will not give statics, so disable: <br><blockquote> <code>EnableSendfile off</code> </blockquote> <br>  We write Apache errors at the specified path / etc / httpd / logs / error_log: <br><blockquote> <code>ErrorLog "logs/error_log"</code> </blockquote> <br>  We indicate at what level to record errors: <br><blockquote> <code>LogLevel error</code> </blockquote> <br>  Connect mimetypes: <br><blockquote> <code>&lt;IfModule mime_module&gt; <br> TypesConfig /etc/mime.types <br> &lt;/IfModule&gt; <br></code> </blockquote><br>  Directory section: <br><blockquote> <code>&lt;Directory /&gt; <br> ... <br> &lt;/Directory&gt; <br></code> </blockquote><br>  Inside the Directory block, in the case of specifying the path to the directory, by default give index.php :: <br><blockquote> <code>DirectoryIndex index.php</code> </blockquote> <br>  Inside the Directory block, prohibit overriding access information in .htaccess: <br><blockquote> <code>AllowOverride none</code> </blockquote> <br>  Inside the Directory block, deny access to server files: <br><blockquote> <code>Require all denied</code> </blockquote> <br>  Mpm_prefork_module Section: <br><blockquote> <code>&lt;IfModule mpm_prefork_module&gt; <br> ... <br> &lt;/IfModule&gt;</code> </blockquote> <br>  Inside the mpm_prefork_module block, after running Apache, create 5 processes: <br><blockquote> <code>StartServers 5</code> </blockquote> <br>  Inside the mpm_prefork_module block, the minimum number of unused processes (if all processes are busy, new free processes will start): <br><blockquote> <code>MinSpareServers 5</code> </blockquote> <br>  Inside the mpm_prefork_module block, the maximum number of unused (spare) processes: <br><blockquote> <code>MaxSpareServers 10</code> </blockquote> <br>  Inside the mpm_prefork_module block, the maximum number of child processes that can be started simultaneously, the rest are queued (with an increase in child processes, the memory consumption increases): <br><blockquote> <code>MaxClients 30</code> </blockquote> <br>  Inside the mpm_prefork_module block, after the specified number of processed requests, the process is restarted (necessary for overflow - memory leaks): <br><blockquote> <code>MaxRequestsPerChild 2500</code> </blockquote> <br>  We close access to .htaccess: <br><blockquote> <code>&lt;Files ".ht*"&gt; <br> Require all denied <br> &lt;/Files&gt;</code> </blockquote> <br>  We load configuration files: <br><blockquote> <code>IncludeOptional sites-enabled/*.conf</code> </blockquote> <br>  <b>For each site we create a virtual host Apache.</b> <br><br>  Add the apache user to the group of each site: <br><blockquote> <code>[root@test ~]# usermod -a -G name.site apache</code> </blockquote> <br>  Create a directory for Apache virtual host configuration files: <br><blockquote> <code>[root@test ~]# mkdir /etc/httpd/sites-enabled</code> </blockquote> <br>  Create a configuration file: <br><blockquote> <code>[root@test ~]# touch /etc/httpd/sites-enabled/name.site.conf</code> </blockquote> <br>  Open the file: <br><blockquote> <code>[root@test ~]# nano /etc/httpd/sites-enabled/name.site.conf</code> </blockquote> <br>  We edit and save: <br><div class="spoiler">  <b class="spoiler_title">/etc/httpd/sites-enabled/name.site.conf</b> <div class="spoiler_text"><blockquote> <code>&lt;VirtualHost *:8080&gt; <br> ServerName name.site <br> ServerAlias www.name.site <br> <br> DocumentRoot /website/name.site/www <br> <br> &lt;Directory "/website/name.site"&gt; <br> AllowOverride None <br> Require all granted <br> &lt;/Directory&gt; <br> <br> DirectoryIndex index.php <br> <br> ErrorLog /website/name.site/logs/error.log <br> CustomLog /website/name.site/logs/requests.log combined <br> &lt;/VirtualHost&gt; <br></code> </blockquote><br></div></div><br><br>  Block VirtualHost, which port is indicated to listen: <br><blockquote> <code>&lt;VirtualHost *:8080&gt; <br> ... <br> &lt;/VirtualHost&gt; <br></code> </blockquote><br>  Domain name: <br><blockquote> <code>ServerName name.site</code> </blockquote> <br>  Domain Mirror: <br><blockquote> <code>ServerAlias www.name.site</code> </blockquote> <br>  The directory where the files of this site will be stored: <br><blockquote> <code>DocumentRoot /website/name.site/www</code> </blockquote> <br>  Open access to site files: <br><blockquote> <code>Require all granted</code> </blockquote> <br>  If the path is to the directory, by default open: <br><blockquote> <code>DirectoryIndex index.php</code> </blockquote> <br>  The path to the Apache error log of a specific site: <br><blockquote> <code>ErrorLog /website/name.site/logs/error.log</code> </blockquote> <br>  Access log path: <br><blockquote> <code>CustomLog /website/name.site/logs/requests.log combined</code> </blockquote> <br>  <b>Check Nginx and Apache.</b> <br><br>  Add Apache to autoload: <br><blockquote> <code>[root@test ~]# systemctl enable httpd.service <br></code> </blockquote><br>  Create, edit and save the file: <br><blockquote> <code>[root@test ~]# touch /website/name.site/www/index.php <br> [root@test ~]# nano /website/name.site/www/index.php <br></code> </blockquote><br>  Copy the php config: <br><blockquote> <code>[root@test ~]# cp /etc/httpd/conf.d/php.conf /etc/httpd/sites-enabled/php.conf <br></code> </blockquote><br>  Run Nginx and Apache: <br><blockquote> <code>[root@test ~]# systemctl start nginx.service <br> [root@test ~]# systemctl start httpd.service <br></code> </blockquote><br>  <b>We configure PHP.</b> <br><br>  Open php.ini: <br><blockquote> <code>[root@test ~]# nano /etc/php.ini</code> </blockquote> <br>  We edit and save: <br><div class="spoiler">  <b class="spoiler_title">/etc/php.ini</b> <div class="spoiler_text"><blockquote> <code>engine = On <br> expose_php = Off <br> short_open_tag = Off <br> zlib.output_compression = Off <br> disable_functions = exec, passthru, shell_exec, system, proc_open, popen, curl_exec, curl_multi_exec, parse_ini_file, show_source, etc <br> <br> display_startup_errors = Off <br> display_errors = Off <br> log_errors = On <br> error_log = "/usr/local/zend/var/log/php.log" <br> ignore_repeated_errors = Off <br> ignore_repeated_source = Off <br> html_errors = On <br> <br> implicit_flush = Off <br> output_buffering = 4K <br> realpath_cache_size = 2M <br> realpath_cache_ttl = 1800 <br> zend.enable_gc = On <br> <br> max_input_time = 200 <br> max_execution_time = 30 <br> file_uploads = On <br> <br> memory_limit = 256M <br> post_max_size = 8M <br> upload_max_filesize = 2M <br> max_file_uploads = 4 <br> <br> extension_dir = "/usr/local/zend/lib/php_extensions" <br> date.timezone = Europe/Moscow <br> default_mimetype = "text/html" <br> default_charset = "UTF-8" <br> <br> variables_order = "CGPS" <br> register_argc_argv = Off <br> auto_globals_jit = On <br> enable_dl = Off <br> <br> allow_url_fopen = On <br> allow_url_include = Off</code> </blockquote> <br></div></div><br>  We enable the PHP interpreter, if necessary, you can turn it off on a specific site: <br><blockquote> <code>engine = On</code> </blockquote> <br>  Disable the headers sent to the client about PHP: <br><blockquote> <code>expose_php = Off</code> </blockquote> <br>  Disable short PHP tag entries &lt;? ...?&gt;: <br><blockquote> <code>short_open_tag = Off</code> </blockquote> <br>  Turn off page compression: <br><blockquote> <code>zlib.output_compression = Off</code> </blockquote> <br>  Disable dangerous functions: <br><blockquote> <code>disable_functions = exec, passthru, shell_exec, system, proc_open, popen, curl_exec, curl_multi_exec, parse_ini_file, show_source, etc</code> </blockquote> <br>  Do not display errors when PHP starts: <br><blockquote> <code>display_startup_errors = Off</code> </blockquote> <br>  Do not show errors: <br><blockquote> <code>display_errors = Off</code> </blockquote> <br>  We log errors after turning off their display on the screen: <br><blockquote> <code>log_errors = On</code> </blockquote> <br>  File in which errors will be recorded: <br><blockquote> <code>error_log = "/usr/local/zend/var/log/php.log"</code> </blockquote> <br>  Do not write the same errors that occur in a specific file and line (ignore_repeated_source - you need to turn it off): <br><blockquote> <code>ignore_repeated_errors = Off</code> </blockquote> <br>  When enabled, it does not record the same errors that can occur in different files and lines, so turn off: <br><blockquote> <code>ignore_repeated_source = Off</code> </blockquote> <br>  Turn off HTML tags when viewing error messages: <br><blockquote> <code>html_errors = On</code> </blockquote> <br>  Adding data to the buffer: <br><blockquote> <code>implicit_flush = Off</code> </blockquote> <br>  <a href="https://habrahabr.ru/company/mailru/blog/248573/">Output buffering</a> for all files, maximum number: <br><blockquote> <code>output_buffering = 4K</code> </blockquote> <br>  We use <a href="https://habrahabr.ru/post/266909/">the realpath cache</a> , thereby reducing the number of stat () calls: <br><blockquote> <code>realpath_cache_size = 2M</code> </blockquote> <br>  Set the cache storage time to 30 minutes: <br><blockquote> <code>realpath_cache_ttl = 1800</code> </blockquote> <br>  Turn on circular link collector: <br><blockquote> <code>zend.enable_gc = On</code> </blockquote> <br>  Specify the maximum time during which data will be received on the server (POST, GET, HEAD), the time is measured from running PHP until the script runs: <br><blockquote> <code>max_input_time = 200</code> </blockquote> <br>  Specify the maximum runtime of the script (the value is not more than Apache - Timeout) - instead of <a href="http://php.net/manual/ru/function.set-time-limit.php">set_time_limit</a> : <br><blockquote> <code>max_execution_time = 30</code> </blockquote> <br>  Allow uploading files to server: <br><blockquote> <code>file_uploads = On</code> </blockquote> <br>  The maximum size of memory that can be used by the script: <br><blockquote> <code>memory_limit = 256M</code> </blockquote> <br>  The maximum size of data sent by the POST method (should be less than - memory_limit): <br><blockquote> <code>post_max_size = 8M</code> </blockquote> <br>  The maximum size of the uploaded file (must be less - post_max_size): <br><blockquote> <code>upload_max_filesize = 2M</code> </blockquote> <br>  Number of files that can be transferred in one request: <br><blockquote> <code>max_file_uploads = 4</code> </blockquote> <br>  Path to the directory with extension modules: <br><blockquote> <code>extension_dir = "/usr/local/zend/lib/php_extensions"</code> </blockquote> <br>  Set the time zone: <br><blockquote> <code>date.timezone = Europe/Moscow</code> </blockquote> <br>  Data Type: <br><blockquote> <code>default_mimetype = "text/html"</code> </blockquote> <br>  Install the UTF-8 encoding: <br><blockquote> <code>default_charset = "UTF-8"</code> </blockquote> <br>  The order of processing variables is $ _COOKIE, $ _GET, $ _POST, $ _SERVER: <br><blockquote> <code>variables_order = "CGPS"</code> </blockquote> <br>  Do not declare argv and argc variables: <br><blockquote> <code>register_argc_argv = Off</code> </blockquote> <br>  The variables SERVER and ENV will be created at the time of use, which leads to an increase in performance: <br><blockquote> <code>auto_globals_jit = On</code> </blockquote> <br>  Turn off dynamic podgruzku, affects the security: <br><blockquote> <code>enable_dl = Off</code> </blockquote> <br>  We allow working with external files by URL: <br><blockquote> <code>allow_url_fopen = On</code> </blockquote> <br>  Disable the use of external files: <br><blockquote> <code>allow_url_include = Off</code> </blockquote> <br>  <b>Install and configure MySQL.</b> <br><br>  Tear off my.cnf: <br><blockquote> <code>[root@test ~]# nano /etc/mysql/my.cnf</code> </blockquote> <br>  The number of parallel processes that handle competitive requests to MySQL (the number of cores multiplied by two): <br><blockquote> <code>thread_concurrency = 4</code> </blockquote> <br>  Set the default encoding for new tables: <br><blockquote> <code>default-character-set = utf8</code> </blockquote> <br>  We will use InnoDB tables: <br><blockquote> <code>default-storage-engine = InnoDB</code> </blockquote> <br>  Set the size of the buffer indexes of tables in RAM (relevant for MyISAM tables): <br><blockquote> <code>key_buffer_size = 5M</code> </blockquote> <br>  Data buffer and table indexes - InnoDB: <br><blockquote> <code>innodb_buffer_pool_size = 300M</code> </blockquote> <br>  The maximum amount of RAM allocated for temporary tables created by MySQL: <br><blockquote> <code>tmp_table_size = 50M</code> </blockquote> <br>  The maximum number of open tables that will be in the cache: <br><blockquote> <code>table_open_cache = 64</code> </blockquote> <br>  The data buffer used to write information to disk is InnoDB: <br><blockquote> <code>innodb_log_buffer_size = 0M</code> </blockquote> <br>  Disable <a href="https://habrahabr.ru/post/41166/">query caching</a> : <br><blockquote> <code>query_cache_size = 0</code> </blockquote> <br>  The size of the buffer used for sorting (ORDER BY) or grouping BY BY of data in each stream: <br><blockquote> <code>sort_buffer_size = 512K</code> </blockquote> <br>  We allocate memory for each stream for each table. Increasing this value can affect the speed of the query: <br><blockquote> <code>read_buffer_size = 512K</code> </blockquote> <br>  Affects the speed of sorting, for queries with - ORDER BY: <br><blockquote> <code>read_rnd_buffer_size = 1M</code> </blockquote> <br>  Buffer size using JOIN if indexes are not used in these queries: <br><blockquote> <code>join_buffer_size = 2M</code> </blockquote> <br>  Stack size, space for storing a list of tasks (open or close a table, execute a query, etc.): <br><blockquote> <code>thread_stack = 1M</code> </blockquote> <br>  Allocate memory for the connection buffer and its results, can be increased to max_allowed_packet: <br><blockquote> <code>net_buffer_length = 30K</code> </blockquote> <br>  The maximum size of data that can be transmitted in one request: <br><blockquote> <code>max_allowed_packet = 5M</code> </blockquote> <br>  Maximum number of simultaneous connections: <br><blockquote> <code>max_connections = 75</code> </blockquote> <br>  The number of connections that can queue: <br><blockquote> <code>back_log = 250</code> </blockquote> <br>  Play only localhost: <br><blockquote> <code>bind-address = 127.0.0.1</code> </blockquote> <br>  Do not use TCP / IP connections, transfer data through a socket: <br><blockquote> <code>skip-networking</code> </blockquote> <br>  To calculate the approximate consumption of RAM on the MySQL server (as I understand it), you can use the following formula (do not forget that the Apache server has already allocated 750 MB and still need to leave the Nginx server): <br><blockquote> <code>key_buffer_size + innodb_buffer_pool_size + tmp_table_size + ((sort_buffer_size + read_buffer_size + read_rnd_buffer_size + join_buffer_size + thread_stack) √ó max_connections) = ?</code> </blockquote> <br>  <b>A little about security.</b> <br><br>  It is undesirable to enter as root, so we create a new user: <br><blockquote> <code>[root@test ~]# adduser newuser</code> </blockquote> <br>  We set the password to the user - newuser: <br><blockquote> <code>[root@test ~]# passwd newuser</code> </blockquote> <br>  Install the sudo package: <br><blockquote> <code>[root@test ~]# yum install sudo</code> </blockquote> <br>  We bring a new user to sudo: <br><blockquote> <code>[root@test ~]# gpasswd -a newuser wheel</code> </blockquote> <br>  If you connect to SSH via port 22, then you need to change it, open sshd_config: <br><blockquote> <code>[root@test ~]# nano /etc/ssh/sshd_config</code> </blockquote> <br>  We change the port to any free one (do not forget to close port 22 using the firewall installed on your site and open a new one, for example 54139): <br><blockquote> <code>Port 54139</code> </blockquote> <br>  Forbid trying to log in with an empty password: <br><blockquote> <code>PermitEmptyPasswords no</code> </blockquote> <br>  Denying access to the root terminal: <br><blockquote> <code>PermitRootLogin no</code> </blockquote> <br>  Let us allow only the new user to log in to the terminal - <br>  newuser: <br><blockquote> <code>AllowUsers newuser</code> </blockquote> <br>  Reboot ssh: <br><blockquote> <code>[root@test ~]# service sshd restart</code> </blockquote> <br><br>  PS You can use Nginx with php-fpm, but there is such an opinion that with properly configured Apache, there is not much difference in performance. <br><br>  We wanted to pay special attention to the security and performance of the server, so if you find any errors or shortcomings, please write this in the comments and, if necessary, we will make changes to the article. </div><p>Source: <a href="https://habr.com/ru/post/311212/">https://habr.com/ru/post/311212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311202/index.html">The best vacancies at My Circle for the week, September 12-18</a></li>
<li><a href="../311204/index.html">Mobile user behavior scenarios have pushed Google AdWords to introduce end-to-end remarketing</a></li>
<li><a href="../311206/index.html">Launching a payment aggregator or e-wallet: features of Russian legislation and success secrets</a></li>
<li><a href="../311208/index.html">Microservices: please do not need</a></li>
<li><a href="../311210/index.html">Complex Data Visualization Algorithm</a></li>
<li><a href="../311214/index.html">When exceptions are needed</a></li>
<li><a href="../311218/index.html">How do we test the server code without mobile clients?</a></li>
<li><a href="../311220/index.html">Programming & Music: we understand and write VSTi synthesizer on C # WPF. Part 1</a></li>
<li><a href="../311224/index.html">The history of one study in log4net and its acceleration more than 10 times</a></li>
<li><a href="../311226/index.html">JSX: antipattern or not?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>