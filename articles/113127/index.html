<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Having fun with hashes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. I want to show you a little trick. First you need to download the archive with two files . Both are the same size and the same md5 sum. Check no ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Having fun with hashes</h1><div class="post__text post__text-html js-mediator-article">  Hey.  I want to show you a little trick.  First you need to download the <a href="">archive with two files</a> .  Both are the same size and the same md5 sum.  Check no cheating there.  The md5 hash of both is equal to ecea96a6fea9a1744adcc9802ab7590d.  Now run the program good.exe and you will see the following on the screen. <img src="https://habrastorage.org/storage/99a24d9b/3bed6aad/cf591bea/9e63508e.jpg"><br>  Try running the evil.exe program. <img src="https://habrastorage.org/storage/2b9636c7/7c4d9967/329a5662/f127c806.jpg"><br>  Something went wrong?  Want to try it yourself? <a name="habracut"></a><br><br><h4>  About hashes and collisions </h4><br>  In fact, there is nothing new in all this.  In fact, this effect is achieved through methods for quickly searching for collisions for a hash function developed back in 2004‚Äì2006.  If anyone knows, a collision is two different data sets that have the same hash value.  So, in 2004, a group of Chinese researchers developed an algorithm based on differential cryptoanalysis, allowing for a relatively short time to find two different random data blocks, 128 bytes each, having the same md5 sum.  And although this algorithm at one time produced the effect of an exploded bomb, its speed left much to be desired.  But already in 2006, the Czech cryptographer Vlastimil Klima offered to search for collisions a new method that allows you to find a different pair of random 128 byte blocks with one md5 sum on a personal computer in less than a minute. <br><br>  You may ask, but what will give us the possession of such a pair of messages, not only are they short (128 bytes in total), so also, in addition, and random ones, i.e.  the method does not allow for a given message to pick up another one with an identical hash.  However, this opens a huge scope for various kinds of attacks on executable files.  And the reason for this is the following feature of any hash function: The hash function is iterative in nature.  This means that when the hash is calculated, the message is divided into blocks, a compression function is applied to each block, depending on some variable called the initialization vector.  The result of this function will be the initialization vector for the next block.  The result of the function after working with the last block will be the final hash value of our message. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Schematically it can be represented as follows: <br>  s <sub>i + 1</sub> = f (s <sub>i</sub> , M <sub>i</sub> ), where s <sub>i is</sub> the initialization vector for the i-th block. <br>  The Vlastimil Klima method allows for any given value of s <sub>i</sub> to pick up two 128-byte blocks M, M` and N, N` such that f (f (s, M), M ') = f (f (s, N), N '). <br><br>  Thus, using this technique, you can construct two files with the same md5 sum, but having different 128 bytes in the middle. <br>  M <sub>0</sub> , M <sub>1</sub> , ..., M <sub>i-1</sub> , <b>M <sub>i</sub> , M <sub>i + 1</sub></b> , M <sub>i + 2</sub> , ..., M <sub>n</sub> , <br><br>  M <sub>0</sub> , M <sub>1</sub> , ..., M <sub>i-1</sub> , <b>N <sub>i</sub> , N <sub>i + 1</sub></b> , M <sub>i + 2</sub> , ..., M <sub>n</sub> . <br>  Please note that the hashes of both of these files match, because  distinct blocks M <sub>i</sub> , M <sub>i + 1</sub> and <br>  N <sub>i</sub> , N <sub>i + 1</sub> will return the same value as s <sub>i + 2</sub> , since  f (f (s, M <sub>i</sub> ), M <sub>i + 1</sub> ) = f (f (s, N <sub>i</sub> ), N <sub>i + 1</sub> ), and since all subsequent data are identical, the subsequent values ‚Äã‚Äãof the compression function for both files will be the same. <br><br><h4>  What does this give us </h4><br>  We now turn from things abstract and remote to a practical question.  Suppose we have an executable file M <sub>0</sub> , M <sub>1</sub> , X, X, ..., M <sub>n</sub> .  But based on it, we can create two different files M <sub>0</sub> , M <sub>1</sub> , <b>N <sub>1</sub> , N <sub>1</sub></b> , ..., M <sub>n</sub> and M <sub>0</sub> , M <sub>1</sub> , <b>N <sub>2</sub> , N <sub>1</sub></b> , ..., M <sub>n</sub> (simply change the blocks X to N <sub>1</sub> and N <sub>2</sub> ).  If blocks N <sub>1</sub> and N <sub>2</sub> are collisions, then the hash sum of these files will be the same. <br>  Now imagine that this executable file has the following structure: <br>  if (X == X) then {good_program} else {evil_program} <br>  That's actually the whole secret of this focus. <br><br><h4>  How to make yourself </h4><br>  Now let's talk a little about how to do it yourself. <br>  <b>Step one:</b> write a double bottom program. <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">#include &lt;stdafx.h&gt; <br> #include&lt;iostream&gt; <br> #include &lt; <font color="#0000ff">string</font> &gt; <br> <font color="#0000ff">using</font> <font color="#0000ff">namespace</font> std; <br> <font color="#008000">// str1  str2        X.</font> <br> <font color="#0000ff">static</font> <font color="#0000ff">char</font> *str1= <font color="#A31515">"qwertyuioplkjhgfdaszxcvbnmkjhgfdsaqwertyuikjh"\ <br> "gbvfdsazxdcvgbhnjikmjhbgfvcdsazxdcfrewqikolkjnhgfqwertyuioplkjh"\ <br> "gfdaszxcvbnmkjhgfdsaqwertyuikjhgbvfdsazxdcvgbhnjikmjhbgfvcdsa"\ <br> "zxdcfrewqikolkjnhgfq123"</font> ; <br> <font color="#0000ff">static</font> <font color="#0000ff">char</font> *str2= <font color="#A31515">"qaswderftgyhujikolpmnbvcxzasxdcfvgbhnjmkijuy"\ <br> "gtfdeswaqscfvgyjqaswderftgyhujikolpmnbvcxzasxdcfvgbhnjmkijuyg"\ <br> "tfdeswaqscfvgyjqaswderftgyhujikolpmnbvcxzasxdcfvgbhnjmkijuygt"\ <br> "fdeswaqscfvgyjqwertyuikja2"</font> ; <br> <br> <font color="#0000ff">int</font> good() <br> { <br> <font color="#0000ff">int</font> a; <br> std::cout&lt;&lt; <font color="#A31515">"Good, nice programme!"</font> ; <br> std::cin&gt;&gt;a; <br> <font color="#0000ff">return</font> 0; <br> } <br> <font color="#0000ff">int</font> bed() <br> { <br> <font color="#0000ff">int</font> a; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i=0; i&lt;1000; i++) <br> { <br> std::cout&lt;&lt; <font color="#A31515">"Evil, evil code!"</font> ; <br> } <br> std::cin&gt;&gt;a; <br> <font color="#0000ff">return</font> 0; <br> } <br> <font color="#0000ff">int</font> _tmain( <font color="#0000ff">int</font> argc, _TCHAR* argv[]) <br> { <br> <font color="#008000">// s  s2        </font> <br> <font color="#0000ff">string</font> s=str1; <br> <font color="#0000ff">string</font> s2=str2; <br> s.erase(0,56); <br> s.erase(128,8); <br> s2.erase(0,64); <br> <font color="#0000ff">if</font> (s==s2) { <br> <font color="#0000ff">return</font> good(); <br> } <font color="#0000ff">else</font> { <br> <font color="#0000ff">return</font> bed(); <br> } <br> <font color="#0000ff">return</font> 0; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Please pay particular attention to the variables str1 and str2.  They serve so that they can be quickly found in the hex editor and replaced with the necessary data. <br>  The main function, depending on the contents of the variables s, causes a good or bad version of the program. <br><br>  <b>Step Two:</b> After compiling the program, you will need to work a bit with the hex editor in order to find our str1 and str2 strings in the .exe file.  Copy the resulting .exe file.  Let the copy be called the "cropped version."  Open the copy in the hex editor and find the str1 and str2 lines in it.  Delete all data going after the first 64 bytes of the first of the lines.  The last lines of the resulting file will look like this: <img src="https://habrastorage.org/storage/b152a4d8/e79c46ae/5073fe8c/030774ca.jpg">  .  Save this file. <br><br>  <b>Step Three:</b> The file created in the second step will serve as a so-called prefix for searching for collisions.  To find a conflict with a given prefix, you need to download the fastcoll program <a href="">from here</a> (Thanks to its author Marc Stevens).  Sources are <a href="">here</a> . <br>  Run the program with the ‚Äìp parameter.  As a prefix, specify the ‚Äúcropped version‚Äù.  As a result, the program will create two files ‚Äútrimmed version_msg1‚Äù and ‚Äútrimmed version_msg2‚Äù. <br><br>  <b>Step Four:</b> Create another copy of your program.  Let the original be called good.exe, and a copy of evil.exe.  Open the msg1 and msg2 files in the hex editor.  First, replace the block in which str2 is stored with the data from the str1 block.  Let them now have the same information.  After that, copy the last 128 bytes from the msg1 file and paste them into your good file as shown in the figure. <br><img src="https://habrastorage.org/storage/69659248/878f7b55/a2b3922f/3774bd6f.jpg"><br>  Please note that indents should correspond to the following parameters: the first block is inserted right where the ‚Äúcropped version‚Äù file ends, the second block is located 96 bytes from the first.  Important: insert the same blocks.  This will be a good version of our program.  Save the good.exe file and open the evil.exe file.  Blocks in the evil.exe file will need to be inserted in the same places as in good.exe, the only difference is that we take the first block from the msg2 file and the second one from the msg1 file.  This difference will provide us with the failure to comply with the condition of the program if (s == s2) and, accordingly, will launch the evil version of the program. <br><br>  <b>Step Five:</b> Profit!  Compare md5 sums of files, enjoy the result. <br><br>  <b>Bibliography:</b> <br>  1. <a href="http://www.mscs.dal.ca/~selinger/md5collision/">A wonderful site with a description of this method.</a> <br>  2. <a href="http://cryptography.hyperlink.cz/MD5_collisions.html">Vlastimil Klima website</a> <br>  3. <a href="http://www.win.tue.nl/hashclash/">The site of the author of the program findcoll</a> </div><p>Source: <a href="https://habr.com/ru/post/113127/">https://habr.com/ru/post/113127/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113121/index.html">Introduction to MVP GWT 2.1</a></li>
<li><a href="../113122/index.html">Idea motivation</a></li>
<li><a href="../113123/index.html">Ubuntu 11.04 Natty Narwhal Alpha 2 released</a></li>
<li><a href="../113124/index.html">And we will go the other way. Moving the model to the database</a></li>
<li><a href="../113126/index.html">Chrome 9: Breakthrough in speed, support for 3D and web applications</a></li>
<li><a href="../113128/index.html">How not to write factorial in Java</a></li>
<li><a href="../113129/index.html">yourfilms.org - your movies</a></li>
<li><a href="../113131/index.html">February 18, St. Petersburg - Java Tech Day 2011</a></li>
<li><a href="../113133/index.html">Uncompromising replacement for a 60-watt light bulb</a></li>
<li><a href="../113134/index.html">Creative Commons licenses are adapted in the first country of the former USSR - Estonia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>