<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HotSpot using Cisco WLC5508, FreeRadius, MySQL and Easyhotspot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about how to create and configure HotSpot . At the same time, I wanted to describe in detail how it looks from the inside and focus on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HotSpot using Cisco WLC5508, FreeRadius, MySQL and Easyhotspot</h1><div class="post__text post__text-html js-mediator-article">  This article is about how to create and configure <a href="https://ru.wikipedia.org/wiki/%25D0%25A5%25D0%25BE%25D1%2582-%25D1%2581%25D0%25BF%25D0%25BE%25D1%2582_%2528Wi-Fi%2529">HotSpot</a> .  At the same time, I wanted to describe in detail how it looks from the inside and focus on the work of freeRadius, MySQL and simple billing Easyhotspot. <br><br>  So, our system will be built on Cisco WLC5508 and CentOS.  To understand how it all interacts with each other, let's look at the scheme. <br><br><img src="https://habrastorage.org/files/02c/b47/3fb/02cb473fb16b4f849de80e647a7588f1.jpg"><br><a name="habracut"></a><br>  It all starts with the service <a href="http://sourceforge.net/projects/easyhotspot/">Easyhotspot</a> , in fact it is billing, which is controlled through a web interface.  This is an open-source project and its main advantage is that it is easy to understand and manage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      With it, we generate username and password, which are recorded in the MySQL database and transferred to the user for use.  Next, the user connects to our access point, which is controlled by the Cisco WLC controller.  When you try to open any page in the browser, the user will be transferred to the authorization page, where he will enter the received credits. <br><br>  After that, the controller will intercept them and, in an access-request message, will send it to the authorization server FreeRadius for checking.  He will access the database, find the appropriate username and password, and answer the Wi-Fi controller that everything is OK, and will give you the time during which the user can be active.  In the <a href="https://ru.wikipedia.org/wiki/RADIUS">RADIUS</a> terminology, the Wi-Fi controller of the Cisco WLC is a client access point for the Network Access Server ( <a href="https://en.wikipedia.org/wiki/Network_access_server">NAS</a> ) radius server; in the hotspot terminology, this service is also called a <a href="https://ru.wikipedia.org/wiki/Captive_portal">captive portal</a> .  The task of this service is to show the user an authorization window, transfer creditors to a radius server, get a response with attributes and adequately process them. <br><br>  And although Easyhotspot was originally designed to work with the captive portal, which is called Chillispot, it doesn't really matter to us. <br>  After the user has been authorized, the NAS must, during the user session, send to the radius server reports on the resources used by the user: the amount of time, traffic, and so on.  The whole thing freeRadius will log into the database.  And the next time you try to connect, the user will be checked for how much he spent and how much of that is available to him. <br><br>  Recall what Radius is.  This is a protocol that is conditionally divided into two parts, this is authentication / authorization and accounting.  The first describes <a href="https://tools.ietf.org/html/rfc2865">RFC 2865</a> , the second <a href="https://tools.ietf.org/html/rfc2866">RFC 2866</a> .  The fact that they work separately says that the server accepts requests for them on different ports of 1812 and 1813. <br><br>  Next, we will analyze in detail how requests and responses look, and how they are processed by FreeRadius, and now we proceed to the installation.  Suppose we have a CentOS 6.5 server with a configured network and internet access.  Install the program for downloading files from the network: <br><br><pre><code class="bash hljs">yum install wget</code> </pre> <br>  Download and install the repository: <br><br><pre> <code class="bash hljs">wget http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm rpm -ivh epel-release-6-8.noarch.rpm</code> </pre><br>  Update the repository and installed programs: <br><br><pre> <code class="bash hljs">yum repolist yum update</code> </pre><br>  Install useful utilities, MySQL, Apache and php: <br><br><pre> <code class="bash hljs">yum install mc vim unzip gcc gcc-c++ make git svn nano yum install mysql-server php httpd php-mysql php-xml php-gd php-pear php-db yum install patch mod_ssl openssl dnsmasq</code> </pre><br>  In the /etc/php.ini file you need to uncomment the line: <br><br><pre> <code class="bash hljs">short_open_tag = On</code> </pre><br>  If you forget about this parameter, then when you try to open a billing page, the following message will appear: <br><br><pre> <code class="html hljs xml">EasyHotSpot config-&gt;item('EASYHOTSPOT_VERSION');?&gt; load-&gt;view($this-&gt;config-&gt;item('FAL_template_dir').'template/menu');?&gt; EasyHotspot - Hotspot Management System GNU Public License</code> </pre><br>  Also in the /etc/php.ini file: <br><br><pre> <code class="bash hljs">date.timezone = Europe/Moscow</code> </pre><br>  Let's make MySQL and Apache start automatically after booting the system: <br><br><pre> <code class="bash hljs">chkconfig --level 235 httpd on chkconfig --level 235 mysqld on chkconfig --level 235 dnsmasq on</code> </pre><br>  Install Easyhotspot.  Download the easyhotspot from here <a href="https://github.com/rafeequl">github.com/rafeequl</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/rafeequl/EasyHotspot ln -s /opt/EasyHotspot/htdocs /var/www/html/easyhotspot</code> </pre><br>  Create an easyhotspot_opensource database: <br><br><pre> <code class="bash hljs">mysql mysql&gt; create database easyhotspot_opensource; mysql&gt; CREATE USER <span class="hljs-string"><span class="hljs-string">'easyhotspot'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; mysql&gt; SET PASSWORD FOR <span class="hljs-string"><span class="hljs-string">'easyhotspot'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> = PASSWORD(<span class="hljs-string"><span class="hljs-string">'easyhotspot'</span></span>); mysql&gt; GRANT ALL ON easyhotspot_opensource.* to <span class="hljs-string"><span class="hljs-string">'easyhotspot'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; mysql&gt; quit mysql -u root easyhotspot_opensource &lt; /opt/EasyHotspot/install/database_with_sample.sql</code> </pre><br>  In EasyHotspot there is a Chillispot page in the menu.  When we click on it, we will see an error.  To avoid this, remove it.  To do this, delete or comment out the following lines in the /opt/EasyHotspot/htdocs/system/application/views/admin/header.php file: <br><br><pre> <code class="php hljs">&lt;!-- &lt;li <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chillispot</span></span></span><span class="hljs-class">"&gt;&lt;?=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anchor</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">admin</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chillispot</span></span></span><span class="hljs-class">','</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chillispot</span></span></span><span class="hljs-class">')?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; --&gt; &lt;!-- &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">radius</span></span></span><span class="hljs-class">"&gt;&lt;?=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anchor</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">admin</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">freeradius</span></span></span><span class="hljs-class">','</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FreeRadius</span></span></span><span class="hljs-class">')?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; --&gt;</span></span></code> </pre><br>  Install phpMyAdmin, this is a kind of GUI for MySQL, it will help us in studying the tables: <br><br><pre> <code class="bash hljs">wget https://files.phpmyadmin.net/phpMyAdmin/3.5.5/phpMyAdmin-3.5.5-all-languages.zip unzip phpMyAdmin-3.5.5-all-languages.zip cp phpMyAdmin-3.5.5-all-languages EasyHotspot/htdocs/phpmyadmin -rf</code> </pre><br>  Create a config.inc.php: <br><br><pre> <code class="bash hljs">vi EasyHotspot/htdocs/phpmyadmin/config.inc.php</code> </pre><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i++; $cfg[<span class="hljs-string"><span class="hljs-string">'ThemeDefault'</span></span>] = <span class="hljs-string"><span class="hljs-string">'original'</span></span>; $cfg[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][$i][<span class="hljs-string"><span class="hljs-string">'host'</span></span>] = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; $cfg[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][$i][<span class="hljs-string"><span class="hljs-string">'extension'</span></span>] = <span class="hljs-string"><span class="hljs-string">'mysqli'</span></span>; $cfg[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][$i][<span class="hljs-string"><span class="hljs-string">'connect_type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'tcp'</span></span>; $cfg[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][$i][<span class="hljs-string"><span class="hljs-string">'compress'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $cfg[<span class="hljs-string"><span class="hljs-string">'Servers'</span></span>][$i][<span class="hljs-string"><span class="hljs-string">'auth_type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'config'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// - phpmyadmin     .   ,      , 'config'   'http' $cfg['Servers'][$i]['user'] = 'easyhotspot'; $cfg['Servers'][$i]['password'] = 'easyhotspot'; /* End of servers configuration */ $cfg['UploadDir'] = ''; $cfg['SaveDir'] = ''; $cfg['BZipDump'] = false; $cfg['DefaultLang'] = 'ru'; $cfg['ThemeDefault'] = 'original'; $cfg['ServerDefault'] = 1; $cfg['CompressOnFly'] = false; $cfg['UserprefsDeveloperTab'] = true; $cfg['HideStructureActions'] = false; $cfg['LoginCookieDeleteAll'] = false; $cfg['QueryHistoryDB'] = true; $cfg['RetainQueryBox'] = true; $cfg['blowfish_secret'] = '51a360783193d3.45092927'; $cfg['LeftDefaultTabTable'] = 'tbl_select.php'; $cfg['MaxTableList'] = 500; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Restart Apache: <br><br><pre> <code class="bash hljs">service httpd restart</code> </pre><br><h4>  Install and configure FreeRadius </h4><br>  Install freerius, mysql support and utilities that will help us test the system: <br><br><pre> <code class="bash hljs">yum install freeradius freeradius-mysql freeradius-utils</code> </pre><br>  Let's make freeradiu start automatically after booting the system: <br><br><pre> <code class="bash hljs">chkconfig --level 235 radiusd on</code> </pre><br>  In the /etc/raddb/clients.conf file in the ‚Äúclient localhost‚Äú section, do the following: <br><br><pre> <code class="bash hljs">ipaddr = 127.0.0.1 secret = easyhotspot nastype = other</code> </pre><br>  In the /etc/raddb/radiusd.conf file in the ‚Äúmodule‚Äù section, uncomment: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$INCLUDE</span></span> sql.conf <span class="hljs-variable"><span class="hljs-variable">$INCLUDE</span></span> sql/mysql/counter.conf</code> </pre><br>  In the ‚Äúinstantiate‚Äú section add: <br><br><pre> <code class="bash hljs">noresetcounter</code> </pre><br>  In the / etc / raddb / sites-enabled / default file in the ‚Äúauthorize‚Äù section, uncomment ‚Äúsql‚Äù and add ‚Äúnoresetcounter‚Äù: <br><br><pre> <code class="bash hljs">sql noresetcounter</code> </pre><br>  Then / etc / raddb / sites-enabled / default in the ‚Äúaccounting‚Äù section uncomment the ‚Äúsql‚Äù: <br><br><pre> <code class="bash hljs">sql</code> </pre><br>  Then / etc / raddb / sites-enabled / default in the ‚Äúsession‚Äù section uncomment the ‚Äúsql‚Äù and comment out ‚Äúradutmp‚Äù: <br><br><pre> <code class="bash hljs">sql <span class="hljs-comment"><span class="hljs-comment">#radutmp</span></span></code> </pre><br>  And then / etc / raddb / sites-enabled / default in the ‚Äúpost-auth‚Äù section uncomment the ‚Äúsql‚Äù: <br><br><pre> <code class="bash hljs">sql</code> </pre><br>  In the /etc/raddb/sql/mysql/counter.conf file, at the end the ‚Äúnoresetcounter‚Äù counter is already defined, we will edit it: <br><br><pre> <code class="bash hljs">sqlcounter noresetcounter { counter-name = Session-Timeout check-name = Session-Timeout reply-name = Session-Timeout sqlmod-inst = sql key = User-Name reset = never query = <span class="hljs-string"><span class="hljs-string">"SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='%{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${key}</span></span></span><span class="hljs-string">}'"</span></span> }</code> </pre><br>  In the /etc/raddb/sql/mysql/dialup.conf file for working with Simultaneous-Use, we uncomment the following: <br><br><pre> <code class="bash hljs">simul_count_query = <span class="hljs-string"><span class="hljs-string">"SELECT COUNT(*) \ FROM </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${acct_table1}</span></span></span><span class="hljs-string"> \ WHERE username = '%{SQL-User-Name}' \ AND acctstoptime IS NULL"</span></span></code> </pre><br>  In the /etc/raddb/sql.conf file in the ‚Äúsql‚Äù section we do this: <br><br><pre> <code class="bash hljs"> database = <span class="hljs-string"><span class="hljs-string">"mysql"</span></span> driver = <span class="hljs-string"><span class="hljs-string">"rlm_sql_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${database}</span></span></span><span class="hljs-string">"</span></span> server = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> <span class="hljs-comment"><span class="hljs-comment">#port = 3306 login = "easyhotspot" password = "easyhotspot" radius_db = "easyhotspot_opensource"</span></span></code> </pre><br>  Restart freeRadius: <br><br><pre> <code class="bash hljs">service radiusd start</code> </pre><br><h4>  Configuring Cisco WLC </h4><br>  We connect the Radius server to the WLC: SECURITY-&gt; Authentication.  SECURITY-&gt; Accounting.  When setting up, you need to enter IP and Shared Secret. <br><br><img src="https://habrastorage.org/files/a74/d6e/ae6/a74d6eae6c1945a694116cf1df086153.jpg"><br><br>  We configure the redirect with the help of which an unauthorized user will be redirected to the authorization page when requesting any page, where you need to enter your login and password. <br><br><img src="https://habrastorage.org/files/6e4/e34/be1/6e4e34be190f486abb48dce7264fe6ad.jpg"><br><br>  Configure access-list.  The fact is that when a user connects to the SSID, all his requests from the web browser will be redirected to the login page, but other than that, in fact, it does not limit anything. <br><br>  We need to create an ACL that allows the user access only to our login page and nowhere else. <br><br><img src="https://habrastorage.org/files/f0a/7bc/55f/f0a7bc55fa064c2caca62d3f8a2eaabf.jpg"><br><br>  Create an SSID, on the Security-&gt; Layer 2 tab, select None.  On the Security-&gt; Layer 3 tab, select Web Policy - Authentication, in the Preauthentication ACL drop-down list, select our previously created ACL. <br><br><img src="https://habrastorage.org/files/f76/d58/5a9/f76d585a9f4b40c48f48ee8e7e185b20.jpg"><br><br>  Select a previously added radius server from the dropdown list. <br><br><img src="https://habrastorage.org/files/25f/20e/2e2/25f20e2e245149988a97ae98bd76ef25.jpg"><br><br>  It remains to tune the radius.  Add our WLC IP and secret <br>  vi /etc/raddb/clients.conf <br><br><pre> <code class="bash hljs">client 192.168.0.5 { <span class="hljs-comment"><span class="hljs-comment"># # secret and password are mapped through the "secrets" file. secret = ololo,karl! # shortname = liv1 # # the following three fields are optional, but may be used by # # checkrad.pl for simultaneous usage checks nastype = cisco # login = !root # password = someadminpas }</span></span></code> </pre><br>  Restart freeRadius: <br><br><pre> <code class="bash hljs">service radiusd restart</code> </pre><br>  Now the authorization page is available at the address <a href="http://xn--u1a.xn--u1a.xn--u1a.xn--u1a/easyhotspot">x.xxx / easyhotspot</a> : <br><br><img src="https://habrastorage.org/files/480/f75/45f/480f7545f1964419bb5c7827864696e7.jpg"><br><br>  Login: admin <br>  Password: admin123 <br><br>  On the web interface, we have two main menus [Cashier Menu] and [Admin Menu]. <br><br><img src="https://habrastorage.org/files/9b1/81e/07f/9b181e07f0334222b880c375c247dd01.jpg"><br><br>  In the Admin Menu we can create a Billing plan and Account plan to generate usernames / passwords based on them.  Let's create a billing plan for an hour, while the voucher generated on its basis will be valid until the end of the next day from the moment of creation (Valid for = 1), and Idle Timeout will be done 5 minutes. <br><br><img src="https://habrastorage.org/files/9cf/c08/6ba/9cfc086ba576414a9263901d8c9ba21c.jpg"><br><br>  Go to [Cashier Menu] -&gt; Voucher Management and generate one voucher. <br><br><img src="https://habrastorage.org/files/381/fc8/06f/381fc806ff894973a96557e5a3037d8c.jpg"><br><br>  Let's test our system.  Using the radtest utility, we will send a request for authorization to the radius server in the same way as the NAS does.  Use the generated login / password, 'easyhotspot' is the secret in the /etc/raddb/clients.conf file: <br><br><pre> <code class="bash hljs">radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot</code> </pre><br>  Here you may have an error: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radtest zupvez10 palkipud 127.0.0.1 100 esyhotspot radclient:: Failed to find IP address for FreeRadius radclient: Nothing to send. [root@FreeRadius ~]#</span></span></code> </pre><br>  It is connected with the fact that when sending a radius package, the utility tries to resolve the server name in order to add it to the NAS-IP-Address.  If the name is not localhost, add it to / etc / hosts.  So: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot Sending Access-Request of id 189 to 127.0.0.1 port 1812 User-Name = "zupvez10" User-Password = "palkipud" NAS-IP-Address = 127.0.0.1 NAS-Port = 100 Message-Authenticator = 0x00000000000000000000000000000000 rad_recv: Access-Accept packet from host 127.0.0.1 port 1812, id=189, length=63 WISPr-Session-Terminate-Time = "2016-1-6T24:00:00" Session-Timeout = 3600 Idle-Timeout = 300 Acct-Interim-Interval = 120 [root@FreeRadius ~]#</span></span></code> </pre><br>  We see that our authorization was successful, and we received a set of attributes in response: <br><br><ul><li>  WISPr-Session-Terminate-Time = "2016-1-6T24: 00: 00" - at midnight of the next day the session will become invalid </li><li>  Session-Timeout = 3600 - means that the NAS will have to disconnect the user in an hour </li><li>  Idle-Timeout = 300 - if within 5 minutes the user is not active, the NAS should drop the session </li><li>  Acct-Interim-Interval = 120 every two minutes the NAS should send an account package (interim-update) with a report on the current affairs of the user </li></ul><br>  Great, but we did only half the work of the NAS, after authentication and authorization should be accounting.  To do this, create three files with attributes.  In the field User-Name = "" do not forget to specify your username. <br><br>  vi start.txt: <br><br><pre> <code class="bash hljs">Packet-Type=4 Packet-Dst-Port=1813 Acct-Session-Id = <span class="hljs-string"><span class="hljs-string">"4D2BB8AC-00000098"</span></span> Acct-Status-Type = Start Acct-Authentic = RADIUS User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> NAS-Port = 0 Called-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-02-6F-AA-AA-AA:My Wireless"</span></span> Calling-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-1C-B3-AA-AA-AA"</span></span> NAS-Port-Type = Wireless-802.11 Connect-Info = <span class="hljs-string"><span class="hljs-string">"CONNECT 48Mbps 802.11b"</span></span></code> </pre><br>  In the field User-Name = "" do not forget to specify your username. <br><br>  vi interim-update.txt: <br><br><pre> <code class="bash hljs">Packet-Type=4 Packet-Dst-Port=1813 Acct-Session-Id = <span class="hljs-string"><span class="hljs-string">"4D2BB8AC-00000098"</span></span> Acct-Status-Type = Interim-Update Acct-Authentic = RADIUS User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> NAS-Port = 0 Called-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-02-6F-AA-AA-AA:My Wireless"</span></span> Calling-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-1C-B3-AA-AA-AA"</span></span> NAS-Port-Type = Wireless-802.11 Connect-Info = <span class="hljs-string"><span class="hljs-string">"CONNECT 48Mbps 802.11b"</span></span> Acct-Session-Time = 11 Acct-Input-Packets = 15 Acct-Output-Packets = 3 Acct-Input-Octets = 1407 Acct-Output-Octets = 467</code> </pre><br>  In the field User-Name = "" do not forget to specify your username. <br><br>  vi stop.txt: <br><br><pre> <code class="bash hljs">Packet-Type=4 Packet-Dst-Port=1813 Acct-Session-Id = <span class="hljs-string"><span class="hljs-string">"4D2BB8AC-00000098"</span></span> Acct-Status-Type = Stop Acct-Authentic = RADIUS User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> NAS-Port = 0 Called-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-02-6F-AA-AA-AA:My Wireless"</span></span> Calling-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-1C-B3-AA-AA-AA"</span></span> NAS-Port-Type = Wireless-802.11 Connect-Info = <span class="hljs-string"><span class="hljs-string">"CONNECT 48Mbps 802.11b"</span></span> Acct-Session-Time = 30 Acct-Input-Packets = 25 Acct-Output-Packets = 7 Acct-Input-Octets = 3407 Acct-Output-Octets = 867 Acct-Terminate-Cause = User-Request</code> </pre><br>  Using the radclient utility, we will send a Start account package to the radius server. <br><br>  radclient 127.0.0.1 auto easyhotspot -f start.txt: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radclient 127.0.0.1 auto easyhotspot -f start.txt Received response ID 50, code 5, length = 20</span></span></code> </pre><br>  An answer was received, code 5 means that everything is in order.  Go to [Cashier Menu] -&gt; Online Users. <br><br><img src="https://habrastorage.org/files/ec7/8c8/666/ec78c866625946d38d17ab03302ba587.jpg"><br><br>  We see our user and the start time of the session.  Now let's send the interim-update account package.  This time, new attributes are added to the package: <br><br><ul><li>  Acct-Session-Time = 11 </li><li>  Acct-Input-Packets = 15 </li><li>  Acct-Output-Packets = 3 </li><li>  Acct-Input-Octets = 1407 </li><li>  Acct-Output-Octets = 467 </li></ul><br>  radclient 127.0.0.1 auto easyhotspot -f interim-update.txt: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radclient 127.0.0.1 auto easyhotspot -f interim-update.txt Received response ID 226, code 5, length = 20</span></span></code> </pre><br>  Let's see Online Users. <br><br><img src="https://habrastorage.org/files/0f9/937/e6c/0f9937e6cfa5470f9b5b2870ed1c054d.jpg"><br><br>  Now we see that the user spent 11 hours and 1874 bytes from the hour that was given to him.  Send an account stop package. <br><br>  radclient 127.0.0.1 auto easyhotspot -f stop.txt: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radclient 127.0.0.1 auto easyhotspot -f stop.txt Received response ID 166, code 5, length = 20</span></span></code> </pre><br>  Session is complete.  Go to the [Cashier Menu] -&gt; Voucher Management. <br><br><img src="https://habrastorage.org/files/a75/e58/8d7/a75e588d72e142ca9db529e46ece1d6b.jpg"><br><br>  We see that our user has 59 minutes left.  Time is rounded, but it is only in billing, freeRadius counts up to a second.  Check: <br><br>  radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot Sending Access-Request of id 93 to 127.0.0.1 port 1812 User-Name = "zupvez10" User-Password = "palkipud" NAS-IP-Address = 127.0.0.1 NAS-Port = 100 Message-Authenticator = 0x00000000000000000000000000000000 rad_recv: Access-Accept packet from host 127.0.0.1 port 1812, id=93, length=63 WISPr-Session-Terminate-Time = "2016-1-6T24:00:00" Session-Timeout = 3570 Idle-Timeout = 300 Acct-Interim-Interval = 120</span></span></code> </pre><br>  As you can guess from the received answer, freeRadius took away from the originally set value 3600 the user spent 30 and returned us 3570. Let's send the package for the beginning of the accounting session now. <br><br>  radclient 127.0.0.1 auto easyhotspot -f start.txt: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radclient 127.0.0.1 auto easyhotspot -f start.txt Received response ID 15, code 5, length = 20</span></span></code> </pre><br>  And we will try to log in again, presenting that the user, having received access, has given his creditors to a friend. <br><br>  radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot: <br><br><pre> <code class="bash hljs">Sending Access-Request of id 99 to 127.0.0.1 port 1812 User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> User-Password = <span class="hljs-string"><span class="hljs-string">"palkipud"</span></span> NAS-IP-Address = 127.0.0.1 NAS-Port = 100 Message-Authenticator = 0x00000000000000000000000000000000 rad_recv: Access-Reject packet from host 127.0.0.1 port 1812, id=99, length=68 Reply-Message = <span class="hljs-string"><span class="hljs-string">"\r\nYou are already logged in - access denied\r\n\n"</span></span></code> </pre><br>  Bolt!  Until the session is completed, no one can log in again.  Finish the session. <br><br>  radclient 127.0.0.1 auto easyhotspot -f stop.txt: <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># radclient 127.0.0.1 auto easyhotspot -f stop.txt Received response ID 143, code 5, length = 20</span></span></code> </pre><br>  Let's see what happens inside freeRadius when the request is processed.  Stop freeRadius: <br><br><pre> <code class="bash hljs">service radiusd stop</code> </pre><br>  Run freeRadius in debug mode and write the output to the log.txt file in the background. <br><br>  radiusd -X&gt; log.txt &amp; <br><br>  Send an authorization request. <br><br>  radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot <br><br>  Request start and end of session: <br><br>  radclient 127.0.0.1 auto easyhotspot -f start.txt <br>  radclient 127.0.0.1 auto easyhotspot -f interim-update.txt <br>  radclient 127.0.0.1 auto easyhotspot -f stop.txt <br><br>  Stop debug mode. <br><br>  kill - you must have your own value, issued after the command radiusd -X&gt; log.txt &amp; <br><br><pre> <code class="bash hljs">[root@FreeRadius ~]<span class="hljs-comment"><span class="hljs-comment"># service radiusd stop Stopping radiusd: [ OK ] [root@FreeRadius ~]# radiusd -X &gt; log.txt &amp; [1] 4215 [root@FreeRadius ~]# radtest zupvez10 palkipud 127.0.0.1 100 easyhotspot Sending Access-Request of id 200 to 127.0.0.1 port 1812 User-Name = "zupvez10" User-Password = "palkipud" NAS-IP-Address = 127.0.0.1 NAS-Port = 100 Message-Authenticator = 0x00000000000000000000000000000000 rad_recv: Access-Accept packet from host 127.0.0.1 port 1812, id=200, length=63 WISPr-Session-Terminate-Time = "2016-1-6T24:00:00" Session-Timeout = 3540 Idle-Timeout = 300 Acct-Interim-Interval = 120 [root@FreeRadius ~]# radclient 127.0.0.1 auto easyhotspot -f start.txt Received response ID 68, code 5, length = 20 [root@FreeRadius ~]# radclient 127.0.0.1 auto easyhotspot -f interim-update.txt Received response ID 142, code 5, length = 20 [root@FreeRadius ~]# radclient 127.0.0.1 auto easyhotspot -f stop.txt Received response ID 37, code 5, length = 20 [root@FreeRadius ~]# kill 4215 [root@FreeRadius ~]# kill 4215 bash: kill: (4215) - No such process [1]+ Done radiusd -X &gt; log.txt</span></span></code> </pre><br>  Let's look at the log: <br><br><pre> <code class="bash hljs">less log.txt</code> </pre><br><div class="spoiler">  <b class="spoiler_title">debug_Authentication and authorization</b> <div class="spoiler_text"><pre> <code class="bash hljs">rad_recv: Access-Request packet from host 127.0.0.1 port 50024, id=200, length=78 User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> User-Password = <span class="hljs-string"><span class="hljs-string">"palkipud"</span></span> NAS-IP-Address = 127.0.0.1 NAS-Port = 100 Message-Authenticator = 0x9159a59b8e5c58fe44a95a199f84f9cf <span class="hljs-comment"><span class="hljs-comment"># Executing section authorize from file /etc/raddb/sites-enabled/default +group authorize { ++[preprocess] = ok ++[chap] = noop ++[mschap] = noop ++[digest] = noop [suffix] No '@' in User-Name = "zupvez10", looking up realm NULL [suffix] No such realm "NULL" ++[suffix] = noop [eap] No EAP-Message, not doing EAP ++[eap] = noop ++[files] = noop [sql] expand: %{User-Name} -&gt; zupvez10 [sql] sql_set_user escaped user --&gt; 'zupvez10' rlm_sql (sql): Reserving sql socket id: 31 [sql] expand: SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id -&gt; SELECT id, username, attribute, value, op FROM radcheck WHERE username = 'zupvez10' ORDER BY id [sql] User found in radcheck table [sql] expand: SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id -&gt; SELECT id, username, attribute, value, op FROM radreply WHERE username = 'zupvez10' ORDER BY id [sql] expand: SELECT groupname FROM radusergroup WHERE username = '%{SQL-User-Name}' ORDER BY priority -&gt; SELECT groupname FROM radusergroup WHER E username = 'zupvez10' ORDER BY priority [sql] expand: SELECT id, groupname, attribute, Value, op FROM radgroupcheck WHERE groupname = '%{Sql-Group}' ORDER BY id -&gt; SELECT id, groupname, attribute , Value, op FROM radgroupcheck WHERE groupname = '1hour' ORDER BY id [sql] User found in group 1hour [sql] expand: SELECT id, groupname, attribute, value, op FROM radgroupreply WHERE groupname = '%{Sql-Group}' ORDER BY id -&gt; SELECT id, groupname, attribute , value, op FROM radgroupreply WHERE groupname = '1hour' ORDER BY id rlm_sql (sql): Released sql socket id: 31 ++[sql] = ok rlm_sqlcounter: Entering module authorize code sqlcounter_expand: 'SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='%{User-Name}'' [noresetcounter] expand: SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='%{User-Name}' -&gt; SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='zupvez10' WARNING: Please replace '%S' with '${sqlmod-inst}' sqlcounter_expand: '%{sql:SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='zupvez10'}' [noresetcounter] sql_xlat [noresetcounter] expand: %{User-Name} -&gt; zupvez10 [noresetcounter] sql_set_user escaped user --&gt; 'zupvez10' [noresetcounter] expand: SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='zupvez10' -&gt; SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='zupvez10' rlm_sql (sql): Reserving sql socket id: 30 [noresetcounter] sql_xlat finished rlm_sql (sql): Released sql socket id: 30 [noresetcounter] expand: %{sql:SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='zupvez10'} -&gt; 60 rlm_sqlcounter: Check item is greater than query result rlm_sqlcounter: Authorized user zupvez10, check_item=3600, counter=60 rlm_sqlcounter: Sent Reply-Item for user zupvez10, Type=Session-Timeout, value=3540 ++[noresetcounter] = ok [expiration] Checking Expiration time: 'January 6 2016 24:00:00' ++[expiration] = ok ++[logintime] = noop ++[pap] = updated +} # group authorize = updated Found Auth-Type = PAP # Executing group from file /etc/raddb/sites-enabled/default +group PAP { [pap] login attempt with password "palkipud" [pap] Using clear text password "palkipud" [pap] User authenticated successfully ++[pap] = ok +} # group PAP = ok # Executing section session from file /etc/raddb/sites-enabled/default +group session { [sql] expand: %{User-Name} -&gt; zupvez10 [sql] sql_set_user escaped user --&gt; 'zupvez10' [sql] expand: SELECT COUNT(*) FROM radacct WHERE username = '%{SQL-User-Name}' AND acctstoptime IS NULL -&gt; SELECT COUNT(*) FROM radacct WHERE username = 'zupvez10' AND acctstoptime IS NULL rlm_sql (sql): Reserving sql socket id: 29 rlm_sql (sql): Released sql socket id: 29 ++[sql] = ok +} # group session = ok # Executing section post-auth from file /etc/raddb/sites-enabled/default +group post-auth { [sql] expand: %{User-Name} -&gt; zupvez10 [sql] sql_set_user escaped user --&gt; 'zupvez10' [sql] expand: %{User-Password} -&gt; palkipud [sql] expand: INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ( '%{User-Name}', '%{%{User-Password}:-%{Chap-Password}}', '%{reply:Packet-Type}', '%S') -&gt; INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ( 'zupvez10', 'palkipud', 'Access-Accept', '2016-01-05 21:20:45') rlm_sql (sql) in sql_postauth: query is INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ( 'zupvez10', 'palkipud', 'Access-Accept', '2016-01-05 21:20:45') rlm_sql (sql): Reserving sql socket id: 28 rlm_sql (sql): Released sql socket id: 28 ++[sql] = ok ++[exec] = noop +} # group post-auth = ok Sending Access-Accept of id 200 to 127.0.0.1 port 50024 WISPr-Session-Terminate-Time := "2016-1-6T24:00:00" Session-Timeout := 3540 Idle-Timeout := 300 Acct-Interim-Interval := 120 Finished request 0. Going to the next request</span></span></code> </pre><br></div></div><br>  FreeRadius got our package and first of all launched the <b>authorize</b> section described in the / etc / raddb / sites-enabled / default file <br>  In brackets shows the modules that process our request in turn. <br><br><ul><li>  [preprocess] - configurable in raddb / huntgroups and raddb / hints, we do not use it </li><li>  [chap] [mschap] [eap] [pap] - authentication protocols, by default freeRadius does not know which one we will use and in the authorize section checks everything </li><li>  [digest] - used for Cisco SIP server, we don‚Äôt need this module </li><li>  [suffix] - this module parses the User-Name attribute in the realm search, thus proxying can be configured </li><li>  [files] - parses the file / raddb / users in search of users, we use the database, so we don‚Äôt care </li><li>  [sql] - checks the database in search of the user and its attributes, the queries themselves are described in the /etc/raddb/sql/mysql/dialup.conf file </li></ul><br>  From the issuance of debug it is clear that five queries were made to the database to five different tables, we consider them later, but for now we understand that the user was found and everything is OK: <br><br><ul><li>  [noresetcounter] - the same module that calculates how much time the user has left is described in the /etc/raddb/sql/mysql/counter.conf file </li><li>  [expiration] - checks the expiration attribute, if the time during which the creditors are valid has expired, then no matter how much time the user has spent, the access will be denied </li><li>  [logintime] - you can set the time when creditors will work, for example, at lunch on Thursdays </li><li>  [pap] - Found Auth-Type = PAP authentication protocol defined </li></ul><br>  Go to the authentication section and here [pap] determines that User authenticated successfully.  Next, the section <b>section is</b> started, in it [sql] it is determined whether the session is currently active, if so, then someone has already logged in and access will be denied.  The request itself is described in the /etc/raddb/sql/mysql/dialup.conf file.  The <b>post-auth</b> section logs successful authentication to the database, to the radpostauth table.  After that the answer goes. <br><br>  So, we see that when processing the authorization and authentication package, freeRadius works with six tables: <br><br><ul><li>  radcheck </li><li>  radreply </li><li>  radusergroup </li><li>  radgroupcheck </li><li>  radgroupreply </li><li>  radpostauth </li></ul><br>  Authentication and authorization passed, let's deal with accounting now: <br><br><div class="spoiler">  <b class="spoiler_title">debug_Accounting</b> <div class="spoiler_text"><pre> <code class="bash hljs">rad_recv: Accounting-Request packet from host 127.0.0.1 port 58851, id=142, length=177 Acct-Session-Id = <span class="hljs-string"><span class="hljs-string">"4D2BB8AC-00000098"</span></span> Acct-Status-Type = Interim-Update Acct-Authentic = RADIUS User-Name = <span class="hljs-string"><span class="hljs-string">"zupvez10"</span></span> NAS-Port = 0 Called-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-02-6F-AA-AA-AA:My Wireless"</span></span> Calling-Station-Id = <span class="hljs-string"><span class="hljs-string">"00-1C-B3-AA-AA-AA"</span></span> NAS-Port-Type = Wireless-802.11 Connect-Info = <span class="hljs-string"><span class="hljs-string">"CONNECT 48Mbps 802.11b"</span></span> Acct-Session-Time = 11 Acct-Input-Packets = 15 Acct-Output-Packets = 3 Acct-Input-Octets = 1407 Acct-Output-Octets = 467 <span class="hljs-comment"><span class="hljs-comment"># Executing section preacct from file /etc/raddb/sites-enabled/default +group preacct { ++[preprocess] = ok [acct_unique] WARNING: Attribute NAS-Identifier was not found in request, unique ID MAY be inconsistent [acct_unique] Hashing 'NAS-Port = 0,,NAS-IP-Address = 127.0.0.1,Acct-Session-Id = "4D2BB8AC-00000098",User-Name = "zupvez10"' [acct_unique] Acct-Unique-Session-ID = "55c4c93f54bb88a7". ++[acct_unique] = ok [suffix] No '@' in User-Name = "zupvez10", looking up realm NULL [suffix] No such realm "NULL" ++[suffix] = noop ++[files] = noop +} # group preacct = ok # Executing section accounting from file /etc/raddb/sites-enabled/default +group accounting { [detail] expand: %{Packet-Src-IP-Address} -&gt; 127.0.0.1 [detail] expand: /var/log/radius/radacct/%{%{Packet-Src-IP-Address}:-%{Packet-Src-IPv6-Address}}/detail-%Y%m%d -&gt; /var/log/radius/radacct/127.0.0.1/detail-20160105 [detail] /var/log/radius/radacct/%{%{Packet-Src-IP-Address}:-%{Packet-Src-IPv6-Address}}/detail-%Y%m%d expands to /var/log/radius/radacct/127.0.0.1/detail-20160105 [detail] expand: %t -&gt; Tue Jan 5 21:21:18 2016 ++[detail] = ok [sql] expand: %{User-Name} -&gt; zupvez10 [sql] sql_set_user escaped user --&gt; 'zupvez10' [sql] expand: %{Acct-Session-Time} -&gt; 11 [sql] expand: %{Acct-Input-Gigawords} -&gt; [sql] ... expanding second conditional [sql] expand: %{Acct-Input-Octets} -&gt; 1407 [sql] expand: %{Acct-Output-Gigawords} -&gt; [sql] ... expanding second conditional [sql] expand: %{Acct-Output-Octets} -&gt; 467 [sql] expand: UPDATE radacct SET framedipaddress = '%{Framed-IP-Address}', acctsessiontime = '%{%{Acct-Session-Time}:-0}', acctinpu toctets = '%{%{Acct-Input-Gigawords}:-0}' &lt;&lt; 32 | '%{%{Acct-Input-Octets}:-0}', acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' &lt;&lt; 32 | '%{%{Acct-Output-Octets}:-0}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}' -&gt; UPDATE radacct SET framedipaddress = '', acctsessiontime = '11', acctinputoctets = '0' &lt;&lt; 32 | '1407', acctoutputoctets = '0' &lt;&lt; 32 | '467' WHERE acctsessionid = '4D2BB8AC-00000098' AND username = 'zupvez10' AND nas rlm_sql (sql): Reserving sql socket id: 26 rlm_sql (sql): Released sql socket id: 26 ++[sql] = ok ++[exec] = noop [attr_filter.accounting_response] expand: %{User-Name} -&gt; zupvez10 attr_filter: Matched entry DEFAULT at line 12 ++[attr_filter.accounting_response] = updated +} # group accounting = updated Sending Accounting-Response of id 142 to 127.0.0.1 port 58851 Finished request 2. Cleaning up request 2 ID 142 with timestamp +40 Going to the next request</span></span></code> </pre><br></div></div><br>  Consider the process of processing package Interim-Update.  The <b>preacct</b> section is <b>started</b> , described in the / etc / raddb / sites-enabled / default file: <br><br><ul><li>  [acct_unique] - takes some attributes from the package and calculates the hash, then writes it to the database in the radacct table, as acctuniqueid </li><li>  [suffix] - this module parses the User-Name attribute in the search for realm, so proxying can be configured </li><li>  [files] - allows, depending on the received attributes, to process the package in different ways, it is configured in the / etc / raddb / acct_users file </li></ul><br>  The <b>accounting</b> section <b>starts</b> : <br><br><ul><li>  [detail] - logs the package in a text file, configured in / etc / raddb / modules / detail. We can view these logs /var/log/radius/radacct/127.0.0.1/ </li><li>  [sql] - logs our query to the database in the radacct table, while we see that the UPDATE query is being used, that is, the new record is not created, but the existing one created during the processing of the start package is updated.  ,                       ,  [noresetcounter]  section.     ,    /etc/raddb/sql/mysql/dialup.conf   accounting_update_query,   ,    accounting_update_query_alt,      accounting_update_query   . </li><li> [exec] ‚Äî     /etc/raddb/modules/exec            </li><li> [attr_filter.accounting_response] ‚Äî    ,    /etc/raddb/modules/attr_filter </li></ul><br>  . ,  ,      freeRadius     : <br><br><ul><li> radacct </li></ul><br><h4>      MySQL </h4><br>   <a href="http://xn--u1a.xn--u1a.xn--u1a.xn--u1a/easyhotspot/phpmyadmin">.../easyhotspot/phpmyadmin</a>        GUI.    easyhotspot_opensource.          freeRadius: <br><br><img src="https://habrastorage.org/files/479/ed3/2a9/479ed32a95454ec5a2c385420f7e0db1.jpg"><br><br>    ,   radcheck. <br><br><img src="https://habrastorage.org/files/77e/0b9/677/77e0b96778f64f218e6c3cb5dba5c20b.jpg"><br><br>        .      Cleartext-Password    ,       Expiration        . <br><br>            [pap]   <b>authenticate</b> ,   Expiration   [expiration]   <b>authorize</b> . <br><br> ,           easyhotspot.  radcheck    ,    ,    radreply   ,     . <br><br><img src="https://habrastorage.org/files/cc0/8e4/789/cc08e47890e9426d91750eee58c6c9dc.jpg"><br><br>      WISPr-Session-Terminate-Time := ¬´2016-1-6T24:00:00¬ª.  ,     .     -    ,       radreply   . <br>     radusergroup  username ,  groupname      . <br><br><img src="https://habrastorage.org/files/053/45a/a4f/05345aa4fbea4b278fbf1201588f6c07.jpg"><br><br>     radgroupreply  groupname         ,      ,    . <br><br><img src="https://habrastorage.org/files/483/a01/fdf/483a01fdf9f248cf9fb216c7148d5e7b.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here we see the remaining three attributes that came to us in response from freeRadius. What if we want to have attributes in the group not only for sending, but also for checking? This is where the radgroupcheck table comes to the rescue. </font></font><br><br><img src="https://habrastorage.org/files/112/05c/d41/11205cd4162f431eacc8c48c02201a29.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In it, we see the Session-Timeout, which is checked by the [noresetcounter] module in the authorize and Simultaneous-Use sections, which is processed by the [sql] module in the session section. value = 1 just the same and tells the radius that there can be only one active session at a time, all subsequent attempts to log in will receive a rejection.</font></font><br><br>         easyhotspot.    -    'Generate Voucher', easyhotspot         .   radpostauth    [sql]   post-auth     . <br><br><img src="https://habrastorage.org/files/be5/0b4/525/be50b452503f429aae7cc1c63c5f9b79.jpg"><br><br>      .     radacct,   freeRadius'    .                 ,      .         freeRadius         NAS. <br><br> ,  ,     NAS-freeRadius-MySQL-Easyhotspot    .             ¬´Online Users¬ª. <br><br><img src="https://habrastorage.org/files/58a/f62/f07/58af62f07e954c5d9a00884913b84ceb.jpg"><br><br>   -,      ?    ,       ,  /        .    SSID,  ,     ,          User-Name   username    . <br><br>    ?            User-Name   -. ,   ,     SSID    ,    ,    radacct. ,  ,   .        freeRadius',   <a href="http://freeradius.org/radiusd/man/unlang.html">unlang</a>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2580%25D0%25BD%25D1%258B%25D0%25B5_%25D0%25B2%25D1%258B%25D1%2580%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F"> </a> . <br><br>   /etc/raddb/sites-enabled/default   preacct       : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Pre-accounting. Decide which accounting type to use. # preacct { if (User-Name=~ /^[A-Fa-f0-9]{12}$/) { reject }</span></span></code> </pre><br>     ,  User-Name : <br><br><ul><li> "~" ‚Äî ,        ,     "//" </li><li> "^" ‚Äî     </li><li> "[A-Fa-f0-9]" ‚Äî           .     ,   hex, .. - </li><li> "{12}" ‚Äî      ,      , -   . </li><li> "$" ‚Äî   </li></ul><br>       ¬´reject¬ª,     .    : <br><br><pre> <code class="bash hljs">rad_recv: Accounting-Request packet from host 192.168.80.100 port 32770, id=138, length=246 User-Name = <span class="hljs-string"><span class="hljs-string">"6c709f251ec4"</span></span> NAS-Port = 13 NAS-IP-Address = 192.168.0.5 Framed-IP-Address = 192.168.13.80 NAS-Identifier = <span class="hljs-string"><span class="hljs-string">"5508"</span></span> Airespace-Wlan-Id = 2 Acct-Session-Id = <span class="hljs-string"><span class="hljs-string">"567be2a8/6c:70:9f:25:1e:c4/217989"</span></span> Acct-Authentic = Remote Tunnel-Type:0 = VLAN Tunnel-Medium-Type:0 = IEEE-802 Tunnel-Private-Group-Id:0 = <span class="hljs-string"><span class="hljs-string">"13"</span></span> Acct-Status-Type = Interim-Update Acct-Input-Octets = 3566315 Acct-Output-Octets = 99562740 Acct-Input-Packets = 41757 Acct-Output-Packets = 66012 Acct-Session-Time = 8345 Acct-Delay-Time = 0 Calling-Station-Id = <span class="hljs-string"><span class="hljs-string">"6c-70-9f-25-2-b2"</span></span> Called-Station-Id = <span class="hljs-string"><span class="hljs-string">"28-94-0f-ae-be-13"</span></span> Cisco-AVPair = <span class="hljs-string"><span class="hljs-string">"nas-update=true"</span></span> <span class="hljs-comment"><span class="hljs-comment"># Executing section preacct from file /etc/raddb/sites-enabled/default +- entering group preacct {...} ++? if (User-Name=~ /^[A-Fa-f0-9]{12}$/) ? Evaluating (User-Name=~ /^[A-Fa-f0-9]{12}$/) -&gt; TRUE ++? if (User-Name=~ /^[A-Fa-f0-9]{12}$/) -&gt; TRUE ++- entering if (User-Name=~ /^[A-Fa-f0-9]{12}$/) {...} +++[reject] returns reject ++- if (User-Name=~ /^[A-Fa-f0-9]{12}$/) returns reject Finished request 7.</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It works, while remembering that when creating creditors, we ourselves should not fall under these conditions, otherwise the user is authorized, but we will not see an account from him. Let's see how our Online Users table now looks. </font></font><br><br><img src="https://habrastorage.org/files/31d/c86/16d/31dc8616d97c49f19acebdaa2e1ac80c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac addresses in it are no longer observed, but it is clear that some sessions are clearly frozen. Check the radacct table, see what happened to the ‚Äúdetpis7‚Äù user. </font></font><br><br><img src="https://habrastorage.org/files/661/f59/efd/661f59efda3a4285b8baaa89dc1c027f.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And with his session, everything is just fine. We see that it started 2015-12-24 18:18:00, and ended 2015-12-24 19:11:37 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why then does it hang in our billing with the start time 2015-12-24 18:18:00 ? Let's see how the database query is formed. This happens in the /opt/EasyHotspot/htdocs/system/application/models/onlineusermodel.php file:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">'select username, MAX(acctstarttime) as start, (acctstoptime) as stop, sum(acctsessiontime) as time,sum(acctoutputoctets)+sum(acctinputoctets) as packet from radacct where (acctstoptime IS NULL) group by username'</span></span>);</code> </pre><br>   ,                  acctstoptime  NULL.            . <br><br>      .  ,            .      start,    .     accounting_update_query   /etc/raddb/sql/mysql/dialup.conf    , freeRadius   accounting_update_query_alt    ,     . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly, we see that the session start time within one session changes by one second. How does this work? The NAS only sends Acct-Session-Time, but acctstarttime for the radacct freeRadius table counts itself. Let's look at the accounting_update_query_alt request in the /etc/raddb/sql/mysql/dialup.conf file:</font></font><br><br><pre> <code class="bash hljs">DATE_SUB(<span class="hljs-string"><span class="hljs-string">'%S'</span></span>, \ INTERVAL (%{%{Acct-Session-Time}:-0} + \ %{%{Acct-Delay-Time}:-0}) SECOND)</code> </pre><br>     ,     ,    Acct-Session-Time (Acct-Delay-Time   0)     . <br><br>     :       12.00.00,   12.00.20 NAS    Interim-update,  12.00.20  12.00.00,  20    Acct-Session-Time = 20 freeRadius'.  ,   ,   MySQL DATE_SUB(date,INTERVAL expr type)  12.00.20  20,  12.00.00        acctstarttime. <br><br>   20  NAS    ,   Acct-Session-Time = 40      -             12.00.41, 12.00.41 ‚Äî 40 = 12.00.01      radacct acctstarttime = 12.00.01. <br><br>      .   ,     MAX(acctstarttime)  acctstoptime = NULL    . <br><br>       Duration    acctsessiontime  ,     .        ,      ,        . <br><br>   : <br><br> vi /opt/EasyHotspot/htdocs/system/application/models/onlineusermodel.php <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db-&gt;query(<span class="hljs-string"><span class="hljs-string">'SELECT username, MAX(radacctid), MAX(acctstarttime) as start, MAX(acctstoptime) as stop, CAST(max(acctsessiontime)/60 AS UNSIGNED) as time,max(acctoutputoctets)+max(acctinputoctets) as packet, framedipaddress FROM radacct GROUP BY acctuniqueid HAVING stop IS NULL'</span></span>);</code> </pre><br>       username,  acctuniqueid.      .   MAX(acctstarttime)    ,        radacctid,    ,    acctsessiontime      60,                acctoutputoctets  acctinputoctets          stop = NULL. <br><br>               ,    .       framedipaddress,   IP-  .    . <br><br> vi /opt/EasyHotspot/htdocs/system/application/views/onlineusers_view.php <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">'BASEPATH'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">'No direct script access allowed'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;load-&gt;view(<span class="hljs-string"><span class="hljs-string">'header'</span></span>) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;h1&gt;<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>=$action<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>&lt;/h1&gt; &lt;table <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stripe</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tbody</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tr</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">line</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">')?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Start</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Duration</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IP</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Address</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Force</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Disconnect</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">th</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tr</span></span></span><span class="hljs-class">&gt; &lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreach</span></span></span><span class="hljs-class"> ($</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onlineusers</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">as</span></span></span><span class="hljs-class"> $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">): ?&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tr</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">;?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">start</span></span></span><span class="hljs-class">;?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">time</span></span></span><span class="hljs-class">;?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packet</span></span></span><span class="hljs-class">;?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">framedipaddress</span></span></span><span class="hljs-class">;?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt;&lt;?=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anchor</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onlineuser</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">disconnect</span></span></span><span class="hljs-class">/'.$</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">,'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">disconnect</span></span></span><span class="hljs-class">','</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">disconnect</span></span></span><span class="hljs-class">" ')?&gt;&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">td</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tr</span></span></span><span class="hljs-class">&gt; &lt;?</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">php</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">endforeach</span></span></span><span class="hljs-class">;?&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tbody</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">table</span></span></span><span class="hljs-class">&gt; &lt;? $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">footer</span></span></span><span class="hljs-class">'); ?&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider how data is requested for the [Cashier Menu] -&gt; Voucher Management page. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vi /opt/EasyHotspot/htdocs/system/application/models/vouchermodel.php +22 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a query to the table voucher_list In fact, this is not a table, but a </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25B4%25D1%2581%25D1%2582%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25B1%25D0%25B0%25D0%25B7%25D1%258B_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585)"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Its description, like for all created tables, can be found in the /opt/EasyHotspot/install/database_with_sample.sql file.</font></font><br><br><pre> <code class="sql hljs">VIEW `voucher_list` AS <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`id`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`username`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`password`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`billingplan`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`billingplan`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid_until`</span></span>,<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`type`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`type`</span></span>,<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`amount`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`amount`</span></span>,<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`valid_for`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid_for`</span></span>,<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`price`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_used`</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`type`</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),(<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`amount`</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_remain`</span></span>,((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_used`</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`type`</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'packet'</span></span>),(<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`amount`</span></span> - (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>((<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_remain`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`isexported`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`isexported`</span></span>,<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`isprinted`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`isprinted`</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`type`</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>) &gt;= <span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`amount`</span></span>),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) &gt;= <span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`amount`</span></span>),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((<span class="hljs-string"><span class="hljs-string">`voucher`</span></span> <span class="hljs-string"><span class="hljs-string">`v`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`radacct`</span></span> <span class="hljs-string"><span class="hljs-string">`ra`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> = <span class="hljs-string"><span class="hljs-string">`ra`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`billingplan`</span></span> <span class="hljs-string"><span class="hljs-string">`b`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`b`</span></span>.<span class="hljs-string"><span class="hljs-string">`name`</span></span> = <span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`billingplan`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">`v`</span></span>.<span class="hljs-string"><span class="hljs-string">`username</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The point is that the view collects data from other tables, as in a normal query, and we refer to the view as a normal table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we view our presentation as a normal request, we need to redo it like this:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, billingplan, valid_until, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, amount, valid_for, price, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),(amount - <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_remain, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'packet'</span></span>),((amount - <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_remain, isexported, isprinted, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) &gt;= amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) &gt;= amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> v.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,v.username <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> username,v.password <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, v.created_by <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> created, v.created_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> created_time, ra.acctuniqueid <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> acctuniqueid, v.billingplan <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> billingplan,v.valid_until <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid_until,b.type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>,b.amount <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> amount,b.valid_for <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid_for,b.price <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> price,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),(b.amount - (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_remain,((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctoutputoctets) + <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'packet'</span></span>),(b.amount - (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((ra.acctoutputoctets + ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_remain,v.isexported <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isexported,v.isprinted <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isprinted,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>) &gt;= b.amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctoutputoctets) + <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) &gt;= b.amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((voucher v <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> radacct ra <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((v.username = ra.username))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> billingplan b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((b.name = v.billingplan))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> v.username, ra.acctuniqueid) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> b <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> username</code> </pre><br>      ,             acctsessiontime, acctoutputoctets  acctinputoctets      . <br><br>  :         radacct        ,             .           .        ,           ,   . <br><br>    ,      .         .   voucher_list_0       voucher_list: <br><br><pre> <code class="sql hljs">mysql -u easyhotspot -p easyhotspot_opensource Enter password: easyhotspot <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> voucher_list_0 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> v.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,v.username <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> username,v.password <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>,ra.acctuniqueid <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> acctuniqueid, v.billingplan <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> billingplan, v.valid_until <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid_until,b.type <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>,b.amount <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> amount,b.valid_for <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid_for,b.price <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> price,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),(b.amount - (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_remain,((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctoutputoctets) + <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'packet'</span></span>),(b.amount - (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((ra.acctoutputoctets + ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_remain,v.isexported <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isexported,v.isprinted <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> isprinted,<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((b.type = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctsessiontime) / <span class="hljs-number"><span class="hljs-number">60</span></span>) &gt;= b.amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((((<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctoutputoctets) + <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ra.acctinputoctets)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) &gt;= b.amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((voucher v <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> radacct ra <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((v.username = ra.username))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> billingplan b <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((b.name = v.billingplan))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> v.username, ra.acctuniqueid;</code> </pre><br>   : <br><br><pre> <code class="bash hljs">drop view voucher_list;</code> </pre><br>   : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> voucher_list <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, billingplan, valid_until, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, amount, valid_for, price, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),(amount - <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used)),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_remain, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'packet'</span></span>),((amount - <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>),_latin1<span class="hljs-string"><span class="hljs-string">'null'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_remain, isexported, isprinted, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = _latin1<span class="hljs-string"><span class="hljs-string">'time'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) &gt;= amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>),<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) &gt;= amount),_latin1<span class="hljs-string"><span class="hljs-string">'exp'</span></span>,_latin1<span class="hljs-string"><span class="hljs-string">'valid'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> voucher_list_0 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> username;</code> </pre><br>        [ Cashier Menu ] -&gt; Postpaid.    : <br><br><pre> <code class="sql hljs">VIEW `postpaid_account_list` AS <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`id`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`realname`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`realname`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`username`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`password`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_used`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_used`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_price`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_price`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`radacct`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> = <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`postplan`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`name`</span></span> = <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span></code> </pre><br>    ,   `postpaid_account_list`  : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, realname, username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used, bill_by, time_price, packet_price, valid_until <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`id`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`realname`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`realname`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`username`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`password`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>)/<span class="hljs-number"><span class="hljs-number">60</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_used`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_used`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_price`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_price`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`radacct`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> = <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`postplan`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`name`</span></span> = <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>, radacct.acctuniqueid ) <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> username</code> </pre><br>   postpaid_account_list_0       postpaid_account_list: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> postpaid_account_list_0 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`id`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`realname`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`realname`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`username`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`password`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>)/<span class="hljs-number"><span class="hljs-number">60</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_used`</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_used`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctsessiontime`</span></span>) / <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`time_price`</span></span>,(<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`price`</span></span> * (<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>((<span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctoutputoctets`</span></span> + <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`acctinputoctets`</span></span>)) / <span class="hljs-number"><span class="hljs-number">1048576</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`packet_price`</span></span>,<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`valid_until`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`radacct`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span> = <span class="hljs-string"><span class="hljs-string">`radacct`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-string"><span class="hljs-string">`postplan`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>((<span class="hljs-string"><span class="hljs-string">`postplan`</span></span>.<span class="hljs-string"><span class="hljs-string">`name`</span></span> = <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`bill_by`</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">`postpaid_account`</span></span>.<span class="hljs-string"><span class="hljs-string">`username`</span></span>, radacct.acctuniqueid;</code> </pre><br>   : <br><br><pre> <code class="bash hljs">drop view postpaid_account_list;</code> </pre><br>   : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> postpaid_account_list <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, realname, username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(time_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> time_used, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(packet_used) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> packet_used, bill_by, time_price, packet_price, valid_until <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> postpaid_account_list_0 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> username;</code> </pre><br>   ,  freeRadius        radacct.    [noresetcounter],    /etc/raddb/sql/mysql/counter.conf. <br><br> vi /etc/raddb/sql/mysql/counter.conf +110 <br><br><pre> <code class="bash hljs">sqlcounter noresetcounter { counter-name = Session-Timeout check-name = Session-Timeout reply-name = Session-Timeout sqlmod-inst = sql key = User-Name reset = never query = <span class="hljs-string"><span class="hljs-string">"SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='%{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${key}</span></span></span><span class="hljs-string">}'"</span></span> }</code> </pre><br>        . noresetcounter,      .  ,    3600 ,            .     ,     , , . <br><br><ul><li> check-name = Session-Timeout ‚Äî      ,  freeRadius    (radcheck  radgroupcheck)    Session-Timeout </li><li> reply-name = Session-Timeout ‚Äî     ,       Session-Timeout    sql-   . </li></ul><br>     query.     ,    .      ,   .       AcctSessionTime      ,       .    mysql  IFNULL,      ,   0.   <br><br><pre> <code class="bash hljs">query = <span class="hljs-string"><span class="hljs-string">"SELECT IFNULL(SUM(AcctSessionTime),0) FROM radacct WHERE UserName='%{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${key}</span></span></span><span class="hljs-string">}'"</span></span></code> </pre><br>  on <br><br><pre> <code class="bash hljs">query = <span class="hljs-string"><span class="hljs-string">"SELECT SUM(b) FROM (SELECT IFNULL(MAX(AcctSessionTime),0) as b FROM radacct WHERE UserName='%{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${key}</span></span></span><span class="hljs-string">}'GROUP BY acctuniqueid) as list"</span></span></code> </pre><br>    ,       session    [sql]       /etc/raddb/sql/mysql/dialup.conf   ¬´Simultaneous Use Checking Queries¬ª. <br><br><pre> <code class="bash hljs">simul_count_query = <span class="hljs-string"><span class="hljs-string">"SELECT COUNT(*) \ FROM </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${acct_table1}</span></span></span><span class="hljs-string"> \ WHERE username = '%{SQL-User-Name}' \ AND acctstoptime IS NULL"</span></span></code> </pre><br>           .   ,    radgroupcheck     Simultaneous-Use := 1,              . <br><br>         detpis7: <br><br><img src="https://habrastorage.org/files/661/f59/efd/661f59efda3a4285b8baaa89dc1c027f.jpg" alt="image"><br><br>        simul_count_query?   , : <br><br><pre> <code class="bash hljs">mysql&gt; SELECT COUNT(*) -&gt; FROM radacct -&gt; WHERE username = <span class="hljs-string"><span class="hljs-string">'detpis7'</span></span> -&gt; AND acctstoptime IS NULL; +----------+ | COUNT(*) | +----------+ | 3 | +----------+ 1 row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec)</code> </pre><br>     ,    detpis7     .  : <br><br> vi /etc/raddb/sql/mysql/dialup.conf +300 <br><br><pre> <code class="bash hljs">simul_count_query = <span class="hljs-string"><span class="hljs-string">"SELECT COUNT(*) FROM (SELECT username, MAX(radacctid), MAX(acctstoptime) as stop, MAX(acctstarttime) FROM </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${acct_table1}</span></span></span><span class="hljs-string"> GROUP BY acctuniqueid HAVING username = '%{SQL-User-Name}' AND stop IS NULL) list"</span></span></code> </pre><br>   mysql: <br><br><pre> <code class="bash hljs">mysql&gt; SELECT COUNT(*) FROM (SELECT username, MAX(radacctid), MAX(acctstoptime) as stop, MAX(acctstarttime) FROM radacct GROUP BY acctuniqueid HAVING username = <span class="hljs-string"><span class="hljs-string">'detpis7'</span></span> AND stop IS NULL) list -&gt; ; +----------+ | COUNT(*) | +----------+ | 0 | +----------+ 1 row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec)</code> </pre><br>    ,     hotspot    . </div><p>Source: <a href="https://habr.com/ru/post/275155/">https://habr.com/ru/post/275155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275139/index.html">Collect the best of two worlds - frameworks and CMS (part 3)</a></li>
<li><a href="../275141/index.html">Measuring the weight of minerals in the mining industry. Theoretical basis</a></li>
<li><a href="../275145/index.html">About React Native</a></li>
<li><a href="../275151/index.html">Weak links in PHP 7</a></li>
<li><a href="../275153/index.html">DeepHack.Q & A Starts - International Hackathon for Deep Learning and Machine Intelligence</a></li>
<li><a href="../275157/index.html">Rust 1.5: Cargo with blackjack</a></li>
<li><a href="../275159/index.html">Resist adding new libraries to your project.</a></li>
<li><a href="../275161/index.html">Hacking bank cards, cars and instant messengers and other features of education at the best magistracy in the Netherlands</a></li>
<li><a href="../275163/index.html">IaaS useful digest</a></li>
<li><a href="../275165/index.html">Safe doors, or continue to design ACS TP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>