<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build ICO file with icons in PNG format using FASM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes I write small programs in C ++, and often it turns out that the program icon ‚Äúweighs‚Äù more than the program itself. It also happened when wr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build ICO file with icons in PNG format using FASM</h1><div class="post__text post__text-html js-mediator-article">  Sometimes I write small programs in C ++, and often it turns out that the program icon ‚Äúweighs‚Äù more than the program itself.  It also happened when writing <a href="http://geektimes.ru/post/243937/">Sound Keeper</a> : the program is 14KB, the icon is 16 √ó 16 + 32 √ó 32 + 48 √ó 48 pixels - 15KB.  What a waste!  Fortunately, it turned out that Windows (starting with Vista) supports PNG inside ICO.  This is exactly what you need!  But for some reason there was no program that would allow most to optimize PNG files and build an ICO file from them.  Since ICO files have a very simple format, we will <a href="http://flatassembler.net/">assemble</a> it using <a href="http://flatassembler.net/">FASM</a> .  This non-standard use of the "flat" assembler shows that it can be used in the most unexpected situations, and it works! <br><a name="habracut"></a><br><h2>  Let's get started </h2><br>  1. Create images for icons in PNG format.  For example, we will make two images with sizes of 16 √ó 16 and 32 √ó 32 pixels.  Save them in the icon16.png and icon32.png files, respectively.  Optimize to your taste with your favorite tools. <br><br>  2. Following the <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/10/18/10077133.aspx">documentation</a> , create the file icopng.asm with something like this: <br><pre><code class="hljs vhdl">dw <span class="hljs-number"><span class="hljs-number">0</span></span> ; reserved, must be <span class="hljs-number"><span class="hljs-number">0</span></span> dw <span class="hljs-number"><span class="hljs-number">1</span></span> ; icon <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, must be <span class="hljs-number"><span class="hljs-number">1</span></span> dw <span class="hljs-number"><span class="hljs-number">2</span></span> ; number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> images <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>st icon header db <span class="hljs-number"><span class="hljs-number">32</span></span> ; <span class="hljs-literal"><span class="hljs-literal">width</span></span> db <span class="hljs-number"><span class="hljs-number">32</span></span> ; height db <span class="hljs-number"><span class="hljs-number">0</span></span> ; no color palette db <span class="hljs-number"><span class="hljs-number">0</span></span> ; reserved, must be <span class="hljs-number"><span class="hljs-number">0</span></span> dw <span class="hljs-number"><span class="hljs-number">1</span></span> ; planes dw <span class="hljs-number"><span class="hljs-number">32</span></span> ; bits per pixel dd icon32_end-icon32_start ; length dd icon32_start ; offset ; <span class="hljs-number"><span class="hljs-number">2</span></span>nd icon header db <span class="hljs-number"><span class="hljs-number">16</span></span> ; <span class="hljs-literal"><span class="hljs-literal">width</span></span> db <span class="hljs-number"><span class="hljs-number">16</span></span> ; height db <span class="hljs-number"><span class="hljs-number">0</span></span> ; no color palette db <span class="hljs-number"><span class="hljs-number">0</span></span> ; reserved, must be <span class="hljs-number"><span class="hljs-number">0</span></span> dw <span class="hljs-number"><span class="hljs-number">1</span></span> ; planes dw <span class="hljs-number"><span class="hljs-number">32</span></span> ; bits per pixel dd icon16_end-icon16_start ; length dd icon16_start ; offset ; <span class="hljs-number"><span class="hljs-number">1</span></span>st icon <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> icon32_start: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'icon32</span></span>.png' icon32_end: ; <span class="hljs-number"><span class="hljs-number">2</span></span>nd icon <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> icon16_start: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'icon16</span></span>.png' icon16_end:</code> </pre>  It was experimentally established that it is better to connect the images in the reverse order, from large to smaller ones.  When adding more icons, do not forget to correct the field with the total number of images in the header.  An error here can lead to unexpected consequences. <br><br>  3. Build the icon with the command: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">fasm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">icopng</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.asm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">icopng</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ico</span></span></code> </pre> <br>  4. As a result, we received an icon with images in PNG format.  Instead of 15KB, I got a file of only 3KB in size. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  PNG8 support with alpha channel </h2><br>  According to scanty <a href="http://blogs.msdn.com/b/oldnewthing/archive/2010/10/22/10079192.aspx">documentation</a> , only PNG32 images should be supported.  <a href="">In practice, the</a> system easily decodes PNG8 images even with an alpha channel.  Unless only the Windows image viewer does not understand PNG8 in icons, apparently it does not use system functions for decoding and drawing the icon.  But you are not making icons to look at them in the image viewer, right?  :) Everywhere, where standard Windows functions are used for loading and displaying the icon - PNG8 with alpha channel is displayed in the same way as PNG32. <br><br>  Important note: even PNG8 images in the header should have no palette, because the PNG decoder at the output gives TrueColor an image with an alpha channel where any colors can occur.  That is, in the example you will only need to change the width and height fields.  The rest is not necessary to touch. <br><br><h2>  Problem in PNG system decoder </h2><br>  PNG support for icons in Windows Vista and later is used by default to save only large 256 √ó 256 icons.  Apparently, PNG support inside the ICO was poorly tested, so there are some problems and workarounds for them. <br><br>  Some kind of error was detected in the PNG system decoder, which is why a particular icon file may not appear correctly in some places (for example, in the file properties dialog).  Moreover, the minimum change in compression parameters easily solves the problem. <br><br>  I did a little research on the <a href="">icon file</a> , which was incorrectly displayed in the file properties dialog.  The <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms648065%2528v%3Dvs.85%2529.aspx">DrawIconEx</a> system function has 3 icon drawing modes: DI_NORMAL (with alpha), DI_IMAGE (without alpha), and DI_MASK (mask only). <br><br><img src="https://habrastorage.org/files/6bf/d92/953/6bfd929539fd4436904e183ccfa8c0d3.png"><br><br>  In this image you can see how the same icon was rendered in different modes, and under the name RESULT what this icon looks like in the file properties.  It can be seen that in DI_NORMAL and DI_IMAGE modes the system draws the icon correctly.  However, in the DI_MASK mode, the mask computed with a view to compatibility is somehow shifted three pixels to the right, and some garbage appeared in the first column of pixels ‚Äî probably due to incorrect buffer handling.  The icon in the file properties, as you can see, has serious artifacts just in the shape of an incorrect mask.  It would be nice to report this problem to the Microsoft developers, but unfortunately, I did not find any open bug tracker. <br><br><h2>  PNG Optimization Tips </h2><br>  I recommend using the <a href="http://x128.ho.ua/color-quantizer.html">Color Quantizer</a> program to convert files from PNG32 to PNG8 with alpha channel.  The resulting file, among other things, is compressed by a very efficient algorithm, so usually additional optimization is not required. <br><br><img src="https://habrastorage.org/files/ae8/3a5/f7d/ae83a5f7dd65402e8490ea2e75f3946d.png"><br><br>  In the screenshot, a block is highlighted in red with a choice of the number of colors and a coefficient of allowable quantization errors.  If the above problem occurs with incorrect display of the icon in the file properties dialog, simply change the quantization parameters.  For example, slightly change the value of the ratio of allowable quantization errors. <br><br><h2>  That's all </h2><br>  Now your compact programs can be with colorful icons of all necessary sizes.  No need to sacrifice transparency or the number of options for the icon.  There is only one drawback - users of Windows XP will not see such an icon.  But if you consider that the official support for Windows XP has long been over, and fewer computers are running this operating system, then everything is not so bad.  Moreover, the authors of small programs often do not add an icon at all to save. </div><p>Source: <a href="https://habr.com/ru/post/247425/">https://habr.com/ru/post/247425/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247413/index.html">Pulp Fiction Weekend - Microsoft Press Free Books</a></li>
<li><a href="../247415/index.html">Marxico - markdown editor for Evernote</a></li>
<li><a href="../247419/index.html">Beautiful Fall: Gravity CSS3 Animation</a></li>
<li><a href="../247421/index.html">Recovering deleted data using Scalpel</a></li>
<li><a href="../247423/index.html">Creating a 3D scanner from a webcam, laser, and a handful of radio components</a></li>
<li><a href="../247429/index.html">The digest of interesting, top and fatal materials from the world of Habr for 2014</a></li>
<li><a href="../247431/index.html">NFV network function virtualization</a></li>
<li><a href="../247433/index.html">Continuing to shred CLR: .Net object pool outside SOH / LOH heaps</a></li>
<li><a href="../247435/index.html">Fix frozen buttons on Nexus 4</a></li>
<li><a href="../247437/index.html">Apple Watch emulator in browser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>