<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Game development for NES in C. Chapters 4-6. Drawing character</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this part we consider the work with graphics: background and sprites of characters. 
 <<< previous next >>> 

 
 A source 
 What is V-blank? 


 PP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Game development for NES in C. Chapters 4-6. Drawing character</h1><div class="post__text post__text-html js-mediator-article"><p>  In this part we consider the work with graphics: background and sprites of characters. <br>  <a href="https://habrahabr.ru/post/348022/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/348820/">next &gt;&gt;&gt;</a> <br><br> <a href="https://habrahabr.ru/post/348212/"><img src="https://habrastorage.org/getpro/habr/post_images/3cf/3f0/a67/3cf3f0a67db4a8f60b28be794e534550.jpg" alt="image"><br></a>  <a href="https://twitter.com/mrbrownjeremy/status/860891813044944896">A source</a> </p><br><h4 id="chto-takoe-v-blank">  What is V-blank? </h4><br><p>  PPU - a graphics processor - can either send a signal to the TV, or receive information from the processor, but not simultaneously.  So the only time for sending is V-blank, the period of personnel extinguishing impulse. </p><br><p>  PPU sends pixels to the video output 90% of the time, line by line from left to right and top to bottom.  A pause is made at the bottom of the screen, and everything repeats.  This happens 60 times per second.  Pause after the frame is drawn and there is a V-blank.  This is a very short time.  It is really possible to attach an update of 2-4 columns of background tiles and an update of sprites into it.  Updating the background is especially critical for scrolling games. </p><a name="habracut"></a><br><p>  There are two ways to learn about the occurrence of V-blank.  First, PPU sets the flag in the high bit of the $ 2002 register.  Secondly, a nonmaskable interrupt (NMI) is called, and a transition occurs at a given address ‚Äî the interrupt vector.  It can be used to work with PPU, control the timing of music, move sprites.  The interval between NMI calls is 1/60 of a second, and it can be used to count the time in the game. </p><br><p>  Now we will write a program that will output ‚ÄúHELLO WORLD‚Äù by 1 letter every 30 frames.  After displaying the entire phrase, clear the screen, and repeat everything in a circle. </p><br><p>  Pay attention to the fragment </p><br><pre><code class="hljs">nmi: inc _NMI_flag inc _Frame_Count</code> </pre> <br><p>  in the reset.s file.  This is a nonmaskable interrupt handler code that actually implements the frame counter in the global variable.  Each frame sets the NMI_flag flag, and if 30 frames have passed (0.5 seconds), the next letter sprite is displayed.  All logic is implemented in main (). </p><br><div class="spoiler">  <b class="spoiler_title">lesson2.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load_Text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Text_Position &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(TEXT)){ <span class="hljs-comment"><span class="hljs-comment">//    PPU_ADDRESS = 0x21; // Y-  PPU_ADDRESS = 0xca + Text_Position; //X-    PPU_DATA = TEXT[Text_Position]; ++Text_Position; } else { // ,      Text_Position = 0; PPU_ADDRESS = 0x21; PPU_ADDRESS = 0xca; for ( index = 0; index &lt; sizeof(TEXT); ++index ){ PPU_DATA = 0; //          } } } void main (void) { All_Off(); //   Load_Palette(); Reset_Scroll(); All_On(); //   while (1){ //   while (NMI_flag == 0); //  NMI NMI_flag = 0; if (Frame_Count == 30){ //  30  Load_Text(); Reset_Scroll(); Frame_Count = 0; } } } //  NMI  ++NMIflag  ++FrameCount   V-blank</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e14/8af/2ca/e148af2cac6a9816f26afedd8df1e792.gif" alt="image"></p><br><p>  The source code is <a href="">here</a> and <a href="https://github.com/BubaVV/nesdoug">here</a> . </p><br><p>  Ideally, you should wait for V-blank before calling All_On (), otherwise one frame after it will be distorted and the screen will flicker.  In this example, this effect is invisible, because All_On () is called only once when the console starts, the screen is black at this time, and the distortion is not noticeable. </p><br><h4 id="nemnogo-cveta">  Some color </h4><br><p>  Now you can color what happened. </p><br><p>  A few words about the palette in the NES.  In the PPU memory, 16 bytes are allocated for it at the addresses $ 3F00- $ 3F0F for 4 background palettes and 16 bytes at the addresses $ 3F10- $ 3F1F for 4 sprites palettes.  The first color of the sprite is always drawn as transparent, and the first background color as the default background color.  The bytes in the PPU memory corresponding to the first colors are mirrored for all 8 entries, and correspond to the default background color.  So we can use 3 unique colors for the sprite and 3 colors plus a common background for tiles. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/627/7c8/dfe/6277c8dfef39d2b2c7f4ef855fa9d7dc.png" alt="image"></p><br><p>  Thus, you can simultaneously draw 25 colors out of 50 possible. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b74/0c1/ec7/b740c1ec7f46d653d2fa581ab9e6c9d5.png" alt="image"></p><br><p>  You can darken these colors through the color emphasis registers, but this feature is not compatible with all clones of the console.  In addition, some televisions tear off roofs of $ 0D and $ 1D colors.  They are blacker than black, and this is an abnormal situation.  Use colors $ xF. </p><br><p>  For the background, the palette is defined for a block of 2x2 tiles, 16x16 pixels in size.  For this breakdown it is convenient to use the Nes Screen Tool.  Most games build the background from such quad metatails. </p><br><p>  In each table of names (in fact, a blank for rendering the screen), 64 bytes are allocated for attributes.  For example, for table 0, the addresses are PPU $ 2000- $ 23FF, and attributes are stored in $ 23C0- $ 23FF.  Each attribute byte describes 4 metatails, that is, an area of ‚Äã‚Äã32x32 pixels.  Accordingly, 2 bits select the palette number for the metathile.  Matching a bit to a metatail is: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e92/29e/802/e9229e80293fcb10f7ba255ae2bcd36d.png" alt="image"><br>  Here one letter corresponds to one tile, a small square is a 2x2 metatyle. </p><br><p>  That is, in order to change the palette of the right lower quadrant for the first of 4 possible ones, it is necessary to change the two bits of the attribute to 01: 01. </p><br><p>  I added to the past example of the palette, so that the letters are now multicolored.  Palettes are moved to a separate file and imported via #include, and variables are defined in the zero page of memory via #pragma - just to demonstrate this feature.  The zero page is faster, but 10-20 variables are used there for internal compiler needs.  So you need to count somewhere on the 235 available bytes. </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> bss-name(push, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ZEROPAGE"</span></span></span><span class="hljs-meta">) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   #include "PALETTE.c" #include "CODE.c"</span></span></span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">lesson3.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> PALETTE[]={ <span class="hljs-number"><span class="hljs-number">0x11</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x31</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  0x00, 0x00, 0x00, 0x15, //  0x00, 0x00, 0x00, 0x27, //  0x00, 0x00, 0x00, 0x1a, //  }; // 011 -   ,  //      const unsigned char Attrib_Table[]={ 0x44, // 0100 0100, 0xbb, // 1011 1011, 0x44, // 0100 0100, 0xbb}; // 1011 1011 }; //   - 2       1616  PPU_ADDRESS = 0x23; PPU_ADDRESS = 0xda; for( index = 0; index &lt; sizeof(Attrib_Table); ++index ){ PPU_DATA = Attrib_Table[index]; } //     PPU</span></span></code> </pre></div></div><br><p><img src="https://habrastorage.org/getpro/habr/post_images/727/678/634/727678634e4ae698acab24ef47883d78.png" alt="image"></p><br><p>  The source code is <a href="">here</a> and <a href="https://github.com/BubaVV/nesdoug">here</a> . </p><br><p>  Here is a useful cheat sheet for the addresses of the attribute table and its binding to screen coordinates: <br><img src="https://habrastorage.org/getpro/habr/post_images/78c/eaa/9a6/78ceaa9a681627bc754a57585097155a.png" alt="image"><br>  The screen is 256 pixels wide, each cell of the table corresponds to a 32x32 square. </p><br><h4 id="sprayty">  Sprites </h4><br><p>  Sprite is an 8x8 image that can move around the screen.  There is a tricky way to use 8x16 sprites, but we will not do that.  Almost all game characters are sprites.  Although in some cases you need to draw them with background tiles due to restrictions on the number of sprites, this is used for the final bosses in some games. <br>  8x8 points is very small, so you have to collect a character from several sprites: a small Mario from 2x2, and a large one from 2x4. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5e2/82a/073/5e282a07309b245eefb9ae2df61e15a7.png" alt="image"></p><br><p>  We must remember the limitations.  Supports no more than 64 sprites, and no more than 8 on one line of the screen.  If the limit is exceeded, only high priority sprites will be drawn.  If you change the priority of the sprite between frames, it will flash.  This method is often used in games. </p><br><p>  PPU stores information on sprites in the OAM table.  Its size is 256 bytes: 4 bytes for each of the 64 possible sprites.  If two sprites with the same priority are superimposed, then the sprite with the lower number is drawn over.  If on one line of the screen there are more than 8 sprites, then only 8 with smaller numbers will be drawn. </p><br><p>  The OAM table stores these attributes: </p><br><ol><li>  Y coordinate </li><li>  Sprite index to display </li><li>  Attributes: palette, priority, mirror image </li><li>  X coordinate </li></ol><br><p>  Coordinates are calculated on the upper left corner.  X can be from $ 00 to $ F8, Y from $ 00 to $ EE.  You can partially hide the sprite down or to the right of the screen, but the left and upper borders are inviolable.  In our example, the initialization code hides the sprites below, Y = $ F8. <br>  <a href="http://wiki.nesdev.com/w/index.php/PPU_OAM">Details on the OAM table.</a> </p><br><p>  How all this is stored in memory: <br><img src="https://habrastorage.org/getpro/habr/post_images/75f/60d/e0e/75f60de0e70e973ddfde7cf037f1c2e2.png" alt="image"><br>  The truth is, here the sprite table is stored in RAM at $ 700, and in the example $ 200 is used. </p><br><p>  Writing to the OAM table is implemented through memory registers: you need to write the address of the sprite at $ 2003, and then the data for it at $ 2004.  This is rarely used because there is a more convenient and faster way to fill with DMA.  It is activated through the register $ 4014: we write $ xx to the address $ 4014, 256 bytes from the range $ xx00- $ xxFF are poured into the OAM.  This should be done during the V-Blank period. </p><br><p>  In our example, we will create a meta sprite of 4 sprites and add animation. </p><br><p>  We must remember that the sprites are drawn 1 point below the expected coordinate.  The picture with Mario at the top of the post shows that he went 1 pixel to the floor. </p><br><div class="spoiler">  <b class="spoiler_title">lesson4.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> bss-name(push, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ZEROPAGE"</span></span></span><span class="hljs-meta">) unsigned char NMI_flag; unsigned char Frame_Count; unsigned char index; unsigned char index4; unsigned char X1; unsigned char Y1; unsigned char move; unsigned char move_count; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> bss-name(push, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OAM"</span></span></span><span class="hljs-meta">) unsigned char SPRITES[256]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// OAM    $200-$2FF,     cfg const unsigned char PALETTE[]={ 0x19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0x19, 0x37, 0x24, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}; const unsigned char MetaSprite_Y[] = {0, 0, 8, 8}; //  Y- const unsigned char MetaSprite_Tile[] = {0, 1, 0x10, 0x11}; //   const unsigned char MetaSprite_Attrib[] = {0, 0, 0, 0}; // :     const unsigned char MetaSprite_X[] = {0, 8, 0, 8}; //  X- //  4 ,    -   void every_frame(void) { OAM_ADDRESS = 0; OAM_DMA = 2; //     OAM  DMA PPU_CTRL = 0x90; //   NMI  PPU_MASK = 0x1e; SCROLL = 0; SCROLL = 0; // ,    } //      void update_Sprites (void) { index4 = 0; for (index = 0; index &lt; 4; ++index ){ SPRITES[index4] = MetaSprite_Y[index] + Y1; //    ++index4; SPRITES[index4] = MetaSprite_Tile[index]; //   ++index4; SPRITES[index4] = MetaSprite_Attrib[index]; //    ++index4; SPRITES[index4] = MetaSprite_X[index] + X1; //    ++index4; } } //  ,   void main (void) { All_Off(); //   X1 = 0x7f; //    Y1 = 0x77; //     Load_Palette(); Reset_Scroll(); All_On(); //   while (1){ //   while (NMI_flag == 0); //    NMI NMI_flag = 0; every_frame(); //      v-blank if (move == 0) ++X1; if (move == 1) ++Y1; if (move == 2) --X1; if (move == 3) --Y1; ++move_count; if (move_count == 20){ //  20  move_count = 0; ++move; } if (move == 4) move=0; update_Sprites(); } }</span></span></span></span></code> </pre> </div></div><br><p>  There is a slightly improved version where the character turns when moving in a square. </p><br><div class="spoiler">  <b class="spoiler_title">Fragment lesson4b.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> MetaSprite_Tile[] = { <span class="hljs-comment"><span class="hljs-comment">//  2, 3, 0x12, 0x13, // right 0, 1, 0x10, 0x11, // down 6, 7, 0x16, 0x17, // left 4, 5, 0x14, 0x15}; // up void update_Sprites (void) { move4 = move &lt;&lt; 2; //    4 index4 = 0; for (index = 0; index &lt; 4; ++index ){ SPRITES[index4] = MetaSprite_Y[index] + Y1; //    ++index4; SPRITES[index4] = MetaSprite_Tile[index + move4]; //   ++index4; SPRITES[index4] = MetaSprite_Attrib[index]; //    ++index4; SPRITES[index4] = MetaSprite_X[index] + X1; //    ++index4; } }</span></span></code> </pre></div></div><br><p><img src="https://habrastorage.org/getpro/habr/post_images/584/a65/243/584a652436e33121ffde2300b57756cf.gif" alt="image"></p><br><p>  The source code is <a href="">here</a> and <a href="https://github.com/BubaVV/nesdoug">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348212/">https://habr.com/ru/post/348212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348202/index.html">Apache Ignite - calculations in grid</a></li>
<li><a href="../348204/index.html">GObject Basics</a></li>
<li><a href="../348206/index.html">Algorithm of a choice of location in Nginx</a></li>
<li><a href="../348208/index.html">Interview. How to create a high-quality knowledge base: choice of technologies, search and further support</a></li>
<li><a href="../348210/index.html">Create CSS keylogger</a></li>
<li><a href="../348214/index.html">Transcription of geographical names in Open Street Map. Latvia, Lithuania, Poland, Estonia</a></li>
<li><a href="../348218/index.html">New lite text markup language based on pair quotes (pq)</a></li>
<li><a href="../348220/index.html">Reason on which database to choose</a></li>
<li><a href="../348222/index.html">The second part of the comparison of python and tcl</a></li>
<li><a href="../348224/index.html">Simple intent classifier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>