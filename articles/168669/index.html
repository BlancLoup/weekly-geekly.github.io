<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tasks and cancellation in .Net - tips & tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the release of the .NET Framework 4.0, Task Parallel Library (TPL) has been added to BCL to implement task-based parallelism. The library is base...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tasks and cancellation in .Net - tips & tricks</h1><div class="post__text post__text-html js-mediator-article"> With the release of the .NET Framework 4.0, <a href="http://en.wikipedia.org/wiki/Task_Parallel_Library">Task Parallel Library</a> (TPL) has been added to <a href="http://en.wikipedia.org/wiki/Base_Class_Library">BCL</a> to implement task-based parallelism.  The library is based on the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.aspx"><code>Task</code></a> types and the <a href="http://msdn.microsoft.com/en-us/library/system.threading.tasks.task.aspx"><code>Task</code></a> type inherited from it <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">.</a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">These types are wrappers for asynchronous operations;</a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">they allow to abstract from such technical details as, for example, flows and to synchronize asynchronous operations with each other.</a> <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"><br><br></a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">In the same version of the .NET Framework, a mini-framework appeared for cooperative undoing asynchronous operations.</a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">It consists of only three types:</a> <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"><br></a> <ul><li>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"></a><a href="http://msdn.microsoft.com/en-us/library/system.threading.cancellationtokensource.aspx"><code>CancellationTokenSource</code></a> - creates cancellation markers (the <code>Token</code> property) and processes requests for cancellation of an operation (overloaded <code>Cancel</code> / <code>CancelAfter</code> ). </li><li>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"></a><a href="http://msdn.microsoft.com/en-us/library/system.threading.cancellationtoken.aspx"><code>CancellationToken</code></a> - cancellation marker;  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">allows you to track cancellation requests in several ways: by polling the <code>IsCancellationRequested</code> property, by registering the callback function (via the overloaded <code>Register</code> method), by waiting on the synchronization object (the <code>WaitHandle</code> property).</a> </li><li>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"></a><a href="http://msdn.microsoft.com/en-us/library/system.operationcanceledexception.aspx"><code>OperationCanceledException</code></a> - an exception whose throwing by convention means that the request to cancel an operation has been processed and the operation must be considered canceled.  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">The preferred way to generate an exception is to call the <code>CancellationToken. ThrowIfCancellationRequested</code> method <code>CancellationToken. ThrowIfCancellationRequested</code></a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"><code>CancellationToken. ThrowIfCancellationRequested</code> .</a> </li></ul> <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"><br></a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">The cancellation mechanism via the <code>CancellationToken</code> is standard for the TPL ‚Äî there are overloads of methods that accept <code>CancellationToken</code> , exceptions <code>OperationCanceledException</code> are handled in a special way, etc.</a>  <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx">However, as in any other API, there are subtleties, tricks, best practices.</a> <a href="http://msdn.microsoft.com/en-us/library/dd321424.aspx"><br></a><a name="habracut"></a> <br><h4>  Why is co-operative cancellation? </h4><br>  The code that performs an asynchronous operation can be divided into three parts (layers): <br><ul><li>  The code is "around" the asynchronous operation, the outer layer.  This code initiates the operation, handles its result and exceptions that occurred during the operation. </li><li>  The code is "inside" an asynchronous operation, the inner layer.  This code implements the operation itself, performs the payload - calculations, input / output, data processing, etc. </li><li>  Intermediary code between external (1) and internal (2) code, infrastructure layer.  It is responsible for low-level details ‚Äî it starts the operation to be executed in the necessary thread, publishes the result of the operation so that it is accessible to the external code, etc.  In the case of using TPL, this code is inside the TPL itself. </li></ul><br>  The cancellation mechanism through the <code>CancellationToken</code> is cooperative, because it requires the coordinated support of the cancellation functionality from all three layers.  A typical code that performs an asynchronous operation with support for cancellation looks like this: <br><pre> <code class="cs hljs">CancellationTokenSource cts; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-comment"><span class="hljs-comment">//    var task = Task.Run(() =&gt; SomeWork(cts.Token), cts.Token); //     // // ... } int SomeWork(CancellationToken cancellationToken) { int result; while (true) { // -  ... // ...   ,      cancellationToken.ThrowIfCancellationRequested(); } //   return result; } void Cancel() { //    cts.Cancel(); }</span></span></code> </pre><br>  In this example, the code in the <code>Start</code> and <code>Cancel</code> functions is the outer layer.  It initiates an asynchronous operation by calling the <code>Task.Run</code> method.  In doing so, he passes the <code>CancellationToken</code> into two places at once: into the inner layer that directly performs the operation (the <code>SomeWork</code> method) and into the infrastructure layer (the second argument of the <code>Task.Run</code> function).  The <code>Cancel</code> function requests that the operation be canceled. <br><br>  The inner layer (the <code>SomeWork</code> function) besides executing the payload periodically checks whether cancellation is requested and, if necessary, throws an <code>OperationCanceledException</code> exception indicating that the cancellation request has been processed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The infrastructure layer (inside the TPL) to support cancellation does two things.  First, before launching the function passed to <code>Task.Run</code> , it checks whether cancellation is requested.  If so, the function does not even run.  Secondly, it handles in a special way the exception <code>OperationCanceledException</code> , informing about the cancellation of the operation. <br><br><h4>  Cancel request processing </h4><br>  After calling the <code>CancellationTokenSource.Cancel</code> method (or after the timeout specified when calling the <code>CancellationTokenSource</code> constructor / <code>CancellationTokenSource.CancelAfter</code> method has been called), the <code>CancellationTokenSource.CancelAfter</code> object changes to the canceled state.  The transition to the canceled state can occur exactly once.  It is impossible to change your mind and make a canceled <code>CancellationTokenSource</code> not canceled, and repeated calls to <code>Cancel</code> ignored. <br><br>  Calling functions that are registered via the <code>CancellationToken.Register</code> method are called when switching to the canceled state, the <code>CancellationToken.Register</code> property starts returning <code>true</code> , and a call to the <code>CancellationToken.ThrowIfCancellationRequested</code> method will generate an <code>OperationCanceledException</code> exception. <br><br>  The inner layer code should periodically check for a cancel request.  Typically, the verification code is reduced to calling the <code>ThrowIfCancellationRequested</code> method if the operation can be interrupted immediately.  If you need to perform additional actions before <code>IsCancellationRequested</code> (for example, release used resources), then the verification code refers to the <code>IsCancellationRequested</code> property.  If it is <code>true</code> , the resource is cleared and an <code>OperationCanceledException</code> exception is thrown (again, by calling the <code>ThrowIfCancellationRequested</code> method or manually). <br><br>  Here it is important to pay attention to the following.  First, if the cancellation request is not handled by the opcode, the operation will continue.  In the end, when the operation is completed (normally or with an exception), the task will be completed ( <code>Task.IsCompleted == true</code> ), but it will not be considered canceled ( <code>Task.IsCanceled == false</code> ). <br><br>  Secondly, you need to choose the optimal size of the interval between checks.  If the interval is too large, the operation will do the extra work if canceled.  If the interval is too small - the overhead of the test will increase the time of the operation.  It is difficult to recommend any specific values, much depends on the specific scenario.  General recommendations are as follows: if the probability of cancellation is not very high, checks can be performed less frequently.  If the cancellation of the operation is initiated by the user, to ensure the responsiveness of the UI, it is sufficient to check every 200-250 ms.  If the operation is performed in the server application, checks should be performed more often, so that in case of cancellation, do not waste server resources.  Checks should not take more than a few percent of the total operation time.  Again, I repeat that these are just general recommendations and in each specific case the developer must make a decision himself taking into account all the influencing factors.  Perhaps not superfluous will be the help of the profiler. <br><br>  Third, the <code>CancellationToken</code> has a <code>CanBeCanceled</code> property.  If it returns <code>false</code> , the cancellation request is guaranteed not to be and checks can be omitted.  <code>CanBeCanceled</code> is <code>false</code> if the <code>CancellationToken</code> received using the static <code>CancellationToken.None</code> property or created by the default constructor or constructor with the parameter set to <code>false</code> . <br><br>  And finally, fourthly, in order for the task to be performed, which was created ‚Äúmanually‚Äù (not by the async method), correctly canceled (so that the <code>Task.IsCanceled</code> property returns <code>true</code> ), the following is necessary: <br><ul><li>  The asynchronous operation code must throw an <code>OperationCanceledException</code> exception, to the constructor of which the <code>CancellationToken</code> must be passed. </li><li>  The same <code>CancellationToken</code> must be passed to the method that creates and runs the task. </li><li>  The <code>IsCancellationRequested</code> property of a <code>CancellationToken</code> should return <code>true</code> . </li></ul><br>  Consider examples: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-comment"><span class="hljs-comment">//... Task.Run(() =&gt; { //... if (cancellationToken.IsCancellationRequested) throw new OperationCanceledException(); //   CancellationToken //... }, cancellationToken);</span></span></code> </pre><br>  Here the <code>CancellationToken</code> not passed to the <code>OperationCanceledException</code> constructor.  That is why it is preferable to use the <code>CancellationToken.ThrowIfCancelationRequested</code> method and not to generate an <code>OperationCanceledException</code> manually. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-comment"><span class="hljs-comment">//... Task.Run(() =&gt; { //... cancellationToken.ThrowIfCancellationRequested(); //... }/*   CancellationToken */);</span></span></code> </pre><br>  In this example, when creating a task, the <code>Task.Run</code> not passed to the <code>Task.Run</code> method. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken2 = cts2.Token; <span class="hljs-comment"><span class="hljs-comment">//... var task = Task.Run(() =&gt; { //... cancellationToken2.ThrowIfCancellationRequested(); // ¬´¬ª CancellationToken //... }, cancellationToken);</span></span></code> </pre><br>  Here, to create a task and to cancel, <code>CancellationToken</code> are used, obtained from various <code>CancellationTokenSource</code> 's. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-comment"><span class="hljs-comment">//... var task = Task.Run(() =&gt; { //... if (!cancellationToken.IsCancellationRequested) //    throw new OperationCanceledException(cancellationToken); //... }, cancellationToken);</span></span></code> </pre><br>  An <code>OperationCanceledException</code> generated here, although no cancellation was requested. <br><br>  In all examples, an <code>OperationCanceledException</code> exception will be treated inside the TPL not as a cancel signal, but as a normal exception.  As a result, the task will not end with the cancellation, but with an error ( <code>Task.IsCancelled == false</code> , <code>Task.IsFaulted == true</code> ). <br><br><h4>  Cancellation and continuation tasks </h4><br>  TPL allows you to chain tasks using the overloaded <code>Task.ContinueWith</code> method.  The task created by the <code>Task.ContinueWith</code> method is called the continuation task, and the task for which the method was called is the predecessor task.  The continuation task waits for the completion of the predecessor task, and then it executes <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> antecedentTask = Task.Run(() =&gt; Console.Write(<span class="hljs-string"><span class="hljs-string">"Hello, "</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> continuationTask = antecedentTask.ContinueWith(_ =&gt; Console.Write(<span class="hljs-string"><span class="hljs-string">"world!"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//    `Hello, world!`</span></span></code> </pre><br>  Continuation tasks fully support cancellation and everything that was written above applies to them.  The <code>Task.ContinueWith</code> method has overloads that allow you to associate with the created task <code>CancellationToken</code> . <br><br>  If the cancellation request comes when the continuation task has not yet started to be executed, it will not be executed.  In this case, by default, the continuation task will be canceled immediately and may be completed earlier than the predecessor task: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> antecedentTask = Task.Run(() =&gt; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> continuationTask = antecedentTask.ContinueWith( _ =&gt; {}, cancellationToken); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); cts.Cancel(); Console.WriteLine(antecedentTask.IsCompleted); <span class="hljs-comment"><span class="hljs-comment">// False Console.WriteLine(continuationTask.IsCompleted); // True</span></span></code> </pre><br>  But you can change this behavior if you create a continuation task using the <code>TaskContinuationOptions.LazyCancellation</code> flag <code>TaskContinuationOptions.LazyCancellation</code> specify that a lazy cancellation is required.  In this case, the continuation task will not be canceled (and will not end) until the predecessor task is completed: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cancellationToken = cts.Token; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> antecedentTask = Task.Run(() =&gt; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">5000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> continuationTask = antecedentTask.ContinueWith( _ =&gt; {}, cancellationToken, TaskContinuationOptions.LazyCancellation, TaskScheduler.Default); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); cts.Cancel(); Console.WriteLine(antecedentTask.IsCompleted); <span class="hljs-comment"><span class="hljs-comment">// False Console.WriteLine(continuationTask.IsCompleted); // False</span></span></code> </pre><br>  Of particular interest is the case when the continuation task can become canceled without using <code>CancellationToken</code> .  In <code>TaskContinuationOptions</code> there are a number of flags that allow you to specify in which cases the continuation task should be launched.  For example, for the predecessor task, you can create two continuation tasks ‚Äî one for the case when the predecessor task completes normally, the second for the case when an error / cancellation occurs in the predecessor task.  After the completion of the predecessor task, only one of the continuation tasks will start, and the second will be canceled: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> antecedentTask = Task.Run(() =&gt; {}); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> continuationTask1 = antecedentTask.ContinueWith( _ =&gt; {}, TaskContinuationOptions.OnlyOnRanToCompletion); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> continuationTask2 = antecedentTask.ContinueWith( _ =&gt; {}, TaskContinuationOptions.NotOnRanToCompletion); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Task.WaitAll(continuationTask1, continuationTask2); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>{} Console.WriteLine(continuationTask1.IsCanceled); <span class="hljs-comment"><span class="hljs-comment">// False Console.WriteLine(continuationTask2.IsCanceled); // True</span></span></code> </pre><br><h4>  Cancel and async methods </h4><br>  In C # 5.0, <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh156513.aspx">async methods appeared</a> .  From the point of view of cancellation, async methods are interesting in that only <code>void</code> and <code>Task</code> / <code><code>Task.   ,  async-   (Task / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code></code> types can be used as return values <code><code>Task.   ,  async-   (Task / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code></code> <code><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <ul><li> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </li> <li> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </li> </ul> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <h4> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </h4> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre> <code><code><code><code><code>Task.   ,  async-   (Task</code> / <code class="cs">Task),    ,   . ,   <br> Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5)) .ContinueWith(_ =&gt; { while (true) { // -  } return 42; });</code> <br>      async-  : <br> <code class="cs">Task&lt;int&gt; task = SomeWork(); async Task&lt;int&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(5)); while (true) { // -  } return 42; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code>int</code> .    ,    <code>SomeWork</code>  <code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = Task .Delay(TimeSpan.FromSeconds(5), cancellationToken) .ContinueWith(_ =&gt; { while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = new CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;int&gt; task = SomeWork(cancellationToken); async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); /* 1 */ await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); /* 2 */ while (true) { // -  cancellationToken.ThrowIfCancellationRequested(); } return 42; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       1  2. ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;int&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw new OperationCanceledException(cancellationToken); throw new OperationCanceledException(); throw new OperationCanceledException(CancellationToken.None); throw new OperationCanceledException(new CancellationToken(true)); throw new OperationCanceledException(new CancellationToken(false)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code>true</code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == true</code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == true</code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; 42); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.Exception), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e is TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { /* -  */ }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (Exception e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> <pre> <code class="hljs pgsql"><code>Task.   ,  async-   (Task</code> / <code><code class="cs">Task),    ,   . ,   <br> Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; });</code> <br>      async-  : <br> <code class="cs">Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork() { await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br>  ,     <code>Task.Run</code> ,  <code>Task.Factory.StartNew</code> ,  .  <code>SomeWork</code>    <code><span class="hljs-type"><span class="hljs-type">int</span></span></code> .    ,    <code>SomeWork</code>  <code><code class="cs">Task. <br> <br> ,  async-,   ,  ,   .       ,    : <br> var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken) .ContinueWith(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }, cancellationToken);</code> <br>  <br> <code class="cs">var cts = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationTokenSource(); var cancellationToken = cts.Token; Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; task = SomeWork(cancellationToken); async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 1 */</span></span> await Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">5</span></span>), cancellationToken); cancellationToken.ThrowIfCancellationRequested(); <span class="hljs-comment"><span class="hljs-comment">/* 2 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { // -  cancellationToken.ThrowIfCancellationRequested(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> <br> ,   async-,  ,       <code>CancellationToken</code> ( <code>CancellationToken</code>  async-      <code>CancellationToken</code>   ).      : <br>        async-,  async-    .       (,  <code>Task.Run</code>  <code>Task.ContinueWith</code> )   .       <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">2.</span></span> ,   async-,    . <code>OperationCanceledException</code>   .   <code>CancellationToken</code> ,         , ..     .  ,        ,   <code>CancellationToken</code>      . ,      <code>Task.Run</code> ,       : <br> <code class="cs">static async Task&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; SomeWork(CancellationToken cancellationToken) { cancellationToken.ThrowIfCancellationRequested(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(cancellationToken); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(CancellationToken.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> OperationCanceledException(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CancellationToken(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); }</code> <br>    <br>     <code>Task.IsCompleted</code>    <code><span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> .     ( <code>Task.Status == TaskStatus.RanToCompletion</code> ),   ( <code>Task.Status == TaskStatus.Faulted</code> ; <code>Task.IsFaulted == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> )    ( <code>Task.Status == TaskStatus.Canceled</code> ; <code>Task.IsCanceled == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> ).             . <br> <br>       -.      <code>TaskContinuationOptions</code>   -     -: <br> <code class="cs">var task = Task.Run(() =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>); task.ContinueWith( t =&gt; Console.WriteLine("Result: {0}", t.Result), TaskContinuationOptions.OnlyOnRanToCompletion); task.ContinueWith( _ =&gt; Console.WriteLine("Canceled"), TaskContinuationOptions.OnlyOnCanceled); task.ContinueWith( t =&gt; Console.WriteLine("Error: {0}", t.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>), TaskContinuationOptions.OnlyOnFaulted);</code> <br>            <code>Task.Wait</code>     <code><code>Task.Result.      c   ,   .    . -,          ‚Äî AggregateException</code> . <code>AggregateException</code>       ,     (  <code>AggregateException</code>   <a href="http://msdn.microsoft.com/en-us/magazine/ee321571.aspx"></a> ). -,  ,   , <code>AggregateException</code>      <code>TaskCanceledException</code> ,   <code>OperationCanceledException</code> ,   : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { task.Wait(); Console.WriteLine("Success"); } catch (AggregateException ae) { try { ae.Flatten().Handle(e =&gt; e <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TaskCanceledException); Console.WriteLine("Cancelled"); } catch (AggregateException e) { Console.WriteLine("Error: {0}", e); } }</code> <br>   async-           <code>await</code> .       <code>AggregateException</code> ,       <code>OperationCanceledException</code> ;     : <br> <code class="cs">var task = Task.Run(() =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* -  */</span></span> }); try { await task; Console.WriteLine("Success"); } catch (OperationCanceledException) { Console.WriteLine("Cancelled"); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> e) { Console.WriteLine("Error: {0}", e); }</code></code></code></code></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/168669/">https://habr.com/ru/post/168669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168655/index.html">The release of RubyMine 5</a></li>
<li><a href="../168657/index.html">Pixel lights fast and easy</a></li>
<li><a href="../168661/index.html">Yahoo! will show ads google</a></li>
<li><a href="../168665/index.html">Open source software in operational printing</a></li>
<li><a href="../168667/index.html">Briefly about hydrodynamics: do you remember how it all began?</a></li>
<li><a href="../168671/index.html">Qt5 build in Visual Studio 2012 or I can sew a kangaroo eye while my favorite ketchup flows</a></li>
<li><a href="../168673/index.html">Creating Warcraft (part 3)</a></li>
<li><a href="../168675/index.html">Similarities and differences between Mercurial and Git</a></li>
<li><a href="../168677/index.html">PowerShell. Decrypt files after exposure to "virus"</a></li>
<li><a href="../168681/index.html">Interactive infographics with CSS and SVG animations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>