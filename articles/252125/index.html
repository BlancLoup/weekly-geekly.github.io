<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ensuring quality code in large-scale projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I came to Airbnb in the fall of 2012, there was, to put it mildly, there was some confusion and vacillation. Some time ago, the company began to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ensuring quality code in large-scale projects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6b2/c71/a0b/6b2c71a0bc4443c8be959b6fbed01721.jpg"><br><br>  When I came to Airbnb in the fall of 2012, there was, to put it mildly, there was some confusion and vacillation.  Some time ago, the company began to grow and develop at a tremendous pace.  In the first place, this was expressed in traffic and transaction volumes.  To cope with all this, very quickly increased the staff of developers.  A year before my arrival, there were 16 people in the group, I had about 40, and now over 130. And one of the main problems caused by all these processes was the preservation of the quality of the code in a rapidly increasing and complicated project. <br><a name="habracut"></a><br>  Looking back, it seems to me that this was a turning point in the history of our company.  Explosive development has led to a number of technical and cultural challenges for Airbnb, which for the most part overlapped with each other.  We had to solve many difficult problems before, but in general they were connected with: <br><br>  ‚Ä¢ scaling whole applications on Ruby on Rails, which were created without any calculation for subsequent scalability, <br>  ‚Ä¢ and an increase in the development team to solve the previous problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is now clear that we have managed to cope with numerous problems of growth.  And here I would like to talk about how we proceeded to writing a more maintainable, more technological code.  And, as a result, much more suitable for scaling. <br><br>  Now I work in a group that develops a module for <a href="https://www.airbnb.ru/jobs/departments/position/11422">processing payments</a> .  Therefore, for us, the quality of the code, its stability and maintainability are of critical importance.  Given the volume of transactions, even small errors are unacceptable.  Over the past year, we have done a great job in developing rules and techniques that allow us to write code quickly and at the same time qualitatively.  First of all, we are talking about establishing and observing specific styles and conditions when coding, regular verification of code by colleagues (peer review) and testing. <br><br><h4>  Code consistency </h4><br>  The consistency of the code depends on the syntactic style and compliance with the agreements and techniques when writing.  You have read and heard about it many times, but I‚Äôll repeat it: if you can open a file from your code base and determine by style which of your colleagues wrote it, then this is a <a href="https://github.com/airbnb/javascript/issues/102">very bad sign</a> .  The development of internal coding standards and their observance by all team members had an extremely positive effect on our work. <br><br>  In a general sense, computer code is consumed by two classes of entities: machines and people.  The machines don't care what the code looks like, as long as it compiles without problems.  But developers are not all the same.  If your team uses different styles and approaches to writing and solving problems in the code base, this leads to an excessive cognitive load on all participants, and a long understanding of the code that is not created by you.  If all members of a group write code in a more or less similar manner, debugging is greatly simplified, it becomes much easier to maintain someone else's code.  I do not mean that you have to make a choice in favor of some decisions for the sake of readability or simplicity of the code, but there are enough ways to unify the coding process by all team members. <br><br>  In Airbnb, we improved the consistency of the code for two years.  We first developed a style guide (there were several versions of this guide).  The most detailed tutorials on <a href="https://github.com/airbnb/javascript">JavaScript</a> and <a href="https://github.com/airbnb/ruby">Ruby</a> , also available on <a href="http://en.wikipedia.org/wiki/RSpec">RSpec</a> , API design, service design, etc.  Despite the fact that these guidelines are based on our specific requirements and conditions, many of them are now used by other teams as well as individual developers.  Of course, the potential benefits of these guides depend on the type of application you are working on, but if you are developing in JavaScript or Ruby, I recommend that you familiarize yourself with them anyway.  At least for inspiration. <br><br>  Some rules are accepted by us exclusively arbitrarily.  For example, by indentation (tab and space), or on which line to place the opening brace.  These and other moments - a matter of taste.  It is important that the rules are respected by all involved.  On the other hand, in some cases, options are possible. <br><br>  Take the length of the string.  We prefer to make lines short and descriptive.  Short strings are not only more readable, but also allow you to define statements in a simpler form (especially when they are used with descriptive variable names).  Methods consisting of a series of short simple operators are easier to comprehend and modify.  Even <a href="https://ru.wikipedia.org/wiki/Diff">diffs</a> as a result more accurately show what has changed between commits.  And since we are writing a testable code containing small, concise methods, this encourages the creation of a very ‚Äúclean‚Äù, modular, and easy to understand code base. <br><br>  Consider an example: <br><br><pre><code class="ruby hljs">usernames = Users.where(<span class="hljs-symbol"><span class="hljs-symbol">:status</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:deleted</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>).map{ <span class="hljs-params"><span class="hljs-params">|u|</span></span> u.first_name.downcase }.reject{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n == <span class="hljs-string"><span class="hljs-string">'john'</span></span> }.map{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n.titleize }</code> </pre> <br><br>  Suppose we need to change the register.  Diff will show something like this: <br><br><pre> <code class="ruby hljs">- usernames = Users.where(<span class="hljs-symbol"><span class="hljs-symbol">:status</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:deleted</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>).map{ <span class="hljs-params"><span class="hljs-params">|u|</span></span> u.first_name.downcase }.reject{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n == <span class="hljs-string"><span class="hljs-string">'john'</span></span> }.map{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n.titleize } + usernames = Users.where(<span class="hljs-symbol"><span class="hljs-symbol">:status</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:deleted</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>).map{ <span class="hljs-params"><span class="hljs-params">|u|</span></span> u.first_name.upcase }.reject{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n == <span class="hljs-string"><span class="hljs-string">'JOHN'</span></span> }.map{ <span class="hljs-params"><span class="hljs-params">|n|</span></span> n.titleize }</code> </pre> <br><br>  It is difficult to say without thinking what exactly has changed, without parsing the string in my head.  And if the code was originally written like this: <br><br><pre> <code class="ruby hljs">users = Users.where(<span class="hljs-symbol"><span class="hljs-symbol">:status</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:deleted</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>) usernames = users. map{ <span class="hljs-params"><span class="hljs-params">|user|</span></span> user.first_name.downcase }. reject{ <span class="hljs-params"><span class="hljs-params">|name|</span></span> name == <span class="hljs-string"><span class="hljs-string">'john'</span></span> }. map{ <span class="hljs-params"><span class="hljs-params">|name|</span></span> name.titleize }</code> </pre><br><br>  That difference in differential would be much clearer: <br><br><pre> <code class="ruby hljs">users = Users.where(<span class="hljs-symbol"><span class="hljs-symbol">:status</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:deleted</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>) usernames = users. - map{ <span class="hljs-params"><span class="hljs-params">|user|</span></span> user.first_name.downcase }. - reject{ <span class="hljs-params"><span class="hljs-params">|name|</span></span> name == <span class="hljs-string"><span class="hljs-string">'john'</span></span> }. + map{ <span class="hljs-params"><span class="hljs-params">|user|</span></span> user.first_name.upcase }. + reject{ <span class="hljs-params"><span class="hljs-params">|name|</span></span> name == <span class="hljs-string"><span class="hljs-string">'JOHN'</span></span> }. map{ <span class="hljs-params"><span class="hljs-params">|name|</span></span> name.titleize }</code> </pre><br><br>  It's funny, but initially those of us who promote such an approach, at first faced with the resistance of colleagues.  I had to show perseverance, and as a result it became a habit for all of us - to make short lines.  Very extreme examples on this topic can be seen in the manuals of <a href="http://www.stroustrup.com/JSF-AV-rules.pdf">Joint Strike Fighter C ++</a> and <a href="http://lars-lab.jpl.nasa.gov/JPL_Coding_Standard_C.pdf">JPL C Coding</a> .  Obviously, these standards are redundant for most consumer web applications, so always correlate the project level and goals that you want to achieve by adhering to certain rules.  It is important to keep a balance. <br><br>  As I mentioned, we also created guides for developing APIs and services.  Despite the fact that it is not always possible to prescribe such things in advance, the consolidation of the team‚Äôs common knowledge into a single document has been invaluable. <br><br><h4>  Code verification by colleagues </h4><br>  Regular audit of the code of their colleagues has become the second cornerstone of increasing code consistency.  The most important advantage of this process is that it allows you to quickly and effectively detect all sorts of bugs before they get into the next release.  But there is a cross-audit and many other small positive points.  Over the past year we have been auditing for every change made to the code. <br><br>  We try to involve in the audit everyone who is somehow involved in this part of the code or functionality.  As a result, for the most non-trivial pull request, at least one or two independent discussions arise.  Sometimes the parsing process goes so far that some have to learn things previously unknown to themselves (for example, credit card processing, internal database organization, cryptography, etc.).  If the change in the code involves a big important issue, then we create the appropriate recommendations and documentation.  I want to emphasize that when reviewing, we are not allowed to appeal to our status or position.  The contribution of any member of the team is appreciated, and the best solutions are rolled out.  All this is a good school for beginners, by the way. <br><br>  It is important to remember that the mere existence of recommendations does not mean that they will be followed (or at least read), or that they are suitable for all occasions.  But reviewing is not only very effective from the point of view of mutual aid, but is also an excellent way to learn or teach someone the art of programming, which is difficult to do with ordinary textbooks.  And when people learn a lot at work, it contributes to their involvement and improves the quality of work. <br><br>  Here is an example of a situation where the main role is not played by the coding style, but by a wise approach: <br><br><pre> <code class="ruby hljs">rus_users = User.active.select{ <span class="hljs-params"><span class="hljs-params">|u|</span></span> <span class="hljs-string"><span class="hljs-string">'RUS'</span></span> == u.country } puts ‚ÄúThere are <span class="hljs-comment"><span class="hljs-comment">#{rus_users.length} RUS users today‚Äù</span></span></code> </pre> <br><br>  and <br><br><pre> <code class="ruby hljs">rus_users = User.active.where(<span class="hljs-symbol"><span class="hljs-symbol">:country</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'RUS'</span></span>) puts ‚ÄúThere are <span class="hljs-comment"><span class="hljs-comment">#{rus_users.count} RUS users today‚Äù</span></span></code> </pre> <br><br>  The first option is more resource-intensive, and with large amounts of data can lead to a catastrophic drop in performance.  Adding a <code>select</code> to the <code>User.active</code> object means that Rails will access MySQL, invoke and instantiate all active users, put them into an array, iterates it and selects users whose country corresponds to RUS.  And all this only to count them. <br><br>  In the second example, we also start with the <code>User.active</code> object, but then apply the where filter.  The first line does not initiate any queries to the database.  When in the second line, when we request a counter, Rails just makes a <code>SELECT COUNT(*)</code> query and does not bother calling strings or instantiating models. <br><br>  Here is another example: <br><br>  badly: <br><br><pre> <code class="ruby hljs">amount = Payout. where(<span class="hljs-symbol"><span class="hljs-symbol">:successful</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>). where(<span class="hljs-string"><span class="hljs-string">'DATE(timestamp) = ?'</span></span>, Date.today). inject(<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-params"><span class="hljs-params">|sum, p|</span></span> sum += p.amount }</code> </pre> <br><br>  OK: <br><br><pre> <code class="ruby hljs">amount = Payout. where(<span class="hljs-symbol"><span class="hljs-symbol">:successful</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>). where(<span class="hljs-string"><span class="hljs-string">'DATE(timestamp) = ?'</span></span>, Date.today). sum(<span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span>)</code> </pre> <br><br>  In the first example, we limit the search to one day, but even in this case, you need to call and instantiate a large number of objects just to summarize over one field.  In the second example, MySQL deals with the summation during the search, which then simply returns the value we need.  In general, this does not create additional burden on MySQL, we do not generate unnecessary network traffic and avoid potentially huge computations in Ruby. <br><br>  The above examples demonstrate how we improve the responsiveness of our site and even prevent it from falling.  Peer review is also good because by discussing a specific part of the code, employees periodically raise a variety of topics, such as database structure or generating financial reports.  That is, lively and productive dialogues constantly arise around the code, during which we study and teach others. <br><br><h4>  Testing </h4><br>  I will not go into this question, this is very well written in <a href="http://nerds.airbnb.com/testing-at-airbnb/">one of</a> our blog <a href="http://nerds.airbnb.com/testing-at-airbnb/">posts</a> .  I can only say (and it is unlikely to be something new for you) that testing is an incredibly important process in terms of providing high quality, maintainable code.  However, the point is not the maximum coverage of the code with tests, the main thing is to create a testing culture so that it becomes a conditioned reflex for each member of the team.  When writing tests is a habit, then creating testable code also becomes a habit. <br><br><h4>  Conclusion </h4><br>  To summarize what was said. <br><br>  All members of a professional development team, no matter what size it is, must write code in the same, pre-approved style.  This helps to widely use successful approaches and techniques, facilitates maintenance and maintenance of code by other people.  The best start is to create coding style guides.  Even deceptively simple and obvious things can greatly affect the quality of the code, its stability and the simplicity of refactoring. <br><br>  It is necessary to actively and constructively review each other‚Äôs code.  At least one person, besides the author, must look through all the diffs.  The benevolent submission of proposals and their verification of the code is a prerequisite for team building and growth of the professional level.  This helps beginners to learn faster and more fully, to acquire useful skills and habits.  In the end, it can save your application from a serious fall. <br><br>  It is important to develop a strong testing culture, not to compromise on this or ‚Äúcut the road‚Äù.  The more we test, the more it turns into a habit.  As a result, you can even love this process. </div><p>Source: <a href="https://habr.com/ru/post/252125/">https://habr.com/ru/post/252125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252115/index.html">How we provided communication at the largest airports</a></li>
<li><a href="../252117/index.html">RSConf: Review and video frontend conference in Minsk</a></li>
<li><a href="../252119/index.html">Upload a user's photo in Active Directory using PowerShell</a></li>
<li><a href="../252121/index.html">Epson at the exhibition of applications and modern technologies MATE 2015</a></li>
<li><a href="../252123/index.html">Creating a creative portfolio. From idea to release</a></li>
<li><a href="../252127/index.html">Let's Lab. IS-IS routing protocol. Part 1</a></li>
<li><a href="../252129/index.html">Mongodb 3.0 Production Release released</a></li>
<li><a href="../252131/index.html">Conference Program DUMP-2015</a></li>
<li><a href="../252133/index.html">Expanding the base of MegaIndex sites by 47 million pieces</a></li>
<li><a href="../252137/index.html">A simple Bluetooth machine on the Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>