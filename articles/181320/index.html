<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We increase the security of closed ssh-keys</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Have you ever been interested in the mechanism of ssh-keys? Or how safe they are? 

 I use ssh every day many times - when I run git fetch or git push...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We increase the security of closed ssh-keys</h1><div class="post__text post__text-html js-mediator-article"> Have you ever been interested in the mechanism of ssh-keys?  Or how safe they are? <br><br>  I use ssh every day many times - when I run <b><code>git fetch</code></b> or <b><code>git push</code></b> , when I deploy code or log in to the server.  Not so long ago, I realized that for me ssh became the magic that I used to use without understanding the principles of its work.  I didn‚Äôt like it a lot - I love to understand the tools I use.  Therefore, I did a little research and share with you the results. <br><br>  In the course of the presentation will meet many abbreviations.  They do not help to understand the ideas, but will be useful if you decide to google the details. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, if you had to resort to key authentication, then you most likely have a file <b><code>~/.ssh/id_rsa</code></b> or <b><code>~/.ssh/id_dsa</code></b> in your home directory.  This is a private (aka private) RSA / DSA key, and <b><code>~/.ssh/id_rsa.pub</code></b> or <b><code>~/.ssh/id_dsa.pub</code></b> is an open (or public) key.  On the server on which you want to log in, there should be a copy of the public key in <b><code>~/.ssh/authorized_keys</code></b> .  When you try to log in, the ssh client confirms that you have a private key using a digital signature;  the server verifies that the signature is valid and there is a public key in <b><code>~/.ssh/authorized_keys</code></b> , and you are gaining access. <br><br>  What is stored inside the private key? <br><br><a name="habracut"></a><h2>  Unencrypted private key format </h2><br>  It is recommended to protect the private key with a password (passphrase), otherwise an attacker who managed to steal the private key from you will be able to log in to your server without any problems.  First, take a look at the unencrypted file format, and deal with the encrypted file later. <br><br>  The unencrypted key looks like this: <br><br><pre> <code class="hljs delphi">-----<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> RSA <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY----- MIIEogIBAAKCAQEArCQG213utzqE5YVjTVF5exGRCkE9OuM7LCp/FOuPdoHrFUXk y2MQcwf29J3A4i8zxpES9RdSEU6iIEsow98wIi0x1/Lnfx6jG5Y0/iQsG1NRlNCC aydGvGaC+PwwWiwYRc7PtBgV4KOAVXMZdMB5nFRaekQ1ksdH/<span class="hljs-number"><span class="hljs-number">360</span></span>KCGgljPtzTNl <span class="hljs-number"><span class="hljs-number">09</span></span>e97QBwHFIZ3ea5Eih/HireTrRSnvF+ywmwuxX4ubDr0ZeSceuF2S5WLXH2+TV0 ...    ... -----<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> RSA <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY-----</code> </pre><br>  The private key contains data in the <a href="http://ru.wikipedia.org/wiki/ASN.1">ASN.1</a> format, represented as a sequence of bytes according to the <a href="http://ru.wikipedia.org/wiki/X.690">X.690</a> standard and encoded in Base64.  Roughly speaking, ASN.1 can be compared to JSON (it supports various data types, such as INTEGER, BOOLEAN, strings and sequences that can form a tree structure).  ASN.1 is widely used in cryptography, although it is slightly out of fashion with the advent of the web (I don‚Äôt know why - it looks like quite a decent format ( <i>you can argue with that</i> ) <i>.</i> ) <br><br>  Generate a test RSA key without a password using <b><code>ssh-keygen</code></b> and decode it with <a href="http://www.openssl.org/docs/apps/asn1parse.html"><b><code>asn1parse</code></b></a> (or use an <a href="http://lapo.it/asn1js/">ASN.1 decoder</a> written in JavaScript): <br><br><pre> <code class="hljs ruby">$ ssh-keygen -t rsa -N <span class="hljs-string"><span class="hljs-string">''</span></span> -f test_rsa_key $ openssl asn1parse -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_rsa_key <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">0</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l=<span class="hljs-number"><span class="hljs-number">1189</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l= <span class="hljs-number"><span class="hljs-number">257</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:C36EB2429D429C7768AD9D879F98C</span></span>... <span class="hljs-number"><span class="hljs-number">268</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">010001</span></span> <span class="hljs-number"><span class="hljs-number">273</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l= <span class="hljs-number"><span class="hljs-number">257</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:A27759F60AEA1F4D1D56878901E27</span></span>... <span class="hljs-number"><span class="hljs-number">534</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:F9D23EF31A387694F03AD0D050265</span></span>... <span class="hljs-number"><span class="hljs-number">666</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:C84415C26A468934F1037F99B6D14</span></span>... <span class="hljs-number"><span class="hljs-number">798</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:D0ACED4635B5CA5FB896F88BB9177</span></span>... <span class="hljs-number"><span class="hljs-number">930</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">128</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">511810</span></span>DF9AFD590E11126397310A6... <span class="hljs-number"><span class="hljs-number">1061</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:E3A296AE14E7CAF32F7E493FDF474</span></span>...</code> </pre><br>  The data structure in ASN.1 is fairly simple: it is a sequence of nine integers.  Their purpose is defined in <a href="http://tools.ietf.org/html/rfc2313">RFC2313</a> .  The first and third numbers are the version number (0) and the open exponent <i>e</i> .  The second and fourth numbers (2048 bits long) are the modulus <i>n</i> and the secret exponent <i>d</i> .  These numbers are <a href="http://ru.wikipedia.org/wiki/RSA">RSA</a> key parameters.  The remaining five can be obtained, knowing <i>n</i> and <i>d</i> - they are cached in the file to speed up some operations. <br><br>  The structure of DSA-keys is similar and includes six numbers: <br><br><pre> <code class="hljs ruby">$ ssh-keygen -t dsa -N <span class="hljs-string"><span class="hljs-string">''</span></span> -f test_dsa_key $ openssl asn1parse -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_dsa_key <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">0</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l= <span class="hljs-number"><span class="hljs-number">444</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:E497DFBFB5610906D18BCFB4C3CCD</span></span>... <span class="hljs-number"><span class="hljs-number">139</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:CF2478A96A941FB440C38A86F22CF</span></span>... <span class="hljs-number"><span class="hljs-number">162</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">129</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">83218</span></span>C0CA49BA8F11BE40EE1A7C72... <span class="hljs-number"><span class="hljs-number">294</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">3</span></span> l= <span class="hljs-number"><span class="hljs-number">128</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">16953</span></span>EA4012988E914B466B9C37CB... <span class="hljs-number"><span class="hljs-number">425</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">89</span></span>A356E922688EDEB1D388258C825...</code> </pre><br><h2>  Password protected private key format </h2><br>  Now let's make life difficult for a potential intruder who could steal a private key - protect it with a password.  What happened to the file? <br><br><pre> <code class="hljs delphi">$ ssh-keygen -t rsa -N <span class="hljs-string"><span class="hljs-string">'super secret passphrase'</span></span> -f test_rsa_key $ cat test_rsa_key -----<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> RSA <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY----- Proc-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>,ENCRYPTED DEK-Info: AES-<span class="hljs-number"><span class="hljs-number">128</span></span>-CBC,D54228DB5838E32589695E83A22595C7 <span class="hljs-number"><span class="hljs-number">3</span></span>+Mz0A4wqbMuyzrvBIHx1HNc2ZUZU2cPPRagDc3M+rv+XnGJ6PpThbOeMawz4Cbu lQX/Ahbx+UadJZOFrTx8aEWyZoI0ltBh9O5+ODov+vc25Hia3jtayE51McVWwSXg wYeg2L6U7iZBk78yg+sIKFVijxiWnpA7W2dj2B9QV0X3ILQPxbU/cRAVTd7AVrKT ...    ... -----<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> RSA <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY-----</code> </pre><br>  Note that two strings have been added with headers, and the result of decoding the Base64 strings is no longer valid ASN.1.  The fact is that the structure of ASN.1.  encrypted.  From the headers we find out which algorithm was used for encryption: <a href="http://ru.wikipedia.org/wiki/Advanced_Encryption_Standard">AES-128</a> in CBC mode.  The 128-bit hexadecimal string in the <b><code>DEK-Info</code></b> header is the initialization vector (IV).  There is nothing unusual here; all common cryptographic libraries can work with the algorithms used here. <br><br>  But how does the AES key come from the password?  I did not find this in the documentation and therefore I was forced to understand the source code of OpenSSL.  Here is what I found out about getting the encryption key: <br><br><ol><li>  The first 8 bytes of the initialization vector are added to the password (in fact, they are salt). </li><li>  From the received string, the MD5 hash is taken once. </li></ol><br>  To verify, decrypt the private key by taking the initialization vector from the <b><code>DEK-Info</code></b> header: <br><br><pre> <code class="hljs ruby">$ tail -n +<span class="hljs-number"><span class="hljs-number">4</span></span> test_rsa_key <span class="hljs-params"><span class="hljs-params">| grep -v '</span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">END</span></span></span><span class="hljs-params"> ' |</span></span> base64 -d <span class="hljs-params"><span class="hljs-params">| openssl aes-128-cbc -d -iv D54228DB5838E32589695E83A22595C7 -K $( ruby -rdigest/md5 -e 'puts Digest::MD5.hexdigest(["</span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span><span class="hljs-params"> secret passphrase",0xD5,0x42,0x28,0xDB,0x58,0x38,0xE3,0x25].pack("a*cccccccc"))' ) |</span></span> openssl asn1parse -inform DER</code> </pre><br>  This command will output the RSA key parameters.  If you just want to see the key, there is a simpler way: <br><br><pre> <code class="hljs pgsql">$ openssl rsa -<span class="hljs-type"><span class="hljs-type">text</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_rsa_key -passin <span class="hljs-string"><span class="hljs-string">'pass:super secret passphrase'</span></span></code> </pre><br>  But I wanted to show exactly how the AES key is obtained from the password in order to pay attention to two vulnerabilities: <br><br><ol><li>  Using MD5 is written in the code, which means that without changing the format, it is impossible to switch to another hash function (for example, SHA-1).  If it turns out that MD5 is not safe enough, there will be problems.  ( <i>Actually, no, see <a href="http://habrahabr.ru/post/181320/">comments</a> - approx. Lane.</i> ) </li><li>  The hash function is applied only once.  Since MD5 and AES are quickly calculated, it is easy to select a short password by searching. </li></ol><br>  If the ssh-key falls into unkind hands, for example, someone steals your laptop or hard drive with backups, the attacker will be able to sort through a large number of passwords, even with a small computing power.  If you set a vocabulary password, you can pick it up in seconds. <br><br>  This is bad news: password protection is not as good as you might expect.  But there is good news: you can switch to a more reliable private key format. <br><br><h2>  Enhance Key Protection with PKCS # 8 </h2><br>  So, we need an algorithm for obtaining a symmetric encryption key from a password that would work slowly so that the attacker took more computational time to find the password. <br><br>  For ssh-keys, there are several standards with awkward names: <br><br><ul><li>  In <a href="http://tools.ietf.org/html/rfc2898">PKCS # 5 (RFC 2898)</a> , the <a href="http://ru.wikipedia.org/wiki/PBKDF2">PBKDF2</a> (Password-Based Key Derivation Function 2) algorithm is defined to derive an encryption key from a password by repeatedly using a hash function.  The PBES2 encryption scheme (Password-Based Encryption Scheme 2) is also defined there, which includes the use of a key generated by PBKDF2 and a symmetric cipher. </li><li>  <a href="http://tools.ietf.org/html/rfc5208">PKCS # 8 (RFC 5208)</a> defines the storage format for encrypted private keys with PBKDF2 support.  OpenSSL supports private keys in the PKCS # 8 format, and OpenSSH uses OpenSSL, so if you use OpenSSH, you can switch from the traditional ssh key file format to the PKCS # 8 format. </li></ul><br>  I do not know why <b><code>ssh-keygen</code></b> still generates keys in the traditional format, despite the fact that for many years there are better alternatives.  It's not about compatibility with server software: private keys never leave your computer.  Fortunately, the existing keys are fairly easy to convert to the PKCS # 8 format: <br><br><pre> <code class="hljs pgsql">$ mv test_rsa_key test_rsa_key.<span class="hljs-built_in"><span class="hljs-built_in">old</span></span> $ openssl pkcs8 -topk8 -v2 des3 \ -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_rsa_key.<span class="hljs-built_in"><span class="hljs-built_in">old</span></span> -passin <span class="hljs-string"><span class="hljs-string">'pass:super secret passphrase'</span></span> \ -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> test_rsa_key -passout <span class="hljs-string"><span class="hljs-string">'pass:super secret passphrase'</span></span></code> </pre><br>  If you try to use a new key file in the PKCS # 8 format, you may find that everything works the same as before.  Let's see what is now inside the file. <br><br><pre> <code class="hljs delphi">$ cat test_rsa_key -----<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> ENCRYPTED <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY----- MIIFDjBABgkqhkiG9w0BBQ0wMzAbBgkqhkiG9w0BBQwwDgQIOu/S2/v547MCAggA MBQGCCqGSIb3DQMHBAh4q+o4ELaHnwSCBMjA+ho9K816gN1h9MAof4stq0akPoO0 CNvXdtqLudIxBq0dNxX0AxvEW6exWxz45bUdLOjQ5miO6Bko0lFoNUrOeOo/Gq4H dMyI7Ot1vL9UvZRqLNj51cj/<span class="hljs-number"><span class="hljs-number">7</span></span>B/bmfa4msfJXeuFs8jMtDz9J19k6uuCLUGlJscP ... - ... -----<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ENCRYPTED <span class="hljs-keyword"><span class="hljs-keyword">PRIVATE</span></span> KEY-----</code> </pre><br>  Notice that the first and last lines have changed ( <b><code>BEGIN ENCRYPTED PRIVATE KEY</code></b> instead of <b><code>BEGIN RSA PRIVATE KEY</code></b> ), and the <b><code>Proc-Type</code></b> and <b><code>DEK-Info</code></b> headings have disappeared.  In fact, the file stores data in the same ASN.1 format: <br><br><pre> <code class="hljs ruby">$ openssl asn1parse -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> test_rsa_key <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">0</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l=<span class="hljs-number"><span class="hljs-number">1294</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OBJECT <span class="hljs-symbol"><span class="hljs-symbol">:PBES2</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">19</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">3</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OBJECT <span class="hljs-symbol"><span class="hljs-symbol">:PBKDF2</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">34</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OCTET STRING [HEX DUMP]<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">3</span></span>AEFD2DBFBF9E3B3 <span class="hljs-number"><span class="hljs-number">44</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> INTEGER <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>080<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">3</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-symbol"><span class="hljs-symbol">cons:</span></span> SEQUENCE <span class="hljs-number"><span class="hljs-number">50</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OBJECT <span class="hljs-symbol"><span class="hljs-symbol">:des-ede3-cbc</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> hl=<span class="hljs-number"><span class="hljs-number">2</span></span> l= <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OCTET STRING [HEX DUMP]<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">78</span></span>ABEA3810B6879F <span class="hljs-number"><span class="hljs-number">70</span></span><span class="hljs-symbol"><span class="hljs-symbol">:d=</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> hl=<span class="hljs-number"><span class="hljs-number">4</span></span> l=<span class="hljs-number"><span class="hljs-number">1224</span></span> <span class="hljs-symbol"><span class="hljs-symbol">prim:</span></span> OCTET STRING [HEX DUMP]<span class="hljs-symbol"><span class="hljs-symbol">:C0FA1A3D2BCD7A80DD61F4C0287F8B2D</span></span>...</code> </pre><br>  Let's use a <a href="http://lapo.it/asn1js/">JavaScript decoder</a> to look at the structure of ASN.1: <br><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) |- <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) | |- Object identifier: <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">840.113549</span></span>.<span class="hljs-number"><span class="hljs-number">1.5</span></span>.<span class="hljs-number"><span class="hljs-number">13</span></span> // using PBES2 from PKCS#<span class="hljs-number"><span class="hljs-number">5</span></span> | `- <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) | |- <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) | | |- Object identifier: <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">840.113549</span></span>.<span class="hljs-number"><span class="hljs-number">1.5</span></span>.<span class="hljs-number"><span class="hljs-number">12</span></span> // using PBKDF2 ‚Äî yay! :) | | `- <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) | | |- Byte <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span> bytes): <span class="hljs-number"><span class="hljs-number">3</span></span>AEFD2DBFBF9E3B3 // salt | | `- <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span>: <span class="hljs-number"><span class="hljs-number">2048</span></span> // iteration count | `- <span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> elements) | Object identifier: <span class="hljs-number"><span class="hljs-number">1.2</span></span>.<span class="hljs-number"><span class="hljs-number">840.113549</span></span>.<span class="hljs-number"><span class="hljs-number">3.7</span></span> // encrypted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Triple DES, CBC | Byte <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span> bytes): <span class="hljs-number"><span class="hljs-number">78</span></span>ABEA3810B6879F // initialization vector `- Byte <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> (<span class="hljs-number"><span class="hljs-number">1224</span></span> bytes): C0FA1A3D2BCD7A80DD61F4C0287F8B2DAB46A43E... // encrypted key blob</code> </pre><br>  OID (Object identifier) ‚Äã‚Äã- globally unique digital identifiers are mentioned here.  From them, we learn that the <a href="">pkcs5PBES2</a> encryption <a href="">scheme</a> , the <a href="">PBKDF2</a> key obtaining function, and the <a href="">des-ede3-cbc</a> encryption algorithm are used.  The hashing function is not explicitly specified, which means that <a href="http://tools.ietf.org/html/rfc3370">the default</a> is <a href="http://tools.ietf.org/html/rfc2104">hMAC-SHA1</a> . <br><br>  Storing the OID in the file is good because the keys can be updated without changing the container format (if, for example, the best encryption algorithm is invented). <br><br>  We also see that in the course of obtaining the encryption key, 2048 iterations are performed.  This is much better than a single use of the hash function when using the traditional format of ssh-keys - brute force will take more time.  At the moment, the number of iterations is written in the OpenSSL code, I hope it can be customized in the future. <br><br><h2>  Conclusion </h2><br>  If you set a complex password to a private key, then converting it from the traditional format to PKCS # 8 can be compared with increasing the length of the password by a couple of characters.  If you use a weak password, PKCS # 8 will make its selection much more difficult. <br><br>  Changing the key format is very simple: <br><br><pre> <code class="hljs ruby">$ mv ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.old $ openssl pkcs8 -topk8 -v2 des3 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.old -out ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa $ chmod <span class="hljs-number"><span class="hljs-number">600</span></span> ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa <span class="hljs-comment"><span class="hljs-comment"># ,    .  ,    $ rm ~/.ssh/id_rsa.old</span></span></code> </pre><br>  The <b><code>openssl pkcs8</code></b> prompts for a password three times: once to unlock an existing key and twice when creating a new key file.  You can come up with a new password or use the old one, it does not matter. <br><br>  Not all software can read the PKCS # 8 format, but there‚Äôs nothing to worry about - only the ssh client needs access to the private ssh-key.  From the server‚Äôs point of view, storing a private key in a different format does not change anything at all. <br><br>  <i>The translator will be happy to hear comments and constructive criticism.</i> </div><p>Source: <a href="https://habr.com/ru/post/181320/">https://habr.com/ru/post/181320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181309/index.html">USB support appeared in KolibriOS</a></li>
<li><a href="../181311/index.html">Data Driven Tests & SpecFlow</a></li>
<li><a href="../181313/index.html">Mailing to VKontakte @ post.vk.com postal addresses lead to breach of confidentiality of personal data</a></li>
<li><a href="../181315/index.html">Abnormal voting on the site ‚ÄúRussian Public Initiative‚Äù (ROI)</a></li>
<li><a href="../181318/index.html">Fujitsu backup and archive solutions</a></li>
<li><a href="../181324/index.html">LG IPS277 - 27 inch home with FullHD</a></li>
<li><a href="../181326/index.html">Return of the "browser for geeks"? A word in defense of Opera Next 15 (philosophical topic)</a></li>
<li><a href="../181328/index.html">Laravel 4 released</a></li>
<li><a href="../181330/index.html">GlacierWorks and Microsoft have created an interactive site on Everest</a></li>
<li><a href="../181332/index.html">How to beat Candy Crush Saga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>