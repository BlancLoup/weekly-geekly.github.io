<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience with WebAssembly or as C ++ undefined behavior shot in the leg</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the last C ++ Russia 2018, we talked about our experience of switching to WebAssembly, how we came across UB and how it heroically stuck, a little ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience with WebAssembly or as C ++ undefined behavior shot in the leg</h1><div class="post__text post__text-html js-mediator-article"><p>  At the last C ++ Russia 2018, we talked about our experience of switching to WebAssembly, how we came across UB and how it heroically stuck, a little about the technology itself and how it works on different devices.  Under the cut there will be a text version of everything relative to UB.  The code for the tests used is available on <a href="https://github.com/iqoption/webassemblycppconf">GitHub</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/hGaZ0gr1bh8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Project outline</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ck/op/4b/ckop4bnoagmg0tct7t4nkie2z9w.jpeg" alt="client code"><br>  Business logic is written in C ++ using our framework.  It itself is written in C ++ with Lua support.  Since there is code that depends on the platform, you have to use JavaScript and DOM. </p><br><p>  For example, for watching videos, on desktop platforms, you use a video player with codecs from Google, and in the browser you use the <a href="http://htmlbook.ru/html/video">video</a> tag </p></div></div><br><p><img src="https://habrastorage.org/webt/ro/n6/kk/ron6kkbeucowfswfesp252dpw0k.jpeg" alt="28"><br>  It is logical to assume that an int type overflow will occur and <code>-2 147 483 648</code> will be output. </p><br><p><img src="https://habrastorage.org/webt/d4/z_/sw/d4z_swm5hymnkosepb3n1gpubrm.jpeg" alt="29"><br>  No, the app <em>will crash</em> .  At the same time, everything works on asm.js and desktop applications. </p><br><p><img src="https://habrastorage.org/webt/bt/rs/by/btrsbygxezhi2cegbdr2qxkhrie.jpeg" alt="thirty"><br>  The program's stopping point indicates the <code>trunc_s</code> or <code>trunc_u</code> .  The documentation on this subject states the following: </p><br><blockquote>  Truncating a float to an int may throw an exception if the initial value of the float does not fit into the integer range or if it is NaN. </blockquote><p>  It is necessary to catch all the problem areas in which the conversion of <code>float</code> and <code>double</code> to <code>int</code> occurs, or to control it as otherwise. </p><br><p><img src="https://habrastorage.org/webt/_4/km/mc/_4kmmcp1qgqcelz9-zgxbfi7r_i.jpeg" alt="31"><br>  This problem has already been discussed many times, and now a new specification is being developed on this topic for the WebAssembly standard called <strong>nontrapping-float-to-int-conversions</strong> .  It is now proposed to use the <code>BINARYEN_TRAP_MODE</code> option with the value <code>clamp</code> .  For all cases of <code>float</code> to- <code>int</code> conversion, a wrapper will be used that checks the possibility of conversion.  If this is not possible, then truncates at the maximum or minimum value. </p><br><p><img src="https://habrastorage.org/webt/43/zf/s4/43zfs4w08hdboogp4pdvspseaxm.jpeg" alt="32"><br>  With the <code>clamp</code> option, the application worked stably.  A simple <a href="https://github.com/iqoption/webassemblycppconf/tree/master/benchmarks/clamp">test</a> was made that clearly shows the situation with the <code>clamp</code> mode.  One pass performs one hundred million <code>float</code> and <code>double</code> conversions to an <code>int</code> .  The performance drops by about 40% compared to the assembly without the <code>clamp</code> option, and for version <strong>1.37.17</strong> , which was available at that time, this figure was even higher, so on the slide this is an optimized version of the <code>clamp</code> mode, but the gap is noticeable .  Here, the numbers were measured on a Core i7 2.2 Ghz processor in Chrome version 65 under Mac OS X. </p><br><div class="spoiler">  <b class="spoiler_title">clamp mode</b> <div class="spoiler_text"><p>  The <code>clamp</code> mode has been optimized by <strong>Alon Zakai</strong> aka <strong>kripken</strong> - the developer of <strong>emscripten</strong> , just based on this test.  Now <code>clamp</code> on performance is practically indistinguishable from asm.js.  A jump of 619 milliseconds, for asm.js, this is just the first iteration of the test for which JIT optimization was performed. </p></div></div><br><p><img src="https://habrastorage.org/webt/5k/bb/bj/5kbbbjreq76nxddgyjswoxbtkli.jpeg" alt="33"><br>  The same test on mobile devices <em>Samsung Edge S8 +</em> and <em>iPhone X.</em>  The gap in the case of wasm about 20 times.  This is a demonstration of how to make JIT compilation really optimal and productive. </p><br><p>  On the iPhone X, the difference between the presence and absence of the <code>clamp</code> mode is approximately 40%.  Under Android, such results do not apply only to this device.  On other devices, the results are similar or worse. </p><br><p>  Half a year ago, these numbers were completely different, considering that at that time iOS did not yet support WebAssembly and could only be compared with the practically non-working asm.js version. </p><br><p><img src="https://habrastorage.org/webt/p3/qz/d-/p3qzd-bw4ysyvnbz2ntxpyire_w.jpeg" alt="34"><br>  It was decided to catch problem areas in the code with truncated <code>float</code> and <code>double</code> in <code>integer</code> .  The easiest option is to compare the value in <code>float</code> with the <code>numeric_limits&lt;int&gt;</code> boundary, and also to check whether the value is <code>NaN</code> . </p><br><p><img src="https://habrastorage.org/webt/1z/og/np/1zognphciwrvpuv7r0ut3_nd69w.jpeg" alt="35"><br>  The key point, the <code>isfinite</code> , was generated after truncation.  The optimizer considered that he could do this because he did not consider <strong>truncate a</strong> dangerous operation.  In this case, the optimization is <code>-3</code> , but this is not important, since any optimization will lead to the generation of such code. </p><br><p>  We get inoperative code, even if we take into account all cases.  At present, this problem in the compiler is saved, it is known, and its solution is under development, it is <strong>nontrapping-float-to-int-conversions</strong> . </p><br><p><img src="https://habrastorage.org/webt/to/fd/yy/tofdyykhp2q2zmibxnczezed-iy.jpeg" alt="36"><br>  Since the <strong>truncate</strong> in <strong>WebAssembly is</strong> not secure at the moment, more control is needed for code generation.  For example, with the <code>-0</code> option <code>-0</code> all the checks in our function will be in the same order as they were written, but this affects the performance and size of the output file. </p><br><p>  You can limit the optimization only for this function by specifying the <code>optnone</code> attribute for it.  If you look at the results of the synthetic test, the difference in performance when using the function and without it is very noticeable and is approximately 70%.  In this case, one operation is performed: a <code>double</code> converted to an <code>int</code> 20 million times.  The result with the <code>clamp</code> option will be more productive than with our function.  <a href="https://github.com/iqoption/webassemblycppconf/tree/master/benchmarks/double_to_int">Test</a> </p><br><p><img src="https://habrastorage.org/webt/ow/o8/l-/owo8l-ooc54df5mcq99th5jgs2q.jpeg" alt="37"><br>  On mobile devices, using the value validation feature all the time also reduces performance.  The same test.  The gap is well marked on Android, more than 80% and 70% on iOS.  These are quite critical results for using the function.  Accordingly, it is better to use it only in cases where it is really necessary. </p><br><p><img src="https://habrastorage.org/webt/nj/lv/zi/njlvzinjpxak9xxxzf2hzmo1y9i.jpeg" alt="38"><br>  We know that in most conversions, <code>float</code> to <code>integer</code> in our program cannot go beyond certain limits.  These values ‚Äã‚Äãcan be checked during <code>float</code> or they are initially restricted to incoming data.  That use of the <code>clamp</code> mode will be redundant, it is enough to check only the part where there is a risk of going beyond the boundaries of the <code>integer</code> type. </p><br><p>  In the next <a href="https://github.com/iqoption/webassemblycppconf/tree/master/benchmarks/complex_try_int_cast">test</a> , matrices are multiplied and points are projected onto a plane.  The test result is the truncation of nine values ‚Äã‚Äãand one of them is checked by a function.  As you can see, this option already gives a performance boost of about 15% compared to <code>clamp</code> .  But the difference is not so clearly visible on the desktop. </p><br><p><img src="https://habrastorage.org/webt/ul/ge/fr/ulgefrqx20k-okdgkqyxas1io9i.jpeg" alt="39"><br>  On mobile devices, the result is more noticeable.  Compared to <code>clamp</code> , Android and iOS show a little more than 20% growth. </p><br><p>  It all depends on the application and its performance, in our case the option with the function that checks the values ‚Äã‚Äãturned out to be preferable.  However, currently the <code>clamp</code> mode has become more optimized.  If we were switching to WebAssembly now, we would use it, since the difference in our application is not noticeable now. </p><br><p><img src="https://habrastorage.org/webt/xh/rm/yv/xhrmyva4jff0xudxcm1wltm4chg.jpeg" alt="40"><br>  Another problem we are facing is reading data from files.  Emscripten allows you to work with files from C ++ as well as with regular files.  For this, a file package is created, and then it is mounted in JavaScript.  In the course of our application, new elements are often created, which are loaded from files as necessary.  At some point, the data from these files became invalid. </p><br><p><img src="https://habrastorage.org/webt/vz/l4/ni/vzl4nitzps51zakowuvzg4d_cna.jpeg" alt="42"><br>  By default, after loading the data file, the data is copied to the heap, and then a pointer to this area is used.  Placing in the heap increases the speed of access to files, but when memory is relocated (if the <code>ALLOW_MEMORY_GROWTH</code> option is <code>ALLOW_MEMORY_GROWTH</code> ), the pointer will become <code>ALLOW_MEMORY_GROWTH</code> , therefore all we read further from the files is some sort of garbage. </p><br><p>  At that time (version v1.37.17), this was already a known problem.  Solution: do not use heap for the file system.  In this case, the object from xhr response will be used directly, that is, the runtime will simply receive a pointer to the already existing buffer without copying it into the heap.  At the moment, in the current version of the toolchain, the <code>no-heap-copy</code> flag will be automatically specified if the <code>ALLOW_MEMORY_GROWTH</code> option is <code>ALLOW_MEMORY_GROWTH</code> . </p><br><p><img src="https://habrastorage.org/webt/uu/wq/ly/uuwqly1ot7lyhbs43t2sym6wx4i.jpeg" alt="44"><br>  You can build on the fact that the application will not consume more than a certain amount of memory, but when working with large amounts of data, it causes difficulties and in most cases a waste of memory. </p><br><p>  In our case, all elements of the application are created dynamically as needed, for example, the user can simultaneously open up to 9 graphs, which in real time receive quotes.  But usually 1-2 graphics are used and at the start of the application this amount of memory is not used. </p><br><p>  Having demanded more memory at the start, you risk not starting up on mobile devices.  The mobile browser when compiling will throw an exception with <strong>out of memory</strong> . </p><br><p><img src="https://habrastorage.org/webt/of/v2/cg/ofv2cguywuffursz_flokpgfgbk.jpeg" alt="62"><br>  What we came to and what conclusions made.  The technology continues to evolve, updates with fixes and improvements for the compiler come out periodically.  It is also possible to conduct a dialogue with developers on GitHub, which allows you to quickly find solutions to emerging problems. </p><br><p>  The problem with <strong>truncate</strong> remains unresolved and it is not known when they will fix it.  The used solutions to this problem currently can significantly slow down the application. </p><br><p>  You will have to write in JavaScript since there are no other possibilities for interacting with system APIs, or use ready-made wrappers. </p><br><p>  Debugging wasm in a browser is very difficult if you do not have a desktop version.  This can make development very difficult.  Some updates to the toolchain make changes that break the application. </p><br><p>  The situation with iOS is incomprehensible.  WebAssembly was supported in Safari, but subsequent updates broke and repaired WebAssembly.  It saves the fact that currently Safari strongly optimized the execution of asm.js and it began to run much faster.  Therefore, while using it as the main version on the iPhone. </p><br><p><img src="https://habrastorage.org/webt/xs/mp/ut/xsmputkfzbrbd8srzt0su7w_4de.jpeg" alt="63"><br>  The technology is quite alive and implemented at a sufficient level for its use in the finished project.  The main plus for us is a tangible increase in performance on mobile and "weak" devices.  At the moment we have been using WebAssembly since September 2017. </p><br><p>  Separately, I would like to thank Sergey Platonov <a href="https://habr.com/users/sermp/" class="user_link">sermp</a> , for organizing the conference. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354690/">https://habr.com/ru/post/354690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354678/index.html">Joomla performance on large volumes of content</a></li>
<li><a href="../354680/index.html">The Balance of Commerce of Ideas (a fundamental article by Nikolos Negroponte on the digital economy for 1995, part 4)</a></li>
<li><a href="../354682/index.html">Phased configuration of Continuous Integration (build, test, deploy) for .NET Core WebApp + GitHub</a></li>
<li><a href="../354684/index.html">Issue # 20: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../354686/index.html">What to read at the weekend: 5 books on practical information security</a></li>
<li><a href="../354692/index.html">Calculation of logical expressions in a string inside Java / Scala / Kotlin code</a></li>
<li><a href="../354694/index.html">Again about the trees</a></li>
<li><a href="../354696/index.html">Riddles resume. Part 1. Choosing a form</a></li>
<li><a href="../354698/index.html">A brief history of information security in China: how to build the Great Chinese firewall</a></li>
<li><a href="../354700/index.html">Is there life without architecture?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>