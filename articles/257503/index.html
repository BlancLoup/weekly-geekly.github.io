<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Power profiling of microcontrollers (EFM32, SiLabs series)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Two years ago, Silicon Labs swallowed another smaller company - this time the Norwegian manufacturer of low-power ARM controllers EnergyM...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Power profiling of microcontrollers (EFM32, SiLabs series)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br><img src="https://habrastorage.org/files/94d/f64/abc/94df64abccc143bc8b13ad62ad2e549b.png" align="right">  Two years ago, Silicon Labs swallowed another smaller company - this time the Norwegian manufacturer of low-power ARM controllers EnergyMicro.  Since then SiLabs actively develops and promotes EFM32 series microcontrollers with a funny lizard on the body. <br><br><h4>  To business </h4><br>  If you had to read reviews on modern microcontrollers, then you will agree - among other things, there will be surely said about record high performance and about record low power consumption.  It seems that this is just a rule of good taste in the club of the producers of MK, but it happens that the marketing phrases have a common meaning. <br><br>  According to the documentation, the power consumption of the EFM32 is really low, you can check it in practice using the utility for profiling the power consumption of microcontrollers from Silicon Labs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/112/1a6/fe5/1121a6fe53d3451d95a25368884c7483.gif"><br><br>  Under the review review utility and practical tips for its use. <br><a name="habracut"></a><br>  <u>Hardware</u> : debug board EFM32WG-STK3800. <br>  <i>EFM32 microcontrollers are based on ARM Cortex-M0 +, Cortex-M3 and Cortex-M4 cores and differ in the set of peripherals and the amount of internal memory.</i>  <i>Each series of microcontrollers has a separate debugging board, but all the boards are very similar and are priced at 42 USD.</i>  <i>I have a kit for EFM32 Wonder Gecko controllers.</i> <br><br>  <u>Software</u> : a platform for developing and debugging the Simplicity Studio project. <br>  <i>This is something like an aggregator of development tools for Silicon Labs microcontrollers (by the way, not only EFM32, but also good old C8051Fxxx, Zigbee modules, etc.).</i>  <i>Here is the IDE (gnu ARM eclipse), documentation, and a dozen different auxiliary utilities, including the desired Energy Profiler.</i>  <i>The full-fledged distribution of Simplicity Studio (Windows, MAC, Ubuntu) can be downloaded for free at <a href="http://www.silabs.com/products/mcu/Pages/simplicity-studio.aspx">silabs.com</a> .</i> <br><br>  Main menu Simplicity Studio immediately after installation: <br><br><img src="https://habrastorage.org/files/daf/740/d1f/daf740d1fa5d4919bb37dd35a93988c1.png" width="538" height="316"><br><br>  Relatively few tools are available before connecting the debugging board, but you can already look around a bit: on the left, a parametric search is available for microcontrollers (only SiLabs, of course), there are three icons in the upper right corner that are used to configure the components included in Simplicity Studio.  In general, the program itself monitors the release of new utilities and updates of its components, but the configuration can be done manually. <br><br>  To start working with the board, it is enough to connect it to the computer via USB and select the debug USB board as the power source (battery power is also available from the target microcontroller's USB). <br><br><img src="https://habrastorage.org/files/e4a/09c/efe/e4a09cefe74140ec948ee25359694625.png"><br><br>  After connecting, the board is detected by the computer and all components intended for the corresponding series of controllers (EFM32WGxxx) become available. <br><br><img src="https://habrastorage.org/files/58c/fd0/750/58cfd07509b44b37824c85256c416cae.png" width="740" height="434"><br><br>  Getting started is the easiest way to start with a demo, since there are a lot of them in Simplicity Studio. <br><br><img src="https://habrastorage.org/files/91f/2da/6e6/91f2da6e675343499f182db88d756177.png" width="740" height="434"><br><br>  I choose one of the examples for the EFM32WG-STK3800 - a simple program for working with the LCD-display - and run it with the default settings. <br><br><img src="https://habrastorage.org/files/f9c/6bc/363/f9c6bc363c1744d8a6b0e91e5b1312f8.png" width="420" height="360"><br><br>  Simultaneously with the launch of the program on the microcontroller, the measurement of the energy consumption of the crystal begins.  In real time, a graph of energy consumption versus time is plotted; this is perhaps the most visual part of the profiler. <br><br>  First, the graph shows the dynamics of changes in consumption in the course of execution of the program.  Secondly, for the point selected on the chart and for the chosen time interval, exact and average values ‚Äã‚Äãof the measured indicators are available. <br><br><img src="https://habrastorage.org/files/147/1d5/b8b/1471d5b8b75e42cab5389b172e2ca459.png" width="740" height="434"><br>  <i>* The screenshot captures the moment when all available profiler functions are enabled.</i>  <i>When you first start the picture does not look so bright</i> <br><br>  Plotting can be stopped and resumed, the plot has the function of scaling on a time scale, and a linear and logarithmic scale can be set along the vertical axis.  The logarithmic scale is a convenient tool for small currents, but the ability to simply scale the graph vertically is sometimes not enough. <br><br>  Several other useful functions are also available: displaying graphs of inputs to interrupt handlers (multi-colored vertical arrows) and supply voltage levels, exporting measurement results to excel, etc. <br><br>  But the most delicious thing is the correlation of graphics with executable code.  If the processor core supports tracing (Cortex-M3 and M4 are suitable), then any point on the Energy Profiler chart will match the line of code ‚Äî by clicking on the chart, the line in the listing on the right will be highlighted.  To determine too ‚Äúgluttonous‚Äù functions and procedures, also serves the statistics of the work of individual functions of the program - under the graph you can see the distribution of energy consumed between them.  Each function can be assigned a specific color, then it will be clear on the graph where it begins and ends. <br><br>  <b>All this beauty, if briefly, is implemented as follows</b> : <br>  The measuring module is built into the microcontroller power supply circuit on the debug board.  Through it, the current and voltage values ‚Äã‚Äãare sent to the computer, as well as the value from the timer built into the measuring module.  Together with the value of the command counter (SWO line), the data is processed and interpreted by the profiler. <br><br>  The current, voltage and time from the beginning of the measurements allow you to build a graph of energy consumption versus time, and the value of the command counter allows you to correlate each point with the line number and the name of the source code file. <br><br>  Energy Profiler uses an .axf object file with debugging data in DWARF (Debug With Arbitrary Record Format) format, which is created when the project is compiled in debug mode and the libelf and libdwarf libraries to determine the desired line in the code. <br><br><img src="https://habrastorage.org/files/cbd/a2a/96c/cbda2a96c99c42f5aa7d4feb20f529b8.png"><br><br><h4>  About profiling your own project </h4><br>  Above was considered a demo example built into Simplicity Studio.  When using the Energy Profiler pitfalls too little. <br><br>  So, to profile your own project, you need to do the following in the Simplicity IDE window: <br><ol><li>  Add the tracing function <b>SWOTraceSetup ()</b> to the project and call it when the controller is initialized. </li><li>  After compiling create a new profiler configuration: <br><ul><li>  Run-&gt; ProfilingConfigurations menu ... </li><li>  click on Simplicity Energy Profiler for ARM -&gt; New </li><li>  specify the * .afx file in the Executable field </li><li>  check the Enable Code Correlation checkbox on the Profiler tab </li></ul></li></ol><div class="spoiler">  <b class="spoiler_title">SWOTraceSetup ()</b> <div class="spoiler_text">  the function can be found in any example from the manufacturer, in the help, and many more where, but here I will add it too <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BSP_TraceSwoSetup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* Enable GPIO Clock. */</span></span> CMU-&gt;HFPERCLKEN0 |= CMU_HFPERCLKEN0_GPIO; <span class="hljs-comment"><span class="hljs-comment">/* Enable Serial wire output pin */</span></span> GPIO-&gt;ROUTE |= GPIO_ROUTE_SWOPEN; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(_EFM32_GIANT_FAMILY) || defined(_EFM32_WONDER_FAMILY) || defined(_EFM32_LEOPARD_FAMILY) /* Set location 0 */ GPIO-&gt;ROUTE = (GPIO-&gt;ROUTE &amp; ~(_GPIO_ROUTE_SWLOCATION_MASK)) | GPIO_ROUTE_SWLOCATION_LOC0; /* Enable output on pin - GPIO Port F, Pin 2 */ GPIO-&gt;P[5].MODEL &amp;= ~(_GPIO_P_MODEL_MODE2_MASK); GPIO-&gt;P[5].MODEL |= GPIO_P_MODEL_MODE2_PUSHPULL; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> /* Set location 1 */ GPIO-&gt;ROUTE = (GPIO-&gt;ROUTE &amp; ~(_GPIO_ROUTE_SWLOCATION_MASK)) | GPIO_ROUTE_SWLOCATION_LOC1; /* Enable output on pin */ GPIO-&gt;P[2].MODEH &amp;= ~(_GPIO_P_MODEH_MODE15_MASK); GPIO-&gt;P[2].MODEH |= GPIO_P_MODEH_MODE15_PUSHPULL; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> /* Enable debug clock AUXHFRCO */ CMU-&gt;OSCENCMD = CMU_OSCENCMD_AUXHFRCOEN; while(!(CMU-&gt;STATUS &amp; CMU_STATUS_AUXHFRCORDY)); /* Enable trace in core debug */ CoreDebug-&gt;DHCSR |= 1; CoreDebug-&gt;DEMCR |= CoreDebug_DEMCR_TRCENA_Msk; /* Enable PC and IRQ sampling output */ DWT-&gt;CTRL = 0x400113FF; /* Set TPIU prescaler to 16. */ TPI-&gt;ACPR = 0xf; /* Set protocol to NRZ */ TPI-&gt;SPPR = 2; /* Disable continuous formatting */ TPI-&gt;FFCR = 0x100; /* Unlock ITM and output data */ ITM-&gt;LAR = 0xC5ACCE55; ITM-&gt;TCR = 0x10009; }</span></span></code> </pre> <br></div></div><br>  After that, you can start profiling (with preliminary assembly and compilation of the project and firmware of the microcontroller) with one click. <br><br><img src="https://habrastorage.org/files/f46/b3e/f75/f46b3ef75d864d3dac0f4d5d6882d5e4.png"><br><br>  Since the utility uses absolute paths to the source code files, it is better to compile the project before each profiling, out of harm's way. <br><br>  Speaking about setting up tracing, you need to remember that it uses the auxiliary RC-generator AUXHFRCO.  In theory, it is configured and started when performing the trace setup function, however, if it is assumed that the microcontroller often uses ‚Äúdeep sleep‚Äù modes, in which this auxiliary generator turns off, there are different glitches.  If EM2 and lower modes of operation are used, it makes sense to manually adjust the AUXHFRCO power: <br><br><pre> <code class="objectivec hljs">EMU -&gt; <span class="hljs-built_in"><span class="hljs-built_in">CTRL</span></span> |= _EMU_CTRL_EMVREG_FULL;</code> </pre><br>  The auxiliary generator, providing the transfer of the value of the command counter via the SWO line, increases the power consumption by ~ 400 ¬µA and noises the measuring channel a little.  If the program optimization is finished and you want to get accurate measurement results, you should disable measurement correlation with executable code (read the kernel trace), i.e.  remove the <b>SWOTraceSetup ()</b> function call. <br><br>  Profiling can also be carried out for the original target board, in which case the SiLabs branded board will serve as a measurement module between the target board and the computer.  For this you will need: <br><ul><li>  Power the target board from the VMCU line on the Starter Kit board and connect the SWO pins of the target microcontroller to the proprietary board. </li><li>  Change the operation mode of the board - from the debug mode of the microcontroller on board to work in the external debugger mode.  Setup is carried out in another utility that is part of Simplicity Studio - Kit Manager. <br><br><div class="spoiler">  <b class="spoiler_title">Kit manager</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/fea/931/e00/fea931e00a614539a9229d937335d2b7.png"><br></div></div></li></ul></div><p>Source: <a href="https://habr.com/ru/post/257503/">https://habr.com/ru/post/257503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257491/index.html">REST server for a simple Haskell blog</a></li>
<li><a href="../257493/index.html">How to quickly build mailer for call center</a></li>
<li><a href="../257497/index.html">Development of Return of Dr. Destructo: What Progress Reached</a></li>
<li><a href="../257499/index.html">Notes on the fields of Big Data Week Moscow</a></li>
<li><a href="../257501/index.html">Cach√© 2015 Scalability with Ivy Bridge-EX</a></li>
<li><a href="../257505/index.html">Responsive design + Icon fonts = Adaptive icons</a></li>
<li><a href="../257507/index.html">A new virus that disables the computer when it is detected</a></li>
<li><a href="../257509/index.html">Changes in Visual C ++</a></li>
<li><a href="../257511/index.html">ES6 and beyond. Chapter 2: Syntax. Part 1</a></li>
<li><a href="../257513/index.html">Not quite cool Ruby</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>