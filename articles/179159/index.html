<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>xdebug in the hands of the administrator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will discuss the possible use of xdebug by system administrators of web servers. It may seem that the administrator does not have to diagn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>xdebug in the hands of the administrator</h1><div class="post__text post__text-html js-mediator-article">  The article will discuss the possible use of xdebug by system administrators of web servers.  It may seem that the administrator does not have to diagnose and debug the code, since this is the work of the programmer.  This is true.  But, how, in case of a problem, convince the programmer that his code is not optimal (if this is the case) and needs to be reworked, if the programmer says all the time: ‚ÄúWe are fine - repair the server‚Äù?  Imagine that this is a programmer with whom it is undesirable to argue.  For example, our very expensive and outraged customer. <br><a name="habracut"></a><br>  When administering web servers, engineers often encounter problems that ordinary users of the site call ‚Äúslow working‚Äù or ‚Äúslowing down‚Äù.  Of course, this is a very important issue that can have serious financial consequences for the site owner.  It is with such a wording that ‚Äúslow working‚Äù is usually addressed by users and / or site owners to the administrator of the web server, and this wording is enough to start diagnosing everything. <br><br>  Interestingly, the causes of such problems may be hidden almost anywhere.  And there can be several of these reasons, and the problems themselves can be difficult to reproduce.  What the user ultimately classifies as ‚Äúbrakes‚Äù might be at the lower level: <br><br><ul><li>  Delays in the network access channel to the site </li><li>  Server hardware problems </li><li>  Insufficient server resources </li><li>  Non-optimal operating system </li><li>  Non-optimal software </li><li>  Problems with access to third-party resources, access to which is implemented synchronously </li><li>  Not optimally written site code </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The task of the administrator is to identify and, if possible, eliminate these problems.  If they, of course, are in his area of ‚Äã‚Äãresponsibility.  And the last and possibly penultimate items are not included in his area of ‚Äã‚Äãresponsibility.  But we must also show that the problem lies precisely in these points. <br><br>  It is about the latter case, we will talk in our article.  Practice shows that this case accounts for about 90% of all problems associated with the slow work of the site.  Suboptimal code, poorly written SQL queries, improper use of locks - all this can lead to a slowdown of the site.  And if, up to a certain point, powerful iron could digest bad code, then with the onset of a certain ‚Äúx‚Äù point, it simply ceases to cope with the load.  It is possible to increase the capacity further, but, first, they will one day run out, and second, these are extra equipment costs.  Therefore, first of all, the solution of the problem should be started with the analysis of the site code. <br><br>  It is worth mentioning that there are cases when the acquisition of new hardware is more cost-effective than parsing and editing a large amount of code. <br><br>  The main task of the administrator, oddly enough - the administration of the server.  He is not a developer and has no moral right to touch the code, even if it does not work well.  Therefore, in order to conduct the most detailed diagnostics of this code and identify bottlenecks leading to the slow work of the site, it is necessary to use tools that do not require editing the code. <br><br>  Yes, I forgot, it is about developing in PHP!  This is what most web programmers use and like.  Although, at the expense of "love" question, rather controversial. <br><br><h2>  Xdebug </h2><br><br>  Xdebug is a <em>PHP</em> extension written by one of the <em>PHP</em> developers and intended to collect and analyze debug information in php code.  It is important to note that this is an open-source project. <br><br>  We will consider <em>xdebug</em> through the prism of the system administrator, affecting only the functionality that does not require editing the site code, and does not slow down the server. <br><br>  Obviously, any profiling or tracing introduces additional delays during code execution.  Therefore, the diagnosis should not affect the performance of the site. <br><br><h2>  Install xdebug </h2><br><br>  When using Centos / RHEL / Fedora, the easiest way to install xdebug will be to install from the EPEL repository: <br><br>  <strong>$ yum install php-pecl-xdebug</strong> <br><br>  Installing using pecl: <br><br>  <strong>$ pecl install xdebug</strong> <br><br>  You can also install xdebug from the source code by downloading it at <a href="http://xdebug.org/download.php">http://xdebug.org/download.php</a> : <br><br>  <strong>$ tar xvzf xdebug-2.2.1.tgz</strong> <br>  <strong>$ cd xdebug-2.2.1</strong> <br>  <strong>$ phpize</strong> <br>  <strong>$ ./configure --enable-xdebug</strong> <br>  <strong>$ make &amp;&amp; make install</strong> <br><br><br><h2>  Xdebug setup </h2><br><br>  The basic setting will be to simply connect the newly installed extension to the <em>php.ini file</em> .  In this file you need to check the presence of the line: <br><br>  zend_extension = /path/to/xdebug.so <br>  xdebug.default_enable = 0 <br>  xdebug.overload_var_dump = 0 <br><br>  If the line was not added to <em>php.ini</em> or to one of the <em>included</em> files, for example <em>/etc/php.d/xdebug.ini</em> , then you need to do it manually.  Then restart the web server. <br><br>  From this point on, the site developers have at their disposal new xdebug features that can theoretically be used.  With the first two directives, we specifically disable the function of the extended display of the function call stack when errors occur and the redefinition of the standard function <em>var_dump ()</em> .  Despite the fact that this is a great feature that helps the development, it changes (albeit slightly) the behavior of the site code.  We cannot go for it. <br><br><h2>  We start the analysis: Trace of function calls </h2><br><br>  The most important and useful method for diagnosing a site and identifying problem areas is the call tracing of functions.  When entering any page of the site that we have chosen, the collection of statistics on the operation of functions will be launched, namely: <br><br><ul><li>  The start and end time of the code </li><li>  The order of performance of functions </li><li>  Execution time of each function </li><li>  Memory consumption of each function </li></ul><br><br>  This invaluable information will help to reliably determine the "brake" section or parts of the code.  In addition, it will be possible to determine the amount of memory consumed by a particular function. <br>  Before starting the trace, we will define some variables that will help us control the collection of information and collect more of the necessary data during the execution of the code. <br><br>  <strong>xdebug.collect_params</strong> indicates how much detail you need to collect information about the arguments of functions.  0 - minimum, no information is collected.  1 - information is collected on the number and type of arguments.  3 - information about the meaning of the arguments.  4 - complete information: type, name, argument value at the moment of transfer.  The more information we want to get, the longer the trace will be performed. <br>  <strong>xdebug.show_mem_delta</strong> determines whether or not to reflect the difference in memory consumption in the final report when each function is called. <br>  <strong>xdebug.trace_enable_trigger</strong> enables or disables the ability to run trace on demand. <br>  <strong>xdebug.auto_trace</strong> enables or disables automatic start of tracing every time the site pages are accessed. <br>  <strong>xdebug.collect_assignments</strong> includes or does not include in the report information on the assignment of values ‚Äã‚Äãto variables. <br>  <strong>xdebug.collect_includes</strong> includes or does not include information about connected files in the report. <br>  <strong>xdebug.collect_return</strong> includes or does not include in the report information about the values ‚Äã‚Äãreturned by the functions. <br>  <strong>xdebug.trace_output_dir</strong> specifies the directory in which reports will be dumped. <br>  <strong>xdebug.trace_output_name</strong> generates the file name for the report. <br><br>  The remaining variables are associated with the visual display of the report, and we are not interested.  The standard form looks quite acceptable for analysis. <br><br>  The essence of the method will be to start the trace only at the moment when the administrator wants it.  Turning on tracing on an ongoing basis is unacceptable because it leads to increased resource consumption during code execution, and also creates a lot of unnecessary reports.  In order to indicate to the server that the administrator wants to start tracing the functions at the time the request is executed, he needs to pass the <strong>XDEBUG_TRACE</strong> parameter in a GET or POST request, or set a cookie with this name.  The latter method seems to be the most preferable, since a POST request is not always possible, and it is almost never necessary.  And when using GET, there may be problems related to the fact that the address bar is often processed on the server using mod_rewrite or aliases before calling the PHP code.  Therefore, our variable may simply not reach the addressee. <br><br>  We will collect as much information as possible about the passed variables, the connected files and the difference in memory consumed between function calls.  Add reports will be in <em>/ var / tmp</em> .  The remaining settings will be the default.  As a result, we add the following lines in <em>php.ini</em> : <br><br>  xdebug.trace_enable_trigger = 1 <br>  xdebug.auto_trace = 0 <br>  xdebug.collect_params = 4 <br>  xdebug.show_mem_delta = 1 <br>  xdebug.trace_output_dir = / var / tmp <br><br><br>  And restart the web server.  For analysis, take the following code: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"config.inc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"class/db.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">1</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">6</span></span>; $i++) { show_num($i); } $v = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); alloc_array(<span class="hljs-number"><span class="hljs-number">1024</span></span>); $db = DB::Get(<span class="hljs-string"><span class="hljs-string">"mysql"</span></span>, HOST, USER, PASS, NAME); $db-&gt;connect(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"finished"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show_num</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span></span>{ ($i % <span class="hljs-number"><span class="hljs-number">2</span></span>) ? show_odd($i) : show_even($i); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show_odd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"odd: $i&lt;br&gt;"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show_even</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"even: $i&lt;br&gt;"</span></span>; sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alloc_array</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $v; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $size; $i++) { $v[] = $i; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br>  We will not go into its details now, although it is not difficult to guess that the code is of no value for use in cases other than test cases. Imagine that the user tried to open in the browser the page for which this code is responsible.  The page was loaded for more than ten seconds, which is very long!  Our goal is to understand why. Since the tracing of the code has already been configured accordingly, we only need to tell the server to enable it for our future request and to make this very request.  As mentioned earlier, to do this, you must set the XDEBUG_TRACE variable in a GET or POST request, or pass it using a cookie.  We chose the last option - the transfer using cookies. <br><br>  Typically, variable cookies for a specific domain are set by the server in the client‚Äôs browser using the <em>Set-Cookie</em> HTTP header or set already on the client‚Äôs side using JavaScript. <br><br>  It‚Äôs rather difficult to get the header we need from the server: we don‚Äôt touch the site code, and making changes to the server settings requires it to be reset, which is not acceptable for periodic (non-one-time) operations.  The most correct option is to set a cookie for our domain on your (client) side.  We cannot force the server to give us the necessary javascript script to set the cookie.  All for the same reasons as in the case of the Set-Cookie header.  Therefore, we will set cookies in the browser on our own.  In Google Chrome, you can do this by typing the script directly into the address bar: <br><br>  javascript: document.cookie = "XDEBUG_TRACE = 1" <br><br><br>  The execution context of this script should correspond to our site.  That is, you must first open the site page, and then enter the command. <br>  Having set the variable, we make a request to the page and wait for the end of the request.  Next, on the server, look for the corresponding trace file in the <em>/ var / tmp directory</em> .  Let's look at the results: <br><br><pre>  TRACE START [2012-09-25 11:19:54]
     0.0005 645152 +645152 -&gt; {main} () /var/www/test.php call
     0.0007 649296 +4144 -&gt; require (/var/www/config.inc) /var/www/test.php:4
     0.0007 649504 +208 -&gt; define ('HOST', '10 .1.1.1 ') /var/www/config.incUE
     0.0008 649536 +32 -&gt; define ('NAME', 'db') /var/www/config.inc:4
     0.0008 649568 +32 -&gt; define ('USER', 'u0') /var/www/config.incimin
     0.0008 649600 +32 -&gt; define ('PASS', 'ps') /var/www/config.inc:6
     0.0012 695728 +46128 -&gt; require (/var/www/class/db.php) /var/www/test.phpiny
     0.0013 694736-992 -&gt; show_num ($ i = 1) /var/www/test.php:8
     0.0013 694736 +0 -&gt; show_odd ($ i = 1) /var/www/test.php:21
     0.0013 694864 +128 -&gt; show_num ($ i = 2) /var/www/test.php:8
     0.0013 694864 +0 -&gt; show_even ($ i = 2) /var/www/test.php:21
     0.0014 694960 +96 -&gt; sleep (1) /var/www/test.php:30
     1.0033 694864 -96 -&gt; show_num ($ i = 3) /var/www/test.php:8
     1.0034 694864 +0 -&gt; show_odd ($ i = 3) /var/www/test.php:21
     1.0034 694864 +0 -&gt; show_num ($ i = 4) /var/www/test.php:8
     1.0034 694864 +0 -&gt; show_even ($ i = 4) /var/www/test.php:21
     1.0035 694960 +96 -&gt; sleep (1) /var/www/test.php:30
     2.0047 694864 -96 -&gt; show_num ($ i = 5) /var/www/test.php:8
     2.0048 694864 +0 -&gt; show_odd ($ i = 5) /var/www/test.php:21
     2.0048 695224 +360 -&gt; alloc_array ($ size = 1024) /var/www/test.php:13
     2.0057 843024 +147800 -&gt; DB :: Get ($ type = 'mysql', $ host = '10 .1.1.1 ', $ user =' u0 ', $ pass =' ‚Äã‚Äãps', $ db = 'db') / var /www/test.php:15
     2.0057 843664 +640 -&gt; absDB -&gt; __ construct ($ host = '10 .1.1.1 ', $ user =' u0 ', $ pass =' ‚Äã‚Äãps', $ db = 'db') / var / www / class / db. php: 10
     2.0058 843664 +0 -&gt; DB -&gt; __ construct ($ host = '10 .1.1.1 ', $ user =' u0 ', $ pass =' ‚Äã‚Äãps', $ db = 'db') / var / www / class / db. php: 36
     2.0058 844000 +336 -&gt; DB-&gt; build () /var/www/class/db.php:19
     2.0058 844016 +16 -&gt; absDB-&gt; connect () /var/www/test.php:16
     2.0058 844368 +352 -&gt; mysqli_connect ('10 .1.1.1 ',' u0 ',' ps', 'db') /var/www/class/db.php:47
    11.0164 8432
 TRACE END [2012-09-25 11:20:05] </pre><br><br><br>  The first and last lines of the report display the start and end times of the request, respectively.  From this information it follows that the code was executed for 11 seconds.  The report also displays the order of calls to all functions in the code, taking into account their nesting.  The first column indicates the total execution time of the code in seconds at the time of the function call, the second column shows the memory consumption in bytes also at the time of the function call.  The third column is the difference in memory consumption caused by the PREVIOUS function.  The remaining columns show the name of the function, the file name and the line number in which it was called. <br><br>  Let's try to understand what causes the slow work of the code.  First of all, the long work of the <em>mysqli_connect ()</em> function, which takes almost 9 seconds, is striking.  Obviously, there are problems with access to a remote server.  Note that this function is called through several layers of abstraction and classes.  For many frameworks, this is common.  In addition, delays occur in the <em>sleep ()</em> function, which is called in the user function <em>show_even ()</em> . <br><br>  As for memory consumption, we see a sharp jump in more than 140KB after calling the user function <em>alloc_array ()</em> , as well as a large memory allocation at the very beginning of the code execution. <br><br>  We see all the necessary information about the passed arguments of all functions, so that the developer will be able to compare these reports with the source code. <br><br><h2>  Code profiling </h2><br><br>  It is worth mentioning another feature that xdebug provides for finding bottlenecks in the code, which the server administrator can use without making changes to the site code.  This is profiling.  Profiling is run in the same way as the function‚Äôs start-up function, with the exception of the variable cookie name.  XDEBUG_PROFILE is used instead of XDEBUG_TRACE.  As a result of profiling, we get a file with data that can be recognized by the <em>callgrind_annotate</em> utility from the <em>vallgrind team</em> , and can also be displayed graphically using the <em>KCacheGrind</em> utility under KDE or <em>WinCacheGrind</em> under Windows.  <em>KCacheGrind</em> among them is the richest in functionality. <br><br>  You need to configure profiling on demand with directives similar to function directives: <br><br>  xdebug.profiler_enable = 0 <br>  xdebug.profiler_enable_trigger = 1 <br>  xdebug.profiler_output_dir = / var / tmp <br></div><p>Source: <a href="https://habr.com/ru/post/179159/">https://habr.com/ru/post/179159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179145/index.html">Boris is a small but reliable REPL for php</a></li>
<li><a href="../179149/index.html">MikroTik - quick setup of the access point</a></li>
<li><a href="../179151/index.html">Nexenta operating experience, or 2 months later</a></li>
<li><a href="../179153/index.html">Features of c ++ tuples implementation</a></li>
<li><a href="../179155/index.html">A little more about migrations. PHP version</a></li>
<li><a href="../179161/index.html">Diablo III's economy has been destroyed by integer overflow</a></li>
<li><a href="../179163/index.html">DevConf contest - dedicated to the Victory Day!</a></li>
<li><a href="../179167/index.html">Introducing GStreamer: Data Sources</a></li>
<li><a href="../179169/index.html">We tame Ustream.tv for HD video broadcasting on our own website without displaying ads</a></li>
<li><a href="../179171/index.html">New Firefox Cookie Policy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>