<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We saw the catalog of goods without touching relational algebra</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, my name is Dmitry Karlovsky and I ... haven‚Äôt been engaged in a backend for a long time, but recently I stumbled upon SbWereWolf‚Äôs torture of p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We saw the catalog of goods without touching relational algebra</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello, my name is Dmitry Karlovsky and I ... haven‚Äôt been engaged in a backend for a long time, but recently I stumbled upon <a href="https://habrahabr.ru/users/sbwerewolf/" class="user_link">SbWereWolf‚Äôs</a> torture of <a href="https://habrahabr.ru/users/sbwerewolf/" class="user_link">putting a</a> <a href="https://habrahabr.ru/post/323498/">hedgehog on a hedgehog</a> and couldn‚Äôt resist the temptation to blow the dust out of its <a href="http://orientdb.com/">OrientDB</a> multi-tool and chop off something like that. </p><br><p>  So, today we will be making a database for an online store with a search for products by parameters, full-text search, localization, automatic generation of a rubricator and a product adding wizard. </p><br><p>  We will analyze this one here relational spaceship: </p><br><p><img src="https://habrastorage.org/files/71d/eb6/e38/71deb6e382784686a11f87292263fb14.png" alt="17 tables"></p><br><p>  And collect here is such a graph birdhouse: </p><br><p><img src="https://habrastorage.org/files/5ba/c61/6df/5bac616df3c54a01beb7b87c91a5c30d.png" alt="5 classes"></p><a name="habracut"></a><br><h1 id="shema-bazy-dannyh">  Database schema </h1><br><p>  All entities of our catalog will have the following fields: </p><br><ul><li>  <strong>slug</strong> - human-readable identifier </li><li>  <strong>created</strong> - time to create an entity </li><li>  <strong>searchable</strong> - whether the entity will be in the search </li><li>  <strong>title</strong> - the human-readable name of the entity in the form of a language-text dictionary </li><li>  <strong>description</strong> - a human-readable description of an entity in the form of a language-text dictionary </li></ul><br><p>  In order not to repeat these fields in each entity, as is done in a starship, we simply create an abstract class "Object" from which we will further inherit other entities: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> abstract <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Object.slug <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> ci , <span class="hljs-keyword"><span class="hljs-keyword">notnull</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Object.created datetime ( readonly <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sysdate</span></span>() ) <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Object.searchable <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Object.title embeddedmap <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> ci ) <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Object.description embeddedmap <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> ci )</code> </pre> <br><p>  A slug should be unique for each entity, and we will need a search by names and descriptions, so we add the appropriate indices to these fields: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.slug <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.title <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>( title <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ) fulltext engine lucene metadata { "analyzer" : "org.apache.lucene.analysis.ru.RussianAnalyzer" } <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.description <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>( description <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ) fulltext engine lucene metadata { "analyzer" : "org.apache.lucene.analysis.ru.RussianAnalyzer" }</code> </pre> <br><p>  It‚Äôs nice that the full-text search engine is already built into the database and we don‚Äôt have to deal with manually transferring data from our main database to any <a href="https://en.wikipedia.org/wiki/Elasticsearch">ElasticSearch built on the same Lucene</a> .  When changing the essence of the DBMS itself will take care of updating the full-text index. </p><br><p>  The most important thing in our store is the goods, and in addition to the standard properties, each product also has a price: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Product extends <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Product.price <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span></code> </pre> <br><p>  In a starship, a hierarchy of rubrics in the form of a tree is used, but we will proceed more interestingly - we divide the entire hierarchy into 2 types of nodes: </p><br><ul><li>  <strong>Tag</strong> - a flag characterizing a particular product. </li><li>  <strong>Aspect</strong> - a group of mutually exclusive tags that form the characteristics of the goods </li></ul><br><p>  In the hierarchy, these two types of nodes go alternately: </p><br><ul><li>  inside the tag may be aspects, but not tags </li><li>  tags can be inside an aspect, but not aspects </li></ul><br><p>  Examples of aspects (and in brackets - tags): </p><br><ul><li>  Type of product (food, clothing, appliances) </li><li>  Manufacturer (Plyushkin Incorporated, McIntosh Limited, Excavator Trading) </li><li>  Color (Red, Blue, Green) </li></ul><br><p>  The choice of "color" makes sense to give only for the tags "clothing" and "appliances", but not "food". </p><br><p>  Add these two entities and tie them together: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Aspect extends <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Tag extends <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Aspect.tag linkset Tag <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Aspect.tag_sub linkset Tag <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Tag.aspect linkset Aspect <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Tag.aspect_sub linkset Aspect</code> </pre> <br><p>  As you can see, all our relations are bilateral many-to-many.  Each entity has a link to related entities.  It remains only to link our hierarchy with the goods.  The link will be one-way so as not to clutter up the tag with a list of related products, which we will not use anyway: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Product.tag linkset Tag</code> </pre> <br><p>  For example, the tag ‚Äútechnique‚Äù may be set for the product ‚ÄúTablecloth-self-dressing‚Äù, which will open the aspect of ‚Äúcolor‚Äù and, as a result, the ability to choose ‚Äúred‚Äù. </p><br><p>  So that the search by tags does not slow us down, we will add an index to them: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> Product.tag notunique</code> </pre> <br><p>  In addition to flags, entities must also have attributes of other types: string, integer, decimal, temporal, and so on.  To describe these attributes, we introduce the corresponding entity: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> extends <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Attribute.type <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">"string"</span></span> )</code> </pre> <br><p>  Attributes we will not be tied to the goods, as one might think, but to the tags: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Tag.attribute linkset <span class="hljs-keyword"><span class="hljs-keyword">Attribute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> property Attribute.tag linkset Tag</code> </pre> <br><p>  For example, if the "food" tag is set, then the "shelf life" attribute becomes available for the product.  The very value of the attribute of a particular product we will store in the product itself.  We will not put this into the scheme, since each product may actually have its own set of attributes depending on which tags have been set for it. </p><br><h1 id="polzovatelskie-scenarii">  Custom Scripts </h1><br><h2 id="polnotekstovoy-poisk">  Full text search </h2><br><p>  If the user entered a search query, we immediately search for all objects that correspond to him: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( title lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> description lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> )</code> </pre> <br><p>  But if the issue turns out to be too large, it would be reasonable to offer him to detail the request for tags from the goods in the issue.  To do this, we will request along with the actually found objects also associated tags and related attributes and aspects: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( title lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> description lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> ) fetchplan *:<span class="hljs-number"><span class="hljs-number">0</span></span> slug:<span class="hljs-number"><span class="hljs-number">0</span></span> title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.slug:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.aspect.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.type:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Thus, next to the search results, we can place a specifying rubricator, the transition to the items which will narrow the issue, but is guaranteed not to lead to its complete cleaning.  Therefore, we boldly add filtering by tags selected by the user and attribute values: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( title lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> description lucene <span class="hljs-string"><span class="hljs-string">"*"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> slug=<span class="hljs-string"><span class="hljs-string">"color=red"</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( weight <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> ) fetchplan *:<span class="hljs-number"><span class="hljs-number">0</span></span> slug:<span class="hljs-number"><span class="hljs-number">0</span></span> title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.slug:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.aspect.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.type:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><h2 id="navigaciya-po-katalogu">  Directory Navigation </h2><br><p>  When the user has just opened the site, it is reasonable to immediately offer him several directions of movement and delineate the range.  Therefore, we derive all root aspects and possible tags for them: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ( tag <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) fetchplan *:<span class="hljs-number"><span class="hljs-number">0</span></span> title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.slug:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.title:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  The user's further journey is similar to the case of full-text search, but without actually full-text search: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Product <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> slug=<span class="hljs-string"><span class="hljs-string">"color=red"</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( weight <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> ) fetchplan *:<span class="hljs-number"><span class="hljs-number">0</span></span> slug:<span class="hljs-number"><span class="hljs-number">0</span></span> title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.slug:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.aspect.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag.attribute.type:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  As you can see, plunging deeper into the rabbit hole, we do not move from one rubric to another (nested), but add an additional tag to the filtering.  For example, on the "red shoes" page we will search by tags "clothing", "shoes", "shoes", "red", and on the "red notebooks" page - "equipment", "computers", "notebooks", " red. "  In both cases, the "red" is the same tag. </p><br><h2 id="sozdanie-tovara">  Creation of goods </h2><br><p>  When creating a product, there is no point in listing all the possible parameters for the goods.  For example, the parameter "signal / noise ratio" is completely meaningless for "shoes".  Therefore, just as with the catalog, we display only the root aspects, and additional aspects become available only as tags are selected by the user who adds the product.  The list of available attributes and aspects with their tags on the list of selected tags is rather trivial: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ( tag <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ( tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> slug=<span class="hljs-string"><span class="hljs-string">"color=red"</span></span> ) ) fetchplan *:<span class="hljs-number"><span class="hljs-number">0</span></span> title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.slug:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.attribute.title:<span class="hljs-number"><span class="hljs-number">0</span></span> tag_sub.attribute.type:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Here we can provide the user with the ability to add not only the product, but also expand the set of attributes, aspects and tags. </p><br><p>  Create, for example, the aspect "Type of product": </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=kind"</span></span> , title = { <span class="hljs-string"><span class="hljs-string">"ru"</span></span> : <span class="hljs-string"><span class="hljs-string">" "</span></span> }</code> </pre> <br><p>  Now add to it, for example, the tag "Clothes": </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=wear"</span></span> , searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> , title = { <span class="hljs-string"><span class="hljs-string">"ru"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> } , aspect = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=kind"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> tag_sub = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=wear"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=kind"</span></span></code> </pre> <br><p>  Other tags are added similarly.  Adding an aspect to a tag is similar.  For example, add the "Color" aspect to the "Clothing" and "Technique" tags: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=color"</span></span> , title = { <span class="hljs-string"><span class="hljs-string">"ru"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> } , tag = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=wear"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> aspect_sub = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=color"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=wear"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> aspect_sub = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Aspect <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=color"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span></code> </pre> <br><p>  And finally, the most important thing is the addition of goods.  For an example, add a "self-painted cloth" in red: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> Product <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> slug = <span class="hljs-string"><span class="hljs-string">"product=2"</span></span> , searchable = <span class="hljs-literal"><span class="hljs-literal">true</span></span> , title = { <span class="hljs-string"><span class="hljs-string">"ru"</span></span> : <span class="hljs-string"><span class="hljs-string">"-"</span></span> } , price = <span class="hljs-number"><span class="hljs-number">999</span></span> , tag = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=tech"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=red"</span></span> )</code> </pre> <br><h2 id="udalenie-tovara">  Removal of goods </h2><br><p>  Deleting a product should not at all lead to deleting a record of this product from the database, so in the future you may need to restore this product or find information about it by its identifier from some log.  Yes, even in order to issue 410 (Gone) instead of 404 (Not found), it is necessary that some product record still remains.  In addition, there is such a complex problem as ensuring that no other entry refers to the one being deleted.  Therefore, the best solution is to change the record so that it is excluded from certain processes.  For example, to ensure that the product is not in the global search or in the catalog, it is enough to change the <code>searchable</code> flag to <code>false</code> .  That is why in all search queries we specified the additional condition <code>where searchable = true</code> . </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> Product <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> searchable = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"product=2"</span></span></code> </pre> <br><p>  Another "delete" option is to delete references to the entity, instead of deleting the entity itself.  For example, the list of aspect tags is stored in the <code>tag_sub</code> property.  If we want to no longer choose the ‚ÄúSulfur-ballon‚Äù tag in the ‚ÄúColor‚Äù aspect, then simply remove it from the <code>tag_sub</code> , but leave the link from the tag to the aspect intact.  Thus, when viewing a product with this strange color, nothing will break - ‚ÄúColor: Sulfur Oil‚Äù will appear, but when creating a new product, it will be impossible to choose this color. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Update</span></span> Aspect remove tag_sub = ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Tag <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"tag=gray-brown-magenta"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> slug = <span class="hljs-string"><span class="hljs-string">"aspect=color"</span></span></code> </pre> <br><h1 id="rezyume">  Summary </h1><br><p>  So we got 4 entities: product, tag, aspect and attribute.  Between themselves, they have 8 types of links.  And all this is enough to realize your Yandex.Market with search, filters and sorceresses in just one hectic evening. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324012/">https://habr.com/ru/post/324012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324002/index.html">VR-Design: User Interface</a></li>
<li><a href="../324004/index.html">New JavaScript: Asynchronous Iterators</a></li>
<li><a href="../324006/index.html">Russian Code Cup challenges programmers again</a></li>
<li><a href="../324008/index.html">Citrix and Microsoft have integrated NetScaler Unified Gateway with Microsoft EMS</a></li>
<li><a href="../324010/index.html">File storage in the social network and other projects of the students of Innopolis University</a></li>
<li><a href="../324016/index.html">Network configuration in guest Ubuntu 16.04 Server on VirtualBox + Windows 7</a></li>
<li><a href="../324018/index.html">Welcome to GeekDay Evolution March 25</a></li>
<li><a href="../324022/index.html">Hacker for a fee destroyed data on fines for violating traffic rules</a></li>
<li><a href="../324024/index.html">Detailed TTL Tuning Guide for DNS Records</a></li>
<li><a href="../324026/index.html">The report on the results of "My Circle" for February 2017 and the most popular vacancies of the month</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>