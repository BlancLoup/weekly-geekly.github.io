<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SSH in humans is not secure enough. How I struggle with paranoia</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Under my supervision about 1000 iron servers, I don‚Äôt even start counting VPS. A couple of dozen of them have very critical data. And a banal ssh with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SSH in humans is not secure enough. How I struggle with paranoia</h1><div class="post__text post__text-html js-mediator-article">  Under my supervision about 1000 iron servers, I don‚Äôt even start counting VPS.  A couple of dozen of them have very critical data.  And a <b>banal ssh with keys in a standard situation is not safe enough</b> .  Not all ‚Äúleather people‚Äù take care of their keys, let's talk how to protect ourselves against the possibility of losing a key by the user. <br><a name="habracut"></a><br><h4>  Whom we protect </h4><br>  "Standard" hosting company.  The largest number of personnel in customer service and support.  Honest SSH servers have access only to support 3 lines, about 12 people.  The technical avant-garde of the company completes the set - ‚Äúservice department‚Äù by 8 people <br><br><h4>  Mass user </h4><br>  For the support department and part of the service department, an SSH authorization server is configured.  This is the server that has the key for authorization almost anywhere.  Almighty Key is one of the most valuable information not to be missed.  4 people in the office can read it directly.  Backup on paper lies in the safe.  Also on this server get temporary access developers who need to personally see where and how it broke. <br><br>  Employee can get ssh access through the authorization server using the all-powerful key.  Technically, these employees can call only one command - ssh, ssh, in turn, uses a private key to connect to a remote server.  As a rule, employees use a local script to quickly use an authorization server.  Historically, it is called go.  Here are its contents: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/vi/z5/wj/viz5wjami_purtlv0xvhaeigkl0.png" alt="image"><br><br>  Another plus of the common authorization server is the ability to log and read statistics for all employees.  We know which employee spent much time on which server.  In case of emergency situations, we know that the employee entered there and what answered him, since all input and output of the ssh session is copied. <br><br><h4>  Demigods </h4><br>  The second serious vulnerability is the omnipotent keys of several employees.  Such keys are allowed to register on the server only with the parameter from = ‚Äù‚Äù.  At authorized_keys, it looks like this: <br><br><img src="https://habrastorage.org/webt/qv/r4/a5/qvr4a5-ksjmbvqpqwhjkayvgfqw.png" alt="image"><br><br>  The mentioned omnipotent 4 people realize their importance and encrypt the disk of the laptop without forgetting about the password to the private part of the key. <br>  Work outside the office is only possible using VPN to the office.  If there is no electricity in the office, we have a backup VPN server that can also announce our office network. <br><br><h4>  Almighty server </h4><br>  The last serious point is a large service server.  The server monitors almost everything and knows about all the pieces of iron and why they are needed, besides that, all the ansible tasks are launched on it.  On the server is a private key with a password.  After logging in to the server, the magic with ssh-agent in bashrc prompts you to enter a password for the key.  Then you can work in full force.  There is no direct ssh on this server, ‚Äútwo subheams, three whims‚Äù and you're on the server. <br><br>  These rules do not override the normal configuration of the firewall on the servers.  But the firewall is usually configured a little wider and lets ssh from the office network, then through sshd_config we press the list of ip which can become root: <br><br><img src="https://habrastorage.org/webt/ab/0h/_2/ab0h_2jd6sahv-k4ck-caemwjp8.png" alt="image"><br><br><h4>  And if all this does not work </h4><br>  The last bastion of verification on each server is the .bashrc file, when the shell initializes via ssh, bash starts, and it checks the source of the connection: <br><br><img src="https://habrastorage.org/webt/rb/p1/t8/rbp1t8jkb28b1-voneudmxtcgfw.png" alt="image"><br><br>  This number of restriction options is used to group the necessary level of protection without blocking the employee‚Äôs work.  But at the same time to maintain confidence that the server is covered.  As the company grows, I am less confident in programs running in the office.  I trust all employees, but I sleep with difficulty. <br><br><h4>  Plans for finishing touches </h4><br>  Extend the functionality of the authorization server so that you can specify a list or mask of servers for each user.  It is possible to add a bashrc so that at the time of connection, he dumped information about the user and ip.  Next, raise the checkboxes if the user has a new ip or something like that.  I'm not sure that this is a working scheme, but you can try it at your leisure. <br><br>  Ps: Message from <a href="https://habrahabr.ru/users/bfuvx/" class="user_link">bfuvx</a> how to get around bashrc <br>  ssh -vvv -i everebody root@149.154.64.101 <br><br>  We catch something like ‚Äúdebug2: shell request accepted on channel 0‚Äù and send at this moment ‚ÄúCtrl + c‚Äù: <br><br>  Last login failed: Tue Mar 20 02:41:12 EDT 2018 from 58.242.83.24 on ssh: notty <br>  There were 23 failed login attempts since the last successful login. <br>  Last login: Tue Mar 20 02:40:14 2018 from 95.154.75.23 <br>  ^ C-bash-4.2 # </div><p>Source: <a href="https://habr.com/ru/post/351310/">https://habr.com/ru/post/351310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351296/index.html">Blockchain on Go. Part 3: Permanent Memory and Command Line Interface</a></li>
<li><a href="../351298/index.html">Apache PHP MySQL bundle on Solaris 11.3</a></li>
<li><a href="../351300/index.html">Analysis of performance tasks with JBreak (part 2)</a></li>
<li><a href="../351304/index.html">Thymeleaf Tutorial: Chapter 7. Conditional Execution</a></li>
<li><a href="../351308/index.html">Comparison of open OLAP-systems Big Data: ClickHouse, Druid and Pinot</a></li>
<li><a href="../351312/index.html">3. Check Point for maximum. Content Awareness</a></li>
<li><a href="../351316/index.html">Introvert management introverts or experience managing technical teams</a></li>
<li><a href="../351318/index.html">John Carmack: Weekly vacation spent programming</a></li>
<li><a href="../351320/index.html">Profiling: measurement and analysis</a></li>
<li><a href="../351322/index.html">Evil by Design: interfaces from Mephistopheles (part one)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>