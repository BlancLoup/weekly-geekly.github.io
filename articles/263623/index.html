<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mystery Case Access denied</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the morning one of the developers of the corporate application contacted the support service. He could not make a copy from the MS SQL Server datab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mystery Case Access denied</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fd3/d10/1a3/fd3d101a32b645c0be42227657cb6844.jpg" align="left">  In the morning one of the developers of the corporate application contacted the support service.  He could not make a copy from the MS SQL Server database, and asked to find out the cause of the error. <br><br>  The first thing to start with is to check the error for reproducibility. <br>  Let's try to make a copy with the command: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [SDB] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK=N<span class="hljs-string"><span class="hljs-string">'\\FS1\Backup\sdb_full.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> COPY_ONLY</code> </pre> <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">What is COPY_ONLY?</b> <div class="spoiler_text">  WITH COPY_ONLY is a very useful key.  It will not disturb the backup sequence in the backup system. <br></div></div><br><br>  Indeed, an attempt to make a copy ended in an error: <br><img src="https://habrastorage.org/files/678/f37/a4c/678f37a4c92d4e35aef0fd6e6e450c97.PNG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What could cause such a problem? <br><br>  SQL Server runs from the built-in ‚ÄúNetwork Service‚Äù account <br><br>  Just in case, we check the resolution of the name of the FS1 server using the short name and the FQDN.  Both names are resolved and, importantly, point to the same server.  Open the network folder, check permissions on NTFS and Share Permissions.  All right, the SQL1 server account has write permission. <br><br>  Maybe problems with NTLM, Kerberos?  Let's try to make a backup using the FQDN server. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [SDB] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK=N<span class="hljs-string"><span class="hljs-string">'\\FS1.contoso.test\Backup\sdb_full.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> COPY_ONLY</code> </pre><br><img src="https://habrastorage.org/files/37b/3d2/0d2/37b3d20d2d304f0aa5f3a81439c2e24f.PNG"><br><br>  Interesting.  Using FQDN, the backup was successfully created.  What does it mean?  Is that the situation has become even more confusing. <br><br>  SQL Server cannot be restarted during working hours.  Staying in the night would not want to. <br><br>  When nothing is clear, the administrator‚Äôs best friend is Wireshark or Microsoft Network Monitor.  If you take a good dump, you can either figure it out or get confused. <br><br>  Putting on a responsible Microsoft Network Monitor server is a theoretically safe event, but life so often makes adjustments to the safest undertakings. <br><br>  It is impossible to reboot, it is undesirable to put the monitor.  Then use the <a href="http://blogs.msdn.com/b/canberrapfe/archive/2012/03/31/capture-a-network-trace-without-installing-anything-works-for-shutdown-and-restart-too.aspx">Windows Event Tracing service</a> . <br><br>  Enable tracing: <br><pre> <code class="dos hljs">netsh trace <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> persistent=yes capture=yes tracefile=c:\temp\trace.etl</code> </pre><br>  Repeated backup command several times: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [SDB] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK=N<span class="hljs-string"><span class="hljs-string">'\\FS1\Backup\sdb_full.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> COPY_ONLY <span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [SDB] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK=N<span class="hljs-string"><span class="hljs-string">'\\FS1\Backup\sdb_full.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> COPY_ONLY <span class="hljs-keyword"><span class="hljs-keyword">BACKUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [SDB] <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK=N<span class="hljs-string"><span class="hljs-string">'\\FS1\Backup\sdb_full.bak'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> COPY_ONLY</code> </pre><br>  Stop tracing: <br><pre> <code class="dos hljs">netsh trace stop</code> </pre><br><img src="https://habrastorage.org/files/587/b12/f97/587b12f978d446ef8e1bc811ad0bc07a.PNG"><br><br>  Open the file in Microsoft Network Monitor on the administrator's workstation: <br><img src="https://habrastorage.org/files/118/56a/ef6/11856aef628f4ff7851418fb324bd4ea.PNG"><br><br>  Each time you try to make a copy, the KDC_ERR_PREAUTH_REQUIRED event appears with a mysterious user DBAdmin.  This is not an employee, administrator account, it does not start SQL Server. <br>  KDC_ERR_PREAUTH_REQUIRED means that the credentials are incorrect. <br><br>  But the backup is performed in the context of the ‚ÄúMS SQL Server‚Äù service, and it is launched under the ‚ÄúNetwork Service‚Äù.  And here is DBAdmin? <br><br>  In Windows, there is a ‚ÄúCredentials Manager‚Äù, also known as the ‚ÄúCredentials Manager,‚Äù which allows you to save credentials for various network resources.  It can be called with the command ‚Äúcontrol userpasswords2‚Äù or ‚Äúnetplwiz‚Äù: <br><img src="https://habrastorage.org/files/9fb/eb4/979/9fbeb49796e741a3aab3eb9e8f581a55.png"><br><br>  Let's check whether the context of the computer account "SQL1 \ Network Service" saved alternative credentials for the server FS1. <br><br>  To start the process on behalf of another user, we use psexec. <br><br>  If you run psexec with the "-s" key, we will get into the context of "Local System".  It will not work. <br><br>  In order to get into the context of the ‚ÄúNetwork Service‚Äù run the utility with the following keys: <br><pre> <code class="dos hljs">psExec.exe -i -u ‚Äúnt authority\network service‚Äù <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe</code> </pre><br><img src="https://habrastorage.org/files/482/01a/85c/48201a85caa04787a352149ecb351a35.PNG"><br><br><img src="https://habrastorage.org/files/b6a/9f0/040/b6a9f004023e44c191434c1ab792ba3c.png"><br><br>  Check if the Access Denied error is repeated in the context of the ‚ÄúNetwork Service‚Äù when accessing the FS1 server: <br><img src="https://habrastorage.org/files/d71/33f/0c3/d7133f0c3f80461595d1e365ae1e3ccf.PNG"><br><br>  The error is playing. <br><br>  Check the saved credentials.  Run "control userpasswords2" without witchcraft with Explorer will not work.  Yes, and it is not necessary, to work with "Credentials Manager" from the command line, there is a cmdkey.exe utility. <br><br>  In order to display the saved credentials, run the command: <br><pre> <code class="dos hljs">cmdkey /list</code> </pre><br><img src="https://habrastorage.org/files/bad/743/d0b/bad743d0b1ec4b06b3a5792bbce12892.PNG"><br><br>  No saved credentials found.  More interesting. <br><br>  So, what we know at the moment: <br><ol><li>  In the context of the computer account "SQL1 \ Network Service" when accessing the SMB protocol to the FS1 server, an Access Denied error is returned </li><li>  When accessing the server via FQDN FS1.contoso.test, the error is not returned </li><li>  Access to the FS1 server is performed using the DBAdmin account, which is not used anywhere else explicitly. </li><li>  In the context of "SQL1 \ Network Service" credentials manager credentials are not saved </li></ol><br>  <b>Wait, but you can save credentials not only in the Credentials Manager, but also in the memory of the Lanman Workstation service</b> . <br><br>  If you connect the drive with the / savecred option, the credentials will be saved in the Credentials Manager: <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> use \\FS1\Backup /persistent:yes /savecred</code> </pre><br>  If you omit the / savecred parameter, the credentials will be stored in the service‚Äôs memory until a reboot <br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> use \\FS1\Backup /persistent:yes /user:DBAdmin</code> </pre><br>  Check if we have saved connections: <br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> use</code> </pre><br><img src="https://habrastorage.org/files/6ff/03a/47a/6ff03a47a9d14d8c90596b78c4c509ac.PNG"><br><br>  There is!  Now it is clear why an error was returned when accessing FS1, but not to FS1.contoso.test. <br><br>  Delete saved connections: <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> use * /delete</code> </pre><br><br>  Check backups: <br><img src="https://habrastorage.org/files/750/41e/f47/75041ef47ecf4b158b098aaf625b836c.PNG"><br><br>  Problem solved. <br><br>  And what was the matter?  The cause of the error is very nontrivial.  A network drive under DBAdmin user was connected inside the corporate application on behalf of SQL Server, which was not disconnected due to an error in the application.  After some time, the DBAdmin user probably changed the password, or the server was restarted.  And here he is, the mysterious Access denied! <br><br>  What conclusions can be drawn for yourself? <br><ol><li>  When you perform a SQL Server backup, the network resources are accessed on behalf of the SQL Server service account, and not from the user running the BACKUP DATABASE command.  Keep this in mind when setting permissions. </li><li>  Always remove additional full backups with the WITH COPY_ONLY key.  SQL Server marks data pages that were modified after a full backup, and only modified pages fall into a differential copy.  It is logical that after each full backup, the state of the pages is cleared.  The key allows you not to clear the page mark, and the sequence will not be broken. </li><li>  In case of an ‚ÄúAccess denied‚Äù error, it will not be superfluous to check whether the error repeats itself and by the host name, by FQDN, by IP address. </li><li>  You can get into the security context of the account you need by running psexec with the -U switch. </li><li>  The cmdkey utility is used to display credentials from the key storage service. </li><li>  To display the saved connected network connections, use the net use command. </li></ol><br><br>  Thanks for attention. <br><br>  Thanks <a href="http://habrahabr.ru/users/ildarz/" class="user_link">ildarz</a> , <a href="http://habrahabr.ru/users/sabin/" class="user_link">sabin</a> for informative comments, removing inaccuracies and hints. </div><p>Source: <a href="https://habr.com/ru/post/263623/">https://habr.com/ru/post/263623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263613/index.html">Modern Internet with the eyes of the blind - Headers (addition)</a></li>
<li><a href="../263615/index.html">How to turn the network itself into a complete security system?</a></li>
<li><a href="../263617/index.html">Flexible and not very software development management models. How to implement and combine in Redmine</a></li>
<li><a href="../263619/index.html">Embedded JavaScript database with an eye on API compatibility with MongoDB</a></li>
<li><a href="../263621/index.html">Microsoft Azure for Web Developer Overview</a></li>
<li><a href="../263625/index.html">Idiom Land - an application for learning English idioms</a></li>
<li><a href="../263627/index.html">Moscow Android Devs Meetup August 5</a></li>
<li><a href="../263629/index.html">Storage of hierarchical structures. Symbiosis "Closure Table" and "Adjacency List"</a></li>
<li><a href="../263631/index.html">What is internal hakaton, or Rule of five "no"</a></li>
<li><a href="../263633/index.html">Oracle Exadata, or About the Use of Engineered Systems (Part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>