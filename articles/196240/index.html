<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM3220G programming under eCos</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have one project whose idea is to create a framework for quick programming of intelligent gateways and hubs. This is when one, in general, inexpens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM3220G programming under eCos</h1><div class="post__text post__text-html js-mediator-article">  We have one project whose idea is to create a framework for quick programming of intelligent gateways and hubs.  This is when one, in general, inexpensive controller serves a group of sensors according to a certain algorithm and at the same time has a connection with the server.  Such a way to implement the <i>internet of things</i> . <br><br>  Understandably, the framework is cross-platform and should cover the maximum possible number of hardware and software platforms.  So, one of the tasks of the project is the port of the framework for eCos, and Cortex-M3 (STM32F2) was chosen as the hardware platform for this, in the implementation of the STM3220G Eval board.  I want to share the experience of mastering such a tandem. <br><br><a name="habracut"></a><br>  The choice of the operating system and hardware platform was made before I arrived at the project, i.e.  It can be considered a given. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having studied the requirements for the framework, the choice of language was clearly made - C ++.  There is a lot of controversy about using C ++ in embedded, but it‚Äôs better to write a separate article about it.  Debian GNU / Linux AMD64 is used as the main development system, for which of course there is a separate framework port. <br><br>  <i>1. eCos</i> <br><br>  eCos (I call it eXotic OS) is a configurable real-time operating system for embedded applications.  It has been developed for a long time, but it is not very common (once I saw one chart with statistics on its use - something around 3-5% of the polled users use it).  There is also a commercial option - eCosCentric, but it has not been done with it so far.  The developers of the latter, by the way, passed the port for the STM3220G Eval board.  Much has been written on the Internet. <br><br>  <i>2. Configuration of eCos for STM3220G</i> <br><br>  On the eCos website you can find links to binary versions of utilities and toolchain.  The port for STM3220G is still in the CVS repository.  Binary versions and toolchain are loaded using the <i>ecos-install.tcl</i> script.  In the case of STM32F2, the GCC port for arm-eabi is required. <br><br>  A feature of eCos is that it literally turns everything off.  Moreover, this is done by define and exotic, written by eCos developers, a configuration system that is represented by two utilities: configtool and ecosconfig.  The first has a GTK + graphical interface, the second is a console.  In our case, the configtool is used. <br><br>  You need to start the configuration by specifying the directory in which the files obtained from the CVS repository are in the configtool directory (menu Build / Repository).  After that, in the configuration templates (menu Build / Templates) the option Hardware ST STM 3220G EVAL board will appear. <br><br>  Next is a feature: you must specify the basic set of packages that will be included in the assembly of the operating system.  I‚Äôll say right away that not all the options will be able to be assembled so that an image is obtained that is ready for firmware in the controller's flash memory.  Our framework needs threads and a scheduler, and therefore choose the Kernel option.  The first option is ready - you can build the system (menu Build / Library).  In fact, the whole system is a set of header files, a static library, and instructions for the linker.  All this is collected in a separate directory utility configtool. <br><br>  Since the framework is cross-platform, it is necessary to add C library packages to the eCos assembly, all packages related to ISO C Library and POSIX Compartibility.  This will slightly increase the base image of the system, but it will allow you to write in the usual C / C ++ language, rather than invent the wheel (ie, the standard C library) again. <br><br>  In eCos, program execution does not begin with the main function as in ISO C, but with the cyg_start () functions, which adversely affects the portability of the code.  To fix this, you need to add the ISO environment startup / termination package. <br><br>  Finishing touch.  To build an image that can be written to the controller ROM, you must specify Startup type == ROM (Configuation / eCos HAL / Cortex-M Architecture / Cortex-M3 / -M4 STM32 Variant / STM32x0G-EVAL ... / Startup type).  This will allow the compiler to collect the correct instructions file. <br><br>  We execute again Build / Library, Build / Tests and that's it, you can start programming. <br><br>  <i>3. Programming for eCos</i> <br><br>  As mentioned earlier, the main language for developing the framework is C ++.  Most of the language constructs are used, including encapsulation, inheritance, polymorphism (using virtual methods), patterns, and even dynamic information about types.  Only three things were immediately excluded from the application: exceptions, dynamic memory allocation and the use of STL (although the eCos bundle has an analog library).  All this as a result significantly simplifies the life of developers, and at the same time the image of the program (including the operating system itself) does not exceed 256K (ROM) in volume, and 128K RAM is enough for normal operation. <br><br>  So, eCos provides us with a C library that is almost ISO compliant, and C ++ allows us to write code that is easy to read and maintain.  It is worth noting that in eCos there are minor inconsistencies with the standards of ISO and POSIX. <br><br>  Another feature.  To correctly compile C ++ code without using standard C ++ libraries, you must use a C-shny compiler (in our case, gcc-arm-eabi). <br><br>  <i>4. Compile and build project</i> <br><br>  To build and test the system, autoconf / automake and cmake scripts are written.  They duplicate each other as much as possible and are made to meet the needs of supporters of both autotools and cmake.  Personally, my preference is autotools, because with this example I will continue to narrate. <br><br>  To select the correct build platform (toolchain + compiler setup), it is enough to use the standard keys for the autoconf script (configure.ac file): <br><br>  $ ../configure --host = arm-eabi --prefix = $ ECOS_INSTALL_DIR CXX = gcc-arm-eabi <br><br>  at the same time, the ECOS_INSTALL_DIR variable must contain the path of the directory where the header files and the eCos library are collected (as indicated above - configured using configtool). <br><br>  In addition to these keys, the autoconf script should add keys for the linker and compiler, for example, like this: <br><br>  CFLAGS = "$ CFLAGS -ffunction-sections -fdata-sections" <br>  CXXFLAGS = "$ CXXFLAGS -ffunction-sections -fdata-sections" <br>  CPPFLAGS = "$ CPPFLAGS -I $ prefix / include -mcpu = cortex-m3 -mthumb" <br>  LDFLAGS = "$ LDFLAGS -L $ prefix / lib -Ttarget.ld -mcpu = cortex-m3 -mthumb -Wl, - gc-sections -Wl, -n -Wl, -static -nostartfiles -nostdlib" <br><br>  I can share full versions of scripts if anyone is interested. <br><br>  That's the whole configuration. <br><br>  <i>5. Preparing an image for flashing flash</i> <br><br>  The autotools / cmake build scripts allow you to get an executable file in ELF format.  It is not suitable for downloading to the controller's flash memory.  In order to get an image suitable for firmware, you must use the program objcopy: <br><br>  $ arm-eabi-objcopy -O binary &lt;your-elf-file&gt; &lt;your-image&gt; .bin <br><br>  This command can be placed in an automake script (Makefile.am file), for example, like this: <br><br>  install-exec-hook: <br>  if PLATFORM_ECOS <br>  $ (host_alias) -objcopy -O binary $ (bindir) / $ (PROGRAM_NAME) $ (EXEEXT) $ (bindir) / $ (PROGRAM_NAME) $ (EXEEXT) .bin <br>  endif <br><br>  Having done all this you can get an image ready for firmware in the controller's flash memory with a simple command: <br><br>  $ make install <br><br>  That's all. </div><p>Source: <a href="https://habr.com/ru/post/196240/">https://habr.com/ru/post/196240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196228/index.html">We are building a stand to prepare for the CCIE with the help of the IOU Web Interface</a></li>
<li><a href="../196230/index.html">The interface of the Russian Google search has undergone "optimization"</a></li>
<li><a href="../196234/index.html">Entrepreneurship in a country where many wild monkeys</a></li>
<li><a href="../196236/index.html">[Translation] cyanogenmod.org/blog - Steve Kondik - New Chapter</a></li>
<li><a href="../196238/index.html">Hideninja VPN application launch history for Android (Part 1): First prototype, first hacking In-App Purchase</a></li>
<li><a href="../196242/index.html">Is it necessary to have a higher education system administrator?</a></li>
<li><a href="../196246/index.html">An animation of ListView elements in Android</a></li>
<li><a href="../196248/index.html">Web help, web documents. Even easier</a></li>
<li><a href="../196250/index.html">Angular vs Derby. There must be only one</a></li>
<li><a href="../196254/index.html">Russian version of Developer Economics Q3 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>