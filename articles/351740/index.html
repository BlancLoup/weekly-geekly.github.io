<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Looking for the causes of database brakes using sys schema in MySQL 5.7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have a web application. Relatively large and old - a lot of code, in which a lot of different database queries. At the same time, we are not Google...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Looking for the causes of database brakes using sys schema in MySQL 5.7</h1><div class="post__text post__text-html js-mediator-article">  We have a web application.  Relatively large and old - a lot of code, in which a lot of different database queries.  At the same time, we are not Google, but several thousand requests per second to the database server are necessary. <br><br>  Well, our application certainly grows in all directions - new features are added, old ones are wrapped around and complicated, the number of clients grows and, accordingly, the amount of data in the database.  And in one not very beautiful moment comes the understanding that something our application slows down.  So it is necessary or to find out what exactly is loading the database, although it could not be loading, well, or if there is nothing like that, then take more servers, more powerful. <br><br>  The standard tip on how to find what loads MySQL is to enable the slow-query-log and see which queries will get there.  But in MySQL 5.7, by default, the best tool is present - <a href="https://dev.mysql.com/doc/refman/5.7/en/sys-schema.html">sys schema</a> , which aggregates data from the performance schema and allows you to get it with simple queries, literally like ‚ÄúOk, MySQL, show me the top queries by the maximum total execution time‚Äù <br><a name="habracut"></a><br>  First, what problems are there with using slow-query-log: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  When MySQL slows down, there are hundreds of queries that are not slow during periods of normal load - for example, we see there from time to time sampling on the primary key. </li><li>  If, for example, you put long_query_time = 3, it will not receive a request that is executed in 0.5 seconds, but there are a lot of calls. </li></ul><br>  It appeared in MySQL 5.5, and the performance schema developed in newer versions, but it is not as easy to use as we would like. <br><br>  This ends the introduction and proceeds to how to use the sys schema, and examples of what can be seen. <br><br>  First of all, if your queries are more complicated than ‚ÄúSELECT a FROM b WHERE c =?‚Äù, You should correct the restrictions on the length of the query text stored in the performance schema.  By default, it is 1024 - suddenly this is enough for you, but it turned out to be not enough for me. <br><br>  Add to my.cnf: <br><br><pre><code class="hljs">max_digest_length=10240 performance_schema_max_sql_text_length=10240 performance_schema_max_digest_length=10240</code> </pre> <br>  Variables are not dynamic, so after that you will need to restart the server.  This, of course, a minus. <br><br>  Next, we change the maximum displayed length of the text of the requests in the sys schema responses (by default it is 64 - and here I don‚Äôt understand at all who this will be enough) <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sys</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> sys_config <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-number"><span class="hljs-number">10240</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">variable</span></span>=<span class="hljs-string"><span class="hljs-string">'statement_truncate_len'</span></span>;</code> </pre><br>  Well, then you can use. <br><br>  Previously mentioned top queries for the maximum total execution time: <br><br><pre> <code class="hljs markdown">mysql&gt; select <span class="hljs-bullet"><span class="hljs-bullet">* from statement_analysis limit 10 \G *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* 1. row *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* query: SELECT <span class="hljs-code"><span class="hljs-code">`AccSettingValue`</span></span> FROM <span class="hljs-code"><span class="hljs-code">`accsetting`</span></span> WHERE <span class="hljs-code"><span class="hljs-code">`accsetting`</span></span> . <span class="hljs-code"><span class="hljs-code">`AccSettingName`</span></span> = ? db: mydb full<span class="hljs-emphasis"><span class="hljs-emphasis">_scan: exec_</span></span>count: 2065339 err<span class="hljs-emphasis"><span class="hljs-emphasis">_count: 0 warn_</span></span>count: 0 total<span class="hljs-emphasis"><span class="hljs-emphasis">_latency: 1.75 m max_</span></span>latency: 16.52 ms avg<span class="hljs-emphasis"><span class="hljs-emphasis">_latency: 50.72 us lock_</span></span>latency: 48.90 s rows<span class="hljs-emphasis"><span class="hljs-emphasis">_sent: 0 rows_</span></span>sent<span class="hljs-emphasis"><span class="hljs-emphasis">_avg: 0 rows_</span></span>examined: 0 rows<span class="hljs-emphasis"><span class="hljs-emphasis">_examined_</span></span>avg: 0 rows<span class="hljs-emphasis"><span class="hljs-emphasis">_affected: 0 rows_</span></span>affected<span class="hljs-emphasis"><span class="hljs-emphasis">_avg: 0 tmp_</span></span>tables: 0 tmp<span class="hljs-emphasis"><span class="hljs-emphasis">_disk_</span></span>tables: 0 rows<span class="hljs-emphasis"><span class="hljs-emphasis">_sorted: 0 sort_</span></span>merge<span class="hljs-emphasis"><span class="hljs-emphasis">_passes: 0 digest: 229c950384bddbaa0e537f54beaa1ac4 first_</span></span>seen: 2018-03-19 20:20:43 last_seen: 2018-03-21 12:27:21</code> </pre><br>  Using the example of this query, we see that the% _latency values ‚Äã‚Äãare returned in a human-readable form, which is convenient for reading the result, but inconvenient if you want to sort by it.  For this, all tables in the sys schema have twins of the form x $ table_name. <br><br>  A selection of queries sorted by avg_latency, creating temporary tables on the disk, will look something like this: <br><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> x$statement_analysis <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> tmp_disk_tables &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> avg_latency <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> \G</code> </pre><br>  A couple more examples of what's useful can be seen using sys schema. <br><br>  Requests, the average execution time of which is in the top 5%: <br><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> statements_with_runtimes_in_95th_percentile <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G</code> </pre><br>  Queries that create temporary tables: <br><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> statements_with_temp_tables <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G</code> </pre><br>  Requests that make a full table scan <br><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> statements_with_full_table_scans <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G</code> </pre><br>  Unused indexes (the server should work for a sufficiently long time so that this data can be trusted): <br><br><pre> <code class="hljs pgsql">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> schema_unused_indexes <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre><br>  This is what was most useful for me personally, if you are interested - detailed documentation and usage examples are <a href="">on github</a> or in the <a href="https://dev.mysql.com/doc/refman/5.7/en/sys-schema-views.html">official documentation</a> . </div><p>Source: <a href="https://habr.com/ru/post/351740/">https://habr.com/ru/post/351740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351730/index.html">Why inheritance has always been meaningless</a></li>
<li><a href="../351732/index.html">Intelligent Word Processing</a></li>
<li><a href="../351734/index.html">Erlang, rebar3 and installation of service under Windows</a></li>
<li><a href="../351736/index.html">Bagodilnya - marathon for killing the elderly bugs</a></li>
<li><a href="../351738/index.html">Description of the prototype of my game multiplayer server</a></li>
<li><a href="../351744/index.html">Amazon Lambda with Golang</a></li>
<li><a href="../351746/index.html">Tutu PHP Meetup # 1</a></li>
<li><a href="../351748/index.html">Create iOS stopwatch on React-Native (subtitles)</a></li>
<li><a href="../351750/index.html">Angular. Recursive component</a></li>
<li><a href="../351752/index.html">Blockchain on Go. Part 4: Transactions, Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>