<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kaggle: Allstate Claims Severity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to describe the solution to the recent Allstate Claims Severity machine learning competition. (My result is 40 of 3055). Since this is a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kaggle: Allstate Claims Severity</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/768/440/3eb/7684403ebe27422a9da00856286cc365.png" width="400"></div><br>  I would like to describe the solution to the recent <a href="https://www.kaggle.com/c/allstate-claims-severity">Allstate Claims Severity</a> machine learning competition.  (My result is 40 of 3055).  Since this is a competition of the ‚Äúensemble Rubilovo‚Äù type, as a rule, the discussion of decisions causes unhealthy holy wars between those who have tried to participate and those who have not, so first I will make a small lyrical digression. <br><a name="habracut"></a><br>  I apologize in advance for the abundance of English words.  I don‚Äôt know how to translate some, but I don‚Äôt want to translate some. <br><br>  I like to think of machine learning as three little connected directions, which I tried to depict in the picture above, and each of these directions pursues its own goals. <br><br>  For example, in an academic environment, your productivity, and indeed personal steepness, is measured by the number and quality of published articles - and here the novelty of ideas is important, but how far these ideas can be put into practice right now is the tenth thing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In business, how much money your models bring to the company, and here interpretability, scalability, speed, model size and so on are important. <br><br>  In competitive machine learning, the challenge is to win everyone.  That is, the model will be non-scalable, and it should be trained for weeks - this is acceptable. <br><br>  In the overwhelming majority of cases when a company provides data for a competition, the models with the best accuracy in production are not available due to their complexity.  (A classic example is the Netflix prize competition on which the best models do not apply, but the knowledge gained by the participants while working on a problem definitely gave impetus to research towards recommender systems.) And, as a result, among those who did not try to participate in machine learning is an opinion that the models that were obtained in the framework of the competition are useless.  And they, of course, are right.  But this audience immediately concludes that the knowledge gained during participation in competitions is also useless, and that only those who cannot find a ‚Äúreal‚Äù job and who have time for this ‚Äúuseless exercise‚Äù take part in the competition .  For example, my colleague in the last work, by the name of Alex, whom I discussed in this <a href="https://habrahabr.ru/post/310776/">post</a> , thought so. <br><br>  There is an opposite extreme: those who show quite good results at competitions think that they will easily spew models out of themselves, which will immediately make great money in Production, which theoretically could happen, but in practice I did not come across.  Still, the accuracy of the model on the train set, test set and in production are three big differences. <br><br>  I prefer thinking machine learning in business vs competitions as about climbing up vs climbing.  If you pull up many times - this does not mean that you are a good climber, but at the same time pulling up helps to climb to some extent and good climbers often invest time to pull up better, while not just pulling up, but pulling up with weights , pull-ups on campusboard, with arms at different heights, etc. <br><br>  Machine learning competitions work in a similar mode in the sense that if you are a Machine Learning Engineer or Data Scientist and you cannot offer something worthwhile in competitions, then perhaps it makes sense to invest some time in it.  Moreover, there are a lot of competitions, they are different and something from some kind of competition can be useful for you at work or for science.  At least the guys from Google, Deepmind, Facebook, Microsoft, and other serious companies periodically participate.  Yes, and cases where good performance at competitions helped to find a decent job more than enough. <br><habracut><br><h2>  Task Description </h2><br>  Allstate has provided data for the competition at <a href="https://www.kaggle.com/">Kaggle.com</a> not for the first time and, apparently, they like it.  This time the prize at the competition - the recruiter Allstate, may force yourself to spend 6 seconds on your resume if you apply for the Junior Data Scientist position.  Despite the fact that the prize is about nothing, the competition attracted more than three thousand participants, which made it a unique storehouse of specific knowledge. <br><br>  The task was to create a model that would predict the amount of payment for the insured event.  In general, as usual, the insurance company wants to predict who does not need insurance - and it is for them to sell it, and who may fall under the insurance case - they don‚Äôt sell or sell high. <br><br>  The target variable has this asymmetric distribution: <br><img src="https://habrastorage.org/files/d5d/0c9/990/d5d0c999025d49a9ae43606d250003d4.png"><br>  Where: <br><br><ul><li>  min = 0.67 </li><li>  max = 121012 </li><li>  mean = 3037 </li></ul><br><br>  Results were evaluated by the Mean Absolute Error metric <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aac/c3f/85f/aacc3f85ffaf72267b1ff89062462c32.gif" alt="image"><br><br>  Anonymized data.  14 numerical and 116 categorical signs. <br><br><ul><li>  Train set - 188318 rows </li><li>  Test test - 125546 rows </li></ul><br>  As usual, to prevent overfitting, the test set was divided into 2 parts: <br><br><ul><li>  30% test set - Public Leaderboard - the accuracy of your model on this part could be checked during the entire competition.  (5 attempts per day) </li><li>  70% test set - Private Leaderboard - the accuracy on this part of the test set becomes known after the end of the competition and it is this that is ultimately used to evaluate your model. </li></ul><br>  That is, there is little data, and a good result can be obtained on low-powered machines without using cloud computing, for example, on laptops, which in many respects caused a large number of participants. <br><br>  The level of models / participants' knowledge can be <b>very conditionally</b> divided into such categories, where the number is an approximate error on the Public LeaderBoard. <br><br><ul><li>  <b>1300+</b> - those who know the basics of machine learning can prepare data, train linear regression and make a prediction.  16% of participants </li><li>  <b>1200-1300</b> - those who know something other than linear regression.  28% of participants. </li><li>  <b>1200-1120</b> - those who know that xgboost / LightGBM exists, but they are not good at tuning it.  9% of participants. </li><li>  <b>1110-1120</b> - those who can configure xgboost or neural networks.  22% of participants </li><li>  <b>1104-1110</b> - those who know that the arithmetic average of xgboost predictions and neural networks is more accurate than each of the predictions separately.  11% of participants. </li><li>  <b>1102-1104</b> - those who are able to build more complex linear combinations.  6% of participants. </li><li>  <b>1101-1102</b> - those who know how to use stacking.  5% of participants. </li><li>  <b>1096-1101</b> are serious guys.  3% of participants. </li></ul><br>  This gradation is very conditional, at least because of the large number of participants and the ridiculousness of the prize.  That is, the public actively shared ideas and code and, for example, there were <a href="https://www.kaggle.com/c/allstate-claims-severity/forums/t/25609/easy-way-to-get-score-1105-05-on-leaderboard">branches on the forum</a> where it was discussed step by step what needs to be done to make 1102. As a result, as was correctly <a href="https://www.kaggle.com/c/allstate-claims-severity/forums/t/25705/that-weird-feeling%3FforumMessageId%3D146246">noticed by</a> <a href="https://www.kaggle.com/lyubap">Love Bubbly</a> , this competition was similar to <a href="https://en.wikipedia.org/wiki/Red_Queen%27s_race">Red Queen's race</a> when you need to improve your models. every day only in order not to crawl down on the LeaderBoard, for 1102+ could be obtained by running and sedating the results of the predictions of someone else's code, which, in general, is rather low style, but it‚Äôs better than that.  It is also necessary to be able to average correctly. <br><br><h2>  Ideas </h2><br><h3>  Idea one </h3><br>  The target variable is highly asymmetric.  In this case, machine learning algorithms work better on symmetric data.  Some like the target variable to have a normal distribution, some not.  In this case, the statement that can be found in the literature that the more symmetrical the target variable is, the better, in this case it is not true.  Standard ways to increase symmetry - logarithm, exponentiation. <br><br><img src="https://habrastorage.org/files/0e0/e26/823/0e0e26823073408d81d4172a6466c534.png"><br><br>  That is, we want something more symmetrical than what was originally, but, since our target MAE metric is from an untransformed target variable, we want an error during training on large values, like 120,000, to be more than 100, but not 1200 times.  And the correct transformation is the one that translates the target variable into something symmetrical, but with a thick right tail.  For example, the fourth degree root has shown itself very worthy of me, better than the logarithm. <br><br><h3>  Second idea </h3><br>  This is a competition: <br><br><ul><li>  on data of mixed type that do not have a local structure </li><li>  size of training data 10 ^ 4 - 10 ^ 7 </li></ul><br>  This is the type and volume on which in 95% of cases xgboost has no competitors.  What happened here. <br><br><img src="https://habrastorage.org/files/20a/3c9/efe/20a3c9efe4fc4cea8575db0ec5cd7220.png"><br>  On this graph, the top 30 most important signs. <br><br>  <a href="https://www.kaggle.com/mmueller">Mathias M√ºller</a> obtained <b>1109</b> using xgboost on the original data, which corresponds to the top 25%.  (As a result, he finished the competition third) <br><br><h3>  Idea three </h3><br>  How to find good hyperparameters?  There are several methods: <br><br><ol><li>  Manually. </li><li>  GridSearch - set the grid and check everything or some subset of parameters. </li><li>  More intelligent methods like <a href="https://github.com/hyperopt/hyperopt">Hyperopt</a> or <a href="https://github.com/fmfn/BayesianOptimization">BayesianOptimization</a> </li></ol><br>  In practice, BayesianOptimization has done well to find good candidates + manual spin. <br><br>  What ranges of parameters to check?  God knows.  I believed that they write in the literature that the structure of the algorithm based on gradient boosting is such that it makes no sense to use trees with a depth of more than 10.  They lie.  In most cases it is, but this is not enough on this data.  The best models used deeper trees, up to max_depth = 25. <br><br><h3>  Fourth idea </h3><br>  Since MAE is not twice differentiable, it is possible to approximate the module as ln (cosh), which is already twice differentiable, and now it is possible to use not the root-mean-square error for the loss function, but something more interesting.  And there was a <a href="https://www.kaggle.com/c/allstate-claims-severity/forums/t/24520/effect-of-mae">forum thread</a> on which it was actively discussed. <br><img src="https://habrastorage.org/files/7b0/821/535/7b0821535a4c4c9c82f1736c8885439f.png"><br><br><h3>  Idea five </h3><br>  There is an opinion that for algorithms that are based on the decision tree, it is not important how to convert categorical signs into numerical ones.  And that in all other algorithms except for one hot encoding nothing can not be used.  And that, and another statement from the point of view of business - however, from the point of view of competition and the academic environment - is a blatant lie.  There is a difference, but it is small.  You can try different encoding and see what works best.  For example, for some categorical features, the lexicographic encoding worked a little better, allowing you to reduce the number of splits in each tree. <br><br><h3>  Idea six </h3><br>  There is an opinion that tree-based algorithms find interactions between features.  It is not true.  They approximate them.  From a business point of view, they are the same thing.  In terms of competition - no.  Therefore, if you take the top as many of the most important signs from the image above and create new signs that will describe their interactions, then the accuracy of some models increases, which was suggested in one of the <a href="https://www.kaggle.com/modkzs/allstate-claims-severity/lexical-encoding-feature-comb">scripts</a> .  And it allowed someone to reach <b>1103</b> with xgboost.  (My best score is 1104) <br><br><h3>  Idea Seven </h3><br>  What about feature engineering?  Correct signs in most cases (but not always) will give more than clever numerical methods.  In preparing the data, Allstate did a very decent job, and despite the efforts of the participants, it was not possible to de-anonymize anything properly.  It seems they understood that one of the signs is the state.  And that any signs somehow relate to dates.  But as far as I know none of this fished out.  Statistical signs, too, no one really use failed.  I still added time zones, and statistical signs for the most important categorical ones, but this is more likely to calm my conscience. <br><br>  Here, for example, the sign diff cont2 vs cont2. <br><img src="https://habrastorage.org/files/ee9/4df/3de/ee94df3de0e94effaaf63ddeb47f04f8.png"><br>  In theory, this should tell us what kind of transformation Allstate applied to the cont2 feature, but no matter how hard I could figure out how to find this transformation. <br><br><h3>  Idea eight </h3><br>  To get a better result, <b>1102</b> needs stacking.  This is such a competent technique that is used in every second competition, but as far as I know, it is used extremely rarely in production.  She does not give much.  But the use of stacking allows you to cleverly cross different models.  Actually, before participating in this competition, I did not own this technique, but only heard the edge of my ear, and the main motivation for participation was to sort out and close this question for myself. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/feb/411/a50/feb411a509ea24bd62e4359546bcc97d.gif" alt="image"><br><br>  The idea is that for each model we want to make a prediction on the train set and on the test set, while we do not want to predict on the train on the same data that was used for training.  Here <a href="https://www.kaggle.com/mmueller/allstate-claims-severity/stacking-starter">'s a python example of</a> how to do this. <br><br>  And as a result, for each model we will have a prediction on the train, and corresponding to the test.  Why is this necessary?  We repeat this for different models and combine the predictions into a new train and test set.  With signs: <br><br><ol><li>  train: {prediction_xgboost, prediction_NN, prediction_SVM, etc} </li><li>  test: {prediction_xgboost, prediction_NN, prediction_SVM, etc} </li></ol><br>  And now we can forget about the original training and test data and train the second level already on this new data using linear or nonlinear methods. <br><br>  Moreover, we can repeat this procedure several times using the predictions from the previous step as features for the next.  In one of the past competitions the final decision looked like: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/941/90b/8b5/94190b8b55c8d8e664fc65c04cd986ea.png" alt="image"><br><br>  Actually such dense decisions and cause rejection of those who think about machine learning solely from the point of view ‚ÄúHow much value can I bring to the company?‚Äù, Because in practice they are not applicable, although there are companies that are trying to automate this process. <br><br><h3>  Idea nine </h3><br>  We made a prediction using stacking.  Can it be improved?  Can.  Tree-based algorithms underestimate large values ‚Äã‚Äãand overestimate small ones, so the final prediction can be calibrated.  A popular transformation that some participants used is: <br>  <b>alpha * prediction ^ beta</b> , and someone even did it for different quantiles. <br><br><h2>  Conclusion </h2><br>  Actually, that's all.  Many different models are being trained (xgboost, Neural Networks, Random Forest, Ridge Regression, Extra Trees, SVR, LightGBM) with various hyper-parameters on the data, which are converted by various methods in stacking mode.  And then, on predictions from all these models, the Neural Network is trained with a pair of hidden layers in order to get a final result. <br><br>  Everything is quite simple and straightforward, but at the same time to achieve this, a certain effort was required.  Moreover, experienced participants it was easier than inexperienced.  Let's hope that in another problem, where similar techniques can be used, the sacred knowledge gained here will somehow help. <br><br>  Those who have not tried to participate in competitions, I strongly recommend. <br><br>  If you use machine learning at work, then God himself told you to check how much your knowledge and skills gained at work are applicable in the world of Competitive Machine Learning, and it is possible that something you may learn during the competition and it can it will come in handy at work so that you can ‚Äúbring value to the company‚Äù.  For example, I convinced the boss to do a couple of submissions at a recent competition.  He flew to the bottom 10 percent of LeaderBoard (he went angry and then thought a lot) because he used different encoding for train and test.  After that, his policy at work changed and we began to spend a little more time on testing. <br><br>  If you are still a student - God himself ordered to participate.  If five years ago I had the same data-handling skills, my postgraduate research would have been more effective and I would have published more articles.  Plus, good results from competitions in which the workhorse is neural networks can almost certainly be published.  And as a piece of diploma can be precisely inserted. <br><br>  If you are thinking about a gradual transition to Data Science - again, God himself ordered you to participate.  Competition alone is not enough for you to be hired, but in combination with education and experience in other areas should help.  That year, the guy in DeepMind was invited after one of the competitions, so the cases are different. <br><br>  Not all tasks are so focused on numerical methods.  A recent <a href="https://www.kaggle.com/c/santander-product-recommendation">product prediction</a> competition <a href="https://www.kaggle.com/c/santander-product-recommendation">for various users of Santander Bank in Spain</a> is pure feature engineering.  It is a pity that I spent little time with him.  Or competitions that are currently being held on Computer Vision, neural networks and other currently fashionable words: <br><br><ol><li>  <a href="https://www.kaggle.com/c/the-nature-conservancy-fisheries-monitoring">Pro Fish</a> - $ 150,000 prize </li><li>  <a href="https://www.kaggle.com/c/dstl-satellite-imagery-feature-detection">About satellite maps</a> - $ 100,000 prize </li><li>  <a href="https://www.kaggle.com/c/data-science-bowl-2017">Pro Cancer</a> - $ 1,000,000 Prize </li></ol><br>  Interestingly, a lot of knowledge, beautiful pictures, and who are lucky enough and will give money. <br><br>  And since this is Habr and here they love code - <a href="https://github.com/ternaus/kaggle_allstate/tree/10fold">unstructured code, which I wrote for this task</a> . <br><br>  <a href="https://ternaus.github.io/allstate/">English translation</a> </habracut></div><p>Source: <a href="https://habr.com/ru/post/318518/">https://habr.com/ru/post/318518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318504/index.html">Modern approach to garbage collection</a></li>
<li><a href="../318508/index.html">Little known Git commands</a></li>
<li><a href="../318510/index.html">Code review in distributed team</a></li>
<li><a href="../318512/index.html">Do sites fall on holidays more often than usual? Myths, reality and how to protect yourself</a></li>
<li><a href="../318514/index.html">Radiant Chinese machine and painting machine to them. Frankenstein</a></li>
<li><a href="../318520/index.html">How I learned not to worry and fell in love with microservices, part 1: The effects of bad code</a></li>
<li><a href="../318522/index.html">How to update the kernel in the system without restarting the services (step-by-step instruction)</a></li>
<li><a href="../318524/index.html">Experience in using self-hosted continuous integration systems</a></li>
<li><a href="../318526/index.html">Machine learning as a new business analysis tool</a></li>
<li><a href="../318528/index.html">How the new design of the PVS-Studio code analyzer developers' website viva64.com was made</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>