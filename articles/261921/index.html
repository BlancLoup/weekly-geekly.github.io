<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL and btrfs - an elephant on an oily diet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, looking at an article on the wiki about file systems, I became interested in btrfs, namely its rich features, stable status and, most import...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL and btrfs - an elephant on an oily diet</h1><div class="post__text post__text-html js-mediator-article">  Recently, looking at <a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems">an article on the wiki</a> about file systems, I became interested in btrfs, namely its rich features, stable status and, most importantly, the mechanism of transparent data compression.  Knowing how easy it is to keep databases containing textual information, I was curious to clarify how much this is applicable in a use case such as postgres. <br><br>  Of course, this testing cannot be called complete, since only reading and that linear is involved.  But the results are already forced to reflect on the possible transition to btrfs in certain cases. <br><br>  But the main goal is to find out the opinion of the community about how reasonable this is and what pitfalls can be concealed in the approach of transparent compression at the file system level. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who do not want to waste time, I will immediately tell you about the findings.  The PostgreSQL database hosted on btrfs with the compress = lzo option reduces the database size by two (compared to any FS without compression) and when using multi-threaded, sequential reading, significantly reduces the load on the disk subsystem. <br><a name="habracut"></a><br><h4>  So, what is available </h4><br>  Physical server - 1 pc <br><ul><li>  CPU: 2 Sockets for 6 cores </li><li>  RAM: 48 GB </li><li>  Storage: <ul><li>  2x - SAS 10K 300GB in configuration RAID 1 + 0 - for OS and main postgres db </li><li>  2x - SAS 10K 300GB in RAID 1 + 0 configuration - for tests </li></ul></li><li>  OS: Ubuntu 04/14/2 - 3.16.0-41 </li><li>  PG: 9.4.4 x86_64 </li></ul><br><h4>  Testing method </h4><br>  So, we have a physical machine with 2 disks: the first postgres database (which is after initdb) is stored on the first one, and the second disk is fully formatted into test files (ext4, btrfs lzo / zlib) without creating markup on it. <br><br>  The test disk is placed on the table space from the backup copy, which participates in the testing, made using pg_basebackup.  The main postgres db is also restored. <br><br>  The essence of testing lies in sequential reading of five tables - clones in five streams. <br><br>  The script is extremely simple and is the usual ‚Äúexplain analyze‚Äù. <br><br>  Each table has a size of 13GB, total volume ~ 65GB. <br><br>  Data for graphs is taken from sar with the simplest parameters: "sar 1" - CPU ALL;  "Sar -d 1" - I / O. <br><br>  Before each launch, reset the pagecache with the command: <br><br><pre><code class="bash hljs">free &amp;&amp; sync &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 3 &gt; /proc/sys/vm/drop_caches &amp;&amp; free</code> </pre> <br>  We check the completion of background processes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sa.pid, sa.state, sa.query <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity sa;</code> </pre><br><h4>  Numbers </h4><br><h5>  Dimensions </h5><br><table><tbody><tr><th>  FS </th><th>  Size in DB </th><th>  Disk size </th><th>  Compression factor </th></tr><tr><td>  btrfs-zlib </td><td>  156GB </td><td>  35GB </td><td>  4.4 </td></tr><tr><td>  btrfs-lzo </td><td>  156GB </td><td>  67GB </td><td>  2.3 </td></tr><tr><td>  ext4 </td><td>  156GB </td><td>  156GB </td><td>  one </td></tr></tbody></table><br><h5>  Explain analyze </h5><br><table><tbody><tr><td>  btrfs-zlib </td><td>  302000 ms </td></tr><tr><td>  btrfs-lzo </td><td>  262000 ms </td></tr><tr><td>  ext4 </td><td>  420000 ms </td></tr></tbody></table><br><h5>  Charts </h5><br><div class="spoiler">  <b class="spoiler_title">CPU load</b> <div class="spoiler_text"><table><tbody><tr><td>  btrfs-zlib </td><td><img src="https://habrastorage.org/files/441/59c/072/44159c07259d450a9e09e0f1ab59fa7a.png"></td></tr><tr><td>  btrfs-lzo </td><td><img src="https://habrastorage.org/files/abc/39b/621/abc39b62167941d4bf237491e5e33fdd.png"></td></tr><tr><td>  ext4 </td><td><img src="https://habrastorage.org/files/1f4/75d/553/1f475d553e7e43898b5309f02059e660.png"></td></tr></tbody></table><br></div></div><br><div class="spoiler">  <b class="spoiler_title">IO Block Transfer</b> <div class="spoiler_text"><table><tbody><tr><td>  btrfs-zlib </td><td><img src="https://habrastorage.org/files/153/857/1fb/1538571fbe604afeb8bdd2999f3b7a17.png"></td></tr><tr><td>  btrfs-lzo </td><td><img src="https://habrastorage.org/files/4d9/099/67f/4d909967f1724a3c8869b04b9d1fac8f.png"></td></tr><tr><td>  ext4 </td><td><img src="https://habrastorage.org/files/418/306/8f2/4183068f266f4244bbfcdd0acf9f4c74.png"></td></tr></tbody></table><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Io wait</b> <div class="spoiler_text"><table><tbody><tr><td>  btrfs-zlib </td><td><img src="https://habrastorage.org/files/9a8/538/8ff/9a85388ff69347fe967d568c99c35b26.png"></td></tr><tr><td>  btrfs-lzo </td><td><img src="https://habrastorage.org/files/a34/de7/dc3/a34de7dc33844938acfd0c736ac51380.png"></td></tr><tr><td>  ext4 </td><td><img src="https://habrastorage.org/files/95d/6a1/1fb/95d6a11fb26f446cbdf53bc594e8a77a.png"></td></tr></tbody></table><br></div></div><br><h4>  Conclusion </h4><br>  As can be seen from the graphs, compression with the lzo algorithm gives only an insignificant load on the CPU, which, coupled with a 2-fold decrease in the volume of occupied space and some acceleration, makes this approach extremely attractive.  Zlib presses our database 4 times, but at the same time, the load on the processor increases significantly (~ 7.5% of processor time), which is also quite acceptable for certain scenarios.  However, btrfs has only recently acquired the status of stable (since kernel 3.10) and it is possible to introduce it into the production environment prematurely.  On the other hand, the presence of a synchronous replica solves this question. <br><br><h4>  PS </h4><br>  As far as I know, zlib and, probably, lzo use instructions from SSE 4.2, which reduces processor utilization and it is quite possible that in some virtualization environments, high processor utilization will prevent you from taking advantage of the compression. <br><br>  If someone tells me how to influence this, then I will try to double-check the difference with and without hardware acceleration. </div><p>Source: <a href="https://habr.com/ru/post/261921/">https://habr.com/ru/post/261921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261905/index.html">UITableView: add icon to UITableViewRowAction</a></li>
<li><a href="../261907/index.html">Convenient structure of the iOS project</a></li>
<li><a href="../261909/index.html">Introducing the Freescale T1040RDB debug card for industrial network switches</a></li>
<li><a href="../261911/index.html">Own JS Wrapper for Uppod Player</a></li>
<li><a href="../261913/index.html">Network security Instead of introducing</a></li>
<li><a href="../261923/index.html">Cezurity's little antivirus test</a></li>
<li><a href="../261925/index.html">Automatic detection of vulnerabilities: description and statistics</a></li>
<li><a href="../261927/index.html">DirectX rendering in WPF window</a></li>
<li><a href="../261931/index.html">Lines and probability theory</a></li>
<li><a href="../261935/index.html">Qihoo 360 and Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>