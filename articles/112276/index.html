<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The consequences of using Copy-Paste technology when programming in C ++ and how to deal with it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am creating a PVS-Studio analyzer that detects errors in the source code of C / C ++ / C ++ 0x applications. In this regard, I have to look through ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The consequences of using Copy-Paste technology when programming in C ++ and how to deal with it</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/29c/daa/ac3/29cdaaac381484e7616b232e96cb39b4.jpg" alt="Copy-Paste, Ctrl-C, Ctrl-V"><br>  I am creating a <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> analyzer that detects errors in the source code of C / C ++ / C ++ 0x applications.  In this regard, I have to look through a large amount of source code of various applications, where with the help of PVS-Studio, suspicious areas of code were detected.  I have accumulated enough examples in which it can be clearly seen when the error came into being due to copying a section of code and its modification.  Of course, this is not a new idea that using Copy-Paste when programming is bad.  However, try not to get off with the recommendation ‚Äúdo not copy the code‚Äù and approach this topic more closely. <br><a name="habracut"></a><br><br>  Usually when people talk about Copy-Paste in programming, they mean the following situation.  A function or a large code fragment is copied entirely, and then the copied code is modified.  Such actions create a large number of similar code in the program, which makes it difficult to maintain it.  You have to change the same fragments of the algorithm in different functions and it is very easy to forget to fix something. <br><br>  In this case, it is really appropriate to say that it is better not to copy the code.  If you want to create a function with similar behavior, it is useful to perform refactoring and isolate the common code into separate methods / classes [1].  Or use templates and lambda functions.  We will not consider in more detail how to avoid duplication of the code, since this does not apply to the main issue.  The main thing is to avoid duplication of code in various functions.  A lot has been written about this and most programmers are familiar with useful recommendations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's focus now on the moment that is usually silent in the books and articles on writing high-quality code.  In fact, it is impossible to program without Copy-Paste.  It's like sex in the Soviet Union.  He is not there, but everyone does it. <br><br>  We all copy small pieces of code when we need to write something like this: <br><br><pre>  GetMenu () -&gt; CheckMenuItem (IDC_ LINES_X, MF_BYCOMMAND | nState);
 GetMenu () -&gt; CheckMenuItem (IDC_ LINES_Y, MF_BYCOMMAND | nState); </pre><br>  Admit yourself honestly that we are too lazy to type a line that differs only in the fact that instead of the character 'X' we will have to write the character 'Y'.  And this is correct and logical.  Copying and editing will be faster than typing the second one again, even with the use of special tools such as Visual Assist and IntelliSence. <br><br>  At the same time, there is no point in talking about code duplication.  How not to think, it is easier to write here.  Similar examples can be given a huge amount, taking any program.  I do not like the fact that here the example concerns the GUI, and in other tasks we will encounter a similar one: <br><br><pre>  int texlump1 = Wads.CheckNumForName ("TEXTURE1", ns_global, wadnum);
 int texlump2 = Wads.CheckNumForName ("TEXTURE2", ns_global, wadnum); </pre><br>  The trouble is that with this ‚Äúmicrocopying‚Äù the probability of an error is also quite high.  And since such small copies of the code are much more than copies of large blocks, this is a really important problem.  How to deal with this problem is not clear, so they try to keep silent about it.  You can not prevent programmers from copying code.  This is insanity. <br><br>  Many of these errors are detected at the first launch of the program and are quickly and painlessly corrected.  But many remain and live in the code for years, waiting in the wings.  It is difficult to detect such errors in the code, since it is difficult to look at similar lines of code and a person‚Äôs attention is quickly dulled.  At the same time, the presence of errors caused by Copy-Paste is practically independent of the professionalism of the programmer.  Anyone can be sealed and view something.  Defects of this kind come across even in very well-known and high-quality software products. <br><br>  To better clarify what kind of errors we are talking about, let's look at a few code examples taken from open-source projects.  As an advertisement: the errors listed here were detected by me using <a href="http://www.viva64.com/ru/general-analysis/">a general-purpose analyzer</a> included in PVS-Studio [ <a href="http://www.viva64.com/ru/pvs-studio-presentation/">2</a> ]. <br><br>  The code is taken from a sound recording and editing program - <a href="http://www.viva64.com/go.php%3Furl%3D438">Audacity</a> . <br><br><pre>  sampleCount VoiceKey :: OnBackward (...) {
   ...
   int atrend = sgn (
     buffer [samplesleft - 2] -buffer [samplesleft - 1]);                          
   int ztrend = sgn (
     buffer [samplesleft - WindowSizeInt-2] -
       buffer [samplesleft - WindowSizeInt-2]);
   ...
 } </pre><br>  The programmer courageously and correctly wrote the initialization of the variable 'atrend'.  Began to write the initialization of the variable 'ztrend'.  Wrote "sgn (buffer [samplesleft - WindowSizeInt-2]". Then he sighed and copied a piece of string. He forgot to edit. As a result, the 'sgn' function will take the value 0 as an argument. <br><br>  The next scenario will be similar.  A programmer writes a long condition in <a href="http://www.viva64.com/go.php%3Furl%3D439">Crystal Space</a> 3D SDK: <br><br><pre>  inline_ bool Contains (const LSS &amp; lss)
 {
   // We check the LSS contains the two 
   // spheres at the start and end of the sweep
   return
     Contains (Sphere (lss.mP0, lss.mRadius)) &amp;&amp; 
     Contains (Sphere (lss.mP0, lss.mRadius));
 } </pre><br>  Here I just want to copy ‚ÄúContains (Sphere (lss.mP0, lss.mRadius))‚Äù and replace the name 'mP0' with 'mP1'.  But it is so easy to accidentally forget to do. <br><br>  Probably, you sometimes noticed that the program windows suddenly suddenly start behaving in a strange way.  For example, many programmers will remember the search box in the first edition of Visual Studio 2010. I think such oddities happen because of a lucky combination of circumstances and code like this: <br><br><pre>  void COX3DTabViewContainer :: OnNcPaint () 
 {
   ...
   if (rectClient.top &lt;rectClient.bottom &amp;&amp;
      rectClient.top &lt;rectClient.bottom)
   {
     dc.ExcludeClipRect (rectClient);
   }
   ...
 } </pre><br>  This code is taken from the well-known <a href="http://www.viva64.com/go.php%3Furl%3D427">Ultimate ToolBox</a> class set.  Normally it will be drawn control or not, will depend on its location. <br><br>  And in the <a href="http://www.viva64.com/go.php%3Furl%3D440">eLynx</a> Image Processing SDK copied a whole line, and this replicated a typo. <br><br><pre>  void uteTestRunner :: StressBayer (uint32 iFlags)
 {
   ...
   static EPixelFormat ms_pfList [] = 
     {PF_Lub, PF_Lus, PF_Li, PF_Lf, PF_Ld};
   const int fsize = sizeof (ms_pfList) / sizeof (ms_pfList);

   static EBayerMatrix ms_bmList [] = 
     {BM_GRBG, BM_GBRG, BM_RGGB, BM_BGGR, BM_None};
   const int bsize = sizeof (ms_bmList) / sizeof (ms_bmList);
   ...
 } </pre><br>  Because of the forgotten pointer dereference, the variable 'fsize' is equal to 1. And then this code was adapted to initialize 'bsize'.  I do not believe that it is possible to make a mistake two times in a row, if you do not copy the code. <br><br>  In the <a href="http://www.viva64.com/go.php%3Furl%3D441">EIB Suite</a> project, the line ‚Äúif (_relativeTime &lt;= 143)‚Äù was copied and edited.  But in the latter, the condition for changing it was forgotten: <br><br><pre>  string TimePeriod :: toString () const
 {
   ...
   if (_relativeTime &lt;= 143)
     os &lt;&lt; ((int) _relativeTime + 1) * 5 &lt;&lt; _ ("minutes");
   else if (_relativeTime &lt;= 167)
     os &lt;&lt; 12 * 60 + ((int) _relativeTime - 143) * 30 &lt;&lt; _ ("minutes");
   else if (_relativeTime &lt;= 196)
     os &lt;&lt; (int) _relativeTime - 166 &lt;&lt; _ ("days");
   else if (_relativeTime &lt;= 143)
     os &lt;&lt; (int) _relativeTime - 192 &lt;&lt; _ ("weeks");
   ...
 } </pre><br>  So the code "os &lt;&lt; (int) _relativeTime - 192 &lt;&lt; _ (" weeks ");"  never get control. <br><br>  Even programmers at Intel are also programmers, not demigods.  Failed to copy in <a href="http://www.viva64.com/go.php%3Furl%3D442">TickerTape</a> project: <br><br><pre>  void DXUTUpdateD3D10DeviceStats (...)
 {
   ...
   else if (DeviceType == D3D10_DRIVER_TYPE_SOFTWARE)
     wcscpy_s (pstrDeviceStats, 256, L "WARP");
   else if (DeviceType == D3D10_DRIVER_TYPE_HARDWARE)
     wcscpy_s (pstrDeviceStats, 256, L "HARDWARE");
   else if (DeviceType == D3D10_DRIVER_TYPE_SOFTWARE)
     wcscpy_s (pstrDeviceStats, 256, L "SOFTWARE");
   ...
 } </pre><br>  The ‚ÄúDeviceType == D3D10_DRIVER_TYPE_SOFTWARE‚Äù condition is repeated twice. <br><br>  In general, in the thickets of conditional statements is very easy to see the error.  In the implementation of <a href="http://www.viva64.com/go.php%3Furl%3D443">Multi-threaded Dynamic Queue</a> , regardless of what the IsFixed () function returns, we will do the same thing: <br><br><pre>  BOOL CGridCellBase :: PrintCell (...)
 {
   ...
   if (IsFixed ())
     crFG = (GetBackClr ()! = CLR_DEFAULT)?
       GetTextClr (): pDefaultCell-&gt; GetTextClr ();
   else
     crFG = (GetBackClr ()! = CLR_DEFAULT)?
       GetTextClr (): pDefaultCell-&gt; GetTextClr ();
   ...
 } </pre><br>  By the way, copying the code is easy and pleasant!  It is not a pity to write an extra point.  :) <br><br><pre>  void RB_CalcColorFromOneMinusEntity (unsigned char * dstColors) {
   ...
   unsigned char invModulate [3];
   ...
   invModulate [0] = 255 - backEnd.currentEntity-&gt; e.shaderRGBA [0];
   invModulate [1] = 255 - backEnd.currentEntity-&gt; e.shaderRGBA [1];
   invModulate [2] = 255 - backEnd.currentEntity-&gt; e.shaderRGBA [2];
   invModulate [3] = 255 - backEnd.currentEntity-&gt; e.shaderRGBA [3];
   ...
 } </pre><br>  And it does not matter that the 'invModulate' array consists of only three elements.  The code is taken from the project of the legendary game <a href="http://www.viva64.com/go.php%3Furl%3D444">Wolfenstein 3D</a> . <br><br>  And finally, the example is more complicated.  The code is taken from the very useful tool <a href="http://www.viva64.com/go.php%3Furl%3D445">Notepad ++</a> . <br><br><pre>  void KeyWordsStyleDialog :: updateDlg () 
 {
   ...
   Style &amp; w1Style =
     _pUserLang -&gt; _ styleArray.getStyler (STYLE_WORD1_INDEX);
   styleUpdate (w1Style, _pFgColour [0], _pBgColour [0],
     IDC_KEYWORD1_FONT_COMBO, IDC_KEYWORD1_FONTSIZE_COMBO,
     IDC_KEYWORD1_BOLD_CHECK, IDC_KEYWORD1_ITALIC_CHECK,
     IDC_KEYWORD1_UNDERLINE_CHECK);

   Style &amp; w2Style =
     _pUserLang -&gt; _ styleArray.getStyler (STYLE_WORD2_INDEX);
   styleUpdate (w2Style, _pFgColour [1], _pBgColour [1],
     IDC_KEYWORD2_FONT_COMBO, IDC_KEYWORD2_FONTSIZE_COMBO,
     IDC_KEYWORD2_BOLD_CHECK, IDC_KEYWORD2_ITALIC_CHECK,
     IDC_KEYWORD2_UNDERLINE_CHECK);

   Style &amp; w3Style =
     _pUserLang -&gt; _ styleArray.getStyler (STYLE_WORD3_INDEX);
   styleUpdate (w3Style, _pFgColour [2], _pBgColour [2],
     IDC_KEYWORD3_FONT_COMBO, IDC_KEYWORD3_FONTSIZE_COMBO,
     IDC_KEYWORD3_BOLD_CHECK, IDC_KEYWORD3_BOLD_CHECK,
     IDC_KEYWORD3_UNDERLINE_CHECK);

   Style &amp; w4Style =
     _pUserLang -&gt; _ styleArray.getStyler (STYLE_WORD4_INDEX);
   styleUpdate (w4Style, _pFgColour [3], _pBgColour [3],
     IDC_KEYWORD4_FONT_COMBO, IDC_KEYWORD4_FONTSIZE_COMBO,
     IDC_KEYWORD4_BOLD_CHECK, IDC_KEYWORD4_ITALIC_CHECK,
     IDC_KEYWORD4_UNDERLINE_CHECK);
   ...
 } </pre><br>  It is necessary to break eyes, to consider an error here.  Therefore, I will shorten the code for clarity: <br><br><pre>  styleUpdate (...
   IDC_KEYWORD1_BOLD_CHECK, IDC_KEYWORD1_ITALIC_CHECK,
   ...);
 styleUpdate (...
   IDC_KEYWORD2_BOLD_CHECK, IDC_KEYWORD2_ITALIC_CHECK,
   ...);
 styleUpdate (...
   IDC_KEYWORD3_BOLD_CHECK, IDC_KEYWORD3_BOLD_CHECK,
   ...);
 styleUpdate (...
   IDC_KEYWORD4_BOLD_CHECK, IDC_KEYWORD4_ITALIC_CHECK,
   ...); </pre><br>  The developer‚Äôs hand trembled and he copied the wrong resource name. <br><br>  I can still give the defective code in this article, but it is no longer interesting.  With all these examples, I just wanted to show that such errors are present in a wide variety of projects and are made by both beginners and professionals.  Let us turn, finally, to a discussion of the question of what to do with all this. <br><br>  To be honest, I do not know the full answer.  At least in the books about such situations, I did not read.  But in practice, I often met the effects of small Copy-Paste in programs.  Including in their own.  Have to improvise, giving an answer to the question. <br><br>  We will proceed from the following position: <br><br>  Programmers copy portions of the code and will copy as it is convenient.  Consequently, such errors will always occur in programs. <br><br>  From this conclusion: <br><br>  To prevent such errors completely impossible, but you can try to reduce the likelihood of their creation. <br><br>  I see two ways how to reduce the number of errors of this kind.  First, it is rational to use tools such as static code analyzers.  They allow you to detect many errors of this class.  And they will do it at the earliest stages.  It is cheaper and easier to detect and correct the error immediately after writing the code than to work with the same error detected during testing. <br><br>  The second way to help in some cases to reduce the number of errors is to discipline yourself and format the copied code in a special way.  Let me explain by example. <br><br><pre>  int ztrend = sgn (
     buffer [samplesleft - WindowSizeInt-2] -buffer [samplesleft - WindowSizeInt-2]); </pre><br>  So, the error is much more difficult to notice than if the code looked like this: <br><br><pre>  int ztrend = sgn (
     buffer [samplesleft - WindowSizeInt-2] -
     buffer [samplesleft - WindowSizeInt-2]); </pre><br>  You should format the code so that the places that should be different are lined up visually in a column.  So make a mistake will be much more difficult.  It is clear that in many cases this does not save and I cited such examples above.  However, at least something is better than nothing at all. <br><br>  Unfortunately, I don‚Äôt know any other ways to reduce the number of errors associated with Copy-Paste.  You can also use the tools to find duplicate and similar code, but this can be attributed to the advice of using static analyzers. <br><br>  I appeal to you readers.  It will be interesting to me if you share your thoughts about this and suggest other ways to avoid Copy-Paste errors.  Perhaps interesting ideas will be heard and many will benefit greatly. <br><br><h2>  Bibliographic list </h2><br><ol><li>  Steve McConnell, "Code Complete, 2nd Edition" Microsoft Press, Paperback, 2nd Edition, Published June 2004, 914 pages, ISBN: 0-7356-1967-0.  (Part 24.3. Reasons to Refactor) </li><li>  Presentation "PVS-Studio, a comprehensive solution for the development of modern resource-intensive applications."  <a href="http://www.viva64.com/ru/pvs-studio-presentation/">http://www.viva64.com/ru/pvs-studio-presentation/</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/112276/">https://habr.com/ru/post/112276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112271/index.html">Tools for Designers and Developers</a></li>
<li><a href="../112272/index.html">Working with the camera in Android</a></li>
<li><a href="../112273/index.html">Concept of a Trojan that recognizes voice and tones from a smartphone</a></li>
<li><a href="../112274/index.html">HTML5 Canvas - creating arcade scrolling step by step</a></li>
<li><a href="../112275/index.html">Spring is coming and CodeFest with her</a></li>
<li><a href="../112277/index.html">Test drive templates. Free for 30 days</a></li>
<li><a href="../112281/index.html">How to make a successful career at IBM headquarters?</a></li>
<li><a href="../112286/index.html">FileSystem API & File API: we understand and use</a></li>
<li><a href="../112287/index.html">Unity3D for beginners - Tutorial 1</a></li>
<li><a href="../112289/index.html">Digital signatures in executable files and circumvention of this protection in malware</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>