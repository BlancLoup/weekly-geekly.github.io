<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Redux: an attempt to get rid of the need to think during API requests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And what is the problem? 


 I started learning React and Redux not so long ago, but he had already managed to pretty much pat my nerves. Literally, e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Redux: an attempt to get rid of the need to think during API requests</h1><div class="post__text post__text-html js-mediator-article"><h3 id="i-v-chem-zhe-problema">  And what is the problem? </h3><br><p>  I started learning React and Redux not so long ago, but he had already managed to pretty much pat my nerves.  Literally, every action has to be thought of - almost no changes in the code are possible without tearing something away.  To just get a list of posts by API and display them, you probably need to write at least a hundred lines of code - create a root container, create a store, add an action for a request to the API, for a successful query result, for an unsuccessful query result, create action-creators , match action-creators and props, match dispatch and props, write a reducer for each action ... Uh, I don‚Äôt want to continue.  And all this we have to do again for each web application is a very irrational waste of the programmer‚Äôs forces. </p><br><p>  Yes, you can say to a beginner: "Look, there are a dozen packages here that can do every action from this list for you. Choose and use!"  But the problem is that it is necessary to understand the settings and use a dozen packages, taking care that they coincide with the version that is described in the documentation and did not enter into conflicts with each other ... Too difficult.  I want something simpler, as simple as in the world of Django, from which I came.  Any one package, after installation of which in the store all the necessary data are magically added - take it and use it. </p><br><p>  Well, I decided - if there is no such solution, I will write it myself. </p><br><h3 id="postanovka-zadachi">  Formulation of the problem </h3><br><p>  Removing all the lyrics from the first paragraph, I get the task - we need to create a tool that will: </p><br><ol><li>  Make an asynchronous GET request to the REST API. </li><li>  Analyze the data received and the data lying in the store, and if there is not enough data related by foreign key, make more queries. </li><li>  Add the received data to the store and monitor the relevance of the stored data. </li></ol><br><p>  According to the description, the package will consist of the action creator, middleware and reducer. </p><a name="habracut"></a><br><h3 id="instrumenty">  Instruments </h3><br><p> Fortunately, as it was said in the first paragraph, many things on JS have long been written, and you will not have to write them again.  For example, we‚Äôll go to the API using <code>redux-api-middleware</code> , monitor the immutability of the data using <code>react-addons-update</code> , and normalize the data (where can we go without it?) Using <code>normalizr</code> . </p><br><h3 id="konfiguraciya">  Configuration </h3><br><p>  The most important thing in this package is easy setup.  In order to simply describe the data model, entry points to the API, and invalidation of old data, we need a config.  With it, we will invent the architecture of the application.  Maybe architecturally this is not very correct, but my opinion is this: first of all, you need to dance from the convenience of the developer, even if it imposes difficulties on the technical implementation of the code. </p><br><p>  <strong>1.</strong> We describe the data scheme with related entities on the example of posts and users: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> schema = { <span class="hljs-attr"><span class="hljs-attr">users</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: { <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-string"><span class="hljs-string">"users"</span></span> } };</code> </pre> <br><p>  Something like, right?  It looks like a schema.Entity from normalizr.  Yes, it was possible to use classes from normalizr right away, but I believe that this will harm the convenience of the config.  In normalizr, the key must refer not just to a string, as in our config, but to an entity object, and the config would turn into this: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {schema} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'normalizr'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.Entity(<span class="hljs-string"><span class="hljs-string">"users"</span></span>, {}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> post = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.Entity(<span class="hljs-string"><span class="hljs-string">"posts"</span></span>, {<span class="hljs-attr"><span class="hljs-attr">author</span></span>: user}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> normalizrSchema = { <span class="hljs-attr"><span class="hljs-attr">users</span></span>: user, <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: post, }</code> </pre> <br><p>  And it is much less beautiful and comfortable than the first option. </p><br><p>  <strong>2.</strong> Entry points and actions for the API. </p><br><p>  Here we will follow the reverse logic - if there is a convenient configuration method written by someone before us, why change it?  <code>redux-api-middleware</code> config with the parameters that are passed to the action in <code>redux-api-middleware</code> , and it will turn out to be quite convenient: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> api = { <span class="hljs-attr"><span class="hljs-attr">users</span></span>: { <span class="hljs-attr"><span class="hljs-attr">endpoint</span></span>: <span class="hljs-string"><span class="hljs-string">"mysite.com/api/users/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">types</span></span>: [<span class="hljs-string"><span class="hljs-string">'USERS_GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'USERS_SUCCESS'</span></span>, <span class="hljs-string"><span class="hljs-string">'USERS_FAILURE'</span></span>], }, <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: { <span class="hljs-attr"><span class="hljs-attr">endpoint</span></span>: <span class="hljs-string"><span class="hljs-string">"mysite.com/api/posts/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">types</span></span>: [<span class="hljs-string"><span class="hljs-string">'POSTS_GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POSTS_SUCCESS'</span></span>, <span class="hljs-string"><span class="hljs-string">'POSTS_FAILURE'</span></span>], } };</code> </pre> <br><p>  Of course, all types of action can be declared as separate variables, not as strings - this is done solely for simplicity.  We only implement GET requests, so there is no need for the method field. </p><br><p>  <strong>3.</strong> "Lifetime" data in the store. </p><br><p>  Of course, sooner or later, the data on the client loses relevance - we cannot blindly rely on data that came to us from the server some time ago.  Therefore, it is necessary to provide a mechanism for the invalidation of old data and write the "lifetime" of each type of data in the config. </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lifetime = { <span class="hljs-attr"><span class="hljs-attr">users</span></span>: <span class="hljs-number"><span class="hljs-number">20000</span></span>, <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: <span class="hljs-number"><span class="hljs-number">100000</span></span> };</code> </pre> <br><p>  Let's collect all parts of a config together: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = {schema, api, lifetime};</code> </pre> <br><p>  Thus, everything is quite simple - users "live" in the store for 20 seconds, and posts - for 100 seconds.  As soon as the lifetime comes out, we will have to go for the data, even if they are already stored in the store, which means we will need to remember the time of arrival of the data.  And this brings us to the next point - the planning store. </p><br><h3 id="planirovanie-store">  Store planning </h3><br><p>  At this point, everything is quite simple - we need to store data and the time of their arrival.  Let's get two keys in store - entities and timestamp.  For those already familiar with normalizr, it becomes immediately clear - in entities we will store our entities, and it will look something like this: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> entities = { <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: {<span class="hljs-number"><span class="hljs-number">1</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, <span class="hljs-number"><span class="hljs-number">2</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">"not content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}}, <span class="hljs-attr"><span class="hljs-attr">users</span></span>: {<span class="hljs-number"><span class="hljs-number">1</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">"one"</span></span>}, <span class="hljs-number"><span class="hljs-number">2</span></span>: {<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">"two"</span></span>}} };</code> </pre> <br><p>  That is, it is a dictionary with key-entities, each of which, in turn, is a dictionary with key-id models. </p><br><p>  The timestamp will look very similar, but by id we will receive not the data, but the moment of delivery of the data to the client - <code>Date.now()</code> . </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timestamp = { <span class="hljs-attr"><span class="hljs-attr">posts</span></span>: {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">1496618924981</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">1496618924981</span></span>}, <span class="hljs-attr"><span class="hljs-attr">users</span></span>: {<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">1496618924983</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">1496618924983</span></span>} };</code> </pre> <br><p>  On this, in general, for now.  The next part will describe the process of developing the components themselves. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330422/">https://habr.com/ru/post/330422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330410/index.html">Features ‚Äìwebkit-box or how to ‚Äúfriend‚Äù flexbox with old Safari</a></li>
<li><a href="../330412/index.html">Why it is worth switching completely to Ceylon or Kotlin (part 1)</a></li>
<li><a href="../330414/index.html">Journey inside Avito: platform</a></li>
<li><a href="../330416/index.html">Intelligence is a new milestone in the development of localization systems</a></li>
<li><a href="../330418/index.html">Creating a simple audio editor</a></li>
<li><a href="../330424/index.html">Joint security in the cloud according to RUVDS, HUAWEI and Kaspersky Labs</a></li>
<li><a href="../330426/index.html">XoruX - free monitoring of virtual infrastructure, data storage and transmission systems</a></li>
<li><a href="../330428/index.html">The story of one landing</a></li>
<li><a href="../330432/index.html">Interview with Josh Patridge (Shazam) about marketing, business, strategy and new products</a></li>
<li><a href="../330434/index.html">Cheap full flash - fiction or reality?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>