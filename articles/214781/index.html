<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collect millions of likes or task queues in Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last week, we celebrated one round date - in the Likeastore database, we have accumulated as many as one million user ‚Äúlikes‚Äù. 

 We use JavaScript, a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collect millions of likes or task queues in Node.js</h1><div class="post__text post__text-html js-mediator-article"> Last week, we celebrated one round date - in the <a href="https://likeastore.com/">Likeastore</a> database, <a href="https://likeastore.com/">we have</a> accumulated as many as one million user ‚Äúlikes‚Äù. <br><br>  We use JavaScript, all current services are written in JavaScript / Node.js.  In general, I do not regret the use of Node.js in our project, it has proven itself as the best means of implementing the HTTP API.  But to collect likes, it must be a <code>daemon</code> that works all the time.  Probably not the most typical task for Node.js - about the specifics of the implementation and some of the pitfalls, read on. <br><a name="habracut"></a><br><h4>  ollector </h4><br>  Collector (collector), a key component of the Likeastore architecture.  It collects data through open API services, processes responses, saves data and its current state.  In essence, this is an ‚Äúinfinite loop‚Äù that builds a list of tasks to be executed, starts them, after which the procedure is repeated. <br><br>  For maximum efficiency, we run 2 instances of the collector operating in different modes: initial, normal.  In initial mode, the collector only processes the newly connected networks.  Thus, the user quickly receives "likes", after connecting the network.  After all the ‚Äúlikes‚Äù have been unloaded, the network goes into normal mode, is processed by another instance, where the time between charges is much higher. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argv = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'optimist'</span></span>).argv; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> env = process.env.NODE_ENV = process.env.NODE_ENV || <span class="hljs-string"><span class="hljs-string">'development'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mode = process.env.COLLECTOR_MODE = process.env.COLLECTOR_MODE || argv.mode || <span class="hljs-string"><span class="hljs-string">'normal'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scheduler = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./source/engine/scheduler'</span></span>); scheduler(mode).run();</code> </pre><br><h4>  Scheduler </h4><br>  The scheduler is essentially that <code>while(true)</code> written for Node.js.  I admit honestly, switching my thinking from ‚Äúsynchronous‚Äù to ‚Äúasynchronous‚Äù mode was not the easiest process for me.  Running an infinite number of tasks in Node.js seemed to be not an easy task, as a result of thinking this <a href="http://stackoverflow.com/questions/15886096/infinite-execution-of-tasks-for-nodejs-application">question</a> was born <a href="http://stackoverflow.com/questions/15886096/infinite-execution-of-tasks-for-nodejs-application">on SO</a> . <br><br>  One option was to use <a href="https://github.com/caolan/async">async.queue</a> , which seemed obvious, but not the best for this task.  After several attempts, the best asynchronous while (true) was setTimeout. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scheduler</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mode</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">schedulerLoop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ runCollectingTasks(restartScheduler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restartScheduler</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, results</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { logger.error(err); } <span class="hljs-comment"><span class="hljs-comment">// http://stackoverflow.com/questions/16072699/nodejs-settimeout-memory-leak var timeout = setTimeout(schedulerLoop, config.collector.schedulerRestart); } // ... return { run: function () { schedulerLoop(); } }; }</span></span></code> </pre><br><br>  It should be noted that the same pitfall daemon'ov Node.js - memory leaks.  I noticed that after the long-term work of the collector, he began to consume a large amount of memory and the most unexpected moment just stopped.  Pay attention to the comment in the code with the <a href="http://stackoverflow.com/questions/16072699/nodejs-settimeout-memory-leak">question on SO</a> .  After I added <code>var timeout =</code> , the situation improved, but not radically. <br><br>  Another reason opened after <a href="http://www.joyent.com/blog/walmart-node-js-memory-leak">an epic post</a> about memory leaks and investigations by Joyent and Wallmart engineers.  With the transition to Node.js v0.10.22, the collector began to work even more stable.  However, spontaneous stops occur, the reason is extremely difficult to understand. <br><br><h4>  Networks and states </h4><br>  When a user connects a new network, we put in the <code>networks</code> collection a document that contains: user ID, access token and other service information.  In the same document, the collector denormalizes its current state (in which mode it works, whether there were errors, how many of them, which current data page is being processed).  Those.  in fact, it is one and the same document, on the basis of which the executable task is created. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runCollectingTasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ prepareCollectingTasks(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, tasks</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback(err); } runTasks(tasks, <span class="hljs-string"><span class="hljs-string">'collecting'</span></span>, callback); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareCollectingTasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ networks.findByMode(mode, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, states</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback({<span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'error during networks query'</span></span>, <span class="hljs-attr"><span class="hljs-attr">err</span></span>: err}); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!states) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback({<span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'failed to read networks states'</span></span>}); } callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, createCollectingTasks(states)); }); }</code> </pre><br><br><h4>  Tasks </h4><br>  Based on the state, we create a list of executable tasks.  Almost all open APIs of popular services have limitations on the number of requests for a period of time.  The collector's task is to execute the most effective number of requests and not go to rate-limit. <br><br>  Only those tasks that were scheduled after the current point in time are allowed to start. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCollectingTasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">states</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = states.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allowedToExecute(state) ? collectingTask(state) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }).filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task !== <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tasks; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allowedToExecute</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> moment().diff(state.scheduledTo) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collectingTask</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> executor(state, connectors, callback); }; }</code> </pre><br><br>  The data array is converted to an array of functions that go to the <code>runTasks</code> input.  <code>runTasks</code> consistently performs each task through <code>async.series</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks, type, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>.series(tasks, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-comment"><span class="hljs-comment">// report error but continue execution to do not break execution chain.. logger.error(err); } callback(null, tasks.length); }); }</span></span></code> </pre><br><br><h4>  Executor </h4><br>  A generic function that accepts the current state, a list of existing connectors, and a callback function (I‚Äôve picked up all error handling and logging to show its essence). <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, connectors, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = state.service; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connector = connectors[service]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectorStarted = moment(); connector(state, user, connectorExecuted); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectorExecuted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, updatedState, results</span></span></span><span class="hljs-function">) </span></span>{ saveConnectorState(state, connectorStateSaved); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveConnectorState</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } function connectorStateSaved (err) { // ... saveConnectorResults(results, connectorResultsSaved); } function saveConnectorResults(results, callback) { // ... connectorResultsSaved(results, connectorResultsSaved); } function connectorResultsSaved (err, saveDuration) { // ... callback(null); } } }</span></span></code> </pre><br><br><h4>  Connectors </h4><br>  A connector is a function that performs an HTTP request to the API, processes its response, updates the status of the task (scheduled next launch), and returns the collected data.  It is the connector that distinguishes the state in which the ‚Äúlikes‚Äù collection is located, depending on which makes the necessary request (builds the required request URI). <br><br>  At the moment, we have implemented 9 connectors, a code that is more or less similar.  Initially, I was always looking for ready-made API access libraries, but this turned out to be the wrong strategy: you have to choose from several options, they don‚Äôt work or have an inappropriate interface, lag behind the current API version, etc.  The most flexible and simplest solution was to use <a href="https://github.com/mikeal/request">request</a> (the best HTTP client for Node.js). <br><br>  I will give an example of code for GitHub (again, I will shorten the details to show the essence). <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> API = <span class="hljs-string"><span class="hljs-string">'https://api.github.com'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, user, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> accessToken = state.accessToken; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!accessToken) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback(<span class="hljs-string"><span class="hljs-string">'missing accessToken for user: '</span></span> + state.user); } initState(state); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = formatRequestUri(accessToken, state); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> headers = { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'User-Agent'</span></span>: <span class="hljs-string"><span class="hljs-string">'likeastore/collector'</span></span>}; request({<span class="hljs-attr"><span class="hljs-attr">uri</span></span>: uri, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: headers, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: config.collector.request.timeout, <span class="hljs-attr"><span class="hljs-attr">json</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, response, body</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handleUnexpected(response, body, state, err, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ callback (err, state); }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handleResponse(response, body); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// intialize state fields (page, errors, mode etc.) ... } function formatRequestUri(accessToken, state) { // create request URI based on values from state ... } function handleResponse(response, body) { var rateLimit = +response.headers['x-ratelimit-remaining']; var stars = body.map(function (r) { return { // transforms response into likeastore item }; }); return callback(null, scheduleTo(updateState(state, stars, rateLimit, false)), stars); } function updateState(state, data, rateLimit, failed) { state.lastExecution = moment().toDate(); // update other state fields (next page, mode) ... return state; } }</span></span></code> </pre><br><br><h4>  scheduleTo </h4><br>  Finally, when the connector is completed and the status is updated, you need to calculate the next moment of launch.  It is calculated based on API limitations and collector operation mode (for initial mode the pause is minimal, for normal mode more, usually 15 minutes, if the connector goes to rate limit then the maximum pause). <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scheduleTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentMoment = moment(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = state.service; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scheduleForMode = { <span class="hljs-attr"><span class="hljs-attr">initial</span></span>: config.collector.quotes[service].runAfter, <span class="hljs-attr"><span class="hljs-attr">normal</span></span>: config.collector.nextNormalRunAfter, <span class="hljs-attr"><span class="hljs-attr">rateLimit</span></span>: config.collector.nextRateLimitRunAfter }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> next = scheduleForMode[state.mode]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scheduledTo = currentMoment.add(next, <span class="hljs-string"><span class="hljs-string">'milliseconds'</span></span>); state.scheduledTo = scheduledTo.toDate(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state; }</code> </pre><br><br>  Here is such a straightforward code that ‚Äúsettled‚Äù around September of last year and all we add from those times are new connectors, the engine itself remains unchanged.  I think about allocating a separate library for running task queues in Node.js, but I‚Äôm not sure how much this is a generalized task. <br><br>  As time goes on, the number of users is growing and at the moment the processing of 3,000 tasks takes about 30 minutes, which is quite a long time (we try to keep the cycle time no more than 15 minutes).  I think that in the future the architecture of the collector will change in the direction of message queues and separation of collectors not according to the mode of operation, but according to another characteristic (network type, user cluster) for easier horizontal scaling. </div><p>Source: <a href="https://habr.com/ru/post/214781/">https://habr.com/ru/post/214781/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214769/index.html">Start problem</a></li>
<li><a href="../214771/index.html">BPM or ERP?</a></li>
<li><a href="../214775/index.html">Free HTML5 Font Editor</a></li>
<li><a href="../214777/index.html">Sochi 2014 mobile apps: how to show megabytes of results to users</a></li>
<li><a href="../214779/index.html">Automate mouse clicks on Linux: xdotool</a></li>
<li><a href="../214783/index.html">PhD thesis. Instructions for clearing scientific stubs. Part 2</a></li>
<li><a href="../214787/index.html">About customization of information systems</a></li>
<li><a href="../214789/index.html">Configure the Site-to-Site IPsec tunnel between the Windows Azure cloud and the D-Link DFL-210</a></li>
<li><a href="../214793/index.html">This post is written by the author who does not read the comments, please do not write them.</a></li>
<li><a href="../214795/index.html">Inside stories Mt. Gox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>