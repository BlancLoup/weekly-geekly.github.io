<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>1-Wire slave on MK. Part 1: Iron</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For one of the automation projects, it was necessary to make a device that is a slave 1-Wire device, accepts commands from the master and exposes the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>1-Wire slave on MK. Part 1: Iron</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/deb/6a7/235/deb6a72355ee4c04a16962c11bb05e26.png"><br>  For one of the automation projects, it was necessary to make a device that is a slave 1-Wire device, accepts commands from the master and exposes the value of an analog signal at its outputs in the range from 0 to 10V. <br>  After analyzing the line of standard microcircuits 1-Wire from Maxim, it became clear that there is no chip that will allow to implement such functionality. <br>  Therefore, it was decided to implement a 1-Wire slave on the microcontroller.  I hope this material will be interesting and useful to people who make "smart home" with their own hands, because  1-Wire is quite a popular bus in similar projects.  As a stone, MK Cortex M0 + <a href="http://www.atmel.com/devices/ATSAMD20G16.aspx">ATSAMD20G16</a> from Atmel was chosen, but the implementation in the code will be described in the second part.  Looking ahead a bit, I‚Äôll say that in the third part of the cycle we‚Äôll talk about the implementation of our own family of devices for the One Wire File System (Linux) <a href="http://owfs.org/">OWFS</a> library.  And today we will talk about some hardware solutions to which we arrived in the development process. <br><a name="habracut"></a><br>  The discussion will mainly focus on how to connect the leg of the microcontroller to a 1-Wire bus with minimal damage to health.  We will move from simple to complex. <br><br><h4>  Nothing to do </h4><br>  The first problem you encounter when trying to assemble a 1-Wire device on a microcontroller with a Cortex core is the power level of a 3.3V microcontroller, while on a 1-Wire bus we have 5V.  You can use the tolerance of the legs of the microcontroller to 5V and connect as is, directly to the bus.  Unfortunately, the legs of the SAM D20 are not tolerant to 5 volts, so this option is not suitable for us, but it's worth it to be noted.  Although, putting the external tire directly onto the leg of the 3.3V stone is not the best idea.  Firstly, there is the likelihood of unstable operation of other devices on the bus with parasitic power, secondly, on a long wire, you can ‚Äúcatch‚Äù a tip. <br><br><h4>  Level conversion </h4><br><img src="https://habrastorage.org/files/996/342/467/9963424675dc4d6bada928ce7a0542ee.PNG"><br>  The simplest option is a bi-directional level converter on a transistor.  It will require somewhere to take 5V from the side of the 1-Wire bus. <br>  The first option is to make 5V on your device (in addition to 3.3V) to power the bus.  As a consequence, the complexity of circuitry. <br>  The second option is to lay the 1-Wire bus in <b>three wires</b> .  The third wire is the + 5V power line.  Of the problems - extra wire, voltage drop on a long wire. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Matching levels </h4><br>  If you really do not want to use + 5V, you can divide the signal line into 2 components (input and output) <br><img src="https://habrastorage.org/files/099/c99/06b/099c9906b1a140b8a224f6ee310066a0.PNG"><br>  It is important to note that with such a scheme, the lines from the controller are inverse. <br>  As a bonus, dividing the data line into 2 parts makes it possible to somewhat simplify further debugging of the software, since  Allows you to see with the oscilloscope signals coming from us separately ( <b>1-Wire Tx line</b> ), not mixed with signals from other devices on the bus. <br><br><h4>  Increase sustainability </h4><br>  In order to make the reception of data on 1-Wire more confident, it is necessary to make steep edges of pulses from the side of the microcontroller.  To do this, we use a comparator from TI <a href="http://www.ti.com.cn/cn/lit/ds/symlink/lmv393.pdf">LMV331</a> , which will provide a more accurate and sharp transition between logical "0" and "1", as well as a hysteresis of 160mV.  We will also replace the output bi-polar BC547 transistor on the field IRLML6346 and supply the TVS protective diode ESD5Z6 to 6V. <br><img src="https://habrastorage.org/files/f25/2cc/a34/f252cca349f34d708405a865fced11ba.PNG"><br>  For this scheme, the comparator will need to be powered from 5V.  Where they can be found above. <br><br><h4>  Untied 1-Wire </h4><br>  To ensure electrical isolation of the 1-Wire bus and the internal electronics of the device, we use an isolated level translator <a href="http://www.analog.com/media/en/technical-documentation/data-sheets/ADuM1200_1201.pdf">ADuM1201</a> and an isolated DC / DC converter <a href="http://assets.tracopower.com/TES1/documents/tes1-datasheet.pdf">TES 1-1211</a> .  As in the previous case, divide the 1-Wire data line into 2 lines: 1W_Rx and 1W_Tx. <br><img src="https://habrastorage.org/files/b09/d53/6b0/b09d536b0d024e4699d5d1f435785886.PNG"><br>  DC / DC converter from 12 to 5 volts taken for example, you can use the same 3.3 / 5. <br><br><h4>  The rest of the circuitry </h4><br>  For completeness, we show the microcontroller connection circuitry, as well as 0-10V analogue output channels. <br><img src="https://habrastorage.org/files/790/e79/7b1/790e797b178846a09ef8ae28e409013f.PNG"><br><img src="https://habrastorage.org/files/073/f10/b74/073f10b7405146d084ea5186698dc196.PNG"><br>  Since  The 1-Wire protocol requires a unique address for each device on the bus; we put on the board a 1-Wire UID from Maxim <a href="http://datasheets.maximintegrated.com/en/ds/DS2411.pdf">DS2411</a> .  Being a bus master for it, we will read its UID and use it as our own address.  In DS2411, the family code is 0x01 (family code is the UID's most significant byte).  On the OWFS website, we will select an unused family code for our new device and replace the first byte. <br><br>  As already mentioned, in the second part we will start the software implementation of the 1-Wire Slave protocol. </div><p>Source: <a href="https://habr.com/ru/post/275373/">https://habr.com/ru/post/275373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275355/index.html">Anonymous Father Frost 2015-2016 - Post boasting New Year's gifts</a></li>
<li><a href="../275359/index.html">Office lighting control over Wi-Fi. Part 1: Atmel WINC1500 Wi-Fi Module</a></li>
<li><a href="../275361/index.html">Office lighting control over Wi-Fi. Part 2: Q-touch sensor technology</a></li>
<li><a href="../275369/index.html">USB bootloader on the microcontroller: firmware update from a flash drive</a></li>
<li><a href="../275371/index.html">Atmel Software Framework (ASF): how does it work?</a></li>
<li><a href="../275375/index.html">Clocking Atmel microcontrollers SAMD20 / 21</a></li>
<li><a href="../275377/index.html">1-Wire slave on MK. Part 2: Implementing in code</a></li>
<li><a href="../275379/index.html">Dialog and Atmel have announced a merger. Comments of the official distributor in Russia</a></li>
<li><a href="../275381/index.html">Remote firmware update microcontroller</a></li>
<li><a href="../275383/index.html">Connecting the temperature sensor and iButton key reader to Queclink GV300 / GV320 trackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>