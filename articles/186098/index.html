<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Should I put Gentoo for the sake of acceleration?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Maybe someone from you once heard: "I plan to put myself Gentoo, it will be better to use the capabilities of my processor and will squeeze the maximu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Should I put Gentoo for the sake of acceleration?</h1><div class="post__text post__text-html js-mediator-article">  Maybe someone from you once heard: "I plan to put myself Gentoo, it will be better to use the capabilities of my processor and will squeeze the maximum out of it."  Well, let's figure it out ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ec/b9e/471/2ecb9e47131ade450caae775058d25a5.png"><br><br><h5>  What kind of optimizations are there for the processor? </h5><br>  Basically, this implies the use of additional instruction sets such as: MMX, SSE, AES and AVX when compiling applications.  However, if you dig deep, there are other optimizations and not just for applications. <br>  I selected the following optimization groups: <br><ul><li>  Code optimization <ul><li>  Code optimization when compiling for <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D1%258B_x86">additional x86</a> : MMX, SSE, AES, ATA, AVX etc. <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D1%258B_x86">instruction sets</a> . </li><li>  Optimization of the code during its static analysis during compilation: deployment of tail recursion, removing unused portions of code, ignoring meaningless conditions, etc. </li><li>  Optimization for better cache hit. </li></ul></li><li>  Kernel-level code optimization: cryptographic methods from the <a href="http://en.wikipedia.org/wiki/Crypto_API_%2528Linux%2529">Cryptographic API</a> . </li></ul><br><a name="habracut"></a><br>  <b>Optimizations for additional instruction sets are</b> best covered on the page: <a href="http://gcc.gnu.org/onlinedocs/gcc/i386-and-x86_002d64-Options.html">Intel 386 and AMD x86-64 GCC Options</a> .  Starting with the Pentium MMX, MMX became available to us, then AMD made 3DNow!, Then SSE appeared in the Pentium III, and it went off.  Intel Haswell, which pleased us this year, is supported: MOVBE, MMX, SSE, SSE2, SSE3, SSSE3, SSE4.1, SSE4.2, AVX, AVX2, AES, PCLMUL, FSGSBASE, RDRND, FMA, BMI, BMI2 and F16C. <br>  Working with real numbers ( <a href="http://ru.wikipedia.org/wiki/FPU">FPU</a> ) also indirectly refers to additional sets of instructions, because the compiler can use SSE for this.  This is faster than x87 instructions and does not block MMX.  More about this will be below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It should be noted another important feature.  When the abbreviations SSE, MMX and AES are mentioned out loud, then very often people familiar with these concepts have a picture in their head that tells about the hard life of C programmers who assemble these inserts into their software.  In fact, there are already 3 ways to use these instruction sets: automatically by the compiler for static code analysis, manually using <a href="http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html">special compiler functions</a> and manually assembler inserts (for example: <a href="http://www.novalis.org/documents/mmx.html">How to optimize the code for MMX processors</a> ).  In which cases GCC automatically uses instruction sets, if they are allowed, is not clear, but the manual clearly states that there are such cases (hopefully, in the comments they will write). <br><br>  <b>Static analysis code optimization is</b> best highlighted on the <a href="http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">Options That Control Optimization</a> page.  There are a lot of possibilities, but in order not to get confused, they are grouped into meta flags: O0, O1, O2, O3, Ofast.  More information on these flags can be found below in linked articles. <br><br>  <b>Optimization for better cache hit</b> .  It‚Äôs not possible to quickly explain, so I refer the reader to another article: <a href="http://habrahabr.ru/post/73726/">Bubbles, caches, and predictors of transitions</a> .  I can only say that programmers can use <a href="http://ru.wikipedia.org/wiki/VTune">Intel VTune Performance Analyzer</a> and <a href="http://ru.wikipedia.org/wiki/CodeAnalyst">AMD CodeAnalyst</a> to analyze the places that can be optimized.  And, it seems, <a href="http://ru.wikipedia.org/wiki/Intel_C%252B%252B_compiler">ICC Intel C ++ compiler is</a> able to do such optimizations in some cases automatically, and how do the GCC today with this, I hope knowledgeable people will add in the comments. <br><br>  <b>Optimize code at the kernel level</b> .  Allow to speed up functions in the Cryptographic API Framework, such as AES encryption, Twofish and others, using additional instruction sets, such as: SSE, AVX, AES.  These functions can be used in other kernel modules, as well as being called outside of applications. <br><br>  With the theory figured out, let's move on to how it is used. <br><br><h5>  If you have Ubuntu </h5><br>  Suppose you are sitting on Ubuntu.  Depending on the bitness of the operating system, you have a choice of packages with the suffix i386 or amd64 ( <a href="http://packages.ubuntu.com/raring/ffmpeg">example</a> ).  i386 does not mean that the package will work on any processor, starting from 386, it simply means that the target destination of the package is a 32-bit x86 platform.  In turn, amd64 means support for the x86-64 64-bit platform.  We can easily check this if we type in the console: <br><pre><code class="bash hljs">gcc -dumpmachine</code> </pre> <br>  On a 32-bit Ubuntu 12.04 LTS Server, we will see <b>i686-linux-gnu</b> , and on a 64-bit one, we should see <b>x86_64-linux-gnu</b> . <br>  Suppose you have a 32-bit Pentium 4, MMX, SSE and SSE2 are available to you, but they were not used when generating packages, since the same packages should work on Intel Celeron, where there is only MMX, and maybe even on Pentium Pro, where there is no even MMX. <br>  Additional instruction sets will be used only in packages, which themselves determine the processor on the fly and include a faster algorithm for this processor.  The good news is that this happens in almost all multimedia packages. <br>  It is also not clear with what code optimizations 32-bit Ubuntu was going to.  If you look at the output of GCC, that is, a little from -O1, and from -O2 and from -O3.  If packages for Ubuntu for a specific version can be built on the system itself with the default compilation options, then apparently they are not being assembled in the most optimal (of the rational) way. <br>  Finally, the functions in the kernel Cryptographic API are not optimized.  Optimized functions for additional instruction sets are present in the system only as modules, and only for i586 and AES (for VIA Nano), but not loaded by default.  It is also not clear that out of 586 you can use for optimizations. <br><br>  In Ubuntu 12.04 64-bit, things are much better.  First: the default gcc for 64-bit systems uses extensions: MMX, SSE, SSE2, so the code can be somewhat optimized.  Secondly, for x86-64, the default is <b>-mfpmath = sse</b> , which speeds up the arithmetic for real numbers. <br>  Optimized functions of the kernel Cryptographic API for additional instruction sets are present in the system in modules, but are not loaded by default.  At least they can be included. <br>  Finally, gcc builds packages with the same strange set of optimizations as for Ubuntu 32-bit. <br><br><h5>  If you have Gentoo </h5><br>  Then most likely you read this <a href="">page from the manual</a> .  So you have set yourself <b>-O2</b> and <b>-march = native</b> (or the correct processor).  But most likely you are the first: you didn‚Äôt go into the Cryptographic API when setting up the kernel and didn‚Äôt speed up some instructions, and at least you should speed up AES.  Secondly: you most likely did not set <a href="">USE flags</a> for additional processor instructions from those that are available to you: 3dnow, mmx, sse, sse2, sse3.  Or put not all of them.  And this means that for applications intentionally pushing activation activations into USE flags, you are left without additional acceleration. <br><blockquote><img src="https://habrastorage.org/getpro/habr/post_images/053/d99/82f/053d9982f06d74ec1d26860a59c3ae58.png"><br>  In addition to global flags, there are also local flags that use additional instructions for some applications.  Such as: 3dnowext, ssse3, sse4, sse4_1, avx, avx128fma, avx256 and aes-ni.  All that you support is better to set too. </blockquote><br><blockquote><img src="https://habrastorage.org/getpro/habr/post_images/053/d99/82f/053d9982f06d74ec1d26860a59c3ae58.png"><br>  The modern stage3 under amd64 exposes by default: bindist, mmx, sse, sse2.  Unfortunately, bindist disables additional instructions in some packages for portability.  If you need a bindist, use additional cpudetection to level the flaws of the bindist flag in some applications. </blockquote><br><br><h6>  In which packages of Gentoo can I get a boost? </h6><br>  app-arch / libzpaq <br>  app-emulation / bochs <br>  media-libs / freeverb3 (audio) <br>  media-libs / libpostproc (video) <br>  media-libs / libvpx (video VP8) <br>  media-plugins / vdr-softdevice (video) <br>  media-sound / mpg123 <br>  media-video / ffmpeg <br>  media-video / libav <br>  media-video / mplayer <br>  media-video / mplayer2 <br>  media-video / vlc <br>  net-libs / cyassl <br>  net-misc / bfgminer (bitcoin) <br>  sci-biology / raxml <br>  sci-libs / fftw <br>  sci-chemistry / gromacs <br>  sys-fs / loop-aes <br>  x11-libs / pixman <br><br>  Additionally, the orc flag, which is already set by default, helps to use additional processor instructions in: <br>  media-libs / gstreamer (audio + video) <br><br>  Additionally, the cpudetection flag, which is not set by default, helps to use additional processor instructions on the fly in: <br>  media-sound / jack-audio-connection-kit <br>  media-video / ffmpeg <br>  media-video / libav <br>  media-video / mplayer <br>  media-video / mplayer2 <br>  sci-libs / mpir <br><br><h5>  findings </h5><br><ul><li>  In 32-bit systems, the greatest gain from Gentoo can be obtained on the latest processor models. </li><li>  In 64-bit systems, the gain from Gentoo can only be obtained by using newer versions of the compiler and optimizing -O2. </li><li>  Even Gentoo, even after reading the official documentation does not interfere with readjusting. </li><li>  Not Gentoo can be sped up too. </li></ul><br><br><h5>  Additional material </h5><br><ul><li>  <a href="http://habrahabr.ru/company/intel/blog/158939/">Optimal options for x86 gcc</a> </li><li>  <a href="http://habrahabr.ru/company/intel/blog/167417/">GCC x86 how to reduce code size</a> </li><li>  <a href="http://habrahabr.ru/company/intel/blog/188386/">‚ÄúWhy update the GCC compiler?‚Äù ...</a> </li><li>  <a href="http://habrahabr.ru/post/108311/">GCC Compilation Optimization with Gentoo Example</a> </li><li>  <a href="">Gentoo: Compilation Optimization Guide</a> </li><li>  <a href="http://habrahabr.ru/post/201114/">Hardware support for the AES algorithm with modern processors</a> </li><li>  <a href="http://www.howtogeek.com/howto/ubuntu/how-to-customize-your-ubuntu-kernel/">How to Customize Your Ubuntu Kernel</a> <br></li><li>  <a href="https://help.ubuntu.com/12.04/installation-guide/i386/hardware-supported.html">Ubuntu: Supported Hardware</a> </li><li>  <a href="https://help.ubuntu.com/community/Loadable_Modules">Ubuntu: Loadable_Modules</a> </li><li>  <a href="http://habrahabr.ru/post/73726/">Bubbles, caches, and transition predictors</a> </li><li>  <a href="http://habrahabr.ru/post/160371/">Ruby on your server may be 2 times slower due to RVM</a> </li></ul><br><br><h6>  ICC material </h6><br><ul><li>  <a href="http://habrahabr.ru/post/83324/">Using alternative compilers in Gentoo using the Intel Compiler Suite example</a> </li><li>  <a href="http://habrahabr.ru/company/abbyy/blog/103447/">Gcc vs Intel C ++ Compiler: we collect FineReader Engine for Linux</a> </li></ul><br><br>  <b>Add-on</b> : <b>Kekekeks</b> user shared a <a href="http://habrahabr.ru/post/186098/">recipe on</a> how to rebuild some packages for Ubuntu with optimization. </div><p>Source: <a href="https://habr.com/ru/post/186098/">https://habr.com/ru/post/186098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186084/index.html">Resize animated GIF images using PHP + GD</a></li>
<li><a href="../186086/index.html">Google has released a patch for the vulnerability in Android</a></li>
<li><a href="../186088/index.html">A little bit about managing HTPC</a></li>
<li><a href="../186092/index.html">Tablet for the elderly. Part two</a></li>
<li><a href="../186096/index.html">PC makers will get Windows 8.1 at the end of August</a></li>
<li><a href="../186100/index.html">Simple and fast application stress testing framework</a></li>
<li><a href="../186102/index.html">Published draft HTTP 2.0 specification</a></li>
<li><a href="../186104/index.html">New technology Ford allows you to "print" car body in a matter of hours</a></li>
<li><a href="../186112/index.html">Grand Theft Auto V - familiarity with the world of the game</a></li>
<li><a href="../186114/index.html">Android phones on Jelly Bean are already more than on Gingerbread</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>