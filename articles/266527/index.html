<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One customer, two premises, four providers and eight connections</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the customers asked that the connection between his office and the warehouse be permanent and secure. How we did it and what happened and what ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One customer, two premises, four providers and eight connections</h1><div class="post__text post__text-html js-mediator-article">  One of the customers asked that the connection between his office and the warehouse be permanent and secure.  How we did it and what happened and what did not. <br><a name="habracut"></a><br><h4>  <b>Conditions</b> </h4><br>  The customer has two premises.  Office and warehouse.  There are Microtik-i and two providers in the office and in the warehouse.  Warehouse staff use IP-telephony and office resources through a secure tunnel. <br><br><h5>  <b>Task</b> </h5><br>  It is necessary to organize communication in such a way that the failure of one provider (from either side) does not lead to the fact that Office users will remain without Internet access, and remote Warehouse users without internal Office resources. <br><br><h5>  <b>Decision</b> </h5><br>  First, let's draw a diagram and try to determine what needs to be done.  We assume that the main channels go through the providers OfficeISP1 and SkladISP1, and the backup channels go through OfficeISP2 and SkladISP2.  In the picture they are shown in a thick line. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e54/d13/cc0/e54d13cc0b03cefd7116640315c4d475.jpg" alt="image"><br><br>  Let's make the list of the parameters describing our configuration: <br><ul><li>  Office Network Addressing: 192.168.1.0/24 </li><li>  The address of the internal interface of the office network router: 192.168.1.254 </li><li>  The external interface address of the office network router in the primary provider‚Äôs network (OfficeISP1): OFF.XXX.XXX.LOC </li><li>  Gateway main provider in the office (OfficeISP1): OFF.XXX.XXX.ISP </li><li>  The external interface address of the office network router in the backup provider's network (OfficeISP2): OFF.YYY.YYY.LOC </li><li>  Gateway backup provider in the office (OfficeISP1): OFF.YYY.YYY.ISP </li><li>  Warehouse network addressing: 192.168.2.0/24 </li><li>  Warehouse network router internal interface address: 192.168.2.254 </li><li>  The external interface address of the warehouse network router in the network of the main provider (SkladISP1): SKL.NNN.NNN.LOC </li><li>  Gateway main provider in the office (SkladISP1): SKL.NNN.NNN.ISP </li><li>  The external interface address of the office network router in the backup provider's network (SkladISP2): SKL.HHH.HHH.LOC </li><li>  Gateway backup provider in the office (SkladISP1): SKL.HHH.HHH.ISP </li><li>  Bridge name for organization of local networks in the office and warehouse: bridge-local </li><li>  The name of the bridge for the organization of networks of the main providers in the office and the office: bridge-isp1 </li><li>  The name of the bridge for the organization of networks of backup providers in the Office and Slada: bridge-isp2 </li></ul><br>  Subsequently, you can make such a list for yourself and then, using a replacement, get the configuration you need. <br><br><h5>  We divide the problem into two </h5><br><ol><li>  Failsafe Internet access through two providers. </li><li>  Organization of VPN-channels for communication between the Office and the Warehouse. </li></ol><br><h5>  <b>Failover of Internet access</b> </h5><br>  The first task, at first, I tried to solve with a script that runs every 3 minutes and checks with the help of ping any of the hosts on the Internet (the survivability of which is beyond doubt).  However, when testing this technology all the time failed.  Why - it is not clear.  Then I used a simple and, as it turned out, more efficient technique: <a href="http://wiki.mikrotik.com/wiki/Advanced_Routing_Failover_without_Scripting">organization of a backup communication channel without scripts</a> .  It turned out even better.  When the main channel is unavailable, the transition to the backup channel almost instantly occurs. <br><br><h5>  <b>VPN connections</b> </h5><br>  For the organization of VPN connections, it was decided to use the IPSec protocol and IPIP tunnels.  We make the plates for the tunnels.  On each side, you will have to describe 4 IPIP tunnels in order to describe all possible combinations of connections. <br><br>  <b>For Office Router</b> <br><ul><li>  Office-Warehouse, communication through the main providers: ipip-office-isp1-sklad-isp1 </li><li>  Office (backup provider) - Warehouse (main provider): ipip-office-isp2-sklad-isp1 </li><li>  Office (main provider) - Warehouse (backup provider): ipip-office-isp1-sklad-isp2 </li><li>  Office-Warehouse, communication through backup providers: ipip-office-isp2-sklad-isp2 </li><li>  ipip-office-isp1-sklad-isp1 local address: OFF.XXX.XXX.LOC </li><li>  ipip-office-isp1-sklad-isp1 remote address: SKL.NNN.NNN.LOC </li><li>  ipip-office-isp2-sklad-isp1 local address: OFF.YYY.YYY.LOC </li><li>  ipip-office-isp2-sklad-isp1 remote address: SKL.NNN.NNN.LOC </li><li>  ipip-office-isp1-sklad-isp2 local address: OFF.XXX.XXX.LOC </li><li>  ipip-office-isp1-sklad-isp2 remote address: SKL.HHH.HHH.LOC </li><li>  ipip-office-isp2-sklad-isp2 local address: OFF.YYY.YYY.LOC </li><li>  ipip-office-isp2-sklad-isp2 remote address: SKL.HHH.HHH.LOC </li></ul><br>  <b>For Warehouse Router</b> <br><br><ul><li>  Warehouse-Office, communication through the main providers: ipip-sklad-isp1-office-isp1 </li><li>  Warehouse (backup provider) - Office (main provider): ipip-sklad-isp2-office-isp1 </li><li>  Warehouse (main provider) - Office (backup provider): ipip-sklad-isp1-office-isp2 </li><li>  Warehouse-Office, communication through backup providers: ipip-sklad-isp2-office-isp2 </li><li>  ipip-sklad-isp1-office-isp1 local address: SKL.NNN.NNN.LOC </li><li>  ipip-sklad-isp1-office-isp1 remote address: OFF.XXX.XXX.LOC </li><li>  ipip-sklad-isp2-office-isp1 local address: SKL.HHH.HHH.LOC </li><li>  ipip-sklad-isp2-office-isp1 remote address: OFF.XXX.XXX.LOC </li><li>  ipip-sklad-isp1-office-isp2 local address: SKL.NNN.NNN.LOC </li><li>  ipip-sklad-isp1-office-isp2 remote address: OFF.YYY.YYY.LOC </li><li>  ipip-sklad-isp2-office-isp2 local address: SKL.HHH.HHH.LOC </li><li>  ipip-sklad-isp2-office-isp2 remote address: OFF.YYY.YYY.LOC </li></ul><br>  <b>For both routers for all IPIP tunnels</b> <br><br><ul><li>  IPSec secret (the same for all tunnels) - check the firmware version for Mikrotik !: bgduikneb789o3krjhgt98728550 (or other password) </li><li>  Keepalive - by default (the same for all tunnels): 00:05:10 10 </li><li>  DSCP: inherit </li><li>  Don't Fragment: inherit </li><li>  Clamp TCP MSS: tick </li></ul><br>  Create addresses for each of the tunnels in order to organize the routing between the Office and the Warehouse: <br><br><ul><li>  172.16.1.1/30 - ipip-office-isp1-sklad-isp1 </li><li>  172.16.1.2/30 - ipip-sklad-isp1-office-isp1 </li><li>  172.16.1.5/30 - ipip-office-isp2-sklad-isp1 </li><li>  172.16.1.6/30 - ipip-sklad-isp1-office-isp2 </li><li>  172.16.1.9/30 - ipip-office-isp1-sklad-isp2 </li><li>  172.16.1.10/30 - ipip-sklad-isp2-office-isp1 </li><li>  172.16.1.13/30 - ipip-office-isp2-sklad-isp2 </li><li>  172.16.1.14/30 - ipip-sklad-isp2-office-isp2 </li></ul><br>  Create routes.  Note how the distance values ‚Äã‚Äãshould be distributed among the routes: <br>  <b>For office</b> <br><br><ul><li>  add distance = 1 dst-address = 192.168.2.0 / 24 gateway = 172.16.1.2 </li><li>  add distance = 5 dst-address = 192.168.2.0 / 24 gateway = 172.16.1.6 </li><li>  add distance = 10 dst-address = 192.168.2.0 / 24 gateway = 172.16.1.10 </li><li>  add distance = 15 dst-address = 192.168.2.0 / 24 gateway = 172.16.1.14 </li></ul><br>  <b>For warehouse</b> <br><br><ul><li>  add distance = 1 dst-address = 192.168.1.0 / 24 gateway = 172.16.1.1 </li><li>  add distance = 5 dst-address = 192.168.1.0 / 24 gateway = 172.16.1.5 </li><li>  add distance = 10 dst-address = 192.168.1.0 / 24 gateway = 172.16.1.9 </li><li>  add distance = 15 dst-address = 192.168.1.0 / 24 gateway = 172.16.1.13 </li></ul><br>  We give the highest priority to routes through the main providers, the lowest - through backup ones.  Intermediate options (in principle) are the same, but in this case we give greater priority to the channel of the main provider from the Office.  I pointed out the latest octets for tunnel IP addresses for easier understanding: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8cb/c7f/ab4/8cbc7fab4df13de9e3be418e90c34710.jpg" alt="image"><br><br><h5>  <b>What happened</b> </h5><br>  During normal operation of all providers, the main channels for IPSec VPN connections are used.  If one of the channels fails, the routing for the users-Internet connection is rebuilt and the corresponding IPSec VPN channel is automatically used.  Thus, even with the simultaneous shutdown of one provider on each side, the system will work. <br><br><h5>  <b>What did not work</b> </h5><br>  Do not reconfigure the phone connection with the provider of IP-telephony.  As a result, when switching to the backup channel, the external address for the telephone exchange does not automatically re-register, but this has been left for the near future.  Restrictions are imposed by the telephone exchange itself. <br><br><h5>  <b>"Tips and Tricks"</b> </h5><br>  To work with two providers at once, do not forget to make the same rules for the NAT (for the Office and the Warehouse - the same): <br><br>  <i>/ ip firewall nat</i> <i><br></i>  <i>add action = masquerade chain = srcnat out-interface = bridge-isp1</i> <i><br></i>  <i>add action = masquerade chain = srcnat out-interface = bridge-isp2</i> <br><br>  In order for the packets to go between the Office and the Warehouse without any problems, cancel the NAT between them by adding to the top of the table the rule for the Office: <br><br>  <i>/ ip firewall nat</i> <i><br></i>  <i>add chain = srcnat dst-address = 192.168.1.0 / 24 src-address = 192.168.2.0 / 24</i> <br><br>  And for the warehouse: <br><br>  <i>/ ip firewall nat</i> <i><br></i>  <i>add chain = srcnat dst-address = 192.168.2.0 / 24 src-address = 192.168.1.0 / 24</i> <br><br>  And in order that remote desktop users who work on the road or from home can always (with any active provider) use office resources, you can use DynDNS technology.  This will allow when switching to a backup provider not to remember the external IP address of the backup channel. </div><p>Source: <a href="https://habr.com/ru/post/266527/">https://habr.com/ru/post/266527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266513/index.html">Perfect ERP or controlled blast</a></li>
<li><a href="../266515/index.html">CRM work protocol in a medical institution</a></li>
<li><a href="../266517/index.html">‚ÄúSweet‚Äù programming, or How to select a label from a can of jam in Mathematica?</a></li>
<li><a href="../266519/index.html">Intel Broadwell Xeon E3-1200 v4 - all you need to know about the new line of Xeon and eDRAM</a></li>
<li><a href="../266521/index.html">Release Phalcon 2.1.0 beta 1</a></li>
<li><a href="../266529/index.html">Zigbee for the little ones. Post number 1</a></li>
<li><a href="../266533/index.html">A variety of network security tests: a review of IXIA solutions</a></li>
<li><a href="../266537/index.html">How to stop freezing in the data center?</a></li>
<li><a href="../266539/index.html">Indoor navigation - from idea to working prototype</a></li>
<li><a href="../266541/index.html">As one of the operators increased the capacity of 3G in a densely populated district of Minsk, not forgetting about the coming on the heels of LTE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>