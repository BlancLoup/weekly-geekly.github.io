<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP SQL query</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since ORM is too heavy for my needs, I usually used DbSimple . However, after getting acquainted with Twig , which compiles the templates in php code,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP SQL query</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/969/6d9/0fe/9696d90feb764b698dbc16e4564fed1c.png" alt="image"><br><br>  Since ORM is too heavy for my needs, I usually used <a href="http://dklab.ru/lib/DbSimple/">DbSimple</a> .  However, after getting acquainted with <a href="http://twig.sensiolabs.org/">Twig</a> , which compiles the templates in php code, the idea to write something similar to work with the database periodically arose.  And so I did it.  The picture shows a request for PHP, which, after compilation, generates code for creating and executing a SQL query. <br><a name="habracut"></a><br>  In the first implementation, I compiled a query from syntax similar to DbSimple in PHP code.  The idea was to get the output code with native functions without any wrappers.  At the same time, it was possible to tailor requests of any complexity and the speed of their analysis did not affect the runtime, since after compilation it was normal native code.  However, the difficulty in debugging such queries (it was difficult to look for errors in the SQL syntax) and the fact that the query processing time is not so long compared with the query execution led to the fact that I refused to use this approach. <br><br>  Not so long ago I came across a library for parsing PHP code on <a href="https://github.com/nikic/PHP-Parser">PHP-Parser</a> tokens.  At work, I write code in the <a href="https://ru.wikipedia.org/wiki/ABAP/4">ABAP</a> language, in which the commands for working with the database are built into the language itself, so the idea came up: ‚ÄúWhat if you do something similar for PHP?‚Äù 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The implementation scheme is quite simple and obvious: when a class is autoloading, we check its presence in the directory of compiled classes.  If there is no compiled class, then we take the source file of the class, replace all the special commands in it and write the finished class into the directory of the compiled classes.  All parsing is done by the PHP-Parser library.  So that the compiler can understand that this is exactly the command he needs, we wrap everything into the namespace ML ( <b>M</b> acro <b>L</b> anguage).  For example, in the code we write this: <br><br><pre><code class="php hljs">\ML::SQL(Select( <span class="hljs-string"><span class="hljs-string">'aa,bb'</span></span>, ucase(<span class="hljs-string"><span class="hljs-string">'xx'</span></span>)-&gt;as(<span class="hljs-string"><span class="hljs-string">'Uxx'</span></span>) ), from(<span class="hljs-string"><span class="hljs-string">"MyTable"</span></span>)-&gt;as(<span class="hljs-string"><span class="hljs-string">"tab"</span></span>), where( like(<span class="hljs-string"><span class="hljs-string">'aa'</span></span>,<span class="hljs-string"><span class="hljs-string">'sha%'</span></span>), _or( field(<span class="hljs-string"><span class="hljs-string">'bb'</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, field(<span class="hljs-string"><span class="hljs-string">'bb'</span></span>) == <span class="hljs-number"><span class="hljs-number">2006</span></span> ) ), orderBy( <span class="hljs-string"><span class="hljs-string">"-aa,+bb"</span></span> ), into($rows)-&gt;rows());</code> </pre> <br>  and get the output: <br><br><pre> <code class="php hljs">$__driver0 = \ML\SQL::getDriver(<span class="hljs-string"><span class="hljs-string">'c933f3523437d521bf59e9e6077255b9'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'server'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'pass'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MyCMS-'</span></span>, <span class="hljs-string"><span class="hljs-string">'codepage'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)); $__query1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ML\SQL\Query($__driver0); $__query1-&gt;sql = <span class="hljs-string"><span class="hljs-string">'SELECT `tab`.`aa` as `tab.aa`, `tab`.`bb` as `tab.bb`, UCASE(`tab`.`xx`) as `Uxx` FROM `MyCMS-MyTable` as `tab` WHERE `tab`.`aa` LIKE \'sha%\' AND (`tab`.`bb` IS NULL OR `tab`.`bb`=2006) ORDER BY `tab`.`aa` DESC, `tab`.`bb` ASC'</span></span>; $rows = $__query1-&gt;rows();</code> </pre> <br>  In this case, we can use PHP variables directly in the query (which are inserted into the query with protection from <a href="http://habrahabr.ru/post/148701/">SQL injection in PHP and MySQL</a> ) and the function of conditional query generation _if.  In particular, this code: <br><br><pre> <code class="php hljs">\ML::SQL(Select( <span class="hljs-string"><span class="hljs-string">'aa'</span></span>, _if($mode==<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'bb'</span></span>) ), from(<span class="hljs-string"><span class="hljs-string">"MyTable"</span></span>)-&gt;as(<span class="hljs-string"><span class="hljs-string">"tab"</span></span>), where( field($fname) = $value ), into($rows)-&gt;row());</code> </pre> <br>  compiles to this code: <br><br><pre> <code class="php hljs">$__driver0 = \ML\SQL::getDriver(<span class="hljs-string"><span class="hljs-string">'c933f3523437d521bf59e9e6077255b9'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'server'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'pass'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'***'</span></span>, <span class="hljs-string"><span class="hljs-string">'prefix'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MyCMS-'</span></span>, <span class="hljs-string"><span class="hljs-string">'codepage'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>)); $__query1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ML\SQL\Query($__driver0); $__query1-&gt;sql = <span class="hljs-string"><span class="hljs-string">'SELECT `tab`.`aa` as `tab.aa`'</span></span> . ($mode == <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-string"><span class="hljs-string">', `tab`.`bb` as `tab.bb`'</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>) . <span class="hljs-string"><span class="hljs-string">' FROM `MyCMS-MyTable` as `tab` WHERE '</span></span> . $__driver0-&gt;getField(<span class="hljs-string"><span class="hljs-string">'tab'</span></span>, $fname, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) . <span class="hljs-string"><span class="hljs-string">'='</span></span> . $__driver0-&gt;getValue($value); $rows = $__query1-&gt;row();</code> </pre> <br>  Since the implementation scheme is simple, I decided not to limit myself to SQL.  To do this, the code does not look for specific \ ML \ SQL commands, but for all calls from the \ ML namespace.  If such a call is found, then the presence of the class \ ML \ &lt;class name&gt; is checked.  If there is such a class, then an object of this class is created and its method &lt;class name&gt; -&gt; compile (...) is called, to which the tokens of the current call (the root node received from <a href="https://github.com/nikic/PHP-Parser">PHP-Parser</a> ) + object of this class are transferred.  This will allow to use this approach not only for accessing the database, but also for other needs (I have not yet come up with any :)).  In particular, I plan to make an ORM extension over SQL.  Those.  I will call the \ ML \ ORM compile into the \ ML \ SQL code, which will already be compiled into PHP code.  Moreover, since the time to parse an expression is not important, then when parsing an ORM call, you can spend time reading information about entities, their connections, fields, etc. <br><br>  PS Although before doing the ORM, I will add the JOIN + command to the UPDATE and DELETE commands. <br><br>  For those who are interested, a small test <a href="http://phpsql.shasoft.com/">site for compiling code</a> .  If you find any error, write in the comments.  So far this is version 0.1 alpha, so errors are very likely. <br><br>  UPD: 2017.02.03 Added more examples <br><br>  UPD: <a href="https://habrahabr.ru/post/327160/">Next Version</a> </div><p>Source: <a href="https://habr.com/ru/post/320718/">https://habr.com/ru/post/320718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320708/index.html">Thinking about a one-way mirror</a></li>
<li><a href="../320710/index.html">The difference between nginx and apache with examples</a></li>
<li><a href="../320712/index.html">Aesthetic Beauty: Switch vs If</a></li>
<li><a href="../320714/index.html">3CX Client for Android and iOS updates, and the 3CX SBC release for Debian Linux</a></li>
<li><a href="../320716/index.html">Passive methods to detect illegal traffic termination</a></li>
<li><a href="../320720/index.html">Own search algorithm for similar images. Theory</a></li>
<li><a href="../320722/index.html">Creating a quest tour of Berlin - step by step instructions</a></li>
<li><a href="../320724/index.html">New Year's Promises by Go-Developer</a></li>
<li><a href="../320726/index.html">Random Forest: walks in the winter forest</a></li>
<li><a href="../320728/index.html">Design patterns, iOS view developer. Part 0. Singleton Single</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>