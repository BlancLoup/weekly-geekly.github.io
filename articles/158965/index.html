<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding MSP430 and Toilet Automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have been reading the DIY rubric for a long time and my hands itched to do something on the microcontroller. And read at random about the MSP430 Lau...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding MSP430 and Toilet Automation</h1><div class="post__text post__text-html js-mediator-article">  I have been reading the DIY rubric for a long time and my hands itched to do something on the microcontroller.  And read at random about the MSP430 Launch Pad from Texas Instruments for $ 4.30.  Perfect set to start. <br>  An automatic air freshener of one famous brand was chosen as an object for experiments. <br><img src="https://habrastorage.org/storage2/f12/b4f/e43/f12b4fe43fd81cc838a5701ec56751f2.jpg"><br><a name="habracut"></a><br><h4>  Task </h4><br>  The original freshener has the function of spraying at specified intervals, which is not always convenient.  Since no one is at home in the afternoon, the balloon is wasted.  In addition, the developers have built in "protection" against the use of cylinders from other manufacturers, which, although it is quite simple, but life becomes easier without it.  In addition, for "manual" spraying had to get the bottle and use it as a regular freshener. <br><br><h5>  What did you want to get </h5><br>  First, to make the algorithm more intelligent.  Namely, to make it so that the freshener works after visiting the toilet.  And secondly, add the function of "manual" operation without opening the case. <br><br><h4>  Decision </h4><br><h5>  Algorithm </h5><br>  I decided to automate the triggering of the sprayer on the basis of a light sensor.  That is, when you turn off the light after 5 seconds should work spray.  After that, do not respond to the on-off light for 15 minutes.  In order not to "re-refresh" the room so it will not be possible to breathe.  Just add a button for "manual" spraying regardless of the mode of operation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Opening the "patient" </h5><br>  Before adding something new, I decided to see what was inside this ‚Äúmiracle unit‚Äù. <br><img src="https://habrastorage.org/storage2/1d4/082/a7e/1d4082a7e2e43dab1695d061a6ac2201.jpg"><br><br>  And the first thing I came across was screws with a non-standard "triangular" head: <br><img src="https://habrastorage.org/storage2/bbb/0b0/489/bbb0b04895910d55b9524bd4609471f0.jpg"><br><br>  Fortunately, a suitable screwdriver was found in the micro screwdriver set and the process did not stop there.  Inside, everything was very simple.  The mechanism of the descent is an ordinary electric motor through a gearbox from a pair of gears connected to the tongue, which presses on the balloon sprayer.  The control board is of no interest, only as a template for making one's own, and as a source of connectors for connecting the power and the descending motor. <br><img src="https://habrastorage.org/storage2/b64/0f4/aa8/b640f4aa8cc55dea31724599ebc90c1a.jpg"><br><br><h5>  Electronic part </h5><br>  When it became clear what this device is, you can begin to design your own control module.  The brain will be a microcontroller MSP430G2553.  There is a younger G2452 in the LaunchPad set and you can use it, but I chose the older one, since it has a hardware UART, which is convenient for debugging and calibration.  For example, the indicator of an empty cylinder.  Initially, it is not known how many sprays it will be enough, so the program has a counter with a record in non-volatile memory, followed by reading and sending over the UART (for this you have to remove the controller from the control module and put it on the debug board).  After receiving these data and bringing the program to the final version, I plan to replace the controller with a younger model. <br><br>  The scheme of the control module.  I want to immediately notice, this is my first finished device, so the circuit and the board are far from the quality standards: <br><img src="https://habrastorage.org/storage2/a89/44f/2bd/a8944f2bd47cf9aefa6067f9808a9a8c.jpg"><br><br>  The scheme was based on the recommendations of the Datasheet controller and articles from the Internet.  Special thanks <a href="http://geektimes.ru/users/dihalt/" class="user_link">DIHALT</a> his textbook on electronics for beginners became for me a starting point. <br>  The components are very simple.  The filter on the capacitors C1 and C2, according to the recommendations of the Datasheet, increases the accuracy of the ADC.  The photoresistor LDR1 is a light sensor and is connected via a voltage divider on resistor R3.  The motor descent is controlled through a transistor BC337.  Also on the diagram, the manual release button S1 and the LEDs of two colors are added.  I used a two-color LED.  It blinks green once a second as an indicator of normal operation, and when the battery is below 2.5V, it starts flashing red.  The source of the real-time clock signal is Quartz Z1 at 32768 Hz, which comes bundled with the board and controllers. <br><br><h5>  Software part </h5><br>  I wrote the program for the controller in IAR Embedded Workbench in C ++.  I cite here her code with comments. <br><br><div class="spoiler">  <b class="spoiler_title">Spary file code spary.h</b> <div class="spoiler_text">  Header file spray.h <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __SPRAY_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __SPRAY_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sstream&gt; //  #define BUTTON BIT4; //    #define SPRAY_PORT BIT6;// P1.6 #define LED_GREEN BIT1; // P2.1 #define LED_RED BIT2; // P2.2 #define LIGHT_SENSOR INCH_5; // A5 #define DARK_VALUE 650; //    " ." #define LOWBATT_VALUE 520; //     . //  unsigned int SleepPeriod = 900; //     . 15 . (900) unsigned int SpayDelay = 5; //    5. unsigned int DarkValue = 650; //    " ." unsigned int LowBattValue = 520; //     . unsigned int BattInterval = 5; //    5. //  unsigned int ADCValue; //   unsigned int SprayCount; //    unsigned int TimerCount = 0; //    unsigned int BattTimer = 0; //     unsigned int RXByte; //       UART //  bool ADCDone = false; //    bool LightOn = false; //    ( ) bool SleepMode = false; //    (  15 ) bool IsCounting = false; //     ,  //      bool LowBatt = false; //     bool BlinkOn = false; //     bool Tick = false; //       bool IsADCOn = false; //     bool IsADCLight = true; //     (true -   // , false - ) bool ForceSpay = false; //       bool UARTReceived = false; //     UART //  void UARTSend(string str); //   UART void LightSensorOn(); //       void VCCSensorOn(); //       unsigned int ReadCountFromFlash(); //     void WriteCountToFlash(unsigned int); //     void Spray(); //   #endif</span></span></span></span></code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Program code</b> <div class="spoiler_text">  The text of the program.  main.cpp: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;msp430g2553.h&gt; #include "spray.h" int main( void ) { //  WDT    WDTCTL = WDTPW + WDTHOLD; //    //------------------------- //  - P1DIR &amp;= ~BUTTON; //     P1REN |= BUTTON; //     P1OUT &amp;= ~BUTTON; //   - GND P1IES |= BUTTON; //     P1IFG &amp;= ~BUTTON; //    P1IE |= BUTTON; //     P1DIR |= SPRAY_PORT; //     P1OUT &amp;= ~SPRAY_PORT; //     //     P2DIR |= LED_GREEN P2DIR |= LED_RED; //    ( ) P2OUT |= LED_GREEN; P2OUT &amp;= ~LED_RED; //  . //------------------------- //   DCOCTL = CALDCO_1MHZ; //     ~ 1 BCSCTL1 = CALBC1_1MHZ; //------------------------- //    TACTL = TASSEL_1 + MC_1; //    ACLK (), //     CCR0 CCR0 = 0x8000; // ..   32768,       //        CCTL0 = CCIS0 + OUTMOD0 + CCIE; //  ,     //     //------------------------- // UART.      FLASH P1SEL = BIT1 + BIT2; //    P1SEL2 = BIT1 + BIT2; // UART UCA0CTL1 |= UCSSEL_2; //   -   SMCLK ~ 1MHz UCA0BR0 = 0x68; //   9600 UCA0BR1 = 0; // 1000000 / 9600 = 104 = 0x68 UCA0MCTL = UCBRS0; UCA0CTL1 &amp;= ~UCSWRST; //       IE2 = UCA0RXIE; //     UART //------------------------- // Flash FCTL2 = FWKEY + FSSEL1 + FN1; //       //    .   65535 -  //   SprayCount = ReadCountFromFlash(); if(SprayCount == 65535) { SprayCount = 0; //   WriteCountToFlash(SprayCount); //  0  Flash } //------------------------- __delay_cycles(2000); //    //------------------------- __bis_SR_register(GIE); //    P2OUT &amp;= ~LED_GREEN; //   .  . UARTSend("Ready\r\n"); //   while(true) { if(Tick) //   . { Tick = false; //   BattTimer++; if(BattTimer &gt;= BattInterval) //       { BattTimer = 0; //   VCCSensorOn(); //    } if(!SleepMode) //      { LightSensorOn(); //    if(IsCounting) //     { if(TimerCount &gt;= SpayDelay) //    { Spray(); //   } } } else { //     if(TimerCount &gt;= SleepPeriod) { TimerCount = 0; //   SleepMode = false; //     } } } if(ADCDone) //    { ADCDone = false; //    if(IsADCLight) //      { if(ADCValue &lt; DarkValue) //  . { LightOn = true; //   " " IsCounting = false; //   (   ,  ) TimerCount = 0; //   } else //    { if(LightOn) //    { LightOn = false; //   IsCounting = true; //      TimerCount = 0; } } } else //    { if(ADCValue &lt; LowBattValue) { LowBatt = true; //     } else { LowBatt = false; //  -   } } } if(ForceSpay) //  .  . { ForceSpay = false; Spray(); } if(UARTReceived) //   UART.   . { UARTReceived = false; ostringstream s; s &lt;&lt; SprayCount &lt;&lt; "\r\n"; UARTSend(s.str()); } } } //   UART void UARTSend(string str) { int len = str.length(); for(int i=0;i&lt;len;i++) { while(!(IFG2&amp;UCA0TXIFG)); UCA0TXBUF = str[i]; } } //       void LightSensorOn() { if(!IsADCOn) { IsADCOn = true; IsADCLight = true; ADC10CTL0 &amp;= ~ENC; ADC10CTL0 = ADC10SHT_3 + ADC10ON + ADC10IE; ADC10CTL1 = ADC10SSEL_2 + LIGHT_SENSOR; ADC10CTL0 |= ENC + ADC10SC; } } //       void VCCSensorOn() { if(!IsADCOn) { IsADCOn = true; IsADCLight = false; ADC10CTL0 &amp;= ~ENC; ADC10CTL0 = SREF_1 + ADC10SHT_3 + REFON + ADC10ON + REF2_5V + ADC10IE; ADC10CTL1 = ADC10SSEL_2 + INCH_11; __delay_cycles(128); ADC10CTL0 |= ENC + ADC10SC; } } //     unsigned int ReadCountFromFlash() { __bic_SR_register(GIE); //    int *Flash_ptr; Flash_ptr = (int *) 0x1040; //   *Flash_ptr = 0; //   unsigned int value = *Flash_ptr; //   __bis_SR_register(GIE); //   return value; //   } //     void WriteCountToFlash(unsigned int value) { __bic_SR_register(GIE); //   int *Flash_ptr; Flash_ptr = (int *) 0x1040; //   FCTL1 = FWKEY + ERASE; //     FCTL3 = FWKEY; *Flash_ptr = 0; //   FCTL1 = FWKEY + WRT; *Flash_ptr++ = value; //    Flash FCTL1 = FWKEY; FCTL3 = FWKEY + LOCK; //     __bis_SR_register(GIE); //   } //   void Spray() { __bic_SR_register(GIE); //   P1OUT |= SPRAY_PORT; //   __delay_cycles(500000); //  ~ 0.5  (  1) P1OUT &amp;= ~SPRAY_PORT; //   //         LightOn=false; SleepMode=true; IsCounting=false; TimerCount=0; SprayCount++; WriteCountToFlash(SprayCount); __bis_SR_register(GIE); //    } //--------------------------- //   //   #pragma vector=ADC10_VECTOR __interrupt void ADC_Handler() { ADCValue = ADC10MEM; //      ADCDone = true; //     IsADCOn = false; } //     #pragma vector=PORT1_VECTOR __interrupt void Button_Handler() { P1IE &amp;= ~BUTTON; //      P1IFG &amp;= ~BUTTON; //   ForceSpay = true; //     //     __delay_cycles(300000); P1IE |= BUTTON; //   } //     1  . #pragma vector=TIMER0_A0_VECTOR __interrupt void Timer_Handler() { //     if(!BlinkOn) //    { //         //      - ,   if(LowBatt) { P2OUT |= LED_RED; } else { P2OUT |= LED_GREEN; } BlinkOn = true; } else //    { P2OUT &amp;= ~LED_RED; P2OUT &amp;= ~LED_GREEN; BlinkOn = false; } TimerCount++; //     Tick=true; //   } //     UART #pragma vector=USCIAB0RX_VECTOR __interrupt void UART_Handler() { RXByte = UCA0RXBUF; UARTReceived = true; }</span></span></span></span></code> </pre><br><br>  The program in this form does not contain a block to indicate the end of the cylinder, since at the time of writing it is not known how many sprays it will be enough. <br></div></div><br><br><h5>  Assembly </h5><br>  After compiling and debugging the program on the board, the module was assembled for tests on the breadboard: <br><img src="https://habrastorage.org/storage2/0a2/475/3bb/0a24753bb351c23a7645afe633f430c5.jpg"><br><br><img src="https://habrastorage.org/storage2/ae5/8ea/ce1/ae58eace1fdd1165a10c92930e97e44c.jpg"><br><br>  The LaunchPad debug card here is simply a holder for quartz, since it is so small that it is simply impossible to place it on the layout. <br><br>  When I was convinced that everything works without failures and according to the algorithm, I started making the board for the control module, which can be placed in the case in place of the native one. <br><br>  Layout of the board for the control module (done in Sprint-Layout): <br><img src="https://habrastorage.org/storage2/f6b/7b8/567/f6b7b85676c0bd243038dfec559189d3.jpg"><br><br>  Then the board was made.  The drawing was done using the LUT method (thanks again <a href="http://geektimes.ru/users/dihalt/" class="user_link">DIHALT</a> ), then the board was etched in ferric chloride and tinned. <br><img src="https://habrastorage.org/storage2/dbe/efa/194/dbeefa19458ca7b4b4b880c15f7c8b1e.jpg"><br><br>  Next, solder the components.  The microcontroller is placed in the panel so that it is easy to remove it and read the value of the counter, as well as change to another one when finalizing the program. <br><img src="https://habrastorage.org/storage2/905/77b/c98/90577bc9861d3137b9880701da88c8ed.jpg"><br><br><img src="https://habrastorage.org/storage2/388/4f5/d6e/3884f5d6ed2dd5f6c1bdeb4bc197488d.jpg"><br><br><img src="https://habrastorage.org/storage2/b01/bfc/f46/b01bfcf461ad93c3b6343b0fb021d710.jpg"><br><br>  And then after testing the device is already assembled with a new control module. <br><img src="https://habrastorage.org/storage2/aae/afd/d52/aaeafdd52d8614acb1ace464e17378ff.jpg"><br><br><img src="https://habrastorage.org/storage2/611/23a/471/61123a471c0cc8727d8fd0c13239fd76.jpg"><br><br><h4>  Conclusion </h4><br>  As a result of work on this device, which lasted about a week in the evenings, I was convinced that the development of devices on modern microcontrollers presents no difficulties even for beginners to comprehend electronics.  The fact that everything worked as planned, further inflamed enthusiasm.  And the pleasure of something made with their own hands from and to was received considerable. <br><br>  And I emphasize once again that before this, I had almost no experience in programming microcontrollers, or experience in working with electronics.  Therefore, most likely I have made mistakes, both in software and in hardware, for which I ask you not to judge strictly. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/158965/">https://habr.com/ru/post/158965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158953/index.html">Cabinets that do not cut hands</a></li>
<li><a href="../158955/index.html">Call of Duty: Black Ops 2 earned $ 500 million per day</a></li>
<li><a href="../158959/index.html">Microsoft Surface as an attempt to lift your hair</a></li>
<li><a href="../158961/index.html">Using RabbitMQ in django projects without Celery, and what's new in Celery 3.0</a></li>
<li><a href="../158963/index.html">Eliminating the artifacts of compression PVRTC textures</a></li>
<li><a href="../158969/index.html">Difficult forms in Django</a></li>
<li><a href="../158971/index.html">Scripting Techniques in Bash</a></li>
<li><a href="../158973/index.html">Good Practice on setting up a small local network based on Active Directory</a></li>
<li><a href="../158975/index.html">Introduction to Pedestrian Modeling</a></li>
<li><a href="../158977/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, ‚Ññ4 (03.11.2012 - 16.11.2012)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>