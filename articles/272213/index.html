<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visual tests with the Galen Framework. Improving code readability</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Two years have passed since the writing of the first article on the Galen Framework . At that time, all that Galen was was just a simple set of checks...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visual tests with the Galen Framework. Improving code readability</h1><div class="post__text post__text-html js-mediator-article">  Two years have passed since the writing of the <a href="http://habrahabr.ru/post/203506/">first article</a> on the <a href="http://galenframework.com/">Galen Framework</a> .  At that time, all that Galen was was just a simple set of checks for locating page elements relative to other elements.  Then it was not possible either to check the screenshot pixel-by-pixel, nor to expand the language of Galen Specs, which, in fact, is the basis of the framework.  Also, tests could be run using only one format of test suites, which greatly limited the possibilities of Galen tests.  Since then, thanks to community support, a lot has changed in Galen.  Today, this is a full-fledged tool for visual testing, which can not only check screenshots pixel-by-pixel and apply filters to the test images, but also provides a rich set of features that allow you to expand the capabilities of the <a href="http://galenframework.com/docs/reference-galen-spec-language-guide/">Galen Specs</a> language.  In this article I would like to demonstrate the new features of the Galen Specs language, and also show how to improve the readability of visual tests in the Galen Framework using the example of <a href="http://galenframework.github.io/galen-extras/website/index.html">this page</a> . <br><br><img src="https://habrastorage.org/files/5ee/3fc/43b/5ee3fc43b6c8465683d1449663bad363.png"><br><br>  Readability is one of the important properties of any test code.  One of my employees even argued that the readability of tests is more important than the readability of the main code, since  It is the test that will be the entry point when trying to figure out how any functionality works in the application.  I liked this idea, and I decided to apply it for visual tests in the Galen Framework.  My goal was to write a test, reading which, it will become clear how the site should look like in different browser sizes.  Let's take a look at the most common cases when testing the layout of an adaptive site and try to figure out how to improve our tests. <br><a name="habracut"></a><br>  Since the release of the first version of the Galen Framework, all my attempts to write a clear visual test have failed.  At first, the test code was clear, but as soon as the number of elements on a page went over 10, it became difficult to understand and maintain these massive sets of instructions. <br>  One of the most common examples is horizontally spaced repeating elements (ex. Menu) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/630/bd5/997/630bd5997b304b7894568a95bd1419ac.png"><br><br>  Our test site in desktop resolution looks like this: <br><br><img src="https://habrastorage.org/files/d5a/7a5/e38/d5a7a5e38ae14b2b968c8e5c66789e5b.png"><br><br>  To test the elements of the horizontal menu in Galen, using standard instructions, you have to write similar code: <br><br><pre><code class="bash hljs">@objects menu <span class="hljs-comment"><span class="hljs-comment">#menu ul item-* li a = Menu = @forEach [menu.item-*] as menuItem, next as nextItem ${menuItem}: left-of ${nextItem} 0 to 5px aligned horizontally all ${nextItem}</span></span></code> </pre> <br><br>  As you can see, this code is the most common loop in which all menu items are sorted.  Each menu item compares with the following, checking the alignment between the upper and lower edges, as well as the distance between the elements.  This piece of code itself looks quite understandable, but once a lot of such blocks are used in one file, it becomes difficult to understand. <br><br>  Let's run this test and look at the reports: <br><br><pre> <code class="bash hljs">galen check homepage.gspec --url http://galenframework.github.io/galen-extras/website/index.html --size 1024x768 --htmlreport reports</code> </pre><br><br>  As a result, we get the following report: <br><br><img src="https://habrastorage.org/files/aef/636/0fb/aef6360fbd974810919aa8557e60d365.png"><br><br>  Not very informative.  When you look at such reports or try to penetrate into the test code, there are always questions: why was this or that test chosen?  What exactly did they want to test?  etc. <br><br>  So how can you improve this code?  So-called <a href="http://galenframework.com/docs/reference-galen-spec-language-guide/">Custom Rules</a> come to the rescue.  In short, it is something like a function, only the parameters are parsed from the usual sentence written by the user.  For now, let's leave the parameterization for later and try first to implement the simplest rule.  For example, for the above case we can create the expression <i>‚Äúmenu items are aligned horizontally next to each other‚Äù</i> .  A little later we will add parameters to this expression.  And so that it does not callus our eyes in the main test file, transfer it to the file <b>my-rules.gspec</b> : <br><br><pre> <code class="bash hljs">@rule menu items are aligned horizontally next to each other @forEach [menu.item-*] as menuItem, next as nextItem <span class="hljs-variable"><span class="hljs-variable">${menuItem}</span></span>: left-of <span class="hljs-variable"><span class="hljs-variable">${nextItem}</span></span> 0 to 5px aligned horizontally all <span class="hljs-variable"><span class="hljs-variable">${nextItem}</span></span></code> </pre><br><br>  Now, instead of this code in the main file, we can call this function like this <br><br><pre> <code class="bash hljs">@import my-rules.gspec @objects menu <span class="hljs-comment"><span class="hljs-comment">#menu ul item-* li a = Menu = | menu items are aligned horizontally next to each other</span></span></code> </pre><br><br>  Another good thing is that in the report we will also see the same sentence, and all its checks will be grouped under it.  Thus, our reports will also be more readable. <br><br><img src="https://habrastorage.org/files/e70/be1/de2/e70be1de26364f998c693ca4822c18a4.png"><br><br>  Now we can improve our expression by adding parameters to it.  For example, if we look at a page, we will see more <code>box</code> elements on it, to which this check also applies.  It would not be bad to use the same expression for different objects.  Let's try to change our expression to this by substituting <code>objectPattern</code> and <code>margin</code> parameters into it: <br><br><pre> <code class="bash hljs">@rule %{objectPattern} are aligned horizontally next to each other with %{margin} margin @forEach [<span class="hljs-variable"><span class="hljs-variable">${objectPattern}</span></span>] as item, next as nextItem <span class="hljs-variable"><span class="hljs-variable">${item}</span></span>: left-of <span class="hljs-variable"><span class="hljs-variable">${nextItem}</span></span> <span class="hljs-variable"><span class="hljs-variable">${margin}</span></span> aligned horizontally all <span class="hljs-variable"><span class="hljs-variable">${nextItem}</span></span></code> </pre><br><br>  Now we change our test: <br><br><pre> <code class="bash hljs">@import my-rules.gspec @objects menu <span class="hljs-comment"><span class="hljs-comment">#menu .middle-wrapper item-* ul li box-* .box-container .box .panel = Menu = | menu.item-* are aligned horizontally next to each other with 0 to 5px margin = Main Section = | box-* are aligned horizontally next to each other with ~ 30px margin</span></span></code> </pre><br><br>  Already better.  The only thing I don‚Äôt like is to use <code>-*</code> characters in all these expressions.  Transferring them to <b>@rule</b> is not a reasonable solution, since  the flexibility of our design is impaired.  But specifically in this case, we can use the <a href="http://galenframework.com/docs/reference-galen-spec-language-guide/">grouping of objects</a> in the test itself.  It works as follows.  After declaring objects in the new <b>@groups</b> section <b>,</b> we can specify groups of objects, come up with a name for each of the groups and list which objects we want to merge.  For now <b>let's</b> create two groups, <b>menu_items</b> and <b>boxes</b> . <br><br><pre> <code class="bash hljs">@import my-rules.gspec @objects menu <span class="hljs-comment"><span class="hljs-comment">#menu .middle-wrapper item-* ul li box-* .box-container .box .panel @groups menu_items menu.item-* boxes box-*</span></span></code> </pre><br><br>  Now, instead of the <code>menu.item-*</code> and <code>box-*</code> search expressions, we can specify groups using the <code>&amp;</code> <br><br><pre> <code class="bash hljs">= Menu = | &amp;menu_items are aligned horizontally next to each other with 0 to 5px margin = Main Section = | &amp;boxes are aligned horizontally next to each other with ~ 30 px margin</code> </pre><br><br>  Now our checks are even more readable.  However, the page we are testing is responsive, and our checks only work for a large screen.  If you check the layout on the mobile resolution (eg 450 pixels wide), you will see that the menu items are displayed in a table with two columns. <br><br><img src="https://habrastorage.org/files/908/9d4/8e5/9089d48e5b3b446d8a973fd9b2ad19b7.png"><br><br>  Also, the box elements are aligned not horizontally, but vertically.  Let's try to implement these new expressions so that we end up with something like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ... = Menu = @on desktop, tablet | &amp;menu_items are aligned horizontally next to each other with 0 to 5px margin @on mobile | &amp;menu_items are rendered in 2 column table layout, with 0px vertical and 0 to 4px horizontal margin = Main Section = @on desktop, tablet | &amp;boxes are aligned horizontally next to each other with ~30 px margin @on mobile | &amp;boxes are aligned vertically above each other with 20px margin</span></span></code> </pre><br><br>  Verification of the vertical arrangement of elements for mobile layout of boxes can be copied from the horizontal and slightly corrected: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ... @rule %{objectPattern} are aligned vertically above each other with %{margin} margin @forEach [${objectPattern}] as item, next as nextItem ${item}: aligned vertically all ${nextItem} above ${nextItem} ${margin}</span></span></code> </pre><br><br>  But with the table rendering of menu items will be a little more difficult.  Let's try to implement this check using JavaScript code.  To do this, create a <code>my-rules.js</code> file and import it into the <code>my-rules.gspec</code> : <br><br><pre> <code class="bash hljs">@script my-rules.js <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br><br>  Well, in the file my-rules.js, we will write the following piece of code.  We use the built-in findAll function, which finds all the specified elements in a search expression. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_ruleRenderedInTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rule, itemPattern, columns, verticalMargin, horizontalMargin</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allItems = findAll(itemPattern); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentColumn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; allItems.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i += <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentColumn &lt; columns - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//          rule.addObjectSpecs(allItems[i].name, [ "left-of " + allItems[i + 1].name + " " + horizontalMargin, "aligned horizontally all " + allItems[i + 1].name ]); } var j = i + columns; if (j &lt; allItems.length) { //      ,    rule.addObjectSpecs(allItems[i].name, [ "above " + allItems[j].name + " " + verticalMargin, "aligned vertically all " + allItems[j].name ]); } currentColumn += 1; if (currentColumn === columns) { currentColumn = 0; } } } rule("%{itemPattern} are rendered in %{columns: [0-9]+} column table layout, with %{verticalMargin} vertical and %{horizontalMargin} horizontal margin", function (objectName, parameters) { _ruleRenderedInTable(this, parameters.itemPattern, parseInt(columns), parameters.verticalMargin, parameters.horizontalMargin); });</span></span></code> </pre><br><br>  Notice the syntax <code>%{columns: [0-9]+}</code> .  In this case, we specify our own regular expression <code>[0-9]+</code> instead of the standard <code>.*</code> , Which will be used for the <code>columns</code> parameter.  Although it is not necessary, but in this way we make protection from typos.  Since we added checks for three different layouts, we need to prepare a test suite in order to run tests on all virtual devices (desktop, tablet, mobile) with one team.  Create the file <b>my.test</b> : <br><br><pre> <code class="bash hljs">@@ table devices | tag | size | | desktop | 1024x768 | | tablet | 800x600 | | mobile | 500x700 | @@ parameterized using devices Home page <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> on <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> device http://galenframework.github.io/galen-extras/website/index.html <span class="hljs-variable"><span class="hljs-variable">${size}</span></span> check homepage.gspec --include <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${tag}</span></span></span><span class="hljs-string">"</span></span></code> </pre><br><br>  Now you can run tests using the command <br><br><pre> <code class="bash hljs">galen <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> my.test --htmlreport reports</code> </pre><br><br>  As a result, we obtain the following reports: <br><br><img src="https://habrastorage.org/files/2c9/a1c/feb/2c9a1cfeb11a4b728670b9a268408f05.png"><br><br><img src="https://habrastorage.org/files/93b/752/20c/93b75220c0a4443b8f56a4bfe25340a7.png"><br><br><h4>  What's next? </h4><br><br>  After lengthy experiments with different layouts, I created the <a href="https://github.com/galenframework/galen-extras">Galen Extras</a> project.  In this project, I implemented extensions for the most common cases.  The main code is in the files <a href="https://github.com/galenframework/galen-extras/blob/master/galen-extras/galen-extras-rules.gspec">galen-extras-rules.gspec</a> and <a href="">galen-extras-rules.js</a> <br><br>  I will not describe in detail the development of all the other special expressions, I will just show what happened in the end.  Here is a test that checks all items on the page: <br><br><pre> <code class="bash hljs">@import galen-extras/galen-extras-rules.gspec @objects header <span class="hljs-comment"><span class="hljs-comment">#header .middle-wrapper box-* .box-container .box .panel menu #menu .middle-wrapper item-* ul li content #content greeting #content h1 footer #footer .middle-wrapper @groups (box, boxes) box-* (menu_item, menu_items) menu.item-* skeleton_elements header, menu, content, footer skeleton_element &amp;skeleton_elements image_validation header, menu.item-* = Skeleton = | &amp;skeleton_elements sides are inside screen with 0px margin from top and bottom | &amp;skeleton_elements are aligned vertically above each other with 0 to 1px margin = Page is centered horizontally inside screen with 900px on desktop, but on mobile and tablet it stretches to screen = | every &amp;skeleton_element is centered horizontally inside screen @on desktop | every &amp;skeleton_element has width 900px @on mobile, tablet | every &amp;skeleton_element is aligned vertically all screen = Menu items should adapt layout = @on * | amount of visible &amp;menu_items should be 4 | every &amp;menu_item is inside menu and has height ~ 64px | first &amp;menu_item is inside menu 0px top left @on desktop, tablet | &amp;menu_items are aligned horizontally next to each other with 0 to 5px margin @on mobile | &amp;menu_items are rendered in 2 column table layout, with 0px vertical and 0 to 4px horizontal margin = Main Section = = Greeting = greeting: height 30 to 60px inside content 40px top, 20px left right @on * | amount of visible &amp;boxes should be 3 | test all &amp;boxes with box-component.gspec @on desktop, tablet | &amp;boxes are aligned horizontally next to each other with equal distance | &amp;box sides are inside content with 20px margin from left and right | every &amp;box is below greeting ~ 10px | every &amp;box is above footer &gt; 19px @on mobile | &amp;boxes are aligned vertically above each other with 20px margin | every &amp;box is inside content 20px left right | first &amp;box is below greeting ~ 10px | last &amp;box is above footer &gt; 19px</span></span></code> </pre><br><br>  As you can see, not all cases turned out to write special expressions.  For example, in the section <i>‚ÄúPage is centered horizontally inside screen with 900px ...‚Äù</i> I had to split the checks into several subexpressions.  Unfortunately, it seemed to me difficult to write a special expression for all the varieties of this particular case.  The result would be too long and, accordingly, the probability of typos would increase.  But if you have ideas on how to expand or improve all these expressions - I will be happy with your pool of requests. <br><br>  By the way, I also prepared a <a href="http://galenframework.github.io/galen-extras/website-bad/index.html">version of the site</a> with layout bugs: <br><br><img src="https://habrastorage.org/files/587/749/edc/587749edcdb043d5b65837d83cd69317.png"><br><br>  If we run the same tests for this version of the site, we will see errors like these in the reports: <br><br><img src="https://habrastorage.org/files/f3d/243/d99/f3d243d992944259b3800a1078a4a103.png"><br><br><h4>  Conclusion </h4><br><br>  As you can see, if you accurately use the <b>@rule</b> feature, you can achieve very good results, significantly reduce your test code and improve test support.  Also, this approach will be easier to apply for TDD in the development of the site.  And what's more important, such code will be clear documentation that explains where and how the site should look.  In the next article I will try to look at the Galen Framework from the other side and describe in detail the various techniques for pixel-by-image comparison of images. <br><br><h4>  Links </h4><br><br><ol><li>  <a href="https://github.com/galenframework/galen-extras">Galen Extras Documentation</a> </li><li>  <a href="http://galenframework.com/docs/reference-galen-spec-language-guide/">Full documentation on the language of Galen Specs</a> </li><li>  <a href="https://github.com/galenframework/galen">Galen framework on github</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/272213/">https://habr.com/ru/post/272213/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272203/index.html">Where does IaaS work?</a></li>
<li><a href="../272205/index.html">10 attacks on web applications in action</a></li>
<li><a href="../272207/index.html">Kazakhstan introduces its CA to listen to all TLS traffic</a></li>
<li><a href="../272209/index.html">GDG DevFest Nizhny Novgorod 2015: photo report from the event</a></li>
<li><a href="../272211/index.html">SQL Server 2016 CTP3.1 - what's new for the developer?</a></li>
<li><a href="../272215/index.html">I believe - I do not believe in indie development. Part 1</a></li>
<li><a href="../272223/index.html">Google Chrome web browser provided another security enhancement</a></li>
<li><a href="../272227/index.html">Java 9 will be postponed for half a year</a></li>
<li><a href="../272229/index.html">Why are our high-level languages ‚Äã‚Äãstill not so high-level?</a></li>
<li><a href="../272231/index.html">Lori Timesheets - time tracking on the CUBA platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>