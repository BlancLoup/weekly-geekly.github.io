<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interactive SVG cartogram with d3.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to you, graceful! Today I will tell you how to make an interactive SVG cartogram using d3js.org , about the capabilities of this JavaScript ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interactive SVG cartogram with d3.js</h1><div class="post__text post__text-html js-mediator-article">  Greetings to you, graceful!  Today I will tell you how to make an interactive <abbr title="Scalable Vector Graphics">SVG</abbr> cartogram using <a href="http://d3js.org/">d3js.org</a> , about the capabilities of this <b>JavaScript</b> library in general, and also have to figure out a little how and where it is better to store geo-information for the web.  In the final we get the following: <br><br><img src="https://habrastorage.org/storage2/f54/73c/b31/f5473cb31f4ca79fdd051ae81cc4a7d4.png" alt="Cartogram"><br>  You can start this exciting journey under the cut. <a name="habracut"></a><br><br><h4>  Cartographic affairs. </h4><br>  In principle, this section can be skipped, if not interesting, a link to the desired file at the very end of the section.  Who cares, understand further.  What is a map, in fact, is information about the geometry of a certain object with reference to coordinates.  In <abbr title="Geographic Information System">GIS</abbr> systems, <a href="http://ru.wikipedia.org/wiki/Shapefile">shapefiles</a> are usually used for this purpose.  We will draw a map of Russia, most likely the search will lead you to the same place as me, namely on the <a href="http://gis-lab.info/qa/rusbounds-rosreestr.html">GIS-Lab</a> .  I chose the <b>Albers-Siberia</b> projection.  Download  First of all, we need to transform our shapefile according to the <a href="http://ru.wikipedia.org/wiki/WGS_84">WGS 84</a> standard (it‚Äôs the same EPSG: 4326).  To do this, you need to create a <a href="http://gis-lab.info/qa/gis-lab-projections.html">projection</a> file, for example, <code>Albers_Siberia.prj</code> with the following contents <a name="prj_param"></a>  : <br><pre> <code class="markdown hljs">+proj=aea +lat<span class="hljs-emphasis"><span class="hljs-emphasis">_1=52 +lat_</span></span>2=64 +lat<span class="hljs-emphasis"><span class="hljs-emphasis">_0=0 +lon_</span></span>0=105 +x<span class="hljs-emphasis"><span class="hljs-emphasis">_0=18500000 +y_</span></span>0=0 +ellps=krass +units=m +towgs84=28,-130,-95,0,0,0,0 +no_defs</code> </pre><br>  Then, using <a href="http://www.gdal.org/">GDAL</a> , or rather one of its <a href="http://www.gdal.org/ogr2ogr.html">OGR</a> libraries, we will perform the conversion.  I downloaded <a href="http://www.qgis.org/">Quantum GIS</a> for these needs, which already contains everything you need and even more.  After installation, you will have several shortcuts, look for <code>OSGeo4W</code> among them, click on it, go to the directory with our files and enter the following command: <br><pre> <code class="bash hljs"> ogr2ogr -f <span class="hljs-string"><span class="hljs-string">'ESRI Shapefile'</span></span> -s_srs Albers_Siberia.prj -t_srs EPSG:4326 input-fixed.shp input.shp</code> </pre><br>  Thus, we got the shapefile we need, although as needed, it doesn‚Äôt suit us at all on the web, so now we will generate a <a href="http://geojson.org/">GeoJSON</a> file based on our data.  Then from GeoJSON we will generate <a href="https://github.com/mbostock/topojson/wiki">TopoJSON</a> , which is needed for our cartogram.  Such are the cases, but do not worry, GeoJSON is useful, maybe it will be useful.  So, we go back to the console and write about the following: <br><pre> <code class="bash hljs"> ogr2ogr -f GeoJSON output.json input.shp</code> </pre><br>  We get our GeoJSON file, open it and see a surprise from GIS-Lab. <br><div class="spoiler">  <b class="spoiler_title">Encryption from GIS-Lab</b> <div class="spoiler_text">  Generally speaking, this feature is present in the shapefile initially, but I noticed this ‚Äúpleasant‚Äù surprise only at this stage.  The feature is that all the names of the regions are encrypted from the enemies of the Motherland and are displayed by kryakozyabrami.  But our man knows where to look for the <a href="http://habrahabr.ru/post/147843/">encryption book</a> .  But it was not there.  Not one Cyrillic encoding came up (there were meaningful names on DOS-866, but some letters were displayed in different squares), then I became thoughtful and went to search for truth on the Internet, maybe I was looking bad, but on the GIS-Lab forums, and in other places there was nothing at all about the krakozyabr on this map at all (and the map from 2010, as I understand it), I was completely desperate, opened again the EditPad (there, I think, most of the encodings are presented, and indeed it is very convenient to work with text and regulars) and began to sort through all the encodings in a row, and, lo and behold, when you  Ore <b>MIK encoding:</b> (!?) <b>Bulgarian</b> got almost what I wanted, namely the names of regions.  True, all the letters in the names were separated by the DOS symbol ‚îú, well, a simple regulars solved this problem rather quickly.  Although why a problem, this is a cipher, and we have passed the test of friend or foe =).  By the way, this file has one more feature, which the truth immediately mentions on the GIS-Lab, namely: there are no borders of the Chechen and Ingush republics on the map due to the lack of data from the Rosreestr (well, they don‚Äôt want to go there on a business trip, and everyone is here).  Well, yes, in principle, not scary (although to whom of course), but the unpleasant sediment remained. </div></div><br>  Now let's move on to generating TopoJSON, this will allow us to reduce the file size.  In general, TopoJSON is GeoJSON‚Äôs optimization in topology, it removes redundant information, for example, it removes duplication of common borders from neighboring regions.  But we can reduce the file size even more by simplifying the geometry.  So let's get started!  Run the <a href="http://nodejs.org/">Node.js</a> command line (it is needed for the implementation of <a href="https://npmjs.org/package/topojson">TopoJSON</a> ) and write the following: <br><pre> <code class="bash hljs"> topojson -o output_topo.json -p -s 1e-7 -- name=input_geo.json</code> </pre><br>  Here, the <code>-p</code> parameter is responsible for the preservation of the <code>feature properties</code> , and <code>-s 1e-7</code> for simplifying the geometry, <code>1e-7</code> is the threshold in <a href="http://en.wikipedia.org/wiki/Steradian">steradians,</a> the smaller, the more accurate the geometry: <code>1e-3</code> is Switzerland relative to the world map, and <code>1e-9</code> football field.  For what it may be necessary - if you want to make it possible to zoom on your map.  The separator <code>--</code> just a separator (your KO) of the output and input files, and the <code>russia</code> prefix specifies the name of the object, if you do not specify it, then the name of the input file will be used as a name, which is not always convenient (can be cumbersome).  In the resulting file, I replaced the names of the regions with codes in accordance with <a href="http://ru.wikipedia.org/wiki/ISO_3166-2:RU">ISO 3166-2: RU</a> .  Everything.  The file can be taken on <a href="https://github.com/KoGor/Maps.GeoInfo">GitHub</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  We draw the cartogram </h4><br>  Map will draw at all, or how?  Now we have everything we need to draw a map using d3.js.  Copy the following template and proceed: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Accidents on the Road - Choropleth<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://d3js.org/d3.v3.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://d3js.org/queue.v1.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://d3js.org/topojson.v0.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"&gt;&lt;/script&gt; --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> your awesome CSS </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Cool Header<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> Your awesome d3.js code </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  First, let's set the size of our SVG map. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> width = <span class="hljs-number"><span class="hljs-number">960</span></span>, height = <span class="hljs-number"><span class="hljs-number">500</span></span>;</code> </pre><br>  Let's set the domain of colors for the cartogram, the domain for the legend and the legend legend. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> color_domain = [<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>, <span class="hljs-number"><span class="hljs-number">750</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ext_color_domain = [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-number"><span class="hljs-number">350</span></span>, <span class="hljs-number"><span class="hljs-number">750</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> legend_labels = [<span class="hljs-string"><span class="hljs-string">"&lt; 50"</span></span>, <span class="hljs-string"><span class="hljs-string">"50+"</span></span>, <span class="hljs-string"><span class="hljs-string">"150+"</span></span>, <span class="hljs-string"><span class="hljs-string">"350+"</span></span>, <span class="hljs-string"><span class="hljs-string">"750+"</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt; 1500"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> color = d3.scale.threshold() .domain(color_domain) .range([<span class="hljs-string"><span class="hljs-string">"#adfcad"</span></span>, <span class="hljs-string"><span class="hljs-string">"#ffcb40"</span></span>, <span class="hljs-string"><span class="hljs-string">"#ffba00"</span></span>, <span class="hljs-string"><span class="hljs-string">"#ff7d73"</span></span>, <span class="hljs-string"><span class="hljs-string">"#ff4e40"</span></span>, <span class="hljs-string"><span class="hljs-string">"#ff1300"</span></span>]);</code> </pre><br>  Add an element and a tooltip class to the document. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> div = d3.select(<span class="hljs-string"><span class="hljs-string">"body"</span></span>).append(<span class="hljs-string"><span class="hljs-string">"div"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"tooltip"</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  Add SVG with attributes that define the size. <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> svg = d3.select(<span class="hljs-string"><span class="hljs-string">"body"</span></span>).append(<span class="hljs-string"><span class="hljs-string">"svg"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"width"</span></span>, width) .attr(<span class="hljs-string"><span class="hljs-string">"height"</span></span>, height);</code> </pre><br>  Let's set the projection parameters (remember / look at <a href="https://habr.com/ru/post/181766/">Albers_Siberia.prj</a> from the beginning of the article): <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> projection = d3.geo.albers() .rotate([<span class="hljs-number"><span class="hljs-number">-105</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>]) .center([<span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>]) .parallels([<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>]) .scale(<span class="hljs-number"><span class="hljs-number">700</span></span>) .translate([width / <span class="hljs-number"><span class="hljs-number">2</span></span>, height / <span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = d3.geo.path().projection(projection);</code> </pre><br>  We read the data. <br><br><pre> <code class="javascript hljs"> queue() .defer(d3.json, <span class="hljs-string"><span class="hljs-string">"/d/5685937/russia_1e-7sr.json"</span></span>) .defer(d3.csv, <span class="hljs-string"><span class="hljs-string">"Accidents.csv"</span></span>) .await(ready);</code> </pre><br>  Start drawing.  Create objects for couples <code> : - </code> and <code> :  </code> . <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ready</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, map, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rateById = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nameById = {}; data.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ rateById[d.RegionCode] = +d.Deaths; nameById[d.RegionCode] = d.RegionName; });</code> </pre><br>  Drawing and coloring cartograms. <br><br><pre> <code class="javascript hljs"> svg.append(<span class="hljs-string"><span class="hljs-string">"g"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"region"</span></span>) .selectAll(<span class="hljs-string"><span class="hljs-string">"path"</span></span>) .data(topojson.object(map, map.objects.russia).geometries) <span class="hljs-comment"><span class="hljs-comment">//.data(topojson.feature(map, map.objects.russia).features) &lt;-- in case topojson.v1.js .enter().append("path") .attr("d", path) .style("fill", function(d) { return color(rateById[d.properties.region]); }) .style("opacity", 0.8)</span></span></code> </pre><br>  We process events: we change the brightness of the region (for highlighting) and output the region name and the exact numerical value in the tooltip. <br><br><pre> <code class="javascript hljs"> .on(<span class="hljs-string"><span class="hljs-string">"mouseover"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ d3.select(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).transition().duration(<span class="hljs-number"><span class="hljs-number">300</span></span>).style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); div.transition().duration(<span class="hljs-number"><span class="hljs-number">300</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) div.text(nameById[d.properties.region] + <span class="hljs-string"><span class="hljs-string">" : "</span></span> + rateById[d.properties.region]) .style(<span class="hljs-string"><span class="hljs-string">"left"</span></span>, (d3.event.pageX) + <span class="hljs-string"><span class="hljs-string">"px"</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"top"</span></span>, (d3.event.pageY <span class="hljs-number"><span class="hljs-number">-30</span></span>) + <span class="hljs-string"><span class="hljs-string">"px"</span></span>); }) .on(<span class="hljs-string"><span class="hljs-string">"mouseout"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ d3.select(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .transition().duration(<span class="hljs-number"><span class="hljs-number">300</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">0.8</span></span>); div.transition().duration(<span class="hljs-number"><span class="hljs-number">300</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); })</code> </pre><br>  Now I would like to learn how to add something to this very map, I decided to add the million cities of Russia, for this we actually need the city itself and its coordinates (latitude and longitude in decimal degrees), unfortunately to find a geocoder like this <a href="http://www.gpsvisualizer.com/geocoder/">gpsvisualizer.com/ geocoder</a> , so that he understands Russian, I could not (can anyone know?), but I did not want to go into the Yandex.Maps API, especially as the list is small.  It would be nice if they themselves did such a koldunchik, but oh well, I was distracted.  As a result, received a list of the following form: <br><br><pre> <code class="markdown hljs">City lat lon  55.7522200 37.6155600 - 59.8944400 30.2641700</code> </pre><br>  Well, actually, add them in a group: <code>-</code> . <br><br><pre> <code class="javascript hljs"> d3.tsv(<span class="hljs-string"><span class="hljs-string">"cities.tsv"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> city = svg.selectAll(<span class="hljs-string"><span class="hljs-string">"g.city"</span></span>) .data(data) .enter() .append(<span class="hljs-string"><span class="hljs-string">"g"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"city"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"transform"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"translate("</span></span> + projection([d.lon, d.lat]) + <span class="hljs-string"><span class="hljs-string">")"</span></span>; }); city.append(<span class="hljs-string"><span class="hljs-string">"circle"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"r"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"fill"</span></span>, <span class="hljs-string"><span class="hljs-string">"lime"</span></span>) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">0.75</span></span>); city.append(<span class="hljs-string"><span class="hljs-string">"text"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) .text(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d.City; }); }); };</code> </pre><br>  Here I would like to add that instead of points you can add, for example, a pie / donut chart, thereby increasing the information load on our cartogram.  In general, the possibilities are mass, everything is limited by your tasks, imagination and expediency from the point of view of <abbr title="User interface">UI</abbr> / <abbr title="User eXperience">UX</abbr> . <br><br>  Well, at the end we will add the legend of our cartogram: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> legend = svg.selectAll(<span class="hljs-string"><span class="hljs-string">"g.legend"</span></span>) .data(ext_color_domain) .enter().append(<span class="hljs-string"><span class="hljs-string">"g"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"legend"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ls_w = <span class="hljs-number"><span class="hljs-number">20</span></span>, ls_h = <span class="hljs-number"><span class="hljs-number">20</span></span>; legend.append(<span class="hljs-string"><span class="hljs-string">"rect"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height - (i*ls_h) - <span class="hljs-number"><span class="hljs-number">2</span></span>*ls_h;}) .attr(<span class="hljs-string"><span class="hljs-string">"width"</span></span>, ls_w) .attr(<span class="hljs-string"><span class="hljs-string">"height"</span></span>, ls_h) .style(<span class="hljs-string"><span class="hljs-string">"fill"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> color(d); }) .style(<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>, <span class="hljs-number"><span class="hljs-number">0.8</span></span>); legend.append(<span class="hljs-string"><span class="hljs-string">"text"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height - (i*ls_h) - ls_h - <span class="hljs-number"><span class="hljs-number">4</span></span>;}) .text(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d, i</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> legend_labels[i]; });</code> </pre><br>  That's basically all, I tried to show the main points on a simple example, I hope that I succeeded.  The code is of course not perfect (nothing is perfect), but the goal, I repeat, was to make it understandable, and not super universal / effective.  Sources can be found on <a href="https://gist.github.com/KoGor/5685876">GitHub</a> , and you can touch the result through the service <a href="http://bl.ocks.org/KoGor/5685876">bl.ocks.org</a> .  Yes, we did not consider <abbr title="Cascading Style Sheets">CSS</abbr> here, but everything is trivial there. <br><br><h4>  Results  What's next? </h4><br>  Well, we created a simple cartogram, without the possibility of approaching, complex animation and other bells and whistles, but if you want to add them here, it will not be difficult.  In general, this library has the broadest possibilities for visualizing everything and everything: graphs, charts, cartograms, trees, graphs, charts, heatmaps ...  Such a DataViz harvester, everything you need can be found through the site <a href="http://d3js.org/">d3js.org</a> .  <b>Mike Bostock is</b> actively developing the project, almost every day it lays out new examples (one minus, almost all without comments), on <a href="">stackoverflow</a> there are also a lot of things and respond there promptly, including Mike himself.  So go ahead, IMHO this library, which is essentially the main visualization tool behind the hill, is unfairly deprived of attention in us.  Well and I, if it will be interesting to a habrosobosomstve, I will periodically sort interesting examples.  Actually everything, comments, questions and suggestions are welcome. <br><br>  <i>PS I almost forgot the most important thing, be careful on the roads, especially if you are not from Chukotka, we have enough freaks and plenty of video from the recorders is a confirmation!</i>  <i>In general, it is sad, almost 28 thousand deaths per year, the horror is simple (data was taken from the traffic police site).</i> </div><p>Source: <a href="https://habr.com/ru/post/181766/">https://habr.com/ru/post/181766/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181754/index.html">Understanding Html code generated by unobtrusive validation in ASP.Net MVC</a></li>
<li><a href="../181756/index.html">Energy Management (Energy Management)</a></li>
<li><a href="../181758/index.html">The internal work of the jQuery validate unobtrusive plugin in ASP.Net MVC</a></li>
<li><a href="../181760/index.html">Sort the list by analogy of "Windows Explorer"</a></li>
<li><a href="../181764/index.html">3d modeling + livecoding = game development acceleration</a></li>
<li><a href="../181768/index.html">Testing Python 2.7 performance when processing lists in various ways</a></li>
<li><a href="../181770/index.html">Configuring Opera 15 with the "file" method</a></li>
<li><a href="../181772/index.html">MVC for the web: nowhere easier</a></li>
<li><a href="../181774/index.html">Short cartoon "Fortress"</a></li>
<li><a href="../181776/index.html">ERP implementation: how not to turn Enterprise Resource Planning into an Expensive Reasonless Program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>