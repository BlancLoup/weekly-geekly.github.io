<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web sockets: combat use</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web Sockets is a progressive standard for full-duplex (two-way) communication with the server over a TCP connection, compatible with HTTP. It allows y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web sockets: combat use</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/getpro/habr/post_images/209/9e2/9ee/2099e29ee972fb655566c16b4a37e3ef.jpg" alt="image">  <a href="http://en.wikipedia.org/wiki/WebSocket">Web Sockets</a> is a progressive standard for full-duplex (two-way) communication with the server over a TCP connection, compatible with HTTP.  It allows you to organize live messaging between the browser and the web server in real time, and in a completely different way than the usual "request URL - response" scheme.  When I looked at this standard two years ago, it was still in its infancy.  There was only an unapproved draft draft and experimental support by some browsers and web servers, and it was disabled by default in Firefox due to security issues.  However, now the situation has changed.  The standard has acquired several revisions (including those without backward compatibility), received RFC status ( <a href="http://tools.ietf.org/html/rfc6455">6455</a> ), and got rid of childhood diseases.  In all modern browsers, including IE10, support for one of the protocol versions is claimed, and there are quite ready for industrial use web servers. <br><br>  I decided it was time to try it on a live project.  And now I share what came of it. <br><a name="habracut"></a><br><h2>  The essence of the task </h2><br>  On my personal small site Klavogonki.ru there is a central part - a list of the current games of the races.  The list is extremely dynamic: players create a new race every few seconds, sometimes a few per second.  Tours begin with a countdown, at the end they are moved from the open games section to the active section.  After the release of all players check-in is removed from the page.  In one run comes from one and sometimes up to one hundred players that you want to display right there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb2/918/ddb/eb2918ddb604119ba19146e8d2f1436a.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How it worked before </h2><br>  Initially, when it became necessary to make this part of the site's functionality, many difficulties arose with the dynamic update of the list.  There are dozens of people on the list page at the same time, each of whom wants to see a fresh picture.  Many races can have a timeout from the creation to the start of just 10-20 seconds, and in order to be able to join them, the update must be quite lively. <br><br>  Updating the entire page by timeout here did not fit at all in any way, and it was necessary to look for other options (here it was necessary to make a remark that there was no wish to use the flash on the site without a very strong need). <br><br>  At first glance, the most obvious and simple solution seemed to be <a href="http://en.wikipedia.org/wiki/Push_technology">long-polling</a> - a hanging connection to the server, which breaks off at the moment when a new event arrives and is rediscovered.  However, after some tests, this option also proved to be unviable: events flowed in a continuous stream, because the client needs to be informed not only about the creation of a new game, but also about changing the parameters of all games (for example, starting the timeout, changing the status, the composition of players), and the number of requests cause a certain degree of discontent with the server.  And the overhead on opening and closing requests also came out rather big. <br><br>  HTTP-streaming could not be used due to problems with proxy servers for many users. <br><br>  Therefore, I stopped at a simple version of updating the page content by timeout every 3 seconds via ajax requests.  On the server, the current data was cached and delivered to cached clients in json, while not all the list was saved to save traffic, but only changed data through the versioning system (the version increased compared to the requested one - we give new information about the arrival, otherwise we give only the current version number). <br><br>  The system showed itself well and worked for a long time.  However, there was a big minus - it is very difficult to enter the race with a 10-second timeout before the start.  In addition, it was not at all consistent with the spirit of a dynamic racing online game and did not look too technologically as a whole. <br><br>  <b>You can see this page in its old version via <a href="http://klavogonki.ru/gamelist%3Fold%3D1">this link</a> .</b> <br><br><h2>  How it works now </h2><br>  In a nutshell, web sites allowed to drive into this whole process. <br><br>  To begin with, a server was chosen that should live in conjunction with the current gaming backend.  For a number of reasons, I chose for this <a href="http://nodejs.org/">node.js</a> - an event-oriented model and well-developed javascript callbacks were perfect for this task. <br><br>  A common environment for communication between the php backend and the server on node.js is the <a href="http://redis.io/topics/pubsub">reds pubsub channels</a> .  When creating a new game or any action that modifies the data, php does something like this (the code here and further is greatly simplified): <br><br><pre><code class="php hljs">$redis = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Redis(); $redis-&gt;pconnect(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">6379</span></span>); $redis-&gt;publish(<span class="hljs-string"><span class="hljs-string">"gamelist"</span></span>, json_encode(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"game created"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'gameId'</span></span> =&gt; $id))));</code> </pre> <br>  Redis works as a separate daemon on a separate TCP port and accepts / sends messages from any number of connected clients.  This makes it possible to scale the system well, regardless of the number of processes (and of servers, to be optimistic) php and node.js.  About 50 php processes and 2 node.js processes are currently spinning. <br><br>  On the node.js side, at startup, there is a connection to a redis-channel wiretap called <code>gamelist</code> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redis = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'redis'</span></span>).createClient(<span class="hljs-number"><span class="hljs-number">6379</span></span>, <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>), redis.subscribe(<span class="hljs-string"><span class="hljs-string">'gamelist'</span></span>);</code> </pre><br>  The <a href="http://socket.io/">Socket.IO</a> binding library is used for working with clients ( <b>upd:</b> comrades <a href="https://habrahabr.ru/users/voenniy/" class="user_link">Voenniy</a> and <a href="https://habrahabr.ru/users/joes/" class="user_link">Joes</a> <a href="http://habrahabr.ru/post/162301/">say</a> in the comments that there are better alternatives like <a href="https://github.com/sockjs/sockjs-client">SockJS</a> and <a href="https://github.com/GeometriaLab/Beseda">Beseda</a> , which may well be true).  It allows you to use web sockets as the main transport, while rolling back to other transports like flash or xhr-polling if the browser does not support web sockets.  In addition, it simplifies working with clients as a whole, for example, provides an API for multiplexing and splitting connected clients into different pseudo-directories (channels), allows you to name events and some other goodies. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>).listen(<span class="hljs-number"><span class="hljs-number">80</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gamelistSockets = io.of(<span class="hljs-string"><span class="hljs-string">'/gamelist'</span></span>);</code> </pre><br>  When a client browser connects to <code>ws://ws.klavogonki.ru/gamelist</code> it is recognized as a gamelist connected to the socketio channel.  The browser for this does the following: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ws.klavogonki.ru/socket.io/socket.io.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> socket = io.connect(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'ws.klavogonki.ru/gamelist'</span></span></span><span class="actionscript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  When an event from the backend arrives on the redis channel, it is analyzed in advance in every possible way and then sent to all connected clients in <code>gamelistSockets</code> : <br><br><pre> <code class="javascript hljs">redis.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">channel, rawMsgData</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(channel == <span class="hljs-string"><span class="hljs-string">'gamelist'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgData = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(rawMsgData); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgName = msgData[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgArgs = msgData[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(msgName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'game created'</span></span>: { ... gamelistSockets.emit(<span class="hljs-string"><span class="hljs-string">'game created'</span></span>, info); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'game updated'</span></span>: { ... gamelistSockets.emit(<span class="hljs-string"><span class="hljs-string">'game updated'</span></span>, info); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'player updated'</span></span>: { ... gamelistSockets.emit(<span class="hljs-string"><span class="hljs-string">'player updated'</span></span>, info); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } });</code> </pre><br>  The browser receives the event in exactly the same way and renders the necessary changes on the page. <br><br><pre> <code class="javascript hljs">socket.on(<span class="hljs-string"><span class="hljs-string">'game created'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ insertGame(data); }); socket.on(<span class="hljs-string"><span class="hljs-string">'game updated'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ updateGame(data); }); socket.on(<span class="hljs-string"><span class="hljs-string">'player updated'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ updatePlayer(data); });</code> </pre><br><br>  The principle is completely simple and clear.  Advanced technologies at the heart of this scheme make it possible to greatly simplify the process and focus on the logic of the work itself.  Although I had to tinker a bit with reworking some parts of the php code to work in the ideology of ‚Äúreporting a change, not about the state‚Äù, and also to transfer the domain of web sockets to a separate machine from the main machine (so as not to suffer with the sharing proxy on port 80), but the bottom line pluses came out very significant: <br><br><ul><li>  The highest dynamics of the interface, the update takes place in real time, you can track individual changes and feel in an online game, and not on the chat page of the 90s. <br></li><li>  There is almost no need for caching, because the data goes in transit from the backend directly to the browser. </li><li>  Organic saving of traffic on sending only the necessary state changes (if you try to fasten the compression, it will be even more interesting). </li><li>  The growth of the network load is almost imperceptible, since node.js was designed just to keep and process any conceivable number of simultaneous connections;  and the growth of the load on the CPU even fell, because the miscalculation of the state change is done once on the backend and is sent to all customers as a finished product. </li><li>  The event-oriented scheme gives you the opportunity to know about all the moments of changes in the data and, for example, to do the animation of floating and floating at the same time. </li></ul><br>  Solid profit, in short. <br><br>  <b>Look at what happened in the end, you <a href="http://klavogonki.ru/gamelist%3Fnew%3D1">can here</a> .</b>  The difference is visible to the naked eye. <br><br>  As a bonus, two tablets, small statistics on the audience Klavogonok, browsers and transports used in Socket.IO: <br><table><tbody><tr><th>  Browser </th><th>  Share </th><th>  Transport </th><th>  Share </th></tr><tr><td>  Chrome </td><td>  51% </td><td>  websocket </td><td>  90% </td></tr><tr><td>  Firefox </td><td>  20% </td><td>  xhr-polling </td><td>  five% </td></tr><tr><td>  Opera </td><td>  15% </td><td>  flashsocket </td><td>  four% </td></tr><tr><td>  IE (roughly in half 8 and 9) </td><td>  6% </td><td>  jsonppolling </td><td>  one% </td></tr></tbody></table>  As you can see, it is quite ready for use. <br><br><h2>  Total </h2><br>  There could be a concluding summary with a summary, bibliography and morality.  But I will save your time and I will say simply: <b>websockets are very cool!</b> <br><br>  <font color="#999999">PS In the newly developed parts of the project (including the one described above), such interesting words as <a href="http://www.mongodb.org/">mongodb</a> and <a href="http://angularjs.org/">angular.js are</a> also <a href="http://angularjs.org/">used</a> .</font>  <font color="#999999">If there is interest, then the following topics will be on this topic.</font> </div><p>Source: <a href="https://habr.com/ru/post/162301/">https://habr.com/ru/post/162301/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162289/index.html">Suggest.io: for people with queries</a></li>
<li><a href="../162291/index.html">Google accidentally passed the Chrome army self-destruction code</a></li>
<li><a href="../162293/index.html">SSD + PCIe = ???</a></li>
<li><a href="../162295/index.html">$ 10 VPS Optimization Experience for WordPress Personal Network</a></li>
<li><a href="../162299/index.html">Thin moments in the contract for the development of the site</a></li>
<li><a href="../162303/index.html">"Russian" smartphone with two screens will see the light</a></li>
<li><a href="../162305/index.html">Free English book "Programming Windows 8 Apps with HTML, CSS, and JavaScript"</a></li>
<li><a href="../162309/index.html">FLOWMASTER: Now in Digital!</a></li>
<li><a href="../162313/index.html">Create a module "New Mail" for Magento (Part 2)</a></li>
<li><a href="../162317/index.html">[Translation] Modern web developer, or 6 things you need to know to survive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>