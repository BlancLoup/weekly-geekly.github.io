<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android Cuvettes, Part 2: SDK and Libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing for Android, you always need to be alert. Step to the left / step to the right - and now another hour has passed after the debug. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android Cuvettes, Part 2: SDK and Libraries</h1><div class="post__text post__text-html js-mediator-article">  When developing for Android, you always need to be alert.  Step to the left / step to the right - and now another hour has passed after the debug.  The cuvettes can be anything from normal bugs in the SDK and ending with non-obvious method names with context-sensitive results (yes, <a href="http://developer.android.com/intl/ru/reference/android/app/Fragment.html">Fragment.getFragmentManager ()</a> , I mean you). <br><br>  In the <a href="https://habrahabr.ru/post/279811/">previous article</a> , we described cuvettes ‚Äúon the surface‚Äù of the SDK, into which it is very easy to please.  This time the cuvettes will be deeper, wiser and more specific.  There will also be a few points related to <a href="">Retrofit 2</a> &amp; <a href="https://github.com/google/gson">Gson</a> . <br><img src="https://habrastorage.org/getpro/habr/post_images/907/5f9/f9f/9075f9f9fefe6985f639b6ae3b6230c7.jpg" alt="image"><br><a name="habracut"></a><br><br><h4>  1. <a href="http://developer.android.com/intl/ru/reference/android/widget/GridLayout.html">GridLayout</a> does not respond to <b>layout_weight</b> </h4><br><h5>  Situation </h5><br>  Sometimes it happens that the usual way to create an object with a heap does not fit: <br><div class="spoiler">  <b class="spoiler_title">Ordinary form</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/50c/4ee/268/50c4ee268d6c14295f93743c5db705da.png" alt="image"><br></div></div><br>  Such a situation could be, for example, <b>landscape</b> form mapping.  I would like in this case to have something like this: <br><div class="spoiler">  <b class="spoiler_title">Form for landscape</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/16a/9e2/ee8/16a9e2ee81e1c5940ed7fe6974bf4480.png" alt="image"><br></div></div><br>  How to make the same alignment 50 to 50?  There are several <a href="http://developer.android.com/intl/ru/training/improving-layouts/optimizing-layout.html">basic approaches</a> : <br><ul><li>  Nested <a href="http://developer.android.com/reference/android/widget/LinearLayout.html">LinearLayout</a> </li><li>  <a href="http://developer.android.com/reference/android/widget/RelativeLayout.html">RelativeLayout</a> </li><li>  <a href="http://developer.android.com/reference/android/widget/TableLayout.html">TableLayout</a> or <a href="http://developer.android.com/reference/android/widget/GridLayout.html">GridLayout</a> </li></ul><br>  However, they all have their drawbacks: <br><ul><li>  The abundance of <b>LinearLayout</b> leads to xml's monstrosity <s>, and it leads to the death of seals</s> . </li><li>  <b>RelativeLayout</b> complicates the change in the future (swap a few lines in the form or add a separator will be the one more task. I‚Äôm completely silent about <b>View.setVisibility (View.GONE</b> ). </li><li>  Well, nobody uses <b>TableLayout</b> at all ... or uses it, but rarely.  I do not know such people. </li></ul><br>  Moreover, it is often necessary to use the magic number <a href="http://stackoverflow.com/questions/6975607/what-does-layout-height-0dp-mean">0dp &amp; weight = 1</a> to achieve a flexible design.  Neither <b>TableLayout</b> nor <b>RelativeLayout</b> will help you here.  When you first try to use something like <a href="http://stackoverflow.com/questions/13313996/what-does-ellipsize-mean-in-android">TextView.setEllipsize ()</a> , problems and pain will begin. <br>  And then you probably noticed that I missed another element.  It would seem that <b>GridLayout</b> comes to the rescue, but it also turns out to be useless due to the fact that it does not support the <b>layout_weight</b> property.  So what to do? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Decision </h5><br>  Until now, there was really nothing to do - either suffer with <b>RelativeLayout</b> , or use <b>LinearLayout</b> , or fill in everything programmatically (for especially perverted ones). <br>  However, since version 21, <b>GridLayout has</b> finally begun to support the <b>layout_weight</b> property and, most importantly, this change was added to <b>AppCompat</b> as <b>android.support.v7.widget.GridLayout</b> ! <br>  By the time I found out about this (and generally that the usual <b>GridLayout</b> wanted to weigh on my <b>weight</b> ), I spent at least a week trying to understand why my <b>layout</b> swam to the right (like <a href="https://code.google.com/p/android/issues/detail%3Fid%3D79177">this</a> ).  Perhaps this is one of the most important innovations, which, for some reason, remained without proper attention.  Fortunately, stackoverflow ( <a href="http://stackoverflow.com/a/10033481/2653714">1</a> , <a href="http://stackoverflow.com/a/10348166/2653714">2</a> ) responses are already beginning to be added. <br>  I also advise you to look at the page to the new <a href="http://developer.android.com/intl/ru/reference/android/support/percent/PercentRelativeLayout.html">PercentRelativeLayout</a> and <a href="http://developer.android.com/intl/ru/reference/android/support/percent/PercentFrameLayout.html">PercentFrameLayout</a> - this is really a bomb.  The name speaks for itself and allows you to make a highly responsive design.  iOS'niki appreciate.  And oh yeah, it is in <a href="http://developer.android.com/intl/ru/tools/support-library/features.html">AppCompat</a> . <br><br><h4>  2. <a href="http://developer.android.com/intl/ru/reference/android/app/Activity.html">Are</a> <a href="http://developer.android.com/intl/ru/reference/android/app/Fragment.html">Fragment.isRemoving ()</a> and <a href="http://developer.android.com/intl/ru/reference/android/app/Activity.html">Acitivity.isFinishing ()</a> equal? </h4><br><h5>  Situation </h5><br>  Once I wanted to write my <b>PresenterManager</b> as a singleton (hello from <b>MVP</b> ).  In order to remove <b>Presenters</b> in time, I used <b>Activity.isFinishing ()</b> , collecting <b>id Presenter</b> 's of activites and deleting them with it.  Naturally, this method worked poorly in the case of <a href="http://developer.android.com/intl/ru/reference/android/support/design/widget/NavigationView.html">NavigationView</a> - fragments changed through <a href="http://developer.android.com/intl/ru/reference/android/app/FragmentTransaction.html">FragmentTransaction.replace ()</a> , <b>Presenter</b> 's were accumulated and everything went under the tail of the cat. <br>  <a href="http://stackoverflow.com/questions/25450763/what-is-the-fragment-equivalent-of-activity-isfinishing">Googling smaltsa</a> , was found method <a href="http://developer.android.com/intl/ru/reference/android/app/Fragment.html">Fragment.isRemoving ()</a> , which seems to do the same thing, but for fragments.  I rewrote <b>PresenterManager's</b> code and was pleased.  The end‚Ä¶ <br><br><h5>  Decision </h5><br>  ... came my quiet life when I tried to make it work.  Honestly, I tried this way and that, but the behavior of this method is fundamentally different from <b>Activity.isFinishing ()</b> .  Google was wrong.  If you ever have a similar problem, think three times before using <b>Fragment.isRemoving ()</b> .  <a href="http://stackoverflow.com/a/34822148/2653714">I'm serious</a> .  Especially pay attention to the logs when you rotate the screen. <br><br>  By the way, with <a href="http://developer.android.com/intl/ru/reference/android/app/Activity.html">Acitivity.isFinishing (),</a> too, everything is not so smooth: minimize the application with&gt; 1 activation in the stack, wait for a situation of low memory, go back and use <a href="http://developer.android.com/intl/ru/training/implementing-navigation/ancestral.html">Up Navigation</a> and * voila *! .. This was a simple recipe for fucking an <b>Activity. isFinishing () == false</b> to activate, which you will never see again. <br>  <b>UPD</b> : As the <a href="https://habrahabr.ru/users/bejibx/" class="user_link">bejibx</a> user correctly noted, the remark about <b>Activity.isFinishing () is</b> not quite right.  To understand why, it is better to read <a href="https://habrahabr.ru/post/280190/">the comment thread</a> . <br><br><h4>  3. <b>Header / Footer</b> in <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.html">RecyclerView</a> </h4><br><h5>  Situation </h5><br>  A common task when implementing <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D0%25B3%25D0%25B8%25D0%25BD%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">pagination</a> is to display the <b>ProgressBar</b> while loading new data. <br>  Unlike <a href="http://developer.android.com/intl/ru/reference/android/widget/ListView.html">ListView</a> , <b>RecyclerView</b> has much more potential - which is what <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.Adapter.html">RecyclerView.Adapter.notifyItemRangeInserted () is</a> worth in comparison with <a href="http://stackoverflow.com/questions/6264795/animate-newly-added-items-in-listview">the</a> <b>ListView</b> <a href="http://stackoverflow.com/questions/6264795/animate-newly-added-items-in-listview">headache</a> . <br>  However, having tried to use it in the project instead of the <b>ListView</b> , you immediately come across a lot of nuances: where is the <a href="http://developer.android.com/intl/ru/reference/android/widget/ListView.html">ListView.setDivider ()</a> property?  Where is something like <a href="http://developer.android.com/intl/ru/reference/android/widget/ListView.html">ListView.addHeaderView ()</a> ?  What else for <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.Adapter.html">RecyclerView.Adapter.getItemViewType ()</a> , etc., etc. <br>  It is easy to understand that with all this dump of information, but something unpleasant still remains.  Adding a <b>Divider / Header</b> makes writing code clouds.  What to say about complex <b>layout</b> 'ah?  It was possible to do <b>RecheclerView</b> with 4 different <b>Header</b> 's and <b>Footer</b> 's with controllers.  Let's just say, sad and dejected, I walked for a very long time. <br><br><h5>  Decision </h5><br>  In fact, everything is not so bad if you know what to look for.  The main problem <b>RecyclerView</b> (and its main advantage) is that you can do anything with it.  There is practically no framework.  Hence the problem: if you want <b>Header</b> , do it yourself.  But fortunately, do it yourself, others have already done for us, so let's take advantage. <br>  Typical problems and their solutions: <br><ul><li>  Headings for groups of elements (for example, in the dictionary ‚ÄúA‚Äù will be the heading for all words beginning with this letter) - the easiest way to do this is through a single <b>item-layout</b> , without adding the 2nd unnecessary type <b>ViewHolder</b> 'a.  Add a check that the current element marks the transition from one letter to another and turn on the header hidden in the <b>layout</b> via <b>View.VISIBLE</b> . </li><li>  Simple <b>divider</b> - copy-paste <a href="https://gist.github.com/lapastillaroja/858caf1a82791b6c1a36">this code</a> into the project.  No extra fraud.  Works through <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.html">RecyclerView.addItemDecoration ()</a> </li><li>  Add <b>Header / Footer / Drag &amp; Drop</b> etc.  - if you do handles, then either get a new type for each new <b>ViewHolder</b> (I do not advise), or do a <b>WrapperAdapter</b> (much nicer).  But it is even better to look <a href="http://guides.codepath.com/android/Must-Have-Libraries">here</a> and choose your favorite lib.  Personally, I like two at once: <a href="https://github.com/mikepenz/FastAdapter">FastAdapter</a> and <a href="https://github.com/cymcsg/UltimateRecyclerView">UltimateRecyclerView</a> </li><li>  Need <b>pagination</b> , but too lazy to mess with <b>Header / Footer</b> for <b>ProgressBar</b> 's - <a href="https://github.com/MarkoMilos/Paginate">Paginate</a> library from one of the developers of twitter. </li></ul><br>  Although for me it still remains a mystery - why it was impossible to make some <b>SimpleDivider / SimpleHeaderAdapter</b> , etc.  Immediately in the SDK? <br><br><h4>  4. Acceleration with <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.Adapter.html">RecyclerView.Adapter.setHasStableIds ()</a> </h4><br><h5>  What's wrong with him? </h5><br>  So much problem, how much lack of <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.Adapter.html">documentation</a> .  This is what it says: <br><blockquote> If you want to see the data set.  If the item is not located the same. </blockquote><br>  And here people are divided into two types.  First: everything is clear.  Second: Cho does that even mean that? <br>  The problem is that even if you attributed yourself to the first people, you may be puzzled by the question: why this method?  Yes, yes, to return a unique <b>ID</b> !  I know.  But why is it necessary?  And no, the answer is ‚ÄúGoogle writes that it will be scrolling faster!‚Äù Will not suit me. <br><br><h5>  But what's the matter </h5><br>  Acceleration from <b>RecyclerView.Adapter.setHasStableIds () is</b> really possible to get, but only in one case - if you everywhere use <a href="http://developer.android.com/intl/ru/reference/android/support/v7/widget/RecyclerView.Adapter.html">RecyclerView.Adapter.notifyDataSetChanged () (and here they deign to write why you need a stable id)</a> .  If you have static data, then this method will not give you anything, and maybe even slow down a bit due to internal <b>ID</b> checks.  I found out about it only after reading the source code, and a bit later I stumbled upon <a href="https://blog.stylingandroid.com/material-part-7/">this article</a> . <br><br><h4>  5. <a href="http://developer.android.com/intl/ru/reference/android/webkit/WebView.html">WebView</a> </h4><br><h5>  Situation </h5><br>  The task is to get <b>html</b> text from the server and display it on the screen.  The text is sent by the server as <b>"&amp; lt; html &amp; gt;"</b>  .  Everything.  This is the whole task.  Complicated?  There is a <b>WebView</b> that can display <b>html</b> in a couple of lines.  Why, even <a href="http://stackoverflow.com/questions/2116162/how-to-display-html-in-textview">TextView</a> can do it!  Once or twice and ready ... yes? .. no? .. well, should it be ?! <br><br><h5>  Decision </h5><br>  Unfortunately, everything is not so smooth: <br><ul><li>  Let's start with the fact that there is no method like <b>HtmlUtils.unescape ()</b> in the Android SDK.  If you want a <b>"&amp; lt;"</b>  turn it into <b>"&lt;"</b> , then the easiest way (besides prescribing <b>regex</b> 'and handles) is to connect apache with its <a href="http://commons.apache.org/proper/commons-lang/javadocs/api-3.1/org/apache/commons/lang3/StringEscapeUtils.html">StringUtils.unescapeHtml4 ()</a> . </li><li>  The next problem will be artifacts when scrolling.  All of a sudden (yes, the Android SDK?), The <b>webview</b> will flash in black.  What to do - is told <a href="http://stackoverflow.com/a/17317706/2653714">here</a> and <a href="http://stackoverflow.com/a/16217522/2653714">here</a> .  Personally, I was helped only by a combination of these approaches. </li><li>  And if you have not yet been surprised by the abundance of problems from such a simple task, then here is the point: you need to display the <b>ProgressBar</b> before the <b>html</b> page has been rendered.  And then everything is bad.  That is <u>really</u> bad.  All solutions presented on <b>stackoverflow</b> work through time or do not work at all ( <a href="http://stackoverflow.com/questions/4065134/is-there-a-listener-for-when-the-webview-displays-its-content">tyk</a> , <a href="http://stackoverflow.com/questions/21000566/android-webview-detect-when-rendering-is-finished">tyk</a> ).  The only hitherto working method was using <a href="http://stackoverflow.com/a/4945875/2653714">WebView.setPictureListener ()</a> , however, it is now declared <b>deprecated</b> and there is nothing to be done about it. <br>  As a result, the only thing that can be advised is to refuse <b>ProgressBar</b> 'a.  Or, if it‚Äôs really, really, really impatient, add it directly to the <b>html</b> code, checking the readiness of the page via <b>javascript</b> .  <s>But this is for the club elite mazahistov.</s> <br></li></ul><br><br><h4>  6. <b>Gson</b> : <a href="http://developer.android.com/intl/ru/reference/java/util/EnumSet.html">EnumSet bitmask</a> </h4><br><h5>  When / Where / Why? </h5><br>  (The situation is specific and does not apply directly to Android‚Äôs problems, but decided to add it as a seed before the next cuvette) <br>  In response to one of the <b>api-</b> requests, a bit mask of access rights comes in the form of <b>int</b> 'a.  It is necessary to process the elements of this mask. <br>  The first thing that comes to mind is the <b>int</b> 'constants and bit operations for checks.  Sure, it always works.  But what if you want more?  What about <b>EnumSet</b> ? <br>  ‚ÄúNo problem‚Äù - the bearded progger will answer and break the architecture of the models into several more levels: <b>POJO, Model, Entity, UiModel</b> and what else the devil is not joking.  But if you want laziness and no extra.  classes?  What then? <br><br><h5>  Decision </h5><br>  We create the enum we need by taking care of the ‚Äúbitness‚Äù of the names in <a href="https://google.github.io/gson/apidocs/com/google/gson/annotations/SerializedName.html">@SerializedName</a> : <br><div class="spoiler">  <b class="spoiler_title">enum access</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Access { <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"1"</span></span>) CREATE, <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"2"</span></span>) READ; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"4"</span></span>) UPDATE; <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"8"</span></span>) DELETE; }</code> </pre> <br></div></div><br>  Define a <a href="https://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonDeserializer.html">JsonDeserializer</a> to deserialize from <b>json</b> to <b>EnumSet</b> : <br><div class="spoiler">  <b class="spoiler_title">EnumMaskConverter</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumMaskConverter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Enum</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonDeserializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumSet</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class">&gt;&gt; </span></span>{ Class&lt;E&gt; enumClass; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnumMaskConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;E&gt; enumClass)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enumClass = enumClass; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> EnumSet&lt;E&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JsonParseException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> mask = json.getAsLong(); EnumSet&lt;E&gt; set = EnumSet.noneOf(enumClass); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (E bit : enumClass.getEnumConstants()) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String value = EnumUtils.GetSerializedNameValue(bit); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> value != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> key = Integer.valueOf(value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mask &amp; key) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { set.add(bit); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set; } }</code> </pre><br></div></div><br>  And add it to <b>Gson</b> : <br><div class="spoiler">  <b class="spoiler_title">Gsonbuilder</b> <div class="spoiler_text"><pre> <code class="java hljs">GsonBuilder gsonBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder(); gsonBuilder.registerTypeAdapter((<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;EnumSet&lt;Access&gt;&gt;() {}).getType(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnumMaskConverter&lt;&gt;(Access.class)); Gson gson = gsonBuilder.create();</code> </pre><br></div></div><br>  As a result: <br><div class="spoiler">  <b class="spoiler_title">Using</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"mask"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EnumSet&lt;Access&gt; access; } <span class="hljs-comment"><span class="hljs-comment">/* ...some lines later... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (myModel.access.containsAll(EnumSet.of(Access.READ, Access.UPDATE, Access.DELETE))) { <span class="hljs-comment"><span class="hljs-comment">/* do something really cool */</span></span> }</code> </pre><br></div></div><br><br><h4>  7. <b>Retrofit</b> : <b>Enum</b> in <a href="https://square.github.io/retrofit/2.x/retrofit/">@GET</a> request </h4><br><h5>  Situation </h5><br>  Let's start with the settings.  <b>Gson</b> is formed as before.  <b>Retrofit</b> is created like this: <br><div class="spoiler">  <b class="spoiler_title">new Retrofit.Builder ()</b> <div class="spoiler_text"><pre> <code class="java hljs">retrofit = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Retrofit.Builder() .baseUrl(ApiConstants.API_ENDPOINT) .client(httpClient) .addConverterFactory(GsonConverterFactory.create(gson)) .addCallAdapterFactory(RxJavaCallAdapterFactory.create()) .build();</code> </pre><br></div></div><br>  And the data looks like this: <br><div class="spoiler">  <b class="spoiler_title">enum season</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Season { <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"3"</span></span>) AUTUMN, <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"1"</span></span>) SPRING; }</code> </pre><br></div></div><br>  Thanks to the ability of <b>Gson</b> to directly parse the enum through the usual <b>@SerializedName</b> , it became possible to get rid of the need to create any additional classes-layers.  All data will immediately go from requests to the <b>Model</b> .  Everything is fine: <br><div class="spoiler">  <b class="spoiler_title">Retrofit Service</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MonthApi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"index.php?page[api]=selectors"</span></span>) <span class="hljs-function"><span class="hljs-function">Observable&lt;MonthSelector&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPriorityMonthSelector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"index.php?page[api]=years"</span></span>) <span class="hljs-function"><span class="hljs-function">Observable&lt;Month&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFirstMonth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Query(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"season"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Season season)</span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Application</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MonthSelector</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"season"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Season season; } <span class="hljs-comment"><span class="hljs-comment">/* ...some mouses later... */</span></span> MonthSelector selector = monthApi.getPriorityMonthSelector(); Season season = selector.season; <span class="hljs-comment"><span class="hljs-comment">/* ...some cats later... */</span></span> Month month = monthApi.getFirstMonth(season);</code> </pre><br></div></div><br>  And now, dear experts, attention to the question!  What went wrong and why is it not working? <br><br><h5>  Decision </h5><br>  I specifically omitted the information that it is not working here.  The fact is that if you look in the logs, then the <b>monthApi.getFirstMonth (season)</b> query will be processed as <b>index.php? Page [api] = years &amp; season_lookup = AUTUMN</b> ... "uh, what's the matter?" I will say.  What is your answer?  Why such a result?  Haven't guessed yet?  Then you are trapped. <br>  When I ran into this task, it took me several hours of searching the source code to understand one thing (or rather even remember): yes, <b>Gson</b> is not used when sending <b>@GET</b> / <b>@POST</b> and other similar _queries_ in general!  Indeed, when was the last time you saw something like <b>index.php? Page [api] = years &amp; season_lookup = {a: 123;</b>  <b>b: 321}</b> ?  This makes no sense.  <b>Retrofit 2</b> uses <b>Gson</b> only when converting <b>Body</b> , but not for the requests themselves.  Eventually?  just used <b>season.toString ()</b> - hence the result. <br>  However, if you really want to sooo <s>(and I am one of them)</s> use <b>enum</b> with <b>Gson conversion</b> in the request, then <a href="http://stackoverflow.com/a/35801262/2653714">here</a> you are another converter, everything is as usual. <br><br><h4>  8. <b>Retrofit</b> : transfer <b>auth-token</b> </h4><br>  And finally, I would like to say one thing to those who write like this: <br><div class="spoiler">  <b class="spoiler_title">Any Retrofit Service</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CoolApi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"index.php?page[api]=need"</span></span>) <span class="hljs-function"><span class="hljs-function">Observable&lt;Data&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">just</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Header(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"auth-token"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String authToken)</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ^ auth-token @GET("index.php?page[api]=more") Observable&lt;Data&gt; not(@Header("auth-token") String authToken); // ^ auth-token   @GET("index.php?page[api]=gold") Observable&lt;Data&gt; doIt(@Header("auth-token") String authToken); // ^ auth-token  101 ! }</span></span></code> </pre><br></div></div><br>  Begin to use the <a href="http/wiki/Interceptors">Interceptor</a> 'ora already!  I understand that it is very simple to use <b>Retrofit</b> and therefore no one reads the documentation, but when you sit for 3 hours and clean the code not only from the <b>auth-token</b> , but also from any specific <i>current_location, battery_level, busy_status</i> - great <i>sadness</i> overtakes (do not ask why <i>battery_level</i> in each request. Himself in shock).  You can read about it <a href="https://futurestud.io/blog/retrofit-token-authentication-on-android">here</a> . <br><br><h4>  Instead of conclusion </h4><br>  Well, this time there was a lot more text than I had planned.  Some less interesting ditches had to be thrown out, while others I decided to leave for the next time. <br>  Contrary to the <a href="https://habrahabr.ru/post/279811/">promise of the previous part</a> , this time I tried to make you not ‚Äúgoogle first‚Äù, but first of all think ‚Äúwhy am I doing this?‚Äù.  Sometimes the problem is not created by the SDK or the library, but by the programmer himself, and, unfortunately, in this case, everything is far more pitiable.  Do not underestimate the chosen tool, as well as not overestimate it. <br>  In general, if you like android and / or you plan to do it - always keep yourself up to date with <a href="http://android-developers.blogspot.ru/">world trends</a> .  Well, or look for a news resource more convenient for you.  There you can find a lot of information about the <a href="http://guides.codepath.com/android">Android SDK</a> , <a href="http://guides.codepath.com/android/Must-Have-Libraries">popular libraries</a> , etc., etc. </div><p>Source: <a href="https://habr.com/ru/post/280190/">https://habr.com/ru/post/280190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280179/index.html">The widest prime number written in roman numerals</a></li>
<li><a href="../280180/index.html">Magic interface</a></li>
<li><a href="../280181/index.html">How to succeed on Kickstarter if you are indie (Part 1)</a></li>
<li><a href="../280186/index.html">Scientists have created a neural network that recognizes "drunk" messages on Twitter</a></li>
<li><a href="../280188/index.html">Var and val in java?</a></li>
<li><a href="../280192/index.html">Problem about pair numbers</a></li>
<li><a href="../280196/index.html">Pros and cons: When it is worth and not worth using MongoDB</a></li>
<li><a href="../280198/index.html">How to clean up the mailbox using a neural network. Part 1</a></li>
<li><a href="../280200/index.html">Directed Phishing - a Modern Security Threat</a></li>
<li><a href="../280204/index.html">A bit of Storage Class Memory</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>