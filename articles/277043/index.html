<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ariadna. Why do I need another geocoder for OSM?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Most recently, I finished doing a geocoder for my goals. Ariadna 
 Under the cut there is a story about why I did it and what it can do. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ariadna. Why do I need another geocoder for OSM?</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Most recently, I finished doing a geocoder for my goals. <a href="https://github.com/gen1us2k/ariadna">Ariadna</a> <br>  Under the cut there is a story about why I did it and what it can do. <br><a name="habracut"></a><br>  The article will not be a single line of code on Go.  But there will be a complete description of the work of the geocoder and the problems I have met.  And you can look at the code on the githaba. <br><br><h3>  Prehistory </h3><br>  I work in one of the Bishkek taxi services in Kyrgyzstan.  We decided to optimize the location of coordinates at the address for a more optimal distribution of orders. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What we do not have: <br><br><ul><li>  Full map of Yandex, Google or 2Gis </li><li>  Confidence in GPS data </li></ul><br>  What we have: <br><br><ul><li>  Very mixed input data </li><li>  Openstreetmap </li><li>  Own accumulated address base with coordinates </li></ul><br><h3>  What can users enter? </h3><br>  Users can enter addresses in different formats: <br><br><ul><li>  Street house </li><li>  Crossroads </li><li>  Facility name </li><li>  Point name </li><li>  microdistrict house </li><li>  microdistrict street house </li></ul><br>  And there are a lot of such options, for example <br>  Kiev 28 <br>  Kiev Soviet <br>  5-42 <br>  5 microdistrict Soviet 42 <br>  TSUM <br>  cafe at Ashot <br>  barrier <br>  And so on <br><br><h3>  Formulation of the problem </h3><br>  Make a geocoder who would be able to take any data at the input and give them coordinates <br>  Search language is only Russian. <br><br><h3>  How come to such a life </h3><br>  Before making my bike, I decided to do something that already exists. <br>  Were: <br><br><ul><li>  <a href="https://github.com/pelias/pelias">Pelias</a> </li><li>  <a href="https://github.com/twain47/Nominatim">Nominatim</a> </li><li>  <a href="https://photon.komoot.de/">Photon</a> </li></ul><br>  What did not suit nominatim, which we had: <br><br><ul><li>  Complicated by itself </li><li>  Made in php + c (This is not because php is bad, but because only for this tool we have Apache and php) </li><li>  Complex Logic in Postgresql Stored Procedures </li></ul><br>  What liked Pelias: <br><br><ul><li>  Can work with many sources of geodata </li><li>  Search is organized on ElasticSearch </li></ul><br>  As a result, I decided to abandon all three geocoders and make my tool for several reasons: <br><br><ol><li>  I want to understand the data in OSM and import only the ones needed for the search. </li><li>  I can process geodata before indexing </li><li>  I don‚Äôt like javascript and node.js, hence no desire to do a search based on a pelias </li></ol><br><h3>  Design </h3><br>  The following algorithm was laid: <br><br><ol><li>  First, we obtain the geometry for large settlements (cities, capitals, villages, residential areas) </li><li>  We unload all possible addresses and correlate them to the desired residential area, city and other settlement, setting the desired value. </li><li>  We unload all roads </li><li>  We are looking for crossing roads </li><li>  We put everything in the index </li><li>  Are looking for </li></ol><br>  To implement, I chose Go, considering projects like <a href="https://github.com/pelias/pbf2json">pbf2json</a> , <a href="http://github.com/kellydunn/golang-geo">golang-geo</a> and many others for processing geodata.  I also wanted to shake the skill in it. <br><br><h3>  Implementation </h3><br>  With receipt and parsing of the data with osm it seems understood.  For residential areas use tags place = city, place = village, place = suburb, place = town, place = neighbors for filtering.  For addresses, buildings addr: street + addr: housenumber, amenity, shop, addr: housenumber <br>  All roads can be accessed using the highway tag. <br><br>  There are difficulties with finding English names in Russian.  How I tried to solve it: <br><br><ol><li>  Simple automatic transliteration in Russian.  The result was absurd and not correct.  An example of data conversion was as follows: City House -&gt; Tsiti House </li><li>  Let's try to convert this way.  Receive a transcription of the word and translate it.  It turned out something like Adrenaline rush -&gt; Erdenalin Rash.  Passable, but need a Russian accent, such as adrenaline rush. </li><li>  Approached such a mechanism.  Automatically transliterate all data using the replacement dictionary.  Still, simple and stupid transliteration works tolerably.  The dictionary was filled in principle quickly after several runs on the data. </li></ol><br>  With this sorted out by this time we already get data that: <br><br><ol><li>  Normalized and reduced to the Russian language </li><li>  The addresses are in the format Country, city, village or village, microdistrict or residential community, street, house </li></ol><br>  The next part of the quest is to find the intersection of the roads.  I did it quickly and got a very slow implementation, O (n ^ 2) complexity.  As a temporary exit, I use Postgres + postgis to find intersections until I have found a good algorithm for finding intersections. <br><br>  The result was a good data parser with OSM, which puts the data in ElasticSearch.  Which got the simple name importer <br><br><h3>  Automate it </h3><br>  Taking into account the fact that constantly pumping out and creating indexes in elastiksercha rather tired, the updater component appeared.  There was also an automatic configuration in JSON format. <br><br>  The process of downloading a file and importing it into elastic search has been automated.  Plus, the opportunity to update the data in elastikserche without downtime, thanks to aliases. <br><br>  How it works: <br><br><ol><li>  Updater downloads file </li><li>  Finds out the current version of the index from the config </li><li>  Increment version and create new index </li><li>  Fills it with data </li><li>  Changes aliases </li><li>  Removes old index </li></ol><br>  Got such benefits from this: <br><br><ol><li>  We write a config </li><li>  Run ./ariadna update </li><li>  Let's go drink coffee </li><li>  We receive the ready adjusted index. </li></ol><br>  Also for convenience, I screwed a simple web interface with a map and search capabilities. <br><br><h3>  Automatic data enrichment </h3><br>  In addition to OSM, we still have a lot of drivers and operators who clog up orders. <br>  We have the name and coordinates accordingly. <br>  Made such a scheme: <br><br><ol><li>  Driver tracks are stored in drivers_data index </li><li>  OSM data is stored in the osm_data index </li><li>  They are combined via the addresses alias for which the address search is performed. </li></ol><br>  Data from drivers is recorded if we have an error in certain coordinates greater than 200 meters. <br><br><h3>  Total </h3><br>  The result is a geocoder who can: <br><br><ol><li>  Search for coordinates by synonyms.  for example ShVK - Champagne Winery </li><li>  Able to search for addresses in a specific radius (for example, for myself, I made a search for addresses 30 km from the city center) </li><li>  Search by the name of institutions (cafe at Ashot for example) </li><li>  Search for intersections </li><li>  Search for addresses in neighborhoods and lived arrays </li><li>  Do reverse geocoding </li><li>  Automatically updated with new data from drivers. </li></ol><br>  Consists of three components: <br><br><ol><li>  Data importer </li><li>  Data updater </li><li>  Web interface </li></ol><br><h3>  Minuses </h3><br><ol><li>  Tested for Kyrgyzstan only </li><li>  No demos </li><li>  No support for all addressing schemes </li></ol><br>  Therefore, I hope someone will help him finish and for a good search in other countries and cities. <br><br>  If someone found the project interesting, then I am not against any criticism, the pool of requests, issues on the githaba and feedback as a whole. <br></div><p>Source: <a href="https://habr.com/ru/post/277043/">https://habr.com/ru/post/277043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277031/index.html">MyHTML - HTML parser on the "bare" C with POSIX Threads support</a></li>
<li><a href="../277033/index.html">Generators in ES6 and asynchronous code in a new way</a></li>
<li><a href="../277035/index.html">Initial Setup of Extreme Networks Wireless Controllers</a></li>
<li><a href="../277037/index.html">Ultima 2C is a free ERP II class solution based on Ultima Businessware platform.</a></li>
<li><a href="../277041/index.html">Multichannel site upgrade. How to make your life easier</a></li>
<li><a href="../277045/index.html">Announcement WordPress Meetup # 2</a></li>
<li><a href="../277047/index.html">Application developers do not care about user safety, which leads to data leakage (with java-code examples)</a></li>
<li><a href="../277049/index.html">Test the training of visual attention</a></li>
<li><a href="../277051/index.html">Report from Tarantool Meetup January 28</a></li>
<li><a href="../277053/index.html">What does DEFAULT TRACE conceal in itself?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>