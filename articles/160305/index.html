<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Who uses Node.js: Trello (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often I meet questions like: ‚ÄúAnd who in general from large / well-known / prominent IT companies uses Node.js in production?‚Äù. January 19, 2012...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Who uses Node.js: Trello (Part 1)</h1><div class="post__text post__text-html js-mediator-article">  Quite often I meet questions like: ‚ÄúAnd who in general from large / well-known / prominent IT companies uses Node.js in production?‚Äù.  January 19, 2012 in the blog of the company Fog Creek, founded by the notorious Joel Spolsky ( <a href="http://joelonsoftware.com/">Joel Spolsky</a> ), was published an article <a href="http://blog.fogcreek.com/the-trello-tech-stack/">"The Trello Tech Stack"</a> .  It is strange that at Habr√© it somehow ignored.  Therefore, in order to correct this shortcoming, and at the same time set an example of using Node.js in a large project, I did a translation of this article. <br><br>  The article itself is quite voluminous, therefore it is divided into two parts: <br><br>  Part 1 <br><ul><li>  CoffeeScript </li><li>  Customer <br>  * Backbone.js <br>  * HTML5 History API <br>  * Mustache </li><li>  Pushing and polling <br>  * Socket.io and WebSockets <br>  * AJAX requests </li></ul><br>  <a href="http://habrahabr.ru/post/160447/">Part 2</a> <br><ul><li>  Server <br>  * node.js <br>  * HAProxy <br>  * Redis <br>  * MongoDB </li><li>  So do we like it? </li></ul><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  The trello tech stack </h1><br>  Trello‚Äôs development began with an HTML layout that <a href="https://trello.com/justin">Justin</a> and <a href="https://trello.com/bobbygrace">Bobby</a> , the designers of the Trello team, collected in a week.  I was struck by how cool he looked and felt.  After <a href="https://trello.com/daniel">Daniel</a> and <a href="http://trello.com/brett">I</a> joined the project to develop a prototype and working version of Trello, the real challenge was to preserve the delightful impressions of the original layout during the creation of the server and the client. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c74/a67/79c/c74a6779c9ec9037cb1859e6dd9a1221.png" alt="image"><br>  <i>The original layout of the Trello.</i> <br><br>  The layout led us to a one-page web application that creates a client-side user interface and accepts data updates via a communication channel with the north.  This was significantly different from any work we previously did at Fog Creek.  Thus, from a technical point of view, the development of Trello was an adventure. <br><br>  At first, we were surprised at how interesting and diverse the [application] structure could be, before the management of the [project] became disturbed, our problems were solved at the primary meeting with <a href="http://joelonsoftware.com/">Joel</a> when he said: ‚ÄúUse solutions that will work fine for two years ". <br><br>  So we did.  We have consistently selected promising (and often challenging) technologies that will provide a terrific experience compared to more mature alternatives.  We have been doing this for about a year, and we like it. <br><br><h2>  CoffeeScript </h2><br>  Trello development started in pure JavaScript on both the client and the server side, and followed this path until May when we copied a couple of files to CoffeeScript as an experiment to see if we would like it.  We really liked it, and very soon we rewrote the rest of the code and continued to develop completely in CoffeeScript. <br><br>  CoffeeScript is a language that compiles into <i>easy-to-read</i> JavaScript.  It already existed when we started developing Trello, but I was worried about the added complexity caused by debugging the compiled code, instead of directly debugging the source files.  When we tried it, however, the conversion turned out to be so high-quality that when mapping the final code to the source files during debugging in Chrome, a little mental effort was required.  And the gains from short code and ease of reading when using CoffeeScript were obvious and convincing. <br><br>  JavaScript is a cool language.  Well-written CoffeeScript smooths and shortens JavaScript, along with it retains the same semantics, and does not introduce a significant problem in debugging. <br><br><h2>  Customer </h2><br><ul><li>  <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> (MVC framework) </li><li>  <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/history.html">HTML 5</a> (History API: pushState) </li><li>  <a href="http://mustache.github.com/">Mustache</a> (templates) </li></ul><br>  Trello servers, in essence, do not work with HTML.  In fact, they do not execute a lot of client code.  The Trello page is a lightweight (2KiB) shell (thin shell) that downloads the client application from the server as one minimized and compressed JS file (including third-party libraries and our compiled CoffeeScript files and Mustache templates) and one CSS file (compiled from our <a href="http://lesscss.ru/">LESS</a> files and including inline images.  All it takes is less than 250KiB, and we distribute it from Amazon's <a href="http://aws.amazon.com/cloudfront">CloudFront</a> CDN.  This way we get low latency downloads for most users.  In the case of a fairly high-speed connection (high-bandwidth), we get the download and launch of the application in a browser window in about half a second.  We also have the benefit of caching, and so on subsequent visits to Trello, that part of the [download] is skipped. <br><br>  In parallel, we removed the download of AJAX data from the start page and try to establish a <a href="http://en.wikipedia.org/wiki/WebSocket">WebSocket</a> connection to the server. <br><br><h3>  Backbone.js </h3><br>  When a response comes in with data, Backbone.js takes effect.  The idea behind Backbone is to display each model received from the server (Model) using a view (View), and Backbone provides easy ways to: <br><ul><li>  tracking DOM events in HTML, which was created by a view, and binding them to handlers in a model that synchronizes with the server; </li><li>  tracking model changes and displaying changed HTML blocks. </li></ul><br>  Gracefully!  Using this approach, we get a normal, understandable and supported client application.  We build a client-side model cache in a special way to handle updates and simplify the reuse of the model on the client side. <br><br><h3>  History.pushState </h3><br>  Now that we have the entire client application loaded into the browser window, we don‚Äôt want to spend time navigating between pages.  We use the HTML 5 History.pushState interface method to move between pages.  In this way, we provide correct and consistent links in the location bar [browser element], and when we go, we simply load the data and transfer them to the appropriate controller based on Backbone. <br><br><h3>  Mustache </h3><br>  We use Mustache - a template language with minimal use of logical constructions - to display our models in HTML.  While ‚Äúusing the full power of [substitute_s_to_your_name] templates‚Äù sounds good, in practice it turns out that this requires serious discipline from developers to maintain clear code.  We were very happy with Mustache's ‚Äúbrevity is the sister of talent‚Äù approach, which allows us to reuse the template code without mixing it with the logic of the client and making confusion. <br><br><h2>  Pushing and polling </h2><br>  Real-time updates (realtime) is not a new thing, but this is an important part when creating a collaboration tool, so we spent some time on this part of Trello. <br><br><h3>  Socket.io and WebSockets </h3><br>  For those browsers that support this, we used WebSocket connections to push the server for changes made by other people to browsers that listen to the appropriate channels.  We use modified <i>(*)</i> Socket.io client and server libraries, which allow us to keep many thousands of WebSocket connections open on each of our servers with minimal CPU and memory usage.  Thus, when some action takes place on the board [the Trello element] that you are watching, this action is passed to the process on our server and distributed to the browser with a minimum delay, usually much less than a second. <br><br>  <i>(*) Currently, the Socket.io server has some problems with scaling to more than 10K simultaneous connections with clients when using multiple processes and Redis storage.</i>  <i>And the client has some problems that can lead to opening multiple connections to the same server or to the fact that the client cannot determine that its connection is serviced.</i>  <i>There are some problems with making our changes (hacks!) Back into the project - in many cases they only work with WebSockets (the only Socket.io transport we use).</i>  <i>We are working on changes that are suitable for general use, to make back into the project.</i> <br><br><h3>  AJAX requests </h3><br>  They are not intricate, but they work. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a11/b55/fba/a11b55fba57336733dc431b232852f60.jpg" alt="image"><br>  <i>The initial outline of the architecture.</i> <br><br>  When the browser does not support WebSockets (hi, IE), we simply make tiny AJAX change requests every couple of seconds while the user is active, and reduce the interval to ten seconds when the user goes into an inactive state (idle).  Since the settings of our server allow us to handle HTTPS requests with minimal overhead and keep TCP connections open, we are able to share good experience in using simple requests when necessary. <br><br>  We tried Comet through low-level transports for Socket.io, and they were all unstable at the time, anyway.  In addition, it seems risky to use Comet and WebSockets as the basis for the main feature.  We wanted to be able to return to the most simple and well-established technologies if we stumble upon a problem. <br><br>  We stumbled upon a problem immediately after launch.  Our implementation of the WebSocket server began to behave strangely under sudden and massive loads caused by the <a href="http://techcrunch.com/2011/09/13/joel-spolskys-trello-is-a-simple-workflow-and-list-manager-for-groups/">TechCranch</a> effect, and we were pleased to be able to return to simple requests and adjust the server's performance by adjusting the request intervals during activity and inactivity.  This allowed us to smoothly reduce performance when we increased the number of users from 300 to 50,000 over the course of a week. Now we are back to using WebSockets, but we have a working short query system that still seems like a very reasonable reserve. <br><br>  <i>To be continued...</i> </div><p>Source: <a href="https://habr.com/ru/post/160305/">https://habr.com/ru/post/160305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160293/index.html">Java Native Interface. C ++. Linux. The first steps</a></li>
<li><a href="../160295/index.html">XenDesktop - everything is simple (part 1)</a></li>
<li><a href="../160299/index.html">Himself cellular roaming. Creating a GSM gate on asterisk + dongle from a cellular operator</a></li>
<li><a href="../160301/index.html">Work with time in Google</a></li>
<li><a href="../160303/index.html">Life and death of information technology</a></li>
<li><a href="../160307/index.html">Increase the reliability of the data center! (photo from the thermal imager inside)</a></li>
<li><a href="../160309/index.html">What online dictionaries / translators do you use?</a></li>
<li><a href="../160311/index.html">Phalcon: Let's learn by example</a></li>
<li><a href="../160313/index.html">Own module for admin on Webasyst</a></li>
<li><a href="../160315/index.html">Export message history from Skype 4. *</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>