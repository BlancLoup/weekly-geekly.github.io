<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Detailed guide to creating and deploying chat on Tornado + Telegram</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This solution is suitable for small projects, since the opportunity to simultaneously conduct a dialogue with several users is realized by creating a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Detailed guide to creating and deploying chat on Tornado + Telegram</h1><div class="post__text post__text-html js-mediator-article">  This solution is suitable for small projects, since the opportunity to simultaneously conduct a dialogue with several users is realized by creating a new chat bot, that is, the more bots there are, the more people will be able to contact you at one time. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Internal chat device</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/a0e/23e/528/a0e23e5283664580aed42f955702e1dd.jpg" alt="image"><br>  Fig.1 UML sequence diagram <br></div></div><br><h2>  Implementation </h2><br>  During the implementation, it was decided to periodically poll the Telegram server in order to simplify deployment and to facilitate understanding of the material, as an alternative, you can use WebHook. <br><br><h4>  Preparing a virtual environment </h4><br>  If you are not worth virtualenv, then you need to install it: <br><br> <code>pip install virtualenv</code> <br> <br>  Create a virtual environment: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>virtualenv --no-site-packages -p python3.4 chat</code> <br> <br>  Activate it: <br><br> <code>source chat/bin/activate</code> <br> <br>  Install all the necessary libraries for our chat: <br><br> <code>pip install tornado==4.4.2 psycopg2==2.7.3 pyTelegramBotAPI==2.2.3</code> <br> <br>  To poll the server we will use the <a href="https://github.com/eternnoir/pyTelegramBotAPI">library</a> to work with the telegram. <br><br>  You must create the following file structure: <br><br><img src="https://habrastorage.org/web/327/a32/42a/327a3242a39140d8b2204f904e271215.png"><br><br><h4>  Create bot </h4><br>  It's time to create a bot, this implementation is designed for several bots to provide the ability to communicate in parallel with several clients. <br><br>  To register a bot, you need to write a <a href="https://telegram.me/botfather">BotFather</a> / newbot and all further instructions you will receive in a dialogue with him.  As a result, after successful registration BotFather will return you the token of your new bot. <br><br>  Now you need to get your chat_id so that the bot knows who to send messages to. <br>  To do this, we find our bot in the telegram application, start the interaction with it with the / start command, write some message to it and follow the link - <br><br> <code>https://api.telegram.org/bot&lt;__&gt;/getUpdates</code> <br> <br>  We see about the following answer - <br><br> <code>{"id":555455667,"first_name":"","last_name":"","username":"kamrus","language_code":"ru-RU"} <br> id    chat_id</code> <br> <br><h4>  Postgres setup </h4><br>  To provide flexibility in the work of the chat and the possibility of its modernization, it is necessary to use the database, I chose postgres. <br><br>  Switch to postgres user: <br><br> <code>sudo su - postgres</code> <br> <br>  Logging into the postgres CLI: <br><br> <code>psql</code> <br> <br>  You need to create a new database in Unicode; <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> habr_chat <span class="hljs-keyword"><span class="hljs-keyword">ENCODING</span></span> <span class="hljs-string"><span class="hljs-string">'UNICODE'</span></span>;</code> </pre> <br>  Create a new user in the database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> habr_user <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'12345'</span></span>;</code> </pre> <br>  And give him all the privileges to the base: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> habr_chat <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> habr_user;</code> </pre> <br>  Connect to the database you just created: <br><br> <code>\c habr_chat</code> <br> <br>  Create a table to store information bots, it will have the following model: <br><br><div class="spoiler">  <b class="spoiler_title">Physical model</b> <div class="spoiler_text"><img src="https://habrastorage.org/web/fb4/754/904/fb47549041a7485a8b08ed0f44e9f9d1.png"><br>  Fig.2 Physical model of the chat table <br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> chat ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, token <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">300</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>, ready <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">True</span></span>, last_message <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, customer_asked <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">False</span></span>, remote_ip <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) )</code> </pre> <br>  And just give the user all the privileges on the table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> chat <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> habr_user;</code> </pre> <br>  Now you need to add bot tokens to it: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> chat (token) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'your_bot_token'</span></span>);</code> </pre> <br>  Exit CLI: <br><br> <code>\q</code> <br> <br>  and change user back: <br><br> <code>exit</code> <br> <br><h4>  Code writing </h4><br>  First of all, we will move the settings for the chat to a separate file. <br><br>  bot_settings.py <br><br><pre> <code class="python hljs">CHAT_ID =   chat_id db = { <span class="hljs-string"><span class="hljs-string">'db_name'</span></span>: <span class="hljs-string"><span class="hljs-string">'habr_chat'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'habr_user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-string"><span class="hljs-string">'12345'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span> }</code> </pre><br>  The main functions will be in the core.py file. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telebot <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> apihelper <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bot_settings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_updates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token, conn, cur, offset=None, limit=None, timeout=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">20</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">'''     '''</span></span> json_updates = apihelper.get_updates(token, offset, limit, timeout) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: answer = json_updates[<span class="hljs-number"><span class="hljs-number">-1</span></span>][<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'text'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> IndexError: answer = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#        ,  #        , #         if is_customer_asked(conn, cur, token): #    ,      #             if not is_last_message(conn, cur, token, answer): #          #    update_last_message(conn, cur, token, answer) return answer else: #      ,      #   ,      , #       update_last_message(conn, cur, token, answer) def send_message(token, chat_id, text): '''    ''' apihelper.send_message(token, chat_id, text) def connect_postgres(**kwargs): try: conn = psycopg2.connect(dbname=db['db_name'], user=db['user'], password=db['password'], host=db['host'], port=db['port']) except Exception as e: print(e, '    posqgres') raise e cur = conn.cursor() return conn, cur def update_last_message(conn, cur, token, message, **kwargs): '''   ,   ''' query = "UPDATE chat SET last_message = %s WHERE token = %s" data = [message, token] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '       %s' %message) raise e def add_remote_ip(conn, cur, token, ip): '''   ip   ''' query = "UPDATE chat SET remote_ip = %s WHERE token = %s" data = [ip, token] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '    ip ') raise e def delete_remote_ip(conn, cur, token): '''  ip       ''' query = "UPDATE chat SET remote_ip = %s WHERE token = %s" data = ['', token] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '    ip ') raise e def is_last_message(conn, cur, token, message, **kwargs): '''         ''' query = "SELECT last_message FROM chat WHERE token = %s" data = [token, ] try: cur.execute(query, data) last_message = cur.fetchone() if last_message: if last_message[0] == message: return True return False except Exception as e: print(e, '    ') raise e def update_customer_asked(conn, cur, token, to_value): '''     ''' query = "UPDATE chat SET customer_asked = %s WHERE token = %s" # to_value = True/False data = [to_value, token] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '    "customer_asked"  %s' %to_value) raise e def is_customer_asked(conn, cur, token): '''     ,    True ''' query = "SELECT customer_asked FROM chat WHERE token = %s" data = [token, ] try: cur.execute(query, data) customer_asked = cur.fetchone() return customer_asked[0] except Exception as e: print(e, "          ") raise e def get_bot(conn, cur): '''      ,   ready = True.  (id, token, ready, last_message, customer_asked)    ''' query = "SELECT * FROM chat WHERE ready = True" try: cur.execute(query) bot = cur.fetchone() if bot: return bot else: return None except Exception as e: print(e, "     ") raise e def make_bot_busy(conn, cur, token): '''   ready  False,      ''' query = "UPDATE chat SET ready = False WHERE token = %s" data = [token,] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '     "ready"  False') raise e def make_bot_free(conn, cur, token): '''   ready  False,      ''' update_customer_asked(conn, cur, token, False) delete_remote_ip(conn, cur, token) query = "UPDATE chat SET ready = True WHERE token = %s" data = [token,] try: cur.execute(query, data) conn.commit() except Exception as e: print(e, '     "ready"  True') raise e</span></span></code> </pre> <br>  tornadino.py <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.web <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.websocket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> core <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bot_settings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CHAT_ID <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WSHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(tornado.websocket.WebSocketHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, application, request, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(WSHandler, self).__init__(application, request, **kwargs) <span class="hljs-comment"><span class="hljs-comment">#         postgres self.conn, self.cur = core.connect_postgres() self.get_bot(self.conn, self.cur, request.remote_ip) def get_bot(self, conn, cur, ip): while True: bot = core.get_bot(conn, cur) if bot: self.bot_token = bot[1] self.customer_asked = bot[4] #   core.make_bot_busy(self.conn, self.cur, self.bot_token) #   ip  core.add_remote_ip(self.conn, self.cur, self.bot_token, ip) break def check_origin(self, origin): '''       ''' return True def bot_callback(self): '''   PeriodicCallback    Telegram       ''' ans_telegram = core.get_updates(self.bot_token, self.conn, self.cur) if ans_telegram: #     ,       self.write_message(ans_telegram) def open(self): '''        ''' #    Telegram  3 self.telegram_loop = tornado.ioloop.PeriodicCallback(self.bot_callback, 3000) self.telegram_loop.start() def on_message(self, message): '''  ,      ''' if not self.customer_asked: self.customer_asked = True #    ,     core.update_customer_asked(self.conn, self.cur, self.bot_token, True) core.send_message(self.bot_token, CHAT_ID, message) def on_close(self): '''      ''' core.send_message(self.bot_token, CHAT_ID, "  ") #  PeriodicCallback self.telegram_loop.stop() #   core.make_bot_free(self.conn, self.cur, self.bot_token) # WebSocket     ws://127.0.0.1:8080/ws application = tornado.web.Application([ (r'/ws', WSHandler), ]) if __name__ == "__main__": application.listen(8080) tornado.ioloop.IOLoop.current().start()</span></span></code> </pre><br>  Now create a static file: <br>  chat.html <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox chatbox-down chatbox--empty"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__title"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h5</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span>Tornado-Telegram-chat<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h5</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__title__close"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">viewBox</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0 0 12 12"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"12px"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">line</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stroke</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#FFFFFF"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"11.75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">y1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.25"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.25"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">y2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"11.75"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">line</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">line</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stroke</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#FFFFFF"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"11.75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">y1</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"11.75"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.25"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">y2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.25"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">line</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messages__box"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__body"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--         --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start-ws"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-success btn-block"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" ..."</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendmessage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  chat.css <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: fixed; <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">400px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-family</span></span>: Arial, sans-serif; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-transition</span></span>: all <span class="hljs-number"><span class="hljs-number">600ms</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cubic-bezier</span></span>(0.19, 1, 0.22, 1); <span class="hljs-attribute"><span class="hljs-attribute">transition</span></span>: all <span class="hljs-number"><span class="hljs-number">600ms</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cubic-bezier</span></span>(0.19, 1, 0.22, 1); <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: -webkit-flex; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: flex; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-flex-direction</span></span>: column; <span class="hljs-attribute"><span class="hljs-attribute">flex-direction</span></span>: column; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox-down</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: -<span class="hljs-number"><span class="hljs-number">350px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--closed</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: -<span class="hljs-number"><span class="hljs-number">400px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.form-control</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-color</span></span>: <span class="hljs-number"><span class="hljs-number">#1f2836</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: none; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">min-height</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-right</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#1f2836</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-top-left-radius</span></span>: <span class="hljs-number"><span class="hljs-number">4px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-top-right-radius</span></span>: <span class="hljs-number"><span class="hljs-number">4px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">cursor</span></span>: pointer; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: -webkit-flex; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: flex; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-align-items</span></span>: center; <span class="hljs-attribute"><span class="hljs-attribute">align-items</span></span>: center; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h5</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">line-height</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: relative; <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-flex-grow</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">flex-grow</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">max-width</span></span>: <span class="hljs-number"><span class="hljs-number">195px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: inline-block; <span class="hljs-attribute"><span class="hljs-attribute">text-decoration</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">white-space</span></span>: nowrap; <span class="hljs-attribute"><span class="hljs-attribute">overflow</span></span>: hidden; <span class="hljs-attribute"><span class="hljs-attribute">text-overflow</span></span>: ellipsis; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h5</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:before</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">content</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: block; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">50%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#4CAF50</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">6px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">translateY</span></span>(-50%); <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">translateY</span></span>(-50%); } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__tray</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__close</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">24px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">24px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">outline</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: transparent; <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">cursor</span></span>: pointer; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-transition</span></span>: opacity <span class="hljs-number"><span class="hljs-number">200ms</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">transition</span></span>: opacity <span class="hljs-number"><span class="hljs-number">200ms</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__tray</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__close</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__tray</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">span</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: inline-block; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">2px</span></span> solid <span class="hljs-number"><span class="hljs-number">#fff</span></span> } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__title__close</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">svg</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">vertical-align</span></span>: middle; <span class="hljs-attribute"><span class="hljs-attribute">stroke-linecap</span></span>: round; <span class="hljs-attribute"><span class="hljs-attribute">stroke-linejoin</span></span>: round; <span class="hljs-attribute"><span class="hljs-attribute">stroke-width</span></span>: <span class="hljs-number"><span class="hljs-number">1.2px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__credentials</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-top</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#f5f5f5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-left</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid <span class="hljs-number"><span class="hljs-number">#ddd</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-right</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid <span class="hljs-number"><span class="hljs-number">#ddd</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-flex-grow</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">flex-grow</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__credentials</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: none; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__credentials</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.form-control</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-shadow</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">box-shadow</span></span>: none; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">overflow-y</span></span>: auto; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: relative; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">4px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(100, 100, 100, 0.1); <span class="hljs-attribute"><span class="hljs-attribute">box-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(100, 100, 100, 0.1); } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">40px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">40px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">4px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: <span class="hljs-number"><span class="hljs-number">2px</span></span> solid <span class="hljs-number"><span class="hljs-number">#fcfcfc</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message--left</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-left</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: left; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message--left</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: -<span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message--right</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-right</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-right</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: right; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body__message--right</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: -<span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__message</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">15px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">min-height</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">outline</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">resize</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> solid <span class="hljs-number"><span class="hljs-number">#ddd</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: none; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#fefefe</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">262px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox-down</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: -<span class="hljs-number"><span class="hljs-number">212px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--closed</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: -<span class="hljs-number"><span class="hljs-number">262px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__body</span></span>, <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__message</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: none; } <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox--empty</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.chatbox__credentials</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: block; } <span class="hljs-selector-class"><span class="hljs-selector-class">.description</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-family</span></span>: Arial, sans-serif; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; } <span class="hljs-selector-id"><span class="hljs-selector-id">#start-ws</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.no-visible</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: none; }</code> </pre> <br></div></div><br>  Before writing a javascript file, you need to decide how the code will look for the message from the client and from the manager. <br><br>  Html code for the message from the client: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__body__message chatbox__body__message--right"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"../static/user.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  Html code for the message from the manager: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatbox__body__message chatbox__body__message--right"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"../static/user.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  chat.js <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">) </span></span>{ $(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $chatbox = $(<span class="hljs-string"><span class="hljs-string">'.chatbox'</span></span>), $chatboxTitle = $(<span class="hljs-string"><span class="hljs-string">'.chatbox__title'</span></span>), $chatboxTitleClose = $(<span class="hljs-string"><span class="hljs-string">'.chatbox__title__close'</span></span>), $chatboxWs = $(<span class="hljs-string"><span class="hljs-string">'#start-ws'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         $chatboxTitle.on('click', function() { $chatbox.toggleClass('chatbox-down'); }); //   $chatboxTitleClose.on('click', function(e) { e.stopPropagation(); $chatbox.addClass('chatbox--closed'); //       ,  //    if (window.sock) { window.sock.close(); } }); //    $chatboxWs.on('click', function(e) { e.preventDefault(); //    $chatbox.removeClass('chatbox--empty'); //      $chatboxWs.addClass('no-visible'); if (!("WebSocket" in window)) { alert("    web sockets"); } else { alert(" "); setup(); } }); }); })(jQuery); //     WebSocket function setup(){ var host = "ws://62.109.2.175:8084/ws"; var socket = new WebSocket(host); window.sock = socket; var $txt = $("#message"); var $btnSend = $("#sendmessage"); //    textarea $txt.focus(); $btnSend.on('click',function(){ var text = $txt.val(); if(text == ""){return} //     socket.send(text); //     clientRequest(text); $txt.val(""); // $('#send') }); //   enter $txt.keypress(function(evt){ //    enter if(evt.which == 13){ $btnSend.click(); } }); if(socket){ //      socket.onopen = function(){ } //        socket.onmessage = function(msg){ //     managerResponse(msg.data); } //      socket.onclose = function(){ webSocketClose("The connection has been closed."); window.sock = false; } }else{ console.log("invalid socket"); } } function webSocketClose(txt){ var p = document.createElement('p'); p.innerHTML = txt; document.getElementById('messages__box').appendChild(p); } //    function clientRequest(txt) { $("#messages__box").append("&lt;div class='chatbox__body__message chatbox__body__message--right'&gt; &lt;img src='../static/user.png' alt=''&gt; &lt;p&gt;" + txt + "&lt;/p&gt; &lt;/div&gt;"); } //     function managerResponse(txt) { $("#messages__box").append("&lt;div class='chatbox__body__message chatbox__body__message--left'&gt; &lt;img src='../static/user.png' alt=''&gt; &lt;p&gt;" + txt + "&lt;/p&gt; &lt;/div&gt;"); }</span></span></code> </pre><br></div></div><br><h2>  Deploy to centos7 </h2><br>  First we need to set up a virtual environment for our application, in fact, repeat what we have already done on the local machine in the implementation clause. <br><br>  After we set up the environment, we need to move our project there, the easiest way to do this is using git, you must first load the code into your repository and from there you can already clone it to the server. <br><br><h4>  Customize postgres </h4><br>  If you do not have postgres installed on your server, you can install it like this: <br><br> <code>sudo yum install postgresql-server postgresql-devel postgresql-contrib</code> <br> <br>  Run postgres: <br><br> <code>sudo postgresql-setup initdb</code> <br> <code>sudo systemctl start postgresql</code> <br> <br>  Add autorun: <br><br> <code>sudo systemctl enable postgresql</code> <br> <br>  After that, you need to go to psql under the postgres user and repeat everything we did on the local machine. <br><br>  We will run our tornado application using the supervisor in the background. <br><br>  First, install supervisor: <br><br> <code>sudo yum install supervisor</code> <br> <br>  Now open the configuration file of the supervisor, which will be located in /etc/supervisor.conf <br><br> <code>[unix_http_server] <br> file=/path/to/supervisor.sock ; (the path to the socket file) <br> <br> [supervisord] <br> logfile=/var/log/supervisor/supervisord.log ; (main log file;default $CWD/supervisord.log) <br> logfile_maxbytes=50MB ; (max main logfile bytes b4 rotation;default 50MB) <br> logfile_backups=10 ; (num of main logfile rotation backups;default 10) <br> loglevel=error ; (log level;default info; others: debug,warn,trace) <br> pidfile=/path/to/supervisord.pid ; (supervisord pidfile;default supervisord.pid) <br> nodaemon=false ; (start in foreground if true;default false) <br> minfds=1024 ; (min. avail startup file descriptors;default 1024) <br> minprocs=200 ; (min. avail process descriptors;default 200) <br> user=root <br> childlogdir=/var/log/supervisord/ ; ('AUTO' child log dir, default $TEMP) <br> <br> [rpcinterface:supervisor] <br> supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface <br> <br> [supervisorctl] <br> serverurl=unix:///path/to/supervisor.sock ; use a unix:// URL for a unix socket <br> <br> [program:tornado-8004] <br> environment=PATH="/path/to/chat/bin" <br> command=/path/to/chat/bin/python3.4 /path/to/tornadino.py --port=8084 <br> stopsignal=KILL <br> stderr_logfile=/var/log/supervisord/tornado-stderr.log <br> stdout_logfile=/var/log/supervisord/tornado-stdout.log <br> <br> [include] <br> files = supervisord.d/*.ini</code> <br> <br>  <b>Do not forget to change the path in the configuration file!</b> <br><br>  Before you start a supervisor, you need to create a folder / var / log / supervisord / it will collect tornado logs, so if the supervisor launched tornado-8004, but the chat does not work, then you should look for the error there. <br><br>  We start the supervisor: <br><br> <code>sudo supervisorctl start tornado-8004</code> <br> <br>  Check that everything is in order: <br><br> <code>sudo supervisorctl status</code> <br> <br>  Should get something like this: <br><br> <code>tornado-8004 RUNNING pid 32139, uptime 0:08:10</code> <br> <br>  On the local machine, we make changes to chat.js: <br><br> <code>var host = "ws://__:8084/ws";</code> <br> <br>  and open chat.html in the browser. <br><br>  Done! <br><br>  You can fasten such a chat to your projects without special gestures, it is also quite convenient to use to collect feedback. </div><p>Source: <a href="https://habr.com/ru/post/335660/">https://habr.com/ru/post/335660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335650/index.html">What can chat bot</a></li>
<li><a href="../335652/index.html">Intel Optane SSD: features and benefits</a></li>
<li><a href="../335654/index.html">Datacenter: the stages of big life</a></li>
<li><a href="../335656/index.html">SpaceX will deliver the HPE supercomputer to the ISS. How does this speed up a mission to mars?</a></li>
<li><a href="../335658/index.html">Coco Framework - blockchain on a large scale</a></li>
<li><a href="../335662/index.html">Bitmap way to display tile cards</a></li>
<li><a href="../335664/index.html">"300 million books per kilometer": IBM extends the life of magnetic tape</a></li>
<li><a href="../335666/index.html">10 steps to solve problems in programming</a></li>
<li><a href="../335668/index.html">Visualization of latent semantic analysis results using Python tools</a></li>
<li><a href="../335670/index.html">The future of contact centers: omni-channel and customer experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>