<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selecting the operation of the web server on personal experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be useful to those people who already have a website, or who plan to open it. Particularly interesting is the article will be ambiti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selecting the operation of the web server on personal experience</h1><div class="post__text post__text-html js-mediator-article">  This article will be useful to those people who already have a website, or who plan to open it.  Particularly interesting is the article will be ambitiously tuned webmasters who feel that the high point of their project is not far off and want to prepare for the influx of visitors to the page. <br><br>  Even those who are only dreaming of thousands of users on their site, probably wondered: ‚ÄúHow many users will my site survive if they log in at the same time?‚Äù I immediately recall the famous expression ‚ÄúHabraeffect‚Äù - the phenomenon of a site‚Äôs failure that turned out to be not ready for numerous transitions to it after the appearance on the Internet links. <br><a name="habracut"></a><br>  Suppose that the site is already there (or will be soon): where is it located?  Should it be a classic hosting or vps server?  If vps, which one and how best to configure it?  Or maybe there is no difference at all and it is easier to choose what is cheaper?  In this article, we will look at several options and, in practice, we will see which one is better for our site. <br><br>  We will experiment: set different modes of server operation and measure performance.  We will simulate the load on the site using the service Loaddy.com.  There you can set the number of users, the growing type of load and the schedule will show how the server responds to them.  It is considered that one user generates approximately one request to the site within 10 seconds.  As a test site, we take a demonstration online store on cms moguta.  It will be filled with test ‚Äúgoods‚Äù, which are displayed on the main page by several criteria (that is, when the page is being formed, work is underway with a database, etc.).  One way or another, it will allow you to compare modes with each other. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a test site, let's create a VPS server on Ubuntu OS.  Its configuration will be [1 core, 1Gb RAM].  We assume that such entry-level servers are created in most cases for new projects.  The test version of the online store will be available at ip address <a href="http://130.193.44.219/">http://130.193.44.219/</a> <br><br>  Another classic hosting will come in handy, to which we will also upload the same online store to conduct tests.  You can go our own way and conduct the same tests on your project! <br><br>  Since in most cases a control panel is offered along with vps, we will make major changes to the settings in it.  On the vps server we have 3 modes of its operation: <br><br><ul><li>  Apache; </li><li>  Apache in CGI mode; </li><li>  Nginx + php-fpm (without Apache). </li></ul><br>  But first we will carry out tests on the hosting: <br><br><h2>  Classic inexpensive hosting </h2><br><img src="https://habrastorage.org/webt/9i/9u/rj/9i9urjtvocmzug1u0s7aug1e-qk.gif" alt="image"><br>  The result is available by <a href="https://loaddy.com/result/14370192/">reference</a> . <br><br>  Errors occur when the number of visitors exceeds 50 people.  Hosting ceases to give content, while if you go to the hosting control panel, we can see something like the following: <br><blockquote>  Your site has been subject to restrictions in the last 24 hours.  Processor resources limited for your site.  You have reached the limits on the input processes (the number of simultaneously running PHP and CGI scripts, scheduled tasks and console sessions) 126 times. </blockquote>  Well, of course, hosting is hosting, the more inexpensive.  You can, of course, find such a tariff, which will provide more opportunities, but all this needs to be taken into account, in some way to know the exact data of the restrictions, and from each hosting provider. <br><br><h2>  VPS: Apache </h2><br>  Next in line is our test airborne unit with the Apache mode, which by the way is suggested by default, when installing an ISP control panel. <br><br><img src="https://habrastorage.org/webt/cq/ps/3k/cqps3kza1pw3ew7wdszpqcovgva.gif" alt="image"><br><br>  The result is available by <a href="https://loaddy.com/result/696972171/">reference</a> . <br><br>  The problems begin when the number of users exceeds 90. If we log in to our server via ssh and look at the moment at the process list using the top command, sorted with Shift + M (by the amount of memory consumed), we will see something like this: <br><br><img src="https://habrastorage.org/webt/8y/ml/uk/8ymlukh_jyjx0jlsnttsw_de6mw.gif" alt="image"><br><br>  We see that the apache2 process has grown into many children and they have eaten all the RAM of our vps server. <br><br>  Here you need to make a small remark.  The fact is that for the Apache server, theoretically, there is a mode that allows instead of this large number of child processes for each connection to create several so-called multi-thread ones, each of which would serve several connections.  This mode is called <i>worker</i> , in contrast to the default <i>prefork</i> .  But it is not easy to install it, in the ISP panels it is impossible to do this, and if you become puzzled and try to implement it via ssh, it turns out that it is not enough to turn off the prefork and enable the worker, you still need a safe version of php.  And if modules like Zend or IonCube are used, they must also be thread-safe.  Anyway, the official PHP site <a href="http://php.net/manual/en/faq.installation.php">does not recommend</a> installing this mode. <br><br><h2>  VPS: CGI </h2><br>  Let's see what happens when using the CGI mode.  To do this, you need to allow using PHP in CGI mode in the ISP control panel; this is done in the section ‚ÄúAccounts - users - settings for the user‚Äù. <br><br><img src="https://habrastorage.org/webt/jc/md/zx/jcmdzxrcghqhwf4xmy2edbixov0.gif" alt="image"><br><br>  The result is available by <a href="https://loaddy.com/result/723163152/">reference</a> . <br><br>  Joyless picture turned out.  The server refuses to issue content already with 55+ visitors, the entire memory is eaten by php processes.  Next, there is an attempt to restore performance, but still everything ends almost 100% with failures. <br><br><h2>  VPS: Nginx + PHP-FPM </h2><br>  It‚Äôs time for a mode in which the Apache server is not used at all, Nginx works instead, and php is processed by the php-fpm module.  If you use the ISP control panel, then you need to enable this mode for the user.  This is also done in the ‚ÄúAccounts - Users - Settings for User‚Äù section.  Also, this mode should be available in the section "Settings - Features - Web server (www)". <br><br><img src="https://habrastorage.org/webt/g1/9h/tu/g19htuq2ms1wdgc7chekxfrdzzk.gif" alt="image"><br><br>  The result is available by <a href="https://loaddy.com/result/213836136/">reference</a> . <br><br>  Exactly what is needed!  100% availability, while the download speed and server response time are at acceptable levels, although they increase with increasing load.  Nevertheless, the server copes! <br><br>  Let's look at the process table at the moment of maximum load on the server: <br><br><img src="https://habrastorage.org/webt/lf/al/bx/lfalbxszotenrmulrkdhifuejky.gif" alt="image"><br><br>  We see that we still have a stock of available RAM.  And the child processes php-fpm7.0 do not grow in large quantities, but are limited to 5 instances, each of which serves several threads. <br><br>  Well, it looks like a "winner mode" is defined.  Let's find out how many simultaneous visitors can serve our server in this mode.  But before we do a little "tuning".  Firstly, since apache is not used for such server operation, it can be turned off altogether.  We will do this in the ISP control panel in the ‚ÄúSystem - Services‚Äù section.  Secondly, let's change a bit the principle of running php-fpm processes.  By default it is dynamic.  This means that child processes will hang in memory even when they are not needed.  In this case, the memory is not released and over time, these processes can grow more than we would like.  Therefore it is proposed to set the ‚Äúondemand‚Äù mode - on demand.  And set the number of child processes and timeout for them. <br><br>  To do this, you will need to log in to the server using ssh and register these settings in the php configuration file.  This is convenient to do in the file for the user for which the domain was created in the ISP. <br><br>  It is usually located in /etc/php/7.0/fpm/pool.d <br><br>  So: <pre><code class="bash hljs">sudo nano /etc/php/7.0/fpm/pool.d/www-root.conf</code> </pre> <br><br>  We see the default settings there: <br><br><pre> <code class="plaintext hljs">[www-root] pm = dynamic pm.start_servers = 1 pm.min_spare_servers = 1 pm.max_children = 5 pm.max_spare_servers = 5</code> </pre> <br>  To make the ondemand mode work, you need to replace this with: <br><pre> <code class="plaintext hljs">pm = ondemand pm.max_children = 5 pm.process_idle_timeout = 10s</code> </pre> <br>  And restart php-fpm with the command <br><br><pre> <code class="bash hljs">sudo service php7.0-fpm restart</code> </pre> <br>  After this, the php-fpm7.0 processes will be created on demand (with load), their maximum number will be = 5, and after 10 seconds of idle time, the process will be killed, freeing up RAM. <br><br>  Just in case, we will run our test again to make sure that all this initiative has not affected the performance of the site for the worse: <br><br><img src="https://habrastorage.org/webt/j_/ii/3q/j_ii3q4de-cmblsvtxi7grdwumq.gif" alt="image"><br><br>  The result is available by <a href="https://loaddy.com/result/826180808/">reference</a> . <br><br>  Now let's run Loaddy with a large number of visitors to see how many connections our server can handle: <br><br><img src="https://habrastorage.org/webt/wb/vs/72/wbvs72nk8yujn1n8w-ngook9mm0.gif" alt="image"><br><br>  The result is available by <a href="https://loaddy.com/result/719807590/">reference</a> . <br><br>  The good news is that all requests were processed, albeit with a long delay, with a large number of them per second.  The server response time approaches 10 seconds with the number of calls of 190+. But let's recall the graph of the apache mode, where we received 4 seconds of the server‚Äôs response for 80+ users, whereas in the php-fpm mode, similar lags are observed for 130 requests that we specifically identified the cursor on the chart above. <br>  But this is the same VPS. <br><br>  Top process table at the end of the test (with 200 users): <br><br><img src="https://habrastorage.org/webt/rj/uj/ra/rjujrafp7z1vbu_iqryibz88cew.gif" alt="image"><br><br>  Note that after the end of testing, the memory used by pfp-fpm was freed: <br><br><img src="https://habrastorage.org/webt/yc/32/vt/yc32vtmtnrupcw6spibvemvkzpk.gif" alt="image"><br><br>  So our server is ready for new loads. <br><br>  It must be remembered that the site works in the nginx + php-fpm mode, this means that apache2 is not used in the work and, as a result, .htaccess is not used.  This may not seem convenient, but it is the fastest possible option, and search engines rank sites that are fast. <br><br><h2>  Conclusion </h2><br>  At the end another small point: If you configured everything on the server and decided to disable the ISP control panel, or you have run out of a license for it, please note that the ‚Äúcore‚Äù process of it will remain on your server.  After months, it can grow, so it is better to ‚Äúkill‚Äù it and remove crona from autorun. <br><br>  If you want to test the site yourself using Loaddy or other methods, it is available at <a href="http://130.193.44.219/">http://130.193.44.219/</a> </div><p>Source: <a href="https://habr.com/ru/post/434198/">https://habr.com/ru/post/434198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434188/index.html">Security Week 52: The Greatest Hits</a></li>
<li><a href="../434190/index.html">How to create a digital Christmas miracle: an interview with the CIO of Santa Claus</a></li>
<li><a href="../434192/index.html">How Baldur's Gate Saved Computer RPGs</a></li>
<li><a href="../434194/index.html">Developing skills for Alice. Experience with voice interfaces, tips for beginners</a></li>
<li><a href="../434196/index.html">3CX v16 Alpha 2 and plans for the new year</a></li>
<li><a href="../434200/index.html">Is it so scary Rust, as it is painted</a></li>
<li><a href="../434202/index.html">4 secrets how not to lose work in data science</a></li>
<li><a href="../434204/index.html">OneWeb offers Russia a share in the project in exchange for frequencies</a></li>
<li><a href="../434206/index.html">Distributor ok.ru/music</a></li>
<li><a href="../434208/index.html">How Go saved our ‚ÄúBlack Friday‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>