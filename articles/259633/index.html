<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Devices with load balancing in network monitoring systems or "what is Network Packet Broker"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, during the work on the 100GE traffic analyzer, I was assigned the task of studying such type of devices as Network Packet Broker (also calle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Devices with load balancing in network monitoring systems or "what is Network Packet Broker"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8f4/a64/ce5/8f4a64ce522049898e35da0e37b276c9.jpg" align="left" vspace="5" hspace="5">  Recently, during the work on the 100GE traffic analyzer, I was assigned the task of studying such type of devices as Network Packet Broker (also called Network Monitoring Switch), or, if simply and in Russian, ‚Äúbalancer‚Äù. <br><br>  This device is used primarily in network monitoring systems.  Gradually, delving into the topic, a sufficient amount of information has accumulated, scattered across different parts of the Internet and documentation.  So the idea of ‚Äã‚Äãan article was born, in which I decided to collect all the found information together and share it with the community. <br><br>  For those who were wondering what is so special about this type of devices, how they are used and why it is the ‚Äúbalancer‚Äù that is - I ask for cat. <br><a name="habracut"></a><br><h3>  <b>What's in a name?</b> </h3><br><img src="https://habrastorage.org/files/8dc/f89/ecf/8dcf89ecfe89495da9fd0377e861f388.jpg" width="497" height="179" align="right" vspace="5" hspace="5">  <b>NPB</b> ‚Äî rack-mounted network device that receives and aggregates network traffic from <abbr title="Switch Port Analyzer">SPAN</abbr> ports or TAPs.  This traffic (or its copies) is further manipulated by the NPB itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      NPBs can be either a one-piece device or a modular one (that is, consist of several blades in one package with the possibility of replacement).  A typical set of NPB characteristics are: <br><br><ul><li>  <b>Data ports</b> (speeds 1GE, 10GE, 40GE, 100GE with SFP, SFP +, QSFP + and CFP modules, respectively). <br></li><li>  <b>Management ports</b> (most commonly RJ-45 10/100/1000).  Management is usually done remotely (API, CLI, GUI, HTTP, SSH, Telnet, or SNMP). </li><li>  <b>Functions implemented in the device</b> (from load balancing and its types to specific traffic filtering options). </li></ul><br><h3>  <b>What is NPB able and what are its features?</b> </h3><br>  The main and most important function of NPB is <b>load balancing</b> (therefore, it can also be called a <i>‚Äúbalancer‚Äù</i> ).  By itself, load balancing is the process of splitting an input stream from one or several interfaces into several output interfaces according to certain rules or criteria.  Almost always, the following functions are used with balancing: <br><br><ul><li>  <b>Filtering</b> - rules that allow you to select streams with a view to their subsequent balancing and reduce the amount of data in these streams. <br></li><li>  <b>Aggregation</b> ‚Äî combining streams from multiple input interfaces into one before performing a balancing operation. <br></li><li>  <b>Switching</b> - most NPBs can serve as a switch. <br></li></ul><br>  <i>The main use of NPB</i> is to extract necessary data from large data streams and to divide them into smaller ones.  This task occurs quite often. <br><br>  Many companies now have many monitoring tools installed to ensure security, surveillance, analytics, and performance management.  There is a problem of transition to other levels of speeds (from 1G to 10G, from 10G to 100G), because there is a lot of equipment that simply does not know how to work at such speeds.  There are two options here - either the purchase of expensive new equipment, or the introduction into the existing structure of the layer in the form of NPB, which will be engaged in the adaptation of data streams for old equipment. <br><br><img src="https://habrastorage.org/files/dcc/c9d/7a3/dccc9d7a31844960b3c709f9d858fc5b.png" width="436" height="554" align="left" vspace="5" hspace="5">  Take for example the usual call-center.  Almost all of them are now digital and all calls are sent there in the form of VoIP traffic over the LAN, and special recording devices (network traffic recorders) are used to record calls.  With an increase in the number of calls to the call-center, one of the recording devices can reach the <i>threshold of its capacity</i> .  This is where load balancing is applied, allowing <i>parallel</i> recording devices to work <i>in parallel</i> , with the following conditions: <br><br><ul><li>  For each call, the entire conversation (in both directions of the traffic flow) must end on a single recording device so that it is not necessary to search for parts of the recorded conversation on several devices. <br></li><li>  A traffic installation call (SIP traffic) must be available for all calls to this recorder. <br></li></ul><br>  Traffic coming from multiple ports is aggregated and arrives at the NPB.  And here (according to the first of the conditions) one of the main requirements appears to him - if the client equipment works with flows at the session level (and this is almost always the case), then the NPB <i>should not break these sessions</i> (session is a group of packets transmitted between specific nodes ), that is, packets from the same session should always come to the same output interface.  This property is called <b>Flow Coherency</b> . <br><br>  Based on this property, you can give the following examples of <i>types of load balancing</i> that can be used in NPB: <br><ul><li>  <b>Uniform</b> (per-packet or round-robin). <br>  Approximately the same amount of traffic goes to all output ports, packets are assigned to output interfaces in a circle.  This type of balancing does not provide Flow Coherency, since  package direction is in no way connected with directions of other packages. <br></li><li>  <b>Static</b> <br>  Balancing occurs on a fixed set of specified rules, for example, on IP source or protocol type.  In this case, the amount of data that came to a specific output interface is not taken into account, i.e.  There is no feedback on which of the output interfaces received more or less traffic.  Depending on exactly what fields are filtered, this type of load balancing may or may not provide Flow Coherency. <br></li><li>  <b>Dynamic</b> <br>  It records traffic sent to each output port.  Most optimal if there are stringent requirements for uniform load on the output interfaces.  Which fields will be used for this type of balancing depends on the algorithm.  Supports Flow Coherency. <br></li><li>  <b>Based on hashes</b> <br>  To select a port, the hash functions calculated by the packet fields (which are specified by the user) are used.  Since the same hash will always be calculated for the same fields, Flow Coherency will ensure balancing when selecting the required fields.  If it turns out that the distribution of hashes will be skewed, then balancing can become very uneven, as statistics on the real output load is not used in the balancing algorithm, but the probability of this is not great. <br></li></ul><br>  Typically, the streams arriving at NPB are defined using <i>5-tuple</i> headers (src / dst IP, src / dst port, protocol).  Packages with the same 5-tuple, but with changed IP and ports, must go to the same device (to record a conversation in both directions).  But at the same time, the threads can be set differently.  For example, if a <i>3-tuple is used</i> , i.e.  IP addresses are fixed, and ports change depending on the packet path, or vice versa, ports are fixed, and IP addresses can change, then NPB should be able to adjust to possible changes in the flow structure.  At the same time, modern NPBs use algorithms that are not tied to storing information about sessions, and, therefore, are not limited in any way by the number of threads being processed. <br><br>  There are also some functions that monitor the state of the channels with which the NPB operates. <br><ul><li>  <b>Link state awaraness</b> - a function that allows you to monitor the status of output channels.  If one of them (or client equipment) fails, the traffic is automatically redistributed between the other output ports of this group.  When the channel returns to its operational state, the traffic is redistributed again.  At the moments of redistribution, transient coherence of the flow is possible.  The performance of the channel is monitored by the presence of a link and / or with the help of keep-alive packets. <br></li><li>  <b>N + M redundancy</b> is a channel <b>redundancy</b> function that works as follows: in the balancing group, N used (active) and M backup channels are selected and if one of the active channels of the group fails, then its traffic is transferred to one of the backup channels.  At restoration of the channel of redistribution does not occur and the restored channel becomes reserve.  This function is used in the case when even short-term violations of flow coherence are not allowed (instead of link state awaraness). <br></li><li>  <b>Overflow mode</b> - this feature allows you to use the channels as the amount of traffic increases.  The user selects a group of channels and indicates those that will be active immediately.  The remaining channels will be automatically activated after the load on the main exceeds the threshold set by the user. <br></li></ul><br>  As for the SIP traffic from our example, it can be started up on all recording devices, since  It creates a small load compared to VoIP traffic.  SIP is transmitted over TCP, while VoIP is transmitted over RTP-UDP.  Here <i>filters</i> work - one of the filters extracts SIP traffic from the stream and forwards it to all recording devices, while the other selects RTP packets and NPB performs load balancing of this traffic between all recording devices. <br><br><h3>  <b>Many filtrations, good and different</b> </h3><br>  In order to give a clearer idea of ‚Äã‚Äãwhat is happening with the packages inside the NPB and what ultimately goes on balancing, consider some of the basic filtering functions implemented in most devices of this type. <br><br>  <b>Packet filtering</b> <br><img src="https://habrastorage.org/files/a4b/970/01c/a4b97001c5bc44119a8e480f607c11d1.png" width="652" height="255"><br>  Allows you to filter incoming packets using the specified rules.  This can be protocol, MAC, IP, VLAN tags, MPLS tags and others.  The search is conducted on the entire contents of the package (including payload).  Templates that are used in this case can be either simple strings with static, user-defined indentation, or complex regular expressions with varying indents.  The main task is to skip packets that fall under the specified criteria for their subsequent balancing. <br><br>  <b>Packet slicing</b> <br><img src="https://habrastorage.org/files/ec0/55e/c44/ec055ec440124843ad66bac65a281a33.png" width="444" height="164"><br>  Some monitoring devices need certain information from the package, its specific part.  In this case, viewing the entire package will take extra resources.  This feature allows you to ‚Äúcut out‚Äù this part of the package and send it further to the monitoring device for further transformations, analysis or statistics, while avoiding unnecessary viewing of the entire contents of the package.  After the slicing procedure, the CRC of the packet is recalculated. <br><br>  <b>Port stamping</b> <br><img src="https://habrastorage.org/files/d26/5ad/fec/d265adfec9394b5da287e8327c642e46.png" width="562" height="167"><br>  The function of inserting into the packet the label of the port number from which it came.  The number generated in the field of the label itself is generated using a specific formula.  In some devices it is possible to assign a port number yourself through the CLI.  The field length is not more than 2 bytes.  In this case, the package CRC after insertion of the label is recalculated. <br><br>  <b>Time stamping</b> <br><img src="https://habrastorage.org/files/392/b87/4e7/392b874e78924485a9a9fc3cf7311a1b.png" width="606" height="256"><br>  The analogy with port stamping is the insertion of a timestamp.  An 8-byte timestamp block is inserted into the incoming packet (32 bits ‚Äî seconds counter, 32 bits ‚Äî nanosecond counter).  One of the methods is insertion of a 14-byte trailer at the end of the packet - 2 bytes - Source ID (from port stamping), 8 bytes - Timestamp, 4 bytes - CRC recalculated.  The device must support the <abbr title="Network time protocol">NTP</abbr> protocol, which is described in RFC 5905 (talking about NTPv4). <br><br>  <b>Packet De-duplication</b> <br><img src="https://habrastorage.org/files/cd9/6cb/af6/cd96cbaf6b744173939a004c1e3fb5be.png" width="362" height="229"><br>  Marks or removes duplicate packets, which are detected using the configured interval of the original packet (from 1 to 50,000 microseconds).  Occur when using SPAN and mirror technologies in switches, or when collecting packages from several places. <br><br>  <b>Tagging</b> (VLAN and MPLS) <br><img src="https://habrastorage.org/files/b75/f6a/e42/b75f6ae4276f4e928bc9be88331ec37d.png" width="563" height="510"><br>  Used to insert VLAN or MPLS tags into packets, allowing them to be tracked and managed as they move through the network. <br><br>  <b>Protocol / Header Stripping, De-incapsulation</b> <br><img src="https://habrastorage.org/files/859/423/93d/85942393d29744dcbcf922d67eacc879.png" width="473" height="272"><br>  Functions inverse to tagging and not differing from each other in the principle of operation - removal of a certain part of a package (for example, headers or tags). <br><br><h3>  <b>Instead of conclusion</b> </h3><br>  Summarizing all the above, we can say that in the face of Netwok Packet Brokers we have a powerful and flexible customizable tool that allows you to filter, aggregate and redistribute traffic to various devices without replacing the already used equipment. <br><br>  Payment for the benefit of such devices is the complexity of introducing them into existing networks - this requires many hours of re-planning (depending on the complexity of the structure of the network itself and the desired filtering and balancing criteria). <br><br>  Among the manufacturers of NPB there are several companies such as VSS Monitoring, Gigamon, Apcon and Ixia (which, more recently, also includes NetOptics, which also produced NPB).  Who cares what those or manufacturers offer - you are welcome to the links. <br><br>  Thanks for attention! <br><br><h3>  References: </h3><br>  Gigamon <a href="http://www.gigamon.com/">website</a> . <br>  VSS Monitoring <a href="http://www.vssmonitoring.com/">website</a> . <br>  Ixia <a href="http://www.ixiacom.com/">website</a> . <br>  Apcon <a href="http://www.apcon.com/">website</a> . <br><br>  PS I express <a href="http://habrahabr.ru/users/des333/" class="user_link">my deep</a> gratitude to <a href="http://habrahabr.ru/users/des333/" class="user_link">Des333</a> and <a href="http://habrahabr.ru/users/paulig/" class="user_link">paulig</a> for their help in preparing the article. </div><p>Source: <a href="https://habr.com/ru/post/259633/">https://habr.com/ru/post/259633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259621/index.html">"1-wire" for buttons with indication</a></li>
<li><a href="../259623/index.html">ADC as a random number generator</a></li>
<li><a href="../259625/index.html">Isomorphic applications. Looking to the future with React</a></li>
<li><a href="../259627/index.html">Preparing for a PHP interview: the keyword "static"</a></li>
<li><a href="../259629/index.html">Azure Pack at Oblakotek: why and how we did it</a></li>
<li><a href="../259635/index.html">We study the insides of the server Huawei RH5885 V3 (unboxing)</a></li>
<li><a href="../259637/index.html">Method of teaching programming: ‚Äúnote-taking‚Äù</a></li>
<li><a href="../259639/index.html">What did you want to know about the Android Animation Framework, but were afraid to ask</a></li>
<li><a href="../259641/index.html">We write chat for the local network using C ++ Builder. Server part</a></li>
<li><a href="../259645/index.html">Configuring VPLS Multihoming on Juniper Routers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>