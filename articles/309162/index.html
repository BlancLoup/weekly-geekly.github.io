<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing a finite state machine in VHDL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="State machines play a very important role in the development of FPGA firmware. Everyone has heard of two classic types of automata: the Mile machine g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing a finite state machine in VHDL</h1><div class="post__text post__text-html js-mediator-article">  State machines play a very important role in the development of FPGA firmware.  Everyone has heard of two classic types of automata: the Mile machine gun and the Moore machine gun, which were proposed before the FPGA era.  However, the specificity of the construction of the FPGA makes its own adjustments and in the process of working I had a quite definite style of describing the machine. <br><a name="habracut"></a><br>  The literature suggests various implementations of automata.  Such an article is on Habr√© - <a href="https://habrahabr.ru/post/254885/">‚ÄúDescription of digital machines on VHDL‚Äù</a> from <a href="https://habrahabr.ru/users/canny/" class="user_link">canny</a> .  However, in practical implementation on an FPGA, especially at high frequencies, such an implementation is inconvenient.  The following option is proposed. <br><br>  Component Description: <br><br><pre><code class="vhdl hljs"><span class="hljs-keyword"><span class="hljs-keyword">entity</span></span> ex_user <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> ( reset : <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std_logic</span></span>: <span class="hljs-comment"><span class="hljs-comment">-- 1 ‚Äì  clk : in std_logic; --   a : in std_logic; --   q : out std_logic --   ) end ex_user;</span></span></code> </pre> <br>  Description of the type and signals: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="vhdl hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> stp_type <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ( s0, s1, s2, s3 ); <span class="hljs-keyword"><span class="hljs-keyword">signal</span></span> stp : stp_type; <span class="hljs-keyword"><span class="hljs-keyword">signal</span></span> rstp0 : <span class="hljs-built_in"><span class="hljs-built_in">std_logic</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">signal</span></span> rstp : <span class="hljs-built_in"><span class="hljs-built_in">std_logic</span></span>;</code> </pre><br>  Reset Sync: <br><br><pre> <code class="vhdl hljs">rstp0 &lt;= reset <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ns <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rising_edge( clk ); rstp &lt;= rstp0 <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ns <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rising_edge( clk );</code> </pre><br>  Actually automatic, in this case - very simple <br><br><pre> <code class="vhdl hljs">pr_stp: <span class="hljs-keyword"><span class="hljs-keyword">process</span></span>( clk ) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( rising_edge( clk ) ) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>( stp ) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s0 =&gt; <span class="hljs-comment"><span class="hljs-comment">--    q &lt;= '0' after 1 ns; if( a='1' ) then stp &lt;= s1 after 1 ns; end if; when s1 =&gt; --   ,   a=0 if( a='0' ) then stp &lt;= s2 after 1 ns; end if; when s2 =&gt; q &lt;= '1' after 1 ns; stp &lt;= s0 after 1 ns; end case; ---    ,     stp --- if( rstp='1' ) then stp &lt;= s0 after 1 ns; --    stp end if; end if; end process;</span></span></code> </pre><br>  Features: <br><br><ul><li>  Single type description for status signal </li><li>  Sync signal reset </li><li>  Reset only affects the status signal </li><li>  All input signals must be synchronous with the clock frequency of the machine </li><li>  Transitions and output signals are described in the same process. </li><li>  Availability after 1 ns - to facilitate modeling </li><li>  Can be implemented as an Moore machine gun, and a Miles machine gun. </li></ul><br>  There is nothing revolutionary, all this has long been known.  But all together it forms the style of description. <br><br>  More details about the features of the description.  The first is the introduction of a separate type for the state signal.  In this case, the type of listing is described.  This allows the synthesizer to choose the type of signal.  It can be one-hot, it can be a binary counter or a gray counter.  The type of implementation can be specified by synthesizer directives.  This separates the description from the implementation.  If someone does not like it, then it is quite possible to set the type of std_logic_vector and the individual constants s0, s1, etc.  Sometimes I make claims that the names s0, s1 are not informative, and it would be better to use constants associated with the meaning of a particular state.  So I also tried to do it, but in the development process very often the logic of the state changes, but the name remains, and this only confuses the matter. <br><br>  Synchronization signal reset - very often the reset is asynchronous with respect to the clock frequency of the machine.  In order not to check where it comes from, it is better to always put two triggers.  In any case, it will facilitate tracing.  A reset only affects the status signal.  It also makes tracing easier, especially with a large number of output signals, but it requires that, in the initial state, all output signals are described. <br><br>  The machine is a synchronous circuit, so all input signals must be synchronous with a clock frequency, here there are no options.  It is required to know where the signal comes from.  If this signal is generated at a different clock frequency, then it is imperative to put two triggers (as well as for the reset signal). <br><br>  The fact that the transitions and output signals are described in one process makes it visually easier to develop and visibility.  If we make an automaton in two (and even in three processes) as the textbooks advise us, then it is difficult to cover it with a glance.  If only because the big machine on one computer screen does not fit. <br><br>  The most controversial statement is to write after 1 ns when assigning a signal.  At one of the forums I was very much criticized for this.  They also wrote that as I gained experience, I would get rid of this bad habit.  My experience shows that this is a very good habit.  The presence of such a record allows you to be sure that the simulation results and the results of work in real equipment will be the same.  It's all about the concept of delta delay. <br>  Consider a simple language construct: <br><br><pre> <code class="vhdl hljs">clk2 &lt;= clk1; b &lt;= a <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rising_edge( clk1 ); c &lt;= b <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rising_edge( clk1 ); d &lt;= b <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rising_edge( clk2 );</code> </pre><br>  The result of the work is shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b03/9c7/c80/b039c7c802a84689bcafcb4d19ede37e.png" alt="image"></div><br>  The diagram visually shows that the signals of the clock frequency <b>clk1</b> and <b>clk2 are the</b> same, but in fact <b>clk2 is</b> delayed relative to <b>clk1</b> by the amount of delta delay. The signal <b>c</b> lags behind the signal <b>b</b> by one clock cycle.  It is right.  But the signal <b>d</b> must coincide with the signal <b>c</b> , but this does not happen.  It works before.  This is due to the fact that it is latched by the frequency <b>clk2</b> .  When working in the equipment <b>clk2</b> will coincide with <b>clk1</b> , it will be the same signal on the global clock line.  In real projects, assignments like clk2 &lt;= clk1 are quite common.  Of course, you can try all developers to strictly forbid it, but I strongly doubt the result.  Instead of assignment, you can make a description of the alias type: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> clk2 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> clk1;</code> </pre> <br>  In this case, <b>clk2</b> will just be another name <b>clk1</b> and the results will be correct.  But there is one more thing.  Purely visually, on the timing diagram it is not clear when the signal changes relative to the clock frequency. <br><br>  And this is what happens when after 1 ns is added: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b02/da3/f61/b02da3f61bdc4ae29d08aeae73f051d9.png" alt="image"></div><br>  Signals <b>c</b> and <b>d</b> are formed correctly.  The change in signal <b>b is</b> clearly visible with respect to the clock edge. <br><br>  Once many years ago, I spent a lot of time searching for the causes of different behaviors in a model and in real hardware.  The shift was just one measure.  And this reason is the assignment of the clock frequency and the absence of after 1 ns.  Since then, I always add a delay and have never regretted it. <br><br>  And finally, in the example, Moore‚Äôs machine gun is shown.  The output signals depend only on the state.  But the code can always be changed, like this: <br><br><pre> <code class="vhdl hljs"><span class="hljs-keyword"><span class="hljs-keyword">when</span></span> s1 =&gt; <span class="hljs-comment"><span class="hljs-comment">--   ,   a=0 if( a='0' ) then stp &lt;= s2 after 1 ns; q &lt;= '1' after 1 ns; end if;</span></span></code> </pre><br>  In this case, the signal q will be formed one clock earlier, i.e.  it will depend on the status and input signal.  And this is an automatic Miles. <br><br>  The article <a href="https://habrahabr.ru/post/254885/">Description of digital machines on the VHDL</a> will also provide a description of the description in one process.  At first glance, everything is the same. <br><br><div class="spoiler">  <b class="spoiler_title">Description of CA in one process</b> <div class="spoiler_text"><pre> <code class="vhdl hljs"><span class="hljs-keyword"><span class="hljs-keyword">PROCESS</span></span> (clk, reset) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> reset = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= Init; <span class="hljs-keyword"><span class="hljs-keyword">ELSIF</span></span> (rising_edge(clk)) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> Init =&gt; <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> cnt = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= R; <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> state &lt;= Init; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; output &lt;= <span class="hljs-string"><span class="hljs-string">"000"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> R =&gt; <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> cnt = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= RG; <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> state &lt;= R; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; output &lt;= <span class="hljs-string"><span class="hljs-string">"100"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> RG =&gt; <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> cnt = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= G; <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> state &lt;= RG; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; output &lt;= <span class="hljs-string"><span class="hljs-string">"010"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> G =&gt; <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> cnt = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= GR; <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> state &lt;= G; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; output &lt;= <span class="hljs-string"><span class="hljs-string">"001"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> GR =&gt; <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> cnt = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= R; <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> state &lt;= GR; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; OUTPUT &lt;= <span class="hljs-string"><span class="hljs-string">"010"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCESS</span></span>;</code> </pre><br></div></div><br>  In this description there is a very serious mistake.  During the <b>reset</b> signal, the output signal <b>OUTPUT is</b> not defined, in order to determine it, it is required to make a signal assignment inside the reset: <br><br><pre> <code class="vhdl hljs"><span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> reset = <span class="hljs-string"><span class="hljs-string">'1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> state &lt;= Init; OUTPUT &lt;= <span class="hljs-string"><span class="hljs-string">"000"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">ELSIF</span></span></code> </pre><br>  In this case, three reset lines are added.  With a large number of output signals, this degrades the FPGA trace. <br><br>  In my case, the reset signal acts only on the state signal, but since it is inside the process after the case, then according to the rules of the language, it takes precedence over the purpose of the state inside the case.  A feature of this solution is that the transfer of the output signals to the initial state will occur only on the second clock of the reset signal.  However, in the overwhelming majority of cases this is not essential. <br><br>  In conclusion, I want to note that this style of description has proven itself very well, the machine is well divorced in FPGA.  Cascade connections of several automata and connections to other circuits inside the FPGA are easily obtained. </div><p>Source: <a href="https://habr.com/ru/post/309162/">https://habr.com/ru/post/309162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309152/index.html">Review of computer vision problems in medicine</a></li>
<li><a href="../309154/index.html">Some examples of the practical use of RxJava</a></li>
<li><a href="../309156/index.html">Testing IVR on Asterisk with ... Asterisk</a></li>
<li><a href="../309158/index.html">Survey: Programmer and Salary</a></li>
<li><a href="../309160/index.html">Russian Post for Dummies</a></li>
<li><a href="../309164/index.html">The digest of interesting materials for the mobile developer # 169 (August 29 - September 4)</a></li>
<li><a href="../309166/index.html">Offline-first app with Hoodie & React. Part One: Browser Database</a></li>
<li><a href="../309168/index.html">Interview with Artyom Malyshev, who will speak at Moscow Python in October</a></li>
<li><a href="../309170/index.html">Cable Management: Some Tips From Your Own Experience</a></li>
<li><a href="../309172/index.html">Zabbix 3.0.4: Windows Agent with TLS, LLD drives, a simple SMART example and command line only</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>