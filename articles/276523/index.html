<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The most basic need: how did we implement DNS hosting at Mail.Ru for business?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last year we launched a free DNS hosting for Mail.Ru for Business, and recently it came out of beta testing. Today I want to tell you how we did it, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The most basic need: how did we implement DNS hosting at Mail.Ru for business?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f14/424/14f/f1442414f6914dfaaf4678de506bfb8b.png"><br><br>  Last year we launched a free DNS hosting for Mail.Ru for Business, and recently it came out of beta testing.  Today I want to tell you how we did it, what technical decisions were made, and a little about how we were launched to the entire audience. <br><br>  We carefully listen to the wishes of our users and keep records of all the users.  In this list, DNS hosting stably held in the first lines.  As a result, we solved two tasks: we implemented an additional service, which was requested by many, and added another way to verify the domain for new customers.  In addition, after the transition to our DNS hosting, all the DNS records necessary for mail operation are added automatically. <br><a name="habracut"></a><br><h1>  Choosing a DNS server </h1><br>  When choosing a DNS server, we focused on speed, consumed resources and usability.  I really wanted him to work with the database out of the box.  Considered BIND, NSD and PowerDNS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      BIND is the most popular server, it has good documentation, and you can probably find the answer to any question about it.  However, he does not know how to work with the database out of the box.  Of course, there is a DLZ patch, but the latest update dates back to 2013.  Does not differ high performance. <br><br>  NSD is the undisputed leader in speed and consumed resources, but it does not know how to work with anything except files.  In practice, this means that you need to write a script that periodically takes all the records from the database, writes them to a file and makes reload NSD. <br><br>  PowerDNS has good performance, moderately uses server resources.  It has a lot of useful and not very native patches.  Able to work with PostgreSQL out of the box. <br><br>  Ultimately, when choosing between high performance NSD and good performance and ease of operation, PowerDNS won PowerDNS. <br><br>  It is a pleasure to work with PowerDNS: you make changes to the database, and he picks them up.  In addition, since all the data is taken from the database, it is not necessary to set up the master-slave on the side of PowerDNS, but you can transfer their replication to the base. <br><br><h1>  Name history </h1><br>  To confirm the domain, we issue two NS records - for example, moscow.ens.mail.ru and spb.ens.mail.ru.  Where did the cities come from?  To explain this, you first need to talk about the problem we were trying to solve. <br><br>  We tried to make registration at Mail.Ru for Business easy and convenient.  Now it works as follows.  Suppose you own the domain bestcompanyever.ru and want to register.  You add the domain bestcompanyever.ru on our website, we give you a couple of domains for NS records.  After you register them, you will be able to manage your mail and DNS records. <br><br>  However, it is possible that two people will try to register bestcompanyever.ru at the same time.  For such cases, an algorithm is needed that will reveal the real owner of the domain and grant him the right to manage the mail and the DNS server for this domain. <br><br>  The simplest solution is to give names in a standard format: dns1.mail.ru, dns2.mail.ru, etc., and use a unique combination of entries for identification.  For example, the first user who added bestcompanyever.ru is offered to register dns7.mail.ru and dns23.mail.ru, and the second one - dns3.mail.ru and dns84.mail.ru.  Then we check which pair of NS records is registered for the domain, and on the basis of this we determine who the real owner is.  It would seem that a great system - but there is a nuance.  Often users, having received, for example, dns3 and dns84 as their records, prescribe everything else in this range: dns3, dns4, dns5, dns6, etc. This does not give any bonuses: the only thing that the user receives as a result of such actions , Is an error when verifying the domain.  To avoid such situations, we give out names where the sequence is not obvious.  To do this, we used the names of cities.  Now we have two lists of 50 cities. <br><br><img src="https://habrastorage.org/files/68e/d26/de5/68ed26de5bd340b4a35692e49f0ff659.png"><br><br>  Anyone who registers with Mail.Ru for Business receives one entry from each list.  This gives 2500 unique combinations, which guarantees an unambiguous identification of the domain owner, even if several people try to register one domain. <br><br>  After registration is complete, server names lose their technical meaning.  Regardless of which of the addresses will receive the request, we will always give the requested records. <br><br><h3>  Bust </h3><br>  In theory, an attacker could start the procedures for registering the same domain under 2500 accounts and get all possible variations of NS-name pairs.  When the real owner of the domain would come and start the registration procedure, he would get a couple of those already occupied by the intruder.  And then after adding them to the registrar and automatic verification, we would activate the domain registered to the attacker. <br><br>  Of course, this scenario is complex, expensive, and in general there are not so many domains that would be worth the trouble to suffer so much.  We solved this problem as follows: we added a limit on the number of unconfirmed domains with one name, and for each domain a unique pair is guaranteed to be generated. <br><br><blockquote>  Taking this opportunity, I want to remind you that Mail.Ru Group has <a href="https://hackerone.com/mailru">a vulnerability scanner</a> .  If you, an inquisitive reader, find bugs in DNS hosting (as well as in general on biz.mail.ru), you can earn plus money and money by submitting an application. </blockquote><br><h1>  Feature system </h1><br>  All new functionality is enabled for users through the feature system.  This allows you to flexibly roll out functions, choosing which users to give access to them.  Thus, we can check new features in production without showing them to everyone.  If necessary, you can include features for specific users, domains or a certain percentage of the audience. <br><br>  In the case of DNS hosting, we had a list of users who very, very much wanted to try it.  They were included in the closed beta group.  This step allowed us to identify the bugs associated with rare cases, as well as fix a few problems in the usability of the interface. <br><br>  At the end of the closed beta test, we began to open access to the hosting to all users: first 10%, then 50%, and a week later - to all our clients. <br><br><h1>  Instead of conclusion </h1><br>  We have created a fast and reliable DNS hosting and are not going to stop there.  In the near future we plan to launch DNSSEC.  We continue to improve our hosting and love it when we are criticized.  So I ask all those who have already used it to tell in the comments that you want to improve or add to the hosting. <br><br>  And if you have not had time to try our service - leave comments.  The first 100 habrayusers will receive a promotional code for registering a free domain in the .ru zone with a connected mail and DNS service. <br><br><h1>  Sources </h1><br>  <a href="https://blog.cloudflare.com/whats-the-story-behind-the-names-of-cloudflares-name-servers/">blog.cloudflare.com/whats-the-story-behind-the-names-of-cloudflares-name-servers</a> </div><p>Source: <a href="https://habr.com/ru/post/276523/">https://habr.com/ru/post/276523/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276503/index.html">How to catch a virus in the password-protected archive</a></li>
<li><a href="../276505/index.html">We are not carpenters, not carpenters ... And we are programmers-workers, yes. And install applications on servers of several environments</a></li>
<li><a href="../276509/index.html">Selection of useful utilities SCSS</a></li>
<li><a href="../276517/index.html">C #, PVS-Studio, ReSharper</a></li>
<li><a href="../276519/index.html">SVG-files from the inside and the output of vector images on the canvas "manually" (Part 1)</a></li>
<li><a href="../276525/index.html">Recruitment to St. Petersburg Academic University</a></li>
<li><a href="../276527/index.html">Notes of a true architect: just about the most important thing (Part 1)</a></li>
<li><a href="../276531/index.html">Unified test runner and analysis of test data</a></li>
<li><a href="../276533/index.html">Procedurally generated world maps on Unity C #, part 3</a></li>
<li><a href="../276535/index.html">How are the packages for checking the quality of random sequences?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>