<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selection of random documents from the MongoDB collection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I ran into one rather trivial task, where I had to randomly select posts from the base written by users of the site. The project is written ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selection of random documents from the MongoDB collection</h1><div class="post__text post__text-html js-mediator-article">  Recently, I ran into one rather trivial task, where I had to randomly select posts from the base written by users of the site.  The project is written in Rails using MongoDB as a database and mongoid jam to work with it.  Not that the task was difficult to accomplish, but at the same time, surprisingly, there is no absolutely simple solution for sort_by_random or the like.  Under the cut a couple of examples how to solve this. <br><a name="habracut"></a><br><br>  First, let's look at a simple way to solve the problem.  In mongoid there is a method that allows you to skip several records or, in other words, set the cursor for the point of reference.  This method is called skip and you can pass it the number of records that should be skipped.  If we have a collection with three entries, then to get the second one, you can do something like this <i>Post.skip (1) .first</i> .  Knowing the number of documents in the collection, we can make a shift to a random number of documents and start reading from there: <br><pre><code class="ruby hljs">proxy = Post.where(...) skip = rand(proxy.count - COUNT_OF_POSTS_TO_SHOW) @posts = proxy.skip(skip).limit(COUNT_OF_POSTS_TO_SHOW)</code> </pre> <br><br>  If you do not have special conditions for which you make a sample, the code will look easier.  Usually, some conditions will still be present, such as the creation date or status.  This sample is still quite random, but not quite, since we randomly select a point of reference, and then all the documents go in a row.  Perhaps this variant of chance will suit someone, especially if you need to choose only one record.  But this method may be completely unacceptable in cases where we select products, thus showing products from the same category or with the same price (depending on the collection indices) <br>  My solution for getting completely random records was a little more difficult, but it gave more correct results.  To do this, I needed to add a new field to the collection from which the selection was made, I called it rand_order.  We wrote a random floating-point number from 0 to 1 into it. The most accurate way to fill this field is to add a before_save filter for a model that might look like this: <br><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_rand_order</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rand_order</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rand </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">..</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>.round(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> rand_order <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, each time when saving an object, we check whether the value for the rand_order field is filled in and fill it if it is empty.  Getting random entries will now happen this way: <br><pre> <code class="ruby hljs">proxy = Post.where(...) skip = rand(proxy.count - COUNT_OF_POSTS_TO_SHOW) @posts = proxy.asc(<span class="hljs-symbol"><span class="hljs-symbol">:rand_order</span></span>).skip(skip).limit(COUNT_OF_POSTS_TO_SHOW)</code> </pre><br><br>  It is worth taking into account that if you apply this method to an existing collection that contains documents, then you need to generate random numbers for the rand_order field for them.  This can be done in the migration and taking into account the fact that we made it in before_filter, you just need to call the save method for each of the objects: <br><pre> <code class="ruby hljs">Post.all.each{<span class="hljs-params"><span class="hljs-params">|p|</span></span> p.save}</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/210706/">https://habr.com/ru/post/210706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210684/index.html">Cryptanalysis hash functions GOST R 34.11-2012</a></li>
<li><a href="../210690/index.html">The biggest battle in the history of EVE Online: destroyed ships at $ 200,000</a></li>
<li><a href="../210696/index.html">Build your dream building from LEGO right in Google Chrome</a></li>
<li><a href="../210700/index.html">How would you look for a contractor for the design and design of interfaces?</a></li>
<li><a href="../210702/index.html">[Translation] We are looking for who sent the letter from the general mailbox. Using the Microsoft Exchange Event Log</a></li>
<li><a href="../210712/index.html">Yandex against shocking ads</a></li>
<li><a href="../210714/index.html">Dutch court lifted the lock The Pirate Bay</a></li>
<li><a href="../210716/index.html">Why does the Facebook application have access to your SMS?</a></li>
<li><a href="../210718/index.html">How PayPal and GoDaddy made me give away a $ 50,000 Twitter account</a></li>
<li><a href="../210720/index.html">We explain to business why we have such ‚Äúfig‚Äù assessments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>