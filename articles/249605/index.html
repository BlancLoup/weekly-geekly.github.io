<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Streaming audio in iOS using Yandex.Disk as an example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While working on the project for streaming audio, it was necessary to add support for new services, such as Yandex.Disk. Working with audio in the app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Streaming audio in iOS using Yandex.Disk as an example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d43/17b/c2e/d4317bc2e2f049c5856f52e7c327326f.png"><br><br>  While working on the project for streaming audio, it was necessary to add support for new services, such as Yandex.Disk.  Working with audio in the application is implemented through AVPlayer, which plays files by url and supports standard schemes such as file, http, https.  Everything works fine for services in which the authorization token is sent to the url of the request, among them DropBox, Box, Google Drive.  For services such as Yandex.Disk, the authorization token is passed in the request header and AVPlayer does not provide access to it. <br><br>  Finding solutions to this problem among the available APIs led to the use of the resourceLoader object in AVURLAsset.  With it, we provide access to a file hosted on a remote resource for AVPlayer.  This works on the principle of a local HTTP proxy but with maximum simplification for use. <br><a name="habracut"></a><br>  It is necessary to understand that AVPlayer uses resourceLoader in those cases when he himself does not know how to download the file.  Therefore, we create a url with a custom scheme and initialize the player with this url.  AVPlayer, without knowing how to load a resource, transfers control to resourceLoader. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      AVAssetResourceLoader works through AVAssetResourceLoaderDelegate for which you need to implement two methods: <br><br><pre><code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)resourceLoader:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoader</span></span> *)resourceLoader shouldWaitForLoadingOfRequestedResource:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resourceLoader:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoader</span></span> *)resourceLoader didCancelLoadingRequest:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest;</code> </pre> <br>  The first is called when the AVAssetResourceLoader starts loading the resource and sends us the AVAssetResourceLoadingRequest.  In this case, we memorize the request and begin loading the data.  If the request is no longer relevant, then AVAssetResourceLoader calls the second method and we cancel the data loading. <br><br>  To begin, create an AVPlayer using the url with a custom scheme, assign AVAssetResourceLoaderDelegate and the queue on which the delegate methods will be called: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">AVURLAsset</span></span> *asset = [<span class="hljs-built_in"><span class="hljs-built_in">AVURLAsset</span></span> URLAssetWithURL:[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> URLWithString:<span class="hljs-string"><span class="hljs-string">@"customscheme://host/myfile.mp3"</span></span>] options:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [asset.resourceLoader setDelegate:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> queue:dispatch_get_main_queue()]; <span class="hljs-built_in"><span class="hljs-built_in">AVPlayerItem</span></span> *item = [<span class="hljs-built_in"><span class="hljs-built_in">AVPlayerItem</span></span> playerItemWithAsset:asset]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addObserversForPlayerItem:item]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.player = [<span class="hljs-built_in"><span class="hljs-built_in">AVPlayer</span></span> playerWithPlayerItem:playerItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addObserversForPlayer];</code> </pre><br>  Some class LSFilePlayerResourceLoader will be engaged in resource loading.  It is initialized with the url of the resource being loaded and the YDSession, which will directly download the file from the server.  We will store the LSFilePlayerResourceLoader objects in the NSDictionary, and the key will be the url of the resource. <br><br>  When loading a resource from an unknown source, AVAssetResourceLoader will invoke delegate methods. <br><br><div class="spoiler">  <b class="spoiler_title">AVAssetResourceLoaderDelegate</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)resourceLoader:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoader</span></span> *)resourceLoader shouldWaitForLoadingOfRequestedResource:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest{ <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *resourceURL = [loadingRequest.request URL]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([resourceURL.scheme isEqualToString:<span class="hljs-string"><span class="hljs-string">@"customscheme"</span></span>]){ LSFilePlayerResourceLoader *loader = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> resourceLoaderForRequest:loadingRequest]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(loader==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>){ loader = [[LSFilePlayerResourceLoader alloc] initWithResourceURL:resourceURL session:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session]; loader.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.resourceLoaders setObject:loader forKey:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> keyForResourceLoaderWithURL:resourceURL]]; } [loader addRequest:loadingRequest]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resourceLoader:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoader</span></span> *)resourceLoader didCancelLoadingRequest:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest{ LSFilePlayerResourceLoader *loader = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> resourceLoaderForRequest:loadingRequest]; [loader removeRequest:loadingRequest]; }</code> </pre><br></div></div><br>  At the beginning of the boot method, we check that the scheme corresponds to ours.  Next, take the LSFilePlayerResourceLoader from the cache or create a new one and add a request to load the resource to it. <br><br>  The interface of our LSFilePlayerResourceLoader looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">LSFilePlayerResourceLoader</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSFilePlayerResourceLoader</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resourceURL</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSArray</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">requests</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">strong</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDSession</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assign</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isCancelled</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSFilePlayerResourceLoaderDelegate</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">delegate</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initWithResourceURL</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDSession</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addRequest</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAssetResourceLoadingRequest</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadingRequest</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">removeRequest</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAssetResourceLoadingRequest</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadingRequest</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cancel</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSFilePlayerResourceLoaderDelegate</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filePlayerResourceLoader</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSFilePlayerResourceLoader</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resourceLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">didFailWithError</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSError</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filePlayerResourceLoader</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSFilePlayerResourceLoader</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resourceLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">didLoadResource</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSURL</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resourceURL</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></div></div><br>  It contains methods for adding / removing a request to the queue and a method for canceling all requests.  LSFilePlayerResourceLoaderDelegate will report when the resource is fully loaded or an error occurred during the download. <br><br>  When adding a request to the queue by calling addRequest, we store it in pendingRequests and start the data load operation: <br><br><div class="spoiler">  <b class="spoiler_title">Add request</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addRequest:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *)loadingRequest{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isCancelled==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *interceptedURL = [loadingRequest.request URL]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> startOperationFromOffset:loadingRequest.dataRequest.requestedOffset length:loadingRequest.dataRequest.requestedLength]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pendingRequests addObject:loadingRequest]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(loadingRequest.isFinished==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>){ [loadingRequest finishLoadingWithError:[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> loaderCancelledError]]; } } }</code> </pre><br></div></div><br>  In the beginning, we created a new data load operation for each incoming request.  The result was that the file was loaded into three or four threads while the data overlapped.  But then they found out that as soon as AVAssetResourceLoader starts a new query, the previous ones are no longer relevant for it.  This gives us the opportunity to safely cancel all ongoing data load operations as soon as we start a new one, which saves traffic. <br><br>  The operation of loading data from the server is divided into two.  The first (contentInfoOperation) gets information about the size and type of the file.  The second (dataOperation) - receives the data of the file with the offset.  We subtract the offset and size of the requested data from the object of the AVAssetResourceLoadingDataRequest class. <br><br><div class="spoiler">  <b class="spoiler_title">Data load operation</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)startOperationFromOffset:(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)requestedOffset length:(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)requestedLength{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> cancelAllPendingRequests]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> cancelOperations]; __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(^failureBlock)(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { [weakSelf performBlockOnMainThreadSync:^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weakSelf &amp;&amp; weakSelf.isCancelled==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>){ [weakSelf completeWithError:error]; } }]; }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(^loadDataBlock)(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> off, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> len) = ^(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> offset,<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> length){ [weakSelf performBlockOnMainThreadSync:^{ <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *bytesString = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"bytes=%lld-%lld"</span></span>,offset,(offset+length<span class="hljs-number"><span class="hljs-number">-1</span></span>)]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *params = @{<span class="hljs-string"><span class="hljs-string">@"Range"</span></span>:bytesString}; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionRequest&gt; req = [weakSelf.session partialContentForFileAtPath:weakSelf.path withParams:params response:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> data:^(<span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span> recDataLength, <span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span> totDataLength, <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *recData) { [weakSelf performBlockOnMainThreadSync:^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weakSelf &amp;&amp; weakSelf.isCancelled==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>){ LSDataResonse *dataResponse = [LSDataResonse responseWithRequestedOffset:offset requestedLength:length receivedDataLength:recDataLength data:recData]; [weakSelf didReceiveDataResponse:dataResponse]; } }]; } completion:^(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err){ failureBlock(err); } }]; weakSelf.dataOperation = req; }]; }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInfoOperation = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.session fetchStatusForPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path completion:^(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *err, YDItemStat *item) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weakSelf &amp;&amp; weakSelf.isCancelled==<span class="hljs-literal"><span class="hljs-literal">NO</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *mimeType = item.path.mimeTypeForPathExtension; <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span> contentType = UTTypeCreatePreferredIdentifierForTag(kUTTagClassMIMEType,(__bridge <span class="hljs-built_in"><span class="hljs-built_in">CFStringRef</span></span>)(mimeType),<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> contentLength = item.size; weakSelf.contentInformation = [[LSContentInformation alloc] init]; weakSelf.contentInformation.byteRangeAccessSupported = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; weakSelf.contentInformation.contentType = <span class="hljs-built_in"><span class="hljs-built_in">CFBridgingRelease</span></span>(contentType); weakSelf.contentInformation.contentLength = contentLength; [weakSelf prepareDataCache]; loadDataBlock(requestedOffset,requestedLength); weakSelf.contentInfoOperation = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ failureBlock(err); } } }]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ loadDataBlock(requestedOffset,requestedLength); } }</code> </pre><br></div></div><br>  After receiving information about the file on the server, we create a temporary file in which we will write data from the network and read it as needed. <br><br><div class="spoiler">  <b class="spoiler_title">Disk cache initialization</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)prepareDataCache{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath = [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>] pathForTemporaryFile]; <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] fileExistsAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath] == <span class="hljs-literal"><span class="hljs-literal">YES</span></span>){ [[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] removeItemAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath error:&amp;error]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> &amp;&amp; [[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] fileExistsAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath] == <span class="hljs-literal"><span class="hljs-literal">NO</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *dirPath = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath stringByDeletingLastPathComponent]; [[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] createDirectoryAtPath:dirPath withIntermediateDirectories:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> attributes:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> error:&amp;error]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [[<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager] createFileAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath contents:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> attributes:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle = [<span class="hljs-built_in"><span class="hljs-built_in">NSFileHandle</span></span> fileHandleForWritingAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath]; <span class="hljs-keyword"><span class="hljs-keyword">@try</span></span> { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle truncateFileAtOffset:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation.contentLength]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle synchronizeFile]; } <span class="hljs-keyword"><span class="hljs-keyword">@catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSException</span></span> *exception) { <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = [[<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> alloc] initWithDomain:LSFilePlayerResourceLoaderErrorDomain code:<span class="hljs-number"><span class="hljs-number">-1</span></span> userInfo:@{<span class="hljs-built_in"><span class="hljs-built_in">NSLocalizedDescriptionKey</span></span>:<span class="hljs-string"><span class="hljs-string">@"can not write to file"</span></span>}]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> completeWithError:error]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.readingFileHandle = [<span class="hljs-built_in"><span class="hljs-built_in">NSFileHandle</span></span> fileHandleForReadingAtPath:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.cachedFilePath]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> completeWithError:error]; } }</code> </pre><br></div></div><br>  After receiving the data packet, we first cache it to disk and update the size of the received data stored in the receivedDataLength variable.  At the end we notify requests queued for a new portion of data. <br><br><div class="spoiler">  <b class="spoiler_title">Receive data packet</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)didReceiveDataResponse:(LSDataResonse *)dataResponse{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> cacheDataResponse:dataResponse]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.receivedDataLength=dataResponse.currentOffset; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> processPendingRequests]; }</code> </pre><br></div></div><br>  The caching method writes data to a file with the desired offset. <br><br><div class="spoiler">  <b class="spoiler_title">Data caching</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)cacheDataResponse:(LSDataResonse *)dataResponse{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> offset = dataResponse.dataOffset; <span class="hljs-keyword"><span class="hljs-keyword">@try</span></span> { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle seekToFileOffset:offset]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle writeData:dataResponse.data]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.writingFileHandle synchronizeFile]; } <span class="hljs-keyword"><span class="hljs-keyword">@catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSException</span></span> *exception) { <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = [[<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> alloc] initWithDomain:LSFilePlayerResourceLoaderErrorDomain code:<span class="hljs-number"><span class="hljs-number">-1</span></span> userInfo:@{<span class="hljs-built_in"><span class="hljs-built_in">NSLocalizedDescriptionKey</span></span>:<span class="hljs-string"><span class="hljs-string">@"can not write to file"</span></span>}]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> completeWithError:error]; } }</code> </pre><br></div></div><br>  The reading method does the reverse operation. <br><br><div class="spoiler">  <b class="spoiler_title">Reading data from the cache</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *)readCachedData:(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)startOffset length:(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)numberOfBytesToRespondWith{ <span class="hljs-keyword"><span class="hljs-keyword">@try</span></span> { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.readingFileHandle seekToFileOffset:startOffset]; <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *data = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.readingFileHandle readDataOfLength:numberOfBytesToRespondWith]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; } <span class="hljs-keyword"><span class="hljs-keyword">@catch</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSException</span></span> *exception) {} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br></div></div><br><br>  To notify requests that are in the queue about a new piece of data, we first write information about the content, and then the data from the cache.  If all the data for the request has been recorded, then we remove it from the queue. <br><br><div class="spoiler">  <b class="spoiler_title">Request Alerts</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)processPendingRequests{ <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *requestsCompleted = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> alloc] init]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingRequest</span></span> *loadingRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pendingRequests){ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> fillInContentInformation:loadingRequest.contentInformationRequest]; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didRespondCompletely = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> respondWithDataForRequest:loadingRequest.dataRequest]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didRespondCompletely){ [loadingRequest finishLoading]; [requestsCompleted addObject:loadingRequest]; } } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.pendingRequests removeObjectsInArray:requestsCompleted]; }</code> </pre><br></div></div><br>  In the method of filling information about the content, we set the size, type, flag of access to an arbitrary range of data. <br><br><div class="spoiler">  <b class="spoiler_title">Filling in content information</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)fillInContentInformation:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingContentInformationRequest</span></span> *)contentInformationRequest{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contentInformationRequest == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } contentInformationRequest.byteRangeAccessSupported = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation.byteRangeAccessSupported; contentInformationRequest.contentType = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation.contentType; contentInformationRequest.contentLength = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentInformation.contentLength; }</code> </pre><br></div></div><br>  And the main method in which we read data from the cache and pass it to requests from the queue. <br><br><div class="spoiler">  <b class="spoiler_title">Filling data</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)respondWithDataForRequest:(<span class="hljs-built_in"><span class="hljs-built_in">AVAssetResourceLoadingDataRequest</span></span> *)dataRequest{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startOffset = dataRequest.requestedOffset; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataRequest.currentOffset != <span class="hljs-number"><span class="hljs-number">0</span></span>){ startOffset = dataRequest.currentOffset; } <span class="hljs-comment"><span class="hljs-comment">// Don't have any data at all for this request if (self.receivedDataLength &lt; startOffset){ return NO; } // This is the total data we have from startOffset to whatever has been downloaded so far NSUInteger unreadBytes = self.receivedDataLength - startOffset; // Respond with whatever is available if we can't satisfy the request fully yet NSUInteger numberOfBytesToRespondWith = MIN(dataRequest.requestedLength, unreadBytes); BOOL didRespondFully = NO; NSData *data = [self readCachedData:startOffset length:numberOfBytesToRespondWith]; if(data){ [dataRequest respondWithData:data]; long long endOffset = startOffset + dataRequest.requestedLength; didRespondFully = self.receivedDataLength &gt;= endOffset; } return didRespondFully; }</span></span></code> </pre><br></div></div><br>  This is the end of the work with the loader  It remains to slightly change the Yandex.Disk SDK so that we can load arbitrary range data from a file on the server.  There are only three changes. <br><br>  The first is to add the ability to cancel for each request in YDSession.  To do this, we add the new protocol YDSessionRequest and set it as the return value in the requests. <br><br><div class="spoiler">  <b class="spoiler_title">YDSession.h</b> <div class="spoiler_text"><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDSessionRequest</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cancel</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDSessionRequest</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetchDirectoryContentsAtPath</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">completion</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDFetchDirectoryHandler</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDSessionRequest</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetchStatusForPath</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">completion</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YDFetchStatusHandler</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">;</span></span></code> </pre><br></div></div><br>  Second, we add a method for loading data of arbitrary range from a file on the server. <br><br><div class="spoiler">  <b class="spoiler_title">YDSession.h</b> <div class="spoiler_text"><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionRequest&gt;)partialContentForFileAtPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)srcRemotePath withParams:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)params response:(YDDidReceiveResponseHandler)response data:(YDPartialDataHandler)data completion:(YDHandler)completion;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">YDSession.m</b> <div class="spoiler_text"><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionRequest&gt;)partialContentForFileAtPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)srcRemotePath withParams:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)params response:(YDDidReceiveResponseHandler)response data:(YDPartialDataHandler)data completion:(YDHandler)completion{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> downloadFileFromPath:srcRemotePath toFile:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> withParams:params response:response data:data progress:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> completion:completion]; } - (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionRequest&gt;)downloadFileFromPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)path toFile:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)aFilePath withParams:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)params response:(YDDidReceiveResponseHandler)responseBlock data:(YDPartialDataHandler)dataBlock progress:(YDProgressHandler)progressBlock completion:(YDHandler)completionBlock{ <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *url = [YDSession urlForDiskPath:path]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!url) { completionBlock([<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> errorWithDomain:kYDSessionBadArgumentErrorDomain code:<span class="hljs-number"><span class="hljs-number">0</span></span> userInfo:@{<span class="hljs-string"><span class="hljs-string">@"getPath"</span></span>: path}]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> skipReceivedData = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(aFilePath==<span class="hljs-literal"><span class="hljs-literal">nil</span></span>){ aFilePath = [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>] pathForTemporaryFile]; skipReceivedData = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *filePath = [YDSession urlForLocalPath:aFilePath]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!filePath) { completionBlock([<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> errorWithDomain:kYDSessionBadArgumentErrorDomain code:<span class="hljs-number"><span class="hljs-number">1</span></span> userInfo:@{<span class="hljs-string"><span class="hljs-string">@"toFile"</span></span>: aFilePath}]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } YDDiskRequest *request = [[YDDiskRequest alloc] initWithURL:url]; request.fileURL = filePath; request.params = params; request.skipReceivedData = skipReceivedData; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> prepareRequest:request]; <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *requestURL = [request.URL <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>]; request.callbackQueue = _callBackQueue; request.didReceiveResponseBlock = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSURLResponse</span></span> *response, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *accept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(responseBlock){ responseBlock(response); } }; request.didGetPartialDataBlock = ^(<span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span> receivedDataLength, <span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span> expectedDataLength, <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *data){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(progressBlock){ progressBlock(receivedDataLength,expectedDataLength); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dataBlock){ dataBlock(receivedDataLength,expectedDataLength,data); } }; request.didFinishLoadingBlock = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *receivedData) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(skipReceivedData){ [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>] removeTemporaryFileAtPath:aFilePath]; } <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *userInfo = @{<span class="hljs-string"><span class="hljs-string">@"URL"</span></span>: requestURL, <span class="hljs-string"><span class="hljs-string">@"receivedDataLength"</span></span>: @(receivedData.length)}; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] postNotificationInMainQueueWithName:kYDSessionDidDownloadFileNotification object:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> userInfo:userInfo]; completionBlock(<span class="hljs-literal"><span class="hljs-literal">nil</span></span>); }; request.didFailBlock = ^(<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(skipReceivedData){ [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>] removeTemporaryFileAtPath:aFilePath]; } <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *userInfo = @{<span class="hljs-string"><span class="hljs-string">@"URL"</span></span>: requestURL}; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] postNotificationInMainQueueWithName:kYDSessionDidFailToDownloadFileNotification object:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> userInfo:userInfo]; completionBlock([<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> errorWithDomain:error.domain code:error.code userInfo:userInfo]); }; [request start]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *userInfo = @{<span class="hljs-string"><span class="hljs-string">@"URL"</span></span>: request.URL}; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] postNotificationInMainQueueWithName:kYDSessionDidStartDownloadFileNotification object:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> userInfo:userInfo]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionRequest&gt;)request; }</code> </pre><br></div></div><br>  And the third thing to be corrected is to change the queue of callbacks from parallel to serial, otherwise the data blocks will not arrive in the order we requested, and the user will hear jerks when playing music. <br><br><div class="spoiler">  <b class="spoiler_title">YDSession.m</b> <div class="spoiler_text"><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">instancetype</span></span>)initWithDelegate:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&lt;YDSessionDelegate&gt;)delegate callBackQueue:(<span class="hljs-built_in"><span class="hljs-built_in">dispatch_queue_t</span></span>)queue{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { _delegate = delegate; _callBackQueue = queue; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } YDDiskRequest *request = [[YDDiskRequest alloc] initWithURL:url]; request.fileURL = filePath; request.params = params; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> prepareRequest:request]; request.callbackQueue = _callBackQueue;</code> </pre><br></div></div><br><br>  The source code of the example on <a href="https://github.com/leshkoapps/AVAssetResourceLoader">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/249605/">https://habr.com/ru/post/249605/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249581/index.html">Difficulties in monetizing stolen data</a></li>
<li><a href="../249589/index.html">XSS on sites using the Instagram API</a></li>
<li><a href="../249591/index.html">Microsoft is changing good Windows Store apps for certificates</a></li>
<li><a href="../249597/index.html">(Kiev) On February 5, a video stream of the seminar ‚ÄúENS 15.1: Advanced Switch Operation, Configuration and Management‚Äù will be held</a></li>
<li><a href="../249603/index.html">Create a standalone drone on Intel Edison</a></li>
<li><a href="../249609/index.html">Professional development in information security</a></li>
<li><a href="../249611/index.html">Free school of iOS developers in Petersburg</a></li>
<li><a href="../249613/index.html">Reverse Engineering KR580VM80A / i8080 completed</a></li>
<li><a href="../249619/index.html">Year of struggle for web development without bugs</a></li>
<li><a href="../249621/index.html">R programming language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>