<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What should we build an email marketing service? An inside look, part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How difficult is it to build a full-fledged email marketing service? What do you need to foresee? What pitfalls can meet on the way of inquiring minds...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What should we build an email marketing service? An inside look, part two</h1><div class="post__text post__text-html js-mediator-article">  How difficult is it to build a full-fledged email marketing service?  What do you need to foresee?  What pitfalls can meet on the way of inquiring minds of developers? <br><br><img src="https://habrastorage.org/files/e14/d61/766/e14d6176668748619800ed71326c9f91.png" alt="image"><br><br>  Let's try to figure it out together.  Within the framework of several articles, I will talk about how I have been doing my own email-mailing service for more than a year, what lessons I have learned for myself and what I plan to do with all this further. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At once I will make a reservation that the article deals only with the technical side of the issue. <br><a name="habracut"></a><br>  The first part can be <a href="https://habrahabr.ru/post/313714/">read here</a> . <br><br><h2>  Briefly about yourself </h2><br>  I have been writing in Python for 5 years, I mainly use Django, PostgreSQL, I can write JavaScript at the jQuery + KnockoutJS level, sometimes I write on React.  In my free time, I do freelance on UpWork and my own Internet projects, one of which I now plan to tell about.  I have been involved in this project for about a year and a half. <br><br><h2>  What is this article about? </h2><br>  In the first part, I briefly talked about what technologies I use as core in my product (Python, Django, PostgreSQL), how the tracking of letters works, and also brought some statistics about the service. <br><br><h3>  In this part I will tell: </h3><br>  1. How did I manage to relieve users of pain using asynchronous tasks.  Consider performing multiple tasks simultaneously using <a href="http://www.celeryproject.org/">Celery</a> . <br>  2. How I organized the work with tables containing several million records in a very resource-constrained server.  I'll tell you why sometimes denormalized tables are good. <br>  3. How I managed to quickly and with minimal time costs migrate some of the functionality of the monolithic Django project into separate microservices and what technologies I used for this. <br><br>  So let's get started. <br><br><h2>  Asynchronous tasks in python projects, or why your user should not wait </h2><br>  Sooner or later, all maturing projects are faced with performance problems, especially if we are talking about web applications that process requests from users' browsers in synchronous mode. <br><br><h3>  Simplest example </h3><br>  Suppose you are using a technology stack typical for a python project: a fresh build of uwsgi, nginx as a web server + your python application.  Nginx gives static files and sends the root to uwsgi.  In the uwsgi configuration, you have N workers. <br><br>  All this will work well smoothly until you encounter a large number of "heavy" requests (loading large files, for example), which will require considerable time, close or more than harakiri uwsgi, for processing.  After that, the uwsgi workers will not have time to process requests from users, and users will begin to receive errors from nginx and 502 and swear in the reviews about your "service". <br><br>  Of course, you can resort to solutions like tornado, asyncio + aiohttp, but this is a little about something else, because we already have a synchronous Django application, which is a very bad thing to <s>throw out a</s> rewrite. <br><br>  <i>An inquisitive reader will say that you can combine Django with aiohttp using multiple upstream for nginx, but now I want to consider a more standard approach.</i> <br><br>  Today, the most standard approach in synchronous python projects is to use a library to handle asynchronous <a href="http://www.celeryproject.org/">Celery</a> tasks. <br><br><img src="https://habrastorage.org/files/a1a/ff4/d00/a1aff4d005104b4390dd897003697789.jpg"><br><br>  <b>All information below is valid for version 3.x, because</b>  <b>I use it exactly.</b>  <b>In version 4 of Celery, a lot of things have changed.</b> <br><br>  For those readers who are still unfamiliar with this library, a brief remark that it can: <br><br>  1. You can create tasks (which are normal functions) that Celery will perform asynchronously (or run at the right time with beat). <br><br>  An example of the simplest task that sends a certain system email: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> current_app ... @current_app.task() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_service_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, recipients, template, html_template, context)</span></span></span><span class="hljs-function">:</span></span> html_mail( subject=subject, template=template, html_template=html_template, recipients=recipients, context=context )</code> </pre> <br>  This task is invoked as follows: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.message.tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> send_service_message ... send_service_message.delay( _(<span class="hljs-string"><span class="hljs-string">u'%s:  '</span></span> % subscriber.list.project.domain), [user.email], <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'site/subscriber/email/subscription_notification.html'</span></span>, context )</code> </pre><br>  2. If you use Django, you will get a fairly convenient interface for managing these tasks, which will allow you to determine, for example, the launch parameters for each task at runtime. <br><br>  3. This entire system most often works on the basis of RabbitMQ (used as a message broker) and, most often, is controlled by the supervisord.  Also, a database can be used as a broker (the slowest option, but quite suitable for development), Redis (Celery authors do not advise using it, since the protocol is very difficult to maintain), Amazon SQS. <br><br><h3>  An example of use in my project </h3><br>  My project provides users with email and transactional mail services. <br>  Accordingly, potentially we have 2 types of asynchronous tasks: <br><br>  1. Long tasks.  Mailings can be up to 20-25 thousand letters, carried out within 6-7 hours because of the necessary timeouts when sending letters. <br>  2. Short tasks.  The user has registered on the site, whose backend sent a request to send an email with registration confirmation to the API of my service and within a few seconds (or better - faster), the user should see this email in his inbox. <br><br>  If you plan on scheduling and run all tasks within one queue (that is, by default), all short tasks, if there is already a long task in progress, will wait for it to complete. <br>  It is clear that receiving transactional emails after 6-7 hours is not an option, so we come to using several queues for parallel processing of tasks. <br><br>  To do this, configure the queues themselves in our project: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py ... CELERY_QUEUES = ( Queue('celery', Exchange('celery'), routing_key='celery'), Queue('bulk', Exchange('bulk'), routing_key='bulk'), Queue('transactional', Exchange('transactional'), routing_key='transactional'), ) CELERY_ROUTES = { 'app.campaign.tasks.start_campaign': { 'queue': 'bulk' }, 'app.message.tasks.send_service_message': { 'queue': 'transactional' }, 'app.message.api.tasks.send_message': { 'queue': 'transactional' } }</span></span></code> </pre><br>  In my project I use three queues: <br><br>  1. Transactional - the queue for sending transactional letters <br>  2. Bulk - queue to send mailings <br>  3. Celery - the queue for the remaining tasks. <br><br>  Accordingly, in supervisor.d, the configuration takes the following form: <br><br><pre> <code class="bash hljs">[program:celery] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=&lt;PROJECT_ROOT&gt;/venv/bin/celery worker -A conf.celery -l INFO --concurrency=4 --pidfile=/var/run/celery/celery.pid -Q celery ... [program:bulk] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=&lt;PROJECT_ROOT&gt;/venv/bin/celery worker -A conf.celery -l INFO --concurrency=4 --pidfile=/var/run/celery/bulk.pid -Q bulk ... [program:transactional] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=&lt;PROJECT_ROOT&gt;/venv/bin/celery worker -A conf.celery -l INFO --concurrency=4 --pidfile=/var/run/celery/transactional.pid -Q transactional ...</code> </pre><br>  It is clear that many configuration options are omitted here.  The bottom line is that every queue needs to start its process at the supervisor. <br><br>  Task setting to a specific queue occurs as follows: <br><br><pre> <code class="python hljs">send_message.apply_async(kwargs={<span class="hljs-string"><span class="hljs-string">'mailer'</span></span>: self, <span class="hljs-string"><span class="hljs-string">'message'</span></span>: message}, queue=<span class="hljs-string"><span class="hljs-string">'transactional'</span></span>)</code> </pre> <br>  As a result, we get simultaneous processing of several tasks, users seem to be happy, the service works fairly quickly, and the uwsgi workers are free. <br><br><h3>  Task status tracking </h3><br>  View the status of tasks is quite simple: <br><br><pre> <code class="bash hljs">celery -A conf.celery inspect scheduled celery -A conf.celery inspect active celery -A conf.celery inspect reserved</code> </pre><br>  You can also use the <a href="http://flower.readthedocs.io/en/latest/">Flower</a> solution for more convenient monitoring. <br><br>  I want to note that I do not consider myself to be a super expert at Celery and will be happy if readers share their experiences using it. <br><br><h2>  Denormalization of large tables - for and against </h2><br>  Sooner or later you will accumulate data.  And it will be necessary to work with them somehow. <br>  My service processes about 400,000 emails per month (this is very small), while I clean the data about emails older than 90 days, and still have about 2 million table entries that contain tracking data. <br><br>  These data must be shown in statistics, you need to work with them, you need to make analytics on them in order to identify spammers, etc. <br><br>  In the beginning, my tables were super-normalized, built according to all the canons of SQL.  However, the reality is that ORM Django often makes life very difficult for you and your project due to the rather complex JOINs between your tables. <br>  Plus, it is not always obvious how many queries occur when iterating a queryset, especially for novice developers. <br><br>  As a result, to find a fairly simple query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'SENT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sent_count, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'OPENED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> opened_count, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'REDIRECTED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> redirected_count, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'HARDBOUNCED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> hardbounced_count, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'SOFTBOUNCED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> softbounced_count, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'UNSUBSCRIBED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> unsubscribed_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TO_CHAR(date_trunc(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, (<span class="hljs-string"><span class="hljs-string">'2017-03-01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span> - offs)), <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> offs ) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> MESSAGE_MESSAGEEVENT me <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (d.date=to_char(date_trunc(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, me.date_created), <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'SENT'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPENED'</span></span>, <span class="hljs-string"><span class="hljs-string">'REDIRECTED'</span></span>, <span class="hljs-string"><span class="hljs-string">'HARDBOUNCED'</span></span>, <span class="hljs-string"><span class="hljs-string">'SOFTBOUNCED'</span></span>, <span class="hljs-string"><span class="hljs-string">'UNSUBSCRIBED'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (...)) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span></code> </pre><br>  It took me about 100 seconds.  Awful time, isn't it?  This happened for several reasons: <br><br>  1. First, never do this: <b>AND id IN (...)</b> , if you can have about 100,000 elements in an array :) <br>  2. Secondly, it is much better to write <b>d.date = me.date_created :: date</b> than <b>d.date = to_char (date_trunc ('day', me.date_created), 'YYYY-MM-DD')</b> . <br>  3. Thirdly, in my table there were foreign keys for several other keys.  Because of what JOINs worked very slowly. <br><br><h3>  What I came to </h3><br>  1. I added fields for explicit values ‚Äã‚Äãof related records in addition to foreign keys (partially denormalize tables). <br>  2. Rewrote the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'SENT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sent, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'OPENED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> opened, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'HARDBOUNCED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> hardbounced, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'SOFTBOUNCED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> softbounced, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'UNSUBSCRIBED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> unsubscribed, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> me.status = <span class="hljs-string"><span class="hljs-string">'REDIRECTED'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> redirected <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-string"><span class="hljs-string">'2017-03-01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span> - offs)::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> offs ) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> MESSAGE_MESSAGEEVENT me <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ( d.date=me.date_created::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> me.date_created &gt;= <span class="hljs-string"><span class="hljs-string">'2017-02-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> me.date_created &lt;= <span class="hljs-string"><span class="hljs-string">'2017-03-01 23:59:59'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> me.project_id = ... ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>;</code> </pre><br>  As a result, the processing time of this request was reduced to 3 seconds, which is already quite tolerable.  Explain: <br><br><pre> <code class="sql hljs">GroupAggregate (cost=61552.47..82232.11 rows=200 width=11) (actual time=2445.092..2986.524 rows=31 loops=1) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Join</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">61552.47</span></span>.<span class="hljs-number"><span class="hljs-number">.73614</span></span><span class="hljs-number"><span class="hljs-number">.51</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">491920</span></span> width=<span class="hljs-number"><span class="hljs-number">11</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">2445.048</span></span>.<span class="hljs-number"><span class="hljs-number">.2857</span></span><span class="hljs-number"><span class="hljs-number">.069</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">69314</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Merge</span></span> Cond: (((<span class="hljs-string"><span class="hljs-string">'2017-03-01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - offs.offs)) = ((me.date_created)::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>)) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">62.33</span></span>.<span class="hljs-number"><span class="hljs-number">.64</span></span><span class="hljs-number"><span class="hljs-number">.83</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.127</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.174</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">31</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>: ((<span class="hljs-string"><span class="hljs-string">'2017-03-01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - offs.offs)) <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> Method: quicksort <span class="hljs-keyword"><span class="hljs-keyword">Memory</span></span>: <span class="hljs-number"><span class="hljs-number">26</span></span>kB -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> generate_series offs (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">1000</span></span> width=<span class="hljs-number"><span class="hljs-number">4</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">0.034</span></span>.<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.069</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">31</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; Materialize (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">61490.14</span></span>.<span class="hljs-number"><span class="hljs-number">.62719</span></span><span class="hljs-number"><span class="hljs-number">.94</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">98384</span></span> width=<span class="hljs-number"><span class="hljs-number">15</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">2444.913</span></span>.<span class="hljs-number"><span class="hljs-number">.2695</span></span><span class="hljs-number"><span class="hljs-number">.888</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">69312</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">61490.14</span></span>.<span class="hljs-number"><span class="hljs-number">.61736</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">98384</span></span> width=<span class="hljs-number"><span class="hljs-number">15</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">2444.908</span></span>.<span class="hljs-number"><span class="hljs-number">.2539</span></span><span class="hljs-number"><span class="hljs-number">.290</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">69312</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>: ((me.date_created)::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Sort</span></span> Method: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> Disk: <span class="hljs-number"><span class="hljs-number">2152</span></span>kB -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Bitmap</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Heap</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> message_messageevent me (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">11442.78</span></span>.<span class="hljs-number"><span class="hljs-number">.51647</span></span><span class="hljs-number"><span class="hljs-number">.59</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">98384</span></span> width=<span class="hljs-number"><span class="hljs-number">15</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">1922.446</span></span>.<span class="hljs-number"><span class="hljs-number">.2253</span></span><span class="hljs-number"><span class="hljs-number">.982</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">69312</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) Recheck Cond: (project_id = ...) Filter: ((date_created &gt;= <span class="hljs-string"><span class="hljs-string">'2017-02-01 00:00:00+01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (date_created &lt;= <span class="hljs-string"><span class="hljs-string">'2017-03-01 23:59:59+01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone)) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Bitmap</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Scan</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> message_messageevent_b098ad43 (<span class="hljs-keyword"><span class="hljs-keyword">cost</span></span>=<span class="hljs-number"><span class="hljs-number">0.00</span></span>.<span class="hljs-number"><span class="hljs-number">.11418</span></span><span class="hljs-number"><span class="hljs-number">.19</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">236446</span></span> width=<span class="hljs-number"><span class="hljs-number">0</span></span>) (actual <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>=<span class="hljs-number"><span class="hljs-number">1870.742</span></span>.<span class="hljs-number"><span class="hljs-number">.1870</span></span><span class="hljs-number"><span class="hljs-number">.742</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>=<span class="hljs-number"><span class="hljs-number">284445</span></span> loops=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> Cond: (project_id = ...) Total runtime: <span class="hljs-number"><span class="hljs-number">2988.107</span></span> ms</code> </pre><br><h3>  What are the disadvantages of this solution? </h3><br>  First, the table takes up more disk space.  Secondly, the string values ‚Äã‚Äãin the denormalized table should be relevant.  Those.  if you change the string identifier in the parent table, you must change it in the child denormalized table.  Fortunately, Django migrations make it easy to implement. <br><br><h2>  Migration of the functionality of a monolithic project to microservices </h2><br><img src="https://habrastorage.org/files/25f/60e/e4a/25f60ee4a871420d869d48e4e7cf2fa7.png"><br><br>  One of the problems of growing up of any more or less large project is that it is becoming harder and harder to maintain.  The code base is growing, the number of tests is growing.  Plus, if you make a mistake in one part of the project, others may suffer because of it.  For example, a random SyntaxError will fill up the entire project. <br>  Also, performance problems associated with the heavy queries I have already described are becoming increasingly relevant. <br><br>  The solution is to separate part of the functionality into a separate microservice, i.e .: <br><br>  1. To carry out the code base and tests related to this functionality in a separate project. <br>  2. Create a separate uwsgi instance for it and a separate upstream or server in nginx. <br>  3. Link it with a broker like RabbitMQ or HTTP API with the main project. <br>  ... <br>  4. PROFIT! <br><br><h3>  Advantages of microservice architecture: </h3><br>  1. There is no more danger to overwhelm a project due to an error in one of its functional parts. <br>  2. You can reuse it in other projects.  Especially important for all kinds of links shorteners, image compressors, and similar application microservices. <br>  3. You can update service dependencies independently.  For example, if you are using the legacy version of Django in the main project, you can use newer versions in microservices without having to adapt a significant code base. <br><br>  In my case, I needed to implement a simple admin panel to manage my project.  It had to work separately, due to the fact that it has quite heavy reports on the use of the service by my users, and I did not want to hammer in the uwsgi workers of the main project. <br><br><h3>  Technologies that I used: </h3><br>  1. <a href="http://www.django-rest-framework.org/">Django Rest Framework</a> (hereinafter referred to as DRF) for building the HTTP API within the framework of the main project. <br>  2. For writing the client administration system - ReactJS, NodeJS, Babel, ES6 and other incomprehensible words from the world of the frontend. <br><br><h3>  Build API </h3><br>  DRF allows you to very quickly build convenient REST API interfaces within existing projects.  In my case, I needed to build an interface that would satisfy the following requirements: <br><br>  1. Access to API handles must be secure.  Only certain users with administrative rights must have access to the administration system. <br>  2. The interface should provide a convenient way of interaction for the client SPA application. <br>  3. Pens should work out of the box to get lists of objects, information on a specific object, delete objects, etc.  In general, the API should be sufficient for building a normal CRUD interface on the client side. <br><br><h4>  Authorization </h4><br>  To authorize requests from the client, I used a ready-made solution from DRF - Token authentication. <br><br>  All that needed to be done to enable it: <br><br>  1. Add 'rest_framework.authtoken' to INSTALLED_APPS. <br>  2. Start the migration. <br>  3. Create tokens for users who should have access to the administration system. <br><br>  Next, we create a general mixin, which we will mix into the viewsets we need: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># permissions.py from rest_framework.permissions import IsAdminUser class IsProjectAdminUser(IsAdminUser): def has_permission(self, request, view): return request.user.is_authenticated and request.user.is_admin</span></span></code> </pre><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># views.py from rest_framework.authentication import TokenAuthentication from app.contrib.api.permissions import IsProjectAdminUser class AdminAuthMixin(object): authentication_classes = [TokenAuthentication] permission_classes = [IsProjectAdminUser]</span></span></code> </pre><br>  Then we can simply use this mixin to connect authorization to our ViewSet: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.contrib.api.views <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AdminAuthMixin, MultiSerializerViewSet ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CampaignsViewSet</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AdminAuthMixin, MultiSerializerViewSet)</span></span></span><span class="hljs-class">:</span></span> queryset = Campaign.objects.filter(date_archived__isnull=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) filter_class = CampaignsFilter serializers = { <span class="hljs-string"><span class="hljs-string">'list'</span></span>: CampaignsListSerializer, <span class="hljs-string"><span class="hljs-string">'retrieve'</span></span>: CampaignDetailSerializer, }</code> </pre><br><h4>  Customer interaction </h4><br>  To interact with the API from the client side, the <a href="https://github.com/mzabriskie/axios">axios</a> library was <a href="https://github.com/mzabriskie/axios">perfect</a> . <br><br>  An example of a request to the API: <br><br><pre> <code class="javascript hljs">axios.get(<span class="hljs-string"><span class="hljs-string">'http://example.com/api/entrypoint/'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">params</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.query_params}) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> items = response.data.results.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function"> =&gt;</span></span> obj); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState({ <span class="hljs-attr"><span class="hljs-attr">is_loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">items</span></span>: items, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: response.data.count }); });</code> </pre><br>  I‚Äôll not give the code for the components of the React application, since  it's pretty standard. <br><br><h2>  PS </h2><br>  In the following articles I will talk about how to painlessly organize logging in a large project based on logstash, kibana and elasticsearch, as well as touch on client documentation and support based on HelpScout and GitBook solutions. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/324174/">https://habr.com/ru/post/324174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324162/index.html">Direct charity: children - toys, adults - the right to drawings</a></li>
<li><a href="../324164/index.html">Using scripts in Openvpn to integrate it with other system services (Firewall, DB, etc.)</a></li>
<li><a href="../324166/index.html">Liscript - REPL bots online</a></li>
<li><a href="../324170/index.html">Names or semantics of classes in programming</a></li>
<li><a href="../324172/index.html">Filtering and chaining in functional JavaScript</a></li>
<li><a href="../324176/index.html">Create a web application using VueJS and .NET</a></li>
<li><a href="../324178/index.html">Download trusted environment or easy way to paranoia in IT</a></li>
<li><a href="../324180/index.html">Glitch - a new approach to application development</a></li>
<li><a href="../324182/index.html">We solve standard problems for PM on projects. Part 1</a></li>
<li><a href="../324184/index.html">9 interesting services for the web designer. Special selection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>