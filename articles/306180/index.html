<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks For The Littlest. Micro issue ‚Ññ6. MPLS L3VPN and Internet Access</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All issues  11. Networks for the smallest. Part eleven. MPLS L3VPN 
 10. Networks for the smallest. Part ten. Basic MPLS 
 9. Networks for the smalles...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks For The Littlest. Micro issue ‚Ññ6. MPLS L3VPN and Internet Access</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">All issues</b> <div class="spoiler_text">  <a href="https://habrahabr.ru/post/273679/">11. Networks for the smallest.</a>  <a href="https://habrahabr.ru/post/273679/">Part eleven.</a>  <a href="https://habrahabr.ru/post/273679/">MPLS L3VPN</a> <br>  <a href="http://linkmeup.ru/blog/154.html">10. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/154.html">Part ten.</a>  <a href="http://linkmeup.ru/blog/154.html">Basic MPLS</a> <br>  <a href="http://linkmeup.ru/blog/129.html">9. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/129.html">Part nine.</a>  <a href="http://linkmeup.ru/blog/129.html">Multicast</a> <br>  <a href="http://linkmeup.ru/blog/92.html">8.1 Network for the smallest.</a>  <a href="http://linkmeup.ru/blog/92.html">Micro Issue number 3.</a>  <a href="http://linkmeup.ru/blog/92.html">IBGP</a> <br>  <a href="http://linkmeup.ru/blog/65.html">8. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/65.html">Part Eight</a>  <a href="http://linkmeup.ru/blog/65.html">BGP and IP SLA</a> <br>  <a href="http://linkmeup.ru/blog/50.html">7. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/50.html">Part Seven.</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br>  <a href="http://linkmeup.ru/blog/33.html">6. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/33.html">Part six.</a>  <a href="http://linkmeup.ru/blog/33.html">Dynamic routing</a> <br>  <a href="http://linkmeup.ru/blog/16.html">5. Networks for the smallest: Part Five.</a>  <a href="http://linkmeup.ru/blog/16.html">NAT and ACL</a> <br>  <a href="http://linkmeup.ru/blog/15.html">4. Networks for the smallest: Part Four.</a>  <a href="http://linkmeup.ru/blog/15.html">STP</a> <br>  <a href="http://linkmeup.ru/blog/14.html">3. Networks for the smallest: Part Three.</a>  <a href="http://linkmeup.ru/blog/14.html">Static routing</a> <br>  <a href="http://linkmeup.ru/blog/13.html">2. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a>  <a href="http://linkmeup.ru/blog/13.html">Switching</a> <br>  <a href="http://linkmeup.ru/blog/12.html">1. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a>  <a href="http://linkmeup.ru/blog/12.html">Connection to the equipment cisco</a> <br>  <a href="http://linkmeup.ru/blog/11.html">0. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/11.html">Part zero.</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div><br><br>  The article about L3VPN turned out to be big - as many as 130,000 characters. <br>  Given that not everyone has read it yet, we have taken out this part about Internet access to a separate publication. <br>  This is especially important, because in Runet, and indeed on the Internet, there is no available analysis of this topic. <br>  It is likely that you are reading exclusive material now. <br><br>  So, there is a carrier, which provides its client with L3VPN.  All of a sudden, from the bay and the bakery, he also needed the Internet. <br>  The most obvious solution is to run another cable in one VPN, in another Internet. <br>  Suppose it is difficult.  Then you can raise the subinterface and transfer the photos to the contact in a separate VLAN. <br>  Suppose there is a complicated leased channel, where you can only proxy 1 VLAN or the client‚Äôs equipment does not know how to VLAN (it is a regular computer), what then? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About this next 36,000 letters of your life. <br><br>  <b>Issue content</b> <br><ul><li>  <a href="https://habr.com/ru/post/306180/">NAT to CE</a> </li><li>  <a href="https://habr.com/ru/post/306180/">VRF Aware NAT</a> </li><li>  <a href="https://habr.com/ru/post/306180/">Common Services</a> </li></ul><br><a name="habracut"></a><br>  So, a provider in the same VPN sells access to the Internet, through the same connection, through the same addresses.  This means that in the provider‚Äôs network it will be necessary to configure access from a private network to a public network, and therefore to ensure the intersection of route information. <br>  All this indecency has its name - <b>Route Leaking</b> - routes flow from VRF to the global table.  The name of the functional saying - to resort to Route Leaking, especially through static routes is necessary only in extreme cases, for an eerie crutch. <br><br>  There are two approaches to the implementation of this functionality: <br><ol><li>  Configure static routes from VRF to public network and vice versa. </li><li>  Juggling Route Targets </li></ol><br>  Both have the right to life. <br><br>  Let's start with the statics. <br><br>  Matter of course, we need <a href="http://lookmeup.linkmeup.ru/">NAT</a> to hide private networks. <br>  Scenarios differ only in the place of use: <br><ul><li>  In the client's network - CE NAT. </li><li>  In the provider's network at the extreme PE - PE NAT. </li><li>  In the provider's network at the point of Internet access - VRF Aware NAT. </li></ul><br><br><br><h3>  NAT to CE </h3><br>  The provider issues to the client a pool of public addresses to which it broadcasts its internal ones.  All that remains to be done by the provider is to configure the routing between the VRF and the global table. <br>  Given that the broadcast will be on CE, you need to select only one branch, let it be <i>TARS_2</i> - there we have a public link network - 100.0.1.0/30. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1c5/27e/79f/1c527e79fd5bd74c50ad83ee5c9baa18.png"><br><br>  As you can see, for this test we need something in the quality of the Internet and a computer that needs access to it. <br>  In GNS, there is such a wonderful object as VPCS, which is perfect for this role. <br>  On <i>TARS_2,</i> you need to configure NAT, below is its configuration: <br> <code>TARS_2(config)#interface Loopback0 <br> TARS_2(config-if)#ip address 172.16.255.2 255.255.255.255 <br> <br> TARS_2(config)#interface FastEthernet0/0 <br> TARS_2(config-if)#description To Linkmeup <br> TARS_2(config-if)#ip address 100.0.1.2 255.255.255.252 <br> TARS_2(config-if)#ip nat outside <br> <br> TARS_2(config)#interface FastEthernet0/1 <br> TARS_2(config-if)#description To LAN <br> TARS_2(config-if)#ip address 172.16.1.1 255.255.255.0 <br> TARS_2(config-if)#ip nat inside <br> <br> TARS_2(config)#router bgp 64502 <br> TARS_2(config-router)#network 172.16.1.0 mask 255.255.255.0 <br> TARS_2(config-router)#network 172.16.255.2 mask 255.255.255.255 <br> TARS_2(config-router)#neighbor 100.0.1.1 remote-as 64500 <br> <br> TARS_2(config)#ip nat inside source list 100 interface FastEthernet0/0 overload <br> <br> TARS_2(config)#access-list 100 deny ip 172.16.0.0 0.0.255.255 172.16.0.0 0.0.255.255 <br> TARS_2(config)#access-list 100 permit ip 172.16.0.0 0.0.255.255 any <br></code> <br>  The access-list 100 consists of two lines - the first one prohibits the translation of addresses for packets that go from their network to their own network located on the other end of the provider. <br>  The second line allows broadcasting only for the addresses of your network.  If suddenly you register permit ip any any, then the BGP session with <i>Linkmeup_R3</i> will immediately drop. <br>  Details on how to configure NAT were covered in the <a href="http://linkmeup.ru/blog/16.html">fifth part of the SDSM</a> . <br><br>  Internet configuration: <br> <code>Internet(config)#interface Loopback0 <br> Internet(config-if)#ip address 101.0.0.101 255.255.255.255 <br> <br> Internet(config)#interface FastEthernet0/0 <br> Internet(config-if)#description To linkmeup <br> Internet(config-if)#ip address 101.0.0.1 255.255.255.252 <br> <br> Internet(config)#router bgp 64501 <br> Internet(config-router)#network 101.0.0.0 mask 255.255.240.0 <br> Internet(config-router)#neighbor 101.0.0.2 remote-as 64500 <br> <br> Internet(config)#ip route 101.0.0.0 255.255.240.0 Null0 <br></code> <br>  The BGP settings on the <i>Internet are</i> exactly the same as they were in Balagan-Telecom in the <a href="http://linkmeup.ru/blog/65.html">eighth edition</a> , we only allowed ourselves some liberties with IP addresses. <br>  The Loopback 0 interface on the site with the name <i>Internet</i> represents the entire Internet.  Ping before him and we will check. <br>  <i>Linkmeup_R1 is</i> also <i>configured</i> to communicate with the <i>Internet</i> : <br> <code>Internet(config)#interface FastEthernet1/1 <br> Internet(config-if)#description To Balagan-Telecom <br> Internet(config-if)#ip address 101.0.0.2 255.255.255.252 <br> <br> Internet(config)#router bgp 64500 <br> Internet(config-router)#network 100.0.0.0 mask 255.255.254.0 <br> Internet(config-router)#network 101.0.0.0 mask 255.255.255.252 <br> Internet(config-router)#neighbor 101.0.0.1 remote-as 64501 <br> <br> Internet(config)#ip route 100.0.0.0 255.255.254.0 Null0 <br></code> <br>  As for Internet access from a VPN, in this case, the configuration needs to be changed only at the closest to CE PE - in our case <i>Linkmeup_R3</i> . <br><br>  <b>1.</b> Create a default route for VRF TARS.  This is so that packages that come from <i>TARS_2 are</i> not dropped and know where to go. <br><br> <code>Linkmeup_R3(config)#ip route vrf TARS 0.0.0.0 0.0.0.0 101.0.0.2 global <br></code> <br>  Pay attention here to two things: <br>  The <b>global keyword</b> .  It suggests that Next Hop (101.0.0.2) should be searched for in the <b>global</b> routing table. <br>  Linkmeup_R1 is selected as the Next-Hop address in the direction of the Internet.  Why not Loopback as we love?  This avoids the so-called blackholing'a.  The fact is that the loopback is always available, and in the event of a channel falling between our gateway ( <i>Linkmeup_R1</i> ) and the Internet, <i>TARS_2</i> will not notice this and will continue to send traffic to <i>Linkmeup_R3</i> , and the latter, also suspecting nothing, to <i>Linkmeup_R1</i> .  If we specify a link address, it will disappear from the routing tables as soon as the line falls. <br><br>  As a result of the previous operation, the default route appears on Linkmeup_3: <br><img src="https://habrastorage.org/getpro/habr/post_images/289/57d/6f1/28957d6f197ffc16cc71f86ccad647f6.png"><br><br>  <b>2.</b> Now it needs to be communicated to the client so that he also has a default route (although he could have configured it himself). <br><br> <code>address-family ipv4 vrf TARS <br> neighbor 100.0.1.2 default-originate <br></code> <br>  Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/7ab/9ec/077/7ab9ec077bf119c304671272fa0453ac.png"><br><br>  So, the routes to <i>there</i> , that is, to the Internet, we already have, now with regard to <i>back</i> . <br><br>  <b>3.</b> On <i>Linkmeup_R3,</i> configure a static route for the network 100.0.1.0/30: <br> <code>ip route 100.0.1.0 255.255.255.252 FastEthernet1/0 <br></code> <br>  Why do we need it?  That was the route, it is logical after all.  If from the Internet the packet arrives on <i>Linkmeup_R3</i> , and there is no route to 100.0.1.0/30 in the global routing table ( <i>in the VRF, it will, of course</i> ), the packet will be dropped. <br>  It was: <br><img src="https://habrastorage.org/getpro/habr/post_images/809/eef/7cf/809eef7cf03309a9ade69c0dbe2ca06e.png"><br>  <i>There is a route, but only not there.</i>  <i>The packet will not be dropped, but it will not reach the addressee either.</i> <br><br>  It became: <br><img src="https://habrastorage.org/getpro/habr/post_images/9a6/178/fe9/9a6178fe9d65c6726bc0a7975d0249e9.png"><br><br>  <b>4.</b> Next, you need to inform BGP neighbors about this network - everyone should know about it.  In particular, we are interested in <i>Linkmeup_R1</i> . <br> <code>router bgp 64500 <br> network 100.0.1.0 mask 255.255.255.252 <br></code> <br>  Result: <br><img src="https://habrastorage.org/getpro/habr/post_images/a11/860/0fb/a118600fb2d18a197154aaf44be82f8e.png"><br><br><blockquote>  BGP, in principle, knew about this network before, but only in the address-family ipv4 vrf TARS, where it reached via the <b>redistribute connected</b> command.  In the global routing table it was not. <br></blockquote><br><br>  So, everything is ready, we check: <br><img src="https://habrastorage.org/getpro/habr/post_images/92a/a74/aa9/92aa74aa92121f6159abb3cafc3a0730.png"><br><br>  This suggests that Route Leaking has earned, that is, access from the VRF to the global routing table and vice versa works. <br><br>  Checking the availability of the Internet from a computer is a formality that will show that we have configured NAT correctly.  In fact, all the magic happens on <i>Linkmeup_R3</i> , and the familiar broadcast on <i>TARS_2</i> , that is, the things are largely unrelated, and if the Internet is available from <i>TARS_2</i> , it will be available from <i>PC1</i> . <br>  However, we will check: <br><img src="https://habrastorage.org/getpro/habr/post_images/555/138/da8/555138da8d5a816ab464526911a2ceac.png"><br><br>  Internet is available.  Hooray! <br><br><div class="spoiler">  <b class="spoiler_title">If you're interested, let's see what happens with the package on the way from PC1 to the Internet.</b> <div class="spoiler_text">  1) Normally, the packet hits the default gateway - <i>TARS_2</i> <br><br>  2) <i>TARS_2</i> sees that the destination address only falls under the default route, sends the packet to the FE0 / 0 interface on <i>Linkmeup_R3</i> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/215/82f/36f/21582f36f452ae7c8eb921d5b026f6eb.png"><br><br>  At the last moment, he notices that the packet header fully satisfies the access list (access-list 100) and translates the local address 172.16.1.2 into 100.0.1.2 <br><br>  3) The packet arrives in VRF TARS on <i>Linkmeup_R3</i> , where it again falls under the default route, which points to the address 101.0.0.2 from the global routing table.  Already from the global TM <i>Linkmeup_R3</i> knows that 101.0.0.2 is accessible through 1.1.1.1 and recursively through 10.0.23.2.  And the packet is given a label of 16. That is, after <i>Linkmeup_R3, the</i> packet will already go through MPLS LSP. <br><img src="https://habrastorage.org/getpro/habr/post_images/fd1/2e6/133/fd12e6133bedf0fd094acdb0e06663b5.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b6/4db/5be/7b64db5be499ee81a3c9b3d0f72d8f8c.png"><br>  <i>Package between Linkmeup_R3 and Provier_R2</i> <br><br>  Notice that the VPN tags are not here - the packet migrated from the VPN to the public network. <br><br>  4) On the <i>Linkmeup_R2, the</i> MPLS transport label is removed from the packet ( <a href="http://lookmeup.linkmeup.ru/">PHP is</a> <i>running</i> ) and a clear IP packet is already transmitted on <i>Linkmeup_R1</i> . <br><br>  5) This clean IP packet leaves <i>Linkmeup_R1</i> on the <i>Internet</i> (BGP has reported the route to the network 101.0.0.0/20) <br><br>  6) The <i>Internet</i> knows the route to 100.0.0.0/23 as well via BGP and sends the packet back. <br><br>  7) <i>Linkmeup_R1</i> knows that the addressee is located at 3.3.3.3 - remember, we announced this network in BGP? <br>  Accordingly, via MPLS it reaches <i>Linkmeup_R3</i> . <br><img src="https://habrastorage.org/getpro/habr/post_images/2f9/4b2/d31/2f94b2d31dca5e8904bcb8876c4fafef.png"><br><br>  8) The network 100.0.1.0/30 is in the VRF TARS, but we after all prescribed it statically in the FE1 / 0 interface.  So the packet is transferred safely to the interface. <br><br>  9) Well, then the reverse broadcast on <i>TARS_2</i> and the last mile to the home. <br></div></div><br><br>  <b>Repeat the configuration steps:</b> <br><ul><li>  Configure NAT.  <i>On CE</i> . </li><li>  Set a default route in the direction of the Internet for the VRF with the indication Next Hop and the keyword Global.  <i>On PE</i> . </li><li>  Make PE announce this default route to the client.  <i>On PE</i> . </li><li>  Configure the route in the global TM in the direction of the client with the indication of the output interface.  <i>On PE</i> . </li><li>  Report this route to MBGP neighbors, or rather to that node, which looks to the Internet.  <i>On CE</i> . </li></ul><br>  <a href="https://docs.google.com/document/d/1yLc_8_-F4WVNzp1fD44Ef3V_LCvwXbQPKT5Rz9MvenE/pub">Complete configuration of nodes interesting to us.</a> <br><hr>  The configuration described is <b>Route Leaking</b> . <br><hr><br><br>  Here we omit the script with NAT at the extreme PE, because it is not interesting. <br><br><br><h3>  VRF-Aware NAT </h3><br>  A more correct and slightly more scalable option - setting up the broadcast on Egress PE - on the Internet connection.  In this case, we have a central node where all operations are performed, and the client does not need to do anything. <br><img src="https://habrastorage.org/getpro/habr/post_images/eb6/6e3/86c/eb66e386c1a85bda7fc9b0ce05aded85.png"><br><br>  The only inconvenience: despite the fact that perhaps no client is connected to Egress PE directly, this router will have to support all the VRFs from which you need to access the Internet.  Actually, therefore, he and VRF-Aware. <br><br>  In our case, Egress PE is <i>Linkmeup_R1</i> , which is a gateway to the Internet for the entire network linkmeup ‚Äî no absolutely additional settings on other nodes. <br>  Let <i>PC2</i> from the C3PO Electronic network ( <i>C3PO_2</i> ) want to access the Internet. <br>  <i>We don‚Äôt touch PC1 from TARS 'Robotics and leave it unchanged - they have a separate story with their white addresses, although they can also be natit in the same way.</i> <br><br>  <b>1)</b> So, firstly on <i>Linkmeup_R1 there</i> should be a VRF C3PO.  He is already there, but if it were not, it would be necessary for it to be. <br>  VRF configuration is typical and it has not changed: <br> <code>Linkmeup_R1(config)#ip vrf C3PO <br> Linkmeup_R1(config-vrf)#rd 64500:100 <br> Linkmeup_R1(config-vrf)#route-target export 64500:100 <br> Linkmeup_R1(config-vrf)#route-target import 64500:100 <br></code> <br>  <b>2)</b> Configure NAT <br>  We turn on <b>ip nat inside</b> in the direction from which we receive packets for broadcasting, that is, in the direction of the P-router <i>Linkmeup_R2</i> : <br> <code>Linkmeup_R1(config)#interface FastEthernet 0/1 <br> Linkmeup_R1(config-if)#ip nat inside <br></code> <br>  In the direction of the Internet, turn on <b>ip nat outside</b> : <br> <code>Linkmeup_R1(config)#interface FastEthernet 1/1 <br> Linkmeup_R1(config-if)#ip nat outside <br></code> <br>  Create an ACL where we allow access from the C3PO network to the Internet: <br> <code>Linkmeup_R1(config)#access-list 100 permit ip 192.168.0.0 0.0.255.255 any <br></code> <br>  And actually NAT itself: <br> <code>Linkmeup_R1(config)#$ip nat inside source list 100 interface FastEthernet 1/1 overload <br></code> <br><br>  <b>3)</b> In BGP, as well as last time, we prescribe the default route to be sent to this VRF: <br> <code>Linkmeup_R1(config)#router bgp 64500 <br> Linkmeup_R1(config-router)#address-family ipv4 vrf C3PO <br> Linkmeup_R1(config-router-af)#redistribute static <br> Linkmeup_R1(config-router-af)#default-information originate <br></code> <blockquote>  Be careful with redistribution in production.  Use only with filtering. </blockquote><br>  Note that the redistribute static command alone is not enough to pick up and announce the default route.  To do this, you will additionally have to execute the <b>default-information originate</b> command explicitly. <br>  In order for this route to be announced by BGP, it is necessary that it be in the routing table: <br> <code>Linkmeup_R1(config)#ip route vrf C3PO 0.0.0.0 0.0.0.0 101.0.0.1 global <br></code> <br>  Now it will not work right away, because I was slightly deceiving, saying that no settings anywhere except the Internet gateway will be needed. <br>  The fact is that we generated the default route for VRF C3PO on <i>Linkmeup_R1</i> and transmitted it <i>via Linkmeup_R3</i> via BGP, but then it got stuck before reaching <i>C3PO_2</i> - you need to force OSPF to announce the default route.  Like the previous time without the explicit <b>default-information originate</b> command, it will not do this: <br> <code>Linkmeup_R3(config)#router ospf 2 vrf C3PO <br> Linkmeup_R3(config-router)# default-information originate <br></code> <br>  Checking: <br><img src="https://habrastorage.org/getpro/habr/post_images/03c/084/3f3/03c0843f30c324e7c70fb10ff0dd1030.png"><br>  <i>It would be strange if it did not work.</i> <br><br><div class="spoiler">  <b class="spoiler_title">What happens to the package?</b> <div class="spoiler_text">  1) From <i>PC2</i> to <i>Linkmeup_R3</i> it comes without visible changes (only the MAC header is changed).  On <i>PC2</i> , the default route is manually configured.  At <i>C3PO_2,</i> it is learned over OSPF from <i>Linkmeup_R3</i> . <br><br>  2) On the FE0 / 1 interface, the package enters the VRF C3PO and acquires a service tag. <br><br>  3) The default route in VRF is imported from BGP and it leads to 1.1.1.1 through 10.0.23.2: <br><img src="https://habrastorage.org/getpro/habr/post_images/8fb/e22/a37/8fbe22a3714af09991b0021a215149eb.png"><br><br>  4) From <i>Linkmeup_R3</i> to <i>Linkmeup_R2, the</i> packet goes through MPLS with two labels: internal service - 27 and external transport - 18. This can be seen from the screenshot above. <br><blockquote>  Do not forget to make a correction for PHP - from the Penultimate Router ( <i>Linkmeup_R2</i> ) - to Egress PE ( <i>Linkmeup_R1</i> ) - the package will go with one service tag, because the transport one was dropped as a result of PHP. <br></blockquote><br>  5) On <i>Linkmeup_R1</i> , Route leaking from VRF C3PO to the global table occurs ‚Äî the packet leaves the VRF. <br>  Also here is the broadcast.  <i>Linkmeup_R1</i> writes information about this fact to its broadcast table for VRF C3PO: <br><img src="https://habrastorage.org/getpro/habr/post_images/f4f/ebc/4e9/f4febc4e9639a217e1d1c5f4cc308db7.png" width="713"><br><br>  6) The Internet package goes, of course, without MPLS tags and with the public address of the sender - 101.0.0.2 in the header <br><br>  7) The response packet on <i>Linkmeup_R1</i> falls on the global routing table - the Internet knows the address 101.0.0.2.  On this node, a reverse translation occurs.  The destination address is changed to 192.168.2.2 and you need to look for it in VRF C3PO - this is what the NAT table said. <br><br>  8) And then you already know the process - two labels, a long way to <i>Linkmeup_R3</i> and then to <i>PC2</i> . <br></div></div><br><br>  <a href="https://docs.google.com/document/d/1_Xc0J5hzRrttBO6u4Dluj8Qb2k8kNjdpderGhV9Ikn0/pub">Complete node configuration for VRF Aware NAT.</a> <br><hr>  It was the same Route Leaking. <br><hr><br><br><h3>  Common Services </h3><br>  So far, we have been discussing the problem of transferring traffic from VPN to public networks and back. <br>  Another approach to providing Internet access is to bring it into a separate VRF. <br>  Strictly speaking, it is the most scalable, because there is no need to customize something individually for each client VRF. <br>  An important condition is that NAT occurs on the client‚Äôs network and only routes to the public client prefixes are imported into VRF Internet. <br><br>  Common Services, often referred to as Shared Services, is a continuation of the question of the interaction between VRFs, which we discussed <a href="https://habrahabr.ru/post/273679/">earlier</a> .  The basic idea is that the export / import is accomplished by the special setting of the route-target.  Only this time it is necessary to limit the list of transmitted prefixes in order to avoid intersection of address spaces and allow only public routes. <br><br>  Consider the task again on the example of TARS, because they already have public networks. <br><br>  At the gateway, we create VRF Internet. <br> <code>Linkmeup_R1(config)#ip vrf Internet <br> Linkmeup_R1(config-vrf)#rd 64500:1 <br> Linkmeup_R1(config-vrf)#route-target import 64500:11 <br> Linkmeup_R1(config-vrf)#route-target export 64500:22 <br></code> <br>  Please note that the route target for import and export is different this time and now it will be clear why. <br>  2) Transfer the interface towards the Internet to the VRF: <br> <code>Linkmeup_R1(config)#interface FastEthernet 1/1 <br> Linkmeup_R1(config-if)#ip vrf forwarding Internet <br> Linkmeup_R1(config-if)#ip address 101.0.0.2 255.255.255.252 <br></code> <br>  3) Move the BGP neighborhood with a router on the Internet to the <i>address-family ipv4 vrf Internet</i> : <br> <code>Linkmeup_R1(config-router)#router bgp 64500 <br> Linkmeup_R1(config-router)#no neighbor 101.0.0.1 remote-as 64501 <br> Linkmeup_R1(config-router)#address-family ipv4 vrf Internet <br> Linkmeup_R1(config-router-af)#neighbor 101.0.0.1 remote-as 64501 <br> Linkmeup_R1(config-router-af)#neighbor 101.0.0.1 activate <br></code> <br>  4) Declare the default route: <br> <code>Linkmeup_R1(config)#router bgp 64500 <br> Linkmeup_R1(config-router-af)#network 0.0.0.0 mask 00.0.0.0 <br> Linkmeup_R1(config-router-af)#default-information originate <br></code> <br> <code>Linkmeup_R1(config)#ip route vrf Internet 0.0.0.0 0.0.0.0 101.0.0.1 <br></code> <br>  5) In the client VRF TARS, you also need to configure RT: <br> <code>Linkmeup_R1(config-vrf)#ip vrf TARS <br> Linkmeup_R(config-vrf)# route-target both 64500:200 <br> Linkmeup_R1(config-vrf)# route-target export 64500:11 <br> Linkmeup_R1(config-vrf)# route-target import 64500:22 <br></code> <br>  So, in addition to its own RT, which provides the exchange of routing information with other branches (64500: 200), those RT are configured here, which are also for VRF Internet, but vice versa: <br><ul><li>  what was exported to VRF Internet (64500: 22) then became import to VRF TARS </li><li>  what was on import to VRF Internet (64500: 11) then became export to VRF TARS </li></ul><br><br>  Why is that?  Why not just give route-target both 64500: 1, for example, on all VRFs? <br>  The basic idea of ‚Äã‚Äãthe Common Service concept is to provide access to the right VRF clients, but not allow them to communicate with each other directly to provide isolation, as required by the definition of a VPN. <br>  If you configure the same RT on all VRFs, then the routes will calmly walk between them. <br>  With the above configuration, all client VRFs have RT 64500: 22 for import (everyone will get Internet routes), and also they have RT 64500: 11 for export, but only VRF Internet has this RT 64500: 11 for import - Only VRF Internet will receive customer routes.  They cannot exchange with each other.  The main thing is that the <i>Internet</i> does not engage in philanthropy and does not begin to route client traffic. <br><img src="https://habrastorage.org/getpro/habr/post_images/c61/9ad/97f/c619ad97f0ec6636e8bc1c3c75ec80cf.png"><br><br>  So, as a result of our operations, we can see the following: <br><img src="https://habrastorage.org/getpro/habr/post_images/487/7c2/a4f/4877c2a4f1cced935eca18389ffc88fe.png"><br>  <i>On TARS_2 everything is in order.</i> <br><br>  <i>Linkmeup_R1</i> has a route to the network 100.0.0.0/30, but there are also extra routes to private networks: <br><img src="https://habrastorage.org/getpro/habr/post_images/a10/430/415/a10430415d1e67b81e0f645ab773398c.png"><br><br>  And in this case we will even have an intimate connection: <br><img src="https://habrastorage.org/getpro/habr/post_images/50a/b2a/576/50ab2a576330e527931e4042dd45515a.png"><br><br>  But what about these extra routes in the VRF Internet?  After all, if we connect another VRF in the same way, we will get unnecessary gray subnets from it. <br><br>  Here, as usual, filtering will help.  And if specifically, we will use the prefix-list + route-map: <br> <code>Linkmeup_R1(config)#ip prefix-list 1 deny 172.16.0.0/12 le 32 <br> Linkmeup_R1(config)#ip prefix-list 1 deny 192.168.0.0/16 le 32 <br> Linkmeup_R1(config)#ip prefix-list 1 deny 10.0.0.0/8 le 32 <br> Linkmeup_R1(config)#ip prefix-list 1 permit 0.0.0.0/0 le 32 <br></code> <br>  The first three lines prohibit announcements of all private networks.  The fourth allows all the rest. <br>  In our case, it would be quite possible to do with one line: <b>ip prefix-list 1 permit 100.0.0.0/23 le 32</b> - the entire Linkmeup subnet, but the example we cited is more universal - it allows for the existence of other public networks and, accordingly, one prefix-list can be applied to all vrf. <br>  The following construct applies the extended community to those prefixes that are in prefix-list 1, in other words, sets RT: <br> <code>Linkmeup_R1(config-map)#route-map To_Internet permit 10 <br> Linkmeup_R1(config-map)#match ip address prefix-list 1 <br> Linkmeup_R1(config-map)#set extcommunity rt 64500:11 <br></code> <br>  The only thing left is to apply the route-map to the VRF: <br> <code>Linkmeup_R1(config)#ip vrf TARS <br> Linkmeup_R1(config-vrf)#export map To_Internet <br></code> <br>  After updating the BGP routes (you can force the command <b>clear ip bgp all 64500</b> ), we see that only the public route remained in the VRF Internet: <br><img src="https://habrastorage.org/getpro/habr/post_images/961/de1/431/961de143107c0d8a46ada0194df08b27.png" width="559"><br><br>  And, in fact, checking the availability of the Internet with <i>PC1</i> (NAT is already configured for <i>TARS_2</i> ): <br><img src="https://habrastorage.org/getpro/habr/post_images/f69/34a/194/f6934a1944842188f3b3b6511f6580df.png"><br><hr>  Dear readers, you have just become familiar with another approach to <b>Route Leaking</b> . <br><hr><br>  <a href="https://docs.google.com/document/d/1LgWutlcWs30v6gs3z_17cDq7ZJEckGPFT6ABJaHTpCc/pub">Complete configuration of all nodes for Common Services.</a> <br><br>  The most accessible topic Common Services is described by <a href="http://packetlife.net/blog/2011/may/19/mpls-vpn-common-services/">Jeremy Stretch</a> .  But it has no indication that prefixes need to be filtered. <br>  In general, they have there in theirs America, everyone knows and respect each other.  Therefore, Jeremy readily refers to Ivan Pepelnyak, or rather his <a href="http://blog.ipspace.net/2011/05/mplsvpn-common-services-design.html">note on Common Services</a> , and Ivan, in turn, to Jeremy.  Their articles complement each other, but again the topic is not fully disclosed. <br>  And here is the <a href="https://supportforums.cisco.com/discussion/11567421/route-leaking-between-vrfs-shared-services">third link</a> , which, coupled with the first two, allows you to add up some idea of ‚Äã‚Äãhow Common Services works. <br><br>  All types of Internet access from VRF are described in <a href="https://supportforums.cisco.com/document/32341/providing-internet-access-mpls-l3-vpns">this article</a> .  But it is so confusing that this is why I decided to devote a separate micro-issue to the SDSM to the question of setting up this functionality. <br><br><hr>  In general, about MPLS and its applications, including L3VPN, can be deeply read in <a href="https://www.amazon.com/MPLS-Enabled-Applications-Emerging-Developments-Technologies/dp/0470665459%3Fie%3DUTF8%26*Version*%3D1%26*entries*%3D0">Ina Minei, Julian Lucek.</a>  <a href="https://www.amazon.com/MPLS-Enabled-Applications-Emerging-Developments-Technologies/dp/0470665459%3Fie%3DUTF8%26*Version*%3D1%26*entries*%3D0">MPLS-Enabled Applications</a> . <br>  From the <a href="http://linkmeup.ru/page/bb">list of the best books for the signalman</a> . <br><hr><br>  This year, wait for SDSM12.  MPLS L2VPN. </div><p>Source: <a href="https://habr.com/ru/post/306180/">https://habr.com/ru/post/306180/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306166/index.html">Effective use of Github</a></li>
<li><a href="../306168/index.html">Software update and initial setup instructions for Nokia 7750 (SR-7 | SR-12)</a></li>
<li><a href="../306170/index.html">Mango CRM System Overview</a></li>
<li><a href="../306176/index.html">HTTPoxy vulnerability can redirect web application http requests</a></li>
<li><a href="../306178/index.html">Balancing two providers based on BGP and EEM</a></li>
<li><a href="../306182/index.html">Safety of railways from open sources</a></li>
<li><a href="../306184/index.html">Top Machine Learning Packages in R, Part 2</a></li>
<li><a href="../306186/index.html">How to represent your own company</a></li>
<li><a href="../306188/index.html">Development for SailfishOS: Basics</a></li>
<li><a href="../306190/index.html">Security Week 29: Ubuntu forum leak, proxy vulnerability in PHP, Go and Python, 276 Oracle patches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>