<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Report - overview of the capabilities and architecture of CppComet comets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the text of the report and a video of my presentation from the conference rumeetup.ru given in an easy-to-read form. I also withdrew part of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Report - overview of the capabilities and architecture of CppComet comets</h1><div class="post__text post__text-html js-mediator-article">  This is the text of the report and a video of my presentation from the conference <a href="http://rumeetup.ru/">rumeetup.ru</a> given in an easy-to-read form.  I also withdrew part of the introduction so as not to take time away from my readers for lyrical digressions about the reasons that prompted me to start developing my <a href="https://github.com/CppComet/comet-server">open source server comets</a> from scratch in C ++. <br><a name="habracut"></a><br>  Performance video <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/imB45kbFML4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><div class="spoiler">  <b class="spoiler_title">Entry not containing technically important details</b> <div class="spoiler_text"><h4>  Slide 1 - Greeting </h4><br><img src="https://habrastorage.org/webt/tw/kk/v_/twkkv_n6yy4wceqpvj8xti0rm78.png"><br><br><h4>  Slide 2 - a little about the project </h4><br>  5 years ago I attended the highload ++ 2012 conference where I had the idea to create a comet server.  I had no objective reasons for doing this.  I just liked this idea.  Especially since I had some groundwork from past projects that I could apply. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since then, I have spent almost 2000 hours on this project.  For which I wrote the SaaS comets service and its open source counterpart in such a way that their API is compatible, which allows you to switch without code changes between the SaaS version and the open source version. <br><br>  During this time I managed to write detailed documentation in Russian and English. <br><br>  Despite the fact that I have been using CppComet in production for almost 4 years, I still actively develop it by gradually adding new functions.  For example, last week added functionality clustering. <br><br>  For 4 years I have been engaged in technical support for project users.  And on the basis of each question, improved the API and documentation so that the following users were easier. <br><br><img src="https://habrastorage.org/webt/qe/lp/9t/qelp9tktdaaapjqt0goyobqphi8.png"><br><br></div></div><br><h4>  Slide 3 - Analogs </h4><br>  My project does not do something revolutionary that cannot be realized with the help of other tools.  Therefore, on this slide I have compiled a list of competing projects. <br><br>  <b>Libraries</b> <br><br><ul><li>  <a href="http://github.com/kakserpom/phpdaemon">phpdaemon</a> </li><li>  <a href="http://github.com/ratchetphp/Ratchet">Ratchet</a> </li><li>  <a href="http://github.com/walkor/Workerman">Workerman</a> </li><li>  <a href="">socket.io</a> </li><li>  <a href="http://github.com/centrifugal/centrifugo">centrifugo</a> </li></ul><br>  <b>SaaS</b> <br><br><ul><li>  <a href="http://fanout.io/">fanout.io</a> </li><li>  <a href="http://pubnub.com/">pubnub</a> </li><li>  <a href="http://pusher.com/">pusher</a> </li></ul><br><h4>  Slide 4 - Introduction </h4><br>  Probably before each developer sooner or later there is the task of creating your own chat or implementing any realtime notifications. <br><br>  And it‚Äôs good if the project is new and you can, at the design stage, consider where and what data should be updated in real-time. <br><br>  But this is not always the case.  Sometimes you need to add real-time data updates to an existing project. <br><br>  Suppose we wanted to have comments on articles on the site updated from users immediately, and not after reloading the page. <br><br>  The first and simplest solution is to request data about new comments from the ajax server once per second. <br><br>  The solution is simple and quite working, some do.  For example, in the admin area, where a maximum of 1 - 2 people sitting. <br><br><img src="https://habrastorage.org/webt/zt/1a/vd/zt1avdc7atvdlev7jzwt5uf3hac.png"><br><br><h4>  Slide 5 </h4><br>  But when there are more than one visitors, this code is great if you want to arrange the ddos ‚Äã‚Äãof your site even with relatively small attendance. <br><br><img src="https://habrastorage.org/webt/vk/ms/tc/vkmstcxx4amaksjlgwfatlqxw7g.png"><br><br><h4>  Slide 6 </h4><br>  Instead of sending a lot of requests from the client to the server, it is more efficient to send new data to the client when it appears on the server. <br><br>  In this scheme, clients from JavaScript connect to comets to the server via web socket and wait for notifications from the backend from it. <br><br>  And the web server sends event notifications to the comets server, in the hope that these notifications will be delivered to the frontend. <br><br>  From my own experience I will say that it is convenient to send data to the comets server immediately after this data has been recorded in the site‚Äôs database. <br><br><img src="https://habrastorage.org/webt/af/fa/po/affapoqj71gsp3jbzxxl12vk6va.png"><br><br><h4>  Slide 7 </h4><br>  The server comets have two APIs, one for connecting via websockets from browsers.  And the second interface for sending requests from the backend. <br><br>  For JavaScript API, there is no particular choice in the protocols.  We work on websockets. <br>  But the API for calls from the backend could be implemented in different ways. <br><br><img src="https://habrastorage.org/webt/_p/xe/gh/_pxegh2bsw3d4jpcprljjgbjrlg.png"><br><br><h4>  Slide 8 - API </h4><br>  First, I did not hesitate to write a simple API for my protocol and a PHP client for it.  But the resulting bike was simple to design and inconvenient to maintain. <br>  As a result, maintaining backward compatibility of all API versions for several platforms has proven to be a cumbersome task. <br><br>  Against the background of its protocol, the work on all known REST API looks very attractive.  But in practice, when working on the http protocol, for each request it is necessary to establish a network connection, execute the request and close the network connection.  This is longer than the tcp option where all requests are performed within the same network connection. <br><br>  And in the end I decided to follow the path that was implemented in SphinxSearch, I implemented the server part of the mysql protocol and it became possible to work with the comets server using mysql clients that are under every less popular language. <br><br><img src="https://habrastorage.org/webt/0s/i7/3r/0si73rhjtiott0cetal3qhxdhby.png"><br><br><h4>  Slide 9 - CometQL API </h4><br>  The comets server has become pretending to be a mysql server.  And the API has become similar to database access. <br><br>  insert to send data to the client, select to get information from the comets of the server. <br>  The name of the table refers to the object on which the operation is performed. <br>  The name of the database symbolizes the version of the API we are working on.  So far, version 1. Since backward compatibility has not been broken for more than 2 years. <br><br><img src="https://habrastorage.org/webt/ak/ju/5z/akju5zw08axivxrdc-e7ecdug00.png"><br><br><h4>  Slide 10 - JavaScript API </h4><br>  The JavaScript API hides a lot of error handling code, clustering functions and various optimizations.  For example, no matter how many tabs of one site we open, only one network connection will be established with the comets server and the remaining tabs will communicate with the comets server through a connection common to all. <br><br><img src="https://habrastorage.org/webt/u9/zc/gk/u9zcgkykf9i8tbzg1k5v2nsoam8.png"><br><br><h4>  Slide 11 - Channels for message delivery </h4><br>  To get information about any event in JavaScript, you must subscribe to this event. <br><br>  For example, if we want to receive new comments on the page that we have just opened in the browser, then subscribe to the channel through which the server will notify us about anything. <br><br>  After we subscribe, you can send data from the server to the channel to which we subscribed. <br><br>  The name of the channel can be any, the main thing is that the server sent messages to the channel to which we subscribed from JS <br><br><img src="https://habrastorage.org/webt/wp/aq/du/wpaqduy-3yrniwxjvyxiygzwxzg.png"><br><br><h4>  Slide 12 - Receive Private Messages </h4><br>  In the past example, anyone who knew which channel to subscribe to could receive the message.  But it is not always convenient. <br><br>  For example, if we are writing a chat and want to deliver a message to someone specifically so that other users cannot receive this message, it‚Äôs more convenient to use a private message mechanism instead of channels. <br><br>  To do this, subscribe to a special channel named ‚Äúmsg‚Äù.  Only messages that are addressed to us personally will be sent to it. <br>  This feature is available after the user is authorized on comets server. <br><br><img src="https://habrastorage.org/webt/j-/x1/gk/j-x1gkfmiwh5a15jkcapzqpbcgy.png"><br><br>
<h4>  Slide 13 - Performance </h4><br>  <a href="https://comet-server.com/wiki/doku.php/comet:load-testing">I measure the performance</a> and memory consumption with tsung on average memory consumption of less than <a href="https://comet-server.com/wiki/doku.php/comet:load-testing-result">5 GB of RAM for 64,000 users</a> .  And at the same time, due to the fact that the comets server works in multi-threaded mode, it manages to use all available cores almost evenly. <br><br>  The test is of course synthetic, the real workload in my production happens much less.  In the meantime, up to 1500 people online.  And as a result, the servers are only a few percent of their capacity. <br><br><img src="https://habrastorage.org/webt/td/zj/pl/tdzjpltrdaytldtwxyuicm-0z2g.png"><br><br><h4>  Slide 14 </h4><br>  As a result, we returned to almost the same amount of code that I gave on the first slide, but did everything correctly.  And now they are able to withstand a load of approximately 5 GB of RAM per 64,000 online.  Plus there are opportunities for clustering, scaling and fault tolerance. <br><br><img src="https://habrastorage.org/webt/jk/fg/n5/jkfgn5zjfhygdnvqqarqss-9lka.png"><br><br><h4>  Slide 15 - Scaling </h4><br>  It is always useful to foresee the <a href="https://comet-server.com/wiki/doku.php/comet:cluster">possibility of scaling the architecture</a> . <br><br>  I in the comets server provided the <a href="https://comet-server.com/wiki/doku.php/comet:cluster">possibility of clustering</a> in which each server in the cluster can accept requests and forward them to those servers in the cluster that need to be notified of the event. <br><br>  Data insert operations (insert and set) are performed asynchronously, which means that you will not wait until the request is sent to all servers in the cluster. <br><br>  Data fetch operations (select and show) work synchronously. <br><br><img src="https://habrastorage.org/webt/dh/w9/ys/dhw9ysrgqqjckjhkc8xgrvjlwcg.png"><br><br><h4>  Slide 16 - Fault tolerance </h4><br>  If something breaks and the comets server becomes unavailable, then at best messages will stop coming to users. <br><br>  If we do not have a cluster, then everything can obviously break at once with problems with the server. <br>  If a cluster of comets from servers, the failure of one node can also be painful if it is through this node that we are trying to send a request. <br><br><img src="https://habrastorage.org/webt/3t/06/ee/3t06eexkzoxwdnrhlavyjegbg-8.png"><br><br><h4>  Slide 17 </h4><br>  In the real world, mistakes sometimes happen.  And to write such code for error handling is not the most pleasant thing.  And most importantly, if some of the servers are unavailable, we will not connect at the first attempt. <br>  Therefore, you can include haproxy in the cluster schema for balancing requests between live nodes of the cluster. <br><br><img src="https://habrastorage.org/webt/om/ks/f3/omksf3zkrtcl-laadwtiranjpm4.png"><br><br><h4>  Slide 18 </h4><br>  In haproxy there is a mechanism for polling mysql servers and exclusions from the list of those that do not work.  And it is also possible to set the proportion for load distribution between the nodes of the cluster. <br>  In javascript api is also built in the ability to connect to another node of the cluster if one of the nodes is not available.  As a result, if you turn off the nodes of the cluster of comets of servers, then the performance will continue as long as there is at least one working node in the system. <br><br>  Moreover, clients from web browsers do not even need to refresh the page.  Everything will be hidden inside the javascript api. <br><br><img src="https://habrastorage.org/webt/6u/49/j1/6u49j1o3maat-efl6uwv2hwhmkq.png"><br><br><div class="spoiler">  <b class="spoiler_title">Slide 19 - Project Development Plans</b> <div class="spoiler_text"><h4>  Slide 19 - Plans </h4><br>  The first is improvements in the cluster.  Since I implemented the clustering mechanism only this autumn, I need to accumulate user experience with it.  And the second is the addition of <a href="https://comet-server.com/wiki/doku.php/comet:video:api">video chat</a> functionality <a href="https://comet-server.com/wiki/doku.php/comet:video:api">and video conferencing</a> . <br><br>  Already have a video chat demo.  But the API is still not fully settled.  And although video chat rooms can already be used.  Not the fact that the following releases will have full backward compatibility for video chats. <br><br>  I am also <a href="https://github.com/CppComet/comet-server/projects/1">posting the</a> planned functionality on a <a href="https://github.com/CppComet/comet-server/projects/1">githaba</a> <br><br><img src="https://habrastorage.org/webt/ye/eu/pc/yeeupc3o83lmaucf_ybycli_wlm.png"><br><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Slide 20 - Some examples where already used</b> <div class="spoiler_text"><h4>  Slide 20 - Where already used </h4><br>  In fact, my comet server is used on several dozen sites.  Here are just some of the projects I know about.  The first three have a simple, common chat for all participants. <br><br>  The second line is a chat for a social network and a chat for a dating site. <br><br><img src="https://habrastorage.org/webt/b9/2y/es/b92yesd2s4rzn8btvujoe56y4ga.png"><br><br><img src="https://habrastorage.org/webt/ym/r-/uj/ymr-uji1no6zu-wbx-f7zenuui8.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Slide 21 - Thank you for your attention.</b> <div class="spoiler_text"><h4>  Slide 21 - Thank you for your attention. </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/ada/e53/56b/adae5356b2db87e8e70426fea537be42.png"><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/341662/">https://habr.com/ru/post/341662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341650/index.html">Orange Pi Zero WiFi Speaker / Player or Lost Time Story</a></li>
<li><a href="../341652/index.html">From user to CAD developers</a></li>
<li><a href="../341654/index.html">The cat died, the tail peeled off</a></li>
<li><a href="../341656/index.html">We invite to the conference FPConf 2017</a></li>
<li><a href="../341660/index.html">Streaming and analyzing Java application logs in MS Azure using Log4j and Stream Analytics</a></li>
<li><a href="../341664/index.html">Crash browser warnings with pseudo-password fields</a></li>
<li><a href="../341666/index.html">Joker 2017 conference: amazing stories</a></li>
<li><a href="../341668/index.html">R, Asterisk and wardrobe</a></li>
<li><a href="../341670/index.html">Let's try to evaluate Kubernetes</a></li>
<li><a href="../341672/index.html">Do you have a student syndrome?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>