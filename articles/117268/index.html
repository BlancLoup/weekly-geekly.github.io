<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with mail on MS Exchange server via EWS. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, readers Habrahabr! 

 As part of a series of these posts, I want to talk about technology such as EWS and how to use it to work with mail store...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with mail on MS Exchange server via EWS. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/9b9a8991/ab5d5457/14c0004e/46a1fd34.png"><br><br>  Hello, readers Habrahabr! <br><br>  As part of a series of these posts, I want to talk about technology such as EWS and how to use it to work with mail stored on MS Exchange 2007 - 2010 servers. I will try to show how easy and convenient it is to use EWS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will begin from the very beginning, from acquaintance to this technology and creation of the first project, and we will finish with more complex mail manipulations. <br><br>  This post is <b>introductory</b> and it will most likely be of no interest to those who are already familiar with EWS. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  <a href="http://msdn.microsoft.com/en-us/library/dd877045(v%3DEXCHG.140).aspx">Exchange Web Services</a> ( <b>EWS</b> ) is a special protocol developed by MS and designed to manage mail and other components that make up MS Exchange.  The protocol is based on XML.  Description of supported operations and examples can be found <a href="http://msdn.microsoft.com/en-us/library/dd877037(v%3DEXCHG.140).aspx">here</a> . <br><br>  EWS is a relatively young technology, introduced in Exchange 2007, and replacing the <a href="http://msdn.microsoft.com/en-us/library/aa486282(v%3DEXCHG.65).aspx"><b>WebDAV</b></a> protocol.  MS puts a lot of effort into developing and improving EWS.  Now it is a powerful tool, with a simple and clear API, as well as with excellent documentation, which allows to solve the management tasks of MS Exchange objects. <br><br>  The EWS architecture is shown in the following image: <br><br><img src="https://habrastorage.org/storage/1d5291a6/027afe7a/4a418250/5af5d366.gif"><br><br>  As you can see, the EWS is hosted on servers with a <a href="http://technet.microsoft.com/en-us/library/bb124915.aspx"><b>Client Access Server</b></a> (CAS) role.  This role is responsible for processing requests from the user, i.e.  any client, such as Outlook, MFCMapi, browser + OWA, etc., they all connect to CAS.  The request from the client application goes into IIS, where the application implements the functionality of the EWS is located.  Those.  EWS ‚Äúlives‚Äù in IIS and runs in a separate process or <b>w3wp.exe</b> processes (in which processes run the IIS application pool).  In addition to EWS, other applications can ‚Äúspin‚Äù there, for example, OWA, ECP and PowerShell. <br><br>  EWS acts as a layer between the client request and the internal Exchange.  When an EWS request from a client application arrives, it is proxied to internal Exchange calls, and then it goes to the <a href="http://technet.microsoft.com/en-us/library/bb124699.aspx"><b>Mailbox Server role</b></a> , where the operations themselves are already performed. <br><br>  <i>Note: A little about the internal structure of the Mailbox role can be found in my previous <a href="http://habrahabr.ru/blogs/system_programming/116308/">article</a> .</i> <br><br>  Physically, the EWS is located inside the .NET assembly.  And starting with Exchange 2010, not only EWS calls come in, but also OWA.  Those.  MS apparently realized that the idea of ‚Äã‚Äãseveral branches with the same code functionality was not successful and decided to leave only one branch, which should simplify and speed up support and development. <br><br>  We got a general idea, we can move on to programming. <br><br><h4>  Development </h4><br>  We will need: <br><ol><li>  <b>MS Exchange Server 2007 - 2010</b> for testing </li><li>  <b>Visual Studio 2008 - 2010</b> </li></ol>  First, create an empty <b>C #</b> <b>console</b> project.  Next you need to add reference'y with the description of classes / methods / types, etc., which we need to work with EWS.  The easiest way to do this, if you have Exchange, is to add a <b>Web Reference</b> .  In VS 2010, you need to select the project and select <b>Add Service Rederence</b> , then <b>Advanced</b> , <b>Add Web Reference</b> and enter the address of your test server in the <b>URL</b> field in the format <b>https: // [server name] /EWS/Services.wsdl</b> , i.e.  should be like this: <br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/70/40/70409aa24b777ebc34d81d2d614f248f.png"></a> <br><br>  After clicking next, the download of references will begin, and if everything goes well, you will be asked to indicate the name of this reference, and at the end it will be added to the project. <br><br>  Everything, now we can try to connect to the server.  And the first thing to do is get the <b>ExchangeServiceBinding</b> object, this is probably the most important object in the EWS, it is through it that all valid methods will be called and it identifies the specific connection on the client side.  To create this object, you can use the following method: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ExchangeServiceBinding </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBinding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> String server, String domain, String user, String password</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> esb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExchangeServiceBinding(); <span class="hljs-comment"><span class="hljs-comment">//    esb.Credentials = new NetworkCredential(user, password, domain); //     EWS esb.Url = "https://" + server + "/EWS/Exchange.asmx"; esb.RequestServerVersionValue = new RequestServerVersion(); //   Exchange  //  Exchange 2007 SP1  2010  Exchange2007_SP1 //  Exchange 2007  SP   Exchange2007 esb.RequestServerVersionValue.Version = ExchangeVersionType.Exchange2007_SP1; return esb; }</span></span></code> </pre> <br>  <i>Note: If the server uses a <a href="http://en.wikipedia.org/wiki/Self-signed_certificate">self-signed</a> certificate, then connect will not work.</i>  <i>such certificate will not pass validation.</i>  <i>As a workaround, you can add an additional code to apply any certificates:</i> <br><br><pre> <code class="cs hljs">ServicePointManager.ServerCertificateValidationCallback = (obj, certificate, chain, errors) =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  With the ExchangeServiceBinding you can try to do something useful, for example, send a message.  MSDN suggests that you need to use the <b>CreateItemType</b> object.  To do this, we write the following method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> ExchangeServiceBinding esb, String to, String subject, String body</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  CreateItem request //       // ,      ,    var createItemRequest = new CreateItemType { Items = new NonEmptyArrayOfAllItemsType(), MessageDispositionSpecified = true, MessageDisposition = MessageDispositionType.SendOnly }; //  item  Message //  recipients,      var message = new MessageType(); message.ToRecipients = new EmailAddressType[1]; message.ToRecipients[0] = new EmailAddressType(); message.ToRecipients[0].EmailAddress = to; //   message.Subject = subject; //     message.Body = new BodyType(); message.Body.BodyType1 = BodyTypeType.Text; message.Body.Value = body; //   request   Item' createItemRequest.Items.Items = new ItemType[1]; createItemRequest.Items.Items[0] = message; //   CreateItemResponseType createItemResponse = esb.CreateItem(createItemRequest); //   ArrayOfResponseMessagesType responseMessages = createItemResponse.ResponseMessages; //  ,   var responseMessage = responseMessages.Items; foreach (var rmt in responseMessage.Where(rmt =&gt; rmt.ResponseClass == ResponseClassType.Error)) { throw new Exception(rmt.MessageText); } }</span></span></code> </pre><br><br>  <i>Note: The code above shows the easiest way to send a message, and we don‚Äôt see the ‚Äúpower‚Äù of the classes used, and they provide extensive possibilities for customizing the operations performed (setting various properties, flags, etc.).</i>  <i>More about this and not only I will try to tell in the following articles.</i> <br><br>  Calling this code can be done like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ServicePointManager.ServerCertificateValidationCallback = (obj, certificate, chain, errors) =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String server = <span class="hljs-string"><span class="hljs-string">"myserver"</span></span>, domain = <span class="hljs-string"><span class="hljs-string">"mydomain"</span></span>, user = <span class="hljs-string"><span class="hljs-string">"myuser"</span></span>, password = <span class="hljs-string"><span class="hljs-string">"mypassword"</span></span>, mailTo = <span class="hljs-string"><span class="hljs-string">"myuser2@mydomain.local"</span></span>, subject = <span class="hljs-string"><span class="hljs-string">"read me"</span></span>, body = <span class="hljs-string"><span class="hljs-string">"ehlo, developers!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> esb = GetBinding(server, domain, user, password); SendMessage(esb, mailTo, subject, body); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Done!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.Message != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Console.WriteLine(e.Message); } }</code> </pre><br><br>  If it seemed to you that the code ran a frighteningly long time (I have about 5 seconds), do not worry, this happens only on the first call.  Almost all the time it takes to initialize only once.  Also, if this was the first EWS call for the server, then the server needs to initialize on its part and create a new w3wp instance to process the request, and this may also take some time. <br><br><h4>  Conclusion </h4><br>  We briefly familiarized ourselves with the EWS technology and wrote a simple example of sending a letter to the addressee. <br><br>  As you can see, the code is very short and understandable.  MS documentation is pretty good and almost always with examples.  If you programmed in C ++ MAPI, then you will appreciate how much simpler this method is. <br><br>  If you have a task to write an email client or any other tasks related to remote work on Exchange objects, I hope that you will use the EWS.  because  IMHO this method is the easiest and most understandable of all with whom I had to work. <br><br>  Thanks for attention. <br><br>  <b>To be continued...</b> <br><br></div><p>Source: <a href="https://habr.com/ru/post/117268/">https://habr.com/ru/post/117268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117260/index.html">Testing Cloud Provider Drives</a></li>
<li><a href="../117261/index.html">LED Continuous Integration Server Status Monitor</a></li>
<li><a href="../117262/index.html">The story of how to get from the Mac to the RMM server module, but not without Windows</a></li>
<li><a href="../117264/index.html">Creating a multilingual installer for Windows using WiX</a></li>
<li><a href="../117266/index.html">Space Competition "Let's Go!" Or "To iPad 2?"</a></li>
<li><a href="../117271/index.html">Go sling! - shooting a slingshot at ducks</a></li>
<li><a href="../117274/index.html">What are the types of OutOfMemoryError or from what parts is the memory of the java process</a></li>
<li><a href="../117276/index.html">F # The most difficult game in the world</a></li>
<li><a href="../117278/index.html">Report ‚ÄúGolden rules for creating successful websites‚Äù at the IT2Days Usability conference</a></li>
<li><a href="../117279/index.html">Cosmonautics Day @ Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>