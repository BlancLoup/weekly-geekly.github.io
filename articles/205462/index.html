<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reading Mettler Toledo PS60 Scale Data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I won a project at Elance - to make a simple WinForms application in Visual Basic, which will display data from Mettler Toledo PS60 s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reading Mettler Toledo PS60 Scale Data</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I won a project at Elance - to make a simple WinForms application in Visual Basic, which will display data from Mettler Toledo PS60 scales. <br>  Fortunately, these scales are a USB HID device. <br>  In this post I will describe how to work with similar HID devices in Visual Basic (and indeed in .Net) <br><br><a name="habracut"></a><br><br>  I searched Google a little, found some interesting links. <br>  It is generally recommended to use the <a href="https://github.com/mikeobrien/HidLibrary">Mike O'Brien's USB HID library</a> . <br>  Here is an article that reads data from similar weights using this library: <br>  <a href="http://nicholas.piasecki.name/blog/2008/11/reading-a-stamps-com-usb-scale-from-c-sharp/">nicholas.piasecki.name/blog/2008/11/reading-a-stamps-com-usb-scale-from-c-sharp</a> <br>  What I did not like is guessing the data format.  In addition, by sharing a link with the customer, he received the answer that he did not need the whole library and in general he would prefer that I solve the problem myself. <br>  Well, we are armed with MSDN as well as the specification for the scales: <br>  "64067860 PS scales Operation and Technical Manual.pdf" - easily searched by Google. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Reading data from a HID device, if you do not need any special difficulties (I will try to write about reading ACS NFC SmartCard Reader later), is quite simple: <br>  1) you need to get the DevicePath of the device you need, like this: <br>  (\? \ usb # vid_04a9 &amp; pid_1097 # 207946 # {28d78fad-5a12-11d1-ae5b-0000f803a8c2}) <br>  2) open this DevicePath using the most common CreateFile function with GENERIC_READ access <br><pre><code class="vbscript hljs">NativeMethods.CreateFile(DeviceInterfaceDetailData.DevicePath, NativeMethods.GENERIC_READ, NativeMethods.FILE_SHARE_READ + NativeMethods.FILE_SHARE_WRITE, security, NativeMethods.OPEN_EXISTING, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  3) Read with ReadFile <br><pre> <code class="vbscript hljs">res = NativeMethods.ReadFile(ioHandle, bufPtr, <span class="hljs-number"><span class="hljs-number">10</span></span>, bytesRead, IntPtr.Zero)</code> </pre><br><br>  How to get DevicePath.  The task is simple.  You need to get a list of all devices, find the scales, and read the HIDD_ATTRIBUTES structure using the HidD_GetAttributes function (hidHandle, deviceAttributes) <br>  Steps: <br>  1) Get the device class guid <br><pre> <code class="vbscript hljs">NativeMethods.HidD_GetHidGuid(hidClass)</code> </pre><br>  2) Create an Enumerator for a device class. <br><pre> <code class="vbscript hljs">DeviceInfoSet = NativeMethods.SetupDiGetClassDevs(hidClass, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, NativeMethods.DIGCF_PRESENT + NativeMethods.DIGCF_DEVICEINTERFACE)</code> </pre><br>  3) Go through the list of devices <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> NativeMethods.SetupDiEnumDeviceInfo(DeviceInfoSet, deviceIndex, DeviceInfoData)</code> </pre><br>  4) In the nested loop we go through the list of device interfaces <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">While</span></span> NativeMethods.SetupDiEnumDeviceInterfaces(DeviceInfoSet, DeviceInfoData, hidClass, deviceIfaceIndex, DeviceInterfaceData)</code> </pre><br>  5) Get the DevicePath <br><pre> <code class="vbscript hljs"> success = NativeMethods.SetupDiGetDeviceInterfaceDetailBuffer(DeviceInfoSet, DeviceInterfaceData, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, RequiredSize, IntPtr.Zero) <span class="hljs-comment"><span class="hljs-comment">' Obtain buffer size success = NativeMethods.SetupDiGetDeviceInterfaceDetail(DeviceInfoSet, DeviceInterfaceData, DeviceInterfaceDetailData, RequiredSize, RequiredSize, DeviceInfoData) ' Get device information using previously recieved buffer size</span></span></code> </pre><br>  Here is a small trick with passing null in order to get the correct buffer size for the data.  Half the task is done - we have a DevicePath. <br>  6) Now you need to understand whether this device. <br><pre> <code class="vbscript hljs">NativeMethods.CreateFile(DeviceInterfaceDetailData.DevicePath, NativeMethods.ACCESS_NONE, NativeMethods.FILE_SHARE_READ + NativeMethods.FILE_SHARE_WRITE, security, NativeMethods.OPEN_EXISTING, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  We open the device with ACCESS_NONE (we only need pid &amp; vid, for this there is no need to open the device for reading, most devices will not allow us and here there will be an exception) <br>  7) And read the attributes <br><pre> <code class="vbscript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> deviceAttributes As NativeMethods.HIDD_ATTRIBUTES deviceAttributes.cbSize = Marshal.SizeOf(deviceAttributes) NativeMethods.HidD_GetAttributes(hidHandle, deviceAttributes)</code> </pre><br>  8) Now just compare deviceAttributes.VendorID and deviceAttributes.ProductID with constants and if this is what you need - you can exit the cycles <br><br>  Now actually to the weights.  When reading data, they give us 6 bytes, which need to be dealt with. <br>  According to the specification, the first byte of the parcel is the report id. <br>  The second is the measurement status.  It happens: an error, stable weight, less than zero, fluctuations, etc.  The complete list is in the code and in the specification. <br>  The third is the unit of measurement.  This is understandable - milligrams, grams, kilograms, etc.  Though troy ounce. <br>  The next three bytes are the actual weight. <br>  The first byte of weight is the power of tens, the next two are the actual value. <br>  Thus, to get the weight value, you need to do a simple operation: <br>  (b [5] * 256 + b [4]) * 10 ^ b [3] <br><br>  That's it - it's pretty simple. <br><br>  Source: <br><br><div class="spoiler">  <b class="spoiler_title">NativeMethods.vb</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> NativeMethods <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_PRESENT = &amp;H2 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_DEVICEINTERFACE = &amp;H10 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_FLAG_OVERLAPPED = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_READ = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_WRITE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_READ = &amp;H80000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_WRITE = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> ACCESS_NONE = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> INVALID_HANDLE_VALUE = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> OPEN_EXISTING = <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;StructLayout(LayoutKind.Sequential, CharSet:=CharSet.Auto)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DETAIL_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As UInt32 &lt;MarshalAs(UnmanagedType.ByValTStr, SizeConst:=<span class="hljs-number"><span class="hljs-number">256</span></span>)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevicePath As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> InterfaceClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Flags As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVINFO_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevInst As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_INPUT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_OUTPUT = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_FEATURE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure HIDD_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VendorID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ProductID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VersionNumber As Short <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SECURITY_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> nLength As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> lpSecurityDescriptor As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> bInheritHandle As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CreateFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (lpFileName As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, dwDesiredAccess As Integer, dwShareMode As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpSecurityAttributes As SECURITY_ATTRIBUTES, dwCreationDisposition As Integer, dwFlagsAndAttributes As Integer, hTemplateFile As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> ReadFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hFile As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Buffer As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> nNumberOfBytesToRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpNumberOfBytesRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Overlapped As IntPtr) As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CloseHandle Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (hObject As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetClassDevs Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> ClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Enumerator As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hwndParent As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Flags As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiDestroyDeviceInfoList Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (deviceInfoSet As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInfo Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInterfaces Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> InterfaceClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As UInteger, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetailBuffer Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"SetupDiGetDeviceInterfaceDetail"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailData As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetail Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceDetailData As SP_DEVICE_INTERFACE_DETAIL_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span> HidD_GetHidGuid Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"HidD_GetHidGuid"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> hidGuid As Guid) <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> HidD_GetAttributes Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> (hidDeviceObject As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> attributes As HIDD_ATTRIBUTES) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span></code> " Alias "SetupDiGetDeviceInterfaceDetail" (ByVal DeviceInfoSet As IntPtr, ByRef DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, ByVal DeviceInterfaceDetailData As IntPtr, ByVal DeviceInterfaceDetailDataSize As Integer, ByRef RequiredSize As Integer, ByRef DeviceInfoData As IntPtr) As Boolean <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> NativeMethods <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_PRESENT = &amp;H2 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_DEVICEINTERFACE = &amp;H10 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_FLAG_OVERLAPPED = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_READ = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_WRITE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_READ = &amp;H80000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_WRITE = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> ACCESS_NONE = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> INVALID_HANDLE_VALUE = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> OPEN_EXISTING = <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;StructLayout(LayoutKind.Sequential, CharSet:=CharSet.Auto)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DETAIL_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As UInt32 &lt;MarshalAs(UnmanagedType.ByValTStr, SizeConst:=<span class="hljs-number"><span class="hljs-number">256</span></span>)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevicePath As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> InterfaceClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Flags As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVINFO_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevInst As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_INPUT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_OUTPUT = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_FEATURE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure HIDD_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VendorID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ProductID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VersionNumber As Short <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SECURITY_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> nLength As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> lpSecurityDescriptor As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> bInheritHandle As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CreateFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (lpFileName As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, dwDesiredAccess As Integer, dwShareMode As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpSecurityAttributes As SECURITY_ATTRIBUTES, dwCreationDisposition As Integer, dwFlagsAndAttributes As Integer, hTemplateFile As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> ReadFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hFile As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Buffer As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> nNumberOfBytesToRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpNumberOfBytesRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Overlapped As IntPtr) As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CloseHandle Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (hObject As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetClassDevs Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> ClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Enumerator As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hwndParent As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Flags As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiDestroyDeviceInfoList Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (deviceInfoSet As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInfo Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInterfaces Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> InterfaceClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As UInteger, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetailBuffer Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"SetupDiGetDeviceInterfaceDetail"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailData As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetail Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceDetailData As SP_DEVICE_INTERFACE_DETAIL_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span> HidD_GetHidGuid Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"HidD_GetHidGuid"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> hidGuid As Guid) <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> HidD_GetAttributes Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> (hidDeviceObject As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> attributes As HIDD_ATTRIBUTES) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span></code> " (ByVal DeviceInfoSet As IntPtr, ByRef DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, ByRef DeviceInterfaceDetailData As SP_DEVICE_INTERFACE_DETAIL_DATA, ByVal DeviceInterfaceDetailDataSize As Integer, ByRef RequiredSize As Integer, ByRef DeviceInfoData As SP_DEVINFO_DATA) As Boolean <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> NativeMethods <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_PRESENT = &amp;H2 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> DIGCF_DEVICEINTERFACE = &amp;H10 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_FLAG_OVERLAPPED = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_READ = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> FILE_SHARE_WRITE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_READ = &amp;H80000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> GENERIC_WRITE = &amp;H40000000 <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> ACCESS_NONE = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> INVALID_HANDLE_VALUE = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> OPEN_EXISTING = <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;StructLayout(LayoutKind.Sequential, CharSet:=CharSet.Auto)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DETAIL_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As UInt32 &lt;MarshalAs(UnmanagedType.ByValTStr, SizeConst:=<span class="hljs-number"><span class="hljs-number">256</span></span>)&gt; _ <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevicePath As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVICE_INTERFACE_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> InterfaceClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Flags As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SP_DEVINFO_DATA <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ClassGuid As System.Guid <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> DevInst As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Reserved As UIntPtr <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_INPUT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_OUTPUT = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> HIDP_FEATURE = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure HIDD_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> cbSize As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VendorID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> ProductID As UShort <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> VersionNumber As Short <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Structure SECURITY_ATTRIBUTES <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> nLength As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> lpSecurityDescriptor As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> bInheritHandle As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> Structure <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CreateFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (lpFileName As <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, dwDesiredAccess As Integer, dwShareMode As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpSecurityAttributes As SECURITY_ATTRIBUTES, dwCreationDisposition As Integer, dwFlagsAndAttributes As Integer, hTemplateFile As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> ReadFile Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hFile As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Buffer As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> nNumberOfBytesToRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> lpNumberOfBytesRead As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Overlapped As IntPtr) As Integer <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> CloseHandle Lib <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span> (hObject As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetClassDevs Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> ClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Enumerator As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> hwndParent As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> Flags As Integer) As IntPtr <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiDestroyDeviceInfoList Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (deviceInfoSet As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInfo Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiEnumDeviceInterfaces Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> InterfaceClassGuid As System.Guid, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> MemberIndex As UInteger, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetailBuffer Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"SetupDiGetDeviceInterfaceDetail"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailData As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As IntPtr) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> SetupDiGetDeviceInterfaceDetail Lib <span class="hljs-string"><span class="hljs-string">"setupapi.dll"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInfoSet As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceData As SP_DEVICE_INTERFACE_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInterfaceDetailData As SP_DEVICE_INTERFACE_DETAIL_DATA, <span class="hljs-keyword"><span class="hljs-keyword">ByVal</span></span> DeviceInterfaceDetailDataSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> RequiredSize As Integer, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> DeviceInfoData As SP_DEVINFO_DATA) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Sub</span></span> HidD_GetHidGuid Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> Alias <span class="hljs-string"><span class="hljs-string">"HidD_GetHidGuid"</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> hidGuid As Guid) <span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> Declare Auto <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> HidD_GetAttributes Lib <span class="hljs-string"><span class="hljs-string">"hid.dll"</span></span> (hidDeviceObject As IntPtr, <span class="hljs-keyword"><span class="hljs-keyword">ByRef</span></span> attributes As HIDD_ATTRIBUTES) As Boolean <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">ScaleReader.vb</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> ScaleReader <span class="hljs-keyword"><span class="hljs-keyword">Private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> VendorId = &amp;HEB8 <span class="hljs-comment"><span class="hljs-comment">' 0EB8 = Toledo, see http://usb-ids.gowdy.us/read/UD/ Private Const ProductId = &amp;HF000 ' F000 = PS60 ' Scale status enumeration Public Enum ScaleStatus Fault StableAtZero InMotion WeightStable UnderZero OverWeight RequiresCalibration RequiresRezeroing RequiresGEO Unknown End Enum ' Scale weighing unit Public Enum WeightUnit UnitMilligram UnitGram UnitKilogram UnitCarats UnitTaels UnitGrains UnitPennyweights UnitMetricTon UnitAvoirTon UnitTroyOunce UnitOunce UnitPound UnitUnknown End Enum ' Scale measure report Public Structure ScaleReport Public ReportId As UShort ' Scale report id Public Status As ScaleStatus ' Scale status Public Unit As WeightUnit ' Weighing unit Public Scaling As SByte ' Scaling, power of 10 Public WeightLsb As UShort ' Least-significant byte of weight value Public WeightMsb As UShort ' Most-significant byte of weight value Public ErrorCode As Integer ' Error code ' Calculates weight from LSB, MSB and scaling Public Function GetWeight() As Double GetWeight = (WeightMsb * 256 + WeightLsb) * (10 ^ Scaling) End Function End Structure Private ioHandle As IntPtr ' handle to read from device ' Opens device with desired access rights Private Function OpenDeviceIO(devicePath As String, deviceAccess As Integer) As IntPtr Dim security As NativeMethods.SECURITY_ATTRIBUTES security.lpSecurityDescriptor = IntPtr.Zero security.bInheritHandle = True security.nLength = Marshal.SizeOf(security) OpenDeviceIO = NativeMethods.CreateFile(devicePath, deviceAccess, NativeMethods.FILE_SHARE_READ + NativeMethods.FILE_SHARE_WRITE, security, NativeMethods.OPEN_EXISTING, 0, 0) End Function ' Close previously opened device Private Sub CloseDeviceIO(handle As IntPtr) NativeMethods.CloseHandle(handle) End Sub ' Disconnect from scale Public Sub Disconnect() CloseDeviceIO(ioHandle) End Sub ' Find Toledo PS60 scale and open to read weight values Public Function Connect() As Boolean Dim hidClass As Guid NativeMethods.HidD_GetHidGuid(hidClass) ' Obtain hid device class Guid to enumerate all hid devices Dim DeviceInfoSet As IntPtr Dim DeviceInfoData As NativeMethods.SP_DEVINFO_DATA Dim DeviceInterfaceData As NativeMethods.SP_DEVICE_INTERFACE_DATA Dim DeviceInterfaceDetailData As NativeMethods.SP_DEVICE_INTERFACE_DETAIL_DATA = Nothing Dim RequiredSize As Integer Dim success As Boolean DeviceInfoSet = NativeMethods.SetupDiGetClassDevs(hidClass, IntPtr.Zero, 0, NativeMethods.DIGCF_PRESENT + NativeMethods.DIGCF_DEVICEINTERFACE) ' Open hid device enumeration DeviceInterfaceData.cbSize = Marshal.SizeOf(DeviceInterfaceData) DeviceInterfaceDetailData.cbSize = 6 DeviceInfoData.cbSize = Marshal.SizeOf(DeviceInfoData) Dim deviceIndex As Integer ' Current deviec index deviceIndex = 0 Do While NativeMethods.SetupDiEnumDeviceInfo(DeviceInfoSet, deviceIndex, DeviceInfoData) ' Loop through all hid devices Dim deviceIfaceIndex As Integer ' Device interface index deviceIfaceIndex = 0 Do While NativeMethods.SetupDiEnumDeviceInterfaces(DeviceInfoSet, DeviceInfoData, hidClass, deviceIfaceIndex, DeviceInterfaceData) ' Loop through all interfaces of current device success = NativeMethods.SetupDiGetDeviceInterfaceDetailBuffer(DeviceInfoSet, DeviceInterfaceData, IntPtr.Zero, 0, RequiredSize, IntPtr.Zero) ' Obtain buffer size success = NativeMethods.SetupDiGetDeviceInterfaceDetail(DeviceInfoSet, DeviceInterfaceData, DeviceInterfaceDetailData, RequiredSize, RequiredSize, DeviceInfoData) ' Get device information using previously recieved buffer size Dim hidHandle As IntPtr hidHandle = OpenDeviceIO(DeviceInterfaceDetailData.DevicePath, NativeMethods.ACCESS_NONE) ' Open device with no access rights to get pid&amp;vid If hidHandle &lt;&gt; NativeMethods.INVALID_HANDLE_VALUE Then Dim deviceAttributes As NativeMethods.HIDD_ATTRIBUTES deviceAttributes.cbSize = Marshal.SizeOf(deviceAttributes) success = NativeMethods.HidD_GetAttributes(hidHandle, deviceAttributes) ' Read device attributes, including PID, VID and Version If success And deviceAttributes.VendorID = VendorId And deviceAttributes.ProductID = ProductId Then ' If it matches Toledo PS60 CloseDeviceIO(hidHandle) ' Close device ioHandle = OpenDeviceIO(DeviceInterfaceDetailData.DevicePath, NativeMethods.GENERIC_READ) ' And reopen with access rights to read reports NativeMethods.SetupDiDestroyDeviceInfoList(DeviceInfoSet) ' Close enumeration Connect = True Exit Function End If CloseDeviceIO(hidHandle) End If deviceIfaceIndex = deviceIfaceIndex + 1 Loop deviceIndex = deviceIndex + 1 Loop NativeMethods.SetupDiDestroyDeviceInfoList(DeviceInfoSet) ' Close enumeration Connect = False End Function ' Reads current weight from scale Public Function ReadValue() As ScaleReport Dim bytesRead As Integer Dim buffer(10) As Byte Dim bufPtr As IntPtr bufPtr = Marshal.AllocHGlobal(10) ' Allocate 10 bytes for report ReadValue = Nothing Dim res As Integer res = NativeMethods.ReadFile(ioHandle, bufPtr, 10, bytesRead, IntPtr.Zero) ' Read 10 bytes from scale If res &gt; 0 Then ' 0=Failure, any positive is success Marshal.Copy(bufPtr, buffer, 0, 10) ' Copy unmamanged buffer to managed byte array If bytesRead &lt; 6 Then ' Report must be 6 bytes or greater (for compatibility) ReadValue.Status = ScaleStatus.Fault Marshal.FreeHGlobal(bufPtr) Exit Function End If Dim rep As ScaleReport rep.ReportId = buffer(0) ' byte #0 is report id Select Case buffer(1) ' byte #1 is scale status Case &amp;H1 rep.Status = ScaleStatus.Fault Case &amp;H2 rep.Status = ScaleStatus.StableAtZero Case &amp;H3 rep.Status = ScaleStatus.InMotion Case &amp;H4 rep.Status = ScaleStatus.WeightStable Case &amp;H5 rep.Status = ScaleStatus.UnderZero Case &amp;H6 rep.Status = ScaleStatus.OverWeight Case &amp;H7 rep.Status = ScaleStatus.RequiresCalibration Case &amp;H8 rep.Status = ScaleStatus.RequiresRezeroing Case &amp;H9 rep.Status = ScaleStatus.RequiresGEO Case Else rep.Status = ScaleStatus.Unknown End Select Select Case buffer(2) ' byte #2 is scale unit Case &amp;H1 rep.Unit = WeightUnit.UnitMilligram Case &amp;H2 rep.Unit = WeightUnit.UnitGram Case &amp;H3 rep.Unit = WeightUnit.UnitKilogram Case &amp;H4 rep.Unit = WeightUnit.UnitCarats Case &amp;H5 rep.Unit = WeightUnit.UnitTaels Case &amp;H6 rep.Unit = WeightUnit.UnitGrains Case &amp;H7 rep.Unit = WeightUnit.UnitPennyweights Case &amp;H8 rep.Unit = WeightUnit.UnitMetricTon Case &amp;H9 rep.Unit = WeightUnit.UnitAvoirTon Case &amp;HA rep.Unit = WeightUnit.UnitTroyOunce Case &amp;HB rep.Unit = WeightUnit.UnitOunce Case &amp;HC rep.Unit = WeightUnit.UnitPound Case Else rep.Unit = WeightUnit.UnitUnknown End Select rep.Scaling = IIf(buffer(3) &lt; 128, buffer(3), buffer(3) - 256) ' byte #3 is scaling rep.WeightLsb = buffer(4) ' byte #4 is LSB rep.WeightMsb = buffer(5) ' byte #5 is MSB ReadValue = rep Else Dim err = Marshal.GetLastWin32Error ReadValue.Status = ScaleStatus.Fault ReadValue.ErrorCode = err End If Marshal.FreeHGlobal(bufPtr) End Function End Class</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/205462/">https://habr.com/ru/post/205462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205452/index.html">20 years DOOM</a></li>
<li><a href="../205454/index.html">Data replication. Attunity Replicate and Greenplum</a></li>
<li><a href="../205456/index.html">How to make friends with the Yandex API and AJAX captcha</a></li>
<li><a href="../205458/index.html">Installing XenServer 6.2 in Hetzner</a></li>
<li><a href="../205460/index.html">Setting up an Internet gateway for a small office CentOS, Iptables, NAT, Squid Transparent, Sarg</a></li>
<li><a href="../205464/index.html">Working with Group Policy Preferences: Interacting with Local Accounts</a></li>
<li><a href="../205466/index.html">Development of Windows 8.1 applications on XAML / –° #. Part 3. Toolbars</a></li>
<li><a href="../205472/index.html">turbofilm.tv blocked</a></li>
<li><a href="../205476/index.html">Rake using common .dll</a></li>
<li><a href="../205478/index.html">Virtual Trading: the first step in the stock market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>