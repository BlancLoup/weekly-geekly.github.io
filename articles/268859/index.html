<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The nuances of ESXi, FlexFabric, 10 Gbit and NFS bundles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to present useful information gathered during the design and implementation of a fault-tolerant virtualization environme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The nuances of ESXi, FlexFabric, 10 Gbit and NFS bundles</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to present useful information gathered during the design and implementation of a fault-tolerant virtualization environment.  Particular attention is paid to the nuances of HP Virtual Connect FlexFabric and the configuration of the VMware vSphere 5.5 hypervisor when using Ethernet 10 Gbit and NFS as a Datastore. <br><br>  <b>Network diagram</b> <br><img src="https://habrastorage.org/files/825/1aa/7fd/8251aa7fdda04b388a75284b065a66ab.jpg"><br><a name="habracut"></a><br>  <b>"Iron"</b> <br><br>  Blade-cart "HP BladeSystem c7000" with a pair of modules "HP VC FlexFabric 10/24". <br>  HP BL460c Gen8 servers with HP FlexFabric 10Gb 536FLB network card. <br>  Network switches "Cisco Nexus 5k". <br>  Storage system "NetApp FAS8020". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Channel aggregation </h2><br>  Channel aggregation is one of the main means of achieving a high resiliency of the virtual environment, so you need to use this at all levels of traffic flow.  In our case: <br><table><tbody><tr><td>  <b>ESXi</b> </td><td>  <b>Flexfabric</b> </td><td>  <b>Network</b> </td><td>  <b>Storage</b> </td></tr><tr><td>  vSphere vSwitch in ‚ÄúPort ID‚Äù mode </td><td>  Shared Uplink Set + Auto Mode (LACP) </td><td>  EtherChannel (LACP) </td><td>  lif </td></tr></tbody></table><br><h2>  Jumbo frames </h2><br>  To get the maximum benefit from 10 Gbit, it is recommended to enable Jumbo Frames at all levels: <br><table><tbody><tr><td></td><td>  <b>VMkernel port</b> </td><td>  <b>vSwitch</b> </td><td>  <b>Flexfabric</b> </td><td>  <b>Network</b> </td><td>  <b>Storage</b> </td></tr><tr><td>  <b>Value</b> </td><td>  9000 </td><td>  9000 </td><td>  9216 </td><td>  9216 </td><td>  9000 </td></tr></tbody></table><br>  The MTU value in HP Virtual Connect is ‚Äúwired‚Äù to 9216 and cannot be <a href="http://h30499.www3.hp.com/t5/HP-BladeSystem-Virtual-Connect/Discussion-on-Jumbo-frames-and-Virtual-Connect-stats/m-p/6541974/highlight/true">changed</a> . <br><br>  <a href="http://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1038827">How to install Jumbo Frames on ESXi</a> . <br><br><h2>  Cisco Discovery Protocol </h2><br>  Unfortunately, CDP is not supported by the ‚ÄúHP VC FlexFabric‚Äù modules, so there is no sense to include its support on the hypervisor. <br>  Excerpt from the documentation: ‚Äú <i>Virtual Connect does not support CDP.</i>  <i>VC does support the industry standard protocol called Link Layer Discovery Protocol (LLDP) by default.</i>  <i>LLDP is functionally equivalent to CDP, although the two protocols are not compatible.</i>  " <br><br><h2>  Flow control </h2><br>  In the matter of using the ‚ÄúFlow Control‚Äù mechanism, we decided to adhere to the recommendation of NetApp and disable it at all ‚Äúlevels‚Äù (ESXi, FlexFabric, Network, Storage). <br><br>  NetApp recommendation: ‚Äú <i>Modern network equipment and protocols handle port congestion better than those in the past.</i>  <i>NFS and iSCSI as implemented in ESXi use TCP.</i>  <i>TCP has built-in congestion management, making Ethernet flow control unnecessary.</i>  <i>Furthermore, it will send you a remote frame.</i>  <i>Although it has been recommended that it has been approved by NetApp for network access control.</i>  " <br><br>  In the configuration of the ‚ÄúHP VC FlexFabric‚Äù modules, Flow Control is enabled by default only on downlink (value ‚ÄúAuto‚Äù), and on uplink ‚Äî off is turned off. <br><br>  <i>"ON" - all ports control (if autoneg) or flowcontrol turned on (non-autoneg).</i> <i><br></i>  <i>"OFF" - all ports will support the flow control (if autoneg) or flowcontrol turned off (non-autoneg).</i> <i><br></i>  <i>‚ÄúAuto‚Äù - all uplink / stacking links will be ‚ÄúOFF‚Äù, and all server links will be ‚ÄúON‚Äù.</i> <br><br>  The command to turn off: #set advanced-networking FlowControl = off <br><br>  Interesting articles on this topic: <br>  <a href="http://h30499.www3.hp.com/t5/HP-BladeSystem-Virtual-Connect/Virtual-Connect-FlexFabric-interconnect-modules-and-Ethernet/td-p/5337889">Virtual Connect FlexFabric interconnect modules and Ethernet Flow Control</a> <br>  <a href="http://rjapproves.com/netapp-vs-vmware-flow-control-dilemma/">NETAPP vs VMWARE FLOW CONTROL DILEMMA</a> <br>  <a href="http://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D1013413">Configuring Flow Control on VMware ESXi and VMware ESX</a> <br><br><h2>  Smart link </h2><br>  Smart Link mode must be enabled for all vNet (Ethernet Network) configurations in FlexFabric.  This is necessary for the hypervisor to properly run the balancing in the virtual switch. <br><br>  Excerpt from the documentation: ‚Äú <i>HP's Virtual Connect supports a feature called smart link, if you‚Äôre uplink ports lose link.</i>  <i>This is a feature that is available on the HP GbE2, GbE2c and most ProCurve switches.</i>  <i>I called there Link State Tracking.</i>  " <br><br><h2>  Virtual switches </h2><br>  It is recommended to separate virtual machine traffic from management traffic (vMotion, Management, NFS, FT).  To increase the reliability of the virtual environment, we used a standard switch for management traffic, rather than distributed, although it has several advantages (for example, LACP support). <br><br><h2>  vSphere vSwitch Load Balancing </h2><br>  In this configuration, virtual switches recommend using load balancing mode "Route based on the originating virtual port id". <br><br>  The ‚ÄúRoute Based on IP Hash‚Äù mode ( <a href="http://h30499.www3.hp.com/hpeb/attachments/hpeb/bladescategory04/1290/1/HP%2520BladeSystem%2520Ref.%2520Architec%2520-%2520VC%2520Flex-10_%2520vSphere.pdf">NetApp recommendation</a> ) cannot be used, since it requires combining its uplink (virtual switch) to a trunk via the 802.3ad protocol, and HP VC FlexFabric does not provide such an opportunity for downlink to servers. <br><br>  The rest of the load balancing policy settings are: <br>  Network failure detection: Link status only. <br>  Notify switches: Yes. <br>  Failback: Yes. <br><br><h2>  VMkernel Port </h2><br>  For each service (vMotion, Management, NFS, FT) it is recommended to create a separate VMkernel Port.  Vmk for NFS traffic (Available Services remains empty) must be created on the same subnet as the NFS exports.  In our case: <br><table><tbody><tr><td>  <b>VMkernel port</b> </td><td>  <b>Available Services</b> </td><td>  <b>Network label</b> </td><td>  <b>VLAN ID</b> </td><td>  <b>MTU</b> </td></tr><tr><td>  vmk0 </td><td>  vmotion </td><td>  vmotion </td><td>  one </td><td>  9000 </td></tr><tr><td>  vmk1 </td><td>  Management </td><td>  Management </td><td>  2 </td><td>  9000 </td></tr><tr><td>  vmk2 </td><td>  - </td><td>  Nfs </td><td>  3 </td><td>  9000 </td></tr></tbody></table><br>  For vMotion vmkernel adapters, <a href="http://h20564.www2.hpe.com/hpsc/doc/public/display%3FdocId%3Dc02616817">HP recommends</a> setting ‚Äúfailover order‚Äù mode in Active / Standby: <br>  <i>‚ÄúTo ensure that it‚Äôs not a problem.‚Äù</i>  <i>This will ensure that all virtual connect module. ‚Äù</i> <br><br><h2>  NFS Advanced Settings </h2><br>  It is recommended to change the default values ‚Äã‚Äãof some parameters for working with NFS exports.  For each vSphere host in Advanced Settings, set the following values: <br><br>  NFS.HeartbeatFrequency = 12 <br>  NFS.HeartbeatTimeout = 5 <br>  NFS.HeartbeatMaxFailures = 10 <br>  Net.TcpipHeapSize = 32 <br>  Net.TcpipHeapMax = 512 <br>  NFS.MaxVolumes = 256 <br>  NFS.MaxQueueDepth = 64 <br><br>  Recommendations are described in the following documents: <br>  <a href="http://www.vmware.com/files/pdf/VMware_NFS_BestPractices_WP_EN.pdf">Best Practices for running VMware vSphere on Network Attached Storage</a> <br>  <a href="http://kb.vmware.com/selfservice/microsites/search.do%3Flanguage%3Den_US%26cmd%3DdisplayKC%26externalId%3D2239">NFS mounts on an ESXi / ESX host</a> <br><br><h2>  Other nuances </h2><br><ol><li>  The blade server network card must be compatible with Virtual Connect modules.  Compatibility can be checked in QuickSpecs from HP. </li><li>  It is advisable to update the firmware of the Virtual Connect modules to the latest available version, but it should be done very carefully when checking the compatibility of the FW blade servers and the recycle bin. </li><li>  Included with the Virtual Connect modules, SFP transceivers do not come, so plan ahead for the physical switching circuit, and buy the right transceivers. </li><li>  Virtual Connect allows you to guarantee and set bandwidth limits for subnets (at the level of vNet / Ethernet Network / VLAN).  This should be used, for example, to limit VLANs with ESXi Management traffic up to 1 Gbit and VLAN guarantees for NFS from 4 Gbit to 10 Gbit. </li></ol><br><h2>  Literature </h2><br>  <a href="http://www.netapp.com/us/media/tr-4068.pdf">VMware vSphere 5 on NetApp Clustered Data ONTAP</a> <br>  <a href="http://www.vmware.com/files/pdf/VMware_NFS_BestPractices_WP_EN.pdf">Best Practices for Running VMware vSphere on Network-Attached Storage (NAS)</a> <br>  <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c02616817-6.pdf">HP Virtual Connect FlexFabric Cookbook</a> <br>  <a href="http://h20628.www2.hp.com/km-ext/kmcsdirect/emr_na-c01702940-15.pdf">FC Cookbook for HP Virtual Connect</a> <br>  <a href="http://h20566.www2.hpe.com/hpsc/doc/public/display%3FdocId%3Demr_na-c01386629-13">HP Virtual Connect for the Cisco Network Administrator</a> <br>  <a href="http://h20565.www2.hp.com/hpsc/doc/public/display%3FdocId%3Demr_na-c03790895">HP Virtual Connect Manager Command Line Interface</a> <br>  <a href="http://h30499.www3.hp.com/t5/HP-BladeSystem-Virtual-Connect/bd-p/bladescategory04">HP HP BladeSystem Virtual Connect Forum</a> </div><p>Source: <a href="https://habr.com/ru/post/268859/">https://habr.com/ru/post/268859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268849/index.html">Rust hit the TIOBE index</a></li>
<li><a href="../268851/index.html">Using readable and writable images in OpenCL 2.0</a></li>
<li><a href="../268853/index.html">Office as Platform Release 7 - Manage Office 365 and SharePoint Online via PowerShell</a></li>
<li><a href="../268855/index.html">Introducing 3CX Phone System v14 SP1 with many new features.</a></li>
<li><a href="../268857/index.html">How I monitored Avito by SMS</a></li>
<li><a href="../268863/index.html">Google Cloud Endpoints in Java: A Guide. part 1</a></li>
<li><a href="../268865/index.html">How business works with IaaS</a></li>
<li><a href="../268867/index.html">New GUI for Postgresql</a></li>
<li><a href="../268871/index.html">Composer - the right way</a></li>
<li><a href="../268875/index.html">Thoughts of a cyber-criminal: what does he look for and why has he chosen your enterprise?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>