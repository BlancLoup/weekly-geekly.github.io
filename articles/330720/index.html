<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reform SQL-based approach in DAO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introductory 
 I often in projects have to deal with frameworks for working with databases. Conceptually, these frameworks can be divided into 2 large...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reform SQL-based approach in DAO</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introductory </h2><br>  I often in projects have to deal with frameworks for working with databases.  Conceptually, these frameworks can be divided into 2 large classes: <br><br><ul><li>  <b>ORM-</b> oriented </li><li>  <b>SQL-</b> oriented </li></ul><br>  Some of them are good, some are not very.  But I can say subjectively: SQL-oriented ones are inferior in the development of ORM-oriented ones.  I emphasize, in development, and not in opportunities.  Although it will not be possible to change this balance, it is quite possible to offer an unusual view of the world of SQL-oriented approach.  Who cares, welcome under the cat <br><a name="habracut"></a><br><h2>  A little review </h2><br>  Before you break, I suggest to remember, quite briefly, that <a href="https://en.wikipedia.org/wiki/List_of_object-relational_mapping_software">there is</a> .  Who in the subject, feel free to skip the review. <br><br>  And so, on the scene, representatives of the <b>ORM-</b> oriented approach: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="http://hibernate.org/">Hibernate</a> </li><li>  <a href="https://eclipse.org/eclipselink/releases/2.5.php">Eclipselink</a> </li><li>  <a href="http://www.mybatis.org/mybatis-3/dynamic-sql.html">Mybatis</a> </li><li>  <a href="https://www.jooq.org/">Jook</a> </li></ul><br>  These representatives do their job in different ways.  The latter, for example, DSL-way, offers to construct SQL queries using either the generated objects according to your database schema, or just strings.  Others <i>require the</i> description of the correspondence between java-objects and database tables.  But not the point.  All of them are united by one idea: to isolate the developer from writing SQL queries as much as possible, offering instead - ORM thinking. <br><br>  On the other hand, representatives of SQL-oriented approach gathered: <br><br><ul><li>  <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html">Spring Framework JDBC</a> </li><li>  <a href="http://www.sql2o.org/">sql2o</a> (really liked) </li><li>  <a href="http://jdbi.org/">Jdbi</a> </li><li>  <a href="https://github.com/reforms/reforms/tree/dev">RefOrms</a> </li></ul><br>  All of these solutions in one form or another are add-ons above the <b>java.sql. *</b> Package.  And so these frameworks are cooler, the more they isolate the developer from him.  However, using them, you have to think first in SQL categories, and then ORM. <br><br>  I know about the existence and the third class of frameworks: generators.  It is difficult for them to win a niche, because such solutions are usually written for a specific project and it is difficult for them to be universal.  The idea is the following: to generate the DAO-layer completely, using the knowledge of a specific project, knowledge of the database and the specifics of business requirements.  I met with such decisions twice.  It is not very usual when you have to refine the generator of the DAO layer, instead of writing SQL queries or mapping. <br><br><h2>  What's wrong? </h2><br>  I deliberately did not give judgments to this or that approach, ORM vs SQL vs Generators.  Everyone decides for himself, coupled with the available circumstances, what to choose.  But here I am ready to offer a specific alternative, both in a stylistic expression and conceptually for SQL-oriented.  But first I‚Äôll say that I don‚Äôt like the code level (performance, debug, etc. I‚Äôm dropping it) in existing solutions: <br><br><ol><li>  Certain verbosity to achieve simple things. </li><li>  Boilerplate, boilerplate, boilerplate ... and again boilerplate </li><li>  Lack of a point in the code where you can see the sql-orm or orm-sql options </li><li>  In one form or another, constructing a SQL query according to the filtering conditions </li><li>  Multiple knowledge to use the framework API - learn about +100500 entities before breaking code </li></ol><br>  Much of the above made me ask: "And what should the framework be for you to like it?" <br><br><h2>  Declarative style </h2><br>  How?  I think simple, so that he took and began to code.  But what if it is serious?  Declarative.  Yes, I am a supporter of declarative style in such things, rather than imperative.  What java comes to mind first when it comes to the declarative approach?  Yes, just 2 things: <i>annotations</i> and <i>interfaces</i> .  If these 2 substances are crossed and sent to the mainstream of the SQL-oriented solution, we get the following: <br><br><div class="spoiler">  <b class="spoiler_title">ORM</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClientState state; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Date regTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ClientState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClientState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = state; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Date </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRegTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> regTime; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRegTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date regTime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.regTime = regTime; } } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ClientState { ACTIVE(<span class="hljs-number"><span class="hljs-number">1</span></span>), BLOCKED(<span class="hljs-number"><span class="hljs-number">2</span></span>), DELETED(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state; ClientState(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = state; } <span class="hljs-meta"><span class="hljs-meta">@TargetMethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state; } <span class="hljs-meta"><span class="hljs-meta">@TargetMethod</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ClientState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClientState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values()[state - <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//    } }</span></span></code> </pre> </div></div><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClientDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@TargetQuery</span></span>(query = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, state "</span></span> + <span class="hljs-string"><span class="hljs-string">" FROM clients "</span></span> + <span class="hljs-string"><span class="hljs-string">" WHERE id = ?"</span></span>, type = QT_SELECT) <span class="hljs-function"><span class="hljs-function">Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId)</span></span></span></span>; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Nameplate</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   CREATE TABLE clients ( id bigint NOT NULL, name character varying(127) NOT NULL, state int NULL, reg_time timestamp NOT NULL, CONSTRAINT pk_clients PRIMARY KEY (id) );</span></span></code> </pre> </div></div><br>  This is a simple working example, the essence of which is to emphasize the idea of ‚Äã‚Äãa declarative style, which is reflected in the framework under consideration.  The idea itself is certainly not new, notes about a similar one I met in an IBM article somewhere in 2006, and some of the frameworks already use this idea.  But seeing such an example, I would reasonably ask a few questions: <br><br><ol><li>  And who implements the IClientDao contract and how to get access to the implementation? </li><li>  And where is mapping fields described? </li><li>  How about something more complicated?  And then these examples for 3 kopecks are already fed up. </li></ol><br>  I suggest in order to answer these questions and hike to reveal the possibilities of the framework. <br><br><h2>  Just proxy </h2><br>  <i>&gt;&gt; 1.</i>  <i>And who implements this contract and how to get access to the implementation?</i> <br><br>  The contract is implemented by the framework itself using the java.lang.reflect.Proxy tool and you do not need to implement it yourself for SQL purposes.  And to get access to the implementation is very simple, with the help of ... Yes, in other examples it is easier to show by example: <br><br><pre> <code class="java hljs">IClientDao clientDao = com.reforms.orm.OrmDao.createDao(connection, IClientDao.class); Client client = clientDao.findClient(<span class="hljs-number"><span class="hljs-number">1L</span></span>);</code> </pre><br>  Where <i>connection</i> is an object to access the database, for example, the implementation of java.sql.Connection or javax.sql.DataSource or in general your object.  <i>Client</i> is your ORM object and perhaps the only thing from the framework itself is the com.reforms.orm class.  <b>OrmDao</b> , which will cover 98% of all your needs. <br><br><h2>  Concept </h2><br>  <i>&gt;&gt; 2.</i>  <i>And where is mapping fields described?</i> <br><br>  As promised above, I‚Äôll touch on 2 things: style and concept.  To answer the second question, you need to talk about the concept.  The message is such that in order to offer something new, a radical view of the solution is needed.  What about SQL-92 parser?  When this thought first came to me, I threw it so far away that I thought I would not see her again.  But how then to make a SQL-oriented framework convenient?  Saw another add?  Or do another helper to the helper framework?  In my opinion, it is better to limit the supported set of SQL constructions - as a good compromise, and in return to get something convenient, in my opinion.  Mapping is done on the basis of the expression tree, after parsing the SQL query.  In the example above, the column names correspond with the one-to-one object ORM field names.  Of course, the framework supports mapping and more complex, but about it a bit later. <br><br><h2>  Examples </h2><br>  <i>&gt;&gt; 3. What about something more complicated?</i>  <i>And then these examples for 3 kopecks are already fed up.</i> <br><br>  But does it make any sense to bother with the SQL-92 parser, if the framework does not know how to do it, something more complicated?  But to show everything in examples without <i>volume</i> is not an easy task.  Of course, I will show, though I will omit the table declarations in SQL and parts of java-code. <br><br>  One of the few things that I never liked about SQL-based solutions is the need to construct SQL queries.  For example, when certain filtering criteria may or may not be specified.  And you probably know this piece of code, or rather its simplified version: <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// -  DAO private String makeRegTimeFilter(Date beginDate, Date endDate) { StringBuilder filter = new StringBuilder(); if (beginDate != null) { filter.append(" reg_time &gt;= ?"); } if (endDate != null) { if (filter.length() != 0) { filter.append(" AND"); } filter.append(" reg_time &lt; ?"); } return filter.length() == 0 ? null : filter.toString(); }</span></span></code> </pre><br>  And I wrote this fragment exactly as I most often meet in old projects.  And this is despite the fact that date checks will appear again when setting values ‚Äã‚Äãin PreparedStatement.  And what is our friend offered?  And it offers <i>dynamic filters</i> .  The example is easier to understand, so let's look at finding customers for a certain interval: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClientDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@TargetQuery</span></span>(query = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, state "</span></span> + <span class="hljs-string"><span class="hljs-string">" FROM clients "</span></span> + <span class="hljs-string"><span class="hljs-string">" WHERE regTime &gt;= ::begin_date AND "</span></span> + <span class="hljs-string"><span class="hljs-string">" regTime &lt; ::end_date"</span></span>, type = QT_SELECT, orm = Client.class) <span class="hljs-function"><span class="hljs-function">List&lt;Client&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findClients</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@TargetFilter(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"begin_date"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Date beginDate, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TargetFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"end_date"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Date endDate)</span></span>; }</code> </pre><br>  And the point is that if the parameter value, for example, beginDate is null, then the associated SQL filter <b>regTime&gt; = :: begin_date</b> will be cut from the final SQL query and in our case the following line will go to the database server: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, state <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> regTime &lt; ?</code> </pre> <br>  If both values ‚Äã‚Äãare null, then the WHERE clause will not be in the final query.  And note - in the code only the declaration and no logic.  In my opinion, but I really want to listen to others, this is a strong weapon and a strong side of the framework.  According to the java code I‚Äôll say that I‚Äôm not a fan of annotations myself, and a large number of them in most projects are just annoying.  Therefore, I provided for an alternative defined by him - filters by object bean properties: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  get/set  .   . public class ClientFilter { private Date beginDate; private Date endDate; } public interface IClientDao { @TargetQuery(query = "SELECT id, name, state " + " FROM clients " + " WHERE regTime &gt;= ::begin_date AND " + " regTime &lt; ::end_date", type = QT_SELECT, orm = Client.class) List&lt;Client&gt; findClients(@TargetFilter ClientFilter period); }</span></span></code> </pre><br>  It turns out quite succinctly and clearly.  Pro dynamic filters should be said separately that they support, or rather, they can be cut from subqueries and all predicates, excluding OVERLAPS and MATCH.  I have never met the last ones in SQL living expressions, but there is a mention of them in the SQL-92 specification. <br><br>  Of course, the framework also supports static, mandatory to indicate filters.  And their syntax is the same as in HQL or SpringTemplate - <i>': named parameter'</i> . <br><br>  True, there is always one problem with static filters: 'How to react to the null parameter'?  The quick answer seems to say - "Throw an exception, you will not be mistaken."  But is it always necessary?  Let's move on to the example of downloading clients with a certain status and check it out: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClientDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@TargetQuery</span></span>(query = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, state "</span></span> + <span class="hljs-string"><span class="hljs-string">" FROM clients "</span></span> + <span class="hljs-string"><span class="hljs-string">" WHERE state = :state"</span></span>, type = QT_SELECT, orm = Client.class) <span class="hljs-function"><span class="hljs-function">List&lt;Client&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findClients</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@TargetFilter(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"state"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ClientState state)</span></span>; }</code> </pre><br>  But the task is what to do if the client status in the database may be absent?  The state column allows NULL values ‚Äã‚Äãand we need to search for just such clients, non-statutory?  The concept of SQL-92 parser saves again.  It is enough to replace the filtering expression by status with <i>': state'</i> with <i>': state <b>?</b></i>  <i>'</i> as the framework engine modifies the WHERE section into the following view <i>' ... WHERE state IS NULL '</i> , if, of course, the input method is null. <br><br><h2>  About mapping </h2><br>  Filters in queries are nice, but in java solutions a lot of attention is paid to the mapping of the result of a SQL query on ORM objects and their binding and binding of the entities themselves.  This is so much, look at what the JPA specification costs.  Or, in your projects, look at shifting from ResultSet to domain objects or setting values ‚Äã‚Äãin PreparedStatement.  Bulky, is not it?  I chose the path, maybe less reliable and less elegant, but definitely - simple.  Why go far when you can arrange a mapping right in the SQL query.  This is the first thing that comes to mind? <br><br>  Let's go straight to the examples.  And here's the task, how to score the result of the query, if all the columns of the table differ from the ORM fields of the class, plus ORM has an embedded object? <br><br><div class="spoiler">  <b class="spoiler_title">ORM classes</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> clientId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String clientName; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClientState clientState; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Address address; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Date regTime; <span class="hljs-comment"><span class="hljs-comment">//   ... } enum ClientState { ACTIVE(1), BLOCKED(2), DELETED(3); private int state; ClientState(int state) { this.state = state; } @TargetMethod public int getState() { return state; } @TargetMethod public static ClientState getClientState(int state) { return values()[state - 1]; //    } } public class Address { private long addressId; private String refCity; private String refStreet; }</span></span></code> </pre></div></div><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClientDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@TargetQuery</span></span>(query = <span class="hljs-string"><span class="hljs-string">"SELECT cl.id AS client_id, "</span></span> + <span class="hljs-comment"><span class="hljs-comment">// underscore_case -&gt; camelCase  " cl.name AS clientName, " + //    camelCase " cl.state AS client_state, " + // any_type to enum   ,   enum   @TargetMethod " cl.regDate AS t#regTime, " + // t# -  ,        java.sql.Timestamp -&gt; java.util.Date " addr.addressId AS address.addressId, " + //      ,   ? " addr.city AS address.refCity, " + " addr.street AS address.refStreet " + " FROM clients cl, addresses addr" + " WHERE id = :client_id", //        type = QT_SELECT) Client findClient(long clientId); }</span></span></code> </pre><br>  This example is more realistic.  The aesthetics of mepping is definitely lame, but still this option is closer to me than endless annotations or xml files.  Yes, with the reliability of trouble, here and runtime and ORM refactoring issues of objects and not always the opportunity to take SQL and test in your favorite database client.  But I will not say that this is a hopeless situation - tests save them from runtime and refactoring.  To check the query in the database client will have to 'clean it'.  Another point: <i>What SQL query will go to the database server</i> ?  All AS sections will be cut from the request.  If, for example, for client_id it is necessary to preserve the value of cid as an alias, then you need to add a colon before this alias: cl.id AS <b>cid:</b> client_id and cid will live -&gt; cl.id AS cid in the final query. <br><br><h2>  And last, a little business logic </h2><br>  Ideal dao, when one operation - one declarative method.  And this is certainly good, but it is not always the case.  In an application, you often need to get a hybrid or composite entity, when part of the data is generated by one SQL query, another part by a second SQL query, etc.  Or make certain gluing, checking.  Perhaps this is not the essence of Dao itself, but such manipulations usually take place and are isolated, but made public in order to be called from different parts of the program.  But what should we do with interfaces, if it is nevertheless an urge to shove business logic into tao?  Unexpectedly for me and to the surprise of many developers, default methods appeared in java8.  Cool?  Yes, I know that the news is rotten, because it's 2017, but can I play on it?  And what if you cross the declarative style adopted as the basis for the development of the DAO layer and default methods for business logic?  And let's see what happens if you need to add an ORM object check to null and load data from another DAO: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClientDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     @TargetQuery(query = "SELECT id, name, state " + " FROM clients " + " WHERE id = ?", type = QT_SELECT) Client findClient(long clientId); //         IAddressDao getAddressDao(); //     default Client findClientAndCheck(long clientId, long addressId) throws Exception { Client client = findClient(clientId); if (client == null) { throw new Exception("  id '" + clientId + "'  "); } //       ,   IAddressDao addressDao = getAddressDao(); client.setAddress(addressDao.loadAddress(addressId)); return client; } }</span></span></code> </pre><br>  I don‚Äôt know if I‚Äôm right, but I want to call it <b>interface programming</b> .  Something like this.  In fact, all that I wanted to tell.  But this is definitely not all that the framework can do, in addition to the stipulated one: sampling a limited number of columns, managing schemes, pagination (not for all is true), manipulating data ordering, reports, updating, inserting and deleting. <br><br><h2>  Conclusion </h2><br>  I don‚Äôt know, dear reader, whether I managed to bring something new into this filled world of SQL frameworks or not, to judge you.  But I tried and was pleased with what I tried.  I look forward to a critical look at the proposed approach and ideas, if any.  The solution is available on the githaba, the link to which is already indicated in the chapter <b>A little review</b> in the list of SQL-oriented frameworks with the last line.  Good luck. <br><br><h2>  Editorial staff </h2><br>  N1.  Added the type of the Client.class object to the @TargetQuery annotation for methods that return lists. </div><p>Source: <a href="https://habr.com/ru/post/330720/">https://habr.com/ru/post/330720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330708/index.html">You are not google</a></li>
<li><a href="../330710/index.html">Copier RFID tags standard EM-Marin</a></li>
<li><a href="../330712/index.html">NNCP: online treatment and censorship of the store-and-forward method</a></li>
<li><a href="../330714/index.html">‚ÄúCloser to the people‚Äù: how to make IaaS more accessible</a></li>
<li><a href="../330716/index.html">‚ÄúThe biggest competitor is those who do everything themselves‚Äù - Petr Zaitsev about the creation and development of the Percona company</a></li>
<li><a href="../330722/index.html">Preparing git reset correctly</a></li>
<li><a href="../330724/index.html">Turing Completeness Generic Java Types</a></li>
<li><a href="../330726/index.html">How to scale bitcoin blockchain</a></li>
<li><a href="../330728/index.html">The digest of interesting materials for the mobile developer # 207 (June 05-12)</a></li>
<li><a href="../330730/index.html">Win32 / Industroyer: A New Threat to Industrial Control Systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>