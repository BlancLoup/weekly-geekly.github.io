<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running service workers using systemd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the release of Ubuntu 16.04 (new LTS release), systemd became a reality of all major Linux distributions used on servers. This means that you ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Running service workers using systemd</h1><div class="post__text post__text-html js-mediator-article">  After the release of Ubuntu 16.04 (new LTS release), systemd became a reality of all major Linux distributions used on servers.  This means that you can pledge to systemd advanced features without risking leaving some users of the application "overboard". <br><br>  This post is about how to implement a mnogovdochnoe application using systemd. <br><br>  Abstract: Using service templates and target'ov to run several service instances (implementation of "workers").  PartOf dependency.  A little about the [install] section of units. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Introduction </h1><br>  Many programming languages ‚Äã‚Äãwith poor or no multithreading (Python, Ruby, PHP, quite often C / C ++) use the concept of "worker".  Instead of building complex relationships between threads within an application, they launch several single-threaded copies of the application, each of which takes on a piece of workload.  Thanks to the <a href="https://lwn.net/Articles/542629/">SO_REUSEPORT option,</a> there is even the possibility to listen ‚Äútogether‚Äù on the same port, which covers most of the tasks for which there is a need for workers (in fact, normal server applications that implement the API or serve the website). <br><br>  But such an approach requires the presence of a ‚Äúsupervisor‚Äù who is responsible for launching copies, monitors their state, handles errors, completes with all kinds of stop / reload, etc.  With seeming trivialities, this is a completely non-trivial task, full of nuances (for example, if one of the workers got into TASK_UNINTERRUPTIBLE or got SIGSTOP, then problems may arise when the restart of a not very well written parent). <br><br>  There is a launch option without a supervisor, but in this case the reload / restart task is passed on to the administrator.  With the ‚Äúone process per core‚Äù model, restarting the service on a 24-core server becomes a candidate for automation, which in turn requires processing all the same SIGSTOPs and other complex nuances. <br><br>  One solution to this problem is to use systemd service templates along with a dependency on a common target. <br><a name="habracut"></a><br><h1>  Theory </h1><br><h2>  Templates </h2><br>  systemd supports ‚Äútemplates‚Äù for running services.  These templates take a parameter, which can then be inserted anywhere in the command line arguments (man systemd.service).  The parameter is passed through the '@' symbol in the service name.  The part after the '@' (but before the dot) is called the 'instance name', encoded by% i or% I.  A complete list of options is <a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">www.freedesktop.org/software/systemd/man/systemd.unit.html#Specifiers</a> .  The presence of '@' in the service name (before the dot) indicates that this is a pattern. <br><br>  Let's try to write the simplest template: <br><br>  /etc/systemd/system/foobar-worker@.service <br><pre> [Unit]
 Description = Foobar number% I
 [Service]
 Type = simple
 ExecStart = / bin / sleep 3600% I
</pre><br><br>  And run some of these: <br><br><pre> systemctl start foobar-worker @ 1
 systemctl start foobar-worker @ 2
 systemctl start foobar-worker @ 300
</pre><br><br>  We look: <br><pre> ps aux | grep sleep
 root 13313 0.0 0.0 8516 748?  Ss 17:29 0:00 / bin / sleep 3600 1
 root 13317 0.0 0.0 8516 804?  Ss 17:29 0:00 / bin / sleep 3600 2
 root 13321 0.0 0.0 8516 764?  Ss 17:29 0:00 / bin / sleep 3600 300
</pre><br><br>  Now we want to somehow run all of them in a general way.  To do this, there are target'y <br><h2>  Targets </h2><br>  Target is a systemd unit that does nothing, but can be used as an element of dependencies (target may depend on several services, or services may depend on the target, which also depends on the services). <br><br>  target'y have the extension .target. <br><br>  Let's write our simplest target: <br>  vim /etc/systemd/system/foobar.target <br><pre> [Unit]
 Wants=foobar-worker@1.service foobar-worker@2.service
 Wants=foobar-worker@300.service
</pre><br>  (attention to .service, it is necessary!) <br>  About 'Wants' we'll talk a little lower. <br><br>  Now we can run all three foobar-workers at the same time: <br>  systemctl start foobar.target <br>  (attention to the target - in the case of .service it can be omitted, in the case of .target - no). <br><br>  In the list of processes appeared three sleep'a.  Unfortunately, if we make systemctl stop foobar.target, they will not disappear, i.e.  they are a little similar to "workers".  We need to somehow combine the target and the workers into a single whole.  For this we will use dependencies. <br><h2>  Dependencies </h2><br>  Systemd provides an extensive set of dependencies, allowing you to describe exactly what we want.  We are from this list interested in 'PartOf'.  Before that, we used wants. <br>  Let's compare their behavior: <br>  Wants (which we used) - the mentioned service tries to start if the main unit starts.  If the mentioned service has dropped or cannot start, it does not affect the main service.  If the main service is shut down / restarted, then the services mentioned in the dependencies remain unaffected. <br>  PartOf - If the above is turned off / restarted, the main service also turns off / restarts. <br><br>  Just what we need. <br><br>  Add the dependency to the description of the worker: <br><br><pre> &lt;pre&gt;
 [Unit]
 Description = Foobar number% I
 PartOf = foobar.target
 [Service]
 Type = simple
 ExecStart = / bin / sleep 3600% I
</pre><br><br>  Everything.  If we make systemd stop foobar.target, then all our workers will stop. <br><br><h2>  Install dependencies </h2><br>  Another interesting systemd feature is install-dependencies.  In sysv-init, it was possible to enable / disable services, but there it was very difficult to explain exactly how to enable.  What runlevels?  What dependencies? <br><br>  In systemd, everything is simple.  When we use the 'enable' command, the service is ‚Äúadded‚Äù (via the slice mechanism) depending on what we specified in the [install] section.  For our convenience, there is a WantedBy dependency, which is inverse to Wanted. <br><br>  There are a bunch of standard targets that we can cling to.  Here are some of them (all - man systemd.special): <br>  * multi-user.target (standard for ‚Äúmust start‚Äù, equivalent to the final runlevel for sysv-init). <br>  * default.target - multi-user alias <br>  * graphical.target - the moment of launching X's <br><br>  Let's hook on to multi-user.target. <br><br>  New foobar.target content: <br><pre> [Unit]
 Wants=foobar-worker@1.service foobar-worker@2.service
 Wants=foobar-worker@300.service
 [install]
 WantedBy = multi-user.target
</pre><br><br>  Now, if we do it enable: <br><pre> # systemctl enable foobar.target
 Created symlink /etc/systemd/system/multi-user.target.wants/foobar.target ‚Üí /etc/systemd/system/foobar.target.
</pre><br><br>  Everything, our service, made from several workers, is ready to start / restart as a whole, plus it will be launched at the start of our computer / server. </div><p>Source: <a href="https://habr.com/ru/post/161011/">https://habr.com/ru/post/161011/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161001/index.html">Humidifier: buy or make? Difficulties of choice</a></li>
<li><a href="../161003/index.html">Give a piece of code for Christmas</a></li>
<li><a href="../161005/index.html">HOLO - The Music Amalgamation System</a></li>
<li><a href="../161007/index.html">Google accused of plagiarism of the game Ingress</a></li>
<li><a href="../161009/index.html">Git Rebase Usage Guidelines</a></li>
<li><a href="../161013/index.html">Logic - weekly selection of gaming and IT industry news ‚Ññ3</a></li>
<li><a href="../161017/index.html">Mobile operators of Spain have launched Joyn for Android: is the industry trying to return Whatsapp and Viber users?</a></li>
<li><a href="../161021/index.html">Bluetooth sticker helps to find keys, backpack or remote control</a></li>
<li><a href="../161025/index.html">BitTorrent intends to become a distributor of licensed content.</a></li>
<li><a href="../161027/index.html">Getting the image of the right size without OutOfMemoryError + auto-rotate according to EXIF ‚Äã‚Äãorientation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>