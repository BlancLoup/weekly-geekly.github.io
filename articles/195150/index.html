<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Debian: create packages for a narrow range of systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, I will talk about a small crutch method that I used to create deb-packages that could be installed only on a specific list of servers. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Debian: create packages for a narrow range of systems</h1><div class="post__text post__text-html js-mediator-article">  In this post, I will talk about a small <s>crutch</s> method that I used to create deb-packages that could be installed only on a specific list of servers.  The solution allowed storing these packages in the central repository along with all other assemblies, without fear of leakage of the data contained in them. <br><br>  In order not to rip out pieces of code from the existing build system, I decided to design the post as a separate small HOWTO, within which the build from scratch of an abstract package containing encrypted data will be considered.  A typical use-case, in addition to the corporate distribution of configs, for example, is the ability to quickly and securely set your favorite aliases / configs to a new system from a publicly available package at deb: //example.com/myrepo. <br><br>  In other words, a post on how openssl can be used in postinst. <br><a name="habracut"></a><br><h5>  Formulation of the problem </h5><br>  Imagine a hypothetical package foopkg, which installs three files into the system: <br><ul><li>  <i>/opt/foopkg/clear.text</i> : unprotected text </li><li>  <i>/opt/foopkg/sensitive.config</i> : a config with two parameters, one of which is secret </li><li>  <i>/ opt / foopkg / topsecret</i> : secret answer file for Main Question </li></ul><br>  Suppose it is distributed as foopkg.deb, which is available in the internal repository, and can be installed on any server through <i>apt-get install foopkg</i> .  Suppose we are lazy (that is), and we want, on the one hand, to keep everything in the repository and do only <i>aptitude update &amp;&amp; aptitude safe-upgrade</i> , and then do nothing to rule.  On the other hand, suppose we are a little paranoid (that is), and we don‚Äôt want our secret settings / configs to be set apart from us.  Of course, we also know about puppet, but why do we need to open a separate channel to systems, when everything is automatically (but this is a topic for a separate cycle of posts) going in the form we need? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Decision </h5><br><ul><li>  Encrypt files (or pieces of files) before building the package. </li><li>  We collect package </li><li>  ??? </li><li>  PROFIT </li></ul><br>  Leaving the package signing issues outside of this HOWTO, we‚Äôll use equivs to build packages. <br><br>  Prepare the build environment: <br><pre><code class="bash hljs">mkdir -p foobuild/root_dir/opt/foopkg &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> foobuild touch {clear.txt,sensitive.config,topsecret} <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Package: foopkg'</span></span> &gt; control <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Pre-Depends: openssl'</span></span> &gt;&gt; control <span class="hljs-comment"><span class="hljs-comment"># minimal control file, see man equivs-control echo -n 'ThisIsOurDeploymentMegaPassphrase' &gt; pass</span></span></code> </pre> <br><br>  The easiest option is to encrypt the entire file: <br><pre> <code class="bash hljs">openssl aes-256-cbc -e -kfile ./pass -a -A -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$infile</span></span> -out <span class="hljs-variable"><span class="hljs-variable">$outfile</span></span></code> </pre><br>  A little subtlety in the <b>-A</b> flag: with it, the encrypted output does not break into blocks of 64 characters each, but goes in one line.  This makes the decryption process in postinst, having only #! / Bin / dash, somewhat easier. <br><br>  But the whole file is sometimes not interesting to encrypt.  Ok, so we encrypt the substrings.  To do this, we first define the markers by which the encryption boundaries will be determined.  For simplicity, I used markers of the form '___ encrypt {' and '} ___', but YMMV, any marker that uniquely breaks a string contained in a file into substrings will do. <br><br>  Accordingly, test files, already ready for encryption, look like this: <br><br>  clear.txt: <pre> <code class="bash hljs">This is clear text, free to view, nothing special.</code> </pre><br>  sensitive.config: <pre> <code class="bash hljs">clear_param=foo secret_param=___encrypt{bar}___</code> </pre><br>  topsecret: <pre> <code class="bash hljs">___encrypt{this is multiline and 42}___</code> </pre><br><br>  And the encryption procedure itself, for example, like this: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import re import subprocess pass_file='./pass' def _encrypt(string): encre = re.compile('___encrypt{(.*?)}___', re.S) # non-greedy enc_string = string for el in encre.findall(string): # use openssl for encryption pipe = subprocess.Popen( ['openssl', 'aes-256-cbc', '-e', '-kfile', pass_file, '-a', '-A'], stdout = subprocess.PIPE, stdin = subprocess.PIPE, stderr = subprocess.PIPE, ) enc_el = pipe.communicate(input='%s' %el)[0] # Note: -A # add decryption markers enc_string = enc_string.replace('___encrypt{%s}___'%el, '___encrypted{%s}___'%enc_el) return enc_string # just for wrapper import sys print _encrypt( open(sys.argv[1], 'r').read() )</span></span></code> </pre><br>  I did it on python, because it is clearer and faster (working with strings in sh is harder than adding or extracting a <i>fixed</i> substring - only for strong-willed and stubborn men).  The algorithm is the simplest: we read the file into a string, look for (not greedily, so as not to capture too much) all substrings by start and end markers, encrypt (calling openssl for simplicity), and paste it back, replacing the start marker with a marker that the decoder understands. <br>  The last two lines are added so that you can go through the list of files with a simple script that will prepare the encrypted files and add them to the list for inclusion in the package: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -n <span class="hljs-string"><span class="hljs-string">"Files: "</span></span> &gt;&gt; control <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> clear.txt sensitive.config topsecret ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ./encrypt.py <span class="hljs-variable"><span class="hljs-variable">$file</span></span> &gt; root_dir/opt/foopkg/<span class="hljs-variable"><span class="hljs-variable">$file</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">" root_dir/opt/foopkg/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$file</span></span></span><span class="hljs-string"> /opt/foopkg"</span></span> &gt;&gt; control <span class="hljs-comment"><span class="hljs-comment">#note space! done</span></span></code> </pre><br>  Spaces at the beginning of lines are important not only in python, but also in the control files of deb-packages, yes, yes. <br><br>  And finally, the final part, decryption on the client side, which will install this package.  To do this, create a <i>postinst</i> file containing: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh -e set -e PKG=foopkg ELIST="/opt/foopkg/topsecret /opt/foopkg/sensitive.config" warning() { echo "*************************************************" echo "*** WARNING! This is a protected package, ***" echo "*** please contact the maintainer, blah blah. ***" echo "*************************************************" } decrypt() { file="${1}" keyfile="${2}" for line in `grep -o -z -P '___encrypted{(.*?)}___' "${file}"`; do l=`echo $line | sed 's/___encrypted{\(.*\)}___/\1/'` d=`echo $l | openssl aes-256-cbc -d -kfile ${keyfile} -a -A` sed -i.encbackup "s@___encrypted{${l}}___@`echo "${d}"|awk '{printf("%s\\\\n", $0);}'|sed -e 's/\\\n$//'`@g" "${file}" done } # common key source PASSFILE='/root/deployment-password' if [ "$1" = configure ]; then # decrypt all encrypted stuff if [ ! -f ${PASSFILE} ]; then warning exit 1 fi for file in ${ELIST}; do decrypt "${file}" "${PASSFILE}" done fi #DEBHELPER# exit 0</span></span></code> </pre><br><br>  Here, too, everything is simple.  At the stage of package creation, we already know which files are encrypted and which ones are not - we add them to the script, making life easier for him.  The decryption algorithm is similar: looking for all the lines by the marker, for each (remember the <b>-A</b> key? Here, everything would be harder without it) pull out the cipher and feed openssl, then change the line breaks to their presentation ( <i>\ n</i> ) so that sed does not swear , we do the replacement, and restore (with the addition to the end of the file including) line breaks.  Unfortunately, we can no longer use python here - the design was also designed for minimal installations where there is no python or not yet (netinstall, for example).  I did not disclose the decryption code to the page, I apologize if it seems unreadable to someone. <br>  Creating a backup file is optional and not always useful, but in this case I added it to illustrate the decryption moment below. <br><br>  Add postinst to control: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"File: postinst 755"</span></span> &gt;&gt; control <span class="hljs-comment"><span class="hljs-comment"># inline postinst file header cat postinst | sed 's/^$/./;s/^/ /;' &gt;&gt; control # inline postinst file body</span></span></code> </pre><br><br>  Sed in this case performs two functions: <br><ol><li>  <b>s /^$/./;</b>  : replacing empty lines with dots, so that the control file can parse correctly, and </li><li>  <b>s / ^ / /;</b>  : add to space at the beginning of each line for the same reason. </li></ol><br><br>  We <i>build the</i> package with the <i>equivs-build control command</i> , we get our <i>foopkg_1.0_all.deb</i> in the working directory (finally, yes?). <br><br>  We are trying to install (of course, using your favorite method of increasing privileges to root): <br><pre> <code class="hljs markdown">dpkg -i foopkg<span class="hljs-emphasis"><span class="hljs-emphasis">_1.0_</span></span>all.deb Selecting previously unselected package foopkg. (Reading database ... 32032154537392375672 files and directories currently installed.) Unpacking foopkg (from .../foopkg/foopkg<span class="hljs-emphasis"><span class="hljs-emphasis">_1.0_</span></span>all.deb) ... Setting up foopkg (1.0) ... <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** **</span></span><span class="hljs-bullet"><span class="hljs-bullet">* WARNING! This is a protected package, *</span></span><span class="hljs-strong"><span class="hljs-strong">** **</span></span><span class="hljs-bullet"><span class="hljs-bullet">* please contact the maintainer, blah blah. *</span></span><span class="hljs-strong"><span class="hljs-strong">** **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">** dpkg: error processing foopkg (--install): subprocess installed post-installation script returned error exit status 1 Errors were encountered while processing: foopkg grep '' /opt/foopkg/* # package now in unconfigured state, lets see what installed /opt/foopkg/clear.txt:This is clear text, free to view, nothing special. /opt/foopkg/clear.txt: /opt/foopkg/sensitive.config:clear_param=foo /opt/foopkg/sensitive.config:secret_param=__</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_encrypted{U2FsdGVkX19P9SiUFkMBPmoe9JKkngTi24rcwWCJ9gs=}_</span></span><span class="hljs-strong"><span class="hljs-strong">__ /opt/foopkg/sensitive.config: /opt/foopkg/topsecret:__</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_encrypted{U2FsdGVkX18wjp/ArVbp5v7yHazykiX3C2VDM9xavGrECXduajGmSmTipNpSRhZ5}_</span></span><span class="hljs-strong"><span class="hljs-strong">__ /opt/foopkg/topsecret: echo -n 'ThisIsOurDeploymentMegaPassphrase' &gt; /root/deployment-password # ok, lets enable decryption dpkg --configure -a # retry install Setting up foopkg (1.0) ... grep '' /opt/foopkg/* # lets see again -- yep, backups and decrypted files are in place. /opt/foopkg/clear.txt:This is clear text, free to view, nothing special. /opt/foopkg/clear.txt: /opt/foopkg/sensitive.config:clear_param=foo /opt/foopkg/sensitive.config:secret_param=bar /opt/foopkg/sensitive.config: /opt/foopkg/sensitive.config.encbackup:clear_param=foo /opt/foopkg/sensitive.config.encbackup:secret_param=__</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_encrypted{U2FsdGVkX19P9SiUFkMBPmoe9JKkngTi24rcwWCJ9gs=}_</span></span><span class="hljs-strong"><span class="hljs-strong">__ /opt/foopkg/sensitive.config.encbackup: /opt/foopkg/topsecret:this /opt/foopkg/topsecret:is /opt/foopkg/topsecret:multiline /opt/foopkg/topsecret:and /opt/foopkg/topsecret:42 /opt/foopkg/topsecret: /opt/foopkg/topsecret.encbackup:__</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_encrypted{U2FsdGVkX18wjp/ArVbp5v7yHazykiX3C2VDM9xavGrECXduajGmSmTipNpSRhZ5}_</span></span>__ /opt/foopkg/topsecret.encbackup:</code> </pre><br><br>  Now we can distribute our package in torrents and upload it to file sharing sites without fear that its contents will be available where it was not intended (of course, with a sufficiently strong password). <br><br><h5>  Potential benefits and applications </h5><br><ul><li>  You can consider this technique as an example of practical implementation - at one time Google did not give the desired results; </li><li>  IANAC (I'm not a cryptographer), I have no reason not to trust openssl.  If someone specifies why such a method may not work as intended - I will be very grateful; </li><li>  not supposed to be used on giant files, of course; </li><li>  I personally use this method to distribute configs and primary keys for setting up IPSec on machines of not-so-tech-savvy relatives / acquaintances; </li><li>  if it is important to someone, then porting to rpm-based should not cause problems; </li><li>  I did not include encryption with different keys for different clients, I did not include the package signature and the repository setup, I tried to shorten the post. </li></ul><br><br>  Thanks to everyone who read to the end, I hope it will come in handy.  Everything in the public domain, of course. </div><p>Source: <a href="https://habr.com/ru/post/195150/">https://habr.com/ru/post/195150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195138/index.html">C ++ test case, sorting functor</a></li>
<li><a href="../195140/index.html">Adding Admob to Unity3d and withdrawing money from PayPal to a bank account in Russia</a></li>
<li><a href="../195142/index.html">Random Cat Generator in 8 Steps</a></li>
<li><a href="../195146/index.html">Evaluation of linear regression results</a></li>
<li><a href="../195148/index.html">GCC and Variable-Length Arrays</a></li>
<li><a href="../195152/index.html">Linux pipes tips & tricks</a></li>
<li><a href="../195154/index.html">Primitive game design. Turn-based card game development</a></li>
<li><a href="../195158/index.html">Pirates vs. copyright holders: insider view</a></li>
<li><a href="../195160/index.html">Document generation based on ODT templates. ODT to PDF</a></li>
<li><a href="../195164/index.html">Russian Code Cup 2013: parse the tasks of the final</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>