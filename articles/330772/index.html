<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Apache step-by-step configuration with the choice of versions of php + Nginx as reverse proxy (with mod_pagespeed) on ubuntu 16.04</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are a lot of articles on server setup, Apache, Nginx, etc. settings on the Internet. This article will set up a simple shared hosting. All opera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Apache step-by-step configuration with the choice of versions of php + Nginx as reverse proxy (with mod_pagespeed) on ubuntu 16.04</h1><div class="post__text post__text-html js-mediator-article">  There are a lot of articles on server setup, Apache, Nginx, etc. settings on the Internet.  This article will set up a simple shared hosting.  All operations are performed through the console. <br><br>  The following tasks will be solved and described in the post: <br><br>  1. Install Apache + PHP <br>  2. Ability to select PHP versions <br>  3. Ability to work sites from different users, with restrictions on reading directories of other sites. <br>  4. Installing Nginx with google pagespeed module <br>  5. Configuring Nginx as a reverse proxy 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All stages will contain descriptions and explanations.  The post itself was written more for itself, so as not to lose the order of configuration, but it will be very useful for beginners who are beginning to understand the administration of the server.  Ubuntu 16.0.4 with SSH only is installed as a server. <br><a name="habracut"></a><br>  <b>STAGE 1 (Install Apache + PHP)</b> <br><br>  Run the shell with root rights: <br><br><pre><code class="bash hljs">sudo -i</code> </pre> <br>  Install apache: <br><br><pre> <code class="bash hljs">apt install -y apache2</code> </pre><br>  Key <pre> <code class="bash hljs"> -y</code> </pre>  it is necessary so that during the installation process, it automatically answers all questions positively.  For example, if you run: <br><br><pre> <code class="bash hljs"> apt install apache2</code> </pre> <br>  then during the installation process we will be asked if we really want to install. <br><br>  Install php (as mod_php) <br><br><pre> <code class="bash hljs"> apt install -y php libapache2-mod-php</code> </pre> <br>  At this stage, we will install php version 7 as an apache module. <br><br>  <b>STAGE 2 (Ability to select PHP versions)</b> <br><br>  At the first stage, we installed the Apache + PHP server, and PHP works like an Apache module for us.  There are several modes of PHP detailed information can be found under the link <a href="http://xandeadx.ru/blog/php/866">"CGI, FastCGI, PHP-FPM and mod_php in brief"</a> . <br><br>  If you are too lazy to read, I will explain it easier: <br><br>  1. mod_php - Apache itself runs a php script. <br><br>  Pros: works quickly, requires a minimum of settings and knowledge <br>  Minuses: scripts run from apache user (usually www-data) <br><br>  2. CGI / FastCGI - Apache Server runs the php-cgi interpreter application script, which in turn executes the php script <br><br>  Pros: scripts are executed from an arbitrary user, can be used in conjunction with other applications (Nginx + PHP), PHP configuration can be made individual <br>  Cons: speed, additional setting <br><br>  3.PHP-FPM is a modernized fast-cgi server that constantly keeps pool processes ready for work. <br><br>  Pros: speed, scripts run from an arbitrary user, can be used in conjunction with other applications (Nginx + PHP-FPM is the most common implementation) <br>  Cons: additional configuration, takes the port, for each user opens its own port. <br><br>  We will focus on CGI / FastCGI.  In fact, many may be afraid that it is the slowest, but on most shared hosts, this is the mode of operation (ispmanager uses this mode of operation).  We will need to compile from source the php versions we need. <br><br>  <i>2.1 Building php from source</i> <br><br>  Update the repository: <br><br><pre> <code class="bash hljs">apt update</code> </pre> <br>  Install the necessary packages for the assembly: <br><br><pre> <code class="bash hljs">apt install -y make \ git autoconf \ lynx \ wget \ build-essential \ libxml2-dev \ libssl-dev \ libbz2-dev \ libcurl4-openssl-dev \ libpng12-dev \ libfreetype6-dev \ libxpm-dev \ libmcrypt-dev \ libmhash-dev \ libmysqlclient-dev \ libjpeg62-dev \ freetds-dev \ libjson-c-dev \ re2c \ zlib1g-dev \ libpcre3 \ libpcre3-dev \ unzip \ libxslt1-dev</code> </pre> <br>  The <i>\</i> character is used as a line break for readability. <br><br>  Create folders for php: <br><br><pre> <code class="bash hljs">mkdir -p /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/php mkdir -p /opt/php/</code> </pre><br>  Go to the directory in which the source php will be stored <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/php</code> </pre><br>  Download the necessary version of php and unpack it: <br><br><pre> <code class="bash hljs">wget -c http://php.net/get/php-5.6.18.tar.bz2/from/this/mirror -O php-5.6.18.tar.bz2 tar xvjf php-5.6.18.tar.bz2</code> </pre><br>  In the last command, we downloaded the link <a href="http://php.net/get/php-5.6.18.tar.bz2/from/this/mirror">php-5.6.18</a> and saved it as php-5.6.18.tar.bz2 <br>  Then unpacked the archive. <br><br>  Go to the directory downloaded and unpacked php <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/php/php-5.6.18</code> </pre><br>  Configuring php <br><br><pre> <code class="bash hljs">./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-cli \ --prefix=/opt/php/php-5.6.18 \ --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-rpath \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-calendar \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-discard-path \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-fastcgi \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-force-cgi-redirect \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-fpm \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-ftp \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-gd-native-ttf \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-inline-optimization \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-mbregex \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-mbstring \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-pcntl \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-soap \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-sockets \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-sysvsem \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-sysvshm \ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-zip \ --with-bz2 \ --with-curl \ --with-curl \ --with-freetype-dir \ --with-gd \ --with-gd \ --with-gettext \ --with-jpeg-dir \ --with-jpeg-dir=/usr/lib/ \ --with-libdir=/lib/x86_64-linux-gnu \ --with-libxml-dir=/usr \ --with-mcrypt \ --with-mhash \ --with-mysql \ --with-mysql \ --with-mysqli \ --with-mysqli \ --with-openssl \ --with-pcre-regex \ --with-pdo-mysql \ --with-png-dir=/usr \ --with-zlib \ --with-zlib-dir</code> </pre><br>  It is worth paying attention to the line <i>--prefix = / opt / php / php-5.6.18</i> .  It is in this directory that the project will be compiled.  You can also add or remove the necessary module and php components.  But the configuration must be - <i>enable-fastcgi</i> and <i>--enable-force-cgi-redirect</i> .  After configuration we collect php <br><br><pre> <code class="bash hljs">make make install</code> </pre><br>  The assembly process is unusually long, so do not worry about it.  Upon completion of the assembly, you can check with the command: <br><br><pre> <code class="bash hljs">/opt/php/php-5.6.18/bin/php -v</code> </pre><br>  The result will be something like: <br><br>  <i>PHP 5.6.18 (cli) (built: Jun 8 2017 15:59:20)</i> <i><br></i>  <i>Copyright ¬© 1997-2016 The PHP Group</i> <i><br></i>  <i>Zend Engine v2.6.0, Copyright ¬© 1998-2016 Zend Technologies</i> <br><br>  <i>2.2 Configuring Apache</i> <br><br>  Next, we need Apache to invoke the php script through the fastcgi mode.  Install and activate mod_fcgi <br><br><pre> <code class="bash hljs">apt install libapache2-mod-fcgid a2enmod cgi fcgid actions</code> </pre><br>  restart the apache service <br><br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>  <i>2.3 Creating a CGI Script</i> <br><br>  Create a wrapper for running PHP-FastCGI <br><br><pre> <code class="bash hljs">mkdir -p /opt/php/php-5.6.18/fcgi-bin</code> </pre><br>  In this folder, create a script called <i>php</i> with the following contents <br>  <code>#!/opt/php/php-5.6.18/bin/php-cgi</code> .  I personally use the nano editor. <br><br><pre> <code class="bash hljs">nano /opt/php/php-5.6.18/fcgi-bin/php</code> </pre><br>  Insert the code, exit CTRL + X and confirm the changes. <br><br>  Making the file executable: <br><br><pre> <code class="bash hljs">chmod +x /opt/php/php-5.6.18/fcgi-bin/php</code> </pre><br>  In the same directory create a file php.ini () you can copy <i>/opt/source/php/php-5.6.18/php.ini-production</i> . <br><br>  <i>2.4 Setting up a host for Apache</i> <br><br>  The example will show the default virtual host setting: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:80&gt;</span></span> <span class="hljs-attribute"><span class="hljs-attribute">ServerAdmin</span></span> webmaster@localhost DocumentRoot /var/www/html &lt;IfModule mod_fcgid.c&gt; IPCCommTimeout 7200 FcgidConnectTimeout 320 MaxRequestLen 25728640 FcgidMaxRequestsPerProcess 0 FcgidBusyTimeout 3600 FcgidOutputBufferSize 0 &lt;/IfModule&gt; &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.ph(p[3-5]?|tml)$"</span></span>&gt; SetHandler fcgid-script FCGIWrapper /opt/php/php-5.6.18/fcgi-bin/php &lt;/FilesMatch&gt; ErrorLog /var/www/html/error.log CustomLog /var/www/html/access.log combined &lt;/VirtualHost&gt; &lt;Directory /var/www/html&gt; Options +Includes +ExecCGI &lt;/Directory&gt;</code> </pre><br>  Restart Apache settings: <br><br><pre> <code class="bash hljs">service apache2 reload</code> </pre><br>  <b>STAGE 3 (Ability to work sites from different users, with restrictions on reading directories of other sites.)</b> <br><br>  To differentiate user rights, Apache has 2 different suEXEC and ITK modules. <br><br>  Consider how each of them works: <br><br>  ITK - When a request arrives, apache creates a handler process that inherits the rights of the root process, but after checking the context, it changes its rights to the specified user. <br><br>  suEXEC -When a request is received, apache runs CGI and similar proprietary or third-party scripts / programs within the domain‚Äôs web folder on behalf of the specified user. <br><br>  suEXEC in our version is preferable because of the particular architecture of the work.  Install suEXEC <br><br><pre> <code class="bash hljs">apt install apache2-suexec-custom a2enmod suexec</code> </pre><br><br>  It is important that for the proper operation of suexec it is necessary to correctly set the rights to directories. <br>  How to locate directories you have to decide for yourself, an example is given in the example, and it is not optimal. <br><br>  The folder hierarchy is as follows: <br><br> <code>|--/var/www/ -  ,  751  root <br> |----/php-bin -      php <br> |------/php-5.6.18 -      php-5.6.18 <br> |--------php -    php-5.6.18 <br> |--------php.ini -    <br> |--------php.ini -    <br> |----/apache-cert -     apache <br></code> <br>  Create folders for the user: <br><br><pre> <code class="bash hljs">mkdir -p /var/www/users/admin mkdir -p /var/www/users/admin/domain.ru mkdir -p /var/www/users/admin/apache-log mkdir -p /var/www/users/admin/php-bin mkdir -p /var/www/users/admin/temp mkdir -p /var/www/users/admin/temp/php-session</code> </pre><br>  Copy the settings files for php: <br><br><pre> <code class="bash hljs">cp /opt/php/php-5.6.18/fcgi-bin/php /var/www/users/admin/php-bin/php cp /opt/php/php-5.6.18/fcgi-bin/php.ini /var/www/users/admin/php-bin/php.ini</code> </pre><br>  Create a user (it is important to remember that all users in the admin group have access to run programs from sudo, so when you select admin, he will automatically have rights to execute sudo. In this example, this is not critical, but you should remember this when creating a user) . <br><br><pre> <code class="bash hljs">useradd -m -s /bin/bash admin passwd admin</code> </pre><br>  We set the folder owner: <br><br><pre> <code class="bash hljs">chown admin:admin -R /var/www/users/admin</code> </pre><br>  We set the root directory for the user: <br><br><pre> <code class="bash hljs">usermod -d /var/www/users/admin admin</code> </pre><br>  Configure virtual hosts in apache: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:8080&gt;</span></span> <span class="hljs-attribute"><span class="hljs-attribute">ServerAdmin</span></span> webmaster@localhost DocumentRoot /var/www/users/admin/domain.ru SuexecUserGroup admin admin &lt;IfModule mod_remoteip.c&gt; RemoteIPHeader X-Forwarded-For RemoteIPHeader X-Real-IP RemoteIPInternalProxy 127.0.0.1 &lt;/IfModule&gt; &lt;ifmodule mod_rewrite.c&gt; RewriteEngine <span class="hljs-literal"><span class="hljs-literal">On</span></span> RewriteRule .* -<span class="hljs-meta"><span class="hljs-meta"> [E=REMOTE_USER:%{HTTP:Authorization}] &lt;/ifmodule&gt; &lt;IfModule mod_fcgid.c&gt; IPCCommTimeout 7200 FcgidConnectTimeout 320 MaxRequestLen 25728640 FcgidMaxRequestsPerProcess 0 FcgidBusyTimeout 3600 FcgidOutputBufferSize 0 &lt;/IfModule&gt; &lt;FilesMatch "\.ph(p[3-5]?|tml)$"&gt; SetHandler fcgid-script FCGIWrapper /var/www/users/admin/php-bin/php &lt;/FilesMatch&gt; ErrorLog /var/www/users/admin/apache-log/error.log CustomLog /var/www/users/admin/apache-log/access.log combined &lt;/VirtualHost&gt; &lt;Directory /var/www/users/admin/www&gt; AllowOverride All Options +Includes +ExecCGI &lt;/Directory&gt;</span></span></code> </pre><br>  In the user's php.ini settings, we change session.save_path <br> <code>session.save_path = /var/www/users/admin/temp/php-session</code> <br> <br>  Restart apache: <br><br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>  <b>STAGE 4 (Installing Nginx with google pagespeed module)</b> <br><br>  Looking ahead, in order to support pagespeed in Nginx, Nginx itself needs to be rebuilt with this module, but in order not to climb further in the settings later, it is easier to install it first. <br>  Change the ports for Apache: <br><br><pre> <code class="bash hljs">/etc/apache2/ports.conf +    </code> </pre><br>  Restart Apache: <br><br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>  Install ngnix: <br><br><pre> <code class="bash hljs">apt-get install nginx</code> </pre><br>  We collect Nginx with pagespeed <br><br>  First you need to install everything you need to build the packages: <br><br><pre> <code class="bash hljs">apt install -y build-essential zlib1g-dev libpcre3 libpcre3-dev unzip libxslt1-dev libgd-dev libgeoip-dev</code> </pre><br>  Create folders for nginx sources: <br><br><pre> <code class="bash hljs">mkdir -p /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx</code> </pre><br>  Download and unpack pagespeed and psol.  Yt cnjbn g <br><br><pre> <code class="bash hljs">wget https://github.com/pagespeed/ngx_pagespeed/archive/v1.11.33.4-beta.zip unzip v1.11.33.4-beta.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ngx_pagespeed-1.11.33.4-beta wget https://dl.google.com/dl/page-speed/psol/1.11.33.4.tar.gz tar -xzvf 1.11.33.4.tar.gz</code> </pre><br>  The psol itself is downloaded and unpacked in a directory with ngx_pagespeed.  Go to the folder with Ngnix <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx</code> </pre> <br>  Check the ngnix version (the default is 1.10.0 in ubuntu 16.0.4): <br><br><pre> <code class="bash hljs">nginx -V</code> </pre> <br>  Download the NGINX version: <br><br><pre> <code class="bash hljs">wget https://nginx.ru/download/nginx-1.10.0.tar.gz tar -xvzf nginx-1.10.0.tar.gz</code> </pre><br>  We build nginx with the same parameters as the installed one, but at the end we add additional modules: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx/nginx-1.10.0 ./configure \ --with-cc-opt=<span class="hljs-string"><span class="hljs-string">'-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2'</span></span> --with-ld-opt=<span class="hljs-string"><span class="hljs-string">'-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now'</span></span> --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log --error-log-path=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_addition_module --with-http_dav_module --with-http_geoip_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module --with-http_v2_module --with-http_sub_module --with-http_xslt_module --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module --with-threads \ --add-module=/opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx/ngx_pagespeed-1.11.33.4-beta \ --with-http_mp4_module</code> </pre><br>  We collect Nginx: <br><br><pre> <code class="bash hljs">make make install</code> </pre><br>  The compiled binary Nginx file is located in the /opt/source/nginx/nginx-1.10.0/objs/nginx directory.  In order to install, you just need to replace the current Nginx file that is being used with the one you have collected. <br><br>  Stop Nginx, replace the file, and restart it. <br><br><pre> <code class="bash hljs">service nginx stop</code> </pre><br>  # Rename (just in case) the current nginx in nginx_backup: <br><br><pre> <code class="bash hljs">mv /usr/sbin/nginx /usr/sbin/nginx_backup</code> </pre><br>  # Move in its place a new compiled binary: <br><br><pre> <code class="bash hljs">mv /opt/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/nginx/nginx-1.10.0/objs/nginx /usr/sbin/nginx</code> </pre><br>  restart nginx: <br><br><pre> <code class="bash hljs">service nginx start</code> </pre><br>  Create a cache storage folder for pagespeed: <br><br><pre> <code class="bash hljs">/var/www/temp/ /var/www/temp/page-speed/</code> </pre><br>  Add /etc/nginx/nginx.conf to the http section: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> FileCachePath <span class="hljs-string"><span class="hljs-string">"/var/www/temp/page-speed/"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> EnableFilters combine_css,combine_javascript,rewrite_images,rewrite_css,rewrite_javascript,inline_images,recompress_jpeg,recompress_png,resize_images; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> JpegRecompressionQuality <span class="hljs-number"><span class="hljs-number">85</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> ImageRecompressionQuality <span class="hljs-number"><span class="hljs-number">85</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> ImageInlineMaxBytes <span class="hljs-number"><span class="hljs-number">2048</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pagespeed</span></span> LowercaseHtmlNames <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre><br>  <b>STAGE 5 (Configuring Nginx as reverse proxy)</b> <br><br>  I will say that on the Internet, a bunch of articles to configure Nginx as a reverse proxy.  I will give an introductory version of the configuration. <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> domain.ru; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx.access_log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* \.(jpg|jpeg|gif|png|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|tar|wav|bmp|rtf|swf|ico|flv|txt|xml|docx|xlsx)$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/users/admin/domain.ru; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.php; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> <span class="hljs-number"><span class="hljs-number">30d</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = <span class="hljs-variable"><span class="hljs-variable">@prox</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@prox</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8880</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-for <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_send_timeout</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_read_timeout</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Connection close; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Type; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Disposition; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Length; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ /\.ht</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8880</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-for <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_send_timeout</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_read_timeout</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Connection close; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Type; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Disposition; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Content-Length; } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Sources:</b> <div class="spoiler_text">  <a href="https://pro-gram.ru/nginx-apache-ubuntu.html">https://pro-gram.ru/nginx-apache-ubuntu.html</a> <br>  <a href="http://www.info-x.org/freebsd/programmy/apache_suexec_php_v_rezhime_cgi.html">http://www.info-x.org/freebsd/programmy/apache_suexec_php_v_rezhime_cgi.html</a> <br>  <a href="http://adminunix.ru/nastrojka-php-5-2-cherez-fastcgi-i-php-5-3-kak-modul-apache2-na/">http://adminunix.ru/nastrojka-php-5-2-cherez-fastcgi-i-php-5-3-kak-modul-apache2-na/</a> <br>  <a href="httpd%26f%3D14">https://www.server-world.info/en/note?os=Ubuntu_16.04&amp;p=httpd&amp;f=14</a> <br>  <a href="http://webew.ru/posts/5351.webew">http://webew.ru/posts/5351.webew</a> <br>  <a href="https://camouf.ru/blog-note/589/">https://camouf.ru/blog-note/589/</a> <br>  <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D32%26CHAPTER_ID%3D04902%26LESSON_PATH%3D3903.4897.4900.4902">https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=32&amp;CHAPTER_ID=04902&amp;LESSON_PATH=3903.4897.4900.4902</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/330772/">https://habr.com/ru/post/330772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330756/index.html">Operation ‚ÄúMigration‚Äù: if your mail is somewhere there, but you need to be here</a></li>
<li><a href="../330758/index.html">GIS and distributed computing</a></li>
<li><a href="../330760/index.html">Working with the server using Alamofire on Swift</a></li>
<li><a href="../330762/index.html">The cost of the error: who pays for the programmers' mistakes and how much?</a></li>
<li><a href="../330764/index.html">Virtual creatures and their habitats: the past and present TTY in Linux</a></li>
<li><a href="../330774/index.html">Facebook Mobile Advertising Test</a></li>
<li><a href="../330776/index.html">OpenStack Test Automation</a></li>
<li><a href="../330778/index.html">Release Rust 1.18</a></li>
<li><a href="../330782/index.html">Lectures Tehnotreka. Linux administration</a></li>
<li><a href="../330784/index.html">Man's bugfix: how to fix bugs that interfere with work</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>