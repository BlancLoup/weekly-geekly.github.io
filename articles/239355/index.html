<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a home audio system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Immediately make a reservation that I understand by the home audio system. 

 Objective: To control the playback of music in columns from any device o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a home audio system</h1><div class="post__text post__text-html js-mediator-article">  Immediately make a reservation that I understand by the home audio system. <br><br>  <b>Objective: To control the playback of music in columns from any device on your home network.</b> <br><br>  The implementation looks like this: the database stores information about the music, there is a servlet that pulls this information upon request. <br>  Everything is managed through a web interface. <br>  And, finally, on the android device to which the speakers are connected, the audio server is spinning. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so, let's go. <br><br><h4>  1. Prepare the database </h4><br>  We will use MySQL as a database.  The database contains two tables: <i>mp3</i> - data about audio files and <i>mp3_tmp</i> - the table is used when updating the database.  The structure of both tables is identical. <br><br>  <b>The tables contain the following fields:</b> <br><br><a name="habracut"></a><br><br>  <i>path</i> - the path to the file on disk, <i>PRIMARY KEY</i> ; <br>  <i>artist</i> - performer; <br>  <i>album</i> - the name of the album; <br>  <i>title</i> - the name of the track; <br>  <i>year</i> - year of recording; <br>  <i>number</i> - the number of the track in the album; <br>  <i>length</i> - the length of the track in the format mm: ss. <br><br>  So, SQL to create the table: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`mp3_tmp`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`mp3_tmp`</span></span> ( <span class="hljs-string"><span class="hljs-string">`path`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`artist`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`album`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`year`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`length`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`number`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`path`</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br><br>  <b>For the formation of the table using the program in Java.</b> <br><br>  To begin with, let's create a list of all mp3 files in the folder with music: <br><br><pre> <code class="java hljs">FileFinder ff = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileFinder(); <span class="hljs-comment"><span class="hljs-comment">//   ,    List&lt;File&gt; files = ff.findFiles(initPath, ".*\\.mp3"); //   mp3-   initPath</span></span></code> </pre> <br><br>  Next, we enter the data about the files in the temporary table. <br>  (used <i>JDBC</i> - to connect to the database and <br>  <i>jaudiotagger</i> library - to scan mp3 tags): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (File file : files) { <span class="hljs-comment"><span class="hljs-comment">//  : PreparedStatement preparedStatement = connect.prepareStatement("insert into `mp3_tmp` " + "(path, artist, album, title, year, number, length) " + "values (?, ?, ?, ?, ?, ?, ?)"); String fullName = file.getCanonicalPath(); String fileName = fullName.replace(initPath,""); //       String length = ""; try { AudioFile af = AudioFileIO.read(file); int len = af.getAudioHeader().getTrackLength(); //   int sec = len%60; int min = (len-sec)/60; length = String.format("%02d:%02d", min, sec); //  MP3File mp3f = new MP3File(file); Tag tag = mp3f.getTag(); //  String artist = tag.getFirst(FieldKey.ARTIST); String album = tag.getFirst(FieldKey.ALBUM); String title = tag.getFirst(FieldKey.TITLE); String year = tag.getFirst(FieldKey.YEAR); String number = tag.getFirst(FieldKey.TRACK); //      (  ): if (!number.equals("")){ Integer num = Integer.parseInt(number); if (num &lt; 10) { number = "00"+num.toString(); } else if (num &lt; 100) { number = "0"+num.toString(); } } //   : preparedStatement.setString(1, fileName); preparedStatement.setString(2, artist); preparedStatement.setString(3, album); preparedStatement.setString(4, title); preparedStatement.setString(5, year); preparedStatement.setString(6, number); } catch (Exception e) { //    ,   : preparedStatement.setString(1, fileName); preparedStatement.setString(2, ""); preparedStatement.setString(3, ""); preparedStatement.setString(4, ""); preparedStatement.setString(5, ""); preparedStatement.setString(6, ""); } finally { preparedStatement.setString(7, length); preparedStatement.executeUpdate(); //     } } //, ,   : statement.execute("DROP TABLE IF EXISTS `mp3`"); statement.execute("CREATE TABLE `mp3` LIKE `mp3_tmp`"); statement.execute("INSERT INTO `mp3` SELECT * FROM `mp3_tmp`");</span></span></code> </pre> <br><br><h4>  2. Backend player </h4><br>  <b>The player's backend consists of two servlets:</b> <br><br>  @WebServlet ("/ getlist") - returns the list of tracks for the search query; <br>  @WebServlet ("/ hint") - returns hints on the first letters. <br><br>  <b>Learn more about the GetList servlet.</b> <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// SQL- String query = "select path, artist, title, album, year, length from `mp3` where "; String[] qArr0 = request.getParameter("query").split("\\|"); for (int k=0; k&lt;qArr0.length; k++) { if (k&gt;0) query += " or "; String[] qArr = qArr0[k].split(" "); query += "concat(title,' ',album,' ',artist) like "+"'%"+qArr[0]+"%' "; for (int j=1; j&lt;qArr.length; j++) { query += "and concat(title,' ',album,' ',artist) like "+"'%"+qArr[j]+"%' "; } } query += "group by concat(year,album,number,title,artist,length) "; query += "order by concat(year,' ',album,' ',number,' ',title,' ',artist)"; Statement statement = connect.createStatement(); resultSet = statement.executeQuery(query); //  //  GSON   json Gson gson = new GsonBuilder().create(); int i=0; while (resultSet.next()) { if (i++&gt;0) playlist+="\n"; String artist = resultSet.getString("artist"); String title = resultSet.getString("title"); String album = resultSet.getString("album"); String year = resultSet.getString("year"); String path = resultSet.getString("path"); path = musicPath+path; String length = resultSet.getString("length"); Track track = new Track(title, artist, album, year, path, length); playlist += gson.toJson(track); }</span></span></code> </pre> <br><br>  <b>The Hint servlet runs the following SQL query:</b> <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// String text = request.getParameter("query"); Statement statement = connect.createStatement(); resultSet = statement.executeQuery("select title as 'str' from " + "`mp3` where title like '%" + text + "%' union " + "select artist as 'str' from " + "`mp3` where artist like '%" + text + "%' union " + "select album as 'str' from " + "`mp3` where album like '%" + text + "%' group by str order by str limit 10");</span></span></code> </pre> <br><br>  and returns the data in the <i>json</i> format. <br><br><h4>  3. HTML5 frontend </h4><br>  We use <i>HTML5</i> and <i>jQuery</i> as a front end player.  The following points are interesting here. <br><br>  <b>Playlist Formation:</b> <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#search'</span></span>).click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// -   var uri = '/mp3player/getlist?query='+$('#query').val(); $.get(encodeURI(uri),function(data){ window.playlist = []; window.number = 0; var array = data.split('\n'); for (i=0; i&lt;array.length; i++) { window.playlist[i] = $.parseJSON(array[i]); } //  HTML : var li_list = '&lt;ol&gt;'; var album = ''; var year = ''; var alb_num = 0; for (i=0; i&lt;window.playlist.length; i++) { if (album != window.playlist[i].album || i == 0) { album = window.playlist[i].album; year = window.playlist[i].year; var str = ' '; if (album) str = album; if (year) str+= ' | ' + year; li_list += '&lt;h4 class="album" alb_num='+alb_num+'&gt;'+str+'&lt;/h4&gt;'; alb_num++; } li_list += '&lt;li class="track" id='+i+' alb_num='+alb_num+'&gt;' +window.playlist[i].title+' ('+window.playlist[i].artist+') | '+window.playlist[i].length+'&lt;/li&gt;'; } li_list += '&lt;/ol&gt;'; //  : $('#list').html(li_list); if (window.playlist.length&gt;1) { window.alb_num = $('li#'+window.number).attr('alb_num'); $('#list').scrollTop($('li#'+window.number).offset().top-$('li#0').offset().top); } //      : $('li.track').click(function(){ $('#toogle').prop('disabled',false); $('#toogle').prop('checked',true); $('li#'+window.number).attr('style','font-weight:normal; font-style:normal'); window.number = $(this).attr('id'); if (window.playlist.length&gt;1) { window.alb_num = $('li#'+window.number).attr('alb_num'); $('#list').animate({scrollTop:($('li#'+window.number).offset().top-$('li#0').offset().top)},200); } $('li#'+window.number).attr('style','font-weight:bold; font-style:italic'); $('#my_audio').trigger('pause'); // #my_audio - html5  audio.   . var track = window.playlist[window.number]; $('#title').html('&lt;h3&gt;'+(Number(window.number)+1)+': '+track.title+' ('+track.artist+')&lt;/h3&gt;'); $('#my_audio').attr('src',track.mp3); //    $('#my_audio').trigger('play'); //   }); }); });</span></span></code> </pre><br><br>  <b>Tips:</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   jquery.autocomplete $('#query').autocomplete({serviceUrl:'/mp3player/hint'});</span></span></code> </pre><br><br>  <b>Volume change:</b> <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#volume_slider'</span></span>).slider({<span class="hljs-attr"><span class="hljs-attr">orientation</span></span>:<span class="hljs-string"><span class="hljs-string">'vertical'</span></span>,<span class="hljs-attr"><span class="hljs-attr">range</span></span>:<span class="hljs-string"><span class="hljs-string">'min'</span></span>,<span class="hljs-attr"><span class="hljs-attr">min</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-attr"><span class="hljs-attr">max</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-attr"><span class="hljs-attr">value</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-attr"><span class="hljs-attr">stop</span></span>:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event,ui</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> volume = (ui.value*<span class="hljs-number"><span class="hljs-number">1.0</span></span>)/<span class="hljs-number"><span class="hljs-number">100.0</span></span>; $(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).prop(<span class="hljs-string"><span class="hljs-string">'volume'</span></span>,volume); } });</code> </pre><br><br>  <b>Track Wandering:</b> <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#time_slider'</span></span>).slider({<span class="hljs-attr"><span class="hljs-attr">disabled</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-attr"><span class="hljs-attr">range</span></span>:<span class="hljs-string"><span class="hljs-string">'min'</span></span>,<span class="hljs-attr"><span class="hljs-attr">min</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-attr"><span class="hljs-attr">max</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-attr"><span class="hljs-attr">stop</span></span>:<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, ui</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dur = $(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).prop(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cur = (dur*ui.value)/<span class="hljs-number"><span class="hljs-number">1000</span></span>; $(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).prop(<span class="hljs-string"><span class="hljs-string">'currentTime'</span></span>,cur); } });</code> </pre><br><br>  <b>Interactive display of the current position:</b> <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).bind(<span class="hljs-string"><span class="hljs-string">'timeupdate'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cur = $(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).prop(<span class="hljs-string"><span class="hljs-string">'currentTime'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dur = $(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).prop(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> left = dur - cur; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dur) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> slider_val = cur*<span class="hljs-number"><span class="hljs-number">1000</span></span>/dur; cur = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(cur+<span class="hljs-number"><span class="hljs-number">0.5</span></span>); dur = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(dur+<span class="hljs-number"><span class="hljs-number">0.5</span></span>); left = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(left+<span class="hljs-number"><span class="hljs-number">0.5</span></span>); cur_s = cur % <span class="hljs-number"><span class="hljs-number">60</span></span>; cur_m = (cur - cur_s)/<span class="hljs-number"><span class="hljs-number">60</span></span>; dur_s = dur % <span class="hljs-number"><span class="hljs-number">60</span></span>; dur_m = (dur - dur_s)/<span class="hljs-number"><span class="hljs-number">60</span></span>; left_s = left % <span class="hljs-number"><span class="hljs-number">60</span></span>; left_m = (left - left_s)/<span class="hljs-number"><span class="hljs-number">60</span></span>; cur_s = $.formatNumber(cur_s,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); cur_m = $.formatNumber(cur_m,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); dur_s = $.formatNumber(dur_s,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); dur_m = $.formatNumber(dur_m,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); left_s = $.formatNumber(left_s,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); left_m = $.formatNumber(left_m,{<span class="hljs-attr"><span class="hljs-attr">format</span></span>:<span class="hljs-string"><span class="hljs-string">'00'</span></span>,<span class="hljs-attr"><span class="hljs-attr">locale</span></span>:<span class="hljs-string"><span class="hljs-string">'ru'</span></span>}); $(<span class="hljs-string"><span class="hljs-string">'#time_cur'</span></span>).text(cur_m+<span class="hljs-string"><span class="hljs-string">':'</span></span>+cur_s+<span class="hljs-string"><span class="hljs-string">' '</span></span>) $(<span class="hljs-string"><span class="hljs-string">'#time_dur'</span></span>).text(<span class="hljs-string"><span class="hljs-string">' '</span></span>+left_m+<span class="hljs-string"><span class="hljs-string">':'</span></span>+left_s); $(<span class="hljs-string"><span class="hljs-string">'#time_slider'</span></span>).slider(<span class="hljs-string"><span class="hljs-string">'option'</span></span>,{<span class="hljs-attr"><span class="hljs-attr">disabled</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}); $(<span class="hljs-string"><span class="hljs-string">'#time_slider'</span></span>).slider(<span class="hljs-string"><span class="hljs-string">'value'</span></span>,slider_val); } });</code> </pre><br><br>  <b>Switch to the next track at the end:</b> <br><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#my_audio'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'ended'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = (<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.number) + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.playlist.length; $(<span class="hljs-string"><span class="hljs-string">'li#'</span></span>+n).trigger(<span class="hljs-string"><span class="hljs-string">'click'</span></span>); });</code> </pre><br><br>  <b>The finished player can be seen here:</b> <br>  <a href="http://home.tabatsky.ru/mp3player/homeaudio/desktop.jsp">http://home.tabatsky.ru/mp3player/homeaudio/desktop.jsp</a> <br><br><h4>  4. Audio server </h4><br>  It so happened that good speakers and one device on an android were gathering dust around me.  As a result, there was an idea to write an audio server for android and listen to music through speakers. <br><br>  The audio server consists of one Activity and two services - <i>HttpService</i> and <i>PlayerService</i> . <br><br>  And so, in more detail. <br><br>  <b>HttpService accepts HTTP requests and sends PlayerService commands.</b> <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startId)</span></span></span><span class="hljs-function"> </span></span>{ t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ss = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServerSocket(port, backlog, InetAddress.getByName(addr)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//     Socket s = ss.accept(); Thread tt = new Thread(new SocketProcessor(s)); tt.start(); tt.join(50); } } catch (Throwable e) { e.printStackTrace(); } } }; t.start(); // BroadcastReceiver   c PlayerService filter = new IntentFilter("Http"); receiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { String res = intent.getStringExtra("result"); if (res!=null) result = "'"+res+"'"; String stat = intent.getStringExtra("status"); if (stat!=null) status = "'"+stat+"'"; String cur = intent.getStringExtra("currentTime"); if (cur!=null) currentTime = cur; String dur = intent.getStringExtra("duration"); if (dur!=null) duration = dur; } }; registerReceiver(receiver, filter); return START_STICKY; } //     HTTP- private class SocketProcessor implements Runnable { private Socket s; private InputStream is; private OutputStream os; private SocketProcessor(Socket s) throws Throwable { this.s = s; this.is = s.getInputStream(); this.os = s.getOutputStream(); } public void run() { try { //   HTTP-: readInputHeaders(); //        jsonp: String response = ""; response += "window.result="+result+"; "; response += "window.status="+status+"; "; response += "window.currentTime="+currentTime+"; "; response += "window.duration="+duration+"; "; writeResponse(response); } catch (Throwable t) { /*do nothing*/ } finally { try { s.close(); } catch (Throwable t) { /*do nothing*/ } } System.err.println("Client processing finished"); } private void writeResponse(String s) throws Throwable { String response = "HTTP/1.1 200 OK\r\n" + "Server: YarServer/2009-09-09\r\n" + "Content-Type: text/javascript\r\n" + "Content-Length: " + s.length() + "\r\n" + "Connection: close\r\n\r\n"; String result = response + s; os.write(result.getBytes()); os.flush(); } private void readInputHeaders() throws Throwable { BufferedReader br = new BufferedReader(new InputStreamReader(is)); String data = ""; String action = ""; String src = ""; String volume = ""; while(true) { String s = br.readLine(); //System.err.println(s); //data += s+"\n"; if (s.startsWith("GET /favicon.ico")) return; if (s.startsWith("GET /?")) { s = s.replace("GET /?", "").replace(" HTTP/1.1", ""); String[] arr = s.split("&amp;"); for (String str: arr) { str = URLDecoder.decode(str, "UTF-8"); if (str.startsWith("action=")) action = str.replace("action=", ""); if (str.startsWith("src=")) src = str.replace("src=", ""); if (str.startsWith("volume=")) volume = str.replace("volume=", ""); } } if(s == null || s.trim().length() == 0) { break; } } //  broadcast  Intent in = new Intent("Player"); in.putExtra("action", action); in.putExtra("src",src); in.putExtra("volume", volume); sendBroadcast(in); } } }</span></span></code> </pre><br><br>  <b>PlayerService is responsible for playing music:</b> <br><br><pre> <code class="javascript hljs">public int onStartCommand(Intent intent, int flags, int startId) { player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaPlayer(); player.setAudioStreamType(AudioManager.STREAM_MUSIC); player.setOnPreparedListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnPreparedListener() { @Override public <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> onPrepared(MediaPlayer mp) { mp.start(); result = <span class="hljs-string"><span class="hljs-string">"ok"</span></span>; status = <span class="hljs-string"><span class="hljs-string">"playing"</span></span>; } }); player.setOnCompletionListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnCompletionListener() { @Override public <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> onCompletion(MediaPlayer mp) { <span class="hljs-comment"><span class="hljs-comment">//player.stop(); result = "ok"; if (mp.getCurrentPosition()&gt;mp.getDuration()-2500) status = "finished"; } }); //   HttpService filter = new IntentFilter("Player"); receiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { String action = intent.getStringExtra("action"); if (action.equals("play")) { player.start(); status = "playing"; } if (action.equals("pause")) { player.pause(); status = "paused"; } if (action.equals("changesrc")) { src = intent.getStringExtra("src"); try { status = "preparing"; player.reset(); //host -      player.setDataSource(host+src); player.prepare(); //player.start(); result = "ok"; } catch (Exception e) { result = "error"; } } if (action.equals("setvolume")) { float volume = Float.parseFloat(intent.getStringExtra("volume")); player.setVolume(volume, volume); } } }; registerReceiver(receiver, filter); // 100     HttpService t = new Thread() { public void run() { while (true) { in = new Intent("Http"); in.putExtra("result", result); //in.putExtra("status", (player.isPlaying()?"playing":"paused")); in.putExtra("status", status); in.putExtra("currentTime", Integer.valueOf(player.getCurrentPosition()/1000).toString()); in.putExtra("duration", Integer.valueOf(player.getDuration()/1000).toString()); sendBroadcast(in); try { sleep(100); } catch (InterruptedException e) { // TODO Auto-generated catch block //e.printStackTrace(); } } } }; t.start(); return START_STICKY; }</span></span></code> </pre><br><br>  <b>It remains only to slightly change the corresponding front-end code.</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  $('li.track').click(function(){ ........ // window.audioServer -     var url = window.audioServer+'/?action=changesrc&amp;src='+track.mp3+'&amp;t='+(new Date().getTime()); $.ajax({ url: encodeURI(url), type: 'GET', crossDomain: true, dataType: 'jsonp' }); ......... } //  $('#volume_slider').slider({orientation:'vertical',range:'min',min:0,max:100,value:100,stop:function(event,ui){ var volume = (ui.value*1.0)/100.0; //$('#my_audio').prop('volume',volume); window.setVolume(volume); } }); window.setVolume = function(volume) { var url = window.audioServer+'/?action=setvolume&amp;volume='+volume +'&amp;t='+(new Date().getTime()); $.ajax({ url: encodeURI(url), type: 'GET', crossDomain: true, dataType: 'jsonp' }); }; //   window.startUpdate = function() { window.update_interval = setInterval(function(){ var url = window.audioServer+'/?action=update'+'&amp;t='+(new Date().getTime());; $.ajax({ url: encodeURI(url), type: 'GET', crossDomain: true, dataType: 'jsonp' }); if (window.result=='error') { //alert(''); } else if (window.result=='ok') { if (window.status=='playing') { if (!window.fin) { window.fin = 0; } else { window.fin--; } window.updateTime(window.currentTime, window.duration); } else if ((window.fin==0)&amp;&amp;(window.status=='finished')) { window.fin = 2; $('#fwd').trigger('click'); } } },500); };</span></span></code> </pre><br><br>  <b>Bottom line: playing music on the speakers can be controlled from any device connected to your home network.</b> </div><p>Source: <a href="https://habr.com/ru/post/239355/">https://habr.com/ru/post/239355/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239339/index.html">How much does a programmer need to know math? What do they think in Yandex</a></li>
<li><a href="../239341/index.html">Microsoft earned $ 1 billion licensing Samsung Android devices last year</a></li>
<li><a href="../239343/index.html">Mobile version for Django project</a></li>
<li><a href="../239347/index.html">VR helmet programming</a></li>
<li><a href="../239351/index.html">The charm of the bad guys or why girls do not like "nerds"</a></li>
<li><a href="../239357/index.html">Reviewing resumes of female techies is more profitable than men</a></li>
<li><a href="../239359/index.html">Microsoft ActiveDirectory - update user passwords in external repositories</a></li>
<li><a href="../239361/index.html">DSL Application Development and Code Generation</a></li>
<li><a href="../239365/index.html">Spherical screens for UAV operators and remotely controlled vehicles</a></li>
<li><a href="../239367/index.html">Wal Commander - Far Manager replacement for OS X and Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>