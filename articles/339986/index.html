<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VoIP server for a small company (FreePBX 14, Asterisk 15, Ubuntu 16.04) part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, evening or night, it all depends on the time of day in which you happened to read my article. Start over. In our company, thinking abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VoIP server for a small company (FreePBX 14, Asterisk 15, Ubuntu 16.04) part 1</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, evening or night, it all depends on the time of day in which you happened to read my article.  Start over.  In our company, thinking about the transition to SIP and the question arose?  how to implement it. <br><br>  Initial data: <br><ul><li>  15 cell phone numbers, by the number of employees and smartphones; </li><li>  2 city numbers from Megaphone (implemented via SIP); </li><li>  Up to 10 simultaneous calls; </li><li>  The inability to transfer calls between employees; </li><li>  The need for frequent long-distance calls. </li></ul><br><br>  Several options were considered: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Leave it as it is (cell phones); </li><li>  Cloud PBX; </li><li>  "Iron" solution; </li><li>  Own VoIP server. </li></ul><br>  As a result, they decided to implement their VoIP server. <br><br>  What we have: <br><br><ul><li>  Dell PowerEdge R230 1xE3-1220v6 2 √ó 16Gb 2RUD x4 3 √ó 1Tb 7.2K 3.5 "ESXi Server; </li><li>  Ubuntu Server 16.04 (minimum configuration, 1GB of memory, 128 GB disk), installed on ESXi 6.5; </li><li>  SIP from zadarma and Megaphone; </li><li>  Cell phones with SIP clients. </li></ul><a name="habracut"></a><br>  A small digression, on points: <br><br>  Ubuntu 16.04 here is a corporate standard, Ubuntu Server 16.04, as a working OS Ubuntu Desktop 16.04.  The main server is based on Zentyal 5.0.  Servers and working PCs are installed over the network via TFTP.  If it is interesting I will describe all the nuances of installing Zentyal (and their decent amount). <br><br>  Devices decided not to buy, each employee has a cell either on Android or iOS, so that there are no problems with clients, employees have access to a Wi-FI desktop.  SIP clients also stand on working PCs.  There is also access to SIP via the Internet, security is also taken into account, connection ports are changed, SIP passwords are rather complicated. <br><br>  We turn to the essence.  There is a lot of documentation on installing FreePBX 13 on Ubuntu 16.04, but there is no way to install FreePBX 14, even the official wiki FreePBX is only for CentOS 7 and Debian 8.8, but there was a great desire and desire to make it. <br><br>  1. I will not describe the installation of Ubuntu Server 16.04, it's easy even for a beginner. <br><br>  1.1.  I did all the manipulations as root <code>sudo su</code> <br><br>  2. Upgrade the system: <code>apt update &amp;&amp; apt upgrade -y</code> , if a reboot is required, reboot. <br><br>  3. Let's do PHP, PHP 5.6 is required for FreePBX 14, by default PHP 7.0 is running in Ubunty 16.04 <br><br>  Delete all PHP if it is in the system: <br><br> <code>sudo apt purge `dpkg -l | grep php| awk '{print $2}' |tr "\n" " "`</code> <br> <br>  Install the PHP 5.6 repository: <br><br> <code>sudo add-apt-repository ppa:ondrej/php</code> <br> <br>  Update and install PHP: <br><br> <code>sudo apt update <br> sudo apt install php5.6</code> <br> <br>  4. Mysql that goes to the repository is not compatible with FreePBX 14, we need MariaDB, we add it to the repository: <br><br> <code>sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8 <br> sudo add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mirror.mephi.ru/mariadb/repo/10.2/ubuntu xenial main'</code> <br> <br>  5. We also need nodejs: <br><br> <code>curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - <br> sudo apt install -y nodejs</code> <br> <br>  6. Install now everything you need: <br><br> <code>sudo apt install -y build-essential linux-headers-`uname -r` openssh-server apache2 mariadb-server mysql-client bison flex sox libncurses5-dev libssl-dev libmysqlclient-dev mpg123 libxml2-dev libnewt-dev sqlite3 libsqlite3-dev pkg-config automake libtool autoconf git subversion unixodbc-dev uuid uuid-dev libasound2-dev libogg-dev libvorbis-dev libcurl4-openssl-dev libical-dev libneon27-dev libsrtp0-dev libspandsp-dev libopus-dev opus-tools libiksemel-dev libiksemel-utils libiksemel3 xmlstarlet</code> <br> <br> <code>sudo apt install -y php5.6 php5.6-curl php5.6-cli php5.6-mysql php5.6-odbc php5.6-db php5.6-gd php5.6-xml curl libapache2-mod-php5.6 php5.6-mbstring</code> <br> <br> <code>apt install -y php-pear</code> <br> <br>  6.1.  The libmyodbc package is no longer in the Ubuntu repositories since the Xenial version. <br><br>  Download the desired connector: <br><br> <code>wget https://downloads.mariadb.com/Connectors/odbc/connector-odbc-3.0.2/mariadb-connector-odbc-3.0.2-ga-debian-x86_64.tar.gz</code> <br> <br>  Unpack: <br> <code>tar -zxvf mariadb-connector-odbc-3.0.2-ga-debian-x86_64.tar.gz</code> <br> <br>  And copy it to the / usr / lib / x86_64-linux-gnu / odbc / directory: <br><br> <code>cd mariadb-connector-odbc-3.0.2-ga-debian-x86_64/lib <br> cp libmaodbc.so /usr/lib/x86_64-linux-gnu/odbc/ <br></code> <br>  7. Now, according to the recommendations of FreePBX, you need to reboot, I did not do this. <br><br>  8. Make sure mod_rewrite is enabled to avoid possible attacks. <br><br> <code>a2enmod rewrite <br> service apache2 restart</code> <br> <br>  9. Enable Console_Getopt support <br><br> <code>pear install Console_Getopt</code> <br> <br>  10. Go to the installation of Asterisk 15 (in fact, this is part of the wiki with FreePBX for Debina 8.8): <br><br>  Download the source: <br><br> <code>cd /usr/src <br> wget http://sourceforge.net/projects/lame/files/lame/3.98.4/lame-3.98.4.tar.gz &amp;&amp; <br> wget http://downloads.asterisk.org/pub/telephony/dahdi-linux-complete/dahdi-linux-complete-current.tar.gz &amp;&amp; <br> wget http://downloads.asterisk.org/pub/telephony/libpri/libpri-current.tar.gz &amp;&amp; <br> wget http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-15-current.tar.gz &amp;&amp; <br> git clone https://github.com/akheron/jansson.git &amp;&amp; <br> wget http://www.pjsip.org/release/2.5.5/pjproject-2.5.5.tar.bz2</code> <br> <br>  Compile and install Lame (mp3): <br><br> <code>cd /usr/src &amp;&amp; <br> tar zxvf lame-3.98.4.tar.gz &amp;&amp; <br> cd lame-3.98.4 &amp;&amp; <br> ./configure &amp;&amp; <br> make &amp;&amp; <br> make install</code> <br> <br>  Let's compile and install DAHDI and LibPRI (We do not use boards, but who knows what we want later): <br><br> <code>cd /usr/src &amp;&amp; <br> tar xvfz dahdi-linux-complete-current.tar.gz &amp;&amp; <br> tar xvfz libpri-current.tar.gz &amp;&amp; <br> rm -f dahdi-linux-complete-current.tar.gz libpri-current.tar.gz &amp;&amp; <br> cd dahdi-linux-complete-* &amp;&amp; <br> make all &amp;&amp; <br> make install &amp;&amp; <br> make config &amp;&amp; <br> cd /usr/src/libpri-* &amp;&amp; <br> make &amp;&amp; <br> make install</code> <br> <br>  Compile and install pjproject: <br><br> <code>cd /usr/src &amp;&amp; <br> tar -xjvf pjproject-2.*.*.tar.bz2 &amp;&amp; <br> cd pjproject-* &amp;&amp; <br> CFLAGS='-DPJ_HAS_IPV6=1' ./configure --prefix=/usr --enable-shared --disable-sound\ <br> --disable-resample --disable-video --disable-opencore-amr &amp;&amp; <br> make dep &amp;&amp; <br> make &amp;&amp; <br> make install</code> <br> <br>  Compile and install jansson: <br><br> <code>cd /usr/src/jansson &amp;&amp; <br> autoreconf -i &amp;&amp; <br> ./configure &amp;&amp; <br> make &amp;&amp; <br> make install</code> <br> <br>  If you want to use the Opus codec, you need to install xmlstarlet before compiling Asterisk: <br><br> <code>sudo apt install xmlstarlet</code> <br> <br>  Compile and install Asterisk: <br><br> <code>cd /usr/src &amp;&amp; <br> tar xvfz asterisk-15-current.tar.gz &amp;&amp; <br> rm -f asterisk-15-current.tar.gz &amp;&amp; <br> cd asterisk-* &amp;&amp; <br> ./contrib/scripts/install_prereq install &amp;&amp; <br> ./configure --with-pjproject-bundled --with-crypto --with-ssl=ssl --with-srtp &amp;&amp; <br> contrib/scripts/get_mp3_source.sh &amp;&amp; <br> make menuselect</code> <br> <br>  For myself, I chose 'format_mp3' and 'res_config_mysql', as well as included 'codec_opus' <br><br>  Save the changes and continue the installation: <br><br> <code>make &amp;&amp; <br> make install &amp;&amp; <br> make config &amp;&amp; <br> ldconfig <br> update-rc.d -f asterisk remove</code> <br> <br>  While everything was going, I managed to pour myself a cup of coffee and continued. <br><br>  Configure the launch as user 'Asterisk' <br><br>  Uncomment in / etc / default / asterisk: <br><br> <code>AST_USER="asterisk" <br> AST_GROUP="asterisk"</code> <br> <br>  Create an Asterisk user and set user rights: <br><br> <code>useradd -m asterisk &amp;&amp; <br> chown asterisk. /var/run/asterisk &amp;&amp; <br> chown -R asterisk. /etc/asterisk &amp;&amp; <br> chown -R asterisk. /var/{lib,log,spool}/asterisk &amp;&amp; <br> chown -R asterisk. /usr/lib/asterisk</code> <br> <br>  11. Go to FreePBX 14 <br><br>  Configure Apache: <br><br> <code>sed -i 's/\(^upload_max_filesize = \).*/\256M/' /etc/php/5.6/apache2/php.ini &amp;&amp; <br> sed -ie 's/\;date\.timezone\ \=/date\.timezone\ \=\ "Asia\/Yekaterinburg"/g' /etc/php/5.6/apache2/php.ini &amp;&amp; <br> cp /etc/apache2/apache2.conf /etc/apache2/apache2.conf_orig &amp;&amp; <br> sed -i 's/^\(User\|Group\).*/\1 asterisk/' /etc/apache2/apache2.conf &amp;&amp; <br> sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/apache2.conf &amp;&amp; <br> systemctl restart apache2</code> <br> <br>  Configure ODBC: <br><br> <code>cat &gt;&gt; /etc/odbcinst.ini &lt;&lt; EOF <br> [MySQL] <br> Driver=/usr/lib/x86_64-linux-gnu/odbc/libmaodbc.so <br> UsageCount=2 <br> <br> EOF</code> <br> <br> <code>cat &gt;&gt; /etc/odbc.ini &lt;&lt; EOF <br> [MySQL-asteriskcdrdb] <br> Description=MySQL connection to 'asteriskcdrdb' database <br> driver=MySQL <br> server=localhost <br> database=asteriskcdrdb <br> Port=3306 <br> Socket=/var/run/mysqld/mysqld.sock <br> option=3 <br> <br> EOF</code> <br> <br>  Download and install FreePBX: <br><br> <code>cd /usr/src <br> wget http://mirror.freepbx.org/modules/packages/freepbx/freepbx-14.0-latest.tgz <br> tar vxfz freepbx-14.0-latest.tgz <br> rm -f freepbx-14.0-latest.tgz <br> cd freepbx <br> touch /etc/asterisk/ari.conf <br> ./start_asterisk start <br> ./install -n</code> <br> <br>  11.1.  To Russify FreePBX, the ru_RU.UTF-8 locale is needed: <br><br> <code>echo "russian ru_RU.UTF-8" &gt;&gt; /etc/locale.alias</code> <br> <code>locale-gen ru_RU</code> <br> <code>systemctl restart apache2</code> <br> <br>  12. Create a startup script for systemd: <br><br>  Insert into the /etc/systemd/system/freepbx.service file: <br><br> <code>[Unit] <br> Description=FreePBX VoIP Server <br> After=mariadb.service <br> <br> [Service] <br> Type=oneshot <br> RemainAfterExit=yes <br> ExecStart=/usr/sbin/fwconsole start -q <br> ExecStop=/usr/sbin/fwconsole stop -q <br> <br> [Install] <br> WantedBy=multi-user.target</code> <br> <br>  Activate the service: <br><br> <code>systemctl enable freepbx.service</code> <br> <br>  Epilogue. <br><br>  This completes the installation and initial setup.  There will be questions, always ready to answer. </div><p>Source: <a href="https://habr.com/ru/post/339986/">https://habr.com/ru/post/339986/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339976/index.html">How IIS supports our BI analytics, and what are the features of settings under Highload</a></li>
<li><a href="../339978/index.html">TLS 1.2 and new GOST</a></li>
<li><a href="../339980/index.html">Lenovo data center solutions</a></li>
<li><a href="../339982/index.html">A cohort analysis shows a picture that is completely different from our usual perception.</a></li>
<li><a href="../339984/index.html">Case: endless development of the ultimate flash drive or how not to start a startup. Part 1: from idea to product</a></li>
<li><a href="../339988/index.html">A little bit about VIM and IDE</a></li>
<li><a href="../339990/index.html">Plastic: how not to hurt the team by an engraved statuette</a></li>
<li><a href="../339992/index.html">We enter on ‚ÄúMy Circle‚Äù a search for candidates by ‚ÄúHabrahabra‚Äù users</a></li>
<li><a href="../339994/index.html">Flowers, fly and well rehearsed random machine learning</a></li>
<li><a href="../339996/index.html">Ama. Avito. Backend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>