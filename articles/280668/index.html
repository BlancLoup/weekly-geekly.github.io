<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little bit about sockets, redis and broken eggs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don‚Äôt want to work on Friday after the first of April lunch - all of a sudden the technician will throw out some joke. Therefore I decided to write ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little bit about sockets, redis and broken eggs</h1><div class="post__text post__text-html js-mediator-article">  I don‚Äôt want to work on Friday after the first of April lunch - all of a sudden the technician will throw out some joke.  Therefore I decided to write about something. <br>  Not so long ago, in the open spaces of Habr in one article, Unix-sockets, mysql, php and redis immediately deflated.  We will not talk about everything in one article; we‚Äôll dwell on sockets and a little on redis. <br>  So the question is: which is faster than Unix or TCP sockets? <br>  A question that is not worth a damn, however, it is constantly mutable and would not write if not the survey in the article itself, according to which almost half of the respondents believe that it is better / more reliable / more stable to use TCP sockets. <br>  Those who already chooses AF_UNIX, you can not continue to read. <br><a name="habracut"></a><br>  Let's start with a brief extract of the theory. <br>  A socket is one of the interfaces for interprocess communication, which allows developing client-server systems for local or network use.  Since we are considering comparing (on the one hand) Unix sockets, in the following we will talk about IPC within one machine. <br>  Unlike named pipes, when using sockets there is a difference between the client and the server.  The socket mechanism allows you to create a server to which many clients connect. <br><br>  How server interaction is implemented: <br>  - the <i>socket</i> system call creates a socket, but this socket cannot be shared with other processes; <br>  - the socket is called.  For local sockets of the <i>AF_UNIX</i> domain ( <i>AF_LOCAL</i> ), the address will be specified by the file name.  Network sockets <i>AF_INET</i> are named according to their ip / port; <br>  - the system call <i>listen (int socket, int backlog)</i> forms a queue of incoming connections.  The second parameter backlog determines the length of this queue; <br>  - the server accepts these connections by calling <i>accept</i> , which creates a new socket that is different from the named socket.  This new socket is used only to interact with this particular client. <br><br>  From the client‚Äôs point of view, the connection is somewhat simpler: <br>  - the <i>socket</i> is called; <br>  - and <i>connect</i> , using the server's named socket as the address. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's take a closer look at the <i>int socket (int domain, int type, int protocol)</i> call <i>, the</i> second parameter of which determines the type of data exchange used with this socket.  In our comparison, we will consider its possible value <i>SOCK_STREAM</i> , which is a reliable, ordered bi-directional byte stream.  That is, the view sockets are involved in the review. <br>  <i>sockfd = socket (AF_UNIX, SOCK_STREAM, 0);</i> <br>  and <br>  <i>sockfd = socket (AF_INET, SOCK_STREAM, 0);</i> <br><br>  The socket structure in the <i>AF_UNIX</i> domain is simple: <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_un</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sun_len; <span class="hljs-comment"><span class="hljs-comment">/* sockaddr len including null */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sa_family_t</span></span> sun_family; <span class="hljs-comment"><span class="hljs-comment">/* AF_UNIX */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sun_path[<span class="hljs-number"><span class="hljs-number">104</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* path name (gag) */</span></span> };</code> </pre> <br>  In the <i>AF_INET</i> domain <i>is</i> somewhat more complicated: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_in</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sin_len; <span class="hljs-keyword"><span class="hljs-keyword">sa_family_t</span></span> sin_family; <span class="hljs-keyword"><span class="hljs-keyword">in_port_t</span></span> sin_port; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in_addr</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sin_addr</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> sin_zero[<span class="hljs-number"><span class="hljs-number">8</span></span>]; };</code> </pre><br>  and we will incur additional costs for its completion.  In particular, this may be the cost of resolving ( <i>gethostbyname</i> ) and / or figuring out which side to break eggs ( <i>htons</i> ). <br><br>  Also, the sockets in the <i>AF_INET</i> domain, despite being accessed by localhost, ‚Äúdo not know‚Äù that they are running on the local system.  Thus, they do not make any effort to bypass the mechanisms of the network stack to increase performance.  Thus, we ‚Äúpay‚Äù for context switching, ACK, TCP flow control, routing, splitting large packets, etc.  That is, this is a ‚Äúfull TCP job‚Äù despite the fact that we are working on the local interface. <br><br>  In turn, the <i>AF_UNIX</i> sockets "realize" that they work within the same system.  They avoid efforts to install ip-headers, routing, calculation of checksums, etc.  In addition, once in the <i>AF_UNIX</i> domain, the file system is used as the address space, we get a bonus in the form of the ability to use file access rights and control access to them.  Thus, we can, without significant efforts, restrict access to sockets to processes and, again, do not incur costs for the security security stages. <br><br>  Let's test the theory in practice. <br>  I'm too lazy to write the server part, so I will use the same redis-server.  Its functionality is great for this and at the same time we will check whether the charges against him were fair.  Client parts we outline our own.  We will execute the simplest <i>INCR</i> command with O (1) complexity. <br>  Creating sockets is intentionally placed inside loops. <br>  TCP client: <br><div class="spoiler">  <b class="spoiler_title">AF_INET</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; #include &lt;netdb.h&gt; #include &lt;netinet/in.h&gt; #include &lt;string.h&gt; int main(int argc, char *argv[]) { int sockfd, portno, n; struct sockaddr_in serv_addr; struct hostent *server; char buffer[256]; if (argc &lt; 4) { fprintf(stderr,"usage %s hostname port count_req\n", argv[0]); exit(0); } portno = atoi(argv[2]); int i=0; int ci = atoi(argv[3]); for(i; i &lt; ci; i++) { sockfd = socket(AF_INET, SOCK_STREAM, 0); if (sockfd &lt; 0) { perror("ERROR opening socket"); exit(1); } server = gethostbyname(argv[1]); if (server == NULL) { fprintf(stderr,"ERROR, no such host\n"); exit(0); } bzero((char *) &amp;serv_addr, sizeof(serv_addr)); serv_addr.sin_family = AF_INET; bcopy((char *)server-&gt;h_addr, (char *)&amp;serv_addr.sin_addr.s_addr, server-&gt;h_length); serv_addr.sin_port = htons(portno); if (connect(sockfd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr)) &lt; 0) { perror("ERROR connecting"); exit(1); } char str[] = "*2\r\n$4\r\nincr\r\n$3\r\nfoo\r\n"; int len = sizeof(str); bzero(buffer, len); memcpy ( buffer, str, len ); n = write(sockfd, buffer, strlen(buffer)); if (n &lt; 0) { perror("ERROR writing to socket"); exit(1); } bzero(buffer,256); n = read(sockfd, buffer, 255); if (n &lt; 0) { perror("ERROR reading from socket"); exit(1); } printf("%s\n",buffer); close(sockfd); } return 0; }</span></span></span></span></code> </pre><br></div></div><br>  UNIX client: <br><div class="spoiler">  <b class="spoiler_title">AF_UNIX</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;string.h&gt; int main(int argc, char *argv[]) { int sockfd, portno, n; struct sockaddr_un serv_addr; struct hostent *server; char buffer[256]; if (argc &lt; 1) { fprintf(stderr,"usage %s count_req\n", argv[0]); exit(0); } int i=0; int ci = atoi(argv[1]); for(i; i &lt; ci; i++) { sockfd = socket(AF_UNIX, SOCK_STREAM, 0); if (sockfd &lt; 0) { perror("ERROR opening socket"); exit(1); } bzero((char *) &amp;serv_addr, sizeof(serv_addr)); serv_addr.sun_family = AF_UNIX; strcpy(serv_addr.sun_path, "/tmp/redis.sock"); if (connect(sockfd, (struct sockaddr*)&amp;serv_addr, sizeof(serv_addr)) &lt; 0) { perror("ERROR connecting"); exit(1); } char str[] = "*2\r\n$4\r\nincr\r\n$3\r\nfoo\r\n"; int len = sizeof(str); bzero(buffer, len); memcpy ( buffer, str, len ); n = write(sockfd, buffer, strlen(buffer)); if (n &lt; 0) { perror("ERROR writing to socket"); exit(1); } bzero(buffer,256); n = read(sockfd, buffer, 255); if (n &lt; 0) { perror("ERROR reading from socket"); exit(1); } printf("%s\n",buffer); close(sockfd); } return 0; }</span></span></span></span></code> </pre><br></div></div><br>  We test with one client: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># redis-cli set foo 0 ; time ./redistcp 127.0.0.1 6379 1000000 &gt; /dev/null ; redis-cli get foo OK 2.108u 21.991s 1:13.75 32.6% 9+158k 0+0io 0pf+0w "1000000" # redis-cli set foo 0 ; time ./redisunix 1000000 &gt; /dev/null ; redis-cli get foo OK 0.688u 9.806s 0:36.90 28.4% 4+151k 0+0io 0pf+0w "1000000"</span></span></code> </pre><br><br>  And now for twenty parallel clients sending 500,000 requests each. <br>  for TCP: <b>6: 12.86</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># redis-cli info Commandstats cmdstat_set:calls=1,usec=5,usec_per_call=5.00 cmdstat_incr:calls=10000000,usec=24684314,usec_per_call=2.47</span></span></code> </pre><br>  for UNIX: <b>4: 11.23</b> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># redis-cli info Commandstats cmdstat_set:calls=1,usec=8,usec_per_call=8.00 cmdstat_incr:calls=10000000,usec=22258069,usec_per_call=2.23</span></span></code> </pre><br><br>  Thus, in general, only mobility of the application and the possibility of simple scaling can serve as arguments in favor of TCP sockets.  But if you need to work within the same machine, then the choice, of course, in favor of UNIX-sockets.  Therefore, the choice between TCP and UNIX sockets is, first of all, the choice between portability and performance. <br><br>  On this, I propose to love Unix sockets, and leave the questions of dullness to the residents of Liliput and Blefusku. </div><p>Source: <a href="https://habr.com/ru/post/280668/">https://habr.com/ru/post/280668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280656/index.html">SQL Server 2014 Developer Edition is now free</a></li>
<li><a href="../280660/index.html">Traditional April 1 on the Internet</a></li>
<li><a href="../280662/index.html">CLRium # 3: .NET Technology Workshop</a></li>
<li><a href="../280664/index.html">8 harmful tips to "accelerate" the site</a></li>
<li><a href="../280666/index.html">NetApp ONTAP and NAS Antivirus Protection</a></li>
<li><a href="../280672/index.html">Attackers use a Linux / Remaiten bot to compromise embedded devices, part 2</a></li>
<li><a href="../280674/index.html">Quad-tree live visualization on Shader Model 2.0</a></li>
<li><a href="../280676/index.html">Unbelievable combinations of the Internet and real professions</a></li>
<li><a href="../280678/index.html">Mobile OCR. How it all began</a></li>
<li><a href="../280682/index.html">We can not pay so much money to PPA members</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>