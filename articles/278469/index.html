<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IoC: Another Scala implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is not about some kind of ready-made library (I‚Äôve been throwing in the implementation with tests for a couple of days, and I think it‚Äôs ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IoC: Another Scala implementation</h1><div class="post__text post__text-html js-mediator-article">  This article is not about some kind of ready-made library (I‚Äôve been throwing in the implementation with tests for a couple of days, and I think it‚Äôs easy for readers to do the same), but rather an attempt to present a new idea.  Which from my point of view looks quite interesting. <br><br>  One of the problems in developing any large project is the problem of dependencies.  Consisting of <br>  - where to get the necessary instance of the object, if it was created ‚Äúabove‚Äù, but is needed deep inside the hierarchy of method calls? <br>  - How to manage the receipt of this instance so that you can substitute other implementations?  First of all, relevant for tests <br>  - how to do it in such a way that any piece of code can be run without a long dance with a tambourine over the settings of the framework that implements step 1 and 2? <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To avoid accusations of cycling and other deadly sins, let me set out my idea of ‚Äã‚Äãgood code and good libraries.  If it does not match yours, please refrain from commenting.  In short: Libraries should either solve one complex, but specific task, or be small enough to make the study of sources easier than reading the documentation.  The frameworks are designed for people who are looking for some kind of magic so that it ‚Äúworks itself‚Äù.  If you have experience, it is more practical to write your own, customized for a specific task, for realizing, putting together the implementation from narrow, high-quality libraries, than to study the multi-megabyte source code of the framework written ‚Äúfor all‚Äù. <br><br>  I will not even consider Spring, the days when it was considered a lightweight alternative to J2EE are long gone.  I don‚Äôt understand the standard skal approach with static variables wrapped in `object`: untestable and difficult to configure.  Cake pattern suffers from the same drawbacks.  Remains Guice and similar libraries. <br><br>  What about Guice?  I adore Guice.  Almost non-intrusive, the configuration is modular and separated from the working code, the ability to replace individual objects during the initialization of the injector.  BUT: <br>  - by default, new objects are created by disposable, not singleton.  Who came up with it?  Who hasn't bothered to explicitly specify a scop each time? <br>  - reflexion.  It has a negative effect on the launch time of the application, which is very, very bad at the time of sbt-revolver. <br>  - composition and redefinition for modules are not made so conveniently. <br>  - Not Invented Here (joke) <br><br>  So the idea is to store the finished Injector in a ThreadLocal variable and use a static method to get an instance.  Like that: <br><br><div class="spoiler">  <b class="spoiler_title">Lot of code</b> <div class="spoiler_text"><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Marker interface for custom injector keys, useful to encode object type into the key. * * @tparam T type of object returned by this key */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InjectorKey</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">injector</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">-</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">main</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">used</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">injector</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stored</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">objects</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">directly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Injector</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Bind this injector to current thread. * @param func code that will be bound to this injector * @tparam T return type * @return value, returned by func */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">let</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](func: =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span>): <span class="hljs-type"><span class="hljs-type">T</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](classTag: <span class="hljs-type"><span class="hljs-type">ClassTag</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](key: <span class="hljs-type"><span class="hljs-type">Any</span></span>, classTag: <span class="hljs-type"><span class="hljs-type">ClassTag</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-comment"><span class="hljs-comment">/** * Initialize all known dependencies eagerly. Good for production mode and validation of dependencies. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eagerInit</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Injector</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>[depend] <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ThreadLocal</span></span>[<span class="hljs-type"><span class="hljs-type">Injector</span></span>]() <span class="hljs-comment"><span class="hljs-comment">/** * Get object instance by type. Fails if this type cannot be resolved to single instance * * @param classTag class tag * @tparam T type of value to return * @return value */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> classTag: <span class="hljs-type"><span class="hljs-type">ClassTag</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> = injector.getInstance(classTag).getOrElse { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">InjectorException</span></span>(<span class="hljs-string"><span class="hljs-string">"No instance registered for "</span></span> + classTag) } <span class="hljs-comment"><span class="hljs-comment">/** * Get object instance by type and some type-assisted key. Useful if you have multiple instances of the same type. * * @param key key, used to identify object * @param classTag class tag * @tparam T type of value to return * @return value */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](key: <span class="hljs-type"><span class="hljs-type">InjectorKey</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>])(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> classTag: <span class="hljs-type"><span class="hljs-type">ClassTag</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> = injector.getInstance(key, classTag).getOrElse { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">InjectorException</span></span>(<span class="hljs-string"><span class="hljs-string">"No instance registered for "</span></span> + classTag + <span class="hljs-string"><span class="hljs-string">", key="</span></span> + key) } <span class="hljs-comment"><span class="hljs-comment">/** * Get object instance by type and some key. Useful if you have multiple instances of the same type. * * @param key key, used to identify object * @param classTag class tag * @tparam T type of value to return * @return value */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](key: <span class="hljs-type"><span class="hljs-type">Any</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> classTag: <span class="hljs-type"><span class="hljs-type">ClassTag</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> = injector.getInstance(key, classTag).getOrElse { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">InjectorException</span></span>(<span class="hljs-string"><span class="hljs-string">"No instance registered for "</span></span> + classTag + <span class="hljs-string"><span class="hljs-string">", key="</span></span> + key) } <span class="hljs-comment"><span class="hljs-comment">/** * Return current injector * @return current injector or exception */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injector</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Injector</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> r = context.get() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IllegalStateException</span></span>(<span class="hljs-string"><span class="hljs-string">"There is no injector in current context. Forgot to run Injector.let for this thread?"</span></span>) } r } }</code> </pre> <br></div></div><br><br>  The implementation of the injector is a simple associative array [object type] -&gt; [lambda, returning an instance] plus the cache for singletons. <br><br>  In code that needs dependencies, use inject [Type] to get an object.  Of course, it is best to use it as the default value of the parameters of the constructor. <br><br>  What does this give? <br>  - if you need not a singleton, but an object, then you can create it simply through new MyClass (). <br>  - support for scopes is not needed - the current injector from ThreadLocal can be wrapped in a delegate that first requests objects from a session-level injector <br>  - no reflex <br>  - the injector can be used in domain objects!  I think this is great news for all lovers of stitching logic in a domain model. <br>  - In any place of the code (and especially tests!) You can easily replace the injector, getting the desired behavior <br><br>  Of course, it will take some refinement of the trapwords that are used by the application to forward Injector from the calling code to other threads, but this is not so difficult. <br><br><div class="spoiler">  <b class="spoiler_title">Tests, they are examples of use.</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InjectorTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FunSuite</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">Injector</span></span>.inject test(<span class="hljs-string"><span class="hljs-string">"basic query by type"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> i = <span class="hljs-type"><span class="hljs-type">Injector</span></span>.newModule() .bind[<span class="hljs-type"><span class="hljs-type">String</span></span>](<span class="hljs-string"><span class="hljs-string">"hello"</span></span>) .injector() i.let { assert(inject[<span class="hljs-type"><span class="hljs-type">String</span></span>] == <span class="hljs-string"><span class="hljs-string">"hello"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//no object of type Date intercept[InjectorException] { inject[Date] } //we have no keys intercept[InjectorException] { inject[String]("hello") } } } test("objects are singletons") { class A val i = Injector.newModule() .bind[Date](new Date()) .bind[A]("key")(new A) .injector() i.let { assert(inject[Date] eq inject[Date]) assert(inject[A]("key") eq inject[A]("key")) } } test("query by key works") { val i = Injector.newModule() .bind[Date]("key1")(new Date(1)) .bind[Date]("key2")(new Date(2)) .injector() i.let { assert(inject[Date]("key1") == new Date(1)) assert(inject[Date]("key2") == new Date(2)) intercept[InjectorException] { inject[String]("key1") } intercept[InjectorException] { inject[Date]("key3") } } } test("object cannot be bound twice") { intercept[InjectorException] { Injector.newModule() .bind[Date](new Date(0)) .bind[Date](new Date(1)) } } test("Binding with dependencies works") { class A class B case class C(a: A, b: B) val i = Injector.newModule() .bind[C](C(inject[A], inject[B])) .bind[A](new A) .bind[B](new B) .injector() i.let { assert(inject[C].a eq inject[A]) assert(inject[C].b eq inject[B]) } } test("Binding with cyclic dependencies does not work") { case class A(c: C) class B case class C(a: A, b: B) val i = Injector.newModule() .bind[C]{ C(inject[A], inject[B]) } .bind[A](A(inject[C])) .bind[B](new B) .injector() i.let { intercept[InjectorException] { inject[C] } } } test("modularization") { class A class B case class C(a: A, b: B) val m1 = Injector.newModule().bind[C](C(inject[A], inject[B])) val m2 = Injector.newModule() .bind[A](new A) .bind[B](new B) m1.injector().let { intercept[InjectorException] { inject[C] } } (m1 + m2).injector().let { inject[C] } } test("It is possible to inject primitive type") { val i = Injector.newModule() .bind[Int](42) .injector() i.let { assert(inject[Int] == 42) } } }</span></span></code> </pre><br></div></div><br><br>  What do you think? </div><p>Source: <a href="https://habr.com/ru/post/278469/">https://habr.com/ru/post/278469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278453/index.html">Adding a proxy to any application on IIS</a></li>
<li><a href="../278459/index.html">Cool sharing pages on social networks using Open Graph</a></li>
<li><a href="../278463/index.html">What you need to know when configuring the power of the ePMP 1000 transmitter from Cambium Networks</a></li>
<li><a href="../278465/index.html">Protection at all stages of cyber attack</a></li>
<li><a href="../278467/index.html">What is bad to be a full stack developer</a></li>
<li><a href="../278473/index.html">Vector graphics for free - selection of sites</a></li>
<li><a href="../278475/index.html">How we automate testing with release management - Part 2</a></li>
<li><a href="../278477/index.html">CSS cascading and specificity</a></li>
<li><a href="../278479/index.html">Photo tour of the "cloud" of 1cloud</a></li>
<li><a href="../278481/index.html">April 28 will be the fifth international mobile conference MBLT16</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>