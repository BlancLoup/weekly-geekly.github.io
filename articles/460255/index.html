<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backdoor on Node.js: why, why, and how it works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, colleagues from Yandex shared with us a sample of an interesting Trojan, as we reported in this news. This malware does not come across ofte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backdoor on Node.js: why, why, and how it works</h1><div class="post__text post__text-html js-mediator-article">  Recently, colleagues from Yandex shared with us a sample of an interesting Trojan, as we reported in <a href="https://news.drweb.ru/show/%3Fi%3D13315%26c%3D9%26lng%3Dru%26p%3D0">this</a> news.  This malware does not come across often, so we decided to take a closer look at it, and at the same time talk about why we rarely find such samples. <br><a name="habracut"></a><br>  The Trojan is a multi-component backdoor written in JavaScript that uses Node.js to run.  Its main elements are worker and updater, which are downloaded and installed into the system by the loader.  The payload can be any, but in this case the Trojan is installed by the miner xmrig.  At the time of the study, the developer used the miner for the mining of cryptocurrency TurtleCoin. <br><br>  MonsterInstall is distributed through sites with cheats for popular video games.  Most of these resources belong to the Trojan’s developer, but we have found several more infected files on other similar sites.  The owner of one of them regularly monitors updates of competitors and replenishes its resource with fresh content.  For this, he uses the parser.php script, which through a proxy is looking for new cheats on cheathappens.com. <br><br><pre><code class="plaintext hljs">Proxy parse done, total: 1 Use sox 84.228.64.133:1080 Error: CURL error(#52), attempts left: 10 Use sox 84.228.64.133:1080 Posts found: 30! [33mPage Satisfactory: ўЂµ№ЅµЂ +8 vCL#96731 {CheatHappens.com} already in base[0m [33mPage Borderlands: The Pre-Sequel - ўЂµ№ЅµЂ +28 v1.2019 {LinGon} already in base[0m [33mPage Borderlands - Game of the Year Enhanced: ўЂµ№ЅµЂ +19 v1.0.1 {LinGon} already in base[0m [33mPage Star Wars: Battlefront 2 (2017): ўЂµ№ЅµЂ +4 v01.04.2019 {MrAntiFun} already in base[0m [36mPage Far Cry 5: ўЂµ№ЅµЂ +23 v1.012 (+LOST ON MARS/DEAD LIVING ZOMBIES) {CheatHappens.com} added 2019-Apr-09[0m [36mPage Fate/Extella Link: ўЂµ№ЅµЂ +13 v04.09.2019 {CheatHappens.com} added 2019-Apr-09[0m [36mPage Superhot: ўЂµ№ЅµЂ +3 v2.1.01p { MrAntiFun} added 2019-Apr-09[0m [36mPage Dawn of Man: ўЂµ№ЅµЂ +7 v1.0.6 {CheatHappens.com} added 2019-Apr-08[0m [36mPage Borderlands 2: ўЂµ№ЅµЂ +14 v06.04.2019 {MrAntiFun} added 2019-Apr-08[0m [36mPage Borderlands: The Pre-Sequel - ўЂµ№ЅµЂ +17 v06.04.2019 {MrAntiFun} added 2019-Apr-08[0m [36mPage Tropico 6: ўЂµ№ЅµЂ +9 v1.01 {MrAntiFun} added 2019-Apr-08[0m [36mPage Operencia: The Stolen Sun - ўЂµ№ЅµЂ +20 v1.2.2 {CheatHappens.com} added 2019-Apr-08[0m [36mPage Enter the Gungeon: ўЂµ№ЅµЂ +6 v2.1.3 {MrAntiFun} added 2019-Apr-07[0m [36mPage The Guild 3: ўЂµ№ЅµЂ +2 v0.7.5 {MrAntiFun} added 2019-Apr-07[0m [36mPage Dead Effect 2: ўЂµ№ЅµЂ +8 v190401 {MrAntiFun} added 2019-Apr-07[0m [36mPage Assassin's Creed: Odyssey - ўЂµ№ЅµЂ +26 v1.2.0 {FLiNG} added 2019-Apr-07[0m [36mPage Assassin's Creed: Odyssey - ўЂµ№ЅµЂ +12 v1.2.0 {MrAntiFun} added 2019-Apr-06[0m [36mPage Super Dragon Ball Heroes: World Mission - ўЂµ№ЅµЂ +11 v1.0 {FLiNG} added 2019-Apr-05[0m [36mPage Tropico 6: ўЂµ№ЅµЂ +7 v1.02 97490 {CheatHappens.com} added 2019-Apr-05[0m [36mPage Risk of Rain 2: ўЂµ№ЅµЂ +10 Build 3703355 {CheatHappens.com} added 2019-Apr-05[0m [36mPage Sid Meier's Civilization 6 - Rise and Fall: ўЂµ№ЅµЂ +12 v1.0.0.314 {MrAntiFun} added 2019-Apr-05[0m [36mPage Sid Meier's Civilization 6 - Gathering Storm: ўЂµ№ЅµЂ +12 v1.0.0.314 {MrAntiFun} added 2019-Apr-05[0m [36mPage Sid Meier's Civilization 6: ўЂµ№ЅµЂ +12 v1.0.0.314 {MrAntiFun} added 2019-Apr-05[0m [36mPage Borderlands GOTY Enhanced: ўЂµ№ЅµЂ +16 v1.0 {CheatHappens.com} added 2019-Apr-05[0m [36mPage Borderlands Game of the Year Enhanced: ўЂµ№ЅµЂ +13 v1.00 {MrAntiFun} added 2019-Apr-04[0m [36mPage Assassin's Creed: Odyssey: ўЂµ№ЅµЂ +24 v1.2.0 (04.04.2019) {CheatHappens.com} added 2019-Apr-04[0m [36mPage Sekiro: Shadows Die Twice - ўЂµ№ЅµЂ +24 v1.02 {FLiNG} added 2019-Apr-04[0m [36mPage Hearts of Iron 4: ўЂµ№ЅµЂ +24 v1.6.2 {MrAntiFun} added 2019-Apr-04[0m [36mPage Wolcen: Lords of Mayhem - ўЂµ№ЅµЂ +5 v1.0.2.1 {MrAntiFun} added 2019-Apr-04[0m [36mPage Devil May Cry 5: ўЂµ№ЅµЂ +18 v1.0 (04.03.2019) {CheatHappens.com} added 2019-Apr-04[0m Parse done</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the developer's sites - a large selection of cheats, but for all the links will be given the same archive.  If you try to download any of the files from the malware site, the user will receive a Trojan.MonsterInstall.  Some parameters of the Trojan can be guessed from the download link: <br><br><pre> <code class="plaintext hljs">https://&lt;malicious_site&gt;/fc/download.php?name=Borderlands%20GOTY%20Enhanced:%20%D0%A2%D1%80%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%20+16%20v1.0%20{CheatHappens.com}&amp;link=https://&lt;malicious_site&gt;//r.php?site=http://gtrainers.com/load/0-0-1-7081-20&amp;password=&lt;malicious_site&gt;/&amp;uid=101&amp;sid1=1&amp;sid2=1&amp;charset=utf-8</code> </pre><br><ul><li>  name - the name of the archive and exe in the archive; </li><li>  link - link to the file that the user wanted to download (sewn into data.json); </li><li>  password - archive password. </li></ul><br>  Let's say we chose the right cheat and downloaded a 7zip archive with a promising name “ExtrimHack.rar” from the developer’s website of the Trojan’s developer.  Inside it are the executable file, the configuration file, the 7zip library, and the bin-archive with the native C ++ libraries and scripts run using the Node.js binary. <br><br>  An example of the contents of the archive: <br><br><ul><li>  7z.dll; </li><li>  data.bin; </li><li>  data.json; </li><li>  ESP cheat for CS GO.exe. </li></ul><br><br>  When launching the executable file, the Trojan will install all the components necessary for its operation, and will also download the cheat needed by the user, using information from the data.json file with parameters. <br><br>  An example of the contents of data.json: <br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"source"</span></span>:[<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">43</span></span>],<span class="hljs-string"><span class="hljs-string">"dataVersion"</span></span>:[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">115</span></span>],<span class="hljs-string"><span class="hljs-string">"link"</span></span>:<span class="hljs-string"><span class="hljs-string">"http:\/\/clearcheats.ru\/images\/dl\/csgo\/ESP_csgo.dll"</span></span>}</code> </pre><br><br>  In order to exclude the work of several copies of its process, the Trojan creates a mutex "cortelMoney-suncMutex" and is installed in the directory "% WINDIR% \ WinKit \".  It then checks if it is in the registry ([HKLM \\ Software \\ Microsoft \\ Windows Node]).  If so, it reads its parameters and compares the version with the one specified in data.json.  If the version is up to date, nothing further does and ends. <br><br>  After that, the Trojan unpacks the contents of data.bin to% WINDIR% \\ WinKit \\ and installs the service to start start.js. <br><br>  Content data.bin: <br><ul><li>  Daemon; </li><li>  node_modules; </li><li>  7z.dll; </li><li>  msnode.exe; </li><li>  start.js; </li><li>  startDll.dll; </li><li>  update.js; </li><li>  updateDll.dll. </li></ul><br>  At the same time, msnode.exe is the Node.js executable file with a valid digital signature, and the node_modules directory contains the ffi, node-windows and ref libraries. <br><br>  In start.js, the startDll.dll library is loaded and its export is called mymain, in which it reads its parameters from the registry, starts "% WINDIR% \\ WinKit \\ msnode% WINDIR% \\ WinKit \\ update.js" and stops the service "Windows Node".  The update.js script, in turn, loads the updateDll.dll library and invokes its export mymain.  Nothing complicated. <br><br>  In updateDll.dll, the Trojan will start to check the internet connection.  To do this, he will send requests to google.com, yahoo.com, facebook.com every 10 seconds until all three return the 200 code.  Then it sends to the <a href="http://s44571fu/">s44571fu</a> [.] Bget [.] En / CortelMoney / enter.php POST server a request with configuration data: <br><br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"login"</span></span>:<span class="hljs-string"><span class="hljs-string">"NULL"</span></span>,<span class="hljs-string"><span class="hljs-string">"mainId"</span></span>:<span class="hljs-string"><span class="hljs-string">"PPrn1DXeGvUtzXC7jna2oqdO2m?WUMzHAoM8hHQF"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"NULL"</span></span>,<span class="hljs-string"><span class="hljs-string">"source"</span></span>:[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>],<span class="hljs-string"><span class="hljs-string">"updaterVersion"</span></span>:[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>],<span class="hljs-string"><span class="hljs-string">"workerVersion"</span></span>:[<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]}</code> </pre> <br><br>  In this case, for the basic authorization, the pair “cortel: money” is used, and the User-Agent is set up with “USER AGENT”.  For the basic authorization of subsequent requests will be used login: password, which will inform the server. <br><br>  The server responds with a json of the following form: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"login"</span></span>: <span class="hljs-string"><span class="hljs-string">"240797"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"tdzjIF?JgEG5NOofJO6YrEPQcw2TJ7y4xPxqcz?X"</span></span>, <span class="hljs-string"><span class="hljs-string">"updaterVersion"</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">115</span></span>], <span class="hljs-string"><span class="hljs-string">"updaterLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"http:\/\/s44571fu.bget.ru\/CortelMoney\/version\/0-0-0-115-upd.7z"</span></span>, <span class="hljs-string"><span class="hljs-string">"workerVersion"</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">"workerLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"http:\/\/s44571fu.bget.ru\/CortelMoney\/version\/0-0-3-0-work.7z"</span></span> }</code> </pre> <br><br>  As you can see, the server’s response indicates the versions of the main elements of the Trojan.  If the current version of the updater on the user's device is older than that reported by the server, the Trojan downloads the file at the specified link and unpacks the archive into the "% WINDIR% \\ WinKit \\\\" directory, where the value of the updaterVersion parameter from the server response will be specified . <br><br>  The Trojan unpacks the worker file to the% WINDIR% \\ WinKit \\ SystemNode \\ directory, and then launches the "% WINDIR% \\ WinKit \\ SystemNode \\ sysnode% WINDIR% \\ WinKit \\ SystemNode \\ main.js". <br><br>  Contents of the archive with the worker: <br><ul><li>  node_modules; </li><li>  7za.exe; </li><li>  codex; </li><li>  main.js; </li><li>  sysnode.exe. </li></ul><br>  The Trojan then deletes the Windows Node Guard service, and then creates it again, replacing the executable file with the Windows Node service file.  In the same way, it recreates the “Windows Node” service, replacing the executable file with daemon \\ service.exe. <br><br>  Next it forms service.xml with parameters: <br><pre> <code class="javascript hljs">&lt;service&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">id</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">service.exe</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">id</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">executable</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">C:\Windows\\WinKit\0.0.0.115\msnode.exe</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">executable</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">arguments</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">"C:\Windows\\WinKit\0.0.0.115\start.js"</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">arguments</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">service</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  Updater is installed in the “C: \ Windows \ Reserve Service” directory, prescribed by the service and launched with the Node.js binary.  It also consists of several js scripts and native C ++ libraries.  The main module is main.js. <br><br>  Content archive with updater: <br><ul><li>  main.js; </li><li>  start.js; </li><li>  crypto.dll; </li><li>  network.dll; </li><li>  service.exe. </li></ul><br>  First of all, the Trojan finds out the current date by sending a request to google.com, yandex.ru or <a href="http://www.i.ua/">www.i.ua.</a>  He uses the received information a bit later.  Then, using the crypto.dll library, it decrypts the contents of the bootList.json file. <br><br>  Decryption algorithm: <br><pre> <code class="javascript hljs">key = <span class="hljs-string"><span class="hljs-string">'123'</span></span> s = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(d)): s += chr((ord(d[i]) - ord(key[i % len(key)])) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>)</code> </pre><br><br>  Receives a list of management servers from there: <br><pre> <code class="javascript hljs">[{<span class="hljs-string"><span class="hljs-string">"node"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://cortel8x.beget.tech/reserve"</span></span>,<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>},{<span class="hljs-string"><span class="hljs-string">"node"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://reserve-system.ru/work"</span></span>,<span class="hljs-string"><span class="hljs-string">"weight"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>}]</code> </pre> <br><br>  Then the trojan reads information from the registry: <br><pre> <code class="plaintext hljs">function getInfo() { var WindowsNodeInfo = new Object(); WindowsNodeInfo.mainId = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "mainId"); WindowsNodeInfo.login = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "log"); WindowsNodeInfo.password = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "pass"); WindowsNodeInfo.source = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "source"); WindowsNodeInfo.updaterVersion = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "updaterVersion"); WindowsNodeInfo.workerVersion = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Windows Node", "workerVersion"); var ReserveSystemInfo = new Object(); ReserveSystemInfo.workerVersion = windowsLib.getStringRegKey("HLM\\SOFTWARE\\Microsoft\\Reserve System", "updaterVersion"); var myInfo = new Object(); myInfo.windowsNode = WindowsNodeInfo; myInfo.reserveSystem = ReserveSystemInfo; return JSON.stringify(myInfo); }</code> </pre><br>  Then it adds the HTTP header of the basic authorization corresponding to the pair “cortel: money”, and sends it by a POST request to the previously decrypted managing server. <br>  In response, the server receives: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"data"</span></span>: { <span class="hljs-string"><span class="hljs-string">"updaterVersion"</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"updaterLink"</span></span>: <span class="hljs-string"><span class="hljs-string">"/upd.7z"</span></span>, <span class="hljs-string"><span class="hljs-string">"updaterVerify"</span></span>: <span class="hljs-string"><span class="hljs-string">"£ñß(\u0012Ä\ti¾$ë5ž»\u001c²\u001c\fÙ=±÷ö‚´èUnŽÐÂBÔ\n\u001dW6?u½\u0005Œn\u000fp:üÍ\u0019\u0000\u000bSý«\u00137÷\u0013”'ì¥û§s7F\u0016ó\\\u000f%6ñê\"7î&lt;ýoäƒƒ0Æ%t ñÅv‚S¡\r\u001e•ÅÆ¡¿N)v\\f8\u0004F\fUS¯‰³§ oIõŒiÆîGÝª\u0017êH/8Ö1-°™[P 5E7X‡Fø%S ŠXÕ6Oþ=Vô‰…ˆ:.3Œ‚i\u000eÁù9Ã&amp;¾ŒM\u001eÛªé$\u0006#IèÞÛ\u0018À\u001b^è,ÁòÑCTXb\u001d$ç\u0004„ð¶0UVÕ»e\u001f\b\u001e¡Ä¼è+Fjúÿoâz\r !çô3xØs—_\u000b\u0017\u001fY]\u0001¥j^û\\W"</span></span>, <span class="hljs-string"><span class="hljs-string">"dateTime"</span></span>: <span class="hljs-number"><span class="hljs-number">1534868028000</span></span>, <span class="hljs-string"><span class="hljs-string">"bootList"</span></span>: [{ <span class="hljs-string"><span class="hljs-string">"node"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://cortel8x.beget.tech/reserve/"</span></span>, <span class="hljs-string"><span class="hljs-string">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> }, { <span class="hljs-string"><span class="hljs-string">"node"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://reserve-system.ru/work/"</span></span>, <span class="hljs-string"><span class="hljs-string">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> }] }, <span class="hljs-string"><span class="hljs-string">"dataInfo"</span></span>: <span class="hljs-string"><span class="hljs-string">"I`ù@ÀP'ÈcÊÛ´#iè Ò~\u0007&lt;\u0001Ýìûl«ÔÆq\u0013àÛ\u0003\b\u0017ÑLÁ}ÿÚ˜DS']\u0003bf\u0003!¿Cð¸q¸ÖÜ'B¢CÄAMˆÀA¤d\u001c5¨d -\u0013‰\u0011Ñ¼F'|SB[¬°(Ü¹ÈÒÜ £L\u00071¾:`\u001bŒìýKõ\"²Ÿ¸$´3™UºÅ¨J†¨cƒf¿}r;Öeì¶x‰ØKt¥‹„47a\u001e¸Ô‡ˆy\u0006•\u001b\u0004‚‹„„•ó\u001a\u0019\nu&gt;¨)bkæ…'\u00127@é‹7µæy3ÈNrS'Mð‡\u0018\u0019¾òÓ[Žå5H‡ƒ·¦k'¿ÉŠ&amp;PÂÈîåÚ~M\u0010ðnáHæ“ªxÃv c×“\u0013…T…ïÑÝ\tœŽ\u0018†Æ\u00148$”Ôî"</span></span> }</code> </pre><br><br>  And here the current date received earlier is useful.  The Trojan compares it with the dataTime parameter sent by the server.  If the difference between the dates is more than a week (in millisecond terms), the Trojan will not execute commands.  Also, the dataInfo parameter contains the data signature (data field), it is checked using the public key sewn into main.js.  And the “bootList” parameter contains a list of servers that the Trojan encrypts and stores in “bootList.json”. <br><br>  After that, the Trojan compares its version with the one specified in the updaterVersion parameter.  If the installed version is not lower than the latest one, the Trojan launches "upd \\ upd.exe", passing it through the "main.js" parameter.  If the version from the server response is newer, then the Trojan downloads the updater archive with the update from the “updaterLink” parameter, checks its signature and unpacks it.  Then it writes the update version of the [HKLM \\ SOFTWARE \\ Microsoft \\ Reserve System] 'updaterVersion' to the registry, after which it launches again “upd \\ upd.exe”, passing it through the “main.js” parameter. <br><br>  The Trojan Worker verifies that the components have already been installed, and makes decisions about the need to install applications.  First, it creates a MoonTitleWorker mutex, then decrypts the codeX file XOR with the string “xor” and executes it.  After that forms json with information: <br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"userId"</span></span>: id, <span class="hljs-string"><span class="hljs-string">"starter"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"worker"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"source"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"osInfo"</span></span>: {<span class="hljs-string"><span class="hljs-string">"isX64"</span></span>: True, <span class="hljs-string"><span class="hljs-string">"osString"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Enterprise"</span></span>}}</code> </pre><br>  This information is sent by a POST request to http: // &lt;malicious_site&gt; [.] Xyz: 1001 / getApps (for the sake of decency, we do not specify a domain name, but you can find it <a href="https://github.com/DoctorWebLtd/malware-iocs/tree/master/Trojan.MonsterInstall">here</a> .) The server response may contain information about the applications that need to be installed. <br><br>  Sample answer: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"apps"</span></span>: [{ <span class="hljs-string"><span class="hljs-string">"hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"452f8e156c5c3206b46ea0fe61a47b247251f24d60bdba31c41298cd5e8eba9a"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">8137466</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">"link"</span></span>: <span class="hljs-string"><span class="hljs-string">"xmr-1-64.7z"</span></span>, <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"%pf%\\Microsoft JDX\\64"</span></span>, <span class="hljs-string"><span class="hljs-string">"runComand"</span></span>: <span class="hljs-string"><span class="hljs-string">"%path%\\moonlight.exe start.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"xmr64"</span></span> }] }, <span class="hljs-string"><span class="hljs-string">"head"</span></span>: <span class="hljs-string"><span class="hljs-string">"O~¨^Óå+ßzIçsG¬üS„Ê¶$êL–LùÎ¸Z\f\u0019ÐÐ\u000e \u0004\u001cÀU¯\u0011š)áUÚ\u001flß²A\u001fôÝÔìˆ±y%\"DP» ^¯«FUâ\u001cÔû\u001dµ´Jï#¬ÌÈ¹ÎÚª?\r—]Yj·÷õ³—\u001e°ÖÒ\\é‰¤d'BT\u0019·¦FõVQ°Aç')\u001cõªµ¦ýûHlbÍ¸þ}éŒ\u0000jvÔ%S;Ã×þA\u0011ß'I[´\u0004ýÚ\u0007Z:ZÂ\n–ñz#ÈBö›²2\u0007ÎJw±èTVoŸå\bÖR3½ù;ƒó\u0011ÉÌ€ÅÖàð06ÓeÕþˆ”7Ùš\u0011•»”˜¢5µgôÛc˜&amp;L\u000fê.?!Çæ}¨\u001eÕ—J#A¼_Ì\u0015càñb"</span></span> }</code> </pre><br>  If there is no such application on the device, the Trojan downloads it by sending a POST request to the URL http: // &lt;malicious_site&gt; [.] Xyz: 1001 /, where the value of the link parameter for the corresponding application from the server response will be indicated instead.  If there is such an application, but an older version, it is updated to the latest. <br><br>  The Trojan checks the size and hash of the downloaded file with the information specified by the server in the "hash" and "size" parameters.  If the data converges, it moves the file along the path from the “path” parameter and runs the command specified in the “runCommand” field.  Information about the downloaded application is saved in the registry [HKLM \\ SOFTWARE \\ Microsoft \\ MoonTitle \\ apps \\]. <br><br>  At the moment, with the help of a backdoor, the miner xmrig is put.  Depending on the system capacity, the Trojan downloads an xmr-1.7z or xmr-1-64.7z archive.  In start.js it loads the xmrig.dll library and calls the export mymain, where it expands its environment variables and kills the processes: <br><ul><li>  % sys32_86% \ xmr; </li><li>  % sys32_86% \ xmr64; </li><li>  % pf_86% \\ Microsoft JDX \\ 32 \\ windows-update.exe; </li><li>  % pf_86% \\ Microsoft JDX \\ 64 \\ windows-update.exe. </li></ul><br>  If xmrig.exe is located next to it, the Trojan loads it into the memory of the current process, erases the MZ signature, decrypts it using XOR with 0x39, and then saves its dump in the dump file.  If the Trojan finds the file “dump” in the same directory, then it decrypts it in the same way, starts windows-update.exe and embeds the decrypted payload into it. <br><br>  The Trojan collects and sends a POST request to the URL: <a href="http://cherry-pot/">cherry-pot</a> [.] Top / RemoteApps / xmr / main.php the following system information: {"action": "enter", "architecture": "INTEL", "cpuAES" : true, "cpuCache": 8192, "cpuSpeed": 3392.0, "cpuThreads": 2, "cpuVendorString": "Intel® Core (TM) i5-4690S CPU @ 3.20GHz \ u0000", "hightPages": false, " login ":" null "," password ":" null "," ramPhysicalSize ": 3071," xmrigVersion ": [2,10,0]} <br><br>  In response, the server sends the miner configuration: <br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"maxCpuLoad"</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-string"><span class="hljs-string">"minCpuLoad "</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"algo"</span></span>:<span class="hljs-string"><span class="hljs-string">"cryptonight-pico/trtl"</span></span>,<span class="hljs-string"><span class="hljs-string">"av"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"background"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-string"><span class="hljs-string">"donate-level"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"max-cpu-usage"</span></span>:<span class="hljs-number"><span class="hljs-number">75</span></span>,<span class="hljs-string"><span class="hljs-string">"retries"</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">"retry-pause"</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-string"><span class="hljs-string">"cpu-priority"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"pools"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">"185.224.133.91:5511"</span></span>,<span class="hljs-string"><span class="hljs-string">"keepalive"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"nicehash"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>}]}</code> </pre> <br>  After the Trojan saves the configuration in config.json, it will automatically start and start mining. <br><br>  MonsterInstall has other modifications.  For example, besides cheats for games, the developer Malvari distributed it under the guise of the installer of the Chrome browser and the program for checking files.  In later versions of the Trojan, the developer thought about security and added string encryption, as well as the need to enter a password for some files.  In addition, in the bootloader of one of the versions of the Trojan, there is even a link to the license agreement located on the developer’s domain of the Trojan. <br><br>  (Questions about the legal validity of such agreements, unfortunately, are beyond the scope of this article, but if you would be interested to read material on this topic, let us know in the comments). <br><br>  <b>findings</b> <br><br>  Node.js is not the most practical solution for virus writers.  If the size of such a Trojan can be small, the Node.js binding (executable file and libraries) will be much “heavier” than the standard Malvar.  What dictated this choice?  As a rule, developers choose tools with which they are well acquainted.  Therefore, even in the case of employees, the choice of technology is more a matter of personal preference.  However, Node.js has its advantages, one of which is a valid signature.  In the system, such a process will be signed as Node.js, which is rarely suspicious. <br><br>  Summing up, it can be noted that, despite the interesting choice of tools, this did not give the backdoor developer any significant advantage.  It is unlikely that in the future we will see more malware using Node.js. <br><br>  As usual, we share <a href="https://github.com/DoctorWebLtd/malware-iocs/tree/master/Trojan.MonsterInstall">indicators of compromise</a> . </div><p>Source: <a href="https://habr.com/ru/post/460255/">https://habr.com/ru/post/460255/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460247/index.html">Recipes for ELFs</a></li>
<li><a href="../460249/index.html">The solution to the task with pwnable.kr 07 - input. Understanding pwntools</a></li>
<li><a href="../46025/index.html">Revival of the legend: we put the OS on Libretto 50 CT</a></li>
<li><a href="../460251/index.html">Artificial Stupidity: the bot that did not help me</a></li>
<li><a href="../460253/index.html">10 reasons to make your skill for voice assistant</a></li>
<li><a href="../460257/index.html">Hello, World! Deep immersion in terminals</a></li>
<li><a href="../46026/index.html">XNA + C # vs DirectX + C ++ v OpenGL. What's better? And why?</a></li>
<li><a href="../460261/index.html">Amazon: 25 years of success in e-commerce</a></li>
<li><a href="../460263/index.html">Making a really smart search: step by step guide</a></li>
<li><a href="../460265/index.html">Creating an Xcode Project Template</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>