<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JIT-enabled Qemu.js: minced meat can still be turned back</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few years ago, Fabrice Bellard wrote jslinux , a PC emulator written in JavaScript. After that there was at least Virtual x86 . But all of them, as ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JIT-enabled Qemu.js: minced meat can still be turned back</h1><div class="post__text post__text-html js-mediator-article"><p>  A few years ago, Fabrice Bellard <a href="https://habrahabr.ru/post/119424/">wrote jslinux</a> , a PC emulator written in JavaScript.  After that there was at least <a href="https://habrahabr.ru/post/198192/">Virtual x86</a> .  But all of them, as far as I know, were interpreters, while written much earlier by the same Fabrice Bellar Qemu, and, probably, any modern emulator respecting itself, uses JIT compilation of the guest code into the host system code.  It seemed to me that the time was right to implement the inverse problem in relation to the one that the browsers decide: JIT-compile the machine code in JavaScript, for which the most logical was to port Qemu.  It would seem, why Qemu, there are more simple and user-friendly emulators - the same VirtualBox, for example - set up and running.  But Qemu has some interesting features. </p><br><ul><li>  open source </li><li>  ability to work without a kernel driver </li><li>  ability to work in interpreter mode </li><li>  support a large number of both host and guest architectures </li></ul><br><p>  At the expense of the third point, now I can already explain that in fact in the TCI mode not the guest machine instructions themselves are interpreted, but the bytecode derived from them, but this does not change the essence - to build and run Qemu on a new architecture, if you're lucky enough compiler C - writing code generator can be postponed. </p><br><p>  And so, after two years of leisurely picking the Qemu source codes in my spare time, a working prototype appeared in which Kolibri OS, for example, can be launched. </p><a name="habracut"></a><br><h1 id="chto-takoe-emscripten">  What is Emscripten? </h1><br><p>  Nowadays, there are many compilers, the final result of which is JavaScript.  Some, such as Type Script, were originally conceived as the best way to write for the web.  At the same time, Emscripten is a way to take existing code in C or C ++, and compile it into a form that is understandable to the browser.  On <a href="https://github.com/kripken/emscripten/wiki/Porting-Examples-and-Demos">this page,</a> many ports of well-known programs are collected: <a href="http://pypyjs.org/">here</a> , for example, you can look at PyPy - by the way, it is claimed, they already have a JIT.  In fact, not any program can be simply compiled and run in the browser - there are a number of <a href="http://kripken.github.io/emscripten-site/docs/porting/guidelines/index.html">features</a> that you have to put up with, however, as the inscription on the same page reads: "C / C ++ code to JavaScript" .  That is, there are a number of operations that are undefined behavior by the standard, but usually work on x86 ‚Äî for example, unaligned access to variables, which is generally prohibited on some architectures.  In general, Qemu is a cross-platform program, and I wanted to believe, and so does not contain a lot of undefined behavior - take it and compile it, then tinker a little with JIT - and go!  But it was not there... </p><br><h1 id="pervaya-popytka">  First try </h1><br><p>  Generally speaking, I am not the first who came up with the idea of ‚Äã‚Äãporting Qemu to JavaScript.  The ReactOS forum asked if this was possible with Emscripten.  Earlier there were rumors that Fabrice Bellard did it personally, but it was jslinux, which, as far as I know, is just an attempt to manually achieve sufficient performance on JS, and is written from scratch.  Later, Virtual x86 was written - nefuscated source code was uploaded to it, and, as it was stated, a great "realism" of emulation allowed using SeaBIOS as firmware.  In addition, there was at least one attempt to port Qemu using Emscripten - the <a href="https://habrahabr.ru/users/socketpair/" class="user_link">socketpair</a> tried to do <a href="https://habrahabr.ru/users/socketpair/" class="user_link">this</a> , but the development, as I understand it, was frozen. </p><br><p>  So, it would seem, here are the sources, here is Emscripten - take it and compile it.  But there are also libraries on which Qemu depends, and libraries on which those libraries depend, etc., and one of them is <a href="https://github.com/libffi/libffi">libffi</a> , on which glib depends.  There were rumors on the Internet that there was also a large collection of ports of libraries under Emscripten, but it was somehow hard to believe: first, it was not going to be a new compiler, secondly, it‚Äôs too low-level library to just take, and compile in js.  And the matter is not even only in assembler inserts - probably, if you pervert, then for some calling conventions you can form the necessary arguments on the stack without them and call the function.  Here is just Emscripten - the trick is tricky: to make the generated code look familiar to the browser's JS engine optimizer, some tricks are used.  In particular, the so-called relooping, the code generator, based on the received LLVM IR with some abstract transition instructions, attempts to recreate plausible if-s, cycles, etc.  Well, the arguments in the function are passed as?  Naturally, as arguments of JS-functions, that is whenever possible not through a stack. </p><br><p> At the beginning, the idea was to simply write a replacement for libffi on JS and run off regular tests, but in the end I got confused about how to make my own header files so that they work with existing code - what can we do, as they say, "Whether the tasks are so complicated whether we are so stupid. "  I had to port libffi to another architecture, so to speak - fortunately, Emscripten has both macros for inline assembly (in javascript, yeah - well, what architecture, such an assembler), and the ability to run the code generated on the fly.  In general, after fiddling with libffi platform-specific snippets for a while, I got some compiling code, and drove it away on the first test I got.  To my surprise, the test was successful.  Ofigev from his genius - it‚Äôs a joke, it worked from the first launch - I, still not believing my eyes, useful to look again at the resulting code, evaluate where to dig further.  Here I again ofigel - the only thing that my <code>ffi_call</code> function <code>ffi_call</code> was that it was reporting a successful call.  The call itself was not.  So I sent my first pull request, correcting an error in the test that any olympiadian could understand - real numbers should not be compared as <code>a == b</code> and even as <code>a - b &lt; EPS</code> - the module should not be forgotten, otherwise 0 will turn out to be very equal to 1 / 3 ... In general, I got a port libffi, which passes the most simple tests, and with which glib is compiled - I decided it will be necessary, then I will add.  Looking ahead I‚Äôll say that, as it turned out, the compiler didn‚Äôt even include the compiler in the final code of the libffi function. </p><br><p>  But, as I have already said, there are some limitations, and among the free use of various indefinite behaviors, a more unpleasant feature has been added: JavaScript by design does not support multi-threading with shared memory.  In principle, this can usually be called a good idea, but not for porting code whose architecture is tied to sishnyh streams.  Generally speaking, there are experiments in support of shared workers in Firefox, and the implementation of pthread for them in Emscripten is present, but did not want to depend on it.  It was necessary to slowly uproot multithreading from the Qemu code ‚Äî that is, to find out where the threads are started, to carry out the body of the loop running in this thread into a separate function, and call such functions one by one from the main loop. </p><br><h1 id="vtoraya-popytka">  Second try </h1><br><p>  At some point, it became clear that things are still there, and that the unsystematic pushing of crutches along the code will not lead to good.  Conclusion: we must somehow systematize the process of adding crutches.  Therefore, the latest version 2.4.1 was taken at that time (not 2.5.0, because, you never know, there are still not caught bugs of the new version, and I will have enough of my bugs), and the first thing was safely rewritten <code>thread-posix.c</code> .  Well, that is, how safe: if someone tried to perform an operation leading to blocking, the <code>abort()</code> function was called immediately ‚Äî of course, this did not solve all problems at once, but at least it was somehow nicer than quietly getting inconsistency data. </p><br><p>  In general, the Emscripten <code>-s ASSERTIONS=1 -s SAFE_HEAP=1</code> options help in porting code to JS - they catch some kinds of undefined behavior like calls to an unaligned address (which is completely inconsistent with the code for typed arrays like <code>HEAP32[addr &gt;&gt; 2] = 1</code> ) or a function call with an incorrect number of arguments. </p><br><p>  By the way, alignment errors are a separate topic.  As I said before, Qemu has a ‚Äúdegenerate‚Äù interpretive TCI code generation (tiny code interpreter) interpreter, and to build and run Qemu on a new architecture, if it's lucky, the C compiler is enough. The keywords <strong>‚Äúif you are lucky‚Äù</strong> .  I was not lucky, and it turned out that TCI uses non-aligned access when parsing its bytecode.  That is, on everyones ARM and other architectures with necessarily aligned access, Qemu is compiled because there is a normal TCG backend generating the native code for them, and whether TCI will work for them is another question.  However, as it turned out, something similar was clearly indicated in the documentation for TCI.  As a result, calls to functions for non-aligned reading that were found in another part of Qemu were added to the code. </p><br><h1 id="razrushenie-kuchi">  Heap destruction </h1><br><p>  As a result, the unaligned access to the TCI was corrected, the main loop was made, in turn calling the processor, RCU and something trivial.  And now I run Qemu with the <code>-d exec,in_asm,out_asm</code> option <code>-d exec,in_asm,out_asm</code> , meaning that I need to say which blocks of code are executed, and write at the time of the broadcast what guest code was, what host code became (in this case, bytecode).  It starts, executes several translation blocks, writes a debug message left by me that RCU will now start and ... crashes on <code>abort()</code> inside the <code>free()</code> function.  By picking up the <code>free()</code> function, we managed to find out that the header of the heap block, which lies in eight bytes, preceding the allocated memory, instead of block size or something like that, turned out to be garbage. </p><br><p>  Heap destruction is so nice ... In this case, there is a useful tool - from (if possible) the same source code, compile the native binary and run it under Valgrind.  After a while the binary was ready.  I launch it with the same options - it crashes on initialization, before reaching, in fact, execution.  It's unpleasant, of course - you see, the source was not exactly the same, which is not surprising, because configure has explored several other options, but I also have Valgrind - I will fix this bug first, and then, if I'm lucky, the initial one will appear.  I run all the same thing under Valgrind ... Yyyyy, yyy, uh-uh, it started, initialization passed normally and went further by the source bug without a single warning about incorrect memory access, not to mention about the falls.  For such a life, as they say, I did not prepare for this - the falling program stops falling when it starts up under valgrind.  What it was was a mystery.  My hypothesis is that once in the vicinity of the current instruction after crashing when initializing gdb, it showed that the <code>memset</code> worked with a valid pointer using either <code>mmx</code> or <code>xmm</code> registers, then maybe it was some kind of alignment error, although it‚Äôs still hard to believe . </p><br><p>  OK, Valgrind here does not seem to be an assistant.  And here the most disgusting thing began - everything, it seems, even starts, but falls for absolutely unknown reasons due to an event that could have happened millions of instructions back.  For a long time, even approaching it was not clear how.  In the end, I still had to sit down and debug.  Printing what the title was rewritten showed that this is not like a number, but rather some kind of binary data.  And, about a miracle, this binary line was found in the file with bios - that is, now it was possible to say with sufficient confidence that it was a buffer overflow, and it is even clear that this buffer was recorded.  Well, then somehow - in Emscripten, fortunately, there is no randomization of the address space, there are no holes in it either, so you can write somewhere in the middle of the code the output of data on the pointer from the last launch, look at the data, look at the pointer, and if that has not changed, get information for consideration.  True, a couple of minutes are spent on linking after any change, but what can you do.  As a result, a specific string was found, copying the BIOS from the temporary buffer to the guest memory - and, indeed, there was not enough space in the buffer.  Searching for the source of that strange buffer address resulted in the <code>qemu_anon_ram_alloc</code> function in the <code>oslib-posix.c</code> - the logic was there: sometimes it can be useful to align the address on a huge 2Mb page, for this we will ask <code>mmap</code> first a little more, and then we will return the excess to using <code>munmap</code> .  And if such alignment is not required, then instead of 2 MB, we specify the result of <code>getpagesize()</code> - <code>mmap</code> will still output the aligned address ... So, in Emscripten, <code>mmap</code> simply calls <code>malloc</code> , and that, of course, does not align the page.  In general, the bug that had upset me for a couple of months, was corrected by a change in <strong>two</strong> lines. </p><br><h1 id="osobennosti-vyzova-funkciy">  Features of the function call </h1><br><p>  And now the processor thinks something, Qemu does not fall, but the screen does not turn on, and the processor quickly goes in cycles, judging by the conclusion <code>-d exec,in_asm,out_asm</code> .  A hypothesis appeared: the timer interrupts do not come (well, or in general, all interrupts).  And indeed, if from a native assembly, which for some reason worked, to unscrew the interrupts, you get a similar picture.  But the solution turned out to be completely different: a comparison of the traces issued with the above option showed that the execution paths diverge very early.  Here it must be said that comparing the debugging output recorded with the <code>emrun</code> with the output of the native assembly is not quite a mechanical process.  I don‚Äôt know exactly how the program launched in the browser connects with <code>emrun</code> , but some lines in the output are swapped, so the difference in differential is not a reason to assume that the trajectories diverged.  In general, it became clear that according to the <code>ljmpl</code> instruction, a transition occurs at different addresses, and the baytcode generates fundamentally different: in one there is an instruction to call the sishnaya helper function, in the other - not.  After googling instructions and examining the code that transmits these instructions, it became clear that, firstly, immediately before it, a record was made in the <code>cr0</code> register ‚Äî also with the help of a helper --- that takes the processor to a protected mode, and secondly, js-version in a protected mode has not switched.  But the fact is that another feature of Emscripten is a reluctance to tolerate code like the implementation of a <code>call</code> instruction in TCI, which leads to a type of <code>long long f(int arg0, .. int arg9)</code> type of any function pointer - functions must be called with the correct number of arguments.  If this rule is violated, depending on the debugging settings, the program will either crash (which is good), or it will not call that function at all (which will be debugging sadly).  There is also a third option - to enable the generation of wrappers that add / discard arguments, but in total these wrappers take up quite a lot of space, despite the fact that in fact I only need a little more than a hundred wrappers.  This alone is very sad, but it turned out to be a more serious problem: in the generated code of the wrapper functions, the arguments were converted-converted, only the function with the generated arguments was sometimes not called ‚Äî well, just like in my implementation of libffi.  That is, some helpers are simply not executed. </p><br><p>  Fortunately, in Qemu there are machine-readable lists of helpers in the form of a header file like </p><br><pre> <code class="hljs lisp">DEF_HELPER_0(<span class="hljs-name"><span class="hljs-name">lock</span></span>, void) DEF_HELPER_0(<span class="hljs-name"><span class="hljs-name">unlock</span></span>, void) DEF_HELPER_3(<span class="hljs-name"><span class="hljs-name">write_eflags</span></span>, void, env, tl, i32)</code> </pre> <br><p>  They are used quite funny: first, the <code>DEF_HELPER_n</code> macros are redefined in the most bizarre way, and then helper.h is <code>helper.h</code> .  Up to the point that the macro is expanded into a structure initializer and a comma, and then an array is defined, and instead of elements - <code>#include &lt;helper.h&gt;</code> As a result, the reason finally came to try the <a href="https://habrahabr.ru/post/239081/">pyparsing</a> library, and a script was generated that generates exactly those wrappers exactly for those functions for which it is needed. </p><br><p>  And so, after that, the processor seems to be working.  It seems to be because the screen was never initialized, although it was possible to start memtest86 + in the native build.  Here it is necessary to clarify that the Qemu block I / O code is written in coroutines.  Emscripten has a very intricate implementation, but it still needed to be supported in Qemu code, and you can debug the processor right now: Qemu supports the <code>-kernel</code> , <code>-initrd</code> , <code>-append</code> , with which you can load Linux or, for example, memtest86 +, in general not using block devices.  But here's the ill luck: in the native build, it was possible to observe the output of the Linux kernel to the console with the <code>-nographic</code> option, and from the browser no output to the terminal from which the <code>emrun</code> was launched did not come.  That is, it is not clear: the processor does not work or graphics output.  And then it occurred to me to wait a bit.  It turned out that "the processor is not sleeping, but just blinks slowly," and after about five minutes the kernel threw out a stack of messages on the console and went to hang on.  It became clear that the processor, in general, works, and you need to dig in the code to work with SDL2.  Unfortunately, I don‚Äôt know how to use this library, so I had to act at random in places.  At some point on the screen flashed a line parallel0 on a blue background, which led to some thoughts.  As a result, it turned out that the case was that Qemu opens several virtual windows in one physical window, between which you can switch by Ctrl-Alt-n: in the native assembly it works, in Emscripten it is not.  After getting rid of unnecessary windows using the options <code>-monitor none -parallel none -serial none</code> and instructions to force the redrawing of the entire screen on each frame, everything suddenly worked. </p><br><h1 id="korutiny">  Korutiny </h1><br><p>  So, the emulation in the browser works, but nothing interesting single-disk in it can not be run, because there is no block I / O - you need to implement support for korutin.  In Qemu, there are already several coroutine backends, but due to the peculiarities of JavaScript and the Emscripten code generator, one cannot simply start juggling with stacks.  It would seem, "usyo was gone, the cast was removed," but the Emscripten developers have already taken care of everything.  This is implemented quite funny: let's call a suspicious function call like <code>emscripten_sleep</code> and several others using Asyncify, as well as pointer calls and calls to any function where one of the previous two cases may occur below.  And now, before each suspicious call, we select the async context, and immediately after the call, we check whether an asynchronous call has occurred, and if it has, save all local variables in this async context, indicate which function to transfer control to when we need to continue execution , and quit the current function.  This is where the scope for exploring the effect of <a href="https://habrahabr.ru/post/245333/">clearing up</a> is - for the needs of continuing to execute code after returning from an asynchronous call, the compiler generates functions "chipping" that start after a suspicious call - like this: if there are n suspicious calls, then the function will be rattled somewhere in 2 times is still if not to consider that it is necessary to add saving of a part of local variables after each potentially asynchronous call to the initial function.  Subsequently, I even had to write a simple Python script, which, given a set of especially diluted functions, which supposedly "do not let asynchrony through themselves" (that is, they do not trigger stack promotion and everything that I just described), indicates calls through pointers in which functions should be ignored by the compiler so that these functions are not considered as asynchronous.  And then the JS-files for 60 MB is already obviously overkill - even if it is at least 30. Although, once I set up the build script, and accidentally threw out the linker options, among which was <code>-O3</code> .  I run the generated code, and Chromium fats out the memory and crashes.  I then accidentally looked at what he was trying to download ... Well, what can I say, I would also be hung up if I were asked to carefully study and optimize javascript for 500+ MB. </p><br><p>  Unfortunately, the checks in the Asyncify support library code were not exactly friendly with the longjmps, which are used in the virtual processor code, but after a small patch that disables these checks and forcibly restores contexts as if everything was fine, the code worked.  And then a strange thing started: sometimes checks in the synchronization code were triggered - the ones that abnormally terminate the code, if, according to the execution logic, it should be blocked - someone tried to capture the already captured mutex.  Fortunately, this was not a logical problem in the serialized code - I just used the regular main loop functionality provided by Emscripten, but sometimes the asynchronous call fully expanded the stack, and at that moment <code>setTimeout</code> from the main loop worked - the code would go into the iteration of the main loop without leaving the previous iteration.  I rewrote <code>emscripten_sleep</code> on an infinite loop, and problems with mutexes stopped.  The code has become even more logical - after all, in fact, I don‚Äôt have some code that prepares the next frame of the animation - the processor just counts something and the screen is periodically updated.  However, the problems did not stop there: sometimes Qemu execution was just silently completed without any exceptions or errors.  At that moment I scored on it, but, looking ahead, I will say that the problem was this: the code of corutin, in fact, does not use <code>setTimeout</code> at all (well, or at least not as often as you might think): function <code>emscripten_yield</code> simply sets the asynchronous call flag.  The whole <code>emscripten_coroutine_next</code> is that <code>emscripten_coroutine_next</code> not an asynchronous function: it checks the box inside, resets it, and passes control to the right place.  That is, on her stack promotion ends.  The problem was that due to use-after-free, which manifested itself when the coruntine pool was disabled, because I did not copy the important line of code from the existing coroutine backend, the <code>qemu_in_coroutine</code> function returned true, when in fact it should return false.  This led to the <code>emscripten_yield</code> call, above which there was no <code>emscripten_coroutine_next</code> stack, the stack was deployed to the very top, but no <code>setTimeout</code> , as I said, was set. </p><br><h1 id="kodogeneraciya-javascript">  JavaScript code generation </h1><br><p>  But, in fact, the promised "turning the stuffing back."  Not really.  Of course, if you run Qemu in the browser, and Node.js in it, then, naturally, after code generation in Qemu, we will get completely different JavaScript.  But still, some kind of inverse transformation. </p><br><p>  First, a little about how Qemu works.  Immediately I ask you to forgive me: I am not a professional developer of Qemu and my conclusions may be erroneous in places.  , "       ,     ".  Qemu             <code>target-i386</code> .        ,       .     ,   ,     Qemu,  TCG (Tiny Code Generator)       .    readme-,    tcg,       C,     JIT. , , target architecture     ‚Äî    ,   .  -      ‚Äî Tiny Code Interpreter (TCI),     (    )       .   ,     ,         ,  JIT-      ,   .   ,     . </p><br><p>      TCG backend,            ,     TCI.     : </p><br><ul><li>          ,     </li><li>         ,  ,     </li><li>      ( , -, ,     ,   patch)      JS-,      ,     </li></ul><br><p>      ,     ,       ,      . </p><br><p>       switch     ,  ,    Emscripten,   JS  relooping,     ,  ,   ,        ‚Äî   .  ‚Äî ,     ,    if- (   ).   ,  ,    ,    -  .          <code>brcond</code> . ,             ‚Ä¶      ,     assert-   .   ,   ,  ,   switch-        , ,   JavaScript-.    .            ,   ,     .  ,        TB,   ,     TB   ,     .       "   ,      ?" ‚Äî     ,     . ,      Chromium (  Firefox        ),  Firefox       asm.js,        . </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="javascript hljs">Compiling <span class="hljs-number"><span class="hljs-number">0x15b46d0</span></span>: CompiledTB[<span class="hljs-number"><span class="hljs-number">0x015b46d0</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stdlib, ffi, heap</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-string"><span class="hljs-string">"use asm"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAP8 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Int8Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAP16 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Int16Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAP32 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Int32Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAPU8 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Uint8Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAPU16 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Uint16Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HEAPU32 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdlib.Uint32Array(heap); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dynCall_iiiiiiiiiii = ffi.dynCall_iiiiiiiiiii; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getTempRet0 = ffi.getTempRet0; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> badAlignment = ffi.badAlignment; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _i64Add = ffi._i64Add; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _i64Subtract = ffi._i64Subtract; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Math_imul = ffi.Math_imul; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _mul_unsigned_long_long = ffi._mul_unsigned_long_long; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> execute_if_compiled = ffi.execute_if_compiled; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getThrew = ffi.getThrew; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> abort = ffi.abort; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_ub = ffi.qemu_ld_ub; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_leuw = ffi.qemu_ld_leuw; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_leul = ffi.qemu_ld_leul; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_beuw = ffi.qemu_ld_beuw; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_beul = ffi.qemu_ld_beul; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_beq = ffi.qemu_ld_beq; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_ld_leq = ffi.qemu_ld_leq; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_b = ffi.qemu_st_b; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_lew = ffi.qemu_st_lew; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_lel = ffi.qemu_st_lel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_bew = ffi.qemu_st_bew; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_bel = ffi.qemu_st_bel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_leq = ffi.qemu_st_leq; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> qemu_st_beq = ffi.qemu_st_beq; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tb_fun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tb_ptr, env, sp_value, depth</span></span></span><span class="hljs-function">) </span></span>{ tb_ptr = tb_ptr|<span class="hljs-number"><span class="hljs-number">0</span></span>; env = env|<span class="hljs-number"><span class="hljs-number">0</span></span>; sp_value = sp_value|<span class="hljs-number"><span class="hljs-number">0</span></span>; depth = depth|<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u0 = <span class="hljs-number"><span class="hljs-number">0</span></span>, u1 = <span class="hljs-number"><span class="hljs-number">0</span></span>, u2 = <span class="hljs-number"><span class="hljs-number">0</span></span>, u3 = <span class="hljs-number"><span class="hljs-number">0</span></span>, result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r0 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r1 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r2 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r3 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r4 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r5 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r6 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r7 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r8 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r9 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r10 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r11 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r12 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r13 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r14 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r15 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r16 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r17 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r18 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r19 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r20 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r21 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r22 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r23 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r24 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r25 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r26 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r27 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r28 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r29 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r30 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r31 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r41 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r42 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r43 = <span class="hljs-number"><span class="hljs-number">0</span></span>, r44 = <span class="hljs-number"><span class="hljs-number">0</span></span>; r14 = env|<span class="hljs-number"><span class="hljs-number">0</span></span>; r15 = sp_value|<span class="hljs-number"><span class="hljs-number">0</span></span>; START: <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { r0 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">-4</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; r42 = <span class="hljs-number"><span class="hljs-number">0</span></span>; result = ((r0|<span class="hljs-number"><span class="hljs-number">0</span></span>) != (r42|<span class="hljs-number"><span class="hljs-number">0</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445321</span></span>] = r14; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result|<span class="hljs-number"><span class="hljs-number">0</span></span>) { HEAPU32[<span class="hljs-number"><span class="hljs-number">1445322</span></span>] = r15; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x0345bf93</span></span>|<span class="hljs-number"><span class="hljs-number">0</span></span>; } r0 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">16</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; r42 = <span class="hljs-number"><span class="hljs-number">8</span></span>; r0 = ((r0|<span class="hljs-number"><span class="hljs-number">0</span></span>) - (r42|<span class="hljs-number"><span class="hljs-number">0</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">16</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r0; r1 = <span class="hljs-number"><span class="hljs-number">8</span></span>; HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">44</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r1; r1 = r0|<span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">40</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r1; r42 = <span class="hljs-number"><span class="hljs-number">4</span></span>; r0 = ((r0|<span class="hljs-number"><span class="hljs-number">0</span></span>) + (r42|<span class="hljs-number"><span class="hljs-number">0</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>; r2 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">24</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445308</span></span>] = r1; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445309</span></span>] = r2; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445321</span></span>] = r14; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445322</span></span>] = r15; qemu_st_lel(env|<span class="hljs-number"><span class="hljs-number">0</span></span>, r0|<span class="hljs-number"><span class="hljs-number">0</span></span>, r2|<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">22759218</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(getThrew() | <span class="hljs-number"><span class="hljs-number">0</span></span>) abort(); r0 = <span class="hljs-number"><span class="hljs-number">3241038392</span></span>; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; r0 = qemu_ld_leul(env|<span class="hljs-number"><span class="hljs-number">0</span></span>, r0|<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">22759233</span></span>)|<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(getThrew() | <span class="hljs-number"><span class="hljs-number">0</span></span>) abort(); HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">24</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r0; r1 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">12</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; r2 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">40</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445308</span></span>] = r1; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445309</span></span>] = r2; qemu_st_lel(env|<span class="hljs-number"><span class="hljs-number">0</span></span>, r2|<span class="hljs-number"><span class="hljs-number">0</span></span>, r1|<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">22759265</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(getThrew() | <span class="hljs-number"><span class="hljs-number">0</span></span>) abort(); r0 = HEAPU32[((r14 + (<span class="hljs-number"><span class="hljs-number">24</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] | <span class="hljs-number"><span class="hljs-number">0</span></span>; HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">40</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r0; r1 = <span class="hljs-number"><span class="hljs-number">24</span></span>; HEAPU32[(r14 + (<span class="hljs-number"><span class="hljs-number">52</span></span>)) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>] = r1; r42 = <span class="hljs-number"><span class="hljs-number">0</span></span>; result = ((r0|<span class="hljs-number"><span class="hljs-number">0</span></span>) == (r42|<span class="hljs-number"><span class="hljs-number">0</span></span>))|<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result|<span class="hljs-number"><span class="hljs-number">0</span></span>) { HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445308</span></span>] = r1; } HEAPU32[<span class="hljs-number"><span class="hljs-number">1445307</span></span>] = r0; HEAPU32[<span class="hljs-number"><span class="hljs-number">1445308</span></span>] = r1; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> execute_if_compiled(<span class="hljs-number"><span class="hljs-number">22759392</span></span>|<span class="hljs-number"><span class="hljs-number">0</span></span>, env|<span class="hljs-number"><span class="hljs-number">0</span></span>, sp_value|<span class="hljs-number"><span class="hljs-number">0</span></span>, depth|<span class="hljs-number"><span class="hljs-number">0</span></span>) | <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> execute_if_compiled(<span class="hljs-number"><span class="hljs-number">23164080</span></span>|<span class="hljs-number"><span class="hljs-number">0</span></span>, env|<span class="hljs-number"><span class="hljs-number">0</span></span>, sp_value|<span class="hljs-number"><span class="hljs-number">0</span></span>, depth|<span class="hljs-number"><span class="hljs-number">0</span></span>) | <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); abort(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>|<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-attr"><span class="hljs-attr">tb_fun</span></span>: tb_fun}; }(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>, CompilerFFI, Module.buffer)[<span class="hljs-string"><span class="hljs-string">"tb_fun"</span></span>]</code> </pre> </div></div><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p> ,     ,          .     ,  .   ,   ,    ,   . ,        -    Qemu.         :    -  ""      . ,      ‚Äî   <code>git log</code> . </p><br><p>     <a href="https://atrosinenko.github.io/qemujs-demo"></a> (, ). </p><br><p>    : </p><br><ul><li>    x86 </li><li>    JIT-     JavaScript </li><li>      32-  :                MIPS </li></ul><br><p>     </p><br><ul><li>  .    JIT  , , ,  Virtual x86 (    Qemu       ) </li><li>    ‚Äî -  ,  ,  ,      Emscripten,   </li><li>      Qemu ‚Äî ,  VM  .. </li><li> <strong>UPD:</strong>      Emscripten     -,      Qemu   .    ,         Emscripten    . </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/315770/">https://habr.com/ru/post/315770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315760/index.html">React Testing</a></li>
<li><a href="../315762/index.html">Crowd funding will help develop an ATX motherboard for IBM's Power8</a></li>
<li><a href="../315764/index.html">7 Tips for Unity Indie Game Localization</a></li>
<li><a href="../315766/index.html">Microsoft SQL Server for Linux: a bridge between the worlds of Linux and Windows</a></li>
<li><a href="../315768/index.html">Dart Developer Summit 2016: Top Dart News</a></li>
<li><a href="../315772/index.html">React.js State of the art (interview with Max Stoiber)</a></li>
<li><a href="../315774/index.html">Here tuk open</a></li>
<li><a href="../315776/index.html">KPI for the elite, or business consultants against small business</a></li>
<li><a href="../315778/index.html">Implementing DMARC to protect your corporate domain from spoofing</a></li>
<li><a href="../315780/index.html">ASP.NET Core: Your first Mac application using Visual Studio Code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>