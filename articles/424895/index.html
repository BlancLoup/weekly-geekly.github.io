<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Designing Types: How to make invalid states ineffable</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to you the translation of the article Scott Wlaschin "Designing with types: Making illegal states unrepresentable" . 


 In this article, we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Designing Types: How to make invalid states ineffable</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>I present to you the translation of the article Scott Wlaschin <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/">"Designing with types: Making illegal states unrepresentable"</a> .</em> </p><br><p>  In this article, we will look at the key advantage of F # - the ability to ‚Äúmake invalid states ineffable‚Äù using a type system (a phrase borrowed from <a href="https://blog.janestreet.com/effective-ml-revisited/">Yaron Minsky</a> ). </p><br><p> Consider the type of <code>Contact</code> .  As a result of the <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-single-case-dus/">refactoring,</a> it became much simpler: </p><br><pre> <code class="plaintext hljs">type Contact = { Name: Name; EmailContactInfo: EmailContactInfo; PostalContactInfo: PostalContactInfo; }</code> </pre> <br><p>  Now suppose that there is a simple business rule: "A contact must contain an email address or postal address."  Does our type fit this rule? </p><br><p>  Not.  It follows from the rule that the contact may contain an e-mail address, but not have a postal address, or vice versa.  However, in its current form, the type requires that both fields be filled. </p><br><p>  It seems the answer is obvious - make the addresses optional, for example, like this: </p><br><pre> <code class="plaintext hljs">type Contact = { Name: PersonalName; EmailContactInfo: EmailContactInfo option; PostalContactInfo: PostalContactInfo option; }</code> </pre> <br><p>  But now our type allows too much.  In this implementation, you can create a contact without an address at all, although the rule requires that at least one address be specified. </p><br><p>  How to solve this problem? </p><a name="habracut"></a><br><h1 id="kak-sdelat-nekorrektnye-sostoyaniya-nevyrazimymi">  How to make invalid states ineffable </h1><br><p>  Having considered the rule of business logic, we can conclude that there are three possible cases: </p><br><ul><li>  only the email address is listed; </li><li>  only the mailing address is indicated; </li><li>  both the email address and the mailing address are listed. </li></ul><br><p>  In this formulation, the solution becomes obvious - to make a type-sum with a constructor for each possible case. </p><br><pre> <code class="plaintext hljs">type ContactInfo = | EmailOnly of EmailContactInfo | PostOnly of PostalContactInfo | EmailAndPost of EmailContactInfo * PostalContactInfo type Contact = { Name: Name; ContactInfo: ContactInfo; }</code> </pre> <br><p>  This implementation is fully compliant.  All three cases are expressed explicitly, while the fourth case (without any address) is not allowed. </p><br><p>  Note the case of "email address and postal address".  For now, I just used a tuple.  In this case, that's enough. </p><br><h2 id="sozdanie-contactinfo">  Creating <code>ContactInfo</code> </h2><br><p>  Now let's see how to use this implementation with an example.  First, create a new contact: </p><br><pre> <code class="plaintext hljs">let contactFromEmail name emailStr = let emailOpt = EmailAddress.create emailStr //          match emailOpt with | Some email -&gt; let emailContactInfo = {EmailAddress=email; IsEmailVerified=false} let contactInfo = EmailOnly emailContactInfo Some {Name=name; ContactInfo=contactInfo} | None -&gt; None let name = {FirstName = "A"; MiddleInitial=None; LastName="Smith"} let contactOpt = contactFromEmail name "abc@example.com"</code> </pre> <br><p>  In this example, we create a simple helper function <code>contactFromEmail</code> to create a new contact, passing in the name and email address.  However, the address may be incorrect, and the function must handle both of these cases.  The function cannot create a contact with an incorrect address, so it returns a value of type <code>Contact option</code> , not Contact. </p><br><h2 id="izmenenie-contactinfo">  Change <code>ContactInfo</code> </h2><br><p>  If you need to add a mailing address to an existing <code>ContactInfo</code> , you will have to handle three possible cases: </p><br><ul><li>  if the contact had only an email address, then now he has both addresses, so you need to return the contact to the <code>EmailAndPost</code> constructor; </li><li>  if the contact only had a mailing address, you must return the contact to the <code>PostOnly</code> designer, replacing the mailing address with a new one; </li><li>  if the contact had both addresses, you must return the contact with the <code>EmailAndPost</code> constructor, replacing the mailing address with a new one. </li></ul><br><p>  The auxiliary function for updating the mailing address is as follows.  Note the explicit handling for each case. </p><br><pre> <code class="plaintext hljs">let updatePostalAddress contact newPostalAddress = let {Name=name; ContactInfo=contactInfo} = contact let newContactInfo = match contactInfo with | EmailOnly email -&gt; EmailAndPost (email,newPostalAddress) | PostOnly _ -&gt; //     PostOnly newPostalAddress | EmailAndPost (email,_) -&gt; //     EmailAndPost (email,newPostalAddress) //    {Name=name; ContactInfo=newContactInfo}</code> </pre> <br><p>  This is how the use of this code looks like: </p><br><pre> <code class="plaintext hljs">let contact = contactOpt.Value //      option.Value  let newPostalAddress = let state = StateCode.create "CA" let zip = ZipCode.create "97210" { Address = { Address1= "123 Main"; Address2=""; City="Beverly Hills"; State=state.Value; //      option.Value  Zip=zip.Value; //      option.Value  }; IsAddressValid=false } let newContact = updatePostalAddress contact newPostalAddress</code> </pre> <br><p>  <em>WARNING: In this example, I used <code>option.Value</code> to get the contents of the option.</em>  <em>This is valid when you experiment in an interactive console, but this is a terrible solution for working code!</em>  <em>You must always use <a href="https://docs.microsoft.com/ru-ru/dotnet/fsharp/language-reference/pattern-matching">pattern matching</a> and handle both <code>option</code> constructors.</em> </p><br><h1 id="zachem-zamorachivatsya-etimi-slozhnymi-tipami">  Why bother with these complex types? </h1><br><p>  By this time you could decide that we were all too complicated.  I will answer with three theses. </p><br><p>  First, business logic is complex in itself.  There is no easy way to avoid this.  If your code is simpler than business logic, you do not handle all cases as it should. </p><br><p>  Secondly, if logic is expressed by types, then it is self-documented.  You can look at the type-sum constructors below and immediately understand the business rule.  You do not have to spend time analyzing any other code. </p><br><pre> <code class="plaintext hljs">type ContactInfo = | EmailOnly of EmailContactInfo | PostOnly of PostalContactInfo | EmailAndPost of EmailContactInfo * PostalContactInfo</code> </pre> <br><p>  Finally, if the logic is expressed by type, then any changes to the rules of business logic will break the code that does not take into account these changes, and this is usually good. </p><br><p>  The last point is revealed in the <a href="https://fsharpforfunandprofit.com/posts/designing-with-types-discovering-the-domain/">next article</a> .  Trying to express the rules of business logic through types, you can come to an in-depth understanding of the subject area. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/424895/">https://habr.com/ru/post/424895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424881/index.html">Newtoo - development of a full browser engine from scratch in 2018?</a></li>
<li><a href="../424887/index.html">What Lida is silent about: the beginning of a developer's career. Principles or how to become Middl'om</a></li>
<li><a href="../424889/index.html">Looking inside the Intel 8087 coprocessor</a></li>
<li><a href="../424891/index.html">Identify fraud using Enron dataset. Part 1, data preparation and selection of marks</a></li>
<li><a href="../424893/index.html">The craftsman created a WiFi module for Macintosh SE / 30, 1989 models</a></li>
<li><a href="../424897/index.html">Unexpected meeting. Chapter 18</a></li>
<li><a href="../424899/index.html">What to listen about audio equipment: 15 podcasts</a></li>
<li><a href="../424901/index.html">The digest of interesting materials for the mobile developer # 272 (September 24 - September 30)</a></li>
<li><a href="../424905/index.html">Developing a hexapod from scratch (part 2) - build</a></li>
<li><a href="../424907/index.html">Conference DEFCON 22. GTVHacker Group. Breaking it all: 20 devices in 45 minutes. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>