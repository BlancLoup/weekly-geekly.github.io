<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to RELIABLY protect in-app purchase from scrapers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, I wrote an article How to protect in-App Purchase from scrapers . It took a little time, but hackers do not sit in place. That method o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to RELIABLY protect in-app purchase from scrapers</h1><div class="post__text post__text-html js-mediator-article">  Most recently, I wrote an article <a href="http://habrahabr.ru/post/143738/">How to protect in-App Purchase from scrapers</a> .  It took a little time, but hackers do not sit in place.  That method of protection turns out to be circumvented, not very difficult.  Under the cut method, which is much more reliable. <br><a name="habracut"></a><br>  Before reading this topic, I recommend reading the previous one. <a href="http://habrahabr.ru/post/143738/">How to protect in-App Purchase from scrapers</a> , since this is a continuation of the topic. <br><br>  In my application, after verification, the receipt is sent to my server, and I analyze it there, and save it in the logs.  And I noticed that the JSON that comes is standard, and some modified. <br>  Standard looks like this: <br><pre><code class="objectivec hljs">{ <span class="hljs-string"><span class="hljs-string">"receipt"</span></span>: { <span class="hljs-string"><span class="hljs-string">"original_purchase_date_pst"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-06-08 04:13:04 America/Los_Angeles"</span></span>, <span class="hljs-string"><span class="hljs-string">"purchase_date_ms"</span></span>: <span class="hljs-string"><span class="hljs-string">"1339153984956"</span></span>, <span class="hljs-string"><span class="hljs-string">"original_transaction_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"430000009214053"</span></span>, <span class="hljs-string"><span class="hljs-string">"original_purchase_date_ms"</span></span>: <span class="hljs-string"><span class="hljs-string">"1339153984956"</span></span>, <span class="hljs-string"><span class="hljs-string">"app_item_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"12312312323"</span></span>, <span class="hljs-string"><span class="hljs-string">"transaction_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"430000009214053"</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"bvrs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"version_external_identifier"</span></span>: <span class="hljs-string"><span class="hljs-string">"7809437"</span></span>, <span class="hljs-string"><span class="hljs-string">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzz"</span></span>, <span class="hljs-string"><span class="hljs-string">"product_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzz.uuuuuu"</span></span>, <span class="hljs-string"><span class="hljs-string">"purchase_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-06-08 11:13:04 Etc/GMT"</span></span>, <span class="hljs-string"><span class="hljs-string">"purchase_date_pst"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-06-08 04:13:04 America/Los_Angeles"</span></span>, <span class="hljs-string"><span class="hljs-string">"original_purchase_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-06-08 11:13:04 Etc/GMT"</span></span>, <span class="hljs-string"><span class="hljs-string">"item_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"123123123"</span></span> }, <span class="hljs-string"><span class="hljs-string">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br><br>  As a result, I noticed 3 types of hacking attempts: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. The most frequent option.  Brokerage does not fake the response of the Apple server, as a result of receipt looks like this: <br><pre> <code class="objectivec hljs">{ <span class="hljs-string"><span class="hljs-string">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">21002</span></span>, <span class="hljs-string"><span class="hljs-string">"exception"</span></span>: <span class="hljs-string"><span class="hljs-string">"java.lang.ClassCastException"</span></span> }</code> </pre><br>  Our previous method coped with such hacking, because the status = 21002 <br><br>  2. More recently, new ways of hacking.  I don‚Äôt know with what utilities this is done, but they fake the response of the Apple servers to the second request. <br>  JSON looks like this then: <br><pre> <code class="objectivec hljs">{ <span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre><br>  Such hacking is simple.  You can check the presence of some variables, for example ‚Äúproduct_id‚Äù, and everything will fall into place. <br><br>  3. But not everything is so simple.  Recently, another version of forged JSON has appeared: <br><pre> <code class="objectivec hljs">{ <span class="hljs-string"><span class="hljs-string">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"receipt"</span></span>: { <span class="hljs-string"><span class="hljs-string">"product_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzzz.uuuuuuu"</span></span>, <span class="hljs-string"><span class="hljs-string">"purchase_date"</span></span>: <span class="hljs-number"><span class="hljs-number">1339152660.383128</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"transaction_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzzz.uuuuuuu"</span></span> } }</code> </pre><br>  If you check something again, then you need to find something that the messaging program cannot get from the request.  After reviewing all the data, I realized that there is a fairly simple way, which will be very difficult to get around. <br>  You need to check for ‚Äúitem_id‚Äù - this is the id that Apple assigns to each product, including the in-app purchase.  You can view it in iTunesConnect by clicking on the ‚ÄúManage In-App Purchases‚Äù button. <br><br>  Then our code will look like this: <br><br><pre> <code class="objectivec hljs">kFeature1 = <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzzz.uuuuuuu"</span></span>; kFeatureItemID1 = <span class="hljs-string"><span class="hljs-string">"123123123"</span></span>; kFeature2 = <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzzz.uuuuuuu"</span></span>; kFeatureItemID2 = <span class="hljs-string"><span class="hljs-string">"123123123"</span></span>; kFeature3 = <span class="hljs-string"><span class="hljs-string">"xx.yyyyyy.zzzzzzzz.uuuuuuu"</span></span>; kFeatureItemID3 = <span class="hljs-string"><span class="hljs-string">"123123123"</span></span>; - (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)verifyReceipt:(<span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span>*)receiptData { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *urlsting = <span class="hljs-string"><span class="hljs-string">@"https://buy.itunes.apple.com/verifyReceipt"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> *url = [<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> URLWithString:urlsting]; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableURLRequest</span></span> *theRequest = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableURLRequest</span></span> requestWithURL:url]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *st = [receiptData base64EncodedString]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *json = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"{\"receipt-data\":\"%@\"}"</span></span>, st]; [theRequest setHTTPBody:[json dataUsingEncoding:<span class="hljs-built_in"><span class="hljs-built_in">NSUTF8StringEncoding</span></span>]]; [theRequest setHTTPMethod:<span class="hljs-string"><span class="hljs-string">@"POST"</span></span>]; [theRequest setValue:<span class="hljs-string"><span class="hljs-string">@"application/x-www-form-urlencoded"</span></span> forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"Content-Type"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *length = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%d"</span></span>, [json length]]; [theRequest setValue:length forHTTPHeaderField:<span class="hljs-string"><span class="hljs-string">@"Content-Length"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSHTTPURLResponse</span></span>* urlResponse = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = [[<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> alloc] init]; <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span> *responseData = [<span class="hljs-built_in"><span class="hljs-built_in">NSURLConnection</span></span> sendSynchronousRequest:theRequest returningResponse:&amp;urlResponse error:&amp;error]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *responseString = [[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> alloc] initWithData:responseData encoding:<span class="hljs-built_in"><span class="hljs-built_in">NSUTF8StringEncoding</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *dic = [responseString JSONValue]; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> status = [[dic objectForKey:<span class="hljs-string"><span class="hljs-string">@"status"</span></span>] intValue]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *receiptDic = [dic objectForKey:<span class="hljs-string"><span class="hljs-string">@"receipt"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> retVal = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; receiptDic) { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *itemId = [receiptDic objectForKey:<span class="hljs-string"><span class="hljs-string">@"item_id"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *productId = [receiptDic objectForKey:<span class="hljs-string"><span class="hljs-string">@"product_id"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (productId &amp;&amp; ([productId isEqualToString:kFeature1] || [productId isEqualToString:kFeature2] || [productId isEqualToString:kFeature3] )) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (itemId &amp;&amp; ( [itemId isEqualToString:kFeatureItemID1] || [itemId isEqualToString:kFeatureItemID2] || [itemId isEqualToString:kFeatureItemID3] )) { retVal = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retVal; }</code> </pre><br>  What is the plus of this code: the lomaker does not know the value of item_id, it is not transmitted anywhere at the request.  That is why it will not be easy to fake such a receipt.  Although, perhaps, it is possible. <br><br>  And please, do not say that everything can be broken.  The purpose of this protection is to avoid mass hacking by standard means. </div><p>Source: <a href="https://habr.com/ru/post/145524/">https://habr.com/ru/post/145524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145515/index.html">Tactile interfaces are on the way</a></li>
<li><a href="../145516/index.html">Touch screen feedback tactile</a></li>
<li><a href="../145518/index.html">Elements of interaction experience - my brief retelling of the book.</a></li>
<li><a href="../145519/index.html">The long-awaited update of the component Virtual Treeview V5.0.0 RC1</a></li>
<li><a href="../145523/index.html">Beamer - make up presentations</a></li>
<li><a href="../145526/index.html">Bitcasa for Linux released</a></li>
<li><a href="../145527/index.html">Recommender systems - the future of the Internet</a></li>
<li><a href="../145528/index.html">How do sorting algorithms</a></li>
<li><a href="../145531/index.html">Firebird UI for Java</a></li>
<li><a href="../145532/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ9 (June 2 - 8, 2012)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>