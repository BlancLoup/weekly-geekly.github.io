<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solution FizzBuzz on FPGA with video generation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes how to generate a video signal on an FPGA using FizzBuzz as an example. Generating a video turned out to be easier than I expec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solution FizzBuzz on FPGA with video generation</h1><div class="post__text post__text-html js-mediator-article">  This article describes how to generate a video signal on an FPGA using FizzBuzz as an example.  Generating a video turned out to be easier than I expected - easier than the previous task with the <a href="https://geektimes.ru/post/299119/">consistent output of FizzBuzz to FPGA</a> .  I got a little carried away with the project, so I added animation, multi-colored text and giant jumping words on the screen. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e91/e9f/d54/e91e9fd5485330ead0b0588fa711493f.jpg"><br>  <i><font color="gray">FizzBuzz on the FPGA board.</font></i>  <i><font color="gray">The board generates a direct VGA video signal with the animation of the words ‚ÄúFizz‚Äù and ‚ÄúBuzz‚Äù</font></i> <br><br>  If you are not familiar with the <a href="http://wiki.c2.com/%3FFizzBuzzTest">FizzBuzz task</a> , then it is to write a program that prints the numbers from 1 to 100, where the three-fold units are replaced by the word Fizz, the five-fold numbers are replaced by the word Buzz, and the multiple fifteen numbers are replaced by the FizzBuzz word.  Since FizzBuzz is implemented in several lines of code, this task is <a href="https://blog.codinghorror.com/why-cant-programmers-program/">given at interviews</a> in order to weed out those who do not know how to program.  But on the FPGA solution is much more difficult. <br><a name="habracut"></a><br>  FPGA ( <a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array">user-programmable gate array</a> ) is an interesting chip.  It is programmed to execute arbitrary digital logic.  It is possible to construct a complex circuit without laying the physical channels between the individual valves and the flip-flops.  The microcircuit can turn into anything from a logic analyzer to a microprocessor and a video generator.  For this project I used the <a href="https://embeddedmicro.com/products/mojo-v3">Mojo FPGA</a> board (in the photo). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href=""><img src="https://habrastorage.org/webt/mn/8a/jd/mn8ajdh40gum3fhcrdujj8m-sho.jpeg"></a> <br>  <i><font color="gray">Mojo FPGA board.</font></i>  <i><font color="gray">The big chip on the board is the Spartan 6 FPGA</font></i> <br><br><h1>  VGA signal generation </h1><br>  For FPGA, there is a definite learning curve, because here you are developing circuits, rather than writing software that runs on a processor.  But if you can use the FPGA to blink five LEDs, then you are generally ready to realize the output of a VGA video signal.  The VGA video format is much simpler than I expected: only three signals for pixels (red, green and blue) and two signals for horizontal and vertical synchronization. <br><br>  The basic idea is to use two counters: one for pixels horizontally and one for vertical lines.  At each point on the screen, these coordinates generate the desired pixel color.  In addition, horizontal and vertical synchronization pulses are generated when the counters are in the corresponding position.  I used the basic resolution of VGA 640 √ó 480 <a href="https://habr.com/ru/post/374419/"><sup>2</sup></a> <a name="2_2"></a><a name="2_2"></a>  where you need to count to 800 and 525 <a href="https://habr.com/ru/post/374419/"><sup>1</sup></a> <a name="1_1"></a>  <a href="https://habr.com/ru/post/374419/"><sup>eleven</sup></a> <a name="11_11"></a><a name="1_1"></a><a name="11_11"></a>  .  Horizontally in each line 800 pixels: 640 visible, 16 empty, 96 for horizontal synchronization and another 48 empty pixels.  (Such strange parameters are used for historical reasons).  Meanwhile, the vertical counter should count 525 lines: 480 lines of the image, 10 empty, 2 lines of vertical synchronization and 33 more empty. <br><br>  Putting it all together, I developed a <code>vga</code> module ( <a href="">source code</a> ) for generating VGA signals.  The code is written in Verilog, this is the standard language for FPGA.  I will not explain in detail Verilog: I hope it is enough to show how it works.  In the code below, the counters <code>x</code> and <code>y</code> implemented.  The first line indicates that the action was taken at the positive edge of each (50 MHz) clock signal.  The next line switches <code>clk25</code> on each clock, generating a 25 MHz signal.  (The only confusion is that <code>&lt;=</code> indicates an assignment, not a comparison).  This code increases the <code>x</code> counter from 0 to 799. At the end of each line, <code>y</code> increases from 0 to 524. Thus, the code generates the necessary pixel and row counters. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge clk) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> clk25 &lt;= ~clk25; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clk25 == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; <span class="hljs-number"><span class="hljs-number">799</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> x &lt;= x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> x &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (y &lt; <span class="hljs-number"><span class="hljs-number">524</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> y &lt;= y + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> y &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  Although Verilog is similar to a normal programming language, it works quite differently.  This code does not generate instructions that are sequentially executed by the processor, but creates a circuit in the FPGA chip.  It creates registers from the triggers for <code>clk25</code> , <code>x</code> and <code>y</code> .  To increase <code>x</code> and <code>y</code> binary adders are generated.  <code>if</code> turned into logic gates of register comparators.  The whole circuit operates in parallel, responding to 50 MHz clock pulses.  To understand FPGA, you need to step out of consistent programming thinking and think about basic patterns. <br><br>  Returning to the <code>vga</code> module, the code below generates horizontal and vertical synchronization signals using the <code>x</code> and <code>y</code> counters.  In addition, the <code>valid</code> flag indicates an area of ‚Äã‚Äã640 √ó 480 where the video signal should be generated;  outside this area the screen should be blank.  As before, these statements generate logic elements to check conditions, rather than generate code. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">assign</span></span> hsync = x &lt; (<span class="hljs-number"><span class="hljs-number">640</span></span> + <span class="hljs-number"><span class="hljs-number">16</span></span>) || x &gt;= (<span class="hljs-number"><span class="hljs-number">640</span></span> + <span class="hljs-number"><span class="hljs-number">16</span></span> + <span class="hljs-number"><span class="hljs-number">96</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">assign</span></span> vsync = y &lt; (<span class="hljs-number"><span class="hljs-number">480</span></span> + <span class="hljs-number"><span class="hljs-number">10</span></span>) || y &gt;= (<span class="hljs-number"><span class="hljs-number">480</span></span> + <span class="hljs-number"><span class="hljs-number">10</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">assign</span></span> valid = (x &lt; <span class="hljs-number"><span class="hljs-number">640</span></span>) &amp;&amp; (y &lt; <span class="hljs-number"><span class="hljs-number">480</span></span>);</code> </pre> <br>  The ‚Äúuseful‚Äù part of the VGA signal is the red, green and blue pixel signals that control what appears on the screen.  To check the scheme, I wrote a few lines to activate <code>r</code> , <code>g</code> and <code>b</code> in different areas of the screen, drowning everything outside of the visible ('valid') area <a href="https://habr.com/ru/post/374419/"><sup>3</sup></a> <a name="3_3"></a>  (the question mark is a ternary conditional operator, as in Java). <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valid) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> rval = (x &lt; <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> x &gt; <span class="hljs-number"><span class="hljs-number">320</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; gval = (y &lt; <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> y &gt; <span class="hljs-number"><span class="hljs-number">360</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; bval = (x &gt; <span class="hljs-number"><span class="hljs-number">500</span></span> &amp;&amp; (y &lt; <span class="hljs-number"><span class="hljs-number">120</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span> y &gt; <span class="hljs-number"><span class="hljs-number">300</span></span>)) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> rval = <span class="hljs-number"><span class="hljs-number">0</span></span>; gval = <span class="hljs-number"><span class="hljs-number">0</span></span>; bval = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br>  I ran the code on the FPGA board - and nothing happened.  The monitor remained black.  What went wrong?  Fortunately, after a couple of seconds <a href="https://habr.com/ru/post/374419/"><sup>4</sup></a> <a name="4_4"></a>  the monitor has completed its normal startup cycle and displayed the issue.  I was pleasantly surprised that the issue of VGA worked the first time, even if it is an arbitrary color blocks.  <a href="https://habr.com/ru/post/374419/"><sup>five</sup></a> <a name="5_5"></a><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/d26/014/65d/d2601465dee7a4e0dc66b70f68e9e827.jpg"><br>  <i><font color="gray">My first VGA program generates arbitrary color blocks on the screen.</font></i>  <i><font color="gray">Not very meaningful, but everything works fine</font></i> <br><br><h1>  Display characters on screen </h1><br>  The next step is to display text characters on the screen.  I implemented a pixel generation module for 8 √ó 8 characters.  Instead of supporting the full set of ASCII characters, here are only the characters needed for FizzBuzz: from 0 to 9, ‚ÄúB‚Äù, ‚ÄúF‚Äù, ‚Äúi‚Äù, ‚Äúu‚Äù, ‚Äúz‚Äù and a space.  Conveniently, the whole set fit in 16 characters, that is, in a four-bit value. <br><br>  Thus, the module receives a four-bit character code and a three-bit line number (for eight lines per character) - and outputs eight pixels for a given character string.  All code (below is a fragment, and the full code is <a href="">here</a> ) is just a big <code>case</code> for outputting the corresponding bits.  <a href="https://habr.com/ru/post/374419/"><sup>6</sup></a> <a name="6_6"></a>  In essence, this code is compiled into ROM, which is implemented in FPGA lookup tables. <br><br><pre> <code class="hljs ruby"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ({char, rownum}) <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000000: pixels = 8'</span></span>b0111110<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXXXX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000001: pixels = 8'</span></span>b1100011<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000010: pixels = 8'</span></span>b1100111<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX XXX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000011: pixels = 8'</span></span>b1101111<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX XXXX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000100: pixels = 8'</span></span>b1111011<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXXX XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000101: pixels = 8'</span></span>b1110011<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXX XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000110: pixels = 8'</span></span>b0111110<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXXXX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0000111: pixels = 8'</span></span>b0000000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001000: pixels = 8'</span></span>b0011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001001: pixels = 8'</span></span>b0111000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001010: pixels = 8'</span></span>b0011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001011: pixels = 8'</span></span>b0011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001100: pixels = 8'</span></span>b0011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001101: pixels = 8'</span></span>b0011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XX <span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-string"><span class="hljs-string">'b0001110: pixels = 8'</span></span>b1111110<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> XXXXXX ...</code> </pre> <br>  I updated the top-level program to use the lower bits of the <code>x</code> coordinate for the character and pixel index, as well as the lower bits of the <code>y</code> coordinate for the row index.  The results are shown below.  The text in the red box is magnified so that you can see the characters. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/656/007/474/656007474a59b35c518d5085b41dcd31.jpg"><br>  <i><font color="gray">My first text implementation (enlarged area in red outline).</font></i>  <i><font color="gray">Because of the error, all the characters go backwards</font></i> <br><br>  Hell, in my character generator, bit 7 is on the left, and in the values ‚Äã‚Äãof the pixel index it is on the right, so the characters are displayed backwards.  But it is easy to fix. <br><br><h1>  FizzBuzz string generation </h1><br>  Having adjusted the display of characters, you need to get the correct characters for the output of FizzBuzz.  The algorithm is the same as in the <a href="https://geektimes.ru/post/299119/">previous program</a> , so here I will give only the main points. <br><br>  Converting numbers from 1 to 100 into characters is trivial to implement on a microprocessor, but more difficult in digital logic, because there is no built-in division operation.  The division into 10 and 100 requires a lot of logical elements.  I decided to use a binary decimal counter (BCD) with separate four-bit counters for each of the bits. <br><br>  The next task is to check the multiplicity of 3 and 5. Like simple division, division with the remainder is easy to implement on a microprocessor, but difficult in digital logic.  Instead of calculating the values, I made counters for the residuals from division by 3 and 5. For example, division with the remainder by three simply counts 0, 1, 2, 0, 1, 2 ... (for other options, see notes <a href="https://habr.com/ru/post/374419/"><sup>7</sup></a> <a name="7_7"></a>  ). <br><br>  The FizzBuzz issue string contains up to eight characters.  The ‚Äúfizzbuzz‚Äù module ( <a href="">source code</a> ) outputs the corresponding eight four-bit characters as a 32-bit <code>line</code> variable.  (The normal way to generate video is to store all the characters or pixels of the screen in the video memory, but I decided to generate everything dynamically).  The if statement (the snippet below) updates the <code>line</code> bits, returning ‚ÄúFizz‚Äú, ‚ÄúBuzz‚Äú, ‚ÄúFizzBuzz‚Äú or a number, depending on the circumstances. <br><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mod3 == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; mod5 != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> // Fizz <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt;= CHAR_F; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt;= CHAR_I; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>] &lt;= CHAR_Z; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>] &lt;= CHAR_Z; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mod3 != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; mod5 == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> // Buzz <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt;= CHAR_B; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span>] &lt;= CHAR_U; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>] &lt;= CHAR_Z; <span class="hljs-literal"><span class="hljs-literal">line</span></span>[<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>] &lt;= CHAR_Z; ...</code> </pre> <br>  The FizzBuzz module needs a signal to increase the counter to the next number, so I changed the <code>vga</code> module to indicate the start of a new line - and used it as a trigger for the transition to the next number.  But testing the code showed a very strange rendition with alien characters.  Below is a fragment. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e2e/d50/280/e2ed502806ce070048a1bd1a4490ead3.jpg"><br>  <i><font color="gray">Changing a character in each line gives out mysterious hieroglyphs, but not the desired result.</font></i> <br><br>  The error is that I moved to the next value of FizzBuzz after each row of pixels instead of waiting for 8 lines of drawing the entire character.  Thus, each displayed symbol consisted of slices of eight different symbols.  Increasing the FizzBuzz counter every 8 lines corrects the problem, as shown below.  (Debugging VGA code is much easier than other tasks on FPGAs, because the problems are immediately visible on the screen. No need to mess around with the oscilloscope trying to figure out what went wrong). <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e27/329/f7d/e27329f7dfa6294017fc766ca9c3cf50.jpg"><br>  <i><font color="gray">Giving FizzBuzz on a VGA monitor</font></i> <br><br>  Now FizzBuzz has appeared on the monitor, but the static display is boring.  Changing the foreground and background colors for each row is made simple ‚Äî use some bits of the <code>y</code> value for red, green, and blue.  So we get the color text in the style of the 80s. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/081/3bc/a7a/0813bca7a5eac6769a338745a7b959c9.jpg"><br>  <i><font color="gray">If the foreground and background color depends on the line, the text looks more interesting.</font></i> <br><br>  Then I added a primitive animation.  The first step is to add the output of the <code>vga</code> module to indicate screen redrawing, this is a new field for every 1/60 second.  I used this to dynamically change colors.  (Tip: do not change color 60 times per second if you do not want to cause a headache; use a counter). <br><br>  Trying different graphic effects is fun and exciting, because the result is immediately visible.  I launched ‚ÄúFizz‚Äù and ‚ÄúBuzz‚Äù with a rainbow trace on the screen (in the spirit of <a href="https://ru.wikipedia.org/wiki/Nyan_Cat">Nyan Cat</a> ).  For this, I changed the initial positions of the characters in accordance with the counter.  For the rainbow effect on the characters, colors are selected by line numbers (therefore, each character string can be a different color) and a rainbow trail is added. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/339/116/dbc/339116dbc86d37694038ef747fe3994b.gif"><br>  <i><font color="gray">End result close up</font></i> <br><br>  Finally, I added another effect - giant words ‚ÄúFizz‚Äù and ‚ÄúBuzz‚Äù, bouncing off the edges of the screen.  The effect is based on rebounding an invisible contour (like an <a href="http://www.fpga4fun.com/PongGame.html">FPGA Pong</a> ), inside of which is the word <a href="https://habr.com/ru/post/374419/"><sup>8</sup></a> <a name="8_8"></a>  .  The variable <code>dx</code> tracks the direction of X, and <code>dy</code> tracks the direction of Y. On each new screen (that is, 60 times per second), the X and Y coordinates of the contour increase or decrease based on the variable direction.  If the contour reaches the right or left edge, <code>dx</code> switches.  Similarly, <code>dy</code> switches if the contour has reached the top or bottom edge.  Then, large text is drawn within the outline using another instance of the symbol generator described earlier.  The word is increased 8 times, discarding the three lower bits from the coordinate.  You are probably tired of the Verilog code, so I will not show the code here, but it is <a href="">published on GitHub</a> .  The final result is in the video. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/NRqq1Vi9mIw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Hardware implementation details </h3><br>  In this project, I used a simple <a href="https://embeddedmicro.com/products/mojo-v3">Mojo V3</a> FPGA development board for beginners.  It has the FPGA of the Xilinx Spartan 6 family. Although it is one of the smallest FPGAs, it has 9000 logic cells and 11,000 triggers - so the kid is capable of a lot.  (For other options, see the <a href="https://joelw.id.au/FPGA/CheapFPGADevelopmentBoards">list of cheap FPGA cards</a> ). <br><br> <a href=""><img src="https://habrastorage.org/webt/xb/ld/fq/xbldfqehsgyah6fc1eoeqg0yhcc.jpeg"></a> <br>  <i><font color="gray">Connecting an FPGA board to a VGA is almost trivial: there are only three 270Œ© resistors.</font></i>  <i><font color="gray">The development board simply attaches the cable to the terminal block.</font></i> <br><br>  If you want to use VGA, it's easier to take a development board with a VGA connector.  But if you don‚Äôt have one (like Mojo, for example), connecting VGA anyway won't be a problem.  Simply place the 270Œ© resistors between the red, green, and blue FPGA output pins and the VGA connection.  Horizontal and vertical sync signals can be received directly from the FPGA.  <a href="https://habr.com/ru/post/374419/"><sup>9</sup></a> <a name="9_9"></a><br><br>  I used the Xilinx development environment (called ISE) to write and synthesize Verilog code.  For details on writing code and downloading it to the FPGA card, see <a href="https://geektimes.ru/post/299119/">my previous article</a> .  To indicate specific physical contacts of the FPGA, I added a few lines to the <code><a href="">mojo.ucf</a></code> configuration file.  Here, the <code>pin_r</code> red pin corresponds to pin 50 and so on. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">NET</span></span> <span class="hljs-string"><span class="hljs-string">"pin_r"</span></span> LOC = P50 | IOSTANDARD = LVTTL; <span class="hljs-attribute"><span class="hljs-attribute">NET</span></span> <span class="hljs-string"><span class="hljs-string">"pin_g"</span></span> LOC = P40 | IOSTANDARD = LVTTL; <span class="hljs-attribute"><span class="hljs-attribute">NET</span></span> <span class="hljs-string"><span class="hljs-string">"pin_b"</span></span> LOC = P34 | IOSTANDARD = LVTTL; <span class="hljs-attribute"><span class="hljs-attribute">NET</span></span> <span class="hljs-string"><span class="hljs-string">"pin_hsync"</span></span> LOC = P32 | IOSTANDARD = LVTTL; <span class="hljs-attribute"><span class="hljs-attribute">NET</span></span> <span class="hljs-string"><span class="hljs-string">"pin_vsync"</span></span> LOC = P29 | IOSTANDARD = LVTTL;</code> </pre> <br>  Output from FPGA to VGA is a common phenomenon, so you can find on the Web a number of projects such as <a href="http://www.fpga4fun.com/PongGame.html">FPGA Pong</a> , <a href="https://eewiki.net/pages/viewpage.action%3FpageId%3D15925278">24-bit color from the DAC chip</a> , <a href="https://embeddedthoughts.com/2016/07/29/driving-a-vga-monitor-using-an-fpga/">Basys 3 board</a> and <a href="http://www.instructables.com/id/Image-from-FPGA-to-VGA/">image output</a> .  If schema is needed, see <a href="https://www.pantechsolutions.net/fpga-tutorials/vga-interface-with-spartan3-fpga-image-processing-board">this page</a> .  In the book <a href="https://www.amazon.com/Programming-FPGAs-Getting-Started-Verilog/dp/125964376X/">"FPGA Programming," an</a> entire chapter is devoted to this topic. <br><br><h1>  Understanding VGA Format </h1><br>  The VGA format may seem a bit strange, but if you look at the history of television and CRT ( <a href="https://en.wikipedia.org/wiki/Cathode_ray_tube">cathode ray tube</a> ), then everything becomes clear.  In a CRT, a beam of electrons passes through the screen, highlighting the phosphor coating to display the picture.  Scanning takes place in a raster array: the beam scans the screen from left to right, and then the horizontal sync pulse causes it to quickly move to the left for a <i>horizontal reversing sweep</i> .  The process is repeated line by line until the vertical synchronization pulse at the bottom of the screen starts the <i>vertical reverse sweep</i> and the beam returns up.  With horizontal and vertical sweep, the beam is dimmed, so the reverse does not draw lines on the screen.  The diagram below shows a raster scan pattern. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/15d/e85/b7c/15de85b7c475e904e5d19b743c9e23b8.png"><br>  <i><font color="gray">CRT Raster Template ( <a href="">Wikipedia</a> )</font></i> <br><br>  These characteristics are stored in VGA, including horizontal and vertical sync pulses, as well as long video muting intervals. <br><br>  In 1953, the NTSC color television standard appeared.  <a href="https://habr.com/ru/post/374419/"><sup>ten</sup></a> <a name="10_10"></a>  However, VGA is much simpler than NTSC, as it uses five wires for synchronization and color signals, and does not wedge everything into one signal with complex coding.  One of the strange features of NTSC, which is transferred to VGA, is that the refresh rate of the screen is not the declared 60 hertz, but in reality is 59.94 Hz.  <a href="https://habr.com/ru/post/374419/"><sup>eleven</sup></a> <a name="11_11"></a><br><br>  The trace of the oscilloscope below shows the VGA signal for two lines.  Horizontal synchronization pulses (yellow) indicate the beginning of each line.  The short red, green and blue pulses at the beginning of the line are the white pixels from the FizzBuzz number.  The red signal in the middle of the line is the floating red word ‚ÄúBuzz‚Äù. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/7aa/444/3c4/7aa4443c4ec442e9e26a4f36b1b4c776.png"><br>  <i><font color="gray">The trace of the oscilloscope signals VGA shows red, green and blue signals, as well as horizontal synchronization</font></i> <br><br><h1>  Conclusion </h1><br>  The conclusion from FPGA to VGA turned out to be much easier than I expected, but they definitely won't take me to work if they ask the FizzBuzz task at an FPGA interview!  If you are interested in FPGA, I highly recommend playing with the video output.  This is not much more complicated than flashing LED, but much more useful.  Video signal generation is also much more interesting than debugging on an oscilloscope - you can immediately see the result on the screen.  And even if something goes wrong, still the result is often fun. <br><br><h1>  Notes and links </h1><br><a name="1"></a>  1. The VGA signal should have a clock speed for pixels of 25.175 MHz.  Instead, I divided the 50 MHz Mojo clock rate into two to get 25 MHz.  The VGA standard says that a clock frequency of 25.175 MHz ¬± 0.5% is allowed.  The frequency of 25 MHz differs by 0.7%, so it is technically a little inconsistent with the specification.  But the monitors are designed to process the signal from cheap video cards, so they usually show everything that is sent to them.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="2"></a>  2. Detailed timings for dozens of standard video resolutions, see <a href="http://caxapa.ru/thumbs/361638/DMTv1r11.pdf">here</a> .  On page 17, the resolution is 640 √ó 480 60 Hz, which I used.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="3"></a>  3. When I forgot to clear the pixels outside the permissible area of ‚Äã‚Äãthe screen, the monitor still showed an image, but very dim, because the monitor was confused what voltage our ‚Äúdark‚Äù one corresponds to.  This is just in case you find that your display is suddenly darkened for no apparent reason.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="4"></a>  4. It‚Äôs just amazing what an LCD display has to do to display a VGA image for a CRT.  The display should examine the incoming signal and ‚Äúguess‚Äù at what resolution the video from the computer goes.  Then you need to re-sample the video signal in accordance with the resolution of the LCD panel.  Finally, new pixel data is sent to the LCD.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="5"></a>  5. For some reason, the output is shifted down by about 25 pixels.  It was perfectly displayed on another monitor, so I am not sure whether something is aligned with my monitor, or I have an error.  This could be adjusted by delaying the vertical sync pulse by 25 lines.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="6"></a>  6. It would be tedious to enter all the code to generate characters, so I wrote <a href="https://gist.github.com/shirriff/07fbaf6d852ff9b7485e15a23e38d67a">a Python program</a> to generate Verilog code from a font file.  The original font is <a href="">here</a> .  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="7"></a>  7. After my last FPGA article on FizzBuzz, readers suggested some other approaches, so I tried them in the VGA project.  With counters from the remainder of the division (my initial approach), the whole project takes 276 LUT (lookup tables) and 277 triggers.  One reader suggested using ring counters (that is, with one bit shifted) instead of binary counters for the remainder of the division.  This requires 277 lookup tables and 281 triggers, so a little worse.  Another suggestion was to add the digits and take the remainder of the division by 3. Here the logic increases the number of lookup tables to 305, which is much worse.  Adding residues from division (instead of digits) reduces the number of lookup tables to 289, which is still worse than the original method.  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="8"></a>  8. Large floating words, in fact, are sprites - raster images that can be arbitrarily arranged on the screen.  Sprites were popular in video games and on computers of the 70s and early 80s, when Pacman, Atari and Commodore 64 appeared. Sprites allow you to animate on slow processors.  Instead of moving all the pixels in memory, the processor simply updates the coordinates of the sprite.  The top level <a href="">code</a> ( <a href="">source code</a> ) ties together the pieces and combines everything on the screen: text, rainbow trail, the giant word ‚ÄúFizz‚Äù (in the rainbow pattern) and the giant ‚ÄúBuzz‚Äù (red).  <a href="https://habr.com/ru/post/374419/">[return]</a> <br><br><a name="9"></a>  9. To connect the VGA monitor, I cut the VGA cable in half and connected its wires to the FPGA board, using the cable from the old <a href="http://www.righto.com/2018/03/reading-vga-monitors-configuration-data.html">project to read the data from the monitor using I2C</a> .  It is better not to use this approach: tiny wiring is difficult to solder and they break easily.  Better use a regular VGA connector.  The interface is simply three 270Œ© resistors that receive the correct voltage for a red, green, and blue signal.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use more resistors for additional colors. </font><font style="vertical-align: inherit;">So you essentially construct two-bit (or more) converters DAC. </font></font><a href="https://habr.com/ru/post/374419/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a> <br><br><a name="10"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. NTSC standard is very smart to introduce color support, while remaining compatible with black and white TVs. </font><font style="vertical-align: inherit;">However, it is very difficult to understand. </font><font style="vertical-align: inherit;">I was frightened by the talk of </font></font><a href="https://en.wikipedia.org/wiki/NTSC"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">color coding in a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> phase and quadrature with color subcarriers and a color burst signal. </font><font style="vertical-align: inherit;">Here, encoding is much more complicated than that of VGA, because NTSC combines color and timing in one transmission channel. </font></font><a href="https://habr.com/ru/post/374419/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a> <br><br><a name="11"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. Although the update rate for the monitors is 60 Hz, the actual value is 59.94 Hz. </font><font style="vertical-align: inherit;">This strange frequency goes back to the origins of color television. </font><font style="vertical-align: inherit;">The refresh rate of the screen of 60 Hz was chosen to level the interference from the power line. </font><font style="vertical-align: inherit;">But in order to prevent carrier frequency interference for color and sound frequency, it was necessary to adjust the frequencies, as a result of which the screen refresh rate was set to 59.94 Hertz. </font><font style="vertical-align: inherit;">This is almost like numerology, but the choice of frequency is explained in detail in </font></font><a href="https://www.youtube.com/watch%3Fv%3D3GJUM6pCpew"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and on </font></font><a href="https://en.wikipedia.org/wiki/NTSC"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://habr.com/ru/post/374419/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[return]</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/374419/">https://habr.com/ru/post/374419/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../374407/index.html">How to send a letter to the ISS by April 12</a></li>
<li><a href="../374409/index.html">Red Hogwarts. Series 3. Major</a></li>
<li><a href="../374411/index.html">Apple has completely switched to renewable energy in 43 countries</a></li>
<li><a href="../374413/index.html">Apple will be forced to pay $ 500 million patent troll</a></li>
<li><a href="../374415/index.html">The experience of using a pedestrian helmet to protect against low temperatures in the winter in the Far East of Russia</a></li>
<li><a href="../374421/index.html">AI Google learned to recognize the voices of people from the random crowd chorus</a></li>
<li><a href="../374423/index.html">Sega announced the release of a miniature Sega MegaDrive</a></li>
<li><a href="../374425/index.html">DTEK starts construction of the largest solar power station in Ukraine</a></li>
<li><a href="../374427/index.html">Why networks are torn</a></li>
<li><a href="../374429/index.html">Mechanical scanning + afterglow =?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>