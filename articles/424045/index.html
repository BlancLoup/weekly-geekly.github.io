<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A couple of sometimes popular tricks when working with git</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share recipes for solving a couple of tasks that sometimes arise when working with git, and which are not "directly obvious." 


 At first I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A couple of sometimes popular tricks when working with git</h1><div class="post__text post__text-html js-mediator-article"><p>  I want to share recipes for solving a couple of tasks that sometimes arise when working with git, and which are not "directly obvious." </p><br><p>  At first I thought to accumulate more similar recipes, but there is a time for everything.  I think if there is a benefit, then it is possible and gradually ... </p><br><p>  So... </p><a name="habracut"></a><br><h1>  Merging old branches with minimal pain </h1><br><p> Preamble.  There is a main branch ( <code>master</code> ), in which new features and fixes are actively committed;  there is a parallel branch <code>feature</code> , in which the developers swam for some time into their own nirvana, and then suddenly discovered that they hadn‚Äôt been merged with the master for a month, and the merge head-on (head with head) had already become nontrivial. </p><br><p>  (Yes, this is not about an ideal world, where everything is correct, there is no crime, children are always obedient and even cross the road strictly by the hand with the mother, carefully looking around). </p><br><p>  Purpose: to bear.  In this case, that it was a "clean" merg, without features.  Those.  so that in a public repository in the graph of branches, two threads are connected at a single point with the message "merged branch 'master' into feature".  And the whole ‚Äúthis one here‚Äù headache about how much time and effort it took, how many conflicts it was decided and how much hair it turned gray has not been kept. </p><br><p>  The plot.  The fact that in the gita you can edit the last commit with the key - <code>--amend</code> knows everything.  The point is that this "last commit" can be anywhere and contain anything.  For example, it may not be just the ‚Äúlast commit to a linear branch‚Äù, where they forgot to correct a typo, but also a merge commit from a normal or ‚Äúoctopus‚Äù merge.  <code>--amend</code> will roll out the proposed changes exactly the same way and "inline" the changed commit into the tree, as if it really appeared as a result of honest merging and conflict resolution.  In essence, <code>git merge</code> and <code>git commit --amend</code> allows <code>git commit --amend</code> to completely separate the "sticking of a place" ("this commit will be HERE in the tree") and the contents of the commit itself. </p><br><p>  The basic idea of ‚Äã‚Äãa complex merge commit with a clean history is simple: first, "we collapse the place", creating a clean merge commit (regardless of the contents), then rewrite it with - <code>--amend</code> , making the contents "correct." </p><br><ol><li><p>  "Pounding place".  This is easy to do by assigning a strategy during the merzh, which will not ask unnecessary questions about conflict resolution. </p><br><pre> <code class="hljs sql">git checkout feature git <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span> -s ours</code> </pre> <br></li><li><p>  Oh yes.  It was necessary to create a "backup" branch from the head feature before merge.  After all, nothing is really merged ... But let it be the 2nd point, not 0th.  In general, we are switching to a non-non-merged feature, and now we honestly merge.  Any affordable way, regardless of any "dirty khaki."  My personal way is to look through the master branch from the moment of the last merge and evaluate possible problem commits (for example: they corrected a typo in one place - not a problem. Massively (into many files) they renamed some essence - a problem, etc.).  From problematic commits we create new branches (I do unsophisticated - master1, master2, master3, etc.).  And then we merge a branch for a branch, moving from old to fresh and correcting conflicts (which are usually self-evident with this approach).  Offer other methods (I'm not a magician; I'm just learning; I will be glad to constructive comments!).  In the end, having spent (maybe) several hours on purely routine operations (which can be trusted to a junior, because there are simply no complicated conflicts with this approach), we get the final code state: all innovations / fixes of the wizard are successfully ported to the feature branch, all relevant tests this code went through, etc.  Successful code must be commited. </p><br></li><li><p>  Rewriting the "success story".  Being on commit, where "everything is done", run the following: </p><br></li></ol><br><pre> <code class="hljs pgsql">git tag mp git checkout mp git <span class="hljs-keyword"><span class="hljs-keyword">reset</span></span> feature git checkout feature git tag -d mp</code> </pre> <br><p>  (I decipher: with the help of the tag (mp - merge point) we go to the detached HEAD state, from there reset to the head of our branch, where at the very beginning there is a "fixed place" with a fraudulent merge commit. The tag is no longer needed, therefore we delete it).  Now we are standing on the original "clean" merge commit;  at the same time in the working copy we have the "correct" files, where everything we need is correct.  Now you need to add all the modified files to the index, and especially carefully look at non-staged (there will be all the new files that have arisen in the main branch).  All the necessary from there we add too. </p><br><p>  Finally, when everything is ready, we enter our correct commit into the reserved place: </p><br><pre> <code class="hljs pgsql">git <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-comment"><span class="hljs-comment">--amend</span></span></code> </pre> <br><p>  Hooray!  Everything worked out!  You can casually push a branch into a public repository, and no one will know that you actually spent half a day of working time on this merge. </p><br><h1>  Select the part of the file, keeping the history </h1><br><p>  Preamble: in the file the code-code, and finally nakodili so that even the visual studio began to slow down, digesting it (not to mention JetBrains).  (Yes, we are again in the "imperfect" world. As always). </p><br><p>  Smart brains thought and thought, and identified several entities that can be budded into a separate file.  But!  If you just take a copy of a piece of file and paste it into another file, this will be a completely new file from the git point of view.  In case of any problems, a search through the history will unequivocally indicate only "where is this invalid?" Who divided the file.  And to find the original source is sometimes not necessary ‚Äúfor repression‚Äù, but purely constructive - to find out WHY this line was changed;  what bug it fixed (or fixed any).  I want the file to be new, but the whole history of changes still remains! </p><br><p>  The plot.  With some slightly annoying edge effects, this can be done.  For definiteness, there is a file <code>file.txt</code> from which you want to select a part in <code>file2.txt</code> .  (and at the same time save the story, yes).  Run this snippet: </p><br><pre> <code class="hljs perl">f=file.txt; f1=file1.txt; f2=file2.txt cp $f $f2 git add $f2 git mv $f $f1 git commit -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span><span class="hljs-string"><span class="hljs-string">"split $f step 1, converted to $f1 and $f2"</span></span></code> </pre> <br><p>  As a result, we obtain the files <code>file1.txt</code> and <code>file2.txt</code> .  They both have exactly the same story (real; like the source file).  Yes, the original <code>file.txt</code> had to be renamed;  this is the "slightly annoying" edge effect.  Unfortunately, I could not find a way to save the story, but in order not to rename the source file, I could not (if anyone could, tell me!).  However, git can handle it all;  no one bothers to rename the file back with a separate commit: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">git</span></span> mv <span class="hljs-variable"><span class="hljs-variable">$f1</span></span> <span class="hljs-variable"><span class="hljs-variable">$f</span></span> git commit -m<span class="hljs-string"><span class="hljs-string">"split finish, rename </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f1</span></span></span><span class="hljs-string"> to </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$f</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br><p>  Now at <code>file2.txt</code> gilt will show the same line history as the original file.  The main thing is not to merge these two commits together (otherwise all the magic will disappear; I tried!).  But at the same time, no one bothers to edit files directly in the process of separation;  it is not necessary to do this later with separate commits.  And yes, you can select many files at once! </p><br><p>  The key point of the recipe: rename the source file to another in the same commit where a copy is made from it (and, possibly, edited).  And let this commit live in the future (never get rid of a reverse renaming). </p><br><p>  Upd: a couple of recipes from <a href="https://habr.com/users/lissov/" class="user_link">Lissov</a> </p><br><h1>  Separate part of the repository with history </h1><br><p>  You are on the latest version of the initial repository.  The task is to separate one folder.  (I‚Äôve seen options for several folders, but it‚Äôs simpler and clearer to either put everything in one at first, or repeat what‚Äôs written below several times.) </p><br><p>  Important!  All movements are done with the <code>git mv</code> , otherwise git could lose the story. </p><br><p>  We carry out: </p><br><pre> <code class="hljs vbscript">git <span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>-branch --prune-<span class="hljs-literal"><span class="hljs-literal">empty</span></span> --subdirectory-<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"{directory}"</span></span> [branch]</code> </pre> <br><p>  {directory} is the folder to be separated.  As a result, we get a folder along with the full history of commits only into it, that is, in each commit, only files from this folder are displayed.  Naturally, part of the commits will be empty, removed by --prune-empty. <br>  Now we change origin: </p><br><pre> <code class="hljs sql">git remote <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> origin {another_repository_url}<span class="hljs-string"><span class="hljs-string">` git checkout move_from_Repo_1</span></span></code> </pre> <br><p>  If the second repository is clean, you can immediately in master.  Well, push: </p><br><pre> <code class="hljs perl">git <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> -u move_from_Repo_1</code> </pre> <br><p>  The entire snippet (for easy copy-paste): </p><br><pre> <code class="hljs vbscript">directory=<span class="hljs-string"><span class="hljs-string">"directory_to_extract"</span></span>; newurl=<span class="hljs-string"><span class="hljs-string">"another_repository_url"</span></span> git <span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>-branch --prune-<span class="hljs-literal"><span class="hljs-literal">empty</span></span> --subdirectory-<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> <span class="hljs-string"><span class="hljs-string">"$directory"</span></span> git remote <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-url origin <span class="hljs-string"><span class="hljs-string">"$newurl"</span></span> git checkout move_from_Repo_1 git push -u move_from_Repo_1</code> </pre> <br><h1>  Merge two repositories together </h1><br><p>  Suppose you have done what is above 2 times and got the <code>move_from_Repo_1</code> and <code>move_from_Repo_2</code> , and in each one you transferred files using <code>git mv</code> to where they should be after the merge.  Now it is necessary to bear: </p><br><pre> <code class="hljs perl">br1=<span class="hljs-string"><span class="hljs-string">"move_from_Repo_1"</span></span>; br2=<span class="hljs-string"><span class="hljs-string">"move_from_Repo_2"</span></span> git checkout master git merge origin/$br1 --allow-unrelated-histories git merge origin/$br2 --allow-unrelated-histories git <span class="hljs-keyword"><span class="hljs-keyword">push</span></span></code> </pre> <br><p>  The focus is on "--allow-unrelated-histories".  As a result, we get one repository with a complete history of all changes. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/424045/">https://habr.com/ru/post/424045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424035/index.html">2019 - the year Intel stopped</a></li>
<li><a href="../424037/index.html">A quick tour of GraphQL</a></li>
<li><a href="../424039/index.html">Cryptography after the landing of aliens</a></li>
<li><a href="../424041/index.html">Brief Introduction to Cell Biology</a></li>
<li><a href="../424043/index.html">Sunny hat trick. In Ukraine, there are three villages Dobrovlyany. And all three have powerful solar power stations.</a></li>
<li><a href="../424049/index.html">Giving the book "Harry Potter and Rational Thinking Methods" to olympiadians</a></li>
<li><a href="../424051/index.html">The Clean Programmer Manifesto or a brief synopsis of Robert Martin's Clean Code book</a></li>
<li><a href="../424053/index.html">MicroSD Series, Created from a Blank Canvas</a></li>
<li><a href="../424057/index.html">Web application integration using Spring Cloud Contract</a></li>
<li><a href="../424059/index.html">#GitLabLive Highlights of September 20, 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>