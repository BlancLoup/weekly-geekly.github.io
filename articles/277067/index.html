<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering and slowdown "Kazakov"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the famous game "Cossacks: Again War" there is a bug that reduces the pleasure of a network game to zero: The inhuman speed of the gameplay on mode...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering and slowdown "Kazakov"</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/3b9/774/f96/3b9774f96ce940fc8cd5bb0b62a44d56.jpg"><br><br>  In the famous game <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D0%25B7%25D0%25B0%25D0%25BA%25D0%25B8:_%25D0%25A1%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B0_%25D0%25B2%25D0%25BE%25D0%25B9%25D0%25BD%25D0%25B0">"Cossacks: Again War"</a> there is a bug that reduces the pleasure of a network game to zero: The inhuman speed of the gameplay on modern computers.  At the same time, the change in game speed in the settings, which works perfectly in the single player mode, does not affect what is happening in the game over the network.  This question is discussed on many forums, but the most popular tips are: <br><br><ol><li>  Artificially load the processor core on which the game is running </li><li>  Run the game in a virtual machine with limited resources </li><li>  Play not on the local network, but on the Internet - there are more delays </li></ol><a name="habracut"></a><br>  The first two options lead to the fact that the game is slow, but with jerks.  The sound quality also drops.  The third option is no comments at all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Getting started </h4><br>  First, look for the value of the speed setting using the <a href="http://www.cheatengine.org/">Cheat Engine</a> .  This should be either a certain multiplier, directly proportional to the position of the slider in the settings menu, or an inversely proportional interval.  This memory cell is quickly located: <br><br><img src="https://habrastorage.org/files/88a/3cc/2b5/88a3cc2b56774c1a875e6c6eb511d389.png"><br><br>  This interval is 0 at maximum speed, and the comfortable for me game speed corresponds to the interval 20. Changing the value during the game immediately affects the speed of the game process.  Well, let's see what we have in a network game.  Load, change the value in the Cheat Engine, and ... nothing.  Only the position of the slider in the settings changes.  Okay, let's see where this interval is processed.  Cheat Engine shows only two adjacent addresses at which the cell is being read: <br><br><img src="https://habrastorage.org/files/e96/488/43b/e9648843bc0a402d8bb5eb376bc427e5.png"><br><br>  Let's look at the listing of the built-in disassembler: <br><br><img src="https://habrastorage.org/files/76f/245/321/76f245321f334577ad3af70aea6c195d.png"><br><br>  Offhand, you can say that the interval is doubled and compared with something, and if it is something less than twice the interval, then the transition is made somewhere back.  Great, we are launching the <s>Tatar</s> program, our favorite for such cases, and we see such a picture at the very end of one long function: <br><br><img src="https://habrastorage.org/files/98b/55f/e62/98b55fe62e974b209ed3cf97f78b5945.png" align="left">  After some digging we find out the following: <br><br><ul><li>  <b>dword_718410</b> - interval value according to the speed settings </li><li>  <b>sub_54C1BE</b> - the procedure that performs the GetTickCount </li><li>  <b>dword_83B1A4</b> - the result of the previous GetTickCount </li><li>  <b>loc_4D1ABF</b> - a subprocedure comparing the difference between the two GetTickCount results and jumping backwards if the difference is smaller than the interval </li></ul><br><h4>  We are looking for an error </h4><br>  Put a breakpoint somewhere in the comparison subprocess with an interval.  We start a single game and immediately fly to the debugger.  We start the game over the network - the breakpoint does not work.  Moreover, if you put a breakpoint at the very beginning of the function, then it always works.  It turns out that it is in a multiplayer game that the interval check is deliberately not performed.  The matter remains for the small: Find the responsible for this branching in the function and change it so that the branch with the required sub-procedure loc_4D1ABF is always executed. <br><br>  We will go from the bottom up.  First, we set a breakpoint in the sub-procedure loc_4D1A9C.  Bingo!  In a single-player game, the word_611B60 variable is always equal to 1, so the jump condition is not fulfilled and control is transferred first to loc_4D1AAA, and from there to our sub-procedure.  When playing online, the word_611B60 variable is always 2, which leads to a jump forward immediately to loc_4D1AE6 and to the end of the function.  To make the game always transfer control to the branch with the sub-procedure loc_4D1ABF, it is enough to replace the comparison instruction <i>cmp edx, 2</i> with <i>cmp edx, 3</i> .  Like two bytes on asphalt! <br><br><br clear="left"><h4>  Not so simple </h4><br>  Now the speed setting works in the network game.  Unfortunately, the tar didn‚Äôt do without a spoon: Over time, one of the players begins to greatly increase the speed of scrolling and the rate of water animation.  After some time, the effect disappears and appears in another player.  In this case, the speed of the rest of the game processes for both is the same and corresponds to the one set in the settings. <br><br>  I did not manage to find out the reason for this behavior, but a strong suspicion arose at the loc_4D1AAA sub-procedure that caused ProcessMessages.  Apparently for the game on the network, this challenge was not needed.  Perhaps it was because of the above described strange behavior that a circumvention of this sub-procedure was made?  In any case, we will try to exclude it from the branch, leaving only the loc_4D1ABF subprocedure useful to us. <br><br><h4>  We get a calculator </h4><br>  So what we need to do: <br><br><ol><li>  Replace the jump with the condition in the sub-procedure <b>loc_4D1A9C</b> with a short direct jump to the sub- <b>procedure loc_4D1ABF</b> </li><li>  Change the reverse jump offset in the sub-procedure <b>loc_4D1ABF</b> to close it on yourself and not fall into <b>loc_4D1AAA</b> </li><li>  Remove the second jump instruction to <b>loc_4D1AAA</b> , located in the block immediately after the sub- <b>procedure loc_4D1ABF</b> </li></ol><br>  With the first point, everything is clear: the operating code of the short jump is <i>EB</i> , and the offset we need is determined by subtracting the address following the byte jump instruction from the address of the beginning of the sub-procedure loc_4D1A9C. <br><br>  The third point is even simpler: Replace the jump instruction with two <i>nop</i> 's. <br><br>  The second point requires the calculation of the offset for a short jump back.  Fortunately, I stumbled upon <a href="http://thestarman.pcministry.com/asm/2bytejumps.htm">an article</a> that clearly describes the algorithm of this action, namely: Subtract the destination address from the address following the byte jump instruction, then subtract <i>1h</i> , then convert the number to a binary form (byte size), invert and re-convert to hexadecimal the system.  The resulting number is the offset we need. <br><br>  Well, gentlemen.  Patch! <br><br><img src="https://habrastorage.org/files/2c8/141/323/2c814132360b4d6e8319d947781be65b.png"><br><br><img src="https://habrastorage.org/files/1a2/c7c/9be/1a2c7c9be6cc4fa3a8ed9b1be70a469c.png"><br><br><h4>  Result </h4><br>  Open the modified file in the same beloved program and see the following picture: <br><br><img src="https://habrastorage.org/files/3a7/dd5/8f0/3a7dd58f0d45482496427afcf47389fb.png"><br><br>  The block containing the ProcessMessages call will never be executed.  After we turned off the test for multiplayer game in the sub-procedure loc_4D1A9C, the control passes to our sub-procedure with a call to GetTickCount and a comparison with the interval.  If the difference is less than the interval, then the subprocedure jumps back to the beginning of itself until the interval is met. <br><br>  Now the game behaves as it should.  The speed of the game corresponds to the lowest speed among players, synchronization is not disturbed.  The scrolling speed is also configurable. <br><br><h4>  Afterword </h4><br>  Since this is my first experience with reverse engineering and working with assembler, this is most likely not the most elegant solution.  <s>The root of the problem lies in using the functions QueryPerformanceFrequency and QueryPerformanceCounter, on which the timing of the game is based.</s>  <s>These functions are called once when creating a new game, setting the tone for all subsequent calculations with GetTickCount</s> .  Unfortunately, I did not manage to influence this part of the program properly, <i>because I was too lazy, and some strange arithmetic was going on around the challenge of the above mentioned functions</i> . <br><br>  <b>UPD:</b> With a careful analysis, it quickly becomes clear that the <abbr title="QueryPerformanceFrequency">QPF</abbr> and <abbr title="QueryPerformanceCounter">QPC</abbr> functions are <abbr title="QueryPerformanceCounter">misused</abbr> .  Their results are summarized, and the QPC is subsequently not invoked anywhere else.  The variable storing the result is subsequently used before calling functions that work with strings.  So QPF and QPC are most likely used here only as <abbr title="Pseudo Random Number Generator">PRNG</abbr> in the process of creating a random map and / or map file name. <br><br><h5>  Links </h5><ul><li>  <a href="https://habrahabr.ru/post/266385/">An article on Habr√©</a> about the reverse engineering of the Batman game that pushed me to action and gave a couple of ideas <br>  Thanks, <a href="https://habrahabr.ru/users/id_daemon/" class="user_link">ID_Daemon</a> ! </li><li>  <a href="http://thestarman.pcministry.com/asm/2bytejumps.htm">Article</a> about the calculation of offsets for short jumps in assembler </li></ul><br><hr><br>  <b>UPD:</b> At the request of <a href="https://habrahabr.ru/users/vrv/" class="user_link">VRV</a> , the version of ‚ÄúCossacks‚Äù was also patched, available through Steam.  The discussion he created is on the <a href="http://forum.newlcn.com/viewtopic.php%3Fp%3D444915"><abbr title="League Cossackers Net">LCN</abbr> forum</a> . <br><br>  The patcher for various versions of the Kazakov executable file is available <a href="https://yadi.sk/d/z6rTlJfRpvRn8">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/277067/">https://habr.com/ru/post/277067/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277049/index.html">Test the training of visual attention</a></li>
<li><a href="../277051/index.html">Report from Tarantool Meetup January 28</a></li>
<li><a href="../277053/index.html">What does DEFAULT TRACE conceal in itself?</a></li>
<li><a href="../277055/index.html">Getting rid of Visual Basic</a></li>
<li><a href="../277057/index.html">Golden App 2016 mobile app competition has started</a></li>
<li><a href="../277069/index.html">Neurorevolution in heads and villages</a></li>
<li><a href="../277077/index.html">Near-architecture arguments or the results of a single dispute</a></li>
<li><a href="../277079/index.html">We send messages to Telegram from C #</a></li>
<li><a href="../277081/index.html">From FineReader to data entry solutions: how the direction of DataCapture in ABBYY began</a></li>
<li><a href="../277085/index.html">CodingFuture + Puppet. Part I: network and network filter (cfnetwork + cffirehol)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>