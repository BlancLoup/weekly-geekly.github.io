<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microservices: size matters, even if you have Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On September 19, the first thematic HUG (Highload ++ User Group) meeting took place in Moscow, which was dedicated to microservices. It included the r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microservices: size matters, even if you have Kubernetes</h1><div class="post__text post__text-html js-mediator-article">  On September 19, <a href="https://www.meetup.com/HighLoad-User-Group/events/254238096/">the</a> first thematic HUG (Highload ++ User Group) meeting <a href="https://www.meetup.com/HighLoad-User-Group/events/254238096/">took place</a> in Moscow, which was dedicated to microservices.  It included the report ‚ÄúOperation of microservices: size does matter, even if you have Kubernetes‚Äù, in which we shared the extensive experience of the company ‚ÄúFlant‚Äù in the area of ‚Äã‚Äãoperating projects with microservice architecture.  First of all, it will be useful to all developers who are thinking about applying this approach in their present or future project. <br><br><img src="https://habrastorage.org/webt/jb/ka/cp/jbkacpew1yyus4jx9l5rbdpc3iq.jpeg"><br><br>  We present the <a href="https://www.youtube.com/watch%3Fv%3Dg9cgppj0gKQ"><b>video with the report</b></a> (50 minutes, much more informative than the article), as well as the main squeeze out of it in text form. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>NB: Videos and presentations are also available at the end of this publication.</i> <a name="habracut"></a><br><br><h2>  Introduction </h2><br>  Usually a good story has a plot, a main plot and a denouement.  This report is more like a plot, and a tragic one.  It is also important to note that it presents a look at microservices from the <i>exploitation</i> side. <br><br>  I‚Äôll start with the following chart, which was authored (in 2015) by Martin Fowler: <br><br><img src="https://habrastorage.org/webt/lj/fo/rz/ljforzqes2fsafgqo6gvhxfrpue.png"><br><br>  It shows how, in the case of a monolithic application that has reached a certain value, the productivity of work begins to fall.  Microservices are different in that the initial productivity with them is lower, however, as the complexity increases, the degradation of efficiency is not so noticeable for them. <br><br>  I will add to this schedule for the case of using Kubernetes: <br><br><img src="https://habrastorage.org/webt/b1/co/v-/b1cov-wky66lpvijeu0cgf72u9y.png"><br><br>  Why is the application with microservices better?  Because such an architecture places serious demands on the architecture, which, in turn, are perfectly covered by the possibilities of Kubernetes.  On the other hand, a part of this functionality will be useful for the monolith, especially since the typical monolith today is not quite a monolith (details will be further in the report). <br><br>  As you can see, the final schedule (when both monolithic and microservice applications in the infrastructure with Kubernetes) is not very different from the original one.  Further, we will talk about applications that are operated using Kubernetes. <br><br><h2>  Useful and harmful microservice </h2><br>  And then the main thought: <br><br><img src="https://habrastorage.org/webt/fa/ks/uz/faksuzabviitaowg8rxaaxz3hgi.jpeg"><br><br>  What is a <b>normal</b> microservice architecture?  It should bring you real benefits by increasing your work efficiency.  If you go back to the schedule, here it is: <br><br><img src="https://habrastorage.org/webt/az/mn/jv/azmnjv4kc7fnk36mxvhodoirsk8.png"><br><br>  If we call it <b>useful</b> , then on the other side of the chart there will be <b>harmful</b> microservice (interferes with work): <br><br><img src="https://habrastorage.org/webt/fh/nt/y4/fhnty40ebkuydrbdwacgmxmnghk.png"><br><br>  Returning to the ‚Äúmain thought‚Äù: is it worth trusting my experience at all?  Since the beginning of this year I have looked at <b>85 projects</b> .  Not all of them were microservice (approximately one third to one half of them had such architecture), but this is still a large number.  We (the company "Flant") as outsourcers manage to see a wide variety of applications developed both in small companies (with 5 developers) and large ones (~ 500 developers).  An additional advantage is that we see how these applications live and develop over the years. <br><br><h2>  Why microservices? </h2><br>  When asked about the benefits of microservices, there is a <a href="https://martinfowler.com/articles/microservice-trade-offs.html">very specific answer</a> to the already mentioned Martin Fowler: <br><br><ol><li>  clear limits of modularity; </li><li>  independent deployment; </li><li>  freedom of choice of technology. </li></ol><br>  I talked a lot with architects and software developers and asked why they need microservices.  And he made his list of their expectations.  Here's what happened: <br><br><img src="https://habrastorage.org/webt/su/g3/nb/sug3nbuvq8arpcszp9eprf0swto.png"><br><br>  If we describe ‚Äúin sensations‚Äù some of the points, then: <br><br><ul><li>  clear borders of the modules: here we have a terrible monolith, and now everything will be neatly laid out in Git-repositories, in which everything is ‚Äúon the shelves‚Äù, not warm and soft; </li><li>  Deployment independence: we will be able to roll out services independently so that development goes faster (in parallel, publish new features); </li><li>  development independence: we can give this microservice to that team / developer, and that one is different, thanks to which we can develop it faster; </li><li>  more reliability: if a partial degradation happens (one microservice of 20 drops), then only one button will stop working, and the system as a whole will continue to function. </li></ul><br><h2>  Typical (harmful) microservice architecture </h2><br>  To explain why, in reality, things are not as we expect, I will present a <i>collective</i> image of microservice architecture based on the experience of many different projects. <br><br>  An example would be an abstract online store that is going to compete with Amazon or at least OZON.  Its microservice architecture looks like this: <br><br><img src="https://habrastorage.org/webt/ly/sl/7-/lysl7-cb72eaj8wnhes4bgina84.gif"><br><br>  For a combination of reasons, these microservices are written on different platforms: <br><br><img src="https://habrastorage.org/webt/x6/hu/rt/x6hurt6jnp-cdugf_mcopvhaqu8.png"><br><br>  Since each microservice should have autonomy, many of them need their own database and cache.  The final architecture is obtained as follows: <br><br><img src="https://habrastorage.org/webt/ee/dr/_x/eedr_xp3mh22lyb9b04ewqzm1ek.png"><br><br><h2>  What are its consequences? </h2><br>  Fowler also <a href="https://martinfowler.com/articles/microservice-trade-offs.html">has an article</a> on this subject - about ‚Äúpayback‚Äù for using microservices: <br><br><img src="https://habrastorage.org/webt/v8/9l/0j/v89l0j0ucc2icw34ojowadgf4w0.jpeg"><br><br>  And we will see if our expectations were met. <br><br><h3>  Clear module boundaries ... </h3><br>  But <b>how many microservices do we really need to fix</b> in order to roll out the change?  Can we even figure out how everything works, without a distributed tracer (after all, any request is processed by half of microservices)? <br><br>  There is a ‚Äú <a href="http://www.laputan.org/mud/">big clump of dirt</a> ‚Äù pattern, and here we have a distributed clump of dirt.  In confirmation of this, here‚Äôs a rough illustration of how requests go: <br><br><img src="https://habrastorage.org/webt/9x/p4/dg/9xp4dgwekrlygkemlygsisl6nxm.jpeg"><br><br><h3>  Deployment independence ... </h3><br>  Technically, it has been achieved: we can roll each microservice separately.  But in practice it is necessary to take into account that a <b>lot of microservices</b> always roll out, and we need to take into account the <b>order of their rollout</b> .  In an amicable way, we generally need to test in a separate circuit, whether we roll out the release in the correct order. <br><br><h3>  Freedom to choose technology ... </h3><br>  She is.  Only it is worth remembering that often freedom borders on lawlessness.  It is very important here not to choose technologies only in order to ‚Äúplay‚Äù with them. <br><br><h3>  Development independence ... </h3><br>  How to make a test loop for the entire application (from so many components)?  But still need to keep it up to date.  All this leads to the fact that the <b>actual number of test circuits</b> , which in principle we can contain, <b>turns out to be minimal</b> . <br><br>  And to deploy all this locally? .. It turns out that often the developer does his work independently, but ‚Äúat random‚Äù, because he has to wait for the circuit to be released for testing. <br><br><h3>  Separate scaling ... </h3><br>  Yes, but it is limited in the area of ‚Äã‚Äãthe used DBMS.  In the given example of architecture, Cassandra will have no problems, but MySQL and PostgreSQL will have problems. <br><br><h3>  More reliability ... </h3><br>  Moreover, in reality, disabling one microservice often breaks the correct functioning of the entire system, so there is also a new problem: <b>every microservice is very difficult to make fault-tolerant</b> .  Because microservices use different technologies (memcache, Redis, etc.), everyone needs to think over and implement everything, which, of course, is possible, but requires huge resources. <br><br><h3>  Load measurability ... </h3><br>  This is really all good. <br><br><h3>  ‚ÄúLightness‚Äù of microservices ... </h3><br>  Not only did we have huge <b>network overheads</b> (multiply queries for DNS, etc.), but also because of the many subqueries we began to <b>replicate data</b> (store caches), which led to a significant amount of storage. <br><br>  And here is the result of meeting our expectations: <br><br><img src="https://habrastorage.org/webt/hg/oe/35/hgoe35hkyfy3kfkmhxguoqq5rne.png"><br><br><h3>  But that's not all! </h3><br>  Because: <br><br><ul><li>  Most likely we will need a message bus. </li><li>  How to make a consistent backup at the right time?  The only <i>real</i> option is to turn off traffic for this.  But how to do this in production? </li><li>  If we are talking about supporting several regions, then organizing sustainability in each of them is a very time consuming task. </li><li>  There is a problem of making centralized changes.  For example, if we need to update the version of PHP, then we need to commit to each repository (and there are dozens of them). </li><li>  The growth of operational complexity offhand turns out to be exponential. </li></ul><br><h2>  What to do with all this? </h2><br>  <b>Start with a monolithic application</b> .  Experience Fowler'a <a href="https://martinfowler.com/bliki/MonolithFirst.html">says</a> that almost all successful microservice applications began with a monolith, which became too large, after which it was broken.  At the same time, almost all systems built as microservices from the very beginning, sooner or later experienced serious problems. <br><br>  Another valuable thought is that in order to succeed in a microservice architecture project, you should know the <b>subject area</b> very well <b>, and how to make microservices</b> .  And the best way to know the subject area is to make a monolith. <br><br><h2>  But what if we are already in this situation? </h2><br>  The first step to solving any problem is to agree with it and understand that this is a problem, that we no longer want to suffer. <br><br>  If in the case of an overgrown monolith (when we‚Äôre out of the opportunity to re-buy resources for it), we cut it, then in this case we get the opposite story: when excessive microservice doesn‚Äôt help anymore, but interferes with it - <b>cut off the excess and enlarge</b> ! <br><br>  For example, for the above collective image ... <br><br>  Get rid of the most dubious microservices: <br><br><img src="https://habrastorage.org/webt/tf/-s/su/tf-ssueuj8be3jxrwhqfqwocqjo.png"><br><br>  Combine all microservices responsible for front-end generation: <br><br><img src="https://habrastorage.org/webt/ii/sw/gs/iiswgsg4bjx69wpgn8vk3_xxp70.png"><br><br>  ... into one microservice written in one (modern and normal, as you yourself think) language / framework: <br><br><img src="https://habrastorage.org/webt/vy/yk/hi/vyykhitrn3crjfplovw_acdoicu.png"><br><br>  It will have one ORM (one DBMS) and first a couple of applications: <br><br><img src="https://habrastorage.org/webt/4x/pe/7s/4xpe7siw54omsbrabwatzggsp1c.png"><br><br>  ... but in general there can be transferred much more, having obtained the following result: <br><br><img src="https://habrastorage.org/webt/gv/cc/mz/gvccmzms2zvyzzg1kfttpyih2bk.png"><br><br>  Moreover, in Kubernetes we launch all of this in separate instances, which means that we can still measure the load and scale them separately. <br><br><h2>  Summarizing </h2><br>  Look at the picture wider.  Very often, all these problems with microservices arise from the fact that someone took his task, but wanted to "play microservices." <br><br>  <b>In the word ‚Äúmicroservices‚Äù the part ‚Äúmicro‚Äù is superfluous</b> .  They are ‚Äúmicro‚Äù only for the reason that they are smaller than a huge monolith.  But do not think of them as something small. <br><br>  And for the final thought, let's return to the original schedule: <br><br><img src="https://habrastorage.org/webt/w8/t5/lg/w8t5lgftdcf1zjri4aekoipk1p0.png"><br><br>  The note written to it <i>(top right)</i> boils down to the fact that the <b>skills of the team that makes your project are always primary</b> - they will play a key role in your choice between microservices and monolith.  If a team does not have enough skills, but it starts doing microservices, the story will definitely be fatal. <br><br><h2>  Video and slides </h2><br>  Video from the speech (~ 50 minutes; unfortunately, it does not convey the numerous emotions of visitors, which largely determined the mood of the report, but as it is): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/g9cgppj0gKQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Presentation of the report: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  PS </h2><br>  Other reports on our blog: <br><br><ul><li>  ‚Äú <a href="https://habr.com/company/flant/blog/412901/">Monitoring and Kubernetes</a> ‚Äù <i>(Dmitry Stolyarov; May 28, 2018 at RootConf)</i> ; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/345116/">Best CI / CD practices with Kubernetes and GitLab</a> ‚Äù <i>(Dmitry Stolyarov; November 7, 2017 on HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/331188/">Our experience with Kubernetes in small projects</a> ‚Äù <i>(Dmitry Stolyarov; June 6, 2017 at RootConf)</i> ; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/324274/">We assemble Docker images for CI / CD quickly and conveniently along with dapp</a> ‚Äù <i>(Dmitry Stolyarov; November 8, 2016 on HighLoad ++)</i> ; </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/322686/">Practices of Continuous Delivery with Docker</a> ‚Äù <i>(Dmitry Stolyarov; May 31, 2016 at RootConf)</i> . </li></ul><br>  You may also be interested in the following publications: <br><br><ul><li>  ‚ÄúThe <a href="https://habr.com/company/flant/blog/347518/">Death of Microservice Madness in 2018</a> ‚Äù; </li><li>  " <a href="https://habr.com/company/flant/blog/425085/">7 best practices for the operation of containers according to Google</a> "; </li><li>  " <a href="https://habr.com/company/flant/blog/340270/">The New Stack statistics about the difficulties of implementing Kubernetes</a> ." </li></ul></div><p>Source: <a href="https://habr.com/ru/post/424531/">https://habr.com/ru/post/424531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424511/index.html">Tools for searching annotated classes in Java</a></li>
<li><a href="../424513/index.html">About cheap data centers, RKN and DDoS protection</a></li>
<li><a href="../424517/index.html">Implementation of the minimization of logical functions by the Kvayna-Mak'Klaski method with an incomplete input set</a></li>
<li><a href="../424519/index.html">Can Beethoven send removal requests?</a></li>
<li><a href="../424525/index.html">Minidrill speed controller</a></li>
<li><a href="../424533/index.html">‚ÄúAny self-respecting IT person is engaged in technology and in his spare time‚Äù - 10 questions for a programmer, issue 6</a></li>
<li><a href="../424537/index.html">Sberbank launched its own operator SberMobile</a></li>
<li><a href="../424539/index.html">Java 11: New in String</a></li>
<li><a href="../424541/index.html">The UGJ-2018 story fiasco: how to make a game that nobody would like (do not do that!)</a></li>
<li><a href="../424543/index.html">Java 11 / JDK 11: General Availability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>