<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We accept payments by cryptocurrency using PayKassa aggregator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In my last article, I told you how to connect a cryptocurrency receipt with your own hands without using third-party services. In this artic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We accept payments by cryptocurrency using PayKassa aggregator</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  In <a href="https://habrahabr.ru/post/350430/">my last article,</a> I told you how to connect a cryptocurrency receipt with your own hands without using third-party services.  In this article I will explain how you can accept payments with cryptocurrency without raising a full node and without the associated difficulties. </p><br><p>  But, as it always happens, you will have to pay for the convenience.  <a href="https://paykassa.pro/">PayKassa is</a> considered as an aggregator, as it allows you to accept payments anonymously with average market commissions, without the need to confirm your identity and company data. </p><a name="habracut"></a><br><h1 id="registraciya-i-nastroyka">  Registration and setup </h1><br><p>  Registration is very simple, setting up is somewhat more complicated. </p><br><p>  I advise you to create 2 stores, one for development and testing, and the second - "combat".  For local development, it is very convenient to use <a href="https://ngrok.io/">ngrok</a> and specify the appropriate domain (having checked beforehand that it is free). </p><br><p>  Making the store as simple as possible: </p><br><img width="595" src="https://habrastorage.org/webt/du/lz/o4/dulzo4aiskmu07sqjfnoupxkbf0.png"><br><p>  In the form that opens, most of the fields should not cause difficulties: </p><br><img width="199" src="https://habrastorage.org/webt/fl/mv/bx/flmvbxzcez1gq0kwfzicg3ry7qa.png"><br><p>  For a test store, it will be most convenient to specify any free ngrok domain.  Handler URL is the address where PayKassa will knock to notify that the order status has changed.  "URL successful / unsuccessful payment" - the address where the user will be sent after the payment.  They can accommodate a simple page describing what the user needs to do after a successful / unsuccessful payment. </p><br><p>  After creation, we need the store ID: </p><br><p><img src="https://habrastorage.org/webt/5r/av/gz/5ravgzo_sutzdtywidze1foswbc.png"></p><br><p>  Further, if you wish, you can specify in the settings who pays the commission and which payment systems you want to connect. </p><br><p>  This is all that is required to start accepting payments. </p><br><h1 id="poluchenie-url-dlya-platezha">  Getting a URL for payment </h1><br><p>  The article will use the true value for the test parameter in all requests.  To go into combat mode is enough not to specify it. </p><br><p>  PayKassa has a <a href="https://paykassa.pro/developers/">simple PHP wrapper for working with the API</a> , but for other languages, writing such a wrapper should also not cause difficulties.  And for a better understanding of the process, all examples will be accompanied by an example of queries using curl. </p><br><p>  I did not find the possibility of using ready-made pages with a choice of payment method, but this is not always required.  Moreover, to make it yourself is quite simple.  On <a href="https://paykassa.pro/developers/">the developer page</a> there is a correspondence between payment systems and internal ID: </p><br><p><img src="https://habrastorage.org/webt/t5/sl/gk/t5slgk5o8unhmcgaya_rhkn6p9e.png"></p><br><p>  As a currency, we will use Bitcoin everywhere (system: 11, currency: "BTC"). </p><br><p> PayKassa payment API is located at <code>https://paykassa.pro/sci/0.3/index.php</code> (at the time of writing) and supports two methods: <code>sci_create_order</code> to get the payment URL and <code>sci_confirm_order</code> to check the status of the payment. </p><br><p>  An example of getting a payment URL using curl: </p><br><pre> <code class="bash hljs">curl https://paykassa.pro/sci/0.3/index.php -d <span class="hljs-string"><span class="hljs-string">'func=sci_create_order&amp;amount=0.1&amp;currency=BTC&amp;order_id=1&amp;comment=test&amp;system=4&amp;sci_id=SCI_ID&amp;sci_key=SCI_KEY&amp;domain=DOMAIN&amp;test=false'</span></span> -H <span class="hljs-string"><span class="hljs-string">'Content-type: application/x-www-form-urlencoded'</span></span></code> </pre> <br><p>  Using the PHP library ( <a href="">link to paykassa_sci.class.php</a> ): </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(<span class="hljs-string"><span class="hljs-string">'paykassa_sci.class.php'</span></span>); $paykassa = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PayKassaSCI( $paykassa_shop_id, <span class="hljs-comment"><span class="hljs-comment">//   $paykassa_shop_password //   ); // : , ,  , ,   $res = $paykassa-&gt;sci_create_order(0.01, "BTC", 1, "Test Payment", 11); if ($res['error']) { echo $res['message']; // $res['message'] -     //    } else { //     $redirect_uri = $res['data']['url']; header("Refresh: 0; url=$redirect_uri"); } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><p>  To work with the API in other languages, it will be convenient to write a small wrapper and use it: </p><br><p>  For ruby: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># paykassa.rb require 'net/http' class Paykassa BASE_SCI_URI = URI('https://paykassa.pro/sci/0.3/index.php') #   Ruby On Rails   #  secrets.yml    : # paykassa: # sci_id: SCI_ID # sci_key: SCI_SECRET_KEY # domain: SCI_DOMAIN #     RoR -       : # def initialize(auth) #        auth    sci_id, sci_key  domain def initialize(auth = Rails.application.secrets[:paykassa]) @_auth = auth end #    ,       JSON    def create_order(amount:, currency:, order_id:, comment:, system:) make_request( func: :sci_create_order, amount: amount, currency: currency, order_id: order_id, comment: comment, system: system ) end #    def confirm_order(private_hash) make_request(func: :sci_confirm_order, private_hash: private_hash) end private def make_request(data) res = Net::HTTP.post_form(BASE_SCI_URI, data.merge(@_auth)) JSON.parse(res.body).deep_symbolize_keys end end</span></span></code> </pre> <br><p>  Getting url for payment: </p><br><pre> <code class="ruby hljs"> paykassa = Paykassa.new <span class="hljs-comment"><span class="hljs-comment">#   secrets.yml      : # paykassa = Paykassa.new(sci_id: 0, sci_key: '123', domain: 'habrashop.ngrok.io') result = paykassa.create_order( amount: 0.01, currency: 'BTC', order_id: 1, comment: "Payment ‚Ññ1", system: 11 ) #    raise StandardError.new(result[:message]) if result[:error] url = result[:data][:url] #       url: redirect_to url</span></span></code> </pre> <br><p>  For node.js: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> https = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'https'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> querystring = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'querystring'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mergeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array1,array2</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> array1) { array2[item] = array1[item]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array2; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PayKassaApi</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sci_id, sci_key, domain, test</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sci_id = sci_id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sci_key = sci_key; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.domain = domain; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.test = test || <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }; PayKassaApi.methods = [ <span class="hljs-string"><span class="hljs-string">'sci_create_order'</span></span>, <span class="hljs-string"><span class="hljs-string">'sci_confirm_order'</span></span> ] PayKassaApi.prototype.sendRequest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method, params, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PayKassaApi.methods.indexOf(method) === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'wrong method name '</span></span> + method) }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { callback = params; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: method, <span class="hljs-attr"><span class="hljs-attr">sci_id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sci_id, <span class="hljs-attr"><span class="hljs-attr">sci_key</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sci_key, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.domain, <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.test } data = mergeArray(params, data) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = querystring.stringify(data); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">'paykassa.pro'</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/sci/0.3/index.php'</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span> }, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = https.request(options, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-string"><span class="hljs-string">''</span></span>; response.setEncoding(<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); response.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chunk</span></span></span><span class="hljs-function">) </span></span>{ result += chunk; }); <span class="hljs-comment"><span class="hljs-comment">// Listener for intializing callback after receiving complete response response.on('end', function () { try { callback(JSON.parse(result)); } catch (e) { console.error(e); callback(result); } }); }); request.write(body) request.end() }; for (var i = 0; i &lt; PayKassaApi.methods.length; i++) { PayKassaApi.prototype[PayKassaApi.methods[i]] = function (method) { return function (params, callback) { this.sendRequest(method, params, callback) } }(PayKassaApi.methods[i]) } module.exports = PayKassaApi</span></span></code> </pre> <br><p>  Using: </p><br><pre> <code class="hljs pgsql">var PayKassa = require("./paykassa") var paykassa = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Api({ sci_id: <span class="hljs-number"><span class="hljs-number">0</span></span>, sci_key: <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'habratest.ngrok.io'</span></span>, test: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }) paykassa.sci_create_order({ amount: <span class="hljs-number"><span class="hljs-number">0.01</span></span>, currency: <span class="hljs-string"><span class="hljs-string">'BTC'</span></span>, order_id: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-string"><span class="hljs-string">'test order ‚Ññ1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (res) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.error) { //   -  <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Error(res.message) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //       /   console.log(res.data.url) } })</code> </pre> <br><p>  For python: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> httplib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PayKassa</span></span></span><span class="hljs-class">:</span></span> sci_domain = <span class="hljs-string"><span class="hljs-string">'paykassa.pro'</span></span> sci_path = <span class="hljs-string"><span class="hljs-string">'/sci/0.3/index.php'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, sci_id, sci_key, domain, test)</span></span></span><span class="hljs-function">:</span></span> self.sci_id = sci_id self.sci_key = sci_key self.domain = domain self.test = test <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sci_create_order</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, amount, currency, order_id, comment, system)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.make_request({ <span class="hljs-string"><span class="hljs-string">'func'</span></span>: <span class="hljs-string"><span class="hljs-string">'sci_create_order'</span></span>, <span class="hljs-string"><span class="hljs-string">'amount'</span></span>: amount, <span class="hljs-string"><span class="hljs-string">'currency'</span></span>: currency, <span class="hljs-string"><span class="hljs-string">'order_id'</span></span>: order_id, <span class="hljs-string"><span class="hljs-string">'comment'</span></span>: comment, <span class="hljs-string"><span class="hljs-string">'system'</span></span>: system }) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sci_confirm_order</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, private_hash)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.make_request({ <span class="hljs-string"><span class="hljs-string">'func'</span></span>: <span class="hljs-string"><span class="hljs-string">'sci_confirm_order'</span></span>, <span class="hljs-string"><span class="hljs-string">'private_hash'</span></span>: private_hash }) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, params)</span></span></span><span class="hljs-function">:</span></span> fields = {<span class="hljs-string"><span class="hljs-string">'sci_id'</span></span>: self.sci_id, <span class="hljs-string"><span class="hljs-string">'sci_key'</span></span>: self.sci_key, <span class="hljs-string"><span class="hljs-string">'domain'</span></span>: self.domain, <span class="hljs-string"><span class="hljs-string">'test'</span></span>: self.test}.copy() fields.update(params) encoded_fields = urllib.urlencode(fields) headers = {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>} conn = httplib.HTTPSConnection(self.sci_domain) conn.request(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, self.sci_path, encoded_fields, headers) response = conn.getresponse() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.loads(response.read())</code> </pre> <br><p>  Using: </p><br><pre> <code class="python hljs">paykassa = PayKassa(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-string"><span class="hljs-string">'habratest.ngrok.io'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) result = paykassa.sci_create_order(<span class="hljs-number"><span class="hljs-number">0.001</span></span>, <span class="hljs-string"><span class="hljs-string">'BTC'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'Order number 1'</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result[<span class="hljs-string"><span class="hljs-string">'error'</span></span>]: print(result[<span class="hljs-string"><span class="hljs-string">'message'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(result[<span class="hljs-string"><span class="hljs-string">'data'</span></span>][<span class="hljs-string"><span class="hljs-string">'url'</span></span>])</code> </pre> <br><p>  The request itself is a regular multipart form / data POST request. </p><br><p>  Description of parameters: </p><br><ul><li>  func - API method </li><li>  system - the ID of the payment system, the list of correspondence between the ID and payment systems, see above. </li><li>  currency - the currency of payment, the possible values ‚Äã‚Äãalso see above. </li><li>  amount - amount in payment currency </li><li>  order_id - a unique identifier of the order, you must generate it yourself </li><li>  comment - a comment to the order, available to the client (need to check) </li><li>  sci_id - store ID, received during store creation </li><li>  sci_key - the secret key of the store, specified when creating the store </li><li>  domain - the domain specified when creating the store </li><li>  test - test mode </li></ul><br><p>  In response, you will receive a similar JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"error"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://paykassa.pro/sci/redir.php?hash=HASH"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"HASH"</span></span> } } }</code> </pre> <br><p>  From it we are interested in the <code>error</code> key and <code>data.url</code> .  If <code>error</code> is <code>false</code> , then you can redirect the user to the address specified in <code>data.url</code> . </p><br><p>  If you go to this address in non-test mode, you can see the payment page: </p><br><p><img src="https://habrastorage.org/webt/yn/qo/zk/ynqozkyv91mbxlyjeonvwnjaamc.png" alt="Payment page"></p><br><h1 id="proverka-oplaty">  Check payment </h1><br><p>  After making the payment, PayKassa will contact you at the server address specified in the field "Handler URL" when creating the store.  This appeal will contain only the order ID, without its status.  To get the status of the order (successfully processed or not) - you need to make a request indicating the received identifier: </p><br><pre> <code class="bash hljs">curl https://paykassa.pro/sci/0.3/index.php -d <span class="hljs-string"><span class="hljs-string">'func=sci_confirm_order&amp;private_hash=PRIVATE_HASH&amp;sci_id=SCI_ID&amp;sci_key=SCI_KEY&amp;domain=DOMAIN&amp;test=true'</span></span> -H <span class="hljs-string"><span class="hljs-string">'Content-type: application/x-www-form-urlencoded'</span></span></code> </pre> <br><p>  Example for ruby: </p><br><pre> <code class="ruby hljs"> paykassa = Paykassa.new private_hash = params[<span class="hljs-symbol"><span class="hljs-symbol">:private_hash</span></span>] <span class="hljs-comment"><span class="hljs-comment">#  RoR / sinatra result = paykassa.confirm_order(private_hash) #    raise StandardError.new(result[:message]) if result[:error] order_id = res[:data][:order_id] # ID  amount = res[:data][:amount] #  </span></span></code> </pre> <br><p>  Python example: </p><br><pre> <code class="python hljs">paykassa = PayKassa(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-string"><span class="hljs-string">'habratest.ngrok.io'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) result = paykassa.confirm_order(request.POST[<span class="hljs-string"><span class="hljs-string">'private_hash'</span></span>]) <span class="hljs-comment"><span class="hljs-comment">#   Django if result['error']: print(result['message']) else: print(result['data']['order_id']) print(result['data']['amount'])</span></span></code> </pre> <br><p>  Well, an example for node.js: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PayKassa = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"./paykassa"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paykassa = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Api({ <span class="hljs-attr"><span class="hljs-attr">sci_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">sci_key</span></span>: <span class="hljs-string"><span class="hljs-string">'123'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'habratest.ngrok.io'</span></span>, <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) paykassa.sci_confirm_order({ <span class="hljs-attr"><span class="hljs-attr">private_hash</span></span>: req.body.private_hash <span class="hljs-comment"><span class="hljs-comment">//   express }, function (res) { if (res.error) { //   -  Exception throw new Error(res.message) } else { //       console.log(res.data.order_id) console.log(res.data.amount) } })</span></span></code> </pre> <br><p>  In response, a similar JSON will come: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"error"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>,<span class="hljs-attr"><span class="hljs-attr">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"  "</span></span>,<span class="hljs-attr"><span class="hljs-attr">"data"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"transaction"</span></span>:<span class="hljs-string"><span class="hljs-string">"XXX"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"shop_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"XXX"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"order_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"amount"</span></span>:<span class="hljs-string"><span class="hljs-string">"0.01"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"currency"</span></span>:<span class="hljs-string"><span class="hljs-string">"BTC"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"system"</span></span>:<span class="hljs-string"><span class="hljs-string">"bitcoin"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"hash"</span></span>:<span class="hljs-string"><span class="hljs-string">"HASH"</span></span>}}</code> </pre> <br><p>  Everything is standard here - if <code>error</code> is <code>false</code> - it means that the payment for the <code>data.order_id</code> order for the amount of <code>data.amount</code> was successful.  <code>data.amount</code> contains the actual payment amount received.  Depending on your logic of processing orders and issuing payments, it is sometimes necessary to check it (for example, transfer of funds, where the user himself specifies the amount), sometimes not (for example, if the user cannot in any way directly affect the amount of the order or we credit the amount without commission). </p><br><p>  Also, it is worth noting that at about the same time the user is redirected to the URL of a successful / unsuccessful payment. </p><br><p>  On this process, the basic integration can be considered successfully completed.  As you can see, the integration of the aggregator turned out to be much simpler than the implementation of receiving payments by yourself.  If your volumes are less than $ 100- $ 1000 per month - then this method is likely to be more profitable for you. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/351550/">https://habr.com/ru/post/351550/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351536/index.html">UI Autotests for Xamarin</a></li>
<li><a href="../351540/index.html">Analysis of performance tasks with JBreak (part 3)</a></li>
<li><a href="../351542/index.html">IBM Cloud Caf√© - Kubernetes meetup</a></li>
<li><a href="../351544/index.html">Katalon Recorder Review and Tutorial (Selenium IDE ++ for Chrome and Firefox)</a></li>
<li><a href="../351548/index.html">How to get PCI DSS certification: IT GRAD experience</a></li>
<li><a href="../351554/index.html">Microsoft Announces DirectX Raytracing Ray Tracing API</a></li>
<li><a href="../351556/index.html">We implement our operator in the Entity Framework Core</a></li>
<li><a href="../351558/index.html">Jessica Livingston (Y Combinator): ‚ÄúThe Sound of Silence‚Äù</a></li>
<li><a href="../351562/index.html">From patches in the fight against malware to a holistic strategy</a></li>
<li><a href="../351564/index.html">Wireless LANs or how Wi-Fi works according to IEEE 802.11 standard. Lab at Packet Tracer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>