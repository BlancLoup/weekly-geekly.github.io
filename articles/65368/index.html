<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Safari plugin? Easily!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, I finally got tired of running Firefox every time I need to quickly pull out an XPath site for an element (there‚Äôs a nice XPather extension for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Safari plugin? Easily!</h1><div class="post__text post__text-html js-mediator-article">  Today, I finally got tired of running Firefox every time I need to quickly pull out an XPath site for an element (there‚Äôs a nice <a href="http://xpath.alephzarro.com/">XPather</a> extension for this), and I decided to look at how to inject my code into a Cocoa application. <br><a name="habracut"></a><br><br>  The general principle is simple: Objective-C runtime allows you to get a pointer to any class from anywhere on the program and perform all sorts of tricks with it.  Taking the <a href="http://www.culater.net/wiki/moin.cgi/CocoaReverseEngineering">SIMBL manual as a reference</a> , I began to develop a bundle. <br><br>  The task was as follows: add an item to the context menu of Safari, upon activation of which an XPath selection will be made for the element under the cursor.  Using <a href="http://www.fscript.org/">F-Script Anywhere,</a> I literally found out in a minute that the implementation of WebUIDelegate (including the webView method: contextMenuItemsForElement: defaultMenuItems :) in the target browser corresponds to the BrowserWebView class.  This means that it is necessary to replace the methods, for which we will use the DTRenameSelector function: <br><blockquote><ol><li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li> <code><font color="#002200"><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> { Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></font></code> </li> <li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li></li><li> <code><font color="#11740a"><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; // First, look for the methods method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></font></code> </li> <li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li></li><li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li> <code><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; <font color="#002200">}</font></code> </li> <li> <code><font color="#002200"><font color="#a61390">BOOL</font> DTRenameSelector <font color="#002200">(</font> <font color="#a61390">Class</font> _class, <font color="#a61390">SEL</font> _oldSelector, <font color="#a61390">SEL</font> _newSelector <font color="#002200">)</font> <font color="#002200">{</font> Method method <font color="#002200">=</font> <font color="#a61390">nil</font> ; <font color="#11740a">// First, look for the methods</font> method <font color="#002200">=</font> class_getInstanceMethod <font color="#002200">(</font> _class, _oldSelector <font color="#002200">)</font> ; <font color="#a61390">if</font> <font color="#002200">(</font> method <font color="#002200">==</font> <font color="#a61390">nil</font> <font color="#002200">)</font> <font color="#a61390">return</font> <font color="#a61390">NO</font> ; method <font color="#002200">-</font> &gt;method_name <font color="#002200">=</font> _newSelector; <font color="#a61390">return</font> <font color="#a61390">YES</font> ; }</font></code> </li> </ol></blockquote><br>  Now you can make a stub for our "fake" selector: <br><blockquote><ol><li>  <font color="#a61390">static</font> <font color="#400080">NSArray</font> <font color="#002200">*</font> webView_contextMenuItemsForElement_defaultMenuItems_ <font color="#002200">(</font> <font color="#a61390">id</font> self, <font color="#a61390">SEL</font> _cmd, </li><li>  <font color="#a61390">id</font> <font color="#002200">*</font> sender, <font color="#400080">NSDictionary</font> <font color="#002200">*</font> element, <font color="#400080">NSArray</font> <font color="#002200">*</font> defaultMenuItems <font color="#002200">)</font> </li><li>  <font color="#002200">{</font> </li><li>  <font color="#a61390">return</font> <font color="#002200">[</font> self </li><li>  _sxp_orig_webView <font color="#002200">:</font> sender </li><li>  contextMenuItemsForElement <font color="#002200">:</font> element </li><li>  defaultMenuItems <font color="#002200">:</font> defaultMenuItems <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li></ol></blockquote><br>  Since this is a C function, the first two arguments of the method (self and _cmd) must be specified explicitly.  Internally, the function calls the real selector, which we will need to rename at boot.  Runtime promises us to execute the + load method when initializing any class, which we will use: <br><blockquote><ol><li>  <font color="#a61390">static</font> SXPPlugin <font color="#002200">*</font> Plugin <font color="#002200">=</font> <font color="#a61390">nil</font> ; </li><li></li><li>  <font color="#a61390">@implementation</font> SXPPlugin </li><li></li><li>  <font color="#002200">+</font> <font color="#002200">(</font> SXPPlugin <font color="#002200">*</font> <font color="#002200">)</font> sharedInstance </li><li>  <font color="#002200">{</font> </li><li>  <font color="#a61390">@synchronized</font> <font color="#002200">(</font> self <font color="#002200">)</font> <font color="#002200">{</font> </li><li>  <font color="#a61390">if</font> <font color="#002200">(</font> <font color="#002200">!</font> Plugin <font color="#002200">)</font> </li><li>  Plugin <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> SXPPlugin alloc <font color="#002200">]</font> init <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li><li>  <font color="#a61390">return</font> plugin; </li><li>  <font color="#002200">}</font> </li><li></li><li>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#a61390">void</font> <font color="#002200">)</font> swizzle </li><li>  <font color="#002200">{</font> </li><li>  <font color="#a61390">Class</font> BrowserWebView <font color="#002200">=</font> objc_getClass <font color="#002200">(</font> <font color="#bf1d1a">"BrowserWebView"</font> <font color="#002200">)</font> ; </li><li>  <font color="#a61390">if</font> <font color="#002200">(</font> BrowserWebView <font color="#002200">)</font> <font color="#002200">{</font> </li><li>  class_addMethod <font color="#002200">(</font> </li><li>  BrowserWebView, </li><li>  <font color="#a61390">@selector</font> <font color="#002200">(</font> _sxp_fake_webView <font color="#002200">:</font> contextMenuItemsForElement <font color="#002200">:</font> defaultMenuItems <font color="#002200">:)</font> , </li><li>  <font color="#002200">(</font> <font color="#a61390">IMP</font> <font color="#002200">)</font> webView_contextMenuItemsForElement_defaultMenuItems_, </li><li>  <font color="#bf1d1a">"@@: @@@"</font> <font color="#002200">)</font> ; </li><li></li><li>  DTRenameSelector <font color="#002200">(</font> </li><li>  BrowserWebView, </li><li>  <font color="#a61390">@selector</font> <font color="#002200">(</font> webView <font color="#002200">:</font> contextMenuItemsForElement <font color="#002200">:</font> defaultMenuItems <font color="#002200">:)</font> , </li><li>  <font color="#a61390">@selector</font> <font color="#002200">(</font> _sxp_orig_webView <font color="#002200">:</font> contextMenuItemsForElement <font color="#002200">:</font> defaultMenuItems <font color="#002200">:)</font> <font color="#002200">)</font> ; </li><li>  DTRenameSelector <font color="#002200">(</font> </li><li>  BrowserWebView, </li><li>  <font color="#a61390">@selector</font> <font color="#002200">(</font> _sxp_fake_webView <font color="#002200">:</font> contextMenuItemsForElement <font color="#002200">:</font> defaultMenuItems <font color="#002200">:)</font> , </li><li>  <font color="#a61390">@selector</font> <font color="#002200">(</font> webView <font color="#002200">:</font> contextMenuItemsForElement <font color="#002200">:</font> defaultMenuItems <font color="#002200">:)</font> <font color="#002200">)</font> ; </li><li>  <font color="#002200">}</font> <font color="#a61390">else</font> <font color="#002200">{</font> </li><li>  NSLog <font color="#002200">(</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"Failed to get BrowserWebView class"</font> <font color="#002200">)</font> ; </li><li>  <font color="#002200">}</font> </li><li>  <font color="#002200">}</font> </li><li></li><li>  <font color="#002200">+</font> <font color="#002200">(</font> <font color="#a61390">void</font> <font color="#002200">)</font> load </li><li>  <font color="#002200">{</font> </li><li>  SXPPlugin <font color="#002200">*</font> plugin <font color="#002200">=</font> <font color="#002200">[</font> SXPPlugin sharedInstance <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> plugin swizzle <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li><li></li><li>  <font color="#a61390">@end</font> </li></ol></blockquote><br>  What is going on here?  As soon as our bundle is loaded into Safari, the + [SXPPlugin load] method will work, which, firstly, will create the first (and last) instance of itself, and, secondly, will replace the method in BrowserWebView, by adding a dummy selector (_sxp_fake) , rename the present to (_sxp_orig) and then install the fictitious in its place.  In fact, _sxp_orig here points not to the code inside Safari, but to another extension that was loaded earlier - Speed ‚Äã‚ÄãDownload.  And after SXPPlugin, 1Password will still be loaded, and it will also be inserted into the chain in the same way (if all of this would have to be unloaded, then the most important thing is to keep order).  By the way, the "@@: @@@" for the selector description means that the selector returns id (first @) and accepts (id, SEL, id, id, id). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything, at this stage you can assemble a bundle, hook it to the SIMBL or directly to InputManagers (but this is not so convenient) and look at how Safari continues to work :) <br><br>  We continue to increase the functionality, we need our own element in this menu: <br><blockquote><ol><li>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#a61390">id</font> <font color="#002200">)</font> init </li><li>  <font color="#002200">{</font> </li><li>  <font color="#a61390">if</font> <font color="#002200">(</font> <font color="#002200">(</font> self <font color="#002200">=</font> <font color="#002200">[</font> super init <font color="#002200">]</font> <font color="#002200">)</font> <font color="#002200">)</font> <font color="#002200">{</font> </li><li>  <font color="#11740a">// init menu</font> </li><li>  <font color="#400080">NSMenu</font> <font color="#002200">*</font> m <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> <font color="#400080">NSMenu</font> alloc <font color="#002200">]</font> initWithTitle <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"XPath"</font> <font color="#002200">]</font> ; </li><li>  <font color="#400080">NSMenuItem</font> <font color="#002200">*</font> mi <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> <font color="#400080">NSMenuItem</font> alloc <font color="#002200">]</font> </li><li>  initWithTitle <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"XPath for node"</font> </li><li>  action <font color="#002200">:</font> <font color="#a61390">@selector</font> <font color="#002200">(</font> onMenu <font color="#002200">:)</font> </li><li>  keyEquivalent <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">""</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> mi setTarget <font color="#002200">:</font> self <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> m addItem <font color="#002200">:</font> mi <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> mi release <font color="#002200">]</font> ; </li><li>  mi <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> <font color="#400080">NSMenuItem</font> alloc <font color="#002200">]</font> </li><li>  initWithTitle <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"Show browser"</font> </li><li>  action <font color="#002200">:</font> <font color="#a61390">@selector</font> <font color="#002200">(</font> onMenuBrowser <font color="#002200">:)</font> </li><li>  keyEquivalent <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">""</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> mi setTarget <font color="#002200">:</font> self <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> m addItem <font color="#002200">:</font> mi <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> mi release <font color="#002200">]</font> ; </li><li></li><li>  _myMenuItem <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> <font color="#400080">NSMenuItem</font> alloc <font color="#002200">]</font> </li><li>  initWithTitle <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"XPath"</font> </li><li>  action <font color="#002200">:</font> <font color="#a61390">nil</font> </li><li>  keyEquivalent <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">""</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> _myMenuItem setSubmenu <font color="#002200">:</font> m <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> m release <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> _myMenuItem setEnabled <font color="#002200">:</font> <font color="#a61390">YES</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li><li>  <font color="#a61390">return</font> self; </li><li>  <font color="#002200">}</font> </li></ol></blockquote><br>  In the constructor, we create the ‚ÄúXPath‚Äù menu item, which has a submenu with the ‚ÄúXPath for node‚Äù and ‚ÄúShow browser‚Äù elements (both elements are linked to actions on the main class). <br><br>  Add a menu to the class description: <code>NSMenuItem *_myMenuItem;</code>  and make it available via the property: <code>@property (readonly) NSMenuItem *myMenuItem;</code>  .  Now we can get to this menu from our function (which is executed in the context of BrowserWebView): <br><blockquote><ol><li>  <font color="#a61390">static</font> <font color="#400080">NSArray</font> <font color="#002200">*</font> webView_contextMenuItemsForElement_defaultMenuItems_ <font color="#002200">(</font> <font color="#a61390">id</font> self, <font color="#a61390">SEL</font> _cmd, </li><li>  <font color="#a61390">id</font> <font color="#002200">*</font> sender, <font color="#400080">NSDictionary</font> <font color="#002200">*</font> element, <font color="#400080">NSArray</font> <font color="#002200">*</font> defaultMenuItems <font color="#002200">)</font> </li><li>  <font color="#002200">{</font> </li><li>  <font color="#002200">[</font> SXPPlugin sharedInstance <font color="#002200">]</font> .ctx <font color="#002200">=</font> element; </li><li>  <font color="#400080">NSArray</font> <font color="#002200">*</font> itms <font color="#002200">=</font> <font color="#002200">[</font> self </li><li>  _sxp_orig_webView <font color="#002200">:</font> sender </li><li>  contextMenuItemsForElement <font color="#002200">:</font> element </li><li>  defaultMenuItems <font color="#002200">:</font> defaultMenuItems <font color="#002200">]</font> ; </li><li>  <font color="#400080">NSMutableArray</font> <font color="#002200">*</font> itms2 <font color="#002200">=</font> <font color="#002200">[</font> <font color="#400080">NSMutableArray</font> arrayWithArray <font color="#002200">:</font> itms <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> itms2 addObject <font color="#002200">:</font> <font color="#002200">[</font> <font color="#400080">NSMenuItem</font> separatorItem <font color="#002200">]</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> itms2 addObject <font color="#002200">:</font> <font color="#002200">[</font> <font color="#002200">[</font> SXPPlugin sharedInstance <font color="#002200">]</font> myMenuItem <font color="#002200">]</font> <font color="#002200">]</font> ; </li><li>  <font color="#a61390">return</font> itms2; </li><li>  <font color="#002200">}</font> </li></ol></blockquote><br>  Do not pay attention to the fourth line, it will be further.  And everything else is obvious - we get a list of the current menu items, add a separator and our menu there, return above. <br><img src="http://l0st.ws/f/fd1/menu.png" alt="Menu"><br><br>  Now we start to do more interesting things.  To begin with, a break in programming and a few minutes at Interface Builder, in which the main interface will be created: <br><img src="http://l0st.ws/f/f6/main.png" alt="Main UI"><br>  The XPath will be displayed in the top line, and the result of the selection will be displayed in the bottom list  <code>[NSBundle loadNibNamed:@"XPathBrowser" owner:self];</code> everything we need on the main class, and in init we add the xib load: <code>[NSBundle loadNibNamed:@"XPathBrowser" owner:self];</code>  . <br><br>  Now, actually, we unleash XPath.  To know where to spin it in the interceptor, we save the dictionary "element", it is in it all the information we need. <br><blockquote><ol><li>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#a61390">void</font> <font color="#002200">)</font> onMenu <font color="#002200">:</font> <font color="#002200">(</font> <font color="#a61390">id</font> <font color="#002200">)</font> sender </li><li>  <font color="#002200">{</font> </li><li>  <font color="#002200">[</font> window makeKeyAndOrderFront <font color="#002200">:</font> self <font color="#002200">]</font> ; </li><li>  <font color="#400080">NSString</font> <font color="#002200">*</font> xp <font color="#002200">=</font> <font color="#002200">[</font> self xpathForNode <font color="#002200">:</font> <font color="#002200">[</font> _ctx objectForKey <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"WebElementDOMNode"</font> <font color="#002200">]</font> <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> xpathField setStringValue <font color="#002200">:</font> xp <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> self onEvaluate <font color="#002200">:</font> self <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li><li></li><li>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#a61390">void</font> <font color="#002200">)</font> onMenuBrowser <font color="#002200">:</font> <font color="#002200">(</font> <font color="#a61390">id</font> <font color="#002200">)</font> sender </li><li>  <font color="#002200">{</font> </li><li>  <font color="#002200">[</font> window makeKeyAndOrderFront <font color="#002200">:</font> self <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li></ol></blockquote><br>  An instance of the DOMNode class, which was clicked, is associated with the WebElementDOMNode key.  The xpathForNode code: I will not give you here, it is quite cumbersome (those who wish can see it in <a href="http://git.hackndev.com/%3Fp%3Dfarcaller/safarixpath.git%3Ba%3Dblob%3Bf%3DClasses/SXPPlugin.m%3Bh%3D437a8abc13fc4bb27fc66210654fb55b49ac3fe7%3Bhb%3DHEAD">git</a> ), the principle of operation is the following: unwind the parent node to the very top.  If a node has an id attribute, then it is added to the XPath, if the parent node has several nodes of the same type (and they do not have an id), then the node index is used. <br><br>  But there is not enough XPath to count, it is necessary to execute it and get a result.  To do this, you could use an NSXMLDocument and feed it data from the current frame, but this is not as interesting as the opportunity to get nodes from JavaScript: <br><blockquote><ol><li>  <font color="#002200">-</font> <font color="#002200">(</font> <font color="#a61390">void</font> <font color="#002200">)</font> onEvaluate <font color="#002200">:</font> <font color="#002200">(</font> <font color="#a61390">id</font> <font color="#002200">)</font> sender </li><li>  <font color="#002200">{</font> </li><li>  <font color="#400080">NSString</font> <font color="#002200">*</font> xp <font color="#002200">=</font> <font color="#002200">[</font> xpathField stringValue <font color="#002200">]</font> ; </li><li>  WebFrame <font color="#002200">*</font> frame <font color="#002200">=</font> <font color="#002200">[</font> _ctx objectForKey <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"WebElementFrame"</font> <font color="#002200">]</font> ; </li><li>  WebView <font color="#002200">*</font> view <font color="#002200">=</font> <font color="#002200">[</font> frame webView <font color="#002200">]</font> ; </li><li>  <font color="#400080">NSString</font> <font color="#002200">*</font> js <font color="#002200">=</font> <font color="#002200">[</font> <font color="#400080">NSString</font> </li><li>  stringWithFormat <font color="#002200">:</font> <font color="#bf1d1a">@</font> <font color="#bf1d1a">"document.evaluate ( <font color="#2400d9">\"</font> % @ <font color="#2400d9">\ "</font> , document, null, XPathResult.ANY_TYPE, null)"</font> , xp <font color="#002200">]</font> ; </li><li></li><li>  <font color="#a61390">id</font> o <font color="#002200">=</font> <font color="#002200">[</font> <font color="#002200">[</font> view windowScriptObject <font color="#002200">]</font> evaluateWebScript <font color="#002200">:</font> js <font color="#002200">]</font> ; </li><li>  <font color="#002200">[</font> _nodes release <font color="#002200">]</font> ; </li><li>  _nodes <font color="#002200">=</font> <font color="#a61390">nil</font> ; </li><li>  <font color="#a61390">if</font> <font color="#002200">(</font> <font color="#002200">!</font> <font color="#002200">[</font> <font color="#002200">[</font> o class <font color="#002200">]</font> isEqual <font color="#002200">:</font> <font color="#002200">[</font> WebUndefined class <font color="#002200">]</font> <font color="#002200">]</font> <font color="#002200">)</font> <font color="#002200">{</font> </li><li>  <font color="#400080">NSMutableArray</font> <font color="#002200">*</font> nodes <font color="#002200">=</font> <font color="#002200">[</font> <font color="#400080">NSMutableArray</font> array <font color="#002200">]</font> ; </li><li>  <font color="#a61390">id</font> n <font color="#002200">=</font> <font color="#002200">[</font> o iterateNext <font color="#002200">]</font> ; </li><li>  <font color="#a61390">while</font> <font color="#002200">(</font> n <font color="#002200">)</font> <font color="#002200">{</font> </li><li>  <font color="#002200">[</font> nodes addObject <font color="#002200">:</font> <font color="#002200">[</font> self dictForNode <font color="#002200">:</font> n <font color="#002200">]</font> <font color="#002200">]</font> ; </li><li>  n <font color="#002200">=</font> <font color="#002200">[</font> o iterateNext <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li><li>  _nodes <font color="#002200">=</font> <font color="#002200">[</font> nodes retain <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> ; </li><li>  <font color="#002200">[</font> outlineView reloadData <font color="#002200">]</font> ; </li><li>  <font color="#002200">}</font> </li></ol></blockquote><br>  Initially, NSOutlineView received DOM * objects directly, but due to the intricacies of the self-leaving nodes (do you have to explicitly retain them?), I rebuild the tree in the nodes array. <br><br>  I ignore the potential injection of JS, if you have access to a browser, then performing JS on the frame can be much simpler.  And the quotation mark seems to be not valid in XPath at all. <br><br>  On the method -dictForNode: you can also look at git.  Its task is to expand the DOM tree into a set of NSDictionary / NSArray structures, from which the outline view will build the list. <br><br>  Final result: <br><img src="http://l0st.ws/f/b/main2.png"><br><br>  I also have an alternative project, where I tried to write the same thing on python (although XPath did a wonderful binding to libxml / libxslt - lxml there).  But it turned out that the lack of a full-featured browser is still inconvenient. <br><br>  Source Code (MIT): <a href="http://git.hackndev.com/%3Fp%3Dfarcaller/safarixpath.git%3Ba%3Dsummary">http://git.hackndev.com/?p=farcaller/safarixpath.git;a=summary</a> <br><br>  Patches, bug fixes, ideas are welcome. <br><br>  <b>Update</b> : thanks for the tip, moved to Mac OS X and iPhone Development <br><br>  <b>Update</b> : at the request of workers, added support for XPath sampling of both the DOM tree and the source HTML document.  It can mess up with encodings, there is an unobvious transformation, if it falls in HTML mode - I really ask for the original file for preparation (with utf8 and cp1251 it seems to work).  In addition, the NSXMLDocument breaks something on some pages altogether, the problem is being investigated. <br><br>  At the same time prefix DOM-parser, it now supports functions (count, name, etc.).  NSXMLDocument does not know how. <br><br>  SIMBL-bundle for the latest Safari: <a href="">http://farcaller.net/stuff/SafariXPath.bundle-1.1.zip</a> </div><p>Source: <a href="https://habr.com/ru/post/65368/">https://habr.com/ru/post/65368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../65359/index.html">Video review of the game "Call of Juarez: Ties of Blood"</a></li>
<li><a href="../65362/index.html">Young nerd: The inner life of the cell</a></li>
<li><a href="../65363/index.html">Using the accelerometer in the iPhone simulator</a></li>
<li><a href="../65366/index.html">Clicking too fast?</a></li>
<li><a href="../65367/index.html">Algorithms on Graphs - Part 0: Basic Concepts</a></li>
<li><a href="../65370/index.html">Question: What is wrong in Oper'e?</a></li>
<li><a href="../65373/index.html">Invites on Enetri.com</a></li>
<li><a href="../65376/index.html">Tips & Tricks: Change User Agent on iPhone</a></li>
<li><a href="../65377/index.html">Microsoft Tag Team Announces API</a></li>
<li><a href="../65378/index.html">Downloading and caching images in Firefox, as well as in Opera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>