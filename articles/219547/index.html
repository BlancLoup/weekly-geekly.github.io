<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Boring article about checking OpenSSL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, a vulnerability was discovered in OpenSSL, which only a lazy one does not speak about. I know that PVS-Studio is not able to find an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Boring article about checking OpenSSL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/ae1/60e/045/ae160e045cacbe1490464b4d23438b2b.png" alt="PVS-Studio and OpenSSL" align="left"><br>  Not so long ago, a vulnerability was discovered in OpenSSL, which only a lazy one does not speak about.  I know that PVS-Studio is not able to find an error that leads to this vulnerability.  So I decided that there is no reason to write any article about OpenSSL.  In recent days, and so has become too many articles on this topic.  However, I received a flurry of letters asking me to tell if PVS-Studio can find this error.  I gave up and wrote this article. <br><br><a name="habracut"></a><br><br><h2>  OpenSSL Verification </h2><br>  I think everyone already knows that a serious vulnerability has been discovered in <a href="http://www.viva64.com/go.php%3Furl%3D1034">OpenSSL</a> .  If, after all, someone missed it or wants to know more details, I suggest to get acquainted with several articles on this topic: <ul><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1383">The Heartbleed Bug</a> . </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1384">Existential type crisis: Diagnosis of the OpenSSL Heartbleed Bug</a> . </li><li>  Wikipedia.  <a href="http://www.viva64.com/go.php%3Furl%3D1385">Heartbleed</a> </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1389">Heartbleed</a> </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1391">Answers the Critical Question of Keys Using Heartbleed?</a> </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1388">NSA Said to Exploit Heartbleed Bug for Intelligence for Years</a> . </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1390">Man who introduced serious 'Heartbleed' security flaw denies he inserted it deliberately</a> . </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1387">The Heartbleed Hit List</a> . </li><li>  <a href="http://www.viva64.com/go.php%3Furl%3D1392">Open Source software is for all of the others</a> . </li></ul>  To be brief, the vulnerability allowing access to other people's data existed in the code for about 2 years.  During this time, no code analyzer found it, although this library was not tested only by the lazy one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We tested OpenSSL too.  Here is a note on this topic: " <a href="http://www.viva64.com/ru/b/0183/">A little about OpenSSL</a> ".  Something we found, but it seems nothing serious.  Now these errors are fixed.  So no wonder checked. <br><br>  I did not specify if we checked OpenSSL when the Heartbleed bug was already there or not.  In any case, I know that PVS-Studio cannot detect such a bug.  It is generally difficult to detect.  The OpenSSL project was tested and verified by various tools, and none of them found this error.  For example, I did not find an error, the leader among the analyzers of the Coverity Scan code.  Notes about this: " <a href="http://www.viva64.com/go.php%3Furl%3D1393">Heartbleed and Static Analysis</a> ", " <a href="http://www.viva64.com/go.php%3Furl%3D1394">Heartbleed and static analysis (2)</a> ". <br><br>  The fact is that such an error is very difficult to find using static analysis.  The code is too confusing.  It is necessary to take into account the values ‚Äã‚Äãstored in memory, you need to understand what lies behind the obvious type conversions and so on.  Even a person is hard to understand what the problem is.  Static analyzers here pass.  This is not a flaw in the static analysis methodology.  It's just that the mistake is really complicated.  Probably, there is no tool that can find such a defect, if it is not previously trained to search for such structures. <br><br>  It should be noted that there are still known and unknown static analysis tools designed to search for software bookmarks.  Probably, similar tools could find vulnerability, but I strongly doubt.  If found, they would use it as an advertisement for their analyzer.  There is, of course, the option that some tool developed within the special services finds this vulnerability, but they do not specifically talk about it.  However, conspirology begins here, so let's not talk about it. <br><br>  My personal opinion.  This is just a mistake, but not a bookmark.  Static analysis tools do not know how to detect it, since it is complex.  That's all. <br><br>  At this point it was possible to finish the article, but it was not at all interesting.  Therefore, I once again checked OpenSSL with <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> .  I didn‚Äôt find anything special, but still let's look at some parts of the code. <br><br>  Why is there so little?  Yes, because OpenSSL is a quality project.  The fact that a serious vulnerability was found in it does not mean at all that the code is terrible.  I think that in many applications there are many big holes, they just are not needed by anyone.  Plus, the OpenSSL project is being tested with many tools. <br><br><h2>  Analysis results </h2><br>  Once again I want to repeat that I did not find any special errors.  It would be better if we consider the text below not as a description of errors, but as comments on the code, which seemed to me to be inaccurate.  I do not want to see comments later that I am inflating an elephant from a fly. <br><br><h3>  Suspicious comparison </h3><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ok_struct</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> buf_len_save; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> buf_off_save; .... } BIO_OK_CTX; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ok_read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BIO *b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> outl)</span></span></span><span class="hljs-function"> </span></span>{ .... BIO_OK_CTX *ctx; .... <span class="hljs-comment"><span class="hljs-comment">/* copy start of the next block into proper place */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ctx-&gt;buf_len_save - ctx-&gt;buf_off_save &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .... }</code> </pre> <br>  PVS-Studio warning: V555 The expression of the 'A - B&gt; 0' kind will work as 'A! = B'.  bio_ok.c 243 <br><br>  The expression (ctx-&gt; buf_len_save - ctx-&gt; buf_off_save&gt; 0) does not work as it might seem at first glance. <br><br>  It seems that here they want to check the condition (ctx-&gt; buf_len_save&gt; ctx-&gt; buf_off_save).  This is not true.  The point is that the compared variables are of unsigned type.  Subtracting one unsigned variable from another unsigned variable gives the result of an unsigned type. <br><br>  The condition (ctx-&gt; buf_len_save - ctx-&gt; buf_off_save&gt; 0) is always met if the variables do not match.  In other words, the following two expressions are equivalent: <ul><li>  (ctx-&gt; buf_len_save - ctx-&gt; buf_off_save&gt; 0) </li><li>  (ctx-&gt; buf_len_save! = ctx-&gt; buf_off_save) </li></ul><br>  <b>Explanation for those who are not very familiar with the C language.</b>  Skilled developers can not read. <br><br>  Suppose we have two 32-bit variables of unsigned type: <br><br>  unsigned A = 10; <br><br>  unsigned B = 20; <br><br>  Check whether the condition (A - B&gt; 0) is fulfilled. <br><br>  The result of the subtraction (A - B) is 10u - 20u = 0xFFFFFFF6u = 4294967286u. <br><br>  Then we compare the unsigned number 4294967286u with zero.  Zero also leads to unsigned type, but it does not matter. <br><br>  The expression (4294967286u&gt; 0u) is true. <br><br>  The expression (A - B&gt; 0) will be false only in one case, when A == B. <br><br>  <b>Is this comparison a mistake?</b>  I do not know, because I am not familiar with the project device.  I think that there is no error. <br><br>  Most likely, this is the case.  The variable 'buf_len_save' is usually larger than the variable '' buf_off_save '.  Only sometimes the value of the variable 'buf_off_save' reaches the value stored in 'buf_len_save'.  In this case, when the variables match and this check is needed.  The case when (buf_len_save &lt;buf_off_save) is probably impossible. <br><br><h3>  Uninitialized variable that does not cause trouble </h3><br>  There is a place where an uninitialized variable can be used.  But it will not lead to any bad consequences.  Here is the code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PEM_do_header</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i,j,o,klen; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o) o = EVP_DecryptUpdate(&amp;ctx,data,&amp;i,data,j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o) o = EVP_DecryptFinal_ex(&amp;ctx,&amp;(data[i]),&amp;j); .... j+=i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!o) { PEMerr(PEM_F_PEM_DO_HEADER,PEM_R_BAD_DECRYPT); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } .... }</code> </pre> <br>  PVS-Studio Warning: V614 Potentially uninitialized variable 'i' used.  pem_lib.c 480 <br><br>  The variable 'i' may be uninitialized if (o == false).  As a result, it is not clear what will be added to 'j'.  This is not a problem, since if (o == false), the error handler is triggered, and the function stops its work. <br><br>  The code is correct, but not accurate.  It is better to first check the variable 'o', and only then use the 'i': <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!o) { PEMerr(PEM_F_PEM_DO_HEADER,PEM_R_BAD_DECRYPT); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } j+=i;</code> </pre> <br><h3>  Strange assignments </h3><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SSL_TLSEXT_ERR_ALERT_FATAL 2 int ssl3_accept(SSL *s) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret != SSL_ERROR_NONE) { ssl3_send_alert(s,SSL3_AL_FATAL,al); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (al != TLS1_AD_UNKNOWN_PSK_IDENTITY) SSLerr(SSL_F_SSL3_ACCEPT,SSL_R_CLIENTHELLO_TLSEXT); ret = SSL_TLSEXT_ERR_ALERT_FATAL; ret= -1; goto end; } .... }</span></span></code> </pre> <br>  PVS-Studio warning: V519 The 'ret' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 376, 377. s3_srvr.c 377 <br><br>  At the beginning of the variable 'ret' is assigned the value 2, and then -1.  Probably the first assignment is superfluous and remained in the code by accident. <br><br>  Another case: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dtls1_retransmit_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">/* save current state */</span></span> saved_state.enc_write_ctx = s-&gt;enc_write_ctx; saved_state.write_hash = s-&gt;write_hash; saved_state.compress = s-&gt;compress; saved_state.session = s-&gt;session; saved_state.epoch = s-&gt;d1-&gt;w_epoch; saved_state.epoch = s-&gt;d1-&gt;w_epoch; .... }</code> </pre> <br>  PVS-Studio warning: V519 The 'saved_state.epoch' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 1277, 1278. d1_both.c 1278 <br><br><h3>  Potential null pointer dereference </h3><br>  The most common bloop in programs ( <a href="http://www.viva64.com/ru/examples/V595/">in my experience</a> ) is dereferencing a pointer before it is checked.  It is not always a mistake.  Often the pointer will never be null.  However, this is a potentially dangerous code.  especially when the project is changing rapidly. <br><br>  There are some bloopers in OpenSSL: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SSL_shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SSL *s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s-&gt;handshake_func == <span class="hljs-number"><span class="hljs-number">0</span></span>) { SSLerr(SSL_F_SSL_SHUTDOWN, SSL_R_UNINITIALIZED); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((s != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) &amp;&amp; !SSL_in_init(s)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(s-&gt;method-&gt;ssl_shutdown(s)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } .... }</code> </pre> <br>  PVS-Studio warning: V595 The pointer 's pointer was used before it was verified against nullptr.  Check lines: 1013, 1019. ssl_lib.c 1013 <br><br>  At the beginning, the 's' pointer is used: (s-&gt; handshake_func == 0). <br><br>  And only then it is checked: (s! = NULL). <br><br>  Another more difficult case: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> bn_wexpand(a,words) \ (((words) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;= (a)-&gt;dmax)?(a):bn_expand2((a),(words))) static int ubsec_dh_generate_key(DH *dh) { .... if(bn_wexpand(pub_key, dh-&gt;p-&gt;top) == NULL) goto err; if(pub_key == NULL) goto err; .... }</span></span></span></span></code> </pre> <br>  PVS-Studio warning: V595 The 'pub_key' pointer was used before it was verified against nullptr.  Check lines: 951, 952. e_ubsec.c 951 <br><br>  To understand where the error is, you need to open the macros.  Then we get this code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((((dh-&gt;p-&gt;top) &lt;= (pub_key)-&gt;dmax)? (pub_key):bn_expand2((pub_key), (dh-&gt;p-&gt;top))) == ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> err; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pub_key == ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> err;</code> </pre> <br>  Note the pointer 'pub_key'. <br><br>  Initially, it is dereferenced: (pub_key) -&gt; dmax. <br><br>  Below it is checked for equality to zero: (pub_key == ((void *) 0)). <br><br><h3>  Extra checks </h3><br>  There are several code snippets where a variable is compared twice with the same value.  I think this is not a mistake.  It seems that just the second check was written randomly and simply superfluous.  It can be removed. <br><br>  <b>Excess check N1</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ASN1_PRINTABLE_type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!( ((c &gt;= <span class="hljs-string"><span class="hljs-string">'a'</span></span>) &amp;&amp; (c &lt;= <span class="hljs-string"><span class="hljs-string">'z'</span></span>)) || ((c &gt;= <span class="hljs-string"><span class="hljs-string">'A'</span></span>) &amp;&amp; (c &lt;= <span class="hljs-string"><span class="hljs-string">'Z'</span></span>)) || (c == <span class="hljs-string"><span class="hljs-string">' '</span></span>) || &lt;&lt;&lt;&lt;==== ((c &gt;= <span class="hljs-string"><span class="hljs-string">'0'</span></span>) &amp;&amp; (c &lt;= <span class="hljs-string"><span class="hljs-string">'9'</span></span>)) || (c == <span class="hljs-string"><span class="hljs-string">' '</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'\''</span></span>) || &lt;&lt;&lt;&lt;==== (c == <span class="hljs-string"><span class="hljs-string">'('</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">')'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'+'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">','</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'-'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'.'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'/'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">':'</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'='</span></span>) || (c == <span class="hljs-string"><span class="hljs-string">'?'</span></span>))) ia5=<span class="hljs-number"><span class="hljs-number">1</span></span>; .... }</code> </pre> <br>  PVS-Studio warning: V501 There are identical sub-expressions '(c ==' ')'  operator.  a_print.c 76 <br><br>  I selected identical checks using "&lt;&lt;&lt;&lt; ====".  I <a href="http://www.viva64.com/ru/b/0183/">wrote</a> about this duplicate check in the previous article, but it is not fixed.  So this is definitely not a problem. <br><br>  <b>Excess check N2, N3</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ssl3_read_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SSL *s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> peek)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((type &amp;&amp; (type != SSL3_RT_APPLICATION_DATA) &amp;&amp; (type != SSL3_RT_HANDSHAKE) &amp;&amp; type) || (peek &amp;&amp; (type != SSL3_RT_APPLICATION_DATA))) .... }</code> </pre> <br>  PVS-Studio warning: V501 operator.  s3_pkt.c 952 <br><br>  It is checked twice that the 'type' variable has a nonzero value. <br><br>  The above code snippet was copied to another file, so there is also a superfluous comparison: d1_pkt.c 760. <br><br><h3>  Incorrect row length </h3><br>  It is not good to set the length of lines using magic constants.  It is very easy to make a mistake.  In OpenSSL, the PVS-Studio analyzer noticed three such places. <br><br>  <b>The first failed magic number</b> <br><br>  To demonstrate that this is a mistake, let's look at a few examples of calling the BIO_write function: <ul><li>  BIO_write (bp, ‚ÄúError in encoding \ n‚Äù, 18) </li><li>  BIO_write (bp, "\ n", 1) </li><li>  BIO_write (bp, ":", 1) </li><li>  BIO_write (bp, ": BAD OBJECT", 11) </li><li>  BIO_write (bp, ‚ÄúBad boolean \ n‚Äù, 12) </li></ul>  As you can see from these examples, the last number specifies the length of the string. <br><br>  And now, the incorrect code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asn1_parse2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (BIO_write(bp,<span class="hljs-string"><span class="hljs-string">"BAD ENUMERATED"</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> end; .... }</code> </pre> <br>  PVS-Studio warning: V666 Consider the third argument of the function 'BIO_write'.  This is not the case.  asn1_par.c 378 <br><br>  The length of the string ‚ÄúBAD ENUMERATED‚Äù is not 11, but 14 characters. <br><br>  <b>The second failed magic number</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">www_body</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *hostname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *context)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ((www == <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp;&amp; (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"GET "</span></span>,buf,<span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>)) || ((www == <span class="hljs-number"><span class="hljs-number">2</span></span>) &amp;&amp; (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-string"><span class="hljs-string">"GET /stats "</span></span>,buf,<span class="hljs-number"><span class="hljs-number">10</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>))) .... }</code> </pre> <br>  PVS-Studio warning: V666 Consider the third argument of the function 'strncmp'.  It is possible that it‚Äôs not passed on.  s_server.c 2703 <br><br>  The length of the string ‚ÄúGET / stats‚Äù is not 10, but 11 characters.  The last space is not taken into account.  Minor bug, but still a bug. <br><br>  <b>The third failed magic number</b> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asn1_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *elem, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bitstr)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(vstart, <span class="hljs-string"><span class="hljs-string">"ASCII"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)) arg-&gt;format = ASN1_GEN_FORMAT_ASCII; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(vstart, <span class="hljs-string"><span class="hljs-string">"UTF8"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)) arg-&gt;format = ASN1_GEN_FORMAT_UTF8; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(vstart, <span class="hljs-string"><span class="hljs-string">"HEX"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)) arg-&gt;format = ASN1_GEN_FORMAT_HEX; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(vstart, <span class="hljs-string"><span class="hljs-string">"BITLIST"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)) arg-&gt;format = ASN1_GEN_FORMAT_BITLIST; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> .... }</code> </pre> <br>  PVS-Studio warning: V666 Consider the third argument of the function 'strncmp'.  This is not the case.  asn1_gen.c 371 <br><br>  The trouble is here: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(vstart, <span class="hljs-string"><span class="hljs-string">"BITLIST"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>))</code> </pre> <br>  The length of the string "BITLIST" is 7 characters. <br><br>  I digress a little.  The reader may have a question about how PVS-Studio finds such errors.  I will explain.  It collects information about function calls, in this case about strncmp (), and builds a data matrix: <ul><li>  vstart, "ASCII", 5 </li><li>  vstart, "UTF8", 4 </li><li>  vstart, "HEX", 3 </li><li>  vstart, "BITLIST", 3 </li></ul>  The function has a string argument and a numeric one.  Basically the length of the string is the same as the number.  So this argument is the length of the string.  In one place this is not the case and it means that a warning <a href="http://www.viva64.com/ru/d/0291/">V666</a> should be issued. <br><br><h3>  Not very good </h3><br>  It is not very good to print out the pointer value using "% 08lX".  For this, there is a "% p". <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mem_st</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *addr; .... } MEM; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_leak_doall_arg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MEM *m, MEM_LEAK *l)</span></span></span><span class="hljs-function"> </span></span>{ .... BIO_snprintf(bufp, BUF_REMAIN, <span class="hljs-string"><span class="hljs-string">"number=%d, address=%08lX\n"</span></span>, m-&gt;num,(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m-&gt;addr); .... }</code> </pre> <br>  It is not a pointer that is passed to the function, but a value of type (unsigned long).  Therefore, the compiler and some analyzers will keep silent. <br><br>  PVS-Studio noticed this flaw indirectly.  He does not like that the pointer explicitly lead to type (unsigned long).  It is not right.  No one guaranteed that the pointer would fit in the 'long' type.  For example, this can not be done in Win64. <br><br>  Correct and shorter code: <br><pre> <code class="cpp hljs">BIO_snprintf(bufp, BUF_REMAIN, <span class="hljs-string"><span class="hljs-string">"number=%d, address=%p\n"</span></span>, m-&gt;num, m-&gt;addr);</code> </pre> <br>  There are three places where the pointer value is incorrectly printed: <ul><li>  mem_dbg.c 699 </li><li>  bio_cb.c 78 </li><li>  asn1_lib.c 467 </li></ul><br><h2>  Conclusion </h2><br>  Although <a href="http://www.viva64.com/ru/t/0074/">static analyzers</a> did not find this error, and it existed for a very long time, I still urge everyone to use static analysis in their daily work.  Just do not look for a silver bullet that will solve all the problems and completely relieve the program code from errors.  The best result is achieved in an integrated approach: unit tests, <a href="http://www.viva64.com/ru/b/0248/">static and dynamic analysis</a> , regression tests, and so on.  Static analysis will eliminate a lot of typos and stupid errors at the coding stage and this will save time on other useful things, such as new functionality or writing more thorough tests. <br><br>  Try our code analyzer <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> . <br><br><h2>  This article is in English. </h2><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="http://www.viva64.com/en/b/0250/">A Boring Article About the OpenSSL Project</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio and CppCat, version 2014</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/219547/">https://habr.com/ru/post/219547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219537/index.html">What we should fix a bug, which is "no"</a></li>
<li><a href="../219539/index.html">CTOcast # 1: Kirill Safonov (RuTarget)</a></li>
<li><a href="../219541/index.html">Servers for STSS Flagman video surveillance</a></li>
<li><a href="../219543/index.html">Gramafon: a wifi router and music player in one</a></li>
<li><a href="../219545/index.html">7 tips to promote applications for Windows Store</a></li>
<li><a href="../219549/index.html">Getting ready for Google I / O 2014</a></li>
<li><a href="../219559/index.html">SmetaCloud - estimating online. Display and print large tables in the browser</a></li>
<li><a href="../219563/index.html">Converse first-hand: 14 questions to developers</a></li>
<li><a href="../219565/index.html">Dart: the smallest laptop adapter</a></li>
<li><a href="../219567/index.html">Seven of the most interesting tasks of the RCC for all the years according to Andrei Stankevich</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>