<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenSSL, ssl_ciphers and nginx: we pump 100%</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A lot of where it is written about how to get 100% and A + on the test from Qualys . At the same time, almost everywhere the directives ssl_ciphers an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenSSL, ssl_ciphers and nginx: we pump 100%</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/143/4ed/28c/1434ed28c9124f71b7f1153f1dc01d88.png"></p><br><p> A lot of where it is written about how to get 100% and A + on the <a href="https://www.ssllabs.com/ssltest/index.html">test from Qualys</a> .  At the same time, almost everywhere the directives <code>ssl_ciphers</code> and the like are given as such magic lines that you just need to insert, and hope that the author does not let you under the monastery.  This article is intended to correct this misunderstanding.  After reading this article, the <code>ssl_ciphers</code> directive will lose all magic for you, and <em>ECDHE</em> and <em>AES</em> will be like friends and brothers. </p><br><a name="habracut"></a><br><h1 id="podgotovka">  Training </h1><br><p>  We will work with Debian 8.7.  If you have a different distribution, the versions should be the same or newer. </p><br><pre> <code class="hljs pgsql"># lsb_release -d Description: Debian GNU/Linux <span class="hljs-number"><span class="hljs-number">8.7</span></span> (jessie) # openssl <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> OpenSSL <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>t <span class="hljs-number"><span class="hljs-number">3</span></span> May <span class="hljs-number"><span class="hljs-number">2016</span></span> # nginx -V nginx <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: nginx/<span class="hljs-number"><span class="hljs-number">1.6</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br><p>  <a href="https://habrahabr.ru/post/318952/">We will configure nginx to receive certificates from Let's Encrypt according to the instructions</a> , but only before obtaining a certificate for our domain. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">certbot</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certonly</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre> <br><p>  Config use the minimum.  Nothing extra.  Everything is by default. </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.example.com example.com; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl default_server; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/example.com/fullchain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/letsencrypt/live/example.com/privkey.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_trusted_certificate</span></span> /etc/letsencrypt/live/example.com/chain.pem; }</code> </pre> <br><p>  Now let's <a href="https://www.ssllabs.com/ssltest/">run a test for this server</a> . </p><br><p><img src="https://habrastorage.org/files/6a2/5cf/6e1/6a25cf6e18bc4b75bd4af6763516d05e.png"></p><br><p>  With the default settings, the result is so-so.  On the four, if in our opinion.  They swear at <a href="https://dxdt.ru/2015/06/02/7479/">weak parameters for key exchange</a> using the Diffie ‚Äì Hellman algorithm (hereinafter referred to as DH). </p><br><p>  It would be possible to make <a href="https://habrahabr.ru/post/318952/">enhanced parameters</a> , but such parameters and speeds are not added, and are supported by some old clients.  The same old clients support the DH protocol on elliptic curves (ECDHE), which means we do not lose anything and <a href="https://securitypitfalls.wordpress.com/2014/10/06/rsa-and-ecdsa-performance/">even gain speed</a> if, following <a href="https://www.ssllabs.com/ssltest/analyze.html%3Fd%3Dgoogle.com">Google</a> , <a href="https://www.ssllabs.com/ssltest/analyze.html%3Fd%3Dfacebook.com">Facebook</a> , <a href="https://wiki.mozilla.org/Security/Server_Side_TLS">Mozilla</a> and <a href="https://github.com/cloudflare/sslconfig/blob/master/conf">CloudFlare, we</a> completely abandon the slow EDH ciphers in favor of ECDHE. </p><br><p>  Easy further.  Need a <a href="https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices">list of recommended ciphers</a> . </p><br><p>  For a certificate with an RSA key from that list, only authenticated RSA ciphers are needed. </p><br><pre> <code class="hljs">ECDHE-RSA-AES128-GCM-SHA256 ECDHE-RSA-AES256-GCM-SHA384 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES256-SHA384 DHE-RSA-AES128-GCM-SHA256 DHE-RSA-AES256-GCM-SHA384 DHE-RSA-AES128-SHA DHE-RSA-AES256-SHA DHE-RSA-AES128-SHA256 DHE-RSA-AES256-SHA256</code> </pre> <br><p>  From them we exclude ciphers weaker than 256 bits, and ciphers DHE.  We list the remaining in the configuration directive. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ssl_ciphers</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ECDHE-RSA-AES256-GCM-SHA384</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ECDHE-RSA-AES256-SHA</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ECDHE-RSA-AES256-SHA384</span></span>;</code> </pre> <br><p>  But this alone <a href="https://github.com/ssllabs/research/wiki/SSL-Server-Rating-Guide">will not be enough</a> .  Need a key of at least 4096 bits. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">certbot</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">certonly</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--renew-by-default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--rsa-key-size</span></span> 4096 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre> <br><p>  And another curve.  In the version of OpenSSL <a href="http_ssl_module.html">you</a> are using, <a href="http_ssl_module.html">you can only select one</a> .  Choose the most reliable of the popular. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_ecdh_curve</span></span> secp384r1;</code> </pre> <br><p>  For evaluation with a plus, add HSTS. </p><br><pre> <code class="hljs pgsql">add_header <span class="hljs-keyword"><span class="hljs-keyword">Strict</span></span>-Transport-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span> "max-age=31536000";</code> </pre> <br><p>  Finally, disable the old protocols for a 100% score <a href="https://github.com/ssllabs/research/wiki/SSL-Server-Rating-Guide">on the Protocol Support column</a> . </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_protocols</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br><p>  The complete config is obtained as follows. </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.example.com example.com; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl default_server; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/example.com/fullchain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/letsencrypt/live/example.com/privkey.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_trusted_certificate</span></span> /etc/letsencrypt/live/example.com/chain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES256-SHA384; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ecdh_curve</span></span> secp384r1; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_protocols</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p>  We will verify that there is no error in the configuration of ciphers and protocols. </p><br><pre> <code class="hljs ruby">$ nmap --script ssl-enum-ciphers -p <span class="hljs-number"><span class="hljs-number">443</span></span> example.com Starting Nmap <span class="hljs-number"><span class="hljs-number">7.40</span></span> ( <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/nmap.org ) at 2017-03-01 00:00 UTC Nmap scan report for example.com (1.2.3.5) Host is up (0.030s latency). PORT STATE SERVICE 443/tcp</span></span> open https <span class="hljs-params"><span class="hljs-params">| ssl-enum-ciphers: |</span></span> TLSv1.<span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-params"><span class="hljs-params">| ciphers: |</span></span> TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (secp384r1) - A <span class="hljs-params"><span class="hljs-params">| TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (secp384r1) - A |</span></span> TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 (secp384r1) - A <span class="hljs-params"><span class="hljs-params">| compressors: |</span></span> NULL <span class="hljs-params"><span class="hljs-params">| cipher preference: server |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span> least <span class="hljs-symbol"><span class="hljs-symbol">strength:</span></span> A Nmap <span class="hljs-symbol"><span class="hljs-symbol">done:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> IP address (<span class="hljs-number"><span class="hljs-number">1</span></span> host up) scanned <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">3.22</span></span> seconds</code> </pre> <br><p>  The ciphers are in place, though not in that order.  But it is expected.  <a href="https://www.ssllabs.com/ssltest/">You can run the test.</a> </p><br><p><img src="https://habrastorage.org/files/143/4ed/28c/1434ed28c9124f71b7f1153f1dc01d88.png"></p><br><p>  Score five plus.  Happiness joy.  It would seem that. </p><br><h1 id="nedostatki">  disadvantages </h1><br><p>  But there is one problem.  If the test results are scrolled to the <em>Handshake Simulation</em> section, then we will see that IE users of any version younger than 11, Java up to SE 8, Android up to version 4.3 and even some versions of Safari will not get to our site.  I don‚Äôt even speak about software compiled with OpenSSL version less than 0.9.8. </p><br><p>  There is another problem: <a href="https://github.com/ssllabs/research/wiki/SSL-and-TLS-Deployment-Best-Practices">performance</a> .  Our key for 4096 bits directly <a href="https-performance">affects the speed of the connection</a> , while <a href="https://www.gnupg.org/faq/gnupg-faq.html">not too enhances protection</a> .  Ciphers for 256 bits also do not help speed up the connection, as for mobile devices with low-power processors and other clients without AES-NI (hardware acceleration). </p><br><p>  In the case of RSA, it is easy to verify the negative impact on speed using the built-in test in OpenSSL. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">openssl</span></span> speed rsa2048 rsa4096</code> </pre> <br><p>  On low-power <a href="http://ark.intel.com/products/72061/Intel-Celeron-Processor-1007U-2M-Cache-1_50-GHz">Celeron 1007U, the</a> difference is obvious. </p><br><pre> <code class="hljs go"> sign verify sign/s verify/s rsa <span class="hljs-number"><span class="hljs-number">2048</span></span> bits <span class="hljs-number"><span class="hljs-number">0.002381s</span></span> <span class="hljs-number"><span class="hljs-number">0.000071s</span></span> <span class="hljs-number"><span class="hljs-number">420.0</span></span> <span class="hljs-number"><span class="hljs-number">14051.0</span></span> rsa <span class="hljs-number"><span class="hljs-number">4096</span></span> bits <span class="hljs-number"><span class="hljs-number">0.016790s</span></span> <span class="hljs-number"><span class="hljs-number">0.000260s</span></span> <span class="hljs-number"><span class="hljs-number">59.6</span></span> <span class="hljs-number"><span class="hljs-number">3852.8</span></span></code> </pre> <br><p>  Signing on the server side is seven times slower.  Verification of the signature on the client is 3.6 times slower.  On the other gland, the trend remains the same.  This loss in speed is a fee <a href="https://www.yubico.com/2015/02/big-debate-2048-4096-yubicos-stand/">for strengthening the cipher strength by some 16%</a> . </p><br><h2 id="chacha20poly1305-vs-aes-128">  ChaCha20 / Poly1305 vs.  AES-128 </h2><br><p>  Similarly, let's check the speed of the recommended ciphers on OpenSSL 1.1.0e. </p><br><pre> <code class="hljs bash"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cipher <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> aes-128-gcm aes-256-gcm chacha20-poly1305 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> openssl speed -decrypt -evp <span class="hljs-variable"><span class="hljs-variable">$cipher</span></span> 2&gt;/dev/null | grep ^<span class="hljs-variable"><span class="hljs-variable">$cipher</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> | column -t</code> </pre> <br><p><img src="https://habrastorage.org/files/2ac/5d2/128/2ac5d212814145acae1975a9e104bb93.png"></p><br><p>  On the Celeron 1007U, the ChaCha20 / Poly1305 cipher is twice as fast as AES-128, and the last one-third faster than AES-256.  On the Core i7 with AES-NI, the picture is different: the ChaCha20 / Poly1305 will be a third slower than the AES-128, and the AES-256 is only slightly slower than the AES-128.  <a href="https://github.com/mdaxini/howto-openssl/wiki/OpenSSL-Cipher-Speed">When encrypting the picture is about the same.</a> </p><br><p>  Key exchange with the default <code>prime256v1</code> curve (also <code>secp256r1</code> or NIST P-256) will be <a href="http://kmackay.ca/micro-ecc/">significantly faster</a> than with the enhanced curve <code>secp384r1</code> (NIST P-384). </p><br><pre> <code class="hljs go">$ openssl speed ecdsap256 ecdsap384 ecdhp256 ecdhp384 sign verify sign/s verify/s <span class="hljs-number"><span class="hljs-number">256</span></span> bit ecdsa (nistp256) <span class="hljs-number"><span class="hljs-number">0.0001s</span></span> <span class="hljs-number"><span class="hljs-number">0.0003s</span></span> <span class="hljs-number"><span class="hljs-number">7923.8</span></span> <span class="hljs-number"><span class="hljs-number">3214.4</span></span> <span class="hljs-number"><span class="hljs-number">384</span></span> bit ecdsa (nistp384) <span class="hljs-number"><span class="hljs-number">0.0006s</span></span> <span class="hljs-number"><span class="hljs-number">0.0023s</span></span> <span class="hljs-number"><span class="hljs-number">1756.6</span></span> <span class="hljs-number"><span class="hljs-number">430.1</span></span> op op/s <span class="hljs-number"><span class="hljs-number">256</span></span> bit ecdh (nistp256) <span class="hljs-number"><span class="hljs-number">0.0002s</span></span> <span class="hljs-number"><span class="hljs-number">4893.5</span></span> <span class="hljs-number"><span class="hljs-number">384</span></span> bit ecdh (nistp384) <span class="hljs-number"><span class="hljs-number">0.0019s</span></span> <span class="hljs-number"><span class="hljs-number">525.9</span></span></code> </pre> <br><p>  Working with the P-384 takes 7‚Äì9 times longer depending on the operation. </p><br><p>  If we compare ECDSA and RSA, then it can be seen that in the case of ECDSA the computational load falls more on the client than on the server. </p><br><p>  If you want to repeat the tests at home, then before the tests should raise the priority of the current process. </p><br><pre> <code class="hljs mel">sudo renice <span class="hljs-number"><span class="hljs-number">-1</span></span> $$</code> </pre> <br><p>  One thing is clear: the choice of ciphers and parameters must be approached more carefully. </p><br><h1 id="princip-poiska-shifrov">  Cipher Search Principle </h1><br><p>  Listing ciphers by the list is not the best idea because it will soon be possible to use ChaCha20 / Poly1305 in nginx, without recompiling and third-party sources.  With an explicit cipher job, the server will not use any new types of encryption without reconfiguration.  This is not something you want to think about every day. </p><br><p>  It will be better to choose ciphers <a href="https://wiki.openssl.org/index.php/Manual:Ciphers%25281%2529">by keywords or tags</a> , each of which correspond to a certain group of ciphers.  Keywords in different versions of OpenSSL are different, but we can always check them. </p><br><p>  For example, the <em>EECDH</em> tag matches all ciphers with the exchange of one-time (ephemeral) keys using the DH algorithm with elliptic curves. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-ECDSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-AES128-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-RC4-SHA SSLv3 Kx=ECDH Au=RSA Enc=RC4(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-RC4-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=RC4(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-DES-CBC3-SHA SSLv3 Kx=ECDH Au=RSA Enc=<span class="hljs-number"><span class="hljs-number">3</span></span>DES(<span class="hljs-number"><span class="hljs-number">168</span></span>) Mac=SHA1 ECDHE-ECDSA-DES-CBC3-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=<span class="hljs-number"><span class="hljs-number">3</span></span>DES(<span class="hljs-number"><span class="hljs-number">168</span></span>) Mac=SHA1 ECDHE-RSA-<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>-SHA SSLv3 Kx=ECDH Au=RSA Enc=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> Mac=SHA1 ECDHE-ECDSA-<span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span> Mac=SHA1</code> </pre> <br><p>  The ciphers are shown in the list according to priority: the client will select the first suitable cipher, viewing the list in the specified order. </p><br><p>  If we had the latest version of OpenSSL, then to get the same list, we would use a clear <em>ECDHE</em> tag, giving the same list and corresponding to the cipher prefix.  <a href="https://www.openssl.org/docs/man1.0.1/apps/ciphers.html">In the current version there is no such tag</a> , so we use one. </p><br><p>  In the resulting list, ciphers are striking without, in fact, encryption, which come with the mark <code>Enc=None</code> .  Exclude such ciphers, giving only authentication.  At the same time exclude ciphers without authentication. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">openssl</span></span> ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:!aNULL:!eNULL'</span></span></code> </pre> <br><p>  For a complete and irrevocable exclusion, the tags of the groups <em>aNULL</em> and <em>eNULL</em> with unsuitable ciphers are mentioned with negation.  There will be no cipher with <code>Au=None</code> or <code>Enc=None</code> in the list. </p><br><p>  Tags can be combined by getting intersections of cipher suites.  Get ciphers that combine ECDHE, AES-256 and <a href="http://crypto.stackexchange.com/questions/2310/what-is-the-difference-between-cbc-and-gcm-mode">GCM</a> . </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH+AES256+AESGCM'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD</code> </pre> <br><p>  Cipher groups can be moved lower in priority, with a plus at the beginning.  Lower the priority of ciphers with AES-256 without deleting them. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH+aRSA+AES:+AES256'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1</code> </pre> <br><p>  You can temporarily remove some cipher group, then add it in another form.  Exclude ciphers from 3DES from all ECDHE ciphers, and then return them back, but only in combination with RSA key exchange.  Such weak ciphers should be at the very bottom of the list. </p><br><pre> <code class="hljs ruby">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:-3DES:RSA+3DES'</span></span> <span class="hljs-params"><span class="hljs-params">| tail -1 |</span></span> column -t DES-CBC3-SHA SSLv3 Kx=RSA Au=RSA Enc=<span class="hljs-number"><span class="hljs-number">3</span></span>DES(<span class="hljs-number"><span class="hljs-number">168</span></span>) Mac=SHA1</code> </pre> <br><h1 id="vybiraem-shifry">  Choosing ciphers </h1><br><p>  Now we have everything to make a list of ciphers for nginx, which will not require additions when new versions of OpenSSL are released, losing old ciphers and acquiring new ones without any participation on our part.  We consider the need to support older browsers and speed requirements. </p><br><p>  Let's start by getting the list of ciphers we already use, but we will not exclude ciphers for certificates with EC in case we ever want to use this type of certificate. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH+AES256'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1</code> </pre> <br><p>  In fact, we need not so much AES specifically, but how many weak 3DES and RC4 ciphers are not needed.  Last exclude completely and forever. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:-3DES:!NULL:!RC4'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-ECDSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-AES128-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1</code> </pre> <br><p>  Give priority <a href="https://www.cult-of-tech.net/2016/04/testing-tls-cipher-performance/">to faster ciphers</a> , lowering it for AES-256.  We will not completely remove AES-256 in case someone really needs AES-256.  (The extra bits from him are <a href="http://crypto.stackexchange.com/questions/20/what-are-the-practical-differences-between-256-bit-192-bit-and-128-bit-aes-enc">imaginary</a> .) </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:+AES256:-3DES:!NULL:!RC4'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-ECDSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-AES128-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1</code> </pre> <br><p>  Such a cipher string will not exclude ChaCha20 / Poly1305 in the next version of OpenSSL. </p><br><pre> <code class="hljs pgsql">$ openssl <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>; openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:+AES256:-3DES:!NULL:!RC4'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t | head -n <span class="hljs-number"><span class="hljs-number">6</span></span> OpenSSL <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>e <span class="hljs-number"><span class="hljs-number">16</span></span> Feb <span class="hljs-number"><span class="hljs-number">2017</span></span> ECDHE-ECDSA-CHACHA20-POLY1305 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=CHACHA20/POLY1305(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-CHACHA20-POLY1305 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=CHACHA20/POLY1305(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-CCM8 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESCCM8(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-CCM TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESCCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD</code> </pre> <br><p>  For some legacy clients, we will return AES without ephemeral keys. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:+AES256:-3DES:RSA+AES:!NULL:!RC4'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-ECDSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-AES128-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD AES256-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA256 AES256-SHA SSLv3 Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 AES128-SHA SSLv3 Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1</code> </pre> <br><p>  Finally, let's get back 3DES without ephemeral keys purely for IE8 / XP.  There is no way to help IE6 / XP - by default it does not support TLS. </p><br><pre> <code class="hljs pgsql">$ openssl ciphers -v <span class="hljs-string"><span class="hljs-string">'EECDH:+AES256:-3DES:RSA+AES:RSA+3DES:!NULL:!RC4'</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> -t ECDHE-RSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-ECDSA-AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD ECDHE-RSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-ECDSA-AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 ECDHE-RSA-AES128-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-ECDSA-AES128-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 ECDHE-RSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-ECDSA-AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD ECDHE-RSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-ECDSA-AES256-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA384 ECDHE-RSA-AES256-SHA SSLv3 Kx=ECDH Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 ECDHE-ECDSA-AES256-SHA SSLv3 Kx=ECDH Au=ECDSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 AES256-GCM-SHA384 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=AEAD AES256-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA256 AES256-SHA SSLv3 Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">256</span></span>) Mac=SHA1 AES128-GCM-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AESGCM(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=AEAD AES128-SHA256 TLSv1<span class="hljs-number"><span class="hljs-number">.2</span></span> Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA256 AES128-SHA SSLv3 Kx=RSA Au=RSA Enc=AES(<span class="hljs-number"><span class="hljs-number">128</span></span>) Mac=SHA1 DES-CBC3-SHA SSLv3 Kx=RSA Au=RSA Enc=<span class="hljs-number"><span class="hljs-number">3</span></span>DES(<span class="hljs-number"><span class="hljs-number">168</span></span>) Mac=SHA1</code> </pre> <br><h1 id="itogo">  Total </h1><br><p>  With ciphers finished.  To support old clients, we need to return lower versions of TLS and, for speed, use a regular curve and a 2048-bit certificate. </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.example.com example.com; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl default_server; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/example.com/fullchain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/letsencrypt/live/example.com/privkey.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_trusted_certificate</span></span> /etc/letsencrypt/live/example.com/chain.pem; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=31536000"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> EECDH:+AES256:-3DES:RSA+AES:RSA+3DES:!NULL:!RC4; }</code> </pre> <br><p>  With this config, we get exactly the same result as that of Google at the beginning of 2017. </p><br><p><img src="https://habrastorage.org/files/4ce/983/b4f/4ce983b4f2194643a11d0051b7d259bd.png"></p><br><p>  At the same time, we know for sure that all clients open the site as quickly as possible without using weak ciphers: all modern browsers use ECDHE. </p><br><p>  Also, you definitely need to <a href="https://www.alexeykopytko.com/2017/free-ssl-from-letsencrypt/">configure OCSP stapling</a> and, optionally, <a href="http_ssl_module.html">TLS cache sessions</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325230/">https://habr.com/ru/post/325230/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325218/index.html">"Introduction to Elixir" - the first book on the Elixir in Russian</a></li>
<li><a href="../325220/index.html">Making your first game on the Phaser. Part 2 - Loading Resources</a></li>
<li><a href="../325222/index.html">Go digest Events, articles, interesting projects from the world of Go [March 15 - 30, 2017]</a></li>
<li><a href="../325224/index.html">We generate a table of contents for the text</a></li>
<li><a href="../325226/index.html">How hackers attack corporate WiFi: parsing attacks</a></li>
<li><a href="../325232/index.html">Zen social programming</a></li>
<li><a href="../325234/index.html">Poll. What php-framework do you use?</a></li>
<li><a href="../325236/index.html">FPGA image rotation</a></li>
<li><a href="../325242/index.html">Tuning SQL Server 2012 under SharePoint 2013/2016. Part 1</a></li>
<li><a href="../325244/index.html">SEM time measure. Or ‚Äúhow do you know SEM and what to do next?‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>