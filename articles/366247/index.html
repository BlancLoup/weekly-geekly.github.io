<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>I and the diode, or the new adventures of the mouse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you may remember, not so long ago I soldered a capacitor to my mouse and happily reported on this epoch-making event . But it soon became clear tha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>I and the diode, or the new adventures of the mouse</h1><div class="post__text post__text-html js-mediator-article">  As you may remember, not so long ago I soldered a capacitor to my mouse and <a href="http://geektimes.ru/post/260672/">happily reported on this epoch-making event</a> .  But it soon became clear that my joy was premature.  So, I bring to your attention the continuation of a detective story. <br><br><img src="https://habrastorage.org/files/c24/6a1/5ec/c246a15eccd54f3dbbf5c36bdf1b33b9.JPG"><br><br><a name="habracut"></a><br>  No, the button did not crumble to dust, as one of the commentators prophesied.  And in general, none of those present guessed the fate of the long-suffering mouse, although, as I understand now, it was almost obvious. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On a tip from a respected <a href="http://geektimes.ru/users/ploop/" class="user_link">ploop,</a> I discovered the program <a href="http://www.x.org/archive/X11R7.7/doc/man/man1/xev.1.xhtml">xev</a> , which among other things shows which buttons are pressed.  I click the right button and see: <br><br><div class="spoiler">  <b class="spoiler_title">Oh God</b> <div class="spoiler_text"><pre> ButtonPress event, serial 56, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 3959640285, (43,112), root: (1109,578),
     state 0x10, button 1, same_screen YES

 ButtonPress event, serial 56, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 3959640285, (43,112), root: (1109,578),
     state 0x110, button 3, same_screen YES

 ButtonRelease event, serial 56, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 3959640436, (43,112), root: (1109,578),
     state 0x510, button 3, same_screen YES

 ButtonRelease event, serial 56, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 3959640452, (43,112), root: (1109,578),
     state 0x110, button 1, same_screen YES
</pre><br></div></div><br><br>  That is, whenever I press the right button (3), the mouse thinks that the left button (1) is also pressed!  At this point, I remembered that after reworking this mouse, it became impossible to bring up the context menu in the Chrome window header.  Then I did not attach any importance to this, because at about the same time, moving back and forth with the ‚Äúback and forth‚Äù buttons also fell off, and only on Habr√© / GT and only on the second mouse, which I (my mother swear) did nothing with. <br><br>  Vypayav capacitor, I was convinced - indeed, it was he who was guilty of pressing the extra button.  And this put an end to the whole idea of ‚Äã‚Äãa panacea for bounce from the previous post.  Since there was no wish to choose between habrassucicide and a deal with conscience, I had to think how to overcome this most unpleasant side effect.  So again we disassemble the mouse, cut in the oscilloscope and try to achieve the very understanding that we lacked last time. <br><br>  The mouse appeared to be based on the <a href="http://geektimes.ru/search/%3Fq%3D%255Bnrf24le1%255D%26target_type%3Dposts">nRF24LE1</a> microcontroller well-known in the nation. <br><br>  By dialing, it was found that all the breaker leads go straight to the feet of the processor, and each such leg is connected to more than one switch.  More specifically, the scheme appears as follows: <br><br><img src="https://habrastorage.org/files/559/c40/55d/559c4055dc704bc48d1319fa9a703313.png"><br><br>  (An asterisk button means a dpi change button that does not pass to the mouse exit.) <br><br>  This makes it possible to suspect the authors in the application of the technique called <a href="http://easyelectronics.ru/matrichnaya-klaviatura.html">‚Äúmatrix keyboard‚Äù</a> .  The scanning signal is alternately transmitted to the legs and looks at which reading legs it appeared.  This allows you to save legs - because the buttons in this way can be set in proportion to the square of the number of used legs.  (In this case, we have 6 buttons and 5 conclusions - that is, the whole one leg is saved. However, I forgot to ring the wheel, so it is possible that the same circuit serves the wheel, then it means saving two legs.) <br><br>  But for now this is only an assumption, you need to check it.  <s>Let's set crocodiles on.</s> Connect the P0 and A conductors (in terms of the previous picture) to the oscilloscope.  By pressing the left button (1) we see: <br><br><img src="https://habrastorage.org/files/c3c/1a3/5ac/c3c1a35ac70b4b09baa35adfa0ae7287.jpg"><br><br>  At P0, a pulse with a duration of 20 microseconds (indicated by an arrow) is applied, which comes to the leg A at a closed switch. It is not visible here, but the interval between pulses is about 10-15 milliseconds.  So, software bounce protection is still present, and it becomes unclear how it turns out that it does not help.  But back to our sheep and release the button: <br><br><img src="https://habrastorage.org/files/7a1/9e5/186/7a19e51867d3450e8bc3f8ad66f79e85.jpg"><br><br>  As we expected, the scanning signal on the reading foot disappears.  And now press the left and right buttons at the same time: <br><br><img src="https://habrastorage.org/files/bde/15c/f85/bde15cf85fb24b7b810162f21ed70296.jpg"><br><br>  And again, in full accordance with expectations, we get two signals from the two legs at the output, separated in time.  If you now press the middle button, there will be three signals that will merge into one big line. <br><br>  But how is it that when two buttons are pressed, the scanning legs do not short out with each other and do not spoil the signal to each other?  In the <a href="http://easyelectronics.ru/matrichnaya-klaviatura.html">above article</a> for this proposed to use diodes.  Here everything is simpler - when the leg is inactive, it is transferred to the Hi-Z (high resistance) mode, that is, it is actually disconnected from the circuit, and no current flows through it.  As evidence in favor of this - if, with the buttons open, inadvertently touch the scanning port, the oscilloscope will show the characteristic ‚Äúwool‚Äù (that is, interference from the radio broadcast received by our body): <br><br><img src="https://habrastorage.org/files/60c/67c/79e/60c67c79edac477e9801742f29ef4ba5.jpg"><br><br>  To finally confirm our guess, we set up an experiment.  If the button presses are registered by increasing the voltage, then if you close the scanning port to power, the mouse should perceive this as pressing all the buttons on this port. <br><br><div class="spoiler">  <b class="spoiler_title">Close port A</b> <div class="spoiler_text"><pre> ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940208, (547,509), root: (1297,734),
     state 0x10, button 6, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940208, (547,509), root: (1297,734),
     state 0x10, button 6, same_screen YES

 ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940208, (547,509), root: (1297,734),
     state 0x10, button 1, same_screen YES

 ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940208, (547,509), root: (1297,734),
     state 0x110, button 3, same_screen YES

 ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940208, (547,509), root: (1297,734),
     state 0x510, button 2, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940253, (547,509), root: (1297,734),
     state 0x710, button 2, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940268, (547,509), root: (1297,734),
     state 0x510, button 1, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059940268, (547,509), root: (1297,734),
     state 0x410, button 3, same_screen YES

</pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Close port B</b> <div class="spoiler_text"><pre> ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977818, (172.409), root: (922,634),
     state 0x10, button 7, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977818, (172.409), root: (922,634),
     state 0x10, button 7, same_screen YES

 ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977818, (172.409), root: (922,634),
     state 0x10, button 8, same_screen YES

 ButtonPress event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977818, (172.409), root: (922,634),
     state 0x10, button 9, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977950, (172.409), root: (922,634),
     state 0x10, button 8, same_screen YES

 ButtonRelease event, serial 166, synthetic NO, window 0xb200001,
     root 0x274, subw 0x0, time 4059977950, (172.409), root: (922,634),
     state 0x10, button 9, same_screen YES

</pre><br></div></div><br><br>  Again, everything is as we expected, plus there were ‚ÄúEaster‚Äù buttons 6 and 7, which are not physically on the mouse (the wheel corresponds to buttons 4 and 5). <br><br>  So, we know the truth about the mouse and its buttons.  But how will this help us cope with our initial misfortune?  To do this, we need to understand two more things - why the capacitor delays releasing the button and why it contributes to pressing it when another button is pressed. <br><br><img src="https://habrastorage.org/files/de1/2da/b7c/de12dab7cdc34e9ea32ad0f489140d45.png"><br><br>  When we close button 1, the capacitor instantly discharges, and the voltage on it becomes zero.  As long as the button is pressed, the capacitor is shorted, so that the mouse perceives pressing the button as if there was no condenser. <br><br>  Now let go of the button.  Since the capacitor has a capacitance, the voltage on it is still zero.  So, if we apply a scanning voltage (2.5 V power supply) to P0, then the input A will also have 2.5 volts, which corresponds to the pressed button. <br><br>  However, with each such pulse, the capacitor will gradually be charged (through the resistance R1).  And at one point, it will charge, say, up to 2 volts, and at the input A there will already be 0.5 volts, which is not enough for a unit to appear on this input.  Therefore, some time after the button is released, the mouse will think that the button is still pressed, and then ‚Äúunderstand‚Äù that it has been released. <br><br>  You can even approximately estimate this time.  Our <a href="https://ru.wikipedia.org/wiki/RC-%25D1%2586%25D0%25B5%25D0%25BF%25D1%258C">RC chain</a> consists of a 13 kŒ© resistor and a capacitor, for example, 0.1 ¬µF.  Multiply these two values ‚Äã‚Äãand find the characteristic time of 1.3 milliseconds.  But since the current flows not all the time, but only 20 microseconds every 10 milliseconds, this time extends to 0.65 seconds - as we intended last time. <br><br>  One could be delighted with such an exact coincidence of calculation with the experiment, but it is necessary to add another spoonful of tar.  The point is that the characteristic time is the time during which the voltage drops to the number e, that is, 2.7 times.  But the datasheet on nRF24LE1 tells us that Input high voltage is 0.7 VDD, and Input low voltage is 0.3 VDD.  That is, the inputs of our processor work as a Schmitt trigger, and in order for them to perceive the unit, we need to raise the voltage to 0.7 supply voltage.  Why did we take 0.7, not 0.3, you ask?  It's very simple - since most of the time at input A is pure zero, then at the moment of impulse we need to raise the voltage to 0.7 supply, otherwise the Schmitt trigger will not switch to one.  So calculation gives time <br><br>  ln (0.7) / ln (1 / e) * 0.65 = 0.23 seconds. <br><br>  And in fact, we have 0.6 seconds!  If you subtract the time when the button is closed - it is 0.5 seconds, which is still a lot.  To explain this, we can assume that in the Hi-Z mode, the leg resistance P0 is still not infinite, and ‚Äúquietly‚Äù discharges the capacitor in the gap between the measuring pulses.  Very roughly from our data, we can estimate its value - since it discharges a capacitor by 10 ms, an amount comparable to that it charges for 20 Œºs, this resistance is more than 6.5 megaohms. <br><br>  And here we need to remember another fact, which I did not attach importance.  Namely, if you solder a capacitor smaller than 2 nF, the mouse will think that the button is always pressed.  And now this fact gets an explanation - in 10 milliseconds the capacitor has time to discharge (2 nF * 6.5 MŒ© = 13 ms), so that with a Schmitt trigger, the trigger works, while this pulse is on, the capacitor is charged (2 nF * 13 kŒ© = 26 microseconds), but does not have time to charge to such an extent as to overcome the threshold of 0.3 supply voltage. <br><br>  Now let's see what happens when we press the right button, not the left button. <br><br>  At rest on the capacitor we have 2.5 volts.  Close switch 3 and wire 20 microsecond pulses from port P2 to conductor A.  But if A 2.5 volts plus 2.5 volts on a capacitor, then P0 should have 5 volts on its leg!  A controller is designed for no more than 3.6 volts.  Especially for such cases in the chips provide protective diodes, so that the voltage at the inputs does not exceed the supply voltage: <br><br><img src="https://habrastorage.org/files/68f/40a/afe/68f40aafea3840298a3308f911fcf64a.png"><br><br>  So, as soon as the supply voltage appears on P2, the capacitor is discharged through this diode, and it will have 0.7 volts, or even less.  And then it will be further discharged after 6.5 mega-ohms.  And when it comes time to measure the pulse on the leg P0, the voltage on the capacitor will be so small that at input A there will be an almost full supply voltage and, as a result, a clear unit.  So we got to press the left button when you press the right. <br><br>  Now, finally, we answered all the questions from the ‚Äúwho's to blame‚Äù category, only a very small amount remains - what to do?  Since the root of our trouble in discharging a capacitor, we put a barrier in the form of a diode in the path of this current: <br><br><img src="https://habrastorage.org/files/890/cf0/051/890cf00512674f46b6c333682fbd8e6c.png"><br><br>  I found the first diode, soldered - and indeed, unauthorized button presses no longer occur.  That's just the delay after the release of the left button disappeared.  How so?  And it‚Äôs very simple - as we already know, to trigger on input A there must be at least 0.7 supply voltage, that is, the entire bundle ‚Äúcapacitor + diode‚Äù must be no more than 0.75 volts.  And on the diode, as you know, it drops about 0.7 volts, plus another capacitor - that's not enough voltage. <br><br>  The <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25BE%25D0%25B4_%25D0%25A8%25D0%25BE%25D1%2582%25D1%2582%25D0%25BA%25D0%25B8">Schottky diode</a> will help us, the forward voltage drop on which is noticeably less than on a conventional diode. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/1ae/e5c/249/1aee5c249f0756312a96393452efceca.png" alt="image"><br><br>  Unfortunately, I could not find Schottky diodes, so I found the diode with the smallest voltage drop (multimeter showed 0.44 V) and soldered it cleanly to make sure that the proposed solution works.  You can search for it on the KDPV (the hint is black and pink).  I also had to raise the supply voltage to 3.3 V, but still the desired effect was achieved!  The delay of releasing the button is as much as 0.4 seconds, and no button is pressed ‚Äúfor the company‚Äù.  True, for obvious reasons, this structure had to be dismantled, but the main conclusion was made - Schottky diodes would save the father of Russian democracy. <br><br>  That, in fact, is the end of the tale. <br><br>  <b>UPD:</b> It turns out, and this is not the end.  <a href="http://geektimes.ru/post/260996/">It is rightly indicated in kamenta</a> that the given circuit with a diode cannot work, because the capacitor cannot discharge when the button is closed.  And it worked, apparently, only because the capacitor was discharged through the resistance of the oscilloscope probe, equal to one megaoma.  The following scheme is declared to be truly correct today: <br><br><img src="https://habrastorage.org/files/2b2/d01/95f/2b2d0195f34a41b18c679090f60863b2.png"><br><br>  That is, it is necessary to cut the track on the board leading from the switch to the ‚Äúscanning‚Äù leg and solder the diode into the resulting cut.  Well, or not necessarily to scan, the main thing - that the current could not flow to our scanning leg from one other scanning leg. <br><br>  Probably, writing a third article on this topic is too much, so if I‚Äôm going to experiment with this scheme, I‚Äôll add it here. </div><p>Source: <a href="https://habr.com/ru/post/366247/">https://habr.com/ru/post/366247/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../366237/index.html">The revolution in artificial intelligence. Part One: The Path to the Overmind</a></li>
<li><a href="../366239/index.html">Smart home or toy for men: end devices</a></li>
<li><a href="../366241/index.html">India has successfully launched its own launch vehicle</a></li>
<li><a href="../366243/index.html">Selected 100 candidates for the colonizers of Mars</a></li>
<li><a href="../366245/index.html">Youtube launched competitor Twitch.tv - Gaming.Youtube.com</a></li>
<li><a href="../366249/index.html">Sports Timekeeping System - Inside View</a></li>
<li><a href="../366251/index.html">NASA warns of the rapid rise in water levels in the oceans</a></li>
<li><a href="../366253/index.html">Three budget quadcopters with cameras in the historical museum "Kolomenskoye"</a></li>
<li><a href="../366255/index.html">The results of many studies on psychology and sociology can not be reproduced and could be forged</a></li>
<li><a href="../366257/index.html">Choosing a home printer - brief and to the point</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>