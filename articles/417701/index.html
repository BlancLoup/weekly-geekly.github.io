<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From simple scripts to a client-server application on WCF with my own hands: why I like working in CM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working in a Configuration Management team is related to providing the functionality of build processes ‚Äî assembling a company's products, pre-checkin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From simple scripts to a client-server application on WCF with my own hands: why I like working in CM</h1><div class="post__text post__text-html js-mediator-article">  Working in a Configuration Management team is related to providing the functionality of build processes ‚Äî assembling a company's products, pre-checking code, statistical analysis, documentation, and much more.  In addition, we are constantly working to optimize various processes, and, remarkably, we are practically free to choose tools for this interesting work.  Next, I will talk in detail about how, having only different levels of knowledge in C # and C ++, I made a functional WCF service for working with fix queues.  And why decided that it is very important. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b47/a3e/2d9/b47a3e2d9febdfd19dcde2b59d58df1b.png"><br><a name="habracut"></a><br><h2>  Automate once or 117 page instruction again and again </h2><br>  A small lyrical digression, so that you understand why I am so worried about the automation and optimization of processes. <br><br>  Before Veeam, I worked at a large international company - I was the team leader of the Configuration Management team, I was building the application and deploying it on test environments.  The program was successfully developed, new functions were added, documentation was written, the support of which I also worked on.  But I always wondered why such a serious program does not have a normal system of parameter configuration, which many dozens, if not hundreds, had. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I communicated on this topic with the developers and received an answer - the customer did not pay for this feature, did not agree on its cost, so the feature was not implemented.  And in fact, QA suffered and directly we, the CM team.  The configuration of the program and its pre-setting was carried out through a variety of configuration files, each of which contained dozens of parameters. <br><br>  Each new build, each new version made its own configuration changes.  Old configuration files could not be used, as they were often incompatible with the new version.  As a result, each time before deploying the build for the test or on the testers' working machines, it was necessary to spend a lot of time configuring the program, correcting configuration errors, and constantly consulting with developers on the topic ‚Äúwhy is this not so now‚Äù?  In general, the process was extremely not optimized. <br><br>  To assist in setting up, we had an instruction for 117 pages in Arial font size 9. We had to read very, very carefully.  Sometimes it seemed that it was easier to build a Linux kernel with eyes closed while the computer was turned off. <br><br>  It became clear that without optimization is not enough.  I started writing my configurator for a program with profile support and the ability to change parameters in a few seconds, but the project went to its final stage, and I moved to another project.  In it, we analyzed a lot of logs of one billing system for possible bugs in the server part.  Automating many actions using Python saved me from the monstrous amount of manual work.  I really liked this scripting language, and with its help we made a set of analysis scripts for all occasions.  Those tasks that required several days of thoughtful analysis using the ‚Äúcat logfile123 |  grep something_special, took a few minutes.  Everything became great ... and boring. <br><br><h2>  Configuration Management - new adventures </h2><br>  I came to Veeam as a small SM team.  Many processes required automation, optimization, rethinking.  But given complete freedom in the choice of tools!  The developer is obliged to use a specific programming language, code-style, a certain set of libraries.  The SM can use nothing at all to solve the problem, if he has enough time, courage and patience. <br><br>  Veeam, like many other companies, has the task of building updates for products.  The update included hundreds of files, and it was necessary to change only those that have changed, given a number of important conditions.  To do this, we created a lengthy powershell script that could climb in TFS, select files, lay them out according to the necessary daddies.  The functionality of the script was supplemented, it gradually became huge, it took a lot of time to debug and constantly some crutches to boot.  It was necessary to urgently do something. <br><br><h2>  What the developers wanted </h2><br>  Here are the main complaints: <br><br><ul><li>  Unable to put the fixes in the queue.  You have to constantly check the web page to see when the assembly of the private fix is ‚Äã‚Äãcomplete and you can run your own assembly. <br></li><li>  No error notifications - in order to see errors in the GUI of the build application, you have to go to the server and watch a lot of voluminous logs. <br></li><li>  No build history of private fixes. <br></li></ul><br>  It was necessary to deal with these tasks and add pleasant trifles, which the developers also would not have refused. <br><br><h2>  What are private fixes </h2><br>  A private fix in the context of our development is a specific set of fixes in the code that is stored in the Team Foundation Server for the release branch in the shelveset.  A small explanation for those who are not too familiar with TFS terminology: <br><br><ul><li>  check-in - a set of local changes in the source code, which is made to the code stored in TFS.  This check can be checked using Continuous Integration / Gated Check-in processes, allowing you to skip only the correct code and reject all check-ins violating the collection of the final project. <br></li><li>  shelveset is a set of local changes in the source code that is not made directly to the source code located in TFS, but is available by its name.  Shelvset can be deployed on a local developer or build system to work with modified code that is not included in TFS.  Also, the shelfset can be added to TFS as a check after deployment, when all work on it is completed.  For example, this is how gateted chekin works.  First, the shellset is checked on the builder.  If the check is successful, the boxset turns into a check! <br></li></ul><br>  This is what the private fix builder does: <br><br><ol><li>  Gets the name (number) of the shelvset and expands it on the private fixes builder.  As a result, we get the source code of the release product plus changes / fixes from the silkset.  The release branch remains unchanged. <br></li><li>  On the private fixes builder, a project or a series of projects for which a private fix was executed is collected. <br></li><li>  The set of compiled binary files is copied to the network directory of the private fix.  The directory contains the name of the shelvset, which is a sequence of numbers. <br></li><li>  The source code on the private fixes builder is reduced to its original form. <br></li></ol><br>  For the convenience of developers, a web interface is used, where you can specify the product for which you need to collect a private fix, specify the network set number, select projects for which you want to assemble a private fix, and add a fix assembly to the queue.  The screenshot below shows the final working version of the web application, which displays the current status of the build, the queue of private fixes and the history of their assembly.  In our example, only the organization queue for assembling private fixes is considered. <br><br><h2>  What did i have </h2><br><ul><li>  Private fixes builder who collected private fixes from TFS shells by running the console application with the specified command line parameters. <br></li><li>  Veeam.Builder.Agent is a WCF service written by Veeam, which runs the application with parameters in the console mode under the current user and returns the current status of the application. <br></li><li>  The IIS web service is a Windows Forms application that allowed you to enter the name of a network chain, set parameters and start the process of building a private fix. <br></li><li>  Very shallow programming knowledge - C ++, some C # at the university and writing small applications for automation, adding new functions to current build processes and as a hobby. <br></li><li>  Experienced colleagues, Google and Indian articles on MSDN are the sources of all the answers. <br></li></ul><br><h2>  What do we do </h2><br>  In this article I will explain how I implemented the setting of the assembly of fixes to the queue and their sequential launch on the builder.  Here are the parts of the solution: <br><br><ul><li>  QBuilder.AppQueue is my WCF service that provides work with the build queue and calls the Veeam.Builder.Agent service to run the build program. <br></li><li>  dummybuild.exe is a stub program used for debugging and as a visual aid.  Needed to visualize the passed parameters. <br></li><li>  QBuilder.AppLauncher is a WCF service that runs applications in the current user‚Äôs console and runs interactively.  This is significantly simplified, written specifically for this article analogue of the program Veeam.Builder.Agent.  The original service can work as a windows-service and run applications in the console, which requires additional work with the Windows API.  To describe all the tricks would require a separate article.  My example works as a simple interactive console service and uses two functions - starting a process with parameters and checking its status. <br></li></ul><br>  Additionally, they created a new convenient web application that can work with several builders and log events.  In order not to overload the article, we will not talk about it in detail yet.  In addition, this article does not show how to work with TFS, with the storage history of collected private fixes and various auxiliary classes and functions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d3c/c13/6b9/d3cc136b9f661a26314f2a44eff3a4b3.jpg"><br><br><h2>  Creation of WCF-services </h2><br>  There are many detailed articles describing the creation of WCF services.  I liked the <a href="https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-host-a-wcf-service-in-a-managed-windows-service">material from Microsoft</a> most of all.  I took it as a basis for development.  To facilitate familiarity with the project, I additionally laid out the <a href="https://drive.google.com/open%3Fid%3D11rxZRWnBHHXzAQ23hjGIX4L4WOZNb7Ew">binaries</a> .  Let's start! <br><br><h3>  Create a QBuilder.AppLauncher service </h3><br>  Here we will only have a primary service disc.  At this stage, we need to make sure that the service starts and runs.  In addition, the code is identical for both QBuilder.AppLauncher and QBuilder.AppQueue, so this process will need to be repeated two times. <br><br><ol><li>  Create a new console application named QBuilder.AppLauncher <br></li><li>  Rename Program.cs to Service.cs <br></li><li>  Rename the namespace to QBuilder.AppLauncher <br></li><li>  Add the following references to the project: <br>  a.  System.ServiceModel.dll <br>  b.  System.ServiceProcess.dll <br>  c.  System.Configuration.Install.dll <br></li><li>  Add the following definitions to Service.cs <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceProcess; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Configuration.Install;</code> </pre> <br>  In the process of further assembly, the following definitions will also be needed: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.XPath;</code> </pre> </li><li>  We define the IAppLauncher interface and add functions for working with the queue: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    [ServiceContract(Namespace = "http://QBuilder.AppLauncher")]   public interface IAppLauncher   {    //             [OperationContract]       bool TestConnection();   }</span></span></code> </pre></li><li>  In the AppLauncherService class, we implement the interface and test function TestConnection: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppLauncherService</span></span> : <span class="hljs-title"><span class="hljs-title">IAppLauncher</span></span>   {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>       {           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;       }   }</code> </pre></li><li>  Create a new class AppLauncherWindowsService, which inherits the ServiceBase class.  Add a local serviceHost variable - a link to ServiceHost.  We define the Main method, which calls ServiceBase.Run (new AppLauncherWindowsService ()): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppLauncherWindowsService</span></span> : <span class="hljs-title"><span class="hljs-title">ServiceBase</span></span>   {       <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ServiceHost serviceHost = <span class="hljs-literal"><span class="hljs-literal">null</span></span>;       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppLauncherWindowsService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>       {           <span class="hljs-comment"><span class="hljs-comment">// Name the Windows Service           ServiceName = "QBuilder App Launcher";       }       public static void Main()       {           ServiceBase.Run(new AppLauncherWindowsService());       }</span></span></code> </pre></li><li>  Override the OnStart () function that creates a new instance of ServiceHost: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span>       {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serviceHost != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)           {               serviceHost.Close();           }           <span class="hljs-comment"><span class="hljs-comment">// Create a ServiceHost for the CalculatorService type and           // provide the base address.           serviceHost = new ServiceHost(typeof(AppLauncherService));           // Open the ServiceHostBase to create listeners and start           // listening for messages.           serviceHost.Open();       }</span></span></code> </pre></li><li>  Override the onStop function that closes the ServiceHost instance: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>       {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serviceHost != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)           {               serviceHost.Close();               serviceHost = <span class="hljs-literal"><span class="hljs-literal">null</span></span>;           }       }   }</code> </pre></li><li>  Create a new class ProjectInstaller, inherited from the Installer and marked RunInstallerAttribute, which is set to True.  This allows you to install the Windows service using the installutil.exe program: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">RunInstaller(true)</span></span>]   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProjectInstaller</span></span> : <span class="hljs-title"><span class="hljs-title">Installer</span></span>   {       <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServiceProcessInstaller process;       <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServiceInstaller service;       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProjectInstaller</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>       {           process = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceProcessInstaller();           process.Account = ServiceAccount.LocalSystem;           service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceInstaller();           service.ServiceName = <span class="hljs-string"><span class="hljs-string">"QBuilder App Launcher"</span></span>;           Installers.Add(process);           Installers.Add(service);       }   }</code> </pre></li><li>  Change the contents of the app.config file: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"QBuilder.AppLauncher.AppLauncherService"</span></span></span><span class="hljs-tag">              </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behaviorConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AppLauncherServiceBehavior"</span></span></span><span class="hljs-tag">&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddresses</span></span></span><span class="hljs-tag">&gt;</span></span>           <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">baseAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://localhost:8000/QBuilderAppLauncher/service"</span></span></span><span class="hljs-tag">/&gt;</span></span>         <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">baseAddresses</span></span></span><span class="hljs-tag">&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">                 </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wsHttpBinding"</span></span></span><span class="hljs-tag">                 </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"QBuilder.AppLauncher.IAppLauncher"</span></span></span><span class="hljs-tag"> /&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mex"</span></span></span><span class="hljs-tag">                 </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mexHttpBinding"</span></span></span><span class="hljs-tag">                 </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IMetadataExchange"</span></span></span><span class="hljs-tag"> /&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AppLauncherServiceBehavior"</span></span></span><span class="hljs-tag">&gt;</span></span>         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceMetadata</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">httpGetEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span>         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceDebug</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">includeExceptionDetailInFaults</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"False"</span></span></span><span class="hljs-tag">/&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </li></ol><br><h3>  We check the serviceability of the service </h3><br><ol><li>  Compile the service. <br></li><li>  Install it with the installutil.exe command <br>  1) Go to the folder where the compiled service file is <br>  2) Run the installation command: <br>  C: \ Windows \ Microsoft .NET \ Framework64 \ v4.0.30319 \ InstallUtil.exe </li><li>  Go to the services.msc snap-in, check for the availability of the QBuilder App Launcher service and launch it. <br></li><li>  The serviceability of the service is checked using the WcfTestClient.exe program, which is included in the delivery of VisualStudio: <br><br>  1) Run WcfTestClient <br>  2) Add the address of the service: <a href="http://localhost:8000/QBuilderAppQueue/service">http: // localhost: 8000 / QBuilderAppLauncher / service</a> <br>  3) The service interface opens: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f32/d38/35e/f32d3835e5b7ddcb399f7e48b3028df9.png"><br><br>  4) Call the TestConnection test function, check that everything works and the function returns a value: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/00e/96a/460/00e96a46098ebee72c99b32357930759.png"></li></ol><br>  Now, when the working blank of service is received, we add functions necessary for us. <br><br><h3>  Why do I need a test function that does nothing </h3><br>  When I started learning how to write a WCF service from scratch, I read a bunch of articles on this topic.  On my desk lay a dozen or two printed sheets, on which I understood what and how.  I admit, I did not succeed in starting the service right away.  I spent a lot of time and came to the conclusion that making a service pig is really important.  With it you will be sure that everything works and you can begin to implement the necessary functions.  The approach may seem wasteful, but it will make life easier if a bunch of written code does not work as it should. <br><br><h3>  Add the ability to run from the console </h3><br>  Let's go back to the application.  At the debugging stage and in some other cases, it is required to start the service as a console application without registering as a service.  This is a very useful feature that allows you to do without the tedious use of debuggers.  It is in this mode that the QBuilder.AppLauncher service works.  Here's how to implement it: <br><br><ol><li>  Add the RunInteractive procedure to the AppLauncherWindowsService class that provides the service in the console mode: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunInteractive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceBase[] services</span></span></span><span class="hljs-function">)</span></span> {   Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Service is running in interactive mode."</span></span>);   Console.WriteLine();   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ServiceBase).GetMethod(<span class="hljs-string"><span class="hljs-string">"OnStart"</span></span>, BindingFlags.Instance | BindingFlags.NonPublic);   <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> services)   {       Console.Write(<span class="hljs-string"><span class="hljs-string">"Starting {0}..."</span></span>, service.ServiceName);       start.Invoke(service, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { } });       Console.Write(<span class="hljs-string"><span class="hljs-string">"Started {0}"</span></span>, service.ServiceName);   }   Console.WriteLine();   Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Press any key to stop the services and end the process..."</span></span>);   Console.ReadKey();   Console.WriteLine();   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stop = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ServiceBase).GetMethod(<span class="hljs-string"><span class="hljs-string">"OnStop"</span></span>, BindingFlags.Instance | BindingFlags.NonPublic);   <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> services)   {       Console.Write(<span class="hljs-string"><span class="hljs-string">"Stopping {0}..."</span></span>, service.ServiceName);       stop.Invoke(service, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);       Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Stopped {0}"</span></span>, service.ServiceName);   }   Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"All services stopped."</span></span>); }</code> </pre></li><li>  We make changes to the Main procedure - we add the processing of command line parameters.  If the / console parameter is present and the user session is open, we launch the program in interactive mode.  Otherwise, we run as a service. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> services = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceBase[]   {       <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppLauncherWindowsService()   };   <span class="hljs-comment"><span class="hljs-comment">//           ,      /console   if (args.Length == 1 &amp;&amp; args[0] == "/console" &amp;&amp; Environment.UserInteractive)   {       //            RunInteractive(services);   }   else   {       //          ServiceBase.Run(services);   } }</span></span></code> </pre></li></ol><br><h3>  Add functions to launch the application and check its status </h3><br>  Service is made extremely simple, there are no additional checks.  He can run applications only in the console version and on behalf of the administrator.  It can also run them as a service - but you will not see them, they will spin in the background and you can only see them through the Task Manager.  All this can be realized, but this is a topic for a separate article.  Here the main thing for us is an illustrative working example. <br><br><ol><li>  To begin with, we add the global variable appProcess, which stores the currently running process. <br><br>  Add it to the class <code>public class AppLauncherService : IAppLauncher</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppLauncherService</span></span> : <span class="hljs-title"><span class="hljs-title">IAppLauncher</span></span>   {       Process appProcess;</code> </pre></li><li>  Add to this class a function that checks the status of the running process: <br><br><pre> <code class="cs hljs">   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>       {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appProcess!=<span class="hljs-literal"><span class="hljs-literal">null</span></span>)           {               <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appProcess.HasExited)               {                   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;               }               <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>               {                   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;               }           }           <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>           {               <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;           }       }</code> </pre><br>  The function returns false if the process does not exist or is not already started, and true if the process is active. <br></li><li>  Add the app launch function: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arguments, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> workingDirectory, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> domain, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeoutInMinutes</span></span></span><span class="hljs-function">)</span></span>       {           ProcessStartInfo processStartInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProcessStartInfo();           processStartInfo.FileName = fileName;           processStartInfo.Arguments = arguments;           processStartInfo.Domain = domain;           processStartInfo.UserName = userName;           processStartInfo.CreateNoWindow = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;           processStartInfo.UseShellExecute = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;           <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>           {               <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appProcess!=<span class="hljs-literal"><span class="hljs-literal">null</span></span>)               {                   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!appProcess.HasExited)                   {                       Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Process is still running. Waiting..."</span></span>);                       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;                   }               }           }           <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex)           {               Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Error while checking process: {0}"</span></span>, ex);           }           <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>           {               appProcess = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process();               appProcess.StartInfo = processStartInfo;               appProcess.Start();           }           <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex)           {               Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Error while starting process: {0}"</span></span>,ex);           }           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;                          }</code> </pre></li></ol><br>  The function starts any application with parameters.  The Domain and Username parameters are not used in this context and may be empty, since the service starts the application from the console session with administrator rights. <br><br><h3>  Starting the QBuilder.AppLauncher service </h3><br>  As previously described, this service is online and allows you to run applications in the current user session, checks whether the process is running or has already been completed. <br><br><ol><li>  To work, you need the files QBuilder.AppLauncher.exe and QBuilder.AppLauncher.exe.config, which are in the archive by the link above.  There is also the source code for this application for self-assembly. <br></li><li>  We start service with the rights of the administrator. <br></li><li>  The service console window will open: <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/981/e79/eb4/981e79eb4757690818462d72cbba5cc4.png"><br><br>  Any keystroke in the service console closes it, be careful. <br><br><ol><li>  For tests, run wcftestclient.exe, included in the delivery of Visual Studio.  We check the availability of the service at <a href="http://localhost:8000/QBuilderAppLauncher/service">http: // localhost: 8000 / QBuilderAppLauncher / service</a> or open the link in Internet Explorer. <br></li></ol><br>  If everything works, go to the next step. <br><br><h3>  Create a QBuilder.AppQueue service </h3><br>  And now let's move on to the most important service, for the sake of which the whole article was written!  We repeat the sequence of actions in the chapter ‚ÄúCreating the QBuilder.AppLauncher service‚Äù and in the ‚ÄúAdding the ability to run from the console‚Äù chapter, replacing AppLauncher with AppQueue in the code. <br><br><h3>  Add a link to the QBuilder.AppLauncher service for use in the queue service </h3><br><ol><li>  In the Solution Explorer for our project, select Add Service Reference and specify the address: <a href="http://localhost/">localhost</a> : 8000 / QBuilderAppLauncher / service <br></li><li>  Select the name namespace: AppLauncherService. <br></li></ol><br>  Now we can access the service interface from our program. <br><br><h3>  Create a structure for storing items of the queue </h3><br>  In the namespace QBuilder.AppQueue, add the QBuildRecord class: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     public class QBuildRecord { // ID  public string BuildId { get; set; } // ID  public string IssueId { get; set; } //   public string IssueName { get; set; } //    public DateTime StartDate { get; set; } //    public DateTime FinishDate { get; set; } //    C# public bool Build_CSharp { get; set; } //    C++ public bool Build_Cpp { get; set; } }</span></span></code> </pre> <br><h3>  Implementing the work class with the CXmlQueue queue </h3><br>  Add a class CXmlQueue.cs to our project, where there will be a number of procedures for working with an XML file: <br><br><ul><li>  Constructor CXmlQueue - sets during initialization the name of the file where the queue is stored. <br></li><li>  SetCurrentBuild - writes the current build information to the queue XML file.  This item is not in the queue, it stores information about the currently running process.  It may be empty. <br></li><li>  GetCurrentBuild - gets the parameters of the running process from the XML file queue.  It may be empty. <br></li><li>  ClearCurrentBuild is clearing the currentbuild element in the queue XML file if the process has terminated. <br></li><li>  OpenXmlQueue is the function to open the XML file where the queue is stored.  If the file is missing, a new one is created. <br></li><li>  GetLastQueueBuildNumber - each build in the queue has its own unique sequence number.  This function returns its value, which is stored in the root attribute. <br></li><li>  IncrementLastQueueBuildNumber - increases the value of the build number when placing a new build in the queue. <br></li><li>  GetCurrentQueue - returns a list of QBuildRecord elements from the queue XML file. <br></li></ul><br>  In the original code, all these procedures were placed in the main class, but for clarity, I made a separate class CXmlQueue.  The class is created in the QBuilder.AppQueue namespace namespace; check that all necessary definitions are specified: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.XPath; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">QBuilder.AppQueue</span></span> { . . . }</code> </pre> <br>  So, we implement.  Directly class CXmlQueue: <br><br><div class="spoiler">  <b class="spoiler_title">Click to reveal spoiler with code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//      XML  public class CXmlQueue { //  ,    string xmlBuildQueueFile; public CXmlQueue(string _xmlQueueFile) { xmlBuildQueueFile = _xmlQueueFile; } public string GetQueueFileName() { return xmlBuildQueueFile; } // ,       xml (   xml) public QBuildRecord GetCurrentBuild() { QBuildRecord qBr; XElement xRoot = OpenXmlQueue(); XElement xCurrentBuild = xRoot.XPathSelectElement("currentbuild"); if (xCurrentBuild != null) { qBr = new QBuildRecord(); qBr.BuildId = xCurrentBuild.Attribute("BuildId").Value; qBr.IssueId = xCurrentBuild.Attribute("IssueId").Value; qBr.StartDate = Convert.ToDateTime(xCurrentBuild.Attribute("StartDate").Value); return qBr; } return null; } // ,       xml (   xml) public void SetCurrentBuild(QBuildRecord qbr) { XElement xRoot = OpenXmlQueue(); XElement newXe = (new XElement( "currentbuild", new XAttribute("BuildId", qbr.BuildId), new XAttribute("IssueId", qbr.IssueId), new XAttribute("StartDate", DateTime.Now.ToString()) )); XElement xCurrentBuild = xRoot.XPathSelectElement("currentbuild"); if (xCurrentBuild != null) { xCurrentBuild.Remove(); // remove old value } xRoot.Add(newXe); xRoot.Save(xmlBuildQueueFile); } // ,       xml,  ,    public void ClearCurrentBuild() { XElement xRoot = OpenXmlQueue(); try { XElement xCurrentBuild = xRoot.XPathSelectElement("currentbuild"); if (xCurrentBuild != null) { Console.WriteLine("Clearing current build information."); xCurrentBuild.Remove(); } } catch (Exception ex) { Console.WriteLine("XML queue doesn't have running build yet. Nothing to clear!"); } xRoot.Save(xmlBuildQueueFile); } //   XML           public XElement OpenXmlQueue() { XElement xRoot; if (File.Exists(xmlBuildQueueFile)) { xRoot = XElement.Load(xmlBuildQueueFile, LoadOptions.None); } else { Console.WriteLine("Queue file {0} not found. Creating...", xmlBuildQueueFile); XElement xE = new XElement("BuildsQueue", new XAttribute("BuildNumber", 0)); xE.Save(xmlBuildQueueFile); xRoot = XElement.Load(xmlBuildQueueFile, LoadOptions.None); } return xRoot; } //       public int GetLastQueueBuildNumber() { XElement xRoot = OpenXmlQueue(); if (xRoot.HasAttributes) return int.Parse(xRoot.Attribute("BuildNumber").Value); return 0; } //              public int IncrementLastQueueBuildNumber() { int buildIndex = GetLastQueueBuildNumber(); buildIndex++; XElement xRoot = OpenXmlQueue(); xRoot.Attribute("BuildNumber").Value = buildIndex.ToString(); xRoot.Save(xmlBuildQueueFile); return buildIndex; } //    xml     QBuildRecord public List&lt;QBuildRecord&gt; GetCurrentQueue() { List&lt;QBuildRecord&gt; qList = new List&lt;QBuildRecord&gt;(); XElement xRoot = OpenXmlQueue(); if (xRoot.XPathSelectElements("build").Any()) { List&lt;XElement&gt; xBuilds = xRoot.XPathSelectElements("build").ToList(); foreach (XElement xe in xBuilds) { qList.Add(new QBuildRecord { BuildId = xe.Attribute("BuildId").Value, IssueId = xe.Attribute("IssueId").Value, IssueName = xe.Attribute("IssueName").Value, StartDate = Convert.ToDateTime(xe.Attribute("StartDate").Value), Build_CSharp = bool.Parse(xe.Attribute("Build_CSharp").Value), Build_Cpp = bool.Parse(xe.Attribute("Build_Cpp").Value) }); } } return qList; } }</span></span></code> </pre> <br></div></div><br>  The queue in the XML file looks like this: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildNumber</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"14"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"26086"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:50.515238+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"15"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"59559"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:50.6880927+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"45275"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:50.859937+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"17"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"30990"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.0321322+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"18"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16706"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.2009904+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"19"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"66540"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.3581274+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68618"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.5087854+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"21"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"18453"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.6713477+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"22"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68288"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.8277942+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"89884"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:52.0151294+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">currentbuild</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"13"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4491"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"13.06.2018 16:53:16"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Create a BuildQueue.xml file with this content and put it in the directory with the executable file.  This file will be used in test debugging to match test results. <br><br><h3>  Adding the AuxFunctions class </h3><br>  In this class, I place auxiliary functions.  Now there is only one function, FormatParameters, which formats the parameters for transfer to the console application for launch.  Listing of the AuxFunctions.cs file: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">QBuilder.AppQueue</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AuxFunctions</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       public static string FormatParameters(string fileName, IDictionary&lt;string, string&gt; parameters) { if (String.IsNullOrWhiteSpace(fileName)) { throw new ArgumentNullException("fileName"); } if (parameters == null) { throw new ArgumentNullException("parameters"); } var macros = String.Join(" ", parameters.Select(parameter =&gt; String.Format("\"{0}={1}\"", parameter.Key, parameter.Value.Replace(@"""", @"\""")))); return String.Format("{0} /b \"{1}\"", macros, fileName); } } }</span></span></code> </pre> <br><h3>  Add new features to the service interface </h3><br>  The test function TestConnection at this stage can be removed.  To implement the work of the queue, I needed the following set of functions: <br><br><ul><li>  PushBuild (QBuildRecord): void.  This is a function that adds a new value to the queue XML file with QBuildRecord parameters. <br></li><li>  TestPushBuild (): void.  This is a test function that adds test data to a queue in the XML file. <br></li><li>  PullBuild: QBuildRecord.  This is a function that retrieves the QBuildRecord value from the queue XML file.  It may be empty. <br></li></ul><br>  The interface will be like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAppQueue</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     [OperationContract] void PushBuild(QBuildRecord qBRecord); //     [OperationContract] void TestPushBuild(); //      [OperationContract] QBuildRecord PullBuild(); }</span></span></code> </pre><br><h3>  Implement the functions in the AppQueueService class: IAppQueue: </h3><br><br><div class="spoiler">  <b class="spoiler_title">Click to open spoiler with code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppQueueService</span></span> : <span class="hljs-title"><span class="hljs-title">IAppQueue</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,    public AppLauncherClient buildAgent; // ,      private string _xmlQueueFile; public AppQueueService() { //       .     ,  . _xmlQueueFile = ConfigurationManager.AppSettings["QueueFileName"]; } public QBuildRecord PullBuild() { QBuildRecord qBr; CXmlQueue xmlQueue = new CXmlQueue(_xmlQueueFile); XElement xRoot = xmlQueue.OpenXmlQueue(); if (xRoot.XPathSelectElements("build").Any()) { qBr = new QBuildRecord(); XElement xe = xRoot.XPathSelectElements("build").FirstOrDefault(); qBr.BuildId = xe.Attribute("BuildId").Value; qBr.IssueId = xe.Attribute("IssueId").Value; qBr.IssueName = xe.Attribute("IssueName").Value; qBr.StartDate = Convert.ToDateTime(xe.Attribute("StartDate").Value); qBr.Build_CSharp = bool.Parse(xe.Attribute("Build_CSharp").Value); qBr.Build_Cpp = bool.Parse(xe.Attribute("Build_Cpp").Value); xe.Remove(); // Remove first element xRoot.Save(xmlQueue.GetQueueFileName()); return qBr; } return null; } public void PushBuild(QBuildRecord qBRecord) { CXmlQueue xmlQueue = new CXmlQueue(_xmlQueueFile); XElement xRoot = xmlQueue.OpenXmlQueue(); xRoot.Add(new XElement( "build", new XAttribute("BuildId", qBRecord.BuildId), new XAttribute("IssueId", qBRecord.IssueId), new XAttribute("IssueName", qBRecord.IssueName), new XAttribute("StartDate", qBRecord.StartDate), new XAttribute("Build_CSharp", qBRecord.Build_CSharp), new XAttribute("Build_Cpp", qBRecord.Build_Cpp) )); xRoot.Save(xmlQueue.GetQueueFileName()); } public void TestPushBuild() { CXmlQueue xmlQueue = new CXmlQueue(_xmlQueueFile); Console.WriteLine("Using queue file: {0}",xmlQueue.GetQueueFileName()); int buildIndex = xmlQueue.IncrementLastQueueBuildNumber(); Random rnd = new Random(); PushBuild (new QBuildRecord { Build_CSharp = true, Build_Cpp = true, BuildId = buildIndex.ToString(), StartDate = DateTime.Now, IssueId = rnd.Next(100000).ToString(), IssueName = "TestIssueName" } ); } }</span></span></code> </pre> <br></div></div><br><h3>  Making changes to the AppQueueWindowsService class: ServiceBase </h3><br>  Add new variables to the class body: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// ,         private System.Timers.Timer timer; // ,       public QBuildRecord currentBuild; //public QBuildRecord processingBuild; // ,       public bool clientStarted; //    public string xmlBuildQueueFileName; //   public CXmlQueue xmlQueue; //         public string btWorkingDir; public string btLocalDomain; public string btUserName; public string buildToolPath; public string btScriptPath; public int agentTimeoutInMinutes; //  public AppQueueService buildQueueService;</span></span></code> </pre><br>  In the AppQueueWindowsService () constructor, add functions to read the configuration file, initialize the services and queue classes: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//          try { xmlBuildQueueFileName = ConfigurationManager.AppSettings["QueueFileName"]; buildToolPath = ConfigurationManager.AppSettings["BuildToolPath"]; btWorkingDir = ConfigurationManager.AppSettings["BuildToolWorkDir"]; btLocalDomain = ConfigurationManager.AppSettings["LocalDomain"]; btUserName = ConfigurationManager.AppSettings["UserName"]; btScriptPath = ConfigurationManager.AppSettings["ScriptPath"]; agentTimeout= 30000; //    buildQueueService = new AppQueueService(); //    xmlQueue = new CXmlQueue(xmlBuildQueueFileName); } catch (Exception ex) { Console.WriteLine("Error while loading configuration: {0}", ex); }</span></span></code> </pre> <br>  AgentTimeout - the frequency of the timer.  Specified in milliseconds.  Here we ask that the timer should fire every 30 seconds.  In the original, this parameter is in the configuration file.  For the article, I decided to ask him in the code. <br><br>  Add the function of checking the launched build process to the class: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//        public bool BuildIsStarted() { IAppLauncher builderAgent; try { builderAgent = new AppLauncherClient(); return builderAgent.IsStarted(); } catch (Exception ex) { return false; } }</span></span></code> </pre><br>  Add a procedure for working with a timer: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimerTick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, System.Timers.ElapsedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     if (!BuildIsStarted()) { //     clientStarted,     if (clientStarted) { //     ,  clientStarted  false      currentBuild.FinishDate = DateTime.Now; clientStarted = false; } else { //       clientStarted=false ( ) -      xmlQueue.ClearCurrentBuild(); } //        currentBuild = buildQueueService.PullBuild(); //    ,     if (currentBuild != null) { //     true -    clientStarted = true; //   currentbuild -     xml            xmlQueue.SetCurrentBuild(currentBuild); //      var parameters = new Dictionary&lt;string, string&gt;(StringComparer.OrdinalIgnoreCase) { {"BUILD_ID", currentBuild.BuildId}, {"ISSUE_ID", currentBuild.IssueId}, {"ISSUE_NAME", currentBuild.IssueName}, {"BUILD_CSHARP", currentBuild.Build_CSharp ? "1" : "0"}, {"BUILD_CPP", currentBuild.Build_Cpp ? "1" : "0"} }; //       var arguments = AuxFunctions.FormatParameters(btScriptPath, parameters); try { //          AppLauncher IAppLauncher builderAgent = new AppLauncherClient(); builderAgent.Start(buildToolPath, arguments, btWorkingDir, btLocalDomain, btUserName, agentTimeout); } catch (Exception ex) { Console.WriteLine(ex); } } } } catch (Exception ex) { Console.WriteLine(ex); } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We make changes to the OnStart function, we add a function for working with a timer: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//     OnStart protected override void OnStart(string[] args) { if (serviceHost != null) { serviceHost.Close(); } //      this.timer = new System.Timers.Timer(agentTimeout); //    this.timer.AutoReset = true; this.timer.Elapsed += new System.Timers.ElapsedEventHandler(this.TimerTick); this.timer.Start(); //  ServiceHost   AppQueueService serviceHost = new ServiceHost(typeof(AppQueueService)); //  ServiceHostBase      serviceHost.Open(); }</span></span></code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Checking the list of definitions used. </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is how it should look like now: </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceProcess; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Configuration.Install; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml.XPath; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> QBuilder.AppQueue.AppLauncherService;</code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add a configuration section to App.config </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the section we add the following set of parameters: </font></font><br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"QueueFileName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BuildQueue.xml"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BuildToolPath"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c:\temp\dummybuild.exe"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BuildToolWorkDir"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"c:\temp\"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LocalDomain"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"."</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ScriptPath"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"C:\Temp\BuildSample.bld"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We check the work of the service </font></font></h2><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unpack the QBuilder.AppLauncher.zip archive. </font><font style="vertical-align: inherit;">He and other necessary files are available by </font></font><a href="https://drive.google.com/open%3Fid%3D11rxZRWnBHHXzAQ23hjGIX4L4WOZNb7Ew"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reference</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy the dummybuild.exe file from the directory inside the binaries archive to the directory, for example, in c: \ temp. </font><font style="vertical-align: inherit;">This program is a test stub and simply displays the command line parameters that the service passes to the application being launched. </font><font style="vertical-align: inherit;">If you are using a different directory, remember to change the BuildToolPath and BuildToolWorkDir settings in the configuration file.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to the \ QBuilder.AppLauncher \ binaries \ QBuilder.AppLauncher \ directory and run the QBuilder.AppLauncher.exe file in administrator mode. </font><font style="vertical-align: inherit;">You can also build this service from source.</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We start the console version of the compiled service with the QBuilder.AppQueue.exe / console command with administrator rights. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We check that the service has started and is running: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/18b/e4a/b17/18be4ab1798effcc29cfa113f6b75452.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run and wait. </font><font style="vertical-align: inherit;">If everything works successfully, after 30 seconds the following window will appear:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/251/681/2a0/2516812a03c79a5c9b2d9811fbbdb0a0.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open the BuildQueue.xml file and observe how the queue shrinks and the currentbuild value changes: </font></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildNumber</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"19"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"66540"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.3581274+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68618"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.5087854+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"21"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"18453"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.6713477+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"22"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68288"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.8277942+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"89884"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:52.0151294+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">currentbuild</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"18"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16706"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"13.06.2018 23:20:06"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Each time dummy closes, the process is simulated to terminate, after which the next element in the queue is launched: </font></font><br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildNumber</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"21"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"18453"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.6713477+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"22"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68288"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:51.8277942+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"23"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"89884"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TestIssueName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2018-06-13T16:49:52.0151294+02:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_CSharp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Build_Cpp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">currentbuild</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BuildId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueId</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68618"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">StartDate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"13.06.2018 23:24:25"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildsQueue</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The queue is working! </font></font><br><br><h2>  results </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The powershell script has been sent to a landfill. The new application is completely written in C #. We have the opportunity to use rulesets - the rules that made the selection of files according to special criteria and inserted them only in certain places in the setup script. Due to the new hashing system, they solved the problem of selecting files only by name and size - it appeared when, with the same name and size, the files differed in content. The new update build program does not treat files as files ‚Äî it treats them as MD5 hashes and creates a hash table in which each set of files in a specific directory has its own unique hash. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dea/641/fbe/dea641fbea68d0be6417a2e757928d6b.png"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Screenshot of the final solution that we use in our work</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minor improvements to the solution are being made all the time, but we have already solved the most important problem - the new approach allowed us to completely remove the human factor and save ourselves from the heap of crutches. The system turned out so universal that in the near future it will be used to build hotfixes, where several files change. All this will work through a web interface using another application. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During the project, I figured out how to work with XML, with configuration files, with the file system. Now I have my own work, which I successfully use in other projects. For clarity of the article, I removed a large amount of code that could distract from the essence, and made a serious refactoring.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope this article will help you in working with WCF-services, with timers in the body of services and implementing queues through XML-files. </font><font style="vertical-align: inherit;">You can watch the work of applications and queues in the video:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/U4rXSbt_OMo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I want to thank Victor Borodich, whose advice helped a lot to bring this system to the working view. </font><font style="vertical-align: inherit;">Victor argues that if you plant a number of experienced developers and juniors, the quality of the code from the latter will definitely increase.</font></font></div><p>Source: <a href="https://habr.com/ru/post/417701/">https://habr.com/ru/post/417701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417687/index.html">Life asymmetry</a></li>
<li><a href="../417689/index.html">Mobio Talks with CEO Appnext about the CPI market and trends in the mobile applications industry</a></li>
<li><a href="../417691/index.html">Our bookshelf C # programmer. What about you?</a></li>
<li><a href="../417697/index.html">Simple image editor on VueJS</a></li>
<li><a href="../417699/index.html">Western Digital closes another HDD plant due to lower demand</a></li>
<li><a href="../417703/index.html">Age of Empires network code: 1500 archers on a 28.8 kbit / s modem</a></li>
<li><a href="../417705/index.html">How a video card manufacturer affects GPU mining profitability</a></li>
<li><a href="../417707/index.html">CSS-in-JS - myths and reality (for example, styled-components)</a></li>
<li><a href="../417709/index.html">Where and how do developers rate their employers? Services assessment companies in the IT industry</a></li>
<li><a href="../417711/index.html">What to read on Swift in Russian?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>