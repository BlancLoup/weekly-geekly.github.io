<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As it turned out, everyone knows, but not everyone understands. Transactions in mysql and SELECT FOR UPDATE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On duty, I sometimes have to hold interviews for the position "[senior | junior] developer python / django", "team leader". To my great surprise, I fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As it turned out, everyone knows, but not everyone understands. Transactions in mysql and SELECT FOR UPDATE</h1><div class="post__text post__text-html js-mediator-article">  On duty, I sometimes have to hold interviews for the position "[senior | junior] developer python / django", "team leader".  To my great surprise, I found out that 9 out of 10 applicants, in whose summaries the words "Mysql / Innodb / transactions / triggers / stored proc etc." appear, can tell absolutely nothing about their past experience of working with them.  Unfortunately, I never received a single description of the use case. <br><a name="habracut"></a><br>  Further on the interview I suggested to try to suggest a solution for the following situation: <br><br>  Suppose we are an online service that in turn uses some kind of external paid API (service activation, paid content, or whatever your heart desires), that is, our service pays money for using the API itself.  A user in our system creates a request to activate the service, fills in all the fields and presses the ‚ÄúActivate service‚Äù button on the last page.  That is, at the time of sending the HTTP request, we have an entry in our database (a request to activate the service).  What is our algorithm? - I ask myself continue: <br><br>  - we get user balance from the base; <br>  - if the balance is enough, then we pull the API; <br>  - if everything is good, then we deduct the amount for the service from the balance, we do UPDATE, commit, otherwise we roll back; <br>  - we respond to the user. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It seems to be trivial, but when I cite the first and most obvious problem in the form of 10 competitive requests (that they all get the same balance at the beginning and start calling the API), solutions start to offer the most sophisticated ones, starting from the execution of 5 selections (I have to admit I did not understand anything in this version), the use of auto-increment counters, external caches, new tables in database, slips, and still don‚Äôt understand what. <br><br>  As you know (and all the candidates knew it!), Innodb in mysql provides a transactional mechanism and the possibility of line-by-line blocking.  In order to apply this most line-wise lock, it is enough to add a FOR UPDATE statement to the end of the SELECT, for example: <br><br>  SELECT * FROM requests WHERE id = 5 FOR UPDATE <br><br>  A transaction will start and all other sessions to the database will not be able to perform a similar request until the completion of our transaction, they will just wait.  For reading, the same record will be available in a state that depends on the isolation level of the transaction. <br><br>  It is also worth noting that the use of FOR UPDATE is best done with autocommit turned off, since regardless of what you have done, the lock will be removed after the first update. <br><br>  It seems a trifle, it seems obvious, but 9 out of 10 ... <br><br>  upd <br>  the former name ‚ÄúTransactions in mysql‚Äù, not disclosed in the article was replaced by ‚ÄúTransactions in mysql and SELECT FOR UPDATE‚Äù <br><br>  PS <br>  The article does not say that the API should be pulled within the framework of a transaction and what to do in the event of a failure and how to handle exceptions. </div><p>Source: <a href="https://habr.com/ru/post/238119/">https://habr.com/ru/post/238119/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238107/index.html">Transition from an approximate solution to an exact one: the problem of splitting a square into 50 similar acute-angled triangles</a></li>
<li><a href="../238109/index.html">Monitoring the availability of servers from Infobox</a></li>
<li><a href="../238113/index.html">The problems of high-frequency trading are deeper than it seems</a></li>
<li><a href="../238115/index.html">Seven A / B tests, without which not a single good email newsletter can do</a></li>
<li><a href="../238117/index.html">uLogin, as a means of cheating customers likes</a></li>
<li><a href="../238121/index.html">Windows Identity Foundation - for ASP.NET MVC projects</a></li>
<li><a href="../238123/index.html">Do it yourself! Kite Aerial Kite Aerial Photography</a></li>
<li><a href="../238125/index.html">The Martian orbital satellites MAVEN and Mangalyaan transmitted the first photos of Mars</a></li>
<li><a href="../238127/index.html">Controlled Internet: is the devil so scary how it is painted?</a></li>
<li><a href="../238129/index.html">Analysis of existing approaches to face recognition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>