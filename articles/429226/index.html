<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic pricing, or How Yandex.Taxi predicts high demand</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Previously, to call a taxi, you had to call to different numbers of dispatching services and wait for the car to go half an hour or more. Taxi service...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic pricing, or How Yandex.Taxi predicts high demand</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/6p/yq/tr/6pyqtrc3l2zveuaglelsme4xphg.png"><br><br>  Previously, to call a taxi, you had to call to different numbers of dispatching services and wait for the car to go half an hour or more.  Taxi services are now well automated, and the average car delivery time for Yandex.Taxi in Moscow is about 3-4 minutes.  But it is necessary to go to the rain or end a mass event, and again we may face a shortage of free cars. <br><br>  My name is Anton Skokurev, I lead a platform efficiency development team at Yandex.Taxi.  Today I will tell Habr's readers how we have learned how to predict high demand and additionally attract drivers so that users can find a free car at any time.  You will learn how to form a coefficient that affects the cost of the order.  Everything is far from being as simple as it may seem at first glance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h3>  Dynamic pricing task </h3><br>  The most important task of dynamic pricing is to provide the ability to book a taxi at all times.  It is achieved by using the surge pricing coefficient, which is calculated by the calculated price.  We call him simply "Surge."  It is important to say that Surge not only regulates the demand for taxis, but also helps attract new drivers to increase supply. <br><br>  If you set Surge too large - we will reduce the demand too much, there will be an excess of free cars.  If set too low, users will see ‚Äúno free machines‚Äù.  We must be able to choose the coefficient at which we will walk on thin ice between the lack of free cars and low demand. <br><br>  What should this coefficient depend on?  Immediately comes to mind the dependence on the number of machines and orders around the user.  Now you can simply divide the number of orders by the number of drivers, get the coefficient and turn it into our Suj by some formula (possibly linear). <br><br>  But there is a small problem in this task - it may be too late to count orders around the user.  After all, an order is almost always an already occupied car, which means that an increase in our coefficient will always be delayed.  Therefore, we consider not created orders, but <b>intentions to</b> order a car - pins.  Pin - this is the mark "A" on the map, which puts the user launching our application. <br><br><img src="https://habrastorage.org/webt/8t/du/0a/8tdu0aql7pjzmgqgqerbnso7zuw.png"><br><br>  We formulate the problem: we need to consider the <b>instantaneous</b> values ‚Äã‚Äãof the machines and pins at some point of the user. <br><br><h3>  We count the number of pins and cars around </h3><br>  When a pin's position changes (the user chooses point ‚ÄúA‚Äù), the user application sends new coordinates to the backend and a small sheet of additional information that helps to estimate the pin more accurately (for example, the selected rate). <br><br>  We try to adhere to microservice architecture, where each microservice is engaged in separate tasks.  Surge is engaged in counting Surja.  It registers pins, saves them to the database, and also updates the cast of pins in the RAM, in which they fit quite well.  Cache lag in such work is only a few seconds, which is acceptable in our case. <br><br><div class="spoiler">  <b class="spoiler_title">A few words about the database</b> <div class="spoiler_text">  When registering, each pin is asynchronously added to the MongoDb with the <a href="https://docs.mongodb.com/manual/core/capped-collections/">TTL Index</a> , where TTL is the ‚Äúlifetime‚Äù of the pin, at which we consider it active to calculate the multiplying factor.  The user does not wait until we perform these actions.  Even if something goes wrong, losing a pin is not such a big tragedy. <br><br><img src="https://habrastorage.org/webt/7g/u0/f6/7gu0f6uercnenpw3c4h2xyu4tls.jpeg"><br></div></div><br>  Hot cache is built with an index on <a href="https://en.wikipedia.org/wiki/Geohash">geohashu</a> .  We group all pins by geohash, and then collect pins for the desired radius around the order point. <br><br>  We do the same with cars, but in another service called Tracker, which Surger just goes with the question ‚Äúhow many drivers are in this radius‚Äù. <br><br>  So we consider the instantaneous values ‚Äã‚Äãof the coefficient. <br><br><img src="https://habrastorage.org/webt/mi/r7/y7/mir7y77n8i0b_dh8-w9vaxtex9k.jpeg"><br><br><h3>  Caching </h3><br>  <b>Case</b> : you are standing in Moscow on the Garden Ring and want to order a car.  In this case, the price jumps often enough and it is annoying. <br><br>  Already knowing the mechanics, it can be understood that this may be due to the fact that drivers accumulate at the conditional traffic lights at the time of the request of Surge and also quickly leave from there.  Because of this, the Surge and price can jump. <br><br>  To avoid this, we cache the value of Surge by users.  When a user comes for a Surge, we are looking at whether there is a saved value for the user in the allowed radius (a linear walk through all the saved Surges of the user).  If there is, we give it away, otherwise we count the new one and also save it. <br><br>  It worked well, but there are other situations. <br><br>  <b>Case</b> : 2 users request Surge.  One orders 30 seconds after the other, when the cars from the traffic light from the past case have already left.  We get a picture where 2 users ordering almost simultaneously can have a markedly different Surge. <br><br>  And here we go from the cache by user to cache by position.  Now, instead of caching the value of surdzh only by the user, we begin to cache it on the already familiar geohash.  So we almost fix the problem.  Why almost?  Because there may be differences on the boundaries of geocaches.  But the problem is not so significant, because we have anti-aliasing. <br><br><h3>  Smoothing </h3><br>  Perhaps, reading a case about a traffic light, the thought occurred to you that it was somehow unfair to count an instant Surge depending on the traffic light.  We also think so, so we figured out how to remedy the situation. <br><br>  We decided to borrow from the machine learning <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_k-%25D0%25B1%25D0%25BB%25D0%25B8%25D0%25B6%25D0%25B0%25D0%25B9%25D1%2588%25D0%25B8%25D1%2585_%25D1%2581%25D0%25BE%25D1%2581%25D0%25B5%25D0%25B4%25D0%25B5%25D0%25B9">method of the nearest neighbors</a> for the regression problem in order to determine how much the value of the instant Surge differs from what is happening around. <br><br>  The learning stage, as in the formal description of the method, consists in memorizing all the objects ‚Äî in our case, the calculated values ‚Äã‚Äãof the Surge in the pin, we are already doing all this at the moment of loading all the pins into the cache.  Things are going to be small - to calculate the instantaneous value, compare it with the value in the zone and agree that we cannot deviate from the value in the zone too much. <br><br>  So we get a system with a quick response to events and allowing you to quickly read the value of the multiplying factor. <br><br><h3>  Surdz driver's card </h3><br>  In order to communicate with the driver, we need to be able to display the Surge map in the driver's application - a taximeter.  This gives the driver feedback on whether there is demand in the zone where he is now and where he should go to get the most expensive orders.  For us, this means that more drivers will arrive in a zone with high demand and settle it. <br><br><img src="https://habrastorage.org/webt/q8/89/m-/q889m-nye_deix_n6i5tqkbnoba.png"><br><br>  We live with the paradigm that the driver device is a rather weak device.  Therefore, the rendering of the Surdzh hexagonal grid lies on the side of the backend.  The client comes to the backend for the tiles.  These are cut raster images for direct display on the map. <br><br>  We have a separate service that periodically collects the casts of the Surger microservice pins and calculates all the meta information needed to render the hexagonal grid: where is the hex and what is the Surge in each. <br><br><h3>  Conclusion </h3><br>  Dynamic pricing is a constant search for a balance between supply and demand, so that free cars are always available to users, including through the mechanism of attracting additional drivers to areas with high demand.  For example, we are currently working on a deeper use of machine learning for calculating surdzh.  As part of one of the tasks in this area, we are learning how to determine the probability of pin conversion to an order and take this information into account.  There is plenty of work here, so we are always glad to see <a href="https://ya.cc/4Zfs7">new specialists</a> in the team. <br><br>  If you are interested in learning about some part of this large topic in more detail, please write in the comments.  Feedback and ideas are welcome too! <br><br>  PS In the next <a href="https://habr.com/company/yandex/blog/431196/">post,</a> my colleague will talk about the use of machine learning to predict the expected time of arrival of a taxi. </div><p>Source: <a href="https://habr.com/ru/post/429226/">https://habr.com/ru/post/429226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429216/index.html">Google Play sales check - is it worth worrying?</a></li>
<li><a href="../429218/index.html">Julia and partial differential equations</a></li>
<li><a href="../429220/index.html">FSIN against the laws of physics or bees against honey</a></li>
<li><a href="../429222/index.html">The State Duma will return the bill on large user data for revision</a></li>
<li><a href="../429224/index.html">Dark web form patterns or what the most conversion form would be</a></li>
<li><a href="../429228/index.html">PMP. Exam. What is worth considering and why it is needed</a></li>
<li><a href="../429230/index.html">Report: Epson projectors at Integrated Systems Russia 2018</a></li>
<li><a href="../429232/index.html">Career steroids. Dogs</a></li>
<li><a href="../429234/index.html">Creating a game "Like coins" on Godot Engine. Part 1</a></li>
<li><a href="../429236/index.html">How many Data Scientists do you need to twist the light bulb (or which team will force the data to work on the business)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>