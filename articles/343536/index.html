<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unnatural diagnostics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dealing with the end-user program crashes is important, but rather difficult. There is usually no access to the client‚Äôs car; if there is access, then...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unnatural diagnostics</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/uc/m_/c5/ucm_c5rk6ktv-h0seunvupyf7_y.jpeg"></div><br>  Dealing with the end-user program crashes is important, but rather difficult.  There is usually no access to the client‚Äôs car;  if there is access, then there is no debugger;  when there is a debugger, it turns out that the problem is not reproduced, etc.  What to do when there is not even an opportunity to build a special version of the application and install it to the client?  Then welcome under the cat! <br><a name="habracut"></a><br>  So, in terms of <a href="https://ru.wikibooks.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F_%25D1%2580%25D0%25B5%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F_%25D0%25B8%25D0%25B7%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B5%25D1%2582%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D1%2581%25D0%25BA%25D0%25B8%25D1%2585_%25D0%25B7%25D0%25B0%25D0%25B4%25D0%25B0%25D1%2587">TRIZ,</a> we have a technical contradiction: we need to change the program so that it writes logs / sends crash reports, but there is no possibility to change the program.  Specify, there is no possibility to change it naturally, add the necessary functionality, rebuild and install the client.  Therefore, we, following the precepts of the <a href="http://lurkmore.to/%25D0%25A2%25D0%25B5%25D1%2580%25D0%25BC%25D0%25BE%25D1%2580%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580">gore</a> guru of <a href="http://lurkmore.to/%25D0%25A2%25D0%25B5%25D1%2580%25D0%25BC%25D0%25BE%25D1%2580%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D1%2580%25D0%25B8%25D0%25BF%25D1%2582%25D0%25BE%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580">cryptanalysis</a> , will change it in an unnatural way! <br><br>  We integrate <a href="https://habrahabr.ru/company/devexpress/blog/342620/">our crash reporter</a> into the program, including for such complex cases and wrote.  Of course, no one bothers to use the following approaches to introduce another code into the program, which was not originally intended by the developers. <br><br>  So, we need the <b>managed</b> application itself, in some ‚Äúmagic way‚Äù, to load the necessary assemblies and execute the initialization code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs">LogifyAlert client = LogifyAlert.Instance; client.ApiKey = <span class="hljs-string"><span class="hljs-string">"my-api-key"</span></span>; client.StartExceptionsHandling();</code> </pre> <br>  Well, we drove. <br><br>  The ‚Äúmagic‚Äù technology we need, exists and is called <a href="https://en.wikipedia.org/wiki/DLL_injection">DLL injection</a> , and will be the loader that launches the application (or attaches to an already running one) and injects the DLL we need into the application process. <br><br>  It looks like this <br><br><div class="spoiler">  <b class="spoiler_title">Interop Pack</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kernel32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwDesiredAccess, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bInheritHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwProcessId</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, CharSet = CharSet.Auto)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetModuleHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpModuleName</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32"</span></span>, CharSet = CharSet.Ansi, ExactSpelling = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProcAddress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hModule, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> procName</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, ExactSpelling = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VirtualAllocEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpAddress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwSize, AllocationType flAllocationType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flProtect</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, ExactSpelling = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VirtualFreeEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpAddress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwSize, AllocationType dwFreeType</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteProcessMemory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpBaseAddress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] lpBuffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nSize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UIntPtr lpNumberOfBytesWritten</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRemoteThread</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpThreadAttributes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwCreationFlags, IntPtr lpThreadId</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> UInt32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForSingleObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hHandle, UInt32 dwMilliseconds</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] [SuppressUnmanagedCodeSecurity] [<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>: MarshalAs(UnmanagedType.Bool)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CloseHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hObject</span></span></span><span class="hljs-function">)</span></span>; [Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> AllocationType { ReadWrite = <span class="hljs-number"><span class="hljs-number">0x0004</span></span>, Commit = <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, Reserve = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>, Decommit = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>, Release = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>, Reset = <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, Physical = <span class="hljs-number"><span class="hljs-number">0x400000</span></span>, TopDown = <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, WriteWatch = <span class="hljs-number"><span class="hljs-number">0x200000</span></span>, LargePages = <span class="hljs-number"><span class="hljs-number">0x20000000</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> PAGE_READWRITE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UInt32 INFINITE = <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF</span></span>;</code> </pre> <br></div></div><br>  We get access to the application process by the process identifier (PID), and we implement the DLL in it: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> access = PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ; IntPtr procHandle = OpenProcess(access, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, dwProcessId); InjectDll(procHandle, BootstrapDllPath);</code> </pre> <br>  If we ourselves have launched a child process, then for this, even administrator rights will not be needed.  If attacked, you will have to attend to the rights: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Process </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttachToTargetProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RunnerParameters parameters</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!String.IsNullOrEmpty(parameters.TargetProcessCommandLine)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StartTargetProcess(parameters.TargetProcessCommandLine, parameters.TargetProcessArgs); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameters.Pid != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Process.EnterDebugMode(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Process.GetProcessById(parameters.Pid); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  And in the application manifest: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestedExecutionLevel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">level</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"requireAdministrator"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uiAccess</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Next, find out the address of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibraryW</a> function and call it in another process, indicating the name of the DLL that needs to be loaded.  We get the address of the function in our process, and we make the call to the address in someone else‚Äôs.  This rolls, since the library kernel32.dll has the same base address in all processes.  Even if this once changes (which is unlikely), then we will show how to solve the problem in the case of different base addresses. <br><br><div class="spoiler">  <b class="spoiler_title">InjectDll and MakeRemoteCall Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectDll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr procHandle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dllName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> libName = <span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> procName = <span class="hljs-string"><span class="hljs-string">"LoadLibraryW"</span></span>; IntPtr loadLibraryAddr = GetProcAddress(GetModuleHandle(libName), procName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loadLibraryAddr == IntPtr.Zero) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MakeRemoteCall(procHandle, loadLibraryAddr, dllName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeRemoteCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr procHandle, IntPtr methodAddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argument</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> textSize = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)Encoding.Unicode.GetByteCount(argument); <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> allocSize = textSize + <span class="hljs-number"><span class="hljs-number">2</span></span>; IntPtr allocMemAddress; AllocationType allocType = AllocationType.Commit | AllocationType.Reserve; allocMemAddress = VirtualAllocEx(procHandle, IntPtr.Zero, allocSize, allocType, PAGE_READWRITE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (allocMemAddress == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; UIntPtr bytesWritten; WriteProcessMemory(procHandle, allocMemAddress, Encoding.Unicode.GetBytes(argument), textSize, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> bytesWritten); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isOk = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IntPtr threadHandle; threadHandle = CreateRemoteThread(procHandle, IntPtr.Zero, <span class="hljs-number"><span class="hljs-number">0</span></span>, methodAddr, allocMemAddress, <span class="hljs-number"><span class="hljs-number">0</span></span>, IntPtr.Zero); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (threadHandle != IntPtr.Zero) { WaitForSingleObject(threadHandle, Win32.INFINITE); isOk = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } VirtualFreeEx(procHandle, allocMemAddress, allocSize, AllocationType.Release); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (threadHandle != IntPtr.Zero) Win32.CloseHandle(threadHandle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isOk; }</code> </pre> <br>  What kind of tin is written here?  We need to pass a string parameter to the call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibraryW</a> in another process.  For this, the line must be written to the address space of another process, which <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366887(v%3Dvs.85).aspx">VirtualAlloc</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v%3Dvs.85).aspx">WriteProcessMemory are doing</a> .  Next, create a thread in another process, an address, that executes <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibraryW</a> with the parameter we just wrote.  We wait for the thread to complete and clean the memory. <br><br></div></div><br>  But, unfortunately, the technology is applicable only for ordinary DLLs, and we have managed assemblies.  Repin's painting "Sailed"! <br><br>  The fact is that a managed assembly does not have an entry point, an analogue of <a href="https://msdn.microsoft.com/en-US/library/windows/desktop/ms682583(v%3Dvs.85).aspx">DllMain</a> , so even if we inject it into the process as a regular DLL, the assembly will not be able to automatically get control. <br><br>  Is it possible to transfer control manually?  Theoretically, there are 2 ways: use the <a href="https://blogs.msdn.microsoft.com/junfeng/2005/11/19/module-initializer-a-k-a-module-constructor/">module initializer</a> , or export the function from the managed build and call it.  I‚Äôll say right away that neither can be done using standard C # tools.  The initializer of the module can be screwed, for example, with the help of <a href="https://www.nuget.org/packages/ModuleInit.Fody/">ModuleInit.Fody</a> , but the trouble is that the initializer of the module itself will not be executed, you must first refer to some type in the assembly.  As the cat Matroskin used to say: ‚ÄúTo sell something unnecessary, you must first buy something unnecessary, but we have no money!‚Äù <br><br>  For exports, theoretically, there is <a href="https://www.nuget.org/packages/UnmanagedExports">UnmanagedExports</a> , but I didn‚Äôt get it to the meeting, and I‚Äôve need to collect 2 differently-chopped versions of the <b>managed</b> assembly (AnyCPU is not supported), it pushed me away. <br><br>  It seems that nothing shines in this direction.  <s>And if the tape wrap?</s>  And if you implement the unmanaged DLL process, and then try to call the managed assembly from it? <br><br><div class="spoiler">  <b class="spoiler_title">It turns out you can</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectDotNetAssembly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* [in] */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LPCWSTR pwzAssemblyPath, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* [in] */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LPCWSTR pwzTypeName, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* [in] */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LPCWSTR pwzMethodName, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* [in] */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> LPCWSTR pwzArgument )</span></span></span><span class="hljs-function"> </span></span>{ HRESULT result; ICLRMetaHost *metaHost = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ICLRRuntimeInfo *runtimeInfo = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ICLRRuntimeHost *runtimeHost = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Load .NET result = CLRCreateInstance(CLSID_CLRMetaHost, IID_PPV_ARGS(&amp;metaHost)); result = metaHost-&gt;GetRuntime(L"v4.0.30319", IID_PPV_ARGS(&amp;runtimeInfo)); result = runtimeInfo-&gt;GetInterface(CLSID_CLRRuntimeHost, IID_PPV_ARGS(&amp;runtimeHost)); result = runtimeHost-&gt;Start(); // Execute managed assembly DWORD returnValue; result = runtimeHost-&gt;ExecuteInDefaultAppDomain( pwzAssemblyPath, pwzTypeName, pwzMethodName, pwzArgument, &amp;returnValue); if (metaHost != NULL) metaHost-&gt;Release(); if (runtimeInfo != NULL) runtimeInfo-&gt;Release(); if (runtimeHost != NULL) runtimeHost-&gt;Release(); return result; }</span></span></code> </pre><br></div></div><br>  It looks not so scary, and it seems like it promises to even make a call in the AppDomain by default.  It is not clear, however, in which thread, but thanks to that. <br><br>  Now we need to call this code from our bootloader. <br><br>  Let us use the assumption that the offset of the function address from the address to which the DLL is loaded is a constant value for any process. <br><br>  We load the necessary DLL into the process itself with the help of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibrary</a> , we get the base address.  Find the address of the function being called via <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683212(v%3Dvs.85).aspx">GetProcAddress</a> . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMethodOffset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dllPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> methodName</span></span></span><span class="hljs-function">)</span></span> { IntPtr hLib = Win32.LoadLibrary(dllPath); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hLib == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; IntPtr call = Win32.GetProcAddress(hLib, methodName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (call == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> result = call.ToInt64() - hLib.ToInt64(); Win32.FreeLibrary(hLib); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  There is the last piece of the puzzle, find the base address of the DLL in another process: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRemoteModuleHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Process process, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> moduleName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = process.Modules.Count; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { ProcessModule module = process.Modules[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (module.ModuleName == moduleName) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)module.BaseAddress; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  And, finally, we get the address of the desired function in another process. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> offset = GetMethodOffset(BootstrapDllPath, <span class="hljs-string"><span class="hljs-string">"InjectManagedAssembly"</span></span>); InjectDll(procHandle, BootstrapDllPath); <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> baseAddr = GetRemoteModuleHandle(process, Path.GetFileName(BootstrapDllPath)); IntPtr remoteAddress = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(baseAddr + (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)offset));</code> </pre> <br>  Make a call to the received address, just as we called <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684175(v%3Dvs.85).aspx">LoadLibrary</a> in another process, via MakeRemoteCall (see above) <br><br>  It is inconvenient that we can only transfer one line, and to call the managed assembly, you need to need as many as 4. In order not to reinvent the wheel, we will form the line as a command line, and on the unmanaged side without noise and dust we will use the system function <a href="https://msdn.microsoft.com/en-US/library/windows/desktop/bb776391(v%3Dvs.85).aspx">CommandLineToArgvW</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InjectManagedAssemblyCore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_In_ LPCWSTR lpCommand)</span></span></span><span class="hljs-function"> </span></span>{ LPWSTR *szArgList; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argCount; szArgList = CommandLineToArgvW(lpCommand, &amp;argCount); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (szArgList == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || argCount &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> E_FAIL; LPCWSTR param; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argCount &gt;= <span class="hljs-number"><span class="hljs-number">4</span></span>) param = szArgList[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> param = <span class="hljs-string"><span class="hljs-string">L""</span></span>; HRESULT result = InjectDotNetAssembly( szArgList[<span class="hljs-number"><span class="hljs-number">0</span></span>], szArgList[<span class="hljs-number"><span class="hljs-number">1</span></span>], szArgList[<span class="hljs-number"><span class="hljs-number">2</span></span>], param ); LocalFree(szArgList); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Note also that the recalculation of the offset function implicitly assumes that the bitness of the loader processes and the target application is strictly the same.  Those.  we are not going anywhere, and we will have to do both 2 boot loader options (32 and 64 bits) and 2 unmanaged DLL options (simply because <a href="https://msdn.microsoft.com/en-US/library/windows/desktop/aa384231(v%3Dvs.85).aspx">only the correct bitness DLL can be loaded</a> into the process). <br><br>  Therefore, when working under 64-bit OS, we add a check for the coincidence of the bitness of the processes.  Own process: <br><br><pre> <code class="cs hljs">Environment.Is64BitProcess</code> </pre> <br>  Alien process: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kernel32.dll"</span></span></span><span class="hljs-meta">, CallingConvention = CallingConvention.Winapi)</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>: MarshalAs(UnmanagedType.Bool)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsWow64Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[In] IntPtr process, [Out] </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> wow64Process</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Is64BitProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Process process</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isWow64; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsWow64Process(process.Handle, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> isWow64)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !isWow64; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsCompatibleProcess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Process process</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Environment.Is64BitOperatingSystem) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is64bitProcess = Is64BitProcess(process); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Environment.Is64BitProcess == is64bitProcess; }</code> </pre> <br>  We make managed assembly, with MessageBox display: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunWinForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { InitLogifyWinForms(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitLogifyWinForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"InitLogifyWinForms"</span></span>); }</code> </pre> <br>  We check, everything is called, MessageBox is shown.  HOORAY! <br><br><img src="https://habrastorage.org/webt/eh/1j/bp/eh1jbpzxx4sy2ywyh_8a5q1qqco.png"><br><br>  Replace MessageBox with a test initialization of a crash reporter: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitLogifyWinForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LogifyAlert client = LogifyAlert.Instance; client.ApiKey = <span class="hljs-string"><span class="hljs-string">"my-api-key"</span></span>; client.StartExceptionsHandling(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { } }</code> </pre> <br>  We write a test WinForms application that causes an exception when a button is pressed. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button2_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> o = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; o.ToString(); }</code> </pre><br>  It seems to be all.  We start, we check ... And silence.  <s>And along the road, dead with braids stand.</s> <br><br>  We insert the crash-reporter code directly into the test application, add references. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitLogifyWinForms(); Application.EnableVisualStyles(); Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); Application.Run(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Form1()); }</code> </pre><br>  We check - it works, it means that the case is not in the initialization code.  Maybe something is wrong with thread?  Change: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Thread thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(InitLogifyWinForms); thread.Start(); Application.EnableVisualStyles(); Application.SetCompatibleTextRenderingDefault(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); Application.Run(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Form1()); }</code> </pre><br>  Check, works again.  What is wrong ?!  I have no answer to this question.  Can someone else shed light on the reasons for this behavior of the <a href="https://msdn.microsoft.com/en-US/library/system.appdomain.unhandledexception(v%3Dvs.110).aspx">AppDomain.UnhandledException</a> event.  Nevertheless, I found a workaround.  We are waiting for the appearance of at least one window in the application and do <a href="https://msdn.microsoft.com/en-us/library/a06c0dc2(v%3Dvs.110).aspx">BeginInvoke</a> through the message queue of this window: <br><br><div class="spoiler">  <b class="spoiler_title">Workaround, 18+</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunWinForms</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isOk = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> totalTimeout = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> smallTimeout = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = totalTimeout / smallTimeout; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Application.OpenForms == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || Application.OpenForms.Count &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) Thread.Sleep(smallTimeout); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Delegate call = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvokeDelegate(InitLogifyWinForms); Application.OpenForms[<span class="hljs-number"><span class="hljs-number">0</span></span>].BeginInvoke(call); isOk = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isOk) { InitLogifyWinForms(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } }</code> </pre><br></div></div><br><br>  And, about a miracle, it was got.  We note a serious disadvantage: for console applications it is inoperable. <br><br>  It remains to bring up the brilliance, and teach the crash reporter to be configured from its own config-file.  It turns out to do realistically, albeit unusually surprising: <br><br><pre> <code class="cs hljs">ExeConfigurationFileMap map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExeConfigurationFileMap(); map.ExeConfigFilename = configFileName; Configuration config = ConfigurationManager.OpenMappedExeConfiguration(map, ConfigurationUserLevel.None);</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">We write a config</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logifyAlert"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DevExpress.Logify.LogifyConfigSection, Logify.Alert.Win"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logifyAlert</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">collectBreadcrumbs</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">breadcrumbsMaxCount</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">apiKey</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"my-api-key"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">confirmSend</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offlineReportsEnabled</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offlineReportsDirectory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"offlineReports"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offlineReportsCount</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logifyAlert</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br>  Put it next to the exe-shnik application.  Run, check, oops. <br><br><img src="https://habrastorage.org/webt/zu/xx/ic/zuxxicohnyt3zqfmgbucapnlsfc.png"><br><br>  Which one  The necessary assembly is already loaded into the process, but for some reason rantaym decided to look for it in a new way.  We try to use the full name of the assembly, with the same success. <br><br>  Frankly speaking, I didn‚Äôt investigate the reasons for this (IMHO, not quite logical) behavior.  There are 2 ways to get around the problem: subscribe to <a href="https://msdn.microsoft.com/en-us/library/system.appdomain.assemblyresolve(v%3Dvs.110).aspx">AppDomain.AssemblyResolve</a> and show the system where the desired assembly is located;  or simply and simply copy the necessary assemblies into the directory with the exe-schnick.  Mindful of the AppDomain.UnhandledException rake with strange behavior, I did not take risks and copied the assemblies. <br><br>  Rebuild, try.  Successfully configured and sends a crash report. <br><br><img src="https://habrastorage.org/webt/i4/mu/xs/i4muxs3sicd5cqeisjwkca6ybak.png"><br><br>  Further routine, we attach the CLI-interface to the loader and in general we comb the project. <br><br><div class="spoiler">  <b class="spoiler_title">CLI</b> <div class="spoiler_text"> <code>LogifyRunner (C) 2017 DevExpress Inc. <br> <br> Usage: <br> <br> LogifyRunner.exe [--win] [--wpf] [--pid=value&gt;] [--exec=value1, ...] <br> <br> --win Target process is WinForms application <br> --wpf Target process is WPF application <br> --pid Target process ID. Runner will be attached to process with specified ID. <br> --exec Target process command line <br> <br> NOTE: logify.config file should be placed to the same directory where the target process executable or LogifyRunner.exe is located. <br> Read more about config file format at: https://github.com/DevExpress/Logify.Alert.Clients/tree/develop/dotnet/Logify.Alert.Win#configuration <br></code> <br></div></div><br>  Now we have in the arsenal of a tech support specialist a simple and oak tool that allows you to get a crash report of the application (as well as <a href="https://habrahabr.ru/company/devexpress/blog/342530/">user actions</a> that precede the fall), in which the crash reporter was not built in initially. <br><br>  <b>PS:</b> <br><br>  Sources on <a href="https://github.com/DevExpress/Logify.Alert.Clients/tree/develop/dotnet/Logify.Alert.Inject">github</a> . <br>  If anyone is interested, <a href="https://logify.devexpress.com/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">the</a> project <a href="https://logify.devexpress.com/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">site</a> and <a href="https://logify.devexpress.com/Alert/Documentation/%3Futm_source%3Dpublication_breadcrumbs%26utm_campaign%3Dblog">documentation</a> .  Also introductory <a href="https://habrahabr.ru/company/devexpress/blog/342620/">article</a> about Logify here, on Habr√©. </div><p>Source: <a href="https://habr.com/ru/post/343536/">https://habr.com/ru/post/343536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343524/index.html">Network JTAG programmer for Altera Quartus Prime from Raspberry Pi3</a></li>
<li><a href="../343526/index.html">Two geometric tasks that came across at the interview, and where they live</a></li>
<li><a href="../343530/index.html">Development for Sailfish OS: Using Sensors (Part 2)</a></li>
<li><a href="../343532/index.html">Mikrotik: Download speed limit for certain IP addresses</a></li>
<li><a href="../343534/index.html">Analysis of the quest Digital Security ICO</a></li>
<li><a href="../343538/index.html">Serverless tensorflow on AWS Lambda</a></li>
<li><a href="../343540/index.html">Google Taxes have been changed</a></li>
<li><a href="../343542/index.html">Event digest for HR specialists in the IT field for December 2017</a></li>
<li><a href="../343544/index.html">How I applied the cohort analysis while participating in a weight loss competition</a></li>
<li><a href="../343548/index.html">Infect for the good: how do we execute the spurious code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>