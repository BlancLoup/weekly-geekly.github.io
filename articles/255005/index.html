<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quaternion rotation notes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Publication structure 


- Obtaining a quaternion from the vector and magnitude of the turning angle 
- Reverse Quaternion 
- Quaternion multiplicatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quaternion rotation notes</h1><div class="post__text post__text-html js-mediator-article"><h4>  Publication structure </h4><br><ul><li>  Obtaining a quaternion from the vector and magnitude of the turning angle </li><li>  Reverse Quaternion </li><li>  Quaternion multiplication </li><li>  Rotate vector </li><li>  Yaw, pitch, roll </li><li>  A series of turns </li></ul><br><br><h4>  Obtaining a quaternion from the vector and magnitude of the turning angle </h4><br>  Once again - what is <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B8%25D0%25BE%25D0%25BD">quaternion</a> ?  For the developer, this is primarily a tool that describes an action - a turn around the axis at a given angle: <br><br>  (w, vx, vy, vz), 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      where v is the axis expressed by the vector; <br>  w is a component describing rotation (cosine of half the angle). <br><a name="habracut"></a><br>  A positive value of the pivot angle means turning clockwise along the vector, when viewed from the end of the vector to its beginning. <br><br>  For example, the quaternion of rotation along the X axis by 90 degrees has the following values ‚Äã‚Äãof its components: w = 0.7071;  x = 0.7071;  y = 0;  z = 0. The left or right coordinate system, there is no difference - the main thing is that all operations are performed in the same coordinate systems, either all to the left or all to the right. <br><br><img src="https://habrastorage.org/files/3e4/055/32a/3e405532a06d4695ade71ee48ee151e6.png"><br><br>  With the following code (Visual Basic was at hand), we can get a quaternion from a vector and a rotation angle around it: <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> create_quat(rotate_vector As TVector, rotate_angle As Double) As TQuat rotate_vector = normal(rotate_vector) create_quat.w = <span class="hljs-built_in"><span class="hljs-built_in">Cos</span></span>(rotate_angle / <span class="hljs-number"><span class="hljs-number">2</span></span>) create_quat.x = rotate_vector.x * <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(rotate_angle / <span class="hljs-number"><span class="hljs-number">2</span></span>) create_quat.y = rotate_vector.y * <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(rotate_angle / <span class="hljs-number"><span class="hljs-number">2</span></span>) create_quat.z = rotate_vector.z * <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(rotate_angle / <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre> <br>  In the code, rotate_vector is a vector that describes the axis of the turn, and rotate_angle is the angle of turn in radians.  The vector should be normalized.  That is, its length should be equal to 1. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> normal(v As TVector) As TVector <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> length As Double length = (vx ^ <span class="hljs-number"><span class="hljs-number">2</span></span> + vy ^ <span class="hljs-number"><span class="hljs-number">2</span></span> + vz ^ <span class="hljs-number"><span class="hljs-number">2</span></span>) ^ <span class="hljs-number"><span class="hljs-number">0.5</span></span> normal.x = vx / length normal.y = vy / length normal.z = vz / length <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre><br>  Do not forget about the situation when the length may be 0. Instead of an error, you may need to handle this situation individually. <br><br><h4>  Reverse Quaternion </h4><br>  To rotate the vector by the quaternion, it is required to be able to make a reverse reversal and correctly perform the multiplication operation of the quaternions.  By reverse reversal, I mean reverse quaternion, that is, the one that rotates in the opposite direction. <br><br>  To get the inverse quaternion from the given one, it is enough to turn the axis vector in the other direction and, if necessary, normalize the quaternion.  Normalizing a quaternion as well as in vectors, it is simply a reduction to length = 1. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_scale(q As TQuat, val As Double) As TQuat qw = qw * val <span class="hljs-comment"><span class="hljs-comment">' x qx = qx * val ' x qy = qy * val ' y qz = qz * val ' z quat_scale = q End Function Public Function quat_length(q As TQuat) As Double quat_length = (qw * qw + qx * qx + qy * qy + qz * qz) ^ 0.5 End Function Public Function quat_normalize(q As TQuat) As TQuat Dim n As Double n = quat_length(q) quat_normalize = quat_scale(q, 1 / n) End Function Public Function quat_invert(q As TQuat) As TQuat Dim res As TQuat res.w = qw res.x = -qx res.y = -qy res.z = -qz quat_invert = quat_normalize(res) End Function</span></span></code> </pre><br>  For example, if the turn around the Y axis is 90 degrees = (w = 0.707; x = 0; y = 0.707; z = 0), then the reverse = (w = 0.707; x = 0; y = -0.707; z = 0) .  It would seem that it is possible to invert only component W, but when turning 180 degrees, it is = 0. Quaternion, which means "no reversal" = (w = 1; x = 0; y = 0; z = 0), that is, it has axis vector length = 0. <br><br><h4>  Quaternion multiplication </h4><br>  Quaternion multiplication is an extremely useful thing.  The result of multiplication is a quaternion, which, after turning, gives the same result if you consistently perform reversals by the multiplied quaternions.  Moreover, the reversal will occur in the report system which is local for the rotated vector, i.e. the rotated vector of the rotated vector also moves. <br><br><img src="https://habrastorage.org/files/6db/f82/2e4/6dbf822e4d1d472ebee922885e0345f5.png"><img src="https://habrastorage.org/files/538/a94/cec/538a94cec0814c2eb5f6b4622074db56.png"><br><br>  Quaternion multiplication is performed as follows: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_mul_quat(a As TQuat, b As TQuat) As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> res As TQuat res.w = aw * bw - ax * bx - ay * by - az * bz res.x = aw * bx + ax * bw + ay * bz - az * by res.y = aw * by - ax * bz + ay * bw + az * bx res.z = aw * bz + ax * by - ay * bx + az * bw quat_mul_quat = res <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre><br>  In order to multiply a quaternion by a 3D vector, you need to transform a vector into a quaternion by assigning the component W = 0 and multiply the quaternion by a quaternion.  Or substitute zero and express it as a function: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_mul_vector(a As TQuat, b As TVector) As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> res As TQuat res.w = -ax * bx - ay * by - az * bz res.x = aw * bx + ay * bz - az * by res.y = aw * by - ax * bz + az * bx res.z = aw * bz + ax * by - ay * bx quat_mul_vector = res <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre><br><h4>  Rotate vector </h4><br>  Now, actually, the rotation of the vector by quaternion: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_transform_vector(q As TQuat, v As TVector) As TVector <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> t As TQuat t = quat_mul_vector(q, v) t = quat_mul_quat(t, quat_invert(q)) quat_transform_vector.x = tx quat_transform_vector.y = ty quat_transform_vector.z = tz <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre><br>  Example: <br><br>  The vector describing the axis (x = 1; y = 0; z = 1).  The angle of rotation is 180 degrees. <br>  The rotated vector (x = 0; y = 0; z = 1).  The result is (x = 1; y = 0; z = 0). <br><br><img src="https://habrastorage.org/files/c75/b1f/603/c75b1f6036464084b32c98f50d990d00.png"><br><br><h4>  Yaw, pitch, roll </h4><br>  Consider the quaternion formation tool with the help of turns around one of the axes: <br>  Yaw = heading = yaw = around the Z axis;  pitch = altitude = pitch = around the Y axis;  roll = bank = roll = around the x-axis. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_from_angles_rad(angles As TKrylov) As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> q_heading As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> q_alt As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> q_bank As TQuat <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> q_tmp As TQuat q_heading.x = <span class="hljs-number"><span class="hljs-number">0</span></span> q_heading.y = <span class="hljs-number"><span class="hljs-number">0</span></span> q_heading.z = <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(angles.heading / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_heading.w = <span class="hljs-built_in"><span class="hljs-built_in">Cos</span></span>(angles.heading / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_alt.x = <span class="hljs-number"><span class="hljs-number">0</span></span> q_alt.y = <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(angles.altitude / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_alt.z = <span class="hljs-number"><span class="hljs-number">0</span></span> q_alt.w = <span class="hljs-built_in"><span class="hljs-built_in">Cos</span></span>(angles.altitude / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_bank.x = <span class="hljs-built_in"><span class="hljs-built_in">Sin</span></span>(angles.bank / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_bank.y = <span class="hljs-number"><span class="hljs-number">0</span></span> q_bank.z = <span class="hljs-number"><span class="hljs-number">0</span></span> q_bank.w = <span class="hljs-built_in"><span class="hljs-built_in">Cos</span></span>(angles.bank / <span class="hljs-number"><span class="hljs-number">2</span></span>) q_tmp = quat_mul_quat(q_heading, q_alt) quat_from_angles_rad = quat_mul_quat(q_tmp, q_bank) <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span></code> </pre><br>  And in the opposite direction, from the quaternion: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> quat_to_krylov(q As TQuat) As TKrylov <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> qx2 As Double <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> qy2 As Double <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> qz2 As Double q = quat_normalize(q) <span class="hljs-comment"><span class="hljs-comment">'    qx2 = qx * qx qy2 = qy * qy qz2 = qz * qz quat_to_krylov_v3.bank = atan2(2 * (qx * qw + qy * qz), 1 - 2 * (qx2 + qy2)) quat_to_krylov_v3.altitude = Application.WorksheetFunction.Asin(2 * (qy * qw - qz * qx)) quat_to_krylov_v3.heading = atan2(2 * (qz * qw + qx * qy), 1 - 2 * (qy2 + qz2)) End Function</span></span></code> </pre><br>  The transformation formulas depend on the adopted coordinate system. <br><br><h4>  A series of turns </h4><br>  Consider an example: <br>  1. The first turn - yaw (around Z) 90 degrees clockwise; <br>  2. The second turn - pitch (around Y) 90 degrees clockwise; <br>  3. The third turn - roll (around X) 90 degrees clockwise. <br><br>  Figures depicting rotation and labeled as ‚Äúglobal‚Äù show rotations relative to fixed XYZ axes.  We will get this result if we use the quaternions of reversal separately.  The fourth figure shows where the vector will be if its initial coordinates were X = 1;  Y = 0;  Z = 0. <br><br>  Figures signed as ‚Äúlocal‚Äù demonstrate the rotation of the axes with the aircraft.  That is, all rotations occur relative to the pilot, and not relative to a fixed coordinate system.  The fourth figure shows where the same vector (1; 0; 0) will end up in all three turns.  We will get this result by multiplying the quaternions of the reversal and applying the resulting quaternion. <br><br><img src="https://habrastorage.org/files/016/307/2a3/0163072a38164ee5821310b871ca1d02.png"><img src="https://habrastorage.org/files/afc/59d/683/afc59d683feb4efba314b81f3e72a492.png"><br><br><img src="https://habrastorage.org/files/e5f/ef0/a64/e5fef0a644d6433b8334e1e3c7f804fd.png"><img src="https://habrastorage.org/files/a0f/dce/e8c/a0fdcee8ce074188b629a4e7ba7a6386.png"><br><br><img src="https://habrastorage.org/files/085/cc2/a97/085cc2a97dc745aa893700b61822af40.png"><img src="https://habrastorage.org/files/997/849/1e8/9978491e80ac4e15a25e1dd98215038e.png"><br><br><img src="https://habrastorage.org/files/bd1/278/001/bd1278001084462aaf553ab7be6d3d71.png"><img src="https://habrastorage.org/files/abf/c5c/9ac/abfc5c9ac38946babd5308982d4ed048.png"></div><p>Source: <a href="https://habr.com/ru/post/255005/">https://habr.com/ru/post/255005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254991/index.html">Digital archeology: how long-lost data is saved</a></li>
<li><a href="../254993/index.html">How we "married" cloud PBX, GSM and realtors (part 4)</a></li>
<li><a href="../254995/index.html">Resuscitation of TP-LINK 3020 router</a></li>
<li><a href="../255001/index.html">Difficult times for free-to-play, a little more about Apple Watch, console revenue - and other news of the week for a mobile developer</a></li>
<li><a href="../255003/index.html">MMAS ant algorithm</a></li>
<li><a href="../255007/index.html">In the wake of WinHEC (Hardware Engineering Conference) 2015 - Windows 10, IoT, AllJoyn, clouds, and more</a></li>
<li><a href="../255009/index.html">Self-assembly 3d-printer or purchase ready-made equipment for the design. 3d printing. Part 3</a></li>
<li><a href="../255011/index.html">Improving sound quality on Android tablets with Intel Atom processors using the Dolby Digital API</a></li>
<li><a href="../255013/index.html">Cloud services under high load. Cackle experience</a></li>
<li><a href="../255015/index.html">How to catch what is not. Part sad: what is an antivirus?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>