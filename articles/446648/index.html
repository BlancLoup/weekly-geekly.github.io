<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing Kubernetes operator with Operator Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As mentioned in the article Radar Technologies , Lamoda is actively moving in the direction of microservice architecture. Most of our services are pac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing Kubernetes operator with Operator Framework</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/352/5c8/f16/3525c8f16510afa2b61b0ff9b8434a02.png" alt="Image"></p><br><p>  As mentioned in the article <a href="https://habr.com/ru/company/lamoda/blog/428411/">Radar Technologies</a> , Lamoda is actively moving in the direction of microservice architecture.  Most of our services are packaged with <a href="https://github.com/helm/helm">Helm</a> and deployed to Kubernetes.  This approach fully satisfies our needs in 99% of cases.  Remains 1%, when the standard functionality Kubernetes is not enough, for example, when you need to configure a backup or update the service for a specific event.  To solve this problem, we use the pattern operator.  In this series of articles, I - Grigory Mikhalkin, the developer of the R &amp; D team at Lamoda - will talk about the lessons I learned from my experience of developing K8s operators using the <a href="https://github.com/operator-framework">Operator Framework</a> . </p><a name="habracut"></a><br><h2 id="chto-takoe-operator">  What is an operator? </h2><br><p>  One of the ways to expand the functionality of Kubernetes is to create your own controllers.  The main abstractions in Kubernetes are objects and controllers.  Objects describe the desired state of the cluster.  For example, <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> describes which containers need to be run and startup parameters, and the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a> object says how many replicas of this Pod should be launched.  The controllers manage the cluster state based on the description of the objects, as applied to the above case, the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/">ReplicationController</a> will maintain the number of Pod replicas specified in the ReplicaSet.  With the help of new controllers, you can implement additional logic such as sending notifications on events, recovering from a crash, or managing <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">third party resources</a> . </p><br><p>  Operator is a kubernetes application that includes one or more controllers serving the third party resource.  The concept <a href="https://coreos.com/blog/introducing-operators.html">came up with the CoreOS team</a> in 2016, and recently the popularity of operators has been growing rapidly.  You can try to find the desired operator in the <a href="https://kubedex.com/operators/">list on kubedex</a> , (more than 100 publicly available operators are listed here), as well as on <a href="https://operatorhub.io/">OperatorHub</a> .  To develop the operator now there are 3 popular tools: <a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder</a> , <a href="https://github.com/operator-framework/operator-sdk">Operator SDK</a> and <a href="https://github.com/GoogleCloudPlatform/metacontroller">Metacontroller</a> .  In Lamoda, we use Operator SDK, so we‚Äôll talk about it later. </p><br><h2 id="operator-sdk">  Operator SDK </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f7e/56d/194/f7e56d1948a2f5291ef189e7a03df9be.png" alt="Image"></p><br><p>  The Operator SDK is part of the Operator Framework, which includes two more important parts: Operator Lifecycle Manager and Operator Metering. </p><br><ul><li>  <a href="https://github.com/operator-framework/operator-sdk">Operator SDK</a> is a wrapper over a <a href="https://github.com/kubernetes-sigs/controller-runtime">controller-runtime</a> , a popular library for developing controllers (which, in turn, is a wrapper over a <a href="https://github.com/kubernetes/client-go">client-go</a> ), code generator + framework for writing E2E tests. </li><li>  <a href="https://github.com/operator-framework/operator-lifecycle-manager">Operator Lifecycle Manager</a> - a framework for managing already working operators;  resolves situations when an operator switches to zombie mode or rolls out a new version. </li><li>  <a href="https://github.com/operator-framework/operator-metering">Operator Metering</a> - as the name implies, it collects data on the work of the operator, and can also generate reports based on them. </li></ul><br><h2 id="sozdanie-novogo-proekta">  Creating a new project </h2><br><p>  As an example, there will be an operator who monitors the file with configs in the repository and, when updated, restarts the deployment of the service with new configs.  Full sample code is available <a href="https://github.com/GrigoriyMikhalkin/config-monitor">here</a> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4c0/e84/ebc/4c0e84ebcba8cad49b2bea8506f79d32.png" alt="Image"></p><br><p>  Create a project with a new operator: </p><br><pre><code class="plaintext hljs">operator-sdk new config-monitor</code> </pre> <br><p>  The code generator will create a code for an operator working in a dedicated <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> .  This approach is preferable to giving access to the entire cluster, since in case of errors the problems will be isolated within the same namespace.  You can generate a <code>cluster-wide</code> statement by adding to the <code>--cluster-scoped</code> .  Inside the created project there will be the following directories: </p><br><ul><li>  cmd - contains the <code>main package</code> , in which the <code>Manager</code> initialized and started; </li><li>  deploy - contains declarations of the operator, CRD and objects necessary for setting up the RBAC operator; </li><li>  pkg - here will be our main code for new objects and controllers. </li></ul><br><p>  There is only one <a href=""><code>cmd/manager/main.go</code></a> file in <a href=""><code>cmd/manager/main.go</code></a> . </p><br><div class="spoiler">  <b class="spoiler_title">Code snippet</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">// Become the leader before proceeding err = leader.Become(ctx, "config-monitor-lock") if err != nil { log.Error(err, "") os.Exit(1) } // Create a new Cmd to provide shared dependencies and start components mgr, err := manager.New(cfg, manager.Options{ Namespace: namespace, MetricsBindAddress: fmt.Sprintf("%s:%d", metricsHost, metricsPort), }) ... // Setup Scheme for all resources if err := apis.AddToScheme(mgr.GetScheme()); err != nil { log.Error(err, "") os.Exit(1) } // Setup all Controllers if err := controller.AddToManager(mgr); err != nil { log.Error(err, "") os.Exit(1) } ... // Start the Cmd if err := mgr.Start(signals.SetupSignalHandler()); err != nil { log.Error(err, "Manager exited non-zero") os.Exit(1) }</code> </pre> </div></div><br><p>  In the first line: <code>err = leader.Become(ctx, "config-monitor-lock")</code> - the leader is selected.  In most scenarios, only one active instance of a statement is needed per namespace / cluster.  By default, the Operator SDK uses the <a href="">Leader for life</a> strategy ‚Äî the first instance of the operator will remain the leader until it is removed from the cluster. </p><br><p>  After this instance of the operator has been designated as a leader, a new <code>Manager</code> is initialized - <code>mgr, err := manager.New(...)</code> .  His responsibilities include: </p><br><ul><li>  <code>err := apis.AddToScheme(mgr.GetScheme())</code> - registration of new resource schemes; </li><li>  <code>err := controller.AddToManager(mgr)</code> - register controllers; </li><li>  <code>err := mgr.Start(signals.SetupSignalHandler())</code> - launch and control of controllers. </li></ul><br><p>  At the moment we have neither new resources nor controllers for registration.  You can add a new resource using the command: </p><br><pre> <code class="plaintext hljs">operator-sdk add api --api-version=services.example.com/v1alpha1 --kind=MonitoredService</code> </pre> <br><p>  This command will add the definition of the <code>MonitoredService</code> resource schema to the <code>pkg/apis</code> directory, as well as yaml with the definition of <code>CRD</code> in <code>deploy/crds</code> .  Of all the generated files, it‚Äôs worth changing only the schema definition in <a href=""><code>monitoredservice_types.go</code></a> .  The <code>MonitoredServiceSpec</code> type determines the desired state of the resource: what the user specifies in yaml with the definition of the resource.  In the context of our operator, the <code>Size</code> field determines the desired number of replicas. <code>ConfigRepo</code> indicates where the actual configs can be pulled from.  <code>MonitoredServiceStatus</code> determines the observed state of the resource, for example, it stores the names of the Pods belonging to this resource and the current <code>spec</code> Pods. </p><br><p>  After editing the scheme, you need to run the command: </p><br><pre> <code class="plaintext hljs">operator-sdk generate k8s</code> </pre> <br><p>  It will update the definition of <code>CRD</code> in <code>deploy/crds</code> . </p><br><p>  Now we will create the main part of our operator, the controller: </p><br><pre> <code class="plaintext hljs">operator-sdk add controller --api-version=services.example.com/v1alpha1 --kind=Monitor</code> </pre> <br><p>  The <a href=""><code>monitor_controller.go</code></a> file will appear in the <code>pkg/controller</code> <a href=""><code>monitor_controller.go</code></a> , in which we add the logic we need. </p><br><h2 id="razrabotka-kontrollera">  Controller development </h2><br><p>  The controller is the main working unit of the operator.  In our case there are two controllers: </p><br><ul><li>  Monitor ontroller monitors the change of configs of the service; </li><li>  Upgrade controller updates the service and maintains it in the desired state. </li></ul><br><p>  At its core, the controller is a control loop, it monitors the queue with the events to which it is subscribed, and processes them: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/220/2e6/a09/2202e6a0931df3e5b87c4442dd839615.png" alt="Image"></p><br><p>  A new controller is created and registered by the manager in the <code>add</code> method: </p><br><pre> <code class="plaintext hljs">c, err := controller.New("monitor-controller", mgr, controller.Options{Reconciler: r})</code> </pre> <br><p>  Using the <code>Watch</code> method, we sign it to events regarding the creation of a new resource or the <code>Spec</code> update of an existing <code>MonitoredService</code> resource: </p><br><pre> <code class="plaintext hljs">err = c.Watch(&amp;source.Kind{Type: &amp;servicesv1alpha1.MonitoredService{}}, &amp;handler.EnqueueRequestForObject{}, common.CreateOrUpdateSpecPredicate)</code> </pre> <br><p>  The event type can be configured using the <code>src</code> and <code>predicates</code> parameters.  <code>src</code> accepts objects of type <code>Source</code> . </p><br><ul><li>  <code>Informer</code> - periodically polls <code>apiserver</code> about events that satisfy the filter, if there is such an event, puts it in the controller's queue.  In <code>controller-runtime</code> this is a wrapper over the <code>SharedIndexInformer</code> from the <code>client-go</code> . </li><li>  <code>Kind</code> is also a wrapper over <code>SharedIndexInformer</code> , but, unlike <code>Informer</code> , it independently creates an informer instance based on the passed parameters (the monitored resource scheme). </li><li>  <code>Channel</code> - accepts <code>chan event.GenericEvent</code> as a parameter, events coming through it puts in the controller queue. </li></ul><br><p>  <code>redicates</code> expects objects that satisfy the <a href="https://godoc.org/github.com/kubernetes-sigs/controller-runtime/pkg/predicate"><code>Predicate</code></a> interface.  In fact, this is an additional filter for events, for example, when filtering <code>UpdateEvent</code> you can see exactly what changes were made in the resource <code>spec</code> . </p><br><p>  When an event arrives, it is received by <code>EventHandler</code> - the second argument of the <code>Watch</code> method - which wraps the event in a request format that <code>Reconciler</code> expects: </p><br><ul><li>  <code>EnqueueRequestForObject</code> - creates a query with the name and namespace of the object that caused the event; </li><li>  <code>EnqueueRequestForOwner</code> - creates a request with the data of the object's parent.  This is necessary, for example, if the resource under the control of the <code>Pod</code> been deleted, and it is necessary to start its replacement; </li><li>  <code>EnqueueRequestsFromMapFunc</code> - takes as a parameter <code>map</code> function that receives the event (wrapped in <code>MapObject</code> ) at the input and returns a list of requests.  <a href="">An example of when you need this handler</a> is a timer, for each tick of which you need to pull out new configs for all available services. </li></ul><br><p>  Requests are put into the controller's queue, and one of the workers (by default, the controller has one) pulls the event out of the queue and sends it to <code>Reconciler</code> 's. </p><br><p>  <strong>Reconciler</strong> implements only one method - <code>Reconcile</code> , which contains the main event processing logic: </p><br><div class="spoiler">  <b class="spoiler_title">Reconcile method</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">func (r *ReconcileMonitor) Reconcile(request reconcile.Request) (reconcile.Result, error) { reqLogger := log.WithValues("Request.Namespace", request.Namespace, "Request.Name", request.Name) reqLogger.Info("Checking updates in repo for MonitoredService") // fetch the Monitor instance instance := &amp;servicesv1alpha1.MonitoredService{} err := r.client.Get(context.Background(), request.NamespacedName, instance) if err != nil { if errors.IsNotFound(err) { // Request object not found, could have been deleted after reconcile request. // Owned objects are automatically garbage collected. For additional cleanup logic use finalizers. // Return and don't requeue return reconcile.Result{}, nil } // Error reading the object - requeue the request. return reconcile.Result{}, err } // check if service's config was updated // if it was, send event to upgrade controller if podSpec, ok := r.isServiceConfigUpdated(instance); ok { // Update instance Spec instance.Status.PodSpec = *podSpec instance.Status.ConfigChanged = true err = r.client.Status().Update(context.Background(), instance) if err != nil { reqLogger.Error(err, "Failed to update service status", "Service.Namespace", instance.Namespace, "Service.Name", instance.Name) return reconcile.Result{}, err } r.eventsChan &lt;- event.GenericEvent{Meta: &amp;servicesv1alpha1.MonitoredService{}, Object: instance} } return reconcile.Result{}, nil }</code> </pre> </div></div><br><p>  The method accepts a <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/reconcile"><code>Request</code></a> object with the <code>NamespacedName</code> field, by which the resource can be pulled out of the cache: <code>r.client.Get(context.TODO(), request.NamespacedName, instance)</code> .  In the example, a request is made to the file with the service configuration referenced by the <code>ConfigRepo</code> field in the resource <code>spec</code> .  If the config is updated, a new event of the <code>GenericEvent</code> type is <code>GenericEvent</code> and sent to the channel that the <code>Upgrade</code> controller is listening to. </p><br><p>  After processing the request, <code>Reconcile</code> returns a <a href="https://godoc.org/sigs.k8s.io/controller-runtime/pkg/reconcile"><code>Result</code></a> and <code>error</code> object.  If in <code>Result</code> the <code>Requeue: true</code> or <code>error != nil</code> <code>Requeue: true</code> field, the controller will return the request back to the queue using the <code>queue.AddRateLimited</code> method.  The request will be returned to the queue with a delay, which is determined by <code>RateLimiter</code> .  The default is <a href="https://godoc.org/k8s.io/client-go/util/workqueue"><code>ItemExponentialFailureRateLimiter</code></a> , which increases exponentially the delay time with an increase in the number of "returns" of the request.  If the <code>Requeue</code> field <code>Requeue</code> not set, and no error occurred during the processing of the request, the controller will call the <code>Queue.Forget</code> method, which will remove the request from the <code>RateLimiter</code> cache (and thereby resetting the number of returns).  At the end of the request processing, the controller removes it from the queue using the <code>Queue.Done</code> method. </p><br><h2 id="zapusk-operatora">  Operator start </h2><br><p>  The components of the operator were described above, and one question remained: how to start it.  First you need to make sure that all the necessary resources are installed (for local testing I recommend <a href="https://kubernetes.io/docs/setup/minikube/">setting</a> up <a href="https://kubernetes.io/docs/setup/minikube/">minikube</a> ): </p><br><pre> <code class="plaintext hljs"># Setup Service Account kubectl create -f deploy/service_account.yaml # Setup RBAC kubectl create -f deploy/role.yaml kubectl create -f deploy/role_binding.yaml # Setup the CRD kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_crd.yaml # Setup custom resource kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_cr.yaml</code> </pre> <br><p>  After the prerequisites have been met, there are two easy ways to run the statement for testing.  The easiest way is to run it outside the cluster using the command: </p><br><pre> <code class="plaintext hljs">operator-sdk up local --namespace=default</code> </pre> <br><p>  The second way is to close the operator in the cluster.  First you need to build a Docker image with the operator: </p><br><pre> <code class="plaintext hljs">operator-sdk build config-monitor-operator:latest</code> </pre> <br><p>  In the file <code>deploy/operator.yaml</code> replace <code>REPLACE_IMAGE</code> with <code>config-monitor-operator:latest</code> : </p><br><pre> <code class="plaintext hljs">sed -i "" 's|REPLACE_IMAGE|config-monitor-operator:latest|g' deploy/operator.yaml</code> </pre> <br><p>  Create a deployment with the operator: </p><br><pre> <code class="plaintext hljs">kubectl create -f deploy/operator.yaml</code> </pre> <br><p>  Now <code>Pod</code> with a test service should appear on the cluster's list on the cluster, and in the second case, another one with an operator. </p><br><h2 id="vmesto-zaklyucheniya-ili-best-practices">  Instead of Conclusion or Best Practices </h2><br><p>  The key problems of the development of operators at the moment are the poorly documented tools and the lack of well-established best practices.  When a new developer starts developing an operator, he has practically nowhere to look at examples of the implementation of one or another requirement, therefore mistakes are inevitable.  Below are a few lessons that we learned from our mistakes: </p><br><ul><li>  If there are two related applications, you should avoid the desire to combine them with a single operator.  Otherwise, the principle of loose coupling services is violated. </li><li>  It is necessary to remember about the separation of concerns: do not try to implement all the logic in one controller.  For example, it is worth spreading the functions of monitoring configs and creating / updating a resource. </li><li>  In the <code>Reconcile</code> method, you should avoid blocking calls.  For example, you can pull up configs from an external source, but if the operation is longer, create a Gorutin for this, and send the request back to the queue, specifying <code>Requeue: true</code> in the response. </li></ul><br><p>  In the comments it would be interesting to hear about your experience in developing operators.  And in the next part we will talk about operator testing. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/446648/">https://habr.com/ru/post/446648/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446638/index.html">Cisco HyperFlex vs. competitors: test performance</a></li>
<li><a href="../446640/index.html">20 projects, 20 languages, deadline yesterday. Part 2</a></li>
<li><a href="../446642/index.html">Checklist for creating and publishing web applications</a></li>
<li><a href="../446644/index.html">How to lead SMM in 2019: 17 charts from Neil Patel</a></li>
<li><a href="../446646/index.html">InterSystems IRIS 2019.1 release</a></li>
<li><a href="../446650/index.html">How much do testers cost and what do their salaries depend on? Build a portrait of a successful QA-specialist</a></li>
<li><a href="../446652/index.html">MVCC-4. Snapshots of data</a></li>
<li><a href="../446654/index.html">How we saved the code review</a></li>
<li><a href="../446656/index.html">Speech coding at 1600 bps with LPCNet neural vocoder</a></li>
<li><a href="../446658/index.html">Interview with Andrei Stankevich about sports programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>