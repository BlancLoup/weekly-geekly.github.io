<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python internal list</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention an article based on the publication of Laurent Luce about the implementation of working with lists in CPython. It can be use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python internal list</h1><div class="post__text post__text-html js-mediator-article">  <i>I bring to your attention an article based on the <a href="http://www.laurentluce.com/posts/python-list-implementation/">publication of</a> Laurent Luce about the implementation of working with lists in CPython.</i>  <i>It can be useful to novice programmers in Python, or preparing for an interview.</i>  <i>C functions <b>are shown in an abbreviated version</b> and with my comments.</i>  <i>The full text of the functions can be found in the <a href="">source code of</a> CPython 2.7.</i> <br><br>  This article describes the implementation of the list object in CPython, the most popular implementation of Python.  Lists in Python are a powerful tool, and it is interesting to know how they are arranged inside.  Take a look at a simple script that adds several integer values ‚Äã‚Äãto the list and displays them: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>l = [] &gt;&gt;&gt; l.append(<span class="hljs-number"><span class="hljs-number">1</span></span>) &gt;&gt;&gt; l.append(<span class="hljs-number"><span class="hljs-number">2</span></span>) &gt;&gt;&gt; l.append(<span class="hljs-number"><span class="hljs-number">3</span></span>) &gt;&gt;&gt; l [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> l: ... <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> e ... <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  As you can see, the list is an iterable object. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  C-structure of the list object </h5><br>  The list object in CPython is represented by the following structure in C. ob_item is a list of pointers to list items, and allocated is the amount of allocated memory. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> PyObject_VAR_HEAD PyObject **ob_item; Py_ssize_t allocated; } PyListObject;</code> </pre><a name="habracut"></a><br><h5>  List initialization </h5><br>  Let's see what happens when creating an empty list, for example l = [].  The PyList_New (0) function is called: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* size -   */</span></span> PyList_New(Py_ssize_t size) { <span class="hljs-comment"><span class="hljs-comment">//      nbytes = size * sizeof(PyObject *); //  ob_item if (size &lt;= 0) op-&gt;ob_item = NULL; else { op-&gt;ob_item = (PyObject **) PyMem_MALLOC(nbytes); memset(op-&gt;ob_item, 0, nbytes); } //     op-&gt;allocated = size; return (PyObject *) op; }</span></span></code> </pre><br>  It is important to understand the difference between the allocated memory and the size of the list.  The size of the list is the same as len (l).  allocated is the amount of allocated memory, which can often be larger than the size of the list.  This is done to prevent realloc from being called whenever elements are added.  We will understand this in more detail later. <br><br><h5>  Adding items </h5><br>  We add an integer to the list: l.append (1).  What happens at this moment?  The C function PyList_Append () is called, which, in turn, calls the function app1 (): <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* self -     v -     */</span></span> app1(PyListObject *self, PyObject *v) { <span class="hljs-comment"><span class="hljs-comment">//      ,   -  (-1) if (list_resize(self, n+1) == -1) return -1; //    ,    n  v PyList_SET_ITEM(self, n, v); //     0 return 0; }</span></span></code> </pre><br>  Let's look at the list_resize () function.  It allocates more memory than necessary to prevent frequent calls to list_resize.  Memory allocation is defined by the following sequence: 0, 4, 8, 16, 25, 35, 46, 58, 72, 88, ... <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* self -     newsize -    */</span></span> list_resize(PyListObject *self, Py_ssize_t newsize) { <span class="hljs-comment"><span class="hljs-comment">//         -     if (allocated &gt;= newsize &amp;&amp; newsize &gt;= (allocated &gt;&gt; 1)) { assert(self-&gt;ob_item != NULL || newsize == 0); Py_SIZE(self) = newsize; return 0; } /*      ,    *      */ new_allocated = (newsize &gt;&gt; 3) + (newsize &lt; 9 ? 3 : 6); /*    */ if (new_allocated &gt; PY_SIZE_MAX - newsize) { PyErr_NoMemory(); return -1; } else { new_allocated += newsize; } //   if (new_allocated &lt;= (PY_SIZE_MAX / sizeof(PyObject *))) PyMem_RESIZE(items, PyObject *, new_allocated); return 0; }</span></span></code> </pre><br>  4 cells are now allocated for list items and the first one is an integer 1. In the image you can see that l [0] indicates an integer number that we added to the list.  Squares marked with a dashed line indicate allocated, but not yet used memory. <br><br>  The operation of adding an item to the list has O (1) complexity. <br><br><img src="https://habrastorage.org/files/245/65a/313/24565a313dd8404abc23df068fddf5df.png" alt="image"><br><br>  Add another item to the list: l.append (2).  list_resize is called with n + 1 = 2, but since the size of the allocated memory is 4, there is no need to allocate additional memory.  The same thing happens when you add two more integers: l.append (3), l.append (4).  The picture shows what we have in the end: <br><br><img src="https://habrastorage.org/files/aa9/028/419/aa9028419587469dbb9d69023cea2d71.png" alt="image"><br><br><h5>  Insert </h5><br>  Insert a new integer into position 1: l.insert (1.5) and see what happens at a low level.  The ins1 () function is called: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* self -     where - ,      v -     */</span></span> ins1(PyListObject *self, Py_ssize_t where, PyObject *v) { n = Py_SIZE(self); <span class="hljs-comment"><span class="hljs-comment">//          if (list_resize(self, n+1) == -1) return -1; //   ,      if (where &lt; 0) { where += n; if (where &lt; 0) where = 0; } //     ,     if (where &gt; n) where = n; //         items = self-&gt;ob_item; for (i = n; --i &gt;= where; ) items[i+1] = items[i]; //    items[where] = v; return 0; }</span></span></code> </pre><br><img src="https://habrastorage.org/files/acf/3fe/5f8/acf3fe5f8e114f35b50508b0b171e006.png" alt="image"><br><br>  Squares marked with a dashed line indicate allocated, but not yet used memory.  So, 8 cells are highlighted, but the size of the list is now 5. <br><br>  The complexity of the insert operation is O (n). <br><br><h5>  Popping </h5><br>  When you push an item from the list, l.pop (), listpop () is called.  The list_resize is called inside listpop () and if the new size is less than half of the allocated memory, then the list is compressed. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* self -     args - ,     */</span></span> listpop(PyListObject *self, PyObject *args) { <span class="hljs-comment"><span class="hljs-comment">//      Py_ssize_t i = -1; //    -  NULL if (Py_SIZE(self) == 0) { return NULL; } //    -    if (i &lt; 0) i += Py_SIZE(self); v = self-&gt;ob_item[i]; //     -  list_resize     if (i == Py_SIZE(self) - 1) { status = list_resize(self, Py_SIZE(self) - 1); return v; } //      ,       status = list_ass_slice(self, i, i+1, (PyObject *)NULL); return v; }</span></span></code> </pre><br>  The complexity of the operation is O (1). <br><br><img src="https://habrastorage.org/files/48d/f2e/689/48df2e689583456f99a11e88ac68b326.png" alt="image"><br><br>  You can observe that the 4th cell still points to the whole, but it is important to understand that our list size is 4. <br><br>  Push out another item.  In list_resize (), size-1 = 4-1 = 3 fewer than half the selected cells, so the list is compressed to 6 cells and the new list size becomes 3. <br><br>  You can observe that the 3 and 4 cells still indicate the whole, but it is important to understand that the size of the list is 3. <br><br><img src="https://habrastorage.org/files/e00/4b4/2a8/e004b42a8f0d4ebbb014fcaaf08ca42a.png" alt="image"><br><br><h5>  Deletion </h5><br>  In Python, the list object has a method for deleting an element with a given value: l.remove (5).  Called listremove (). <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* self -     v -     */</span></span> listremove(PyListObject *self, PyObject *v) { Py_ssize_t i; <span class="hljs-comment"><span class="hljs-comment">//    for (i = 0; i &lt; Py_SIZE(self); i++) { int cmp = PyObject_RichCompareBool(self-&gt;ob_item[i], v, Py_EQ); //     -     Python None if (cmp &gt; 0) { if (list_ass_slice(self, i, i+1, (PyObject *)NULL) == 0) Py_RETURN_NONE; return NULL; } else if (cmp &lt; 0) return NULL; } //     -  NULL return NULL; }</span></span></code> </pre><br><br>  The complexity of the delete operation is O (n). <br><br><img src="https://habrastorage.org/files/942/1c8/ea4/9421c8ea44c0403f9c03b3246cefb298.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/273045/">https://habr.com/ru/post/273045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273027/index.html">Browser extension from Yandex</a></li>
<li><a href="../273035/index.html">Accelerate your application. PERFMATTERS !.</a></li>
<li><a href="../273037/index.html">Interactive C #</a></li>
<li><a href="../273039/index.html">Evolution in the cloud: the experience of the service to work with social networks</a></li>
<li><a href="../273043/index.html">On the effectiveness of Rutreker's ‚Äúteachings‚Äù</a></li>
<li><a href="../273047/index.html">How to squeeze a flat cat</a></li>
<li><a href="../273049/index.html">NOC Project. Where to start and how to continue?</a></li>
<li><a href="../273051/index.html">How I debugged the python httplib and httplib2</a></li>
<li><a href="../273053/index.html">CrystaX NDK 10.3.0 Released</a></li>
<li><a href="../273055/index.html">Open-source implementation of domestic cryptoGOST</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>