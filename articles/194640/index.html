<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centrifuge is gaining momentum</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 A couple of months ago I published an article on Habr√© describing the open-source project Centrifuge . Let me remind you that this is a serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centrifuge is gaining momentum</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/b79/2ce/30e/b792ce30e5bf0d35b4566b978ce180e6.jpg" align="left">  Hello! <br><br>  A couple of months ago I <a href="http://habrahabr.ru/post/184262/">published</a> an article on Habr√© describing the open-source project <a href="https://github.com/FZambia/centrifuge">Centrifuge</a> .  Let me remind you that this is a server for sending messages to connected clients (mainly from a web browser) in real time.  Written in Python. <br><br>  Since then, I continued to work on the project in my free time and now I am ready to share my accumulated thoughts and changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Initially, the centrifuge was a distinctive project.  Not much concern for reproducing the functionality of existing analogs, I wrote the code in the way it seemed right to me.  As a result, messages were delivered to customers, everything worked, but!  Was it convenient to use all this?  Not! <br><br>  At the end of June, I came across a great article from <a href="https://github.com/mrjoes">Serge Koval</a> - <a href="http://mrjoes.github.io/2013/06/21/python-realtime.html">Python and real-time Web</a> .  Surprisingly, at that time I did not know about the existence of <a href="http://faye.jcoglan.com/">Faye</a> .  The article opened this wonderful project for me, as well as the understanding of the fact that, nevertheless, the Centrifuge in its current state does not greatly simplify life when developing real-time web applications. <br><br>  Since that time, I have finished the Centrifuge with an eye to usability and with an eye on <a href="http://pusher.com/">pusher.com</a> , <a href="http://pubnub.com/">pubnub.com</a> and Faye. <br><br>  The question of why I needed to write code from scratch, if there are already more mature and advanced analogues, is inevitable.  Here are some reasons: <br><br><ul><li>  It is interesting.  The project currently uses Tornado, ZeroMQ, Redis, SockJS, Bootstrap 3. Excellent tools, working with which - unlimited happiness. </li><li>  Pusher.com and Pubnub.com are cloud services, it‚Äôs not always possible / have_ meaning / want to rely on a third party.  Unable to make changes to the server side. </li><li>  I still haven't found any Python analogs (maybe you know?), The Faye backend is Ruby or NodeJS.  To make the subscription authorization to the channel, you need to write extensions in these languages.  I wanted to create a solution that is more independent of the backend language of the web application, providing the necessary functionality out of the box. </li><li>  Some features that are not in the analogues.  This is the presence of namespaces that define the characteristics of the behavior of their channels.  A web interface for managing projects, their settings and the ability to monitor messages in channels in real time. </li></ul><br><br>  Now I‚Äôll tell you about the changes that have occurred since the previous Centrifuge article was written. <br><br>  Structure - projects, namespaces and their settings - will now by default be stored in SQLite, the database included in the standard Python library.  Therefore, when running Centrifuge processes on one machine, it is no longer necessary to install PostgreSQL or MongoDB, as it was before.  Since the centrifuge is designed for use in small and medium-sized projects - I think this is an important and necessary change, since one machine should be enough in full. <br><br>  You can go a little further - and run the centrifuge with the structure described in the configuration file.  At the same time, the ability to dynamically make and save changes from the web interface is lost, but there are no dependencies on external storage.  This feature also helps tremendously in development. <br><br>  There is support for presence and history - now you can find out who is currently connected to the channel, as well as get the latest messages sent to the channel.  Redis is used to store this data.  If Redis is not configured - the data simply will not be available to customers, nothing will break. <br><br>  The question arises.  Now the centrifuge uses ZeroMQ PUB / SUB sockets for communication between several of its processes.  Perhaps, once Redis entered the game as a repository of information about connected clients and message history, should you use its PUB / SUB capabilities for communication between Centrifuge processes instead of ZeroMQ?  In the <a href="http://blog.jupo.org/2013/02/23/a-tale-of-two-queues/">only comparative benchmark</a> that I saw, ZeroMQ outperforms Redis in performance. <br>  Therefore, at the moment I left everything as it is.  However, this is a controversial and important point. <br><br>  Even now you can receive messages about the connection (disconnection) of the client to the channel (from the channel).  Pleasant little thing. <br><br>  Finally, perhaps the most important thing is a javascript client appeared - a wrapper over the Centrifuge protocol.  It is based on the <a href="https://github.com/Wolfy87/EventEmitter">Event Emitter</a> , written by <a href="https://github.com/Wolfy87">Oliver Caldwell</a> .  Now it‚Äôs very easy to interact with Centrifuge from the browser.  Like this: <br><br><blockquote>  <font color="#003366">var</font> centrifuge <font color="#339933">=</font> <font color="#003366">new</font> centrifuge <font color="#009900">(</font> <font color="#009900">{</font> <br>  <font color="#006600">// authentication settings</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  centrifuge.  <font color="#660066">on</font> <font color="#009900">(</font> <font color="#3366CC">'connect'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// the connection to the Centrifuge is established</font> <br><br>  <font color="#003366">var</font> subscription <font color="#339933">=</font> centrifuge.  <font color="#660066">subscribe</font> <font color="#009900">(</font> <font color="#3366CC">'python: django'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// function called when a new message is received from the channel</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  subscription.  <font color="#660066">on</font> <font color="#009900">(</font> 'ready' <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  subscription.  <font color="#660066">presence</font> <font color="#009900">(</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// received information about clients connected to the channel</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  subscription.  <font color="#660066">history</font> <font color="#009900">(</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// history of the latest channel messages</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  subscription.  <font color="#660066">on</font> <font color="#009900">(</font> <font color="#3366CC">'join'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// called when a new client connects to the channel</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  subscription.  <font color="#660066">on</font> <font color="#009900">(</font> <font color="#3366CC">'leave'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// called when the client disconnects from the channel</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  centrifuge.  <font color="#660066">on</font> <font color="#009900">(</font> <font color="#3366CC">'disconnect'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#006600">// Centrifuge connection lost</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  centrifuge.  <font color="#660066">connect</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br><br>  Overboard in this example are the authentication settings (you can <a href="https://centrifuge.readthedocs.org/en/latest/content/client_api.html">read</a> about them <a href="https://centrifuge.readthedocs.org/en/latest/content/client_api.html">in the documentation</a> ).  Also note the name of the channel - it consists of the namespace name that must be created in the administrative interface before connecting, in this case <code>python</code> .  The name of the channel itself is indicated after - in this case, <code>django</code> .  The namespace defines the settings of all channels belonging to it.  In the project settings, you can choose the default namespace - then in the javascript code, you can not explicitly specify the name of the namespace.  That is, if the python namespace is the default for the project, you can write like this: <br><br><blockquote>  centrifuge.  <font color="#660066">on</font> <font color="#009900">(</font> <font color="#3366CC">'connect'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#003366">var</font> subscription <font color="#339933">=</font> centrifuge.  <font color="#660066">subscribe</font> <font color="#009900">(</font> <font color="#3366CC">'django'</font> <font color="#339933">,</font> <font color="#003366">function</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#009900">{</font> <br>  console.  <font color="#660066">log</font> <font color="#009900">(</font> message <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#009900">)</font> <font color="#339933">;</font> <br></blockquote><br><br>  Authorization in this kind of applications is perhaps the most difficult part.  As I already mentioned, in Faye you need to write extensions on NodeJS or Ruby to protect access to certain channels.  Pusher.com for private channels offers the following scheme: <br><br><img src="https://habrastorage.org/storage3/239/252/39a/23925239a5aeeb856e62786f21ddd20b.png"><br><br>  When you try to subscribe to a private channel, an AJAX request is sent to the backend of your application with the channel name.  In case access is allowed, you must return a signed response, which is then sent along with the channel name directly to Pusher.  The advantage here is that at the time of receiving an AJAX request, your application already contains the current user object in most cases (for example, in Django, it's <code>request.user</code> ). <br><br>  The centrifuge takes a slightly different approach.  The current user ID is sent once at the moment of connection - you specify it when you configure the javascript client along with the project ID and token.  A token is an <a href="http://docs.python.org/2/library/hmac.html">HMAC</a> generated based on the project's secret key (which only your application‚Äôs backend should know about), the project ID, and the user ID.  The token is required to verify the correctness of the transmitted project ID and user ID.  In the future, when subscribing to private channels, the Centrifuge will send a POST request to your application with string user IDs, namespace name and channel name.  Therefore, first of all, in the authorization handler function, you will need to get your user's object by ID. <br><br>  Another important point regarding authorization is that now, in order to subscribe to several channels, you have to call the <code>subscribe</code> function several times on the client side.  If the channels are private, then each such subscription will result in a POST request to your application.  Not optimized behavior that I would like to improve.  But the same pusher.com, recognizing that such cases, although rare, are among the demands of their clients, has not yet <a href="http://pusher.tenderapp.com/discussions/requests/13-connect-to-and-auth-with-multiple-channels-at-once">fully resolved this problem</a> .  Here I am still looking for the right solution. <br><br>  I would like to mention another way to protect private data, which has not been canceled.  For example, to make separate private channels for each user of the application - it is possible to generate difficult to guess channel names based on some secret key and user ID.  In this case, it is quite possible to do without additional authorization, at least as long as it is not profitable for your clients to share the names of their private channels :) <br><br>  It is possible to add a custom asynchronous function (framed by the @coroutine tornado decorator) before posting a message to the channel.  Inside this function, you can do anything with the message, including returning None and thereby unpublish the message.  But, perhaps, this is of little use to anyone, as is the similar opportunity to add a handler called after publication.  This is a fairly low-level intervention and requires knowledge of Python and Tornado. <br><br>  Installing a Centrifuge in the simplest case comes down to one <code>pip install centrifuge</code> command inside virtualenv.  However, ZeroMQ (libzmq3) and the dev package for PostgreSQL must be installed on the machine (PostgreSQL server itself is optional).  The found problems that may arise during installation from PYPI, and how to solve them are <a href="https://centrifuge.readthedocs.org/en/latest/content/install.html">described in the documentation</a> .  Start of one process is performed by the <code>centrifuge</code> team.  However, a configuration file is required to launch into the combat environment, as it contains important security settings.  You also can‚Äôt do without additional command line options if you want to run multiple processes. <br><br>  <a href="https://centrifuge.readthedocs.org/en/latest/content/overview.html">Here in this section of the documentation</a> I tried to explain in as much detail as possible how the centrifuge works, what startup options there are, what address to specify when connecting from a browser and much more.  In English, really. <br><br>  Load testing has not yet conducted.  I hope to do some benchmarks in the near future.  It is interesting to compare with Faye, it is interesting to run on PYPY.  And, of course, it is necessary to continue working on resistance to all sorts of errors, improve the Python code and the javascript client, and so on.  Join now! <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/194640/">https://habr.com/ru/post/194640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194626/index.html">Interesting moments that you might not know about C # (Array)</a></li>
<li><a href="../194628/index.html">0 AD - free real-time strategy collects money on Indiegogo</a></li>
<li><a href="../194632/index.html">Render a landscape in WebGL - 2</a></li>
<li><a href="../194636/index.html">New mobile A / B testing framework from Facebook. Navigation panel redesign for iOS 5.6 & 7</a></li>
<li><a href="../194638/index.html">Bioprinter do it yourself</a></li>
<li><a href="../194642/index.html">The age of our galaxy</a></li>
<li><a href="../194644/index.html">Winter, a smartphone and gloves, or prepare your finger in the summer ...</a></li>
<li><a href="../194646/index.html">Peachy Printer - another 3D printer with a kickstarter or a new player in the market?</a></li>
<li><a href="../194648/index.html">The traffic compression feature has been added to Google Chrome for iOS</a></li>
<li><a href="../194650/index.html">Shed Skin - an experimental translator from Python to C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>