<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>5 advanced testing techniques on Go</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salute to all! Less than a week remains before the start of the ‚ÄúGolang Developer‚Äù course and we continue to share useful material on the topic. Go! 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>5 advanced testing techniques on Go</h1><div class="post__text post__text-html js-mediator-article"> Salute to all!  Less than a week remains before the start of the <a href="https://otus.pw/uNfP/">‚ÄúGolang Developer‚Äù</a> course and we continue to share useful material on the topic.  Go! <br><br><img src="https://habrastorage.org/webt/mi/ly/nj/milynjiemmrcxgeldshfcz383pa.png"><br><br>  Go has a good and reliable built-in library for testing.  If you write on Go, then you already know it.  In this article, we‚Äôll talk about several strategies that can improve your testing skills with Go.  From the experience of writing our impressive code base on Go, we learned that these strategies really work and thus help save time and effort to work with the code. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Use test suites</b> <br><br>  If you learn for yourself only one useful thing from this article, then it must be the use of test suites.  For those who are not familiar with this concept, testing by sets is the process of developing a test for testing a common interface that can be used on many implementations of this interface.  Below you can see how we pass several different implementations of <code>Thinger</code> and run them with the same tests. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Thinger <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { DoThing(input <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) (Result, error) } <span class="hljs-comment"><span class="hljs-comment">// Suite tests all the functionality that Thingers should implement func Suite(t *testing.T, impl Thinger) { res, _ := impl.DoThing("thing") if res != expected { t.Fail("unexpected result") } } // TestOne tests the first implementation of Thinger func TestOne(t *testing.T) { one := one.NewOne() Suite(t, one) } // TestOne tests another implementation of Thinger func TestTwo(t *testing.T) { two := two.NewTwo() Suite(t, two) }</span></span></code> </pre><br>  Lucky readers worked with code databases that use this method.  Frequently used tests on plug-in systems that are written to test the interface can be used by all implementations of this interface to understand how they meet the requirements of behavior. <br><br>  Using this approach will potentially help save hours, days, and even enough time to solve the problem of equality of <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE_%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25BE%25D0%25B2_P_%25D0%25B8_NP">classes P and NP</a> .  Also, replacing one base system with another eliminates the need to write (a large number) of additional tests, and there is also confidence that such an approach will not disrupt your application.  Implicitly, you need to create an interface that defines the area of ‚Äã‚Äãthe test area.  With the help of dependency injection, you can customize a set of a package passed to the implementation of the entire package. <br><br>  A full example can be found <a href="https://github.com/segmentio/testdemo">here</a> .  Despite the fact that this example is contrived, one can imagine that one database is remote, and the second is in memory. <br><br>  Another cool example of this technique is located in the standard library in the <code>golang.org/x/net/nettest</code> package.  It provides the means to verify that net.Conn satisfies the interface. <br><br>  <b>Avoid interface contamination</b> <br><br>  You can't talk about testing in Go, but don't talk about interfaces. <br><br>  Interfaces are important in the context of testing, because they are the most powerful tool in our testing arsenal, so you need to use them correctly. <br><br>  Packages often export interfaces for developers, and this leads to the fact that: <br><br>  A) Developers create their own stub (mock) to implement the package; <br>  B) The package exports its own stub (mock). <br><br><blockquote>  <i>‚ÄúThe larger the interface, the weaker the abstraction‚Äù</i> <i><br></i>  <i>- Rob Pike, Sayings about Go</i> </blockquote><br>  Interfaces should be carefully checked before exporting.  It is often tempting to export interfaces to allow users to mimic the behavior they need.  Instead, document which interfaces suit your structures so as not to create hard dependencies between the consumer package and your own.  A great example of this is the <i><a href="https://godoc.org/github.com/pkg/errors">errors</a></i> package. <br><br>  When we have an interface that we do not want to export, you can use the <i><a href="">internal / package subtree</a></i> to save it inside the package.  Thus, we can not be afraid that the end user may depend on him, and, therefore, can be flexible in changing the interface in accordance with the new requirements.  We usually create interfaces with external dependencies in order to be able to run tests locally. <br><br>  This approach allows the user to implement their own small interfaces, simply by wrapping some part of the library for testing.  For more information on this concept, read the <a href="https://rakyll.org/interface-pollution/">rakyl article on interface pollution</a> . <br><br>  <b>Do not export concurrency primitives.</b> <br><br>  Go offers easy-to-use concurrency primitives, which can also sometimes lead to their excessive use due to the same simplicity.  First of all, we are concerned about the channels and the sync package.  Sometimes it is tempting to export a feed from your package so that others can use it.  In addition, a common mistake is to embed <code>sync.Mutex</code> without setting it to private.  This, as usual, is not always bad, but it creates certain problems when testing your program. <br><br>  If you export feeds, you further complicate the life of a package user, which is not worth doing.  As soon as the channel is exported from the package, you create difficulties in testing for whoever uses this channel.  For successful testing, the user must know: <br><br><ul><li>  When data is finished being sent over the channel. </li><li>  Were there any errors in getting data. </li><li>  How does the packet clear the channel after completion, if clear at all? </li><li>  How to wrap the API of a package, so as not to call it directly? </li></ul><br>  Note the reading queue example.  Here is an example of a library that reads from a queue and provides the user with a feed for reading. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Reader <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> {...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadChan</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> &lt;-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chan</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Msg</span></span></span></span> {...}</code> </pre> <br>  Now a user of your library wants to implement a test for his consumer: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConsumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.T)</span></span></span></span> { cons := &amp;Consumer{ r: libqueue.NewReader(), } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> msg := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> cons.r.ReadChan() { <span class="hljs-comment"><span class="hljs-comment">// Test thing. } }</span></span></code> </pre> <br><br>  The user can then decide that dependency injection is a good idea, and write his own messages to the channel: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConsumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.T, q queueIface)</span></span></span></span> { cons := &amp;Consumer{ r: q, } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> msg := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> cons.r.ReadChan() { <span class="hljs-comment"><span class="hljs-comment">// Test thing. } }</span></span></code> </pre> <br><br>  Wait, what about errors? <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConsumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.T, q queueIface)</span></span></span></span> { cons := &amp;Consumer{ r: q, } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg := &lt;-cons.r.ReadChan(): <span class="hljs-comment"><span class="hljs-comment">// Test thing. case err := &lt;-cons.r.ErrChan(): // What caused this again? } } }</span></span></code> </pre> <br><br>  Now we need to somehow generate events to actually write to this stub, which replicates the behavior of the library we use.  If the library simply wrote down the synchronous API, then we could add all the parallelism to the client code, so testing becomes easier. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConsumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t testing.T, q queueIface)</span></span></span></span> { cons := &amp;Consumer{ r: q, } msg, err := cons.r.ReadMsg() <span class="hljs-comment"><span class="hljs-comment">// handle err, test thing }</span></span></code> </pre><br><br>  If you are in doubt, just remember that it is always easy to add concurrency to the consumer package (consuming package), and it is difficult or impossible to remove it after exporting from the library.  And most importantly, do not forget to write in the package documentation whether the structure / package is safe for simultaneous access to several Gorutin. <br>  Sometimes it is still desirable or necessary to export the channel.  To level out some of the problems outlined above, you can provide channels through accessors, instead of direct access and leave them open only for reading ( <code>‚Üêchan</code> ) or only for writing ( <code>chan‚Üê</code> ) when announcing. <br><br>  <b>Use <code>net/http/httptest</code></b> <br><br>  <code>Httptest</code> allows <code>Httptest</code> to perform <code>http.Handler</code> code without starting the server or binding to the port.  This speeds up testing and allows you to perform tests in parallel with lower costs. <br><br>  Here is an example of the same test, implemented in two ways.  There is nothing grandiose here, but this approach reduces the amount of code and saves resources. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestServe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// The method to use if you want to practice typing s := &amp;http.Server{ Handler: http.HandlerFunc(ServeHTTP), } // Pick port automatically for parallel tests and to avoid conflicts l, err := net.Listen("tcp", ":0") if err != nil { t.Fatal(err) } defer l.Close() go s.Serve(l) res, err := http.Get("http://" + l.Addr().String() + "/?sloths=arecool") if err != nil { log.Fatal(err) } greeting, err := ioutil.ReadAll(res.Body) res.Body.Close() if err != nil { log.Fatal(err) } fmt.Println(string(greeting)) } func TestServeMemory(t *testing.T) { // Less verbose and more flexible way req := httptest.NewRequest("GET", "http://example.com/?sloths=arecool", nil) w := httptest.NewRecorder() ServeHTTP(w, req) greeting, err := ioutil.ReadAll(w.Body) if err != nil { log.Fatal(err) } fmt.Println(string(greeting)) }</span></span></code> </pre> <br>  Perhaps the most important feature is that with the help of <code>httptest</code> you can only divide the test into the function you want to test.  No routers, middleware, or any other side effects that occur when setting up servers, services, handler factories, handler factories factories, or any other things that come to your mind that you used to consider a good idea. <br><br>  To see this principle in action, read the <a href="http://markjberger.com/testing-web-apps-in-golang/">article by Mark Berger</a> . <br><br>  <b>Use a separate <code>_test</code> package</b> <br><br>  Most of the tests in the ecosystem are created in the <code>pkg_test.go</code> files, but still remain in the same package: <code>package pkg</code> .  A separate test package is the package that you create in the new file, <code>foo_test.go</code> , in the directory of the module you want to test, <code>foo/</code> , with the <code>package foo_test</code> declaration.  From here you can import <code>github.com/example/foo</code> and other dependencies.  This feature allows you to do many things.  This is the recommended solution for cyclic dependencies in tests, it prevents the emergence of ‚Äúbrittle tests‚Äù (brittle tests) and allows the developer to feel what it is like to use your own package.  If your package is difficult to use, then testing with this method will also be difficult. <br><br>  This strategy prevents fragile tests from occurring by restricting access to private variables.  In particular, if your tests ‚Äúbreak‚Äù and you use separate test packets, it is almost guaranteed that the client using the function that broke in the tests will also break when called. <br><br>  Finally, it helps to avoid import cycles in tests.  Most packages are likely to depend on other packages that you wrote besides being tested, so you will eventually encounter a situation where the import cycle occurs naturally.  The external package is located above both packages in the package hierarchy.  Take the example from The Go Programming Language (Chapter 11, Section 2.4), where <code>net/url</code> implements the URL parser that <code>net/http</code> imports for use.  However, <code>net / url</code> needs to be tested using a real use case by importing <code>net / http</code> .  Thus it turns out <code>net/url_test</code> . <br><br>  Now that you are using a separate test package, you may need access to the unexported entities in the package where they were previously available.  Some developers encounter this for the first time when they are testing something based on time (for example, time.Now becomes a stub using a function).  In this case, we can use an additional file to provide entities exclusively during testing, since <code>_test.go</code> files <code>_test.go</code> excluded from regular builds. <br><br>  <b>What you need to remember?</b> <br><br>  It is important to remember that none of the methods described above is a panacea.  The best approach in any business is to critically analyze the situation and independently choose the best solution to the problem. <br><br>  Want to learn more about testing with Go? <br>  Read these articles: <br><br>  <a href="https://dave.cheney.net/2013/06/09/writing-table-driven-tests-in-go">Writing Table Driven Tests in Go by Dave Cheney</a> <br>  <a href="http://www.gopl.io/">The Go Programming Language Chapter on Testing.</a> <br>  Or watch these videos: <br>  <a href="https://www.youtube.com/watch%3Fv%3Dyszygk1cpEc">Hashimoto's Advanced Testing With Gophercon 2017</a> <br>  <a href="https://talks.golang.org/2014/testing.slide">Andrew Gerrand's Testing Techniques Talk from 2014</a> <br><br>  We hope this translation was useful for you.  We are waiting for comments, and we invite everyone to learn more about the course on <a href="https://otus.pw/bUrv/">the open day</a> , which will be held on May 23. </div><p>Source: <a href="https://habr.com/ru/post/452772/">https://habr.com/ru/post/452772/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452756/index.html">Creating a Tower Defense Game in Unity: Enemies</a></li>
<li><a href="../45276/index.html">New design Microsoft.com</a></li>
<li><a href="../452760/index.html">Vitamin D. To drink or not to drink, that is the question. (Or a story about how I took an analysis that I was not prescribed)</a></li>
<li><a href="../452764/index.html">[Peter] JUG.ru meeting with Sergey Melnikov - Profiling with superlight speed: theory and practice</a></li>
<li><a href="../452768/index.html">How to design a product if you decide to enter the overseas market</a></li>
<li><a href="../452776/index.html">N.M.D. (It's not my business)</a></li>
<li><a href="../452778/index.html">How to speed up the LZ4 release in ClickHouse</a></li>
<li><a href="../452780/index.html">Mobius 2019 Piter: free online broadcast and everything else</a></li>
<li><a href="../45279/index.html">Redirect from habr.ru to habrahabr.ru</a></li>
<li><a href="../452792/index.html">Review SSD for corporate users Kingston DC500R</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>