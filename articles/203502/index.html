<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Ansible AWX on Debian 7.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We decided to simplify the administration of a small group of servers on FreeBSD. It seems that there are not many servers of these servers, but still...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Ansible AWX on Debian 7.1</h1><div class="post__text post__text-html js-mediator-article">  We decided to simplify the administration of a small group of servers on FreeBSD.  It seems that there are not many servers of these servers, but still it often happens that you need to perform a number of tasks of the same type all at once. <br>  Long thought, chose, compared, and yet came to the option to install the Ansible system.  And for clarity, to fasten a web-face with the name AWX to it. <br>  But bad luck, the server is on FreeBSD, and Debian is chosen as the ‚Äúworking‚Äù Linux.  Ansible AWX supports as official RHEL / Fedora and Ubuntu. <br>  As we all remember, Ubuntu came out of Debian, which means it should be aware of the ancestor.  We will understand how to put AWX on Debian. <br>  Background: freshly installed Debian 7.1 Wheezy with the included configuration options ‚ÄúSSH server‚Äù and ‚ÄúSystem utilities‚Äù. <br><a name="habracut"></a><br>  The AWX installer is a sh script (a little more on this below), but the only thing that this script does is run the playbook for ansible, which means that before running this script you should install the ansible itself. <br><pre><code class="bash hljs">root@awx:~<span class="hljs-comment"><span class="hljs-comment"># apt-get install ansible   ‚Ä¶        ‚Ä¶  E:     ansible</span></span></code> </pre> <br><br>  But then there is a surprise in wheezy it is not, so you have to connect the testing repository.  I use Yandex mirrors, so I added the line to my /etc/apt/sources.list file: <br><pre> <code class="bash hljs">deb http://mirror.yandex.ru/debian/ testing main contrib non-free</code> </pre><br><br>  Next, update the package lists: <br><pre> <code class="bash hljs">root@awx:~<span class="hljs-comment"><span class="hljs-comment"># apt-get update</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And we set ourselves ansible with the necessary dependencies: <br><pre> <code class="bash hljs">root@awx:~<span class="hljs-comment"><span class="hljs-comment"># apt-get install ansible</span></span></code> </pre><br><br>  We agree with everything we are imputed to and we are waiting for the completion of the installation.  Then we download awx, unfortunately it is not in the packages. <br><pre> <code class="bash hljs">wget http://ansibleworks.com/releases/awx/setup/awx-setup-latest.tar.gz</code> </pre><br><br>  Unpacking <br><pre> <code class="bash hljs">root@awx:~<span class="hljs-comment"><span class="hljs-comment"># tar xzvf awx-setup-latest.tar.gz</span></span></code> </pre><br><br>  We are looking at what we have to deal with. <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># ls group_vars myhosts README.md roles setup.sh site.yml</span></span></code> </pre><br><br>  After reading the README.md file, we learn that we need to change the authentication data for PostgreSQL in the group_vars / all file, as well as a warning that pg_hba.conf and supervisord.conf will be overwritten.  So, if you are not putting on a clean system, you should make the appropriate backups. <br><br>  While everything is clear, now consider what the installer is about about which we already mentioned above: <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat setup.sh #!/bin/bash getopts "e:" EXTRA_ARGS if [ "$OPTARG" != "" ]; then echo "Running with extra args: ${OPTARG}" sudo ANSIBLE_ERROR_ON_UNDEFINED_VARS=True ansible-playbook -i myhosts -c local -v -e "$OPTARG" site.yml else sudo ANSIBLE_ERROR_ON_UNDEFINED_VARS=True ansible-playbook -i myhosts -c local -v site.yml fi</span></span></code> </pre><br><br>  From the contents it can be seen that the main and only task of this file is to run the playbook site.yml on a group of nodes specified in the myhosts file (in which only 127.0.0.1) from the same directory.  The following parameter -c local specifies the mechanism for delivering commands to the target machine, in our case the ansible and the target machine are the same. <br><br>  Also from the curious one can see that it is suggested to use sudo.  But since we have a clean installation of Debian, this is the very same sudo, unlike Ubuntu, not included.  This means either we delete the command, or we deliver sudo. <br>  I removed the sudo call, and also added two more letters ‚Äúv‚Äù for more detailed debugging. <br>  View of the file after my editing: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">getopts</span></span> <span class="hljs-string"><span class="hljs-string">"e:"</span></span> EXTRA_ARGS <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OPTARG</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Running with extra args: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${OPTARG}</span></span></span><span class="hljs-string">"</span></span> ANSIBLE_ERROR_ON_UNDEFINED_VARS=True ansible-playbook -i myhosts -c <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> -vvv -e <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OPTARG</span></span></span><span class="hljs-string">"</span></span> site.yml <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ANSIBLE_ERROR_ON_UNDEFINED_VARS=True ansible-playbook -i myhosts -c <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> -vvv site.yml <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br><br>  Now let's move on to the most interesting, site.yml file. <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat site.yml --- # This playbook deploys the AWX application (database, web and worker) to a # single server. - hosts: all tasks: - name: group hosts by distribution group_by: key="{{ ansible_distribution }}-{{ ansible_distribution_version }}" - hosts: RedHat-6*:CentOS-6*:SL-6* user: root roles: - { role: packages_el6 } - { role: postgres, pg_hba_location: "/var/lib/pgsql/data/pg_hba.conf" } - { role: awx_install } - { role: supervisor, sup_init_name: "supervisord", sup_conf_location: "/etc/supervisord.conf" } - { role: httpd, httpd_init_name: "httpd" } - { role: iptables } - { role: misc } - hosts: Ubuntu-12*:Ubuntu-13* user: root roles: - { role: packages_ubuntu } - { role: postgres, pg_hba_location: "/etc/postgresql/9.1/main/pg_hba.conf" } - { role: awx_install } - { role: supervisor, sup_init_name: "supervisor", sup_conf_location: "/etc/supervisor/conf.d/awx.conf" } - { role: httpd, httpd_init_name: "apache2" } - { role: misc }</span></span></code> </pre><br><br>  The option for Debian is not visible, but here you can see 2 ready-made versions of the script for RHEL-based and for Ubuntu, and as it is known Ubuntu is a direct descendant of Debian.  We will install it according to the Ubunt installation option, for this we add a mention of our OS in this playbook: <br><pre> <code class="bash hljs">- hosts: Ubuntu-12*:Ubuntu-13*:Debian*</code> </pre><br><br>  Since postgresql we will install version 9.3 we will slightly correct the path to its configuration files <br><pre> <code class="bash hljs"> - { role: postgres, pg_hba_location: <span class="hljs-string"><span class="hljs-string">"/etc/postgresql/9.3/main/pg_hba.conf"</span></span> }</code> </pre><br><br>  Otherwise, for us there is nothing more interesting. <br>  Lets go through the individual roles, and the first will be packages_ubuntu <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat roles/packages_ubuntu/tasks/main.yml --- # Tasks to install required packages for awx - name: install ubuntu awx apt repository template: src=awx_repo.j2 dest=/etc/apt/sources.list.d/awx_repo.list - name: install python-pip package for ubuntu 12.04 apt: name=python-pip when: ansible_lsb.codename == "precise" - name: install django 1.5.4 via pip for ubuntu 12.04 pip: name=django version=1.5.4 when: ansible_lsb.codename == "precise" - name: install django via apt for ubuntu 12.10 or later apt: name=python-django when: ansible_lsb.codename != "precise" - name: install required packages via apt apt: name={{ item }} with_items: - apache2 - libapache2-mod-wsgi - postgresql - python-psycopg2 - python-setuptools - python-ldap - supervisor - git - subversion - mercurial - name: install awx package via apt apt: name=awx update_cache=yes force=yes state=latest</span></span></code> </pre><br><br>  The first interesting line to us is template: src = awx_repo.j2 dest = / etc / apt / sources.list.d / awx_repo.list - connect the repository, look into the file: <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat roles/packages_ubuntu/templates/awx_repo.j2 deb {{ aw_repo_url }}/deb {{ansible_lsb.codename}} non-free</span></span></code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c9/680/127/4c96801277a177761e4275302212f5a6.png"><br><br>  It seems everything is clear, 2 variables, in the first case the URL of the repository specified in the group_vars / all file, in the second case the code name of the operating system, we have it whezzy, but since there is nothing in the repository for wheezy, we will disguise as Ubuntu Raring Ringtail. <br>  After ‚Äúmasking‚Äù the file takes the following form. <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat roles/packages_ubuntu/templates/awx_repo.j2 deb {{ aw_repo_url }}/deb raring non-free</span></span></code> </pre><br><br>  The next part checks to see if we have Precise Pangolin: <br><pre> <code class="bash hljs">- name: install python-pip package <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ubuntu 12.04 apt: name=python-pip when: ansible_lsb.codename == <span class="hljs-string"><span class="hljs-string">"precise"</span></span> - name: install django 1.5.4 via pip <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ubuntu 12.04 pip: name=django version=1.5.4 when: ansible_lsb.codename == <span class="hljs-string"><span class="hljs-string">"precise"</span></span> - name: install django via apt <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ubuntu 12.10 or later apt: name=python-django when: ansible_lsb.codename != <span class="hljs-string"><span class="hljs-string">"precise"</span></span></code> </pre><br><br>  Since it has (Precise Pangolin) in the Django repository of the old version, and the AWX authors put a newer (1.5.4) alternative way.  This problem does not threaten us, so you can not change anything.  Also we change the condition in the handler file for httpd, from Ubunu to Debian: <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat roles/httpd/handlers/main.yml --- # Handlers for common notifications. - name: restart httpd service: name=httpd state=restarted when: ansible_distribution in ["CentOS","RedHat"] - name: restart apache2 service: name=apache2 state=restarted when: ansible_distribution in ["Ubuntu"]</span></span></code> </pre><br><br>  The last line of Ubuntu is changed to Debian. <br>  Similar actions need to be done for the following postgres role: <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># cat roles/postgres/tasks/main.yml # Tasks for configuring PostgreSQL server. - name: init postgresql command: service postgresql initdb creates=/var/lib/pgsql/data/PG_VERSION when: ansible_distribution != "Ubuntu" tags: postgresql</span></span></code> </pre><br><br>  We cross our fingers and run <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># ./setup.sh PLAY RECAP ******************************************************************** 127.0.0.1 : ok=30 changed=12 unreachable=0 failed=0</span></span></code> </pre><br><br>  Installer apache settings placed in a folder <br><pre> <code class="bash hljs">root@awx:~/awx-setup-1.3.1<span class="hljs-comment"><span class="hljs-comment"># ls /etc/apache2/conf.d awx.conf awx-plain.conf</span></span></code> </pre><br><br>  The contents of this folder are not included in the main apache config, so we need to move them: <br><pre> <code class="bash hljs">mv /etc/apache2/conf.d/awx* /etc/apache2/sites-enabled/</code> </pre><br><br>  Further, nothing complicated, we configure Apache, delete duplicate module calls and use. </div><p>Source: <a href="https://habr.com/ru/post/203502/">https://habr.com/ru/post/203502/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203490/index.html">Why 98% of the texts on your sites do not work. At all. And how to fix it</a></li>
<li><a href="../203492/index.html">Do not trust "people of the people"</a></li>
<li><a href="../203494/index.html">Commercial self-extracting archives: security, principles of operation</a></li>
<li><a href="../203496/index.html">New domains for brands: make.believe</a></li>
<li><a href="../203500/index.html">ABCat: New version of the application for downloading and cataloging audiobooks</a></li>
<li><a href="../203504/index.html">How I hung up hotkeys on the Unity sound indicator</a></li>
<li><a href="../203506/index.html">TDD for Responsive Design. Or how to automate site display testing for different devices using the Galen Framework</a></li>
<li><a href="../203508/index.html">CodinGame November: Note Writing from Doctor Who</a></li>
<li><a href="../203512/index.html">Virtual reality glasses using a tablet</a></li>
<li><a href="../203514/index.html">Pointer events</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>