<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Architecture highload project on the example of a web consultant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our team is engaged in remote administration of servers and, not so long ago, representatives of the WebConsult service turned to us with the task of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Architecture highload project on the example of a web consultant</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://centos-admin.ru/">Our team</a> is engaged in remote administration of servers and, not so long ago, representatives of the <a href="http://consultsystems.ru/">WebConsult</a> service turned to us with the task of building an easily scalable server architecture that will withstand serious workloads.  We decided that maybe it would be interesting for Habrahabr users who are somehow connected with the administration of Highload projects.  The project turned out to be fast-growing and the existing structure was already working at the limit, so we had to launch a new one in an accelerated mode. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/694/b80/172/694b80172aa4006f285dfdb3b2063fa4.png" alt="image"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To do this quickly, we tried to distribute the tasks as much as possible among all our administrators.  To do this, we used the project and task management system - Redmine and in the same place maintained contact with the project developers, who promptly answered our questions and carried out the necessary improvements in the code. <br>  To understand the essence of the task before us, let's see what the principle of the project is.  <a href="http://consultsystems.ru/">WebConsult</a> is a system through which visitors can contact the store or company manager and ask their questions in real time.  Managers, for their part, have a choice of using two counseling options - through a panel open in a browser or through any familiar Jabber client.  In turn, visitors to the sites where the system is installed see the call button of a consultant, which is loaded from the WebConsult server (which means that the speed of the service is very important).  Since the button is downloaded several million times per day, this creates a significant load on web servers.  Also, a serious part of the burden is made up of operators who use the main method of consulting - through a web client.  In this case, HTTP requests for updates (a new client, a message, a change in various statuses) come from thousands of consultants who are simultaneously online after a certain number of seconds. This also consumes a huge amount of HTTP servers and database servers. <br><br><h5>  Balancing </h5><br><img src="http://centos-admin.ru/images/1.png" alt="Balancing scheme"><br><br>  Let's move on to considering the architecture we have built.  The basis of everything is balancing at the DNS level (round-robin), which transmits traffic on two fronts (this is convenient, including for cases when one of the servers is briefly unavailable - modern browsers transfer the request automatically to the second server).  The fronts, in turn, proxy traffic using nginx to HTTP servers ‚Äî web1, web2, web3, and so on. <br><br><h5>  Virtualization </h5><br>  We tried to create our OpenVZ container for each individual task in order to isolate the logical parts of the project from each other, as well as to be able to quickly allocate the container to a separate physical server.  Why we chose this virtualization, we described in <a href="http://habrahabr.ru/company/centosadmin/blog/161375/">one of the past articles</a> . <br><br><h5>  NGINX web server </h5><br><img src="http://centos-admin.ru/images/2.png" alt="Loading and issuing statics"><br><br>  In order to save traffic and optimize load, all passing statics are cached using nginx tools.  In the previous architecture, NFS was used to store files and source code, but it was decided to abandon it due to the fact that it exerted additional load.  Instead, we began to catch requests for static downloads (avatars of consultants, company logos) and redirect them to one server.  NGINX is set up so that if it does not find the pictures locally, it searches for them on other web servers using try_files $ uri <a href="http://habrahabr.ru/users/servers/" class="user_link">servers</a> , and in the named <a href="http://habrahabr.ru/users/servers/" class="user_link">servers</a> locale, the search of web <a href="http://habrahabr.ru/users/servers/" class="user_link">servers is</a> registered.  Also, static is synchronized with other servers several times a day, which makes them available locally. <br><br><h5>  Jabber </h5><br>  An important part of the WebConsult project is working with clients on the site via Jabber.  As a XMPP server, Openfire is used with a number of self-written modules that allow you to integrate with the internal structure of the project and send messages from Jabber to HTTP and back.  For the convenience of customers, the task was to make the ability to connect to the jabber-server not only through the direct domain jabber.consultsystems.ru, but also through the main domain consultsystems.ru.  For this it was necessary to organize the proxying of ports.  We decided to replace the previously used rinetd with a more advanced solution and used HAProxy for this task, which forwards ports 5222, 5223 in TCP mode. <br><br><h5>  For developers </h5><br>  Since <a href="http://consultsystems.ru/">WebConsult</a> is a project that is constantly being developed and expanded, it was necessary to come up with a solution that allows developers to see the changes made on the server in their own sandbox, so that customers notice them only after everything has been tested and completed.  To do this, a separate OpenVZ container was created with a minimum amount of allocated resources, where a version of the site was launched for testing and debugging.  GIT was chosen as a version control system as a familiar and modern solution.  As a result, it turned out that developers can introduce new functions, test them on a separate server, and after everything is ready to produce an updated version of the project in production, which virtually eliminates the possibility of failure and errors in the working copy of the project.  Also, for convenience, we have written a small plugin for Redmine, which allows authorized users to do warm deploy by pressing a button. <br><br><h5>  Database </h5><br>  We chose Percona Server as the database server as a more efficient version of the mysql server. <br>  Memcached is used for central storage of user sessions.  Access to it is open only for the web by iptables rules. <br><br><h5>  Scaling </h5><br>  As a result, we have a structure that easily horizontally scales by adding new web servers by ‚Äúcloning‚Äù the existing OpenVZ container and transferring it to a new machine.  As for the scalability of the database, at the moment, one powerful server handles everything, and in the future replication will be applied.  Also, some of the ‚Äúheavy‚Äù functions for which MySQL is currently used will be transferred to NoSQL solutions, for example Redis, which will seriously relieve the servers.  Another very important task at the moment is to transfer chat to web sockets, in order to refuse to perform regular HTTP requests and instead keep a constant connection to the server - work in this direction is already underway. <br><br>  Thank you for your attention, if you have any questions or suggestions, we will be happy to discuss in the comments. </div><p>Source: <a href="https://habr.com/ru/post/166739/">https://habr.com/ru/post/166739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166725/index.html">Activision will show a new generation of rendering technologies at GDC</a></li>
<li><a href="../166727/index.html">Man-hours for implementing the ‚Äúsimple‚Äù Email sending module in an application with a modular architecture</a></li>
<li><a href="../166729/index.html">I-Teco OpenStack Cloud: Designing the OpenStack Network Part</a></li>
<li><a href="../166731/index.html">Paul Graham: How to find an idea for a startup (part two)</a></li>
<li><a href="../166735/index.html">Controlling the HD44780 LCD with an assembler</a></li>
<li><a href="../166741/index.html">Type Yourself a Robot: Frenchman Makes an Open Source Android</a></li>
<li><a href="../166743/index.html">Support for free VMware vSphere Hypervisor (Free ESXi) in virtual environment backup products</a></li>
<li><a href="../166745/index.html">Error 451, 404 Error Simulated</a></li>
<li><a href="../166747/index.html">Specification By Example - BDD for Pragmatists</a></li>
<li><a href="../166751/index.html">Lost documentation or transform: matrix3d ‚Äã‚Äã[translation]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>