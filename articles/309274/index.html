<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AWS ElasticBeanstalk: Tips and Tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AWS ElasticBeanstalk - PaaS based on AWS infrastructure. In my opinion, a significant advantage of this service is the ability to directly access infr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AWS ElasticBeanstalk: Tips and Tricks</h1><div class="post__text post__text-html js-mediator-article">  AWS ElasticBeanstalk - PaaS based on AWS infrastructure.  In my opinion, a significant advantage of this service is the ability to directly access infrastructure elements (balancers, instances, queues, etc.). In this article I decided to collect some tricks to solve typical problems using ElasticBeanstalk.  I will supplement as new ones are found.  Questions and suggestions in the comments are welcome. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4de/5de/125/4de5de12563745239908260c462ef119.jpg"></div><br><a name="habracut"></a><br><h3>  Options for adding application configuration </h3><br>  In my opinion, the obvious disadvantage of the platform is a vague configuration storage mechanism.  Therefore, I use the following methods to add a configuration. <br><br>  The most obvious and native for ElasticBeanstalk is setting via environment variables.  Inside the instance, these environment variables are not available as usual, but exclusively in the environment of the application.  To set these parameters, it is most convenient to use the eb setenv command from the awsebcli package, which is used to deploy the application (suitable for small projects), or the AWS API. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">eb setenv RDS_PORT=5432 PYTHONPATH=/opt/python/current/app/myapp:<span class="hljs-variable"><span class="hljs-variable">$PYTHONPATH</span></span> RDS_PASSWORD=12345 DJANGO_SETTINGS_MODULE=myapp.settings RDS_USERNAME=dbuser RDS_DB_NAME=appdb RDS_HOSTNAME=dbcluster.us-east-1.rds.amazonaws.com</code> </pre> <br>  The second option is when the config is injected into the created version of the application.  For this we need to explain how to proceed the deployment process.  Manually or a script creates a zip archive containing the application code, is laid out on a special S3 bucket, unique for each region (type elasticbeanstalk- &lt;region_name&gt; - &lt;my_account_id&gt; - do not try to use another, it will not work - it is checked).  You can create this package manually or edit it programmatically.  I prefer to use an alternate deployment option when using my own version creation code instead of awsebcli. <br><br><img src="https://habrastorage.org/files/e93/bfe/951/e93bfe95157f4d30bc7df76e1c91705b.png"><br><br>  The third option is to upload the configuration remotely during the deployment phase from the external configuration database.  IMHO the most correct approach, but beyond the scope of this article.  I use the scheme with storing configs on S3 and proxying requests to S3 via API Gateway - this allows the most flexible management of configs.  S3 also supports versioning. <br><br><h3>  We include tasks in crontab </h3><br>  ElasticBeanstalk supports creating tasks for the scheduler using the cron.yaml file.  However, this config only works for the worker environment ‚Äî the configuration used to process the task queue / periodic tasks.  To solve this problem in the WebServer environment, we add a file with the following content in the project directory .ebextensions: <br><br><pre> <code class="xml hljs">files: "/etc/cron.d/cron_job": mode: "000644" owner: root group: root content: | #Add comands below 15 10 * * * root curl www.google.com &gt;/dev/null 2&gt;&amp;1<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span> "/usr/local/bin/cron_job.sh": mode: "000755" owner: root group: root content: | #!/bin/bash /usr/local/bin/test_cron.sh || exit echo "Cron running at " `date` &gt;&gt; /tmp/cron_job.log # Now do tasks that should only run on 1 instance ... "/usr/local/bin/test_cron.sh": mode: "000755" owner: root group: root content: | #!/bin/bash METADATA=/opt/aws/bin/ec2-metadata INSTANCE_ID=`$METADATA -i | awk '{print $2}'` REGION=`$METADATA -z | awk '{print substr($2, 0, length($2)-1)}'` # Find our Auto Scaling Group name. ASG=`aws ec2 describe-tags --filters "Name=resource-id,Values=$INSTANCE_ID" \ --region $REGION --output text | awk '/aws:autoscaling:groupName/ {print $5}'` # Find the first instance in the Group FIRST=`aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $ASG \ --region $REGION --output text | awk '/InService$/ {print $4}' | sort | head -1` # Test if they're the same. [ "$FIRST" = "$INSTANCE_ID" ] commands: rm_old_cron: command: "rm *.bak" cwd: "/etc/cron.d" ignoreErrors: true</code> </pre><br><h3>  Automatically apply Django migrations and build statics during deployment </h3><br>  Add to the config file in .ebextensions: <br><br><pre> <code class="xml hljs">container_commands: 01_migrate: command: "python manage.py migrate --noinput" leader_only: true 02_collectstatic: command: "./manage.py collectstatic --noinput"</code> </pre><br>  Similarly, alembic migrations are applied;  in order to avoid the use of migrations on each instance of autoscaling group, the parameter leader_only is indicated <br><br><h3>  Using hooks when deploying applications </h3><br>  By creating scripts in the / opt / elasticbeanstalk / hooks / directory, you can add various control scripts, in particular, modify the application deployment process.  Scripts running before deployment are located in the / opt / elasticbeanstalk / hooks / appdeploy / pre / * directory, during - in / opt / elasticbeanstalk / hooks / appdeploy / enact / *, and after - in / opt / elasticstalk / hooks / appdeploy / post / *.  The scripts are executed in alphabetical order, thanks to this, you can build the correct sequence of application deployment. <br><br><h3>  Adding the Celery daemon to the existing supervisor config </h3><br><pre> <code class="xml hljs">files: "/opt/elasticbeanstalk/hooks/appdeploy/post/run_supervised_celeryd.sh": mode: "000755" owner: root group: root content: | #!/usr/bin/env bash # Get django environment variables celeryenv=`cat /opt/python/current/env | tr '\n' ',' | sed 's/export //g' | sed 's/$PATH/%(ENV_PATH)s/g' | sed 's/$PYTHONPATH//g' | sed 's/$LD_LIBRARY_PATH//g'` celeryenv=${celeryenv%?} # Create celery configuraiton script celeryconf="[program:celeryd] ; Set full path to celery program if using virtualenv command=/opt/python/run/venv/bin/celery worker -A yourapp -B --loglevel=INFO -s /tmp/celerybeat-schedule directory=/opt/python/current/app user=nobody numprocs=1 stdout_logfile=/var/log/celery-worker.log stderr_logfile=/var/log/celery-worker.log autostart=true autorestart=true startsecs=10 ; Need to wait for currently executing tasks to finish at shutdown. ; Increase this if you have very long running tasks. stopwaitsecs = 600 ; When resorting to send SIGKILL to the program to terminate it ; send SIGKILL to its whole process group instead, ; taking care of its children as well. killasgroup=true ; if rabbitmq is supervised, set its priority higher ; so it starts first priority=998 environment=$celeryenv" # Create the celery supervisord conf script echo "$celeryconf" | tee /opt/python/etc/celery.conf # Add configuration script to supervisord conf (if not there already) if ! grep -Fxq "[include]" /opt/python/etc/supervisord.conf then echo "[include]" | tee -a /opt/python/etc/supervisord.conf echo "files: celery.conf" | tee -a /opt/python/etc/supervisord.conf fi # Reread the supervisord config supervisorctl -c /opt/python/etc/supervisord.conf reread # Update supervisord in cache without restarting all services supervisorctl -c /opt/python/etc/supervisord.conf update # Start/Restart celeryd through supervisord supervisorctl -c /opt/python/etc/supervisord.conf restart celeryd</code> </pre><br>  By the way, I used the experimental opportunity to take as a broker for Celery SQS and this was completely justified;  true, flower does not yet have support for such a scheme. <br><br><h3>  Automatic HTTP Forwarding to HTTPS </h3><br>  Such an addition to the Apache configuration inside ElasticBeanstalk is used. <br><br><pre> <code class="xml hljs">files: "/etc/httpd/conf.d/ssl_rewrite.conf": mode: "000644" owner: root group: root content: | RewriteEngine On <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">If</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-n</span></span></span><span class="hljs-tag"> '%{</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HTTP:X-Forwarded-Proto</span></span></span><span class="hljs-tag">}' &amp;&amp; %{</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HTTP:X-Forwarded-Proto</span></span></span><span class="hljs-tag">} != </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'https'</span></span></span><span class="hljs-tag">"&gt;</span></span> RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L] <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">If</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h3>  Using multiple SSL domains </h3><br>  Amazon gives domain owners the opportunity to use SSL certificates for free, including wildcard, but only within AWS itself.  To use multiple domains with SSL on one environment, we obtain a certificate through AWS Certificate Manager, add another ELB balancer and configure SSL on it.  You can use and obtained from another supplier certificates. <br><br><img src="https://habrastorage.org/files/911/30b/826/91130b8266cb4cba90944120b837488d.png"><br><br>  <b>UPDATE</b> Below <a href="https://habrahabr.ru/post/309274/">in the comments</a> respected <a href="https://habrahabr.ru/users/darken99/" class="user_link">darken99</a> brought a couple of useful chips, let <a href="https://habrahabr.ru/users/darken99/" class="user_link">me</a> add them here with some explanations <br><br>  <b>Turn off the environment on schedule</b> <br><br>  In this case, depending on the specified time range, the number of instances in the autoscaling group decreases from 1 to 0. <br><br><pre> <code class="xml hljs">option_settings: - namespace: aws:autoscaling:scheduledaction resource_name: Start option_name: MinSize value: 1 - namespace: aws:autoscaling:scheduledaction resource_name: Start option_name: MaxSize value: 1 - namespace: aws:autoscaling:scheduledaction resource_name: Start option_name: DesiredCapacity value: 1 - namespace: aws:autoscaling:scheduledaction resource_name: Start option_name: Recurrence value: "0 9 * * 1-5" - namespace: aws:autoscaling:scheduledaction resource_name: Stop option_name: MinSize value: 0 - namespace: aws:autoscaling:scheduledaction resource_name: Stop option_name: MaxSize value: 0 - namespace: aws:autoscaling:scheduledaction resource_name: Stop option_name: DesiredCapacity value: 0 - namespace: aws:autoscaling:scheduledaction resource_name: Stop option_name: Recurrence value: "0 18 * * 1-5"</code> </pre><br><br>  <s><b>Replacing Apache with Nginx</b></s> <s><br></s> <pre> <s><code class="xml hljs">option_settings: aws:elasticbeanstalk:environment:proxy: ProxyServer: nginx</code></s> </pre>  Does not work for python </div><p>Source: <a href="https://habr.com/ru/post/309274/">https://habr.com/ru/post/309274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309264/index.html">Worker question: why are western IT companies interested in autistic employees?</a></li>
<li><a href="../309266/index.html">Peter Lowry: ‚ÄúThe greatest difficulty is in understanding the methodology‚Äù</a></li>
<li><a href="../309268/index.html">The digest of interesting events from the world of Java, and around it # 8 (08/01/2016 - 08/31/2016)</a></li>
<li><a href="../309270/index.html">School programmers HeadHunter - open the seventh set</a></li>
<li><a href="../309272/index.html">How to develop design thinking</a></li>
<li><a href="../309276/index.html">Unusual jQuery and CSS selectors</a></li>
<li><a href="../309278/index.html">Criteria for optimal selection of CMS and CMF</a></li>
<li><a href="../309282/index.html">Providing VMware-based cloud resources with BILLmanager. Or how the new CloudLITE personal account appeared</a></li>
<li><a href="../309284/index.html">And a couple of words about the recording: Larisa, where are the files ???</a></li>
<li><a href="../309286/index.html">Solve puzzles of shamans in the World of Warcraft genetic algorithm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>