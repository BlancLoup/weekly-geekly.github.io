<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to transfer ESXi server to another server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This material describes how to install an ESXi server on hardware that is not supported by its installer. The problem is avoided by tra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to transfer ESXi server to another server</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  This material describes how to install an ESXi server on hardware that is not supported by its installer.  The problem is avoided by transferring an ESXi image from a working server to the server where the installation problem occurred.  In my case, the problem was with HP Proliant Blade 35p. <br><a name="habracut"></a><br><h4>  Problem with 35 blade </h4><br>  It took us to install ESXi on Blade HP BL35p.  But for some reason during installation ESXi cannot detect the hard disk installed there.  And on HP BL20p it is put without problems, but on 35 it doesn‚Äôt want at all - it gives an error: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/bf9/641/86c/bf964186c497c5efff3cc6853728c1e0.png" alt="Unable to find a supported device"><br><br>  Search for information <br>  An Internet search on ESXi gave information about the ability to boot from a flash drive (http://www.yellow-bricks.com/2008/07/29/esxi-35-update-2-on-a-usb-memory-key/) .  But there appeared another problem - the BL35p does not have external USB ports. <br>  The ILO download option is also not very suitable, since for this you need to go to the Blade browser and mount an image for it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There was another possibility to use USB devices.  On the front panel of the server there is a special connector where you can connect a tricky cable with outputs for PS / 2 mouse, keyboard, monitor and 2 USB ports.  But this solution is more suitable for a temporary connection, and not for regular work. <br><br><h4>  Dd flash option </h4><br><h5>  failure from dd to partition </h5><br>  Since there is already a ready-made image for working directly from a flash drive, I thought of transferring it directly to disk.  Damn Small Linux also did not want to boot on the blade.  I tried and in a safe mode and a couple more options - did not work. <br>  Therefore, I just put our corporate CentOs on the disk, and then I recorded this image in a specially assigned partition: <br> <code>centos # dd bs=512 if=VMware-...-.i386.dd of=/dev/hda3</code> <br>  Then he climbed into grub.conf and added a download point for ESXi <br> <code>title ESXi <br> root (hd0,2) <br> chainloader +1 <br></code>  <b>Naive!</b>  I thought everything was so simple :) <br>  This method could not earn in principle, but then I did not know it. <br>  It is worth noting here that I did all this, looking for at least a small but a whole time interval, between other, though small, but urgent tasks.  And such interruption does not contribute to a deep understanding of the issue :) <br>  I was hoping that everything will work itself out after several successful manipulations found on the Internet. <br><br><h5>  failure from dd to a separate disk </h5><br>  Again began to look for a way to start the server.  This time I was looking for an opportunity to dual boot from grub. <br>  Found a discussion of a similar problem. How do I setup ESXi in a dualboot with Linux?  ( <a href="http://communities.vmware.com/message/1205801%3Bjsessionid%3D8858F14289C5790501D2BE15F4E048CF">communities.vmware.com/message/1205801;jsessionid=8858F14289C5790501D2BE15F4E048CF</a> ) <br><br>  Added 2nd winchester to the server, recorded the image there <br> <code>centos # dd bs=512 if=VMware-...-.i386.dd of=/dev/hdb</code> <br>  Repeated grub manipulations <br> <code>title ESXi <br> root (hd1,0) <br> chainloader +1 <br></code>  but something he did not want to be loaded from grub.  Disconnected 1st disk and now it is loaded from the 2nd.  I was delighted: finally!  Still, it's pretty simple! <br>  But this time the download was interrupted.  I can not find a bootable partition, waiting for a bootable USB device to appear, - this is how the server reported.  And as a result, a loading error. <br><br><h5>  The dd image already contains several sections. </h5><br>  Further search led me to this document <a href="http://www.grid.org/blog/cameron/updating-vmware-esxi-disk-dump-file">www.grid.org/blog/cameron/updating-vmware-esxi-disk-dump-file</a> <br>  Then I understood why the method did not work with recording the image in a disk partition - the image itself already contains several disk partitions. <br> <code>~# fdisk -ul VMware-...-.i386.dd <br> You must set cylinders. <br> You can do this from the extra functions menu. <br> Disk VMware-...-.i386.dd: 0 MB, 0 bytes <br> 64 heads, 32 sectors/track, 0 cylinders, total 0 sectors <br> Units = sectors of 1 * 512 = 512 bytes <br> Disk identifier: 0x00000000 <br> Device Boot Start End Blocks Id System <br> VMware-...-.i386.dd1 8192 1535999 763904 5 Extended <br> VMware-...-.i386.dd4 * 32 8191 4080 4 FAT16 &lt;32M <br> VMware-...-.i386.dd5 8224 106495 49136 6 FAT16 <br> VMware-...-.i386.dd6 106528 204799 49136 6 FAT16 <br> VMware-...-.i386.dd7 204832 430079 112624 fc Unknown <br> VMware-...-.i386.dd8 430112 1535999 552944 6 FAT16 <br> Partition table entries are not in disk order</code> <br> <br>  After a bit of searching and thinking, I refused this method (writing the dd image from the distribution kit directly to disk), since I didn‚Äôt know what had to be done so that the server would understand how to boot in this case. <br><br><h4>  Network ESXi boot using PXE </h4><br>  In the process of searching, I also met a rather tempting way to download ESXi over the network using PXE.  Everything is as simple as creating a bootable flash drive, just adding a few more steps to set up a PXE server. <br>  In this document, everything is described in detail in <a href="http://communities.vmware.com/docs/DOC-6824">communities.vmware.com/docs/DOC-6824</a> .  Even apply the desired configuration after the download can <a href="http://communities.vmware.com/docs/DOC-7510">communities.vmware.com/docs/DOC-7510</a> . <br>  But in this case, you need a separate PXE server, which you did not want to configure right now, so I went the other way :) <br><br><h4>  Successful option with transferring partitions from BL20p </h4><br>  I thought that all this is simply organized for both flash drives and PXE boot.  You can add entries for your device drivers by manipulating the oem.tgz file.  So I just need a normal Live Cd and a server on which ESXi has already been installed. <br>  So I installed ESXi on the backup BL20p, where there are no problems.  Download ubuntu-8.10-desktop-i386.iso <br><h5>  partition map of the newly installed ESXi </h5><br>  Boot into Ubuntu looked at the disk with ESXi.  I saw this picture: <br><br><img src="http://pics.livejournal.com/corvit/pic/0003zt26" alt="fdisk -ul / dev / cciss / c0d0"><br><br>  And almost everything became clear to me :) <br>  the <b><i>/ dev / cciss / c0d0p4</i></b> section is bootable, the additional section ( <b>extended</b> ) <b><i>/ dev / cciss / c0d0p1</i></b> with its subsections ( <b><i>p5, p6, p7, p8</i></b> ) contains everything you need for ESXi to work. <br>  There are still two main sections: <br>  <b><i>/ dev / cciss / c0d0p2</i></b> - here is the paging file (uwswap) <br>  <b><i>/ dev / cciss / c0d0p3</i></b> is the repository for which the rest of the space is allocated during installation. <br><br><h5>  transfer of the main part </h5><br>  Then I started transferring the ESXi server from the BL20p to the BL35p.  For this, I downloaded both from the Ubuntu Live CD. <br>  On BL20p fulfilled <br> <code>blade20p #fdisk -ul /dev/cciss/c0d0 <br> Disk /dev/cciss/c0d0: 18.3 GB, 18345246720 bytes <br> 64 heads, 32 sectors/track, 17495 cylinders, total 35830560 sectors <br> Units = sectors of 1 * 512 = 512 bytes <br> Disk identifier: 0x00000000 <br> <br> Device Boot Start End Blocks Id System <br> /dev/cciss/c0d0p1 8192 <u>1535999</u> 763904 5 Extended <br> /dev/cciss/c0d0p2 1536000 9922559 4193280 6 FAT16 <br> /dev/cciss/c0d0p3 9922560 35830559 12954000 fb VMware VMFS <br> /dev/cciss/c0d0p4 * 32 8191 4080 4 FAT16 &lt;32M <br> /dev/cciss/c0d0p5 8224 106495 49136 6 FAT16 <br> /dev/cciss/c0d0p6 106528 204799 49136 6 FAT16 <br> /dev/cciss/c0d0p7 204832 430079 112624 fc VMware VMKCORE <br> /dev/cciss/c0d0p8 430112 1535999 552944 6 FAT16 <br> Partition table entries are not in disk order</code> <br>  A picture familiar to us is already visible here.  Knowing where extended section ‚Ññ1 ends ( <b><i>/ dev / cciss / c0d0p1</i></b> ), I <b><i>film</i></b> its image <br> <code>blade20p # dd bs=512 if=/dev/cciss/c0d0 of=/tmp/boot_esxi.dd count= <u>1535999</u></code> <br>  Then I transfer this image in size 786`431`488 bytes to another server <br> <code>blade20p # scp /tmp/boot_esxi.dd bl35p:/tmp/</code> <br>  Well, I am writing this image to the hard disk. <br> <code>blade35p # dd bs=512 if=/tmp/boot_esxi.dd of=/dev/sda</code> <br> <br><h5>  copying the contents of a partition2 </h5><br>  I format the 2nd partition (/ dev / sda2) in FAT16, because although it is in the partition table, it really is not marked on the disk. <br>  On both servers I mount 2nd section <br> <code>blade35p # mount /dev/sda /mnt ( BL35p) <br> blade20p # mount /dev/cciss/c0d0p2 ( BL20p) <br></code>  I copy the contents of sections from the 20th to the 35th <br> <code>blade20p # echo &gt; /mn t/uwswap ( swap   1 ) <br> blade20p # scp /mnt/* blade35p:/mnt/ -r</code> <br> <br><h5>  manipulations with partition3 (it is possible that this is not necessary) </h5><br>  Since the third section is <b><i>/ dev / cciss / c0d0p3</i></b> in <b><i>vmfs</i></b> format, I do not know what to do with it in Ubunt.  Therefore, I simply transfer 400MB of this section as an image.  Before that, I found out by booting into ESXi that there are utility files on this section that occupy <u>366</u> MB <br> <code>blade20p # df -h <br> Filesystem Size Used Available Use% Mounted on <br> unknown 183.9M 116.4M 67.5M 63% / <br> unknown 4.0G 1.0G 3.0G 25% /vmfs/volumes/49df3145-f290113e-defa-001635c10df4 <br> unknown 12.3G <u>366</u> .0M 11.9G 3% /vmfs/volumes/49df314a-a47bf89f-e95d-001635c10df4 <br> unknown 539.8M 175.0M 364.8M 32% /vmfs/volumes/3abb47ef-875ea67c-c948-7bf6ff8d3c38 <br> unknown 47.8M 1.0k 47.8M 0% /vmfs/volumes/f25a177c-84106917-bb27-25e3fe8f8471 <br> unknown 47.8M 36.6M 11.2M 77% /vmfs/volumes/c8f8fc7d-7c221e9a-67b6-5dcb9d3b36ad</code> <br> <br>  I transfer as well as the first piece to this: <br> <code>blade20p # dd bs=512 if=/dev/cciss/c0d0p3 of=/tmp/partit3.dd count=819200 (819200 = 400*1024*1024/512) <br> blade20p # scp /tmp/partit3.dd bl35p:/tmp/</code> <br>  Well, I write this image on the hard disk in the desired section <br> <code>blade35p # dd bs=512 if=/tmp/partit3.dd of=/dev/sda3</code> <br> <br>  After a reboot, ESXi works as if nothing had happened.  Hooray!  Everything worked out!  :) <br><br><h5>  Creating Storage from VI Client </h5><br>  It remains only to configure our server. <br>  I configure the ip address of the new server from the console.  I access it using the VMWare Infrastructure Client.  In the settings, I see that this server has a storage capacity of 13.3 GB and about 40 GB more of unused space, since the 60 GB hard drive is installed here. <br>  I delete the existing storage for 13.3 GB, then create a new one from the unallocated space of 55 GB. <br><br>  There is one <b>danger here</b> .  When a new storage is created, my default is to use the entire disk.  Although a warning pops up there that all data will be destroyed, I‚Äôm sure that I‚Äôm working with the unallocated part of the disk successfully organized the storage on top of ESXi itself, which continued to function until the next reboot.  Only then I realized that I was wrong, destroying everything on the disk :) <br><br>  This situation was described by DimkaPhantom <a href="http://dimkaphantom.habrahabr.ru/blog/54322/">dimkaphantom.habrahabr.ru/blog/54322</a> <br><br>  I had to repeat the server transfer procedure described above. <br><br><h4>  Conclusion </h4><br><br>  When all the way is passed, everything seems so simple and obvious that I just wonder why I was so tormented in the beginning :) <br>  Suddenly, someone will be at the beginning of this path and not everything will be obvious to him.  Maybe my description will help him a little :) </div><p>Source: <a href="https://habr.com/ru/post/57165/">https://habr.com/ru/post/57165/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../57154/index.html">Apple is developing a portable device that will occupy a niche between the iPhone / iPod touch and the MacBook!</a></li>
<li><a href="../57158/index.html">"The right driver." Project Diary. Initial promotion</a></li>
<li><a href="../57159/index.html">Twinbots: first experience</a></li>
<li><a href="../57161/index.html">How to quickly spend 1 GB of traffic</a></li>
<li><a href="../57162/index.html">Overview of the system architecture of the social network Campus.ru</a></li>
<li><a href="../57166/index.html">Do you buy printed editions of books on IT topics?</a></li>
<li><a href="../57167/index.html">Askin. Wallpaper</a></li>
<li><a href="../57168/index.html">Attempting to explain ‚Äúwhat is OpenID, how to use it‚Äù</a></li>
<li><a href="../57170/index.html">World Digital Library</a></li>
<li><a href="../57173/index.html">Real Valley right from Disney Land</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>