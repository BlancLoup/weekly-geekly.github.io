<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Signal processing in PHP, or cooking delicious</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the Internet, including Habra, the topic of signal processing using php has been raised several times, but for the most part they are quite old, co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Signal processing in PHP, or cooking delicious</h1><div class="post__text post__text-html js-mediator-article">  On the Internet, including Habra, the topic of signal processing using php has been raised several times, but for the most part they are quite old, contain irrelevant information, and do not answer the frequently asked question: ‚Äúwhy?‚Äù, We are let's start <br><a name="habracut"></a><br><hr><br><h4>  When can we need signal processing in php? </h4><br><ul><li>  In any loaded project, sooner or later you have to face the need to parallelize the process and the most frequent way is to use a message server, such as RabbitMq, Gearman, Kafka and others.  At this moment it becomes necessary to create a so-called consumer.  It consists of a cycle, checking for new messages and processing them. <br><br>  Now, the actual situation: we updated the code and we need to restart the consumer calculator - if you just send a SIGTERM signal, you will be able to get non-consistency of data in the database or other problems due to script breaks in the middle of processing, in which case we will be helped by signal processing. </li><li>  Also in the era of containerization, it is not bad to be able to correctly extinguish the container with the application without losing the processed information. </li><li>  Well, the third option - specific tasks where you need a demon and wrote it in php, here we can use a number of signals to update the configuration, complete the script, and other actions.  <a href="https://habr.com/post/307464/">An example</a> . </li></ul><br><hr><br>  <b>Arsenal that provides us with php to work with signals:</b> <br><br><ul><li>  <b>pcntl_signal ()</b> <sup>php&gt; = 4.1.0</sup> is a function for registering a signal handler. </li><li>  <b>declare (ticks = 1)</b> <sup>php &lt;5.3</sup> - indicates how many ticks the interpreter will check for the presence of a signal. </li><li>  <b>pcntl_signal_dispatch ()</b> <sup>php&gt; = 5.3.0</sup> - manual launch of the raw signal check, as a more productive alternative to declare. </li><li>  <b>pcntl_async_signals ()</b> <sup>php&gt; = 7.1.0</sup> - asynchronous substitution of the signal handler in the call stack. </li><li>  <b>pcntl_signal_get_handler ()</b> <sup>php&gt; = 7.1.0</sup> - getting the function of the signal handler. </li><li>  <b>pcntl_alarm ()</b> <sup>php&gt; = 4.3.0</sup> - send yourself a SIGALARM. </li><li>  <b>pcntl_sigprocmask ()</b> <sup>php&gt; = 5.3.0</sup> - you can block, unblock the processing of specified signals, also delete, replace the stack of blocked signals. </li></ul><br><hr><br><h4>  A bit of theory: </h4><br>  For each signal that we want to process, you need to register a handler function via pcntl_signal (). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Important note from php.net pcntl_signal () - does not assemble signal handlers into the stack, but replaces them, that is, if you somewhere in the code again define a signal handler of some kind of signal, it will simply override the previous one, this is why libraries <s>do not use</s> try not to use these features.  But at the end of the article there will be a small bonus about this. <br><br>  After executing the handler function, the interpreter continues its work from the interruption point.  <s>If you certainly did not call die () in the handler</s> . <br><br>  From previous versions of php, we know about the existence of the declare directive (ticks = 1), which told our script after each operation, see if the signal came to us, respectively, it gave a tangible overhead while executing, especially if there is a lot of code, it is well described <a href="https://habr.com/post/179075/">here</a> .  But fortunately in the courtyard in 2018 and the language developers added an amazing thing - pcntl_async_signals (), this function allows the interpreter not to be distracted by checking the signal, in fact it puts our signal handler as the next in the call stack for the function being performed. <br><br>  <i>The synthetic performance test showed no differences with and without pcntl_async_signals ().</i> <br><br>  Now let's talk about handler restrictions, the signal will be processed only after the end of the current function execution, if this call to api or DB will take a while before processing the signal, this should be taken into account, for example, if you use a supervisor or a docker, increase the timeout before sending SIGKILL during your own long blocking call plus stock.  I also want to say that at the time of testing I encountered an interesting behavior of the sleep () function, as it turned out to be documented, but I did not expect it - it is interrupted by a signal and returns the number of seconds that it did not sleep, that is, if you suddenly need to use it and be sure of the length of sleep, then this would look like this: <br><br><pre><code class="php hljs">$sleep = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($sleep &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $sleep = sleep($sleep); }</code> </pre> <br>  I also want to focus on the fact that you will encounter examples of SIGKILL processing on many resources - <b>but this does not work</b> (it worked on older versions of linux), now this signal kills the process from the operating system and cannot be affected. <br><hr><br><h4>  And some code </h4><br>  What it will look like in the case of a RabbitMq with a cosyumer: <br>  This is our simplified task manager whose task is to prepare a concierge and follow up on tasks <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $stopConsume = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopConsume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stopConsume = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($consumerAlias)</span></span></span><span class="hljs-function"> </span></span>{ $consumer = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getConsumerBuilder()-&gt;create($consumerAlias); $channel = $consumer-&gt;getChannel(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (\count($channel-&gt;callbacks) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;stopConsume !== <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $channel-&gt;wait(); } } }</code> </pre><br>  And this is all you need in the controller: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $queueManager; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;queueManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueueManager(); pcntl_signal(SIGTERM, [<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;queueManager, <span class="hljs-string"><span class="hljs-string">'stopConsume'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consumeSomeQueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;queueManager-&gt;consume(<span class="hljs-string"><span class="hljs-string">'SomeConsumer'</span></span>); } }</code> </pre><br>  When the signal is received, the stopConsume method of the queueManager object will be called - it in turn will set the stopConsume parameter to true and will only have to go to the end of processing the current message, after which the cycle will end. <br><br>  The purpose of the article is not to consider side issues of demonizing processes such as maintaining connections, memory leaks, etc. <br><br>  I hope this information was useful and interesting for you, <br>  if there are any questions left, I will gladly answer in the comments or add to the article as necessary. <br><br><div class="spoiler">  <b class="spoiler_title">Actually the bonus itself</b> <div class="spoiler_text">  This class format will give us the opportunity to put several handlers on the signal, if you ask why, simply because we can. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $handlers = []; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sigNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$sigNumber])) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$sigNumber] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $signalHandler) { $signalHandler($sigNumber); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sigNumber, $handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$sigNumber][<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFunctionHash($handler)] = $handler; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unsubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sigNumber, $handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;handlers[$sigNumber][<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getFunctionHash($handler)]); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFunctionHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($callable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> spl_object_hash($callable); } }</code> </pre><br>  Try at work: <br><br><pre> <code class="php hljs">pcntl_async_signals(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $sigHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SigHandler(); pcntl_signal(SIGTERM, [$sigHandler, <span class="hljs-string"><span class="hljs-string">'handle'</span></span>]); $sigHandler-&gt;subscribe(SIGTERM, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'sigterm_1'</span></span>, PHP_EOL; }); $sigHandler-&gt;subscribe(SIGTERM, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'sigterm_2'</span></span>, PHP_EOL; }); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/355020/">https://habr.com/ru/post/355020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../355008/index.html">May 19, welcome to Badoo Techleads Meetup # 3</a></li>
<li><a href="../355010/index.html">Check Point Dashboards - that's what I love</a></li>
<li><a href="../355014/index.html">Telegram bot development for Instagram</a></li>
<li><a href="../355016/index.html">Common mistakes made by developers in the UX</a></li>
<li><a href="../355018/index.html">GPU Ray Tracing in Unity</a></li>
<li><a href="../355022/index.html">Project Arena - webinar for creators of serious VR projects</a></li>
<li><a href="../355024/index.html">Rethinking Conference</a></li>
<li><a href="../355026/index.html">Approaches to connecting Internet of Things to the network</a></li>
<li><a href="../355088/index.html">How to demoralize employees: A guide for bad companies</a></li>
<li><a href="../355114/index.html">Advanced Locationbar for Firefox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>