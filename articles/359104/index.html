<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to deploy the infrastructure for Pivotal CF, or Puff Pie Recipe in pictures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year ago, the task came to the center of competence in IT management and monitoring systems: deploy the Pivotal Cloud Foundry product (which is, in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to deploy the infrastructure for Pivotal CF, or Puff Pie Recipe in pictures</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/nm/iw/jd/nmiwjda1nm3pc80hwwbchs3qkb8.jpeg"></div><br><br><p>  A year ago, the task came to the center of competence in IT management and monitoring systems: deploy the Pivotal Cloud Foundry product (which is, in fact, the reference model of the PaaS model).  In a nutshell, <a href="https://pivotal.io/platform">Pivotal Cloud Foundry</a> (PCF) is a complete commercial solution for businesses that: </p><br><ul><li>  need a platform running in a hybrid or multi-cloud environment; </li><li>  want to move from using monolithic architectures to cloud schemes; </li><li>  want to launch next-generation digital services from day one; </li><li>  are already using Java or Spring to deploy microservices. </li></ul><br><p>  In this article, I do not seek to advertise a vendor product or once again ‚Äúexplain for microservices.‚Äù  My main goal is to share the experience of deploying the infrastructure for the cloud PCF platform in a non-standard configuration of this kind of solution.  This configuration came during the task of creating an environment for project developers, who, without false modesty, were called ‚ÄúDigital Transformation‚Äù. </p><a name="habracut"></a><br><h2 id="pivotal-prosto-gotovit">  Pivotal just ‚Äúcook‚Äù </h2><br><p>  From the "business" was set a global task: to build products using microservice architecture.  VMware virtual infrastructure was chosen as IaaS;  as PaaS, the Pivotal Cloud Foundry platform. </p><br><p>  The choice of PCF was supported by the possibility of providing users (in a sense, developers) with a ready-made set of various programming environments, databases and services for creating applications of any scale without being tied to a specific hypervisor.  This flexibility allowed us to concentrate on building the business logic of applications and minimally refer to low-level IaaS-level functions. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6c/dn/7o/6cdn7osviuuxaad9wvilbe43jre.jpeg"></div><br><h2 id="nemnogo-istorii">  A bit of history </h2><br><p>  VMware, the largest developer of virtualization software, was one of the founders of the open source <a href="https://www.cloudfoundry.org/">Cloud Foundry</a> hybrid cloud platform under the Apache 2.0 license, which is being developed to improve the quality of continuous integration processes and continuous delivery (CI / CD) software.  In 2014, the Cloud Foundry Foundation (CFF) non-profit foundation was created under the auspices of the non-profit organization Linux Foundation, which allowed us to create a neutral platform for joint development, management and promotion of the project.  In 2015, the CFF community decided to certify systems based on the Cloud Foundry open source project.  The certification program was designed to ensure the portability of PaaS solutions between various cloud services and systems hosted on enterprise sites (on-premise).  Currently, CFF includes more than sixty organizations that are leaders in the global telecommunications and engineering systems market: Cisco, Dell EMC, Hewlett Packard Enterprise, IBM, Pivotal, SAP, VMware, Intel, and many others. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/da/mg/y_/damgy_v_pe9_ct39ybymvasyjo0.jpeg"></div><br><p>  Pivotal Software, Inc.  (Pivotal) - Separated from 2013, a division of EMC Corporation and VMware - has combined a wide range of innovative developments to create the Pivotal Cloud Foundry product (based on open source code), which includes the usual configuration, management and monitoring applications, turnkey . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ok/5p/ym/ok5pym_3lr7ge-rhwrhv4n5a4fi.jpeg"></div><br><h2 id="samyy-glavnyy-ingredient">  The most important "ingredient" </h2><br><p>  The cornerstone of the Cloud Foundry philosophy is the term ‚Äúmicroservice architecture‚Äù (microservice architecture). </p><br><p>  A microservice architecture is a way of representing a single application as a set of small services, each of which runs in its own process and communicates with the others using lightweight mechanisms (usually HTTP).  This term is easiest to illustrate with a comparison with a ‚Äúmonolith‚Äù (monolithic architecture) - an application built as a whole. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h5/fs/io/h5fsiomjtocigkwponrbq7qrhhe.jpeg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/ip/az/e3ipazeyhrmsahzzlm7zz0jyly0.jpeg"></div><br><p>  Traditional monolithic architecture is not suitable for a modern cloud: modules within a monolith cannot be scaled separately, and a change in the logic of one tends to influence the code of others.  In the microservice architecture, on the contrary, the modules can be written in different programming languages, quickly deployed and easily scaled, which together increases the availability factor of the application. </p><br><p>  As part of the development of the microservice Cloud Foundry architecture, two main areas can be distinguished: </p><br><ul><li>  The core of the cloud is <a href="https://bosh.io/docs">BOSH</a> , an open source toolkit for deploying and managing distributed systems that supports a variety of platforms: AWS, Azure, OpenStack, vSphere, vCloud, and the Google Compute Platform. </li><li>  A number of systems are responsible for the correct execution of the runtime (runtime) of the applications: life cycle management (Cloud Controller), performance management (Diego), user authentication and authorization (UAA), messaging (NATS), technical condition and health monitoring (Health Manager ) and etc. </li></ul><br><p>  Despite the fact that the list of microservices included in the release of the Cloud Foundry platform is huge, this release lays the minimum foundation necessary for deploying and running so-called ‚Äúcontainer‚Äù applications (application containers) in the cloud. </p><br><p>  Container applications are the next isolation level at which an application contains all the components it needs and works regardless of the operating system.  Container application virtualization provides better performance, scalability, density, dynamic resource management, and ease of administration compared to alternative solutions. </p><br><p>  At this introductory microservice ends, and I proceed to the most interesting - the description of the infrastructure. </p><br><h2 id="dlya-prigotovleniya-nam-potrebuetsya">  For the "preparation" we need ... </h2><br><p>  After analyzing the system requirements of the PCF platform for the VMware cluster, a number of prerequisites were formed: </p><br><ul><li>  Required read / write permissions for the datacenter level as per <a href="https://vmware.github.io/pyvmomi-community-samples/assets/vchierarchy.pdf">vSphere Inventory Hierarchy</a> ; </li><li>  Access to vCenter over HTTPS is required; </li><li>  Access to ESXi via TCP is required to ports: 443, 902, 903; </li><li>  When you enable the vSphere DRS (Distributed Resource Scheduler) option, the automation level must be set to Partially automated or Fully automated. </li></ul><br><p>  Already on the basis of these requirements, it became obvious that to deploy PCF, it was necessary to have an isolated vCenter and, as a result, isolated ESXi hosts.  To implement such a segment (read, save on hardware), I had the idea to use the concept of nested virtualization. </p><br><p>  No sooner said than done!  To execute this, to put it mildly, nontraditional IaaS model, I needed a piece of our public cloud, <a href="https://ts-cloud.ru/">Technoserv Cloud</a> , which is implemented in two virtualization environments: VMware and OpenStack.  The vCloud Director product serves as the control panel for the VMware environment. </p><br><p>  Immediately make a reservation: in practice, such solutions do not go to Prod, but as a Test or Dev stand will fit.  Further in the text I will try to talk about the architecture, key features and advantages of the installation (or disadvantages, how it goes). </p><br><h2 id="tot-samyy-sloenyy-pirog">  The same "layer cake" </h2><br><p>  So, a virtual data center (VDC) TS-CloudDev with the following characteristics was created in the TS-Cloud cloud: </p><br><ul><li>  Memory Quota: 750 GB </li><li>  vCPU speed: 2.60 GHz </li><li>  Quota CPU: 314.60 GHz </li><li>  Disk Quota: 3474 GB </li><li>  VM Quota: 100 </li><li>  Network Quota: 10 </li></ul><br><p>  For the target cluster, using Edge Gateway, 4 internal subnets are created: </p><br><ol><li>  10.0.10.0/24 - as management of a network of Nested ESXi hosts. </li><li>  10.0.11.0/24 - as a vMotion network for migrating virtual machines deployed on Nested ESXi hosts. </li><li>  192.168.63.192/26 - as a network for integration with the internal network. </li><li>  10.10.0.0/16 - as a PCF deployment network. </li></ol><br><p>  Subnet 10.0.150.0/24 is external to the VDC. </p><br><img src="https://habrastorage.org/webt/n0/my/go/n0mygoatmjpeabsav9nhmvspzdo.jpeg"><br><p>  It is worth noting that the presence of the Edge Gateway component is one of the key advantages of using the vCloud environment.  This is a virtual VDC-network router that can be configured to provide network services: DHCP, NAT, firewall, static routing, VPN and load balancing. </p><br><p>  As for the hardware configuration, in addition to 4 identical ESXi hosts and 1 vCenter server, another virtual machine was created, acting as an iSCSI initiator to provide storage. </p><br><p>  View from below: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nm/iw/jd/nmiwjda1nm3pc80hwwbchs3qkb8.jpeg"></div><br><p>  Type "ex machina": </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/km/op/ttkmopre826b7yo2whpwvb69z7m.jpeg"></div><br><p>  View from above": </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v6/wx/6l/v6wx6lul1qfljdo6ieix2uyjgds.jpeg"></div><br><p>  ... And a week later the place on the first hundred ended, therefore the second storage was operatively connected. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p2/fk/gc/p2fkgcv2vhv7_9oixetmdbrrbdo.jpeg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cz/it/fe/czitfemltlreyipzqstga7kt62m.jpeg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tl/ci/ve/tlcivejohw9032qp_u1grt9jbm4.jpeg"></div><br><h2 id="hozyayke-na-zametku">  Hostess note </h2><br><p>  During the deployment process, I inevitably ran into constraints that need to be taken into account when preparing the infrastructure: </p><br><ul><li>  Edge Gateway Virtual Router can support up to 10 interfaces (see above Network Quota).  The interface can be classified as an uplink when connected to an external network and as an internal interface when connected to a VDC network.  When creating an Edge Gateway, you must specify at least one uplink.  The internal interface is added automatically when creating a routed VDC network. </li><li><p>  The total size of the storage allocated for the VDC is considered regardless of the selected model (Allocation Model) according to the <a href="https://kb.vmware.com/s/article/2043173">formula</a> : </p><br><blockquote>  Allocated to virtual machines + Total Memory Allocated to virtual machines + Memory Storage used to </blockquote><p>  Thus, the total amount of storage includes memory allocated to virtual machines.  In our configuration, 750 GB of RAM is allocated, 2 GB as internal storage for each ESXi, 100 GB as internal storage for vCenter, 16 GB as internal storage for storage1 virtual machine.  That is, a total of 750 + 2 * 4 + 100 + 16 + 2600 = 3474 GB will be allocated for VDC (see above Disk Quota). </p><br></li><li>  There is a need to enable Promiscuous Mode outside the VDC.  This is a mandatory VMware nesting requirement, which is explained as follows: <br>  Both VSS (vSphere Standard Switch) and VDS (vSphere Distributed Switch) do not implement MAC Learning, unlike traditional network switches, because the vSphere platform already knows which MAC addresses are assigned to a particular virtual machine.  This means that the virtual switch will forward network packets to the virtual machine only if the destination MAC address matches the ESXi vmnic MAC address (pNIC).  In a nested virtualization environment, the destination MAC address of network packets destined for these virtual machines will be different from the Nested ESXi vmnic MAC address.  Because of this, the virtual switch of the physical ESXi server drops the packet if Promiscuous mode is not enabled. </li><li> File storage (originally used by NFS) does not provide the disk subsystem performance required for normal operation of the platform;  block storage is recommended (that's where iSCSI came from). </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  In conclusion, I would like to note that the use of nested virtualization for Dev booth turned out to be one of the main advantages, since it allowed at the same time: </p><br><ul><li>  create an ecosystem with isolated data streams; </li><li>  do not violate the integrity of the infrastructure; </li><li>  save developers from scaling problems; </li><li>  provide full control over the child's virtual environment. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/359104/">https://habr.com/ru/post/359104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359090/index.html">How to programmer move to Cyprus</a></li>
<li><a href="../359092/index.html">Mobile-first indexing - Google's search revolution</a></li>
<li><a href="../359094/index.html">CTF from the Ministry of Education and Science: analysis of information security challenges</a></li>
<li><a href="../359096/index.html">Understanding of homogeneous space-time</a></li>
<li><a href="../359102/index.html">Selectel IPv4 prefix route leaking</a></li>
<li><a href="../359106/index.html">Work with EventSystem in Unity. Basic things in working with UI</a></li>
<li><a href="../359108/index.html">How do we hire using the bootcamp. Experience of the department of search interfaces</a></li>
<li><a href="../359110/index.html">New attack technique based on Meltdown. Using speculative instructions for detecting virtualization</a></li>
<li><a href="../359114/index.html">What is business: a conversation on concepts</a></li>
<li><a href="../359116/index.html">Reverse engineering of the device firmware on the example of a flashing "rhino". Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>