<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We get control back to Jenkins Pipeline</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jenkins Pipeline Plugin is a very handy thing to arrange for continuous software delivery. The plugin allows you to break the software delivery to the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We get control back to Jenkins Pipeline</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="https://wiki.jenkins-ci.org/display/JENKINS/Pipeline%2BPlugin">Jenkins Pipeline Plugin is a</a> very handy thing to arrange for continuous software delivery.  The plugin allows you to break the software delivery to the end user at the <strong>stage</strong> , each of which can be controlled (on which node, what and how to do) and, ultimately, visualize the delivery process.  Together with the <a href="https://jenkins.io//blog/2016/05/26/introducing-blue-ocean/">Blueocean plugin,</a> it all looks very tasty.  In real life, it sometimes happens that in addition to Jenkins, there are other systems that are involved in this process ( <strong>workflow</strong> ), and the question arises - how to integrate them with existing solutions.  An example is <strong>Jira</strong> , in which there is a certain <strong>issue</strong> falling on the tester, clicking on the interface (well, or doing other useful work), and only after blessing it, our artifact has the right to move further in the direction of the waiting client. </p><br><p>  So what are our options for implementation? </p><a name="habracut"></a><br><p>  Obviously, there are at least two of them: </p><br><ul><li>  "fall asleep" for some time and check the state in the external system ( <strong>polling</strong> ) </li><li>  use <strong>webhook</strong> to continue or cancel the movement of the artifact on the pipeline </li></ul><br><p>  The first option is at least inconvenient because you need to write a loop that will check something, do not forget to interrupt it after a certain amount of time, and, in general, polling is not the coolest method, I think.  Therefore, we will immediately look in the direction of the web hook. </p><br><p>  Having covered the documentation, I did not find the features with the name of the web hook, and this, in fact, is not very good, because what is is rather a kind of <strong>workaround</strong> than a targeted solution. </p><br><p>  We will experiment on a very simple configuration of a spherical horse in a spherical vacuum (literally we take an example from examples): </p><br><pre><code class="hljs pgsql">node { stage <span class="hljs-string"><span class="hljs-string">'Stage 1'</span></span> echo <span class="hljs-string"><span class="hljs-string">'Hello World 1'</span></span> stage <span class="hljs-string"><span class="hljs-string">'Stage 2'</span></span> echo <span class="hljs-string"><span class="hljs-string">'Hello World 2'</span></span> stage <span class="hljs-string"><span class="hljs-string">'Stage 3'</span></span> build job: <span class="hljs-string"><span class="hljs-string">'hello-task'</span></span>, parameters: [[$<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: <span class="hljs-string"><span class="hljs-string">'StringParameterValue'</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'CoolParam'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>]] }</code> </pre> <br><p>  To describe the steps of the sequence of actions, the plugin uses groovy-dsl.  In the above example, everything will be performed on one node (and this is the master, so do not do it;)).  As you can see, there are three stages of execution, two of which simply write <code>Hello World</code> to the console (which is unexpected), and the third invokes at least a simple <strong>job</strong> and passes a parameter to it, which also needs to be printed to the console. </p><br><p>  If we execute this task, we will see something similar in the logs: </p><br><pre> <code class="hljs pgsql">Started <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> [Pipeline] node Running <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> master <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /var/jenkins_home/jobs/pipeline-test/workspace [Pipeline] { [Pipeline] stage (Stage <span class="hljs-number"><span class="hljs-number">1</span></span>) Entering stage Stage <span class="hljs-number"><span class="hljs-number">1</span></span> Proceeding [Pipeline] echo Hello World <span class="hljs-number"><span class="hljs-number">1</span></span> [Pipeline] stage (Stage <span class="hljs-number"><span class="hljs-number">2</span></span>) Entering stage Stage <span class="hljs-number"><span class="hljs-number">2</span></span> Proceeding [Pipeline] echo Hello World <span class="hljs-number"><span class="hljs-number">2</span></span> [Pipeline] stage (Stage <span class="hljs-number"><span class="hljs-number">3</span></span>) Entering stage Stage <span class="hljs-number"><span class="hljs-number">3</span></span> Proceeding [Pipeline] build (Building hello-task) Scheduling project: hello-task Starting building: hello-task #<span class="hljs-number"><span class="hljs-number">2</span></span> [Pipeline] } [Pipeline] // node [Pipeline] <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Pipeline Finished: SUCCESS</code> </pre> <br><p>  Hooray, we have completed and our teams from the script, and our child task, which we defined separately. </p><br><p>  Now imagine that between the first and second stage, we need approval from the external system to continue the execution of the work.  In order to implement it, we will use the mechanism of waiting for data input by the user through the <strong>input</strong> construction.  In its simplest form, it will look like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-string"><span class="hljs-string">'Ready to go?'</span></span></code> </pre> <br><p>  By running our <strong>job</strong> again, we will see that we are now required to perform a confirming action in the interface: <br><img src="http://s33.postimg.org/flg918zzz/2016_05_31_10_30_30.png" alt="alt"></p><br><p>  But the interface is cool for those who like to click the mouse, but it does not solve our problem, so we are going to smoke <strong>API</strong> .  And then the documentation is not all right.  To understand what and how to call, you need to ask advice from people who know the <a href="https://gitter.im/jenkinsci-ru/public">subject</a> , and examine the <a href="">code</a> . </p><br><p>  Since in our example there are no parameters, you can use the <code>proceedEmpty</code> method to confirm the action.  To do this, you need to throw a <strong>POST</strong> request to the URL: </p><br><pre> <code class="hljs pgsql">JENKINS_ROOT_URL/job/JOB_NAME/BUILD_NUMBER/<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>/INPUT_ID/proceedEmpty?token=YOUR_TOKEN</code> </pre> <br><p>  The main difficulty here is precisely in getting <code>INPUT_ID</code> , because through the <strong>API</strong> I couldn‚Äôt get it, and you can understand what it is, only by parsing the page or by viewing the form submission traffic.  The good news is that the <code>INPUT_ID</code> always constant.  Bad - by default it is generated randomly and is a string of characters.  To walk and to recognize her every time is not the most fun exercise, so you must set this <strong>ID</strong> manually through the <code>id</code> property: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">input</span></span> message: <span class="hljs-string"><span class="hljs-string">'Ready to go?'</span></span>, id: <span class="hljs-string"><span class="hljs-string">'go'</span></span></code> </pre> <br><p>  Here it is worth noting that the real <strong>ID</strong> will always begin with a capital letter.  As a result, in my case, the request was as follows: </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:8080/job</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pipeline-test/</span></span><span class="hljs-number"><span class="hljs-number">16</span></span>/input/Go/proceedEmpty?token=f7614a8510b59569347714f53ab1e764</code> </pre> <br><p>  An additional key to the <strong>input</strong> mechanism is the ability to set additional parameters, which can then be used: </p><br><pre> <code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testPassParamInput</span></span></span><span class="hljs-function"> </span></span>= input( id: <span class="hljs-symbol"><span class="hljs-symbol">'testPassPara</span></span>m', message: <span class="hljs-symbol"><span class="hljs-symbol">'Pass</span></span> param?', parameters: [ [$<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-symbol"><span class="hljs-symbol">'StringParameterDefinitio</span></span>n', defaultValue: <span class="hljs-symbol"><span class="hljs-symbol">'hell</span></span>o', description: <span class="hljs-symbol"><span class="hljs-symbol">'Test</span></span> parameter', name: <span class="hljs-symbol"><span class="hljs-symbol">'testPara</span></span>m'] ])</code> </pre> <br><p>  To do this, we can define some parameter that we want to pass to the child <strong>job</strong> , in our case <code>testParam</code> .  Accordingly, we can rewrite the call to the child <strong>job</strong> so that it accepts this parameter: </p><br><pre> <code class="hljs pgsql">build job: <span class="hljs-string"><span class="hljs-string">'hello-task'</span></span>, parameters: [[$<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: <span class="hljs-string"><span class="hljs-string">'StringParameterValue'</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'CoolParam'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: testPassParamInput]]</code> </pre> <br><p>  Note that the entire object is passed to <strong>value</strong> .  If there are several parameters, you must explicitly specify which parameter to take: </p><br><pre> <code class="hljs cs">testPassParamInput[<span class="hljs-string"><span class="hljs-string">'testParam'</span></span>]</code> </pre> <br><p>  In the interface, we will now have something like this: </p><br><p><img src="http://s33.postimg.org/c4dtpz8zj/2016_05_31_10_47_48.png" alt="alt"></p><br><p>  But again, the <strong>GUI is of</strong> little interest to us and we are going to study the <strong>API</strong> further.  To forward a parameter through plain HTTP, you need to use another method: <code>proceed</code> : </p><br><pre> <code class="hljs pgsql">JENKINS_ROOT_URL/job/JOB_NAME/BUILD_NUMBER/<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>/INPUT_ID/proceed?token=YOUR_TOKEN</code> </pre> <br><p>  In this case, we need to pass the form with the parameters and their values.  To do this, first of all we will generate the correct <strong>JSON</strong> : </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"parameter"</span></span> : [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"testParam"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span> : <span class="hljs-string"><span class="hljs-string">"new cool value"</span></span> } ] }</code> </pre> <br><p>  Here <code>name</code> is the name of the parameter, and <code>value</code> its value. </p><br><p>  Now the question is how to properly convey it, and here the uninitiated begin to have problems.  Since Jenkins implements <strong>JSONP</strong> , this content is not transmitted directly in the body of the request.  Instead, it is necessary to wrap it in a form and stuff it in a <code>json</code> box.  If you do this through Postman, then the final query will look like this: </p><br><pre> <code class="hljs kotlin">----WebKitFormBoundaryE19zNvXGzXaLvS5C Content-Disposition: form-<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>; name=<span class="hljs-string"><span class="hljs-string">"json"</span></span> { <span class="hljs-string"><span class="hljs-string">"parameter"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"testParam"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span> : <span class="hljs-string"><span class="hljs-string">"new cool value"</span></span> } ] } ----WebKitFormBoundaryE19zNvXGzXaLvS5C</code> </pre> <br><p>  Not very nice, but it works.  Now in the logs we will be able to observe that the actions have indeed been confirmed by the user (in our case, by the administrator): </p><br><pre> <code class="hljs pgsql">Hello World <span class="hljs-number"><span class="hljs-number">2</span></span> [Pipeline] <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> Ready <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> go? Proceed <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Abort</span></span> Approved <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> [Pipeline] <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span> requested Approved <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> [Pipeline] stage (Stage <span class="hljs-number"><span class="hljs-number">3</span></span>) Entering stage Stage <span class="hljs-number"><span class="hljs-number">3</span></span> Proceeding [Pipeline] build (Building hello-task) Scheduling project: hello-task Starting building: hello-task #<span class="hljs-number"><span class="hljs-number">11</span></span></code> </pre> <br><p>  In the case when the external system does not give good, it needs to pull the <code>abort</code> method: </p><br><pre> <code class="hljs pgsql">JENKINS_ROOT_URL/job/JOB_NAME/BUILD_NUMBER/<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>/INPUT_ID/<span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>?token=YOUR_TOKEN</code> </pre> <br><p>  No data transfer is required.  In the logs after the execution of this request, we will see that the execution was really rejected by the user: </p><br><pre> <code class="hljs pgsql">Rejected <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> Finished: ABORTED</code> </pre> <br><p>  And finally.  Do not forget that all these requests require <strong>basic</strong> authorization, token and <strong>crumbs</strong> .  The latter can be obtained at: <code>JENKINS_ROOT_URL/crumbIssuer/api/json</code> : </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"_class"</span></span>:<span class="hljs-string"><span class="hljs-string">"hudson.security.csrf.DefaultCrumbIssuer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"crumb"</span></span>:<span class="hljs-string"><span class="hljs-string">"f4c1a2dc6a67c70e66c35c807e542f4e"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"crumbRequestField"</span></span>:<span class="hljs-string"><span class="hljs-string">"Jenkins-Crumb"</span></span> }</code> </pre> <br><p>  After that, you need to insert into the headers of the http-request a new <code>Jenkins-Crumb</code> header and its value from the <code>crumb</code> field. </p><br><h4>  Summary </h4><br><p>  In its current form, the <strong>Pipeline Plugin</strong> provides opportunities for embedding control actions from external systems, which opens up many opportunities for automating software delivery during complex and transitional implementation processes.  At the same time, I still want a more obvious and beautiful <strong>API</strong> for these actions. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302274/">https://habr.com/ru/post/302274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302264/index.html">Three approaches to building a data center from Louros Project, Keystone NAP and Iron Mountain</a></li>
<li><a href="../302266/index.html">Developer in the project management triangle</a></li>
<li><a href="../302268/index.html">Email - not a sparrow, fly out - you won't catch it or how we did email marketing with a machine</a></li>
<li><a href="../302270/index.html">ESET specialists released a tool to decrypt TeslaCrypt files</a></li>
<li><a href="../302272/index.html">HPE StoreVirtual VSA Architecture</a></li>
<li><a href="../302276/index.html">Virus living exclusively in PLC</a></li>
<li><a href="../302278/index.html">Docker Container Development with Sparrow Multipurpose Scripting System</a></li>
<li><a href="../302280/index.html">Events in Angular Light</a></li>
<li><a href="../302284/index.html">RxJS: Reactive Extension for Front End Development</a></li>
<li><a href="../302286/index.html">DUMP-2016: video of all reports in one post. Is free. Without SMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>