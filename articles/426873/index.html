<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic control using Windows registry remote access</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Support for proper, correct operation of computers and software for ordinary users - a routine of technical support staff and / or administrators. If ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic control using Windows registry remote access</h1><div class="post__text post__text-html js-mediator-article"><p>  Support for proper, correct operation of computers and software for ordinary users - a routine of technical support staff and / or administrators.  If the company is small and everyone is in one or two rooms, it is usually easy to go yourself and solve the problem or check what you need. </p><br><p>  But what if the company is large and the user is located at another site / in another city / country? </p><br><p><img src="https://habrastorage.org/webt/wt/ie/d-/wtied-3-4doen9ma6k3gbtzee2u.png" alt="image"></p><a name="habracut"></a><br><p>  One of the classic tools for this kind of work is a remote connection (using RDP, software like TeamViewer / Skype with a demonstration of the desktop, and so on).  However, it is not without fundamental flaws: </p><br><ul><li>  in any case, the end user will be distracted from his work (in some cases, even without seeing his desktop) </li><li>  these tools will not always work if there are errors on the remote computer </li><li>  installing third-party software (including proprietary software, in the case of TeamViewer) is not always welcomed by company policy </li><li>  the method is practically not automated </li></ul><br><p>  Finally, this approach is used when the incident has already occurred (it‚Äôs hard to imagine that the administrator would from time to time ‚Äúproactively‚Äù connect to each user).  That is why the control mechanism (monitoring) of remote computers is important. </p><br><p>  One possible solution is to use remote access to the Windows registry.  It stores data in the form of a hierarchical database, which allows them to be quickly received and stored compactly.  Use the registry to store their own settings and parameters as the OS and built-in services, and most third-party programs.  Therefore, the contents of the registry in many ways affects the operation of the system. </p><br><p>  Based on this, the registry may well be used as an "indicator" for control (you can detect an error if it is associated with incorrect parameters in the registry or simulate a problem situation). </p><br><p>  Another possibility that this solution gives is the possibility of administrative control of users (for example, remote reading allows you to see the facts of installing unwanted programs and making changes to settings) - do not forget about the influence of the "human factor" on the system.  In practice, this was useful in the framework of the <a href="https://skypetime.ru/">SkypeTime</a> project, where it was necessary to track the correction of settings in Skype for Business. </p><br><p><img src="https://habrastorage.org/webt/eb/jt/9l/ebjt9lhsnvxoead9su8n64gzyqq.jpeg" alt="image"></p><br><p>  But the registry contains thousands of entries, it is extremely difficult to control all of them.  Therefore, first of all, it is necessary to limit the subject of control - to determine which parameters are of interest to us and to find out which branches of the registry contain the corresponding values.  As a rule, the latter is not difficult to find in the documentation / Internet, or to determine independently based on the names of the keys. </p><br><p>  Having defined the subject of control, you can proceed to the direct configuration of remote access.  To do this, you need to activate the Remote Procedure Call service on remote computers and configure the firewall as necessary, which is convenient to do using group policies.  Taking into account the security requirements, access requires domain administrator or local administrator rights on each of the devices. </p><br><div class="spoiler">  <b class="spoiler_title">Remote Access Setup</b> <div class="spoiler_text"><p>  To activate the service itself, in the Computer Configuration&gt; Preferences&gt; Control Panel Settings&gt; Services section, set the parameters for the RpcSs service, as in a screen shot </p><br><p><img src="https://habrastorage.org/webt/oy/j8/k-/oyj8k-xbkjvb6yurtx-_ejk_0gc.jpeg" alt="image"></p><br><p>  It remains to add the appropriate Firewall exceptions.  In the same policy in the section Computer Configuration&gt; Policies&gt; Windows Settings&gt; Security Settings&gt; Windows Firewall with Advanced Security&gt; Inbound Rules we create the New Rule: <br>  Rule Type - Custom </p><br><p><img src="https://habrastorage.org/webt/s1/wo/hk/s1wohkk7ldbibzqrim7qrcki-rs.jpeg" alt="image"></p><br><p>  As the program path, specify -% SystemRoot% \ system32 \ svchost.exe <br>  From the additional settings in the Services section, we set the Apply to service with the following short name - Winmgmt </p><br><p><img src="https://habrastorage.org/webt/ef/fg/wv/effgwvovrv1eqr9btfiy-dv9dzo.jpeg" alt="image"></p><br><p>  On the following pages we set TCP without specifying specific ports and for all addresses </p><br><p><img src="https://habrastorage.org/webt/0z/-5/ef/0z-5ef-xfzxapqdbl8mln_9hu6u.jpeg" alt="image"></p><br><p><img src="https://habrastorage.org/webt/7k/y6/ks/7ky6kso0xwqyamgqb14i3uvkxxi.jpeg" alt="image"></p><br><p>  and allow connection ( <em>Allow the Connection</em> ) for a domain profile </p><br><p><img src="https://habrastorage.org/webt/ry/hg/e7/ryhge7d26xy8gjkmlneq6cqjg6w.jpeg" alt="image"></p><br><p><img src="https://habrastorage.org/webt/ui/fq/-a/uifq-aqdmohmt-omff0ctcgm1mq.jpeg" alt="image"></p></div></div><br><p>  However, manually controlling the registry of tens and hundreds of computers "manually" (even if several records are allowed) is ungrateful and meaningless.  Fortunately, this process is fairly easy to automate using scripts.  For example, the following script on PowerShell allows you to find out which user has changed the AwayThreshold and IdleThreshold parameters (the time to ‚ÄúOut of place‚Äù and ‚ÄúInactive‚Äù) for Skype for Business. </p><br><div class="spoiler">  <b class="spoiler_title">Script code</b> <div class="spoiler_text"><pre><code class="hljs mel">Param ( [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"c"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$FromFileComputers, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"r"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$OutputRPCErrorsFile, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"u"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$FromFileUsers, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"o"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$OutputFile=<span class="hljs-string"><span class="hljs-string">"output.csv"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"a"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]$MinAway, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"i"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]$MinIdle ) $RPCErrorsArray = @() $result = @() $HKU = <span class="hljs-number"><span class="hljs-number">2147483651</span></span> $RegistryForCheckArray = <span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\13.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\14.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\15.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\16.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Communicator"</span></span> $CurrentComputerNumber = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileUsers)) { $Users = Get-Content $FromFileUsers; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileComputers)) { $Comps = Get-Content $FromFileComputers; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $date = (get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span>).AddMonths(<span class="hljs-number"><span class="hljs-number">-1</span></span>) $Comps = Get-ADComputer -<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { lastlogontimestamp -ge $date } | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> name | ForEach-Object {$_.name} #$Comps = <span class="hljs-string"><span class="hljs-string">"NB_CY"</span></span> } $ServersCount = ($Comps).Count; Foreach ($Comp <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Comps) { $CurrentComputerNumber++ try { Write-Host <span class="hljs-string"><span class="hljs-string">"Checking: $Comp [$CurrentComputerNumber/$ServersCount]"</span></span>; $profiles = Get-WmiObject Win32_UserProfile -<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-string"><span class="hljs-string">"Loaded=$true and special=$false"</span></span> -ComputerName $Comp -ErrorAction Stop $reg = [wmiclass]<span class="hljs-string"><span class="hljs-string">"\\$Comp\root\default:stdregprov"</span></span> Foreach ($profile <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $profiles) { $username = Split-Path $profile.LocalPath -Leaf <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileUsers)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$Users.Contains($username)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } } Foreach( $registry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $RegistryForCheckArray) { $hkey = <span class="hljs-string"><span class="hljs-string">"$($profile.sid)\$registry"</span></span> #Write-Host <span class="hljs-string"><span class="hljs-string">"KEY: $hkey"</span></span> $away = $reg.GetDWORDValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"AwayThreshold"</span></span>).uValue $idle = $reg.GetDWORDValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"IdleThreshold"</span></span>).uValue $sip = $reg.GetStringValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"ServerSipUri"</span></span>).sValue <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($away) -and [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($idle)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(($MinAway -gt <span class="hljs-number"><span class="hljs-number">0</span></span> -and $away -lt $MinAway) -or ($MinIdle -gt <span class="hljs-number"><span class="hljs-number">0</span></span> -and $idle -lt $MinIdle)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } $result += New-Object PsObject -Property @{ <span class="hljs-string"><span class="hljs-string">"PC"</span></span> = $Comp <span class="hljs-string"><span class="hljs-string">"Username"</span></span> = $username <span class="hljs-string"><span class="hljs-string">"SIP"</span></span> = $sip <span class="hljs-string"><span class="hljs-string">"SFB_Away"</span></span> = $away <span class="hljs-string"><span class="hljs-string">"SFB_Idle"</span></span> = $idle } } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_.Exception.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"COMException"</span></span>) { $RPCErrorsArray += $Comp; } Write-Host <span class="hljs-string"><span class="hljs-string">"Error: ($_.Exception.GetType().Name)"</span></span>; $_.Exception } } $result | Export-csv -Path $OutputFile $result | Format-Table -Property PC,Username,SIP,SFB_Away,SFB_Idle -AutoSize Write-Host <span class="hljs-string"><span class="hljs-string">"Saved to: $OutputFile"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($OutputRPCErrorsFile)) { $RPCErrorsArray | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> $OutputRPCErrorsFile Write-Host <span class="hljs-string"><span class="hljs-string">"RPC errors saved to: $OutputRPCErrorsFile"</span></span> }</code> </pre> </div></div><br>  For convenience, the script can be run with parameters: <br><br>  -c path to the file with the list of hostnames of computers to be checked, if not specified - receives computers from AD with activity for 30 days. <br>  -r path to the file in which the hostname of the computers that had the RPC error will be written. <br>  -u path to the file with the list of users (login), if not specified - checks all. <br>  -o path to the file, in which the result of the script execution will be, by default output.csv. <br>  -a is the minimum value for the AwayThreshold parameter, entries with a value less than the specified value will not receive the result of the script execution. <br>  -i is the minimum value for the IdleThreshold parameter, entries with a value less than the specified one will not receive the result of the script execution. <br><br>  Further, the script launch can be automated by adding to the Task Scheduler Windows (Task Scheduler) or through the Sheduled Job functionality in PowerShell. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/426873/">https://habr.com/ru/post/426873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426853/index.html">"S in IoT Stands for Security": the world's first law on the protection of smart gadgets is adopted - we understand what the essence</a></li>
<li><a href="../426861/index.html">New hunt for dark matter passes under the mountain</a></li>
<li><a href="../426863/index.html">Available on quaternions and their benefits</a></li>
<li><a href="../426865/index.html">Understandable dashboard design for complex advertising management system</a></li>
<li><a href="../426869/index.html">How to effectively conduct videoconferencing with foreign customers</a></li>
<li><a href="../426875/index.html">The architecture of the meta-server mobile online shooter Tacticool</a></li>
<li><a href="../426879/index.html">Configuring an electrical constraint system for projects using high-speed interfaces</a></li>
<li><a href="../426881/index.html">Launch of online software for developers</a></li>
<li><a href="../426889/index.html">How to participate in machine learning competitions. Lecture in Yandex</a></li>
<li><a href="../426891/index.html">SAP Process Mining or how to understand your business processes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>