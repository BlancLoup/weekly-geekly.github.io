<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recognition of color and light level using APDS-9960</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, an article flashed on Habr.com in which, among other things, a light sensor was reported. Some time ago I found and purchased an interesting...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recognition of color and light level using APDS-9960</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/rm/ag/5g/rmag5gl-y94uucthuku5ltafn_u.jpeg" alt="image"></p><br><p>  Recently, <a href="https://habr.com/company/wirenboard/blog/423523/">an article</a> flashed on Habr.com in which, among other things, a light sensor was reported.  Some time ago I found and purchased an interesting thing - a module manufactured by RobotDyn based on the APDS-9960 sensor, which also can measure the level of illumination.  Searching and failing to find references to this device on this resource, I decided that this was a suitable occasion for writing an article. </p><br><p>  In this article, I would like in general terms to acquaint readers with the possibilities provided by this sensor and to consider in more detail how it can be used to determine color and measure the level of illumination. </p><a name="habracut"></a><br><p>  The APDS-9960 is a sensor from Avago, a combination digital sensor with a variety of interesting and useful features. <br>  He knows how to recognize gestures, determine the approximation, and he also knows how to register the intensity of the ambient light and determine the color. <br>  This is exactly what the article will discuss in this article - with the help of an old STM32VLDISCOVERY and APDS-9960, we will measure the illumination with you and will determine the color in all its richness of shades of Red, Green and Blue. </p><br><p>  However, before we get down to the practical part, let me first write a few words about the general capabilities of the APDS-9960. </p><br><p>  Functional diagram of the APDS-9960 is presented in the figure below. <br><img src="https://habrastorage.org/webt/u9/rg/-n/u9rg-nkiqgefja-ztskmzzp6bvo.jpeg" alt="image"></p><br><p>  <strong>Gesture recognition</strong> </p><br><p>  The concept of how gesture recognition on the APDS-9960 is very well shown in this <a href="https://www.youtube.com/watch%3Fv%3DA3QRyixnEl8">video</a> . </p><br><p>  The documentation describes the principle of registering gestures: <br>  For recognition of the gesture, four directional photodiodes are used which register the reflected light (in the IR range) emitted by the built-in LED. </p><br><p><img src="https://habrastorage.org/webt/2j/mf/u_/2jmfu_8tlls330xu675wtqc5ssu.jpeg" alt="image"></p><br><p>  <strong>Proximity detection function</strong> </p><br><p>  Judging by the description of all the same documentation, the detection mechanism (approximation) works on the same exact principle as gesture recognition. </p><br><p>  <strong>Color recognition and ambient light level (Color / ALS)</strong> </p><br><p>  According to the functional diagram, the sensor determines the color / level of illumination using appropriate photodiodes.  It is also stated that the APDS-9960 has built-in filters that block ultraviolet and infrared bands. <br>  Simplified, it looks like this: the signals registered by photodiodes are measured using an ADC, are buffered, and then the data is sent via i2c. </p><br><p><img src="https://habrastorage.org/webt/ta/zs/-8/tazs-8jfaap7pfma6yv_kv-a7ue.jpeg" alt="image"></p><br><p>  The graphs in the picture above are taken from the documentation on the sensor, and the spectral characteristic of Color Sense (RGBC) is shown at the top left. </p><br><p>  The photodiode RGBC signal accumulates over a period of time determined by the value of the ATIME register.  In SparkFun (in their "apds9960.h") this value is defined by the constant DEFAULT_ATIME and is equal to 219, which corresponds to 103 ms. </p><br><p>  The gain is adjustable from 1x to 64x and is determined by the setting of the CONTROL AGAIN parameter.  The constant DEFAULT_AGAIN, equal, in turn, to the value 1, which corresponds to the gain 4 times. </p><br><p>  <strong>Practical part</strong> </p><br><p>  Personally, I was only interested in the Color / ALS function in the APDS-9960, so I decided to examine it in more detail and wrote a small code demonstrating its work. <br>  I deliberately tried to make the code as compact, concise and extremely simple to understand as possible;  the entire code will be presented at the end of the article. </p><br><p>  So, all documentation (drawing, pinout and circuit diagram) for the module is available on <a href="https://robotdyn.com/gesture-sensor-apds-9960-module.html">the</a> manufacturer's <a href="https://robotdyn.com/gesture-sensor-apds-9960-module.html">website</a> . </p><br><p><img src="https://habrastorage.org/webt/gg/dy/3k/ggdy3kbub0kahc7rixcz02xzcgi.jpeg" alt="image"></p><br><p>  <strong>We connect our module APDS-9960 to STM32VLDISCOVERY</strong> </p><br><p>  The APDS9960 uses the i2c interface to communicate with the outside world, so for STM32VLDISCOVERY, we use the I2C1 bus by connecting the output of the SCL module to the PB6 leg, and the SDA output, respectively, to the PB7 leg.  Do not forget to connect the power and common wire.  Interrupts will not be used in this case, so the output of Int can not be connected.  In my photo it is connected, but not used. </p><br><p><img src="https://habrastorage.org/webt/bf/2o/ah/bf2oahfh9pfgiyvpugrsgja4voc.jpeg" alt="image"></p><br><p>  And now a little code.  Since all communication with the module is done using i2c, we will create the necessary configuration and define the read / write functions for i2c. </p><br><p>  <u>Initialization of I2C.</u> </p><br><div class="spoiler">  <b class="spoiler_title">Initialization</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">I2C1_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ I2C_InitTypeDef I2C_InitStructure; GPIO_InitTypeDef GPIO_InitStructure; RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE); RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB| RCC_APB2Periph_AFIO , ENABLE); GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD; GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6 | GPIO_Pin_7; GPIO_Init(GPIOB, &amp;GPIO_InitStructure); I2C_StructInit(&amp;I2C_InitStructure); I2C_InitStructure.I2C_ClockSpeed = <span class="hljs-number"><span class="hljs-number">100000</span></span>; I2C_InitStructure.I2C_OwnAddress1 = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; I2C_InitStructure.I2C_Ack = I2C_Ack_Enable; I2C_Init(I2C1, &amp;I2C_InitStructure); I2C_Cmd(I2C1, ENABLE); }</code> </pre> </div></div><br><p>  <u>Reading the register.</u> </p><br><div class="spoiler">  <b class="spoiler_title">Register value read function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> i2c1_read(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> addr) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> data; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); I2C_GenerateSTART(I2C1, ENABLE); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>, I2C_Direction_Transmitter); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)); I2C_SendData(I2C1, addr); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_GenerateSTART(I2C1, ENABLE); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>, I2C_Direction_Receiver); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_RECEIVED)); data = I2C_ReceiveData(I2C1); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_RECEIVED)); I2C_AcknowledgeConfig(I2C1, DISABLE); I2C_GenerateSTOP(I2C1, ENABLE); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }</code> </pre></div></div><br><p>  <u>Writing value to register</u> </p><br><div class="spoiler">  <b class="spoiler_title">The function of writing values ‚Äã‚Äãto the register</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i2c1_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data)</span></span></span><span class="hljs-function"> </span></span>{ I2C_GenerateSTART(I2C1, ENABLE); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>, I2C_Direction_Transmitter); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)); I2C_SendData(I2C1, addr); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_SendData(I2C1, data); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_GenerateSTOP(I2C1, ENABLE); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)) {}; }</code> </pre> </div></div><br><p>  In order for the module to work properly, it must first be properly configured.  Specifically, for color recognition and lighting it is necessary to do the following: </p><br><p>  1) Determine the ATIME register.  By default, when starting the module, the ATIME register is set to 0xFF and if nothing is changed, this will affect the sensitivity of the sensor - the sensitivity will be low. </p><br><pre> <code class="cpp hljs">i2c1_write(APDS9960_ATIME, DEFAULT_ATIME);</code> </pre> <br><p>  2) the next step is to set the AGAIN parameter field (ALS and Color Gain Control) of the Control Register One register (0x8F) to the value corresponding to the gain equal to x4 (DEFAULT_AGAIN equal to AGAIN_4X). </p><br><pre> <code class="cpp hljs">i2c1_write(APDS9960_CONTROL, DEFAULT_AGAIN);</code> </pre> <br><p>  3) Enable the ALS option by setting the AEN bit of the Enable Register register (0x80) <br>  4) turn on the module power supply by setting the PON bit of the same register </p><br><p>  so here: </p><br><pre> <code class="cpp hljs">i2c1_write(APDS9960_ENABLE, (APDS9960_PON | APDS9960_AEN));</code> </pre> <br><p>  That's the whole setup.  Our sensor is ready for work and defense, you can begin to measure all the colors. </p><br><p>  But first, measure the light level </p><br><pre> <code class="cpp hljs">Colour_tmpL = i2c1_read(APDS9960_CDATAL); Colour_tmpH = i2c1_read(APDS9960_CDATAH); Colour_Clear = (Colour_tmpH &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) + Colour_tmpL;</code> </pre> <br><p>  And now our business has come to the long-awaited flowers </p><br><div class="spoiler">  <b class="spoiler_title">Get the RGB data</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//_________________________________________________________________________ // RED color Recognize: Colour_tmpL = i2c1_read(APDS9960_RDATAL); Colour_tmpH = i2c1_read(APDS9960_RDATAH); Colour_Red = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; //_________________________________________________________________________ // GREEN color Recognize: Colour_tmpL = i2c1_read(APDS9960_GDATAL); Colour_tmpH = i2c1_read(APDS9960_GDATAH); Colour_Green = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; //_________________________________________________________________________ // BLUE color Recognize: Colour_tmpL = i2c1_read(APDS9960_BDATAL); Colour_tmpH = i2c1_read(APDS9960_BDATAH); Colour_Blue = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL;</span></span></code> </pre></div></div><br><p>  And now the whole code: </p><br><div class="spoiler">  <b class="spoiler_title">main.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f10x.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_I2C_ADDR 0x39 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_ATIME 0x81 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_CONTROL 0x8F #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_ENABLE 0x80 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_CDATAL 0x94 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_CDATAH 0x95 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_RDATAL 0x96 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_RDATAH 0x97 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_GDATAL 0x98 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_GDATAH 0x99 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_BDATAL 0x9A #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_BDATAH 0x9B </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Bit fields */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_PON 0x01 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_AEN 0x02 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_PEN 0x04 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_WEN 0x08 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APSD9960_AIEN 0x10 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_PIEN 0x20 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_GEN 0x40 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> APDS9960_GVALID 0x01 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* ALS Gain (AGAIN) values */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AGAIN_1X 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AGAIN_4X 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AGAIN_16X 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AGAIN_64X 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEFAULT_ATIME 219 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 103ms #define DEFAULT_AGAIN AGAIN_4X uint8_t Colour_tmpL = 0; uint8_t Colour_tmpH = 0; uint16_t Colour_Clear = 0; uint16_t Colour_Red = 0; uint16_t Colour_Green = 0; uint16_t Colour_Blue = 0; //----------------------------------------------------------------------- void I2C1_init(void) { I2C_InitTypeDef I2C_InitStructure; GPIO_InitTypeDef GPIO_InitStructure; RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE); RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB| RCC_APB2Periph_AFIO , ENABLE); GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD; GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6 | GPIO_Pin_7; GPIO_Init(GPIOB, &amp;GPIO_InitStructure); I2C_StructInit(&amp;I2C_InitStructure); I2C_InitStructure.I2C_ClockSpeed = 100000; I2C_InitStructure.I2C_OwnAddress1 = 0x01; I2C_InitStructure.I2C_Ack = I2C_Ack_Enable; I2C_Init(I2C1, &amp;I2C_InitStructure); I2C_Cmd(I2C1, ENABLE); } //----------------------------------------------------------------------- uint8_t i2c1_read(uint8_t addr) { uint8_t data; while(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); I2C_GenerateSTART(I2C1, ENABLE); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;1, I2C_Direction_Transmitter); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)); I2C_SendData(I2C1, addr); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_GenerateSTART(I2C1, ENABLE); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;1, I2C_Direction_Receiver); while(!I2C_CheckEvent(I2C1,I2C_EVENT_MASTER_BYTE_RECEIVED)); data = I2C_ReceiveData(I2C1); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_RECEIVED)); I2C_AcknowledgeConfig(I2C1, DISABLE); I2C_GenerateSTOP(I2C1, ENABLE); while(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); return data; } //----------------------------------------------------------------------- void i2c1_write(uint8_t addr, uint8_t data) { I2C_GenerateSTART(I2C1, ENABLE); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); I2C_Send7bitAddress(I2C1, APDS9960_I2C_ADDR&lt;&lt;1, I2C_Direction_Transmitter); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)); I2C_SendData(I2C1, addr); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_SendData(I2C1, data); while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED)); I2C_GenerateSTOP(I2C1, ENABLE); while(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)) {}; } //----------------------------------------------------------------------- int main() { I2C1_init(); i2c1_write(APDS9960_ATIME, DEFAULT_ATIME); i2c1_write(APDS9960_CONTROL, DEFAULT_AGAIN); i2c1_write(APDS9960_ENABLE, (APDS9960_PON | APDS9960_AEN)); while (1) { Colour_Clear = 0; Colour_Red = 0; Colour_Green = 0; Colour_Blue = 0; //_________________________________________________________________________ // Ambient Light Recognize: Colour_tmpL = i2c1_read(APDS9960_CDATAL); Colour_tmpH = i2c1_read(APDS9960_CDATAH); Colour_Clear = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; //_________________________________________________________________________ // RED color Recognize: Colour_tmpL = i2c1_read(APDS9960_RDATAL); Colour_tmpH = i2c1_read(APDS9960_RDATAH); Colour_Red = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; //_________________________________________________________________________ // GREEN color Recognize: Colour_tmpL = i2c1_read(APDS9960_GDATAL); Colour_tmpH = i2c1_read(APDS9960_GDATAH); Colour_Green = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; //_________________________________________________________________________ // BLUE color Recognize: Colour_tmpL = i2c1_read(APDS9960_BDATAL); Colour_tmpH = i2c1_read(APDS9960_BDATAH); Colour_Blue = (Colour_tmpH &lt;&lt; 8) + Colour_tmpL; } }</span></span></span></span></code> </pre></div></div><br><p>  I deliberately did not make the definitions of the constants in a separate heder for convenience. <br>  Constants, by the way, borrowed from the official repository of SparkFun Electronics.  <a href="">From here</a> . </p><br><p>  I liked the APDS-9960 very much - an interesting thing, it was interesting to explore, it was interesting to write an article.  I hope someone this material will be useful.  Thanks for attention. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/423847/">https://habr.com/ru/post/423847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423835/index.html">Expanding the formula X - index of the quality of the site Yandex</a></li>
<li><a href="../423837/index.html">How to quickly ruin any project? 17 top bad tips</a></li>
<li><a href="../423839/index.html">sha256 tooth test for neural network</a></li>
<li><a href="../423843/index.html">If you are in Kazan or Novosibirsk and you want to design chips like in Cupertino</a></li>
<li><a href="../423845/index.html">Corporate condom</a></li>
<li><a href="../423851/index.html">Introducing the new plugin for Grafana - Statusmap panel</a></li>
<li><a href="../423853/index.html">How S3 DataLine Storage is arranged</a></li>
<li><a href="../423855/index.html">Zyxel Nebula - ease of management as the basis for savings</a></li>
<li><a href="../423857/index.html">6 problems that you will encounter while learning programming yourself</a></li>
<li><a href="../423861/index.html">Solar lanterns - we need brighter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>