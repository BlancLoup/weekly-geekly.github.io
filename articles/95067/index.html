<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using XPath to refer to object references</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This topic talks about the possibility of using XPath to select objects from the database in cases when using SQL is undesirable. 

 Formulation of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using XPath to refer to object references</h1><div class="post__text post__text-html js-mediator-article">  This topic talks about the possibility of using XPath to select objects from the database in cases when using SQL is undesirable. <br><a name="habracut"></a><br><h4>  Formulation of the problem </h4><br>  In many systems, for various purposes it is often required to select objects from the database as the values ‚Äã‚Äãof various fields.  For example, select a supplier of goods from the list.  This is part of the system user interface. <br><br>  However, besides users, the system has programmers, tuning engineers, designers, etc., who also sometimes need to tell the system which objects to select.  For example, it is possible that after selecting a supplier‚Äôs city, it is necessary to limit the list of suppliers.  For this, the programmer usually writes the corresponding SQL, for example, ‚ÄúSELECT id, name FROM agents WHERE city =?‚Äù.  That is, SQL is used to tell the system which objects to select from the database. <br><br>  Most often, this choice is part of the system source code.  Hidden in PHP or in Java code (or, better, in SQL bundles or in stored procedures) such code looks familiar.  But sometimes the filter becomes not part of the source code, but part of the system setup that the system engineer or layout designer XSLT / HTML produces. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Example 1: Enterprise Management System.  There is a list of objects "Employee" and a list of objects "Office".  It is necessary to add an office selection field to the ‚ÄúEmployee‚Äù object, while showing the list of offices in the same country where the employee is registered.  The usual way is to write the corresponding SQL filter to the ‚ÄúOffice employee‚Äù attribute properties of the ‚ÄúEmployee‚Äù class.  This SQL takes, for example, the input of an employee ID and calculates the corresponding list of offices. <br><br>  Example 2: A content management system based on XSLT.  An object is selected from the database (for example, an article), XML is built, after which the XSLT transform produces HTML and is given to the client.  However, often, apart from the text of the article itself, additional elements should be attached to XML - for example, a list of other articles in the section for quick navigation.  Or even a list of sections of the current site, if the design allows you to change it through the control system.  To select the corresponding objects one could use the same SQL, taking as arguments the ID of the current object (article). <br><br>  Using SQL in such examples has the following disadvantages: <br>  1) A system engineer who is not familiar with Java / PHP / .NET should still know SQL <br>  2) The engineer must know the internal structure of the system tables. <br>  3) Using SQL for such settings of the application "freezes" the structure of the tables, making it part of the public API <br>  4) This SQL has the right to read at least all the data from the relevant tables.  Restricting rights to an application without using row-level security is unrealistic. <br><br>  Therefore, in Arp.Site, another method of indication is used to select objects from template texts.  Since XSLT is mainly used for templates, it was most logical to use the technology that is closest to XML.  Namely XPath. <br><br>  XPath allows you to select objects from the <i>tree</i> (more precisely, from an acyclic oriented graph), taking into account <i>predicate</i> constraints.  Writing expressions to XPath is more compact and more comprehensible than in SQL. <br><br>  Example 1: <code>//[@=$/@]</code> <br>  Example 2: <code>//folder[@active='true']/article</code> - to select articles from the same section.  <code>//site[@active='true']/folder</code> - to select sections of the current site. <br><br><h4>  Technical implementation </h4><br>  For implementation it is possible to use two approaches: interpretation and compilation. <br><br>  Interpretation is the construction of a real (for very small sites) or a virtual (for large systems) DOM tree of objects and ‚Äúfeeding‚Äù to an XPath engine of the XPath expression itself and the root (or current object) of the DOM tree.  The result of the execution is a pointer to another object (or NodeList) of the DOM tree, which is converted into a set of system IDs. <br><br>  Benefits: <br>  - the fastest way to implement "from scratch" <br>  - the most understandable, if there are no optimizations aimed at accelerating <br><br>  disadvantages <br>  - the most brake way, if each operation of transition on a tree will demand the appeal to a database <br>  - It is very difficult to do execution optimization. <br><br>  What is optimization and why are they needed?  Example: <br>  - part of the XPath expression is, for example, <code>//article[@name='123']</code> .  Any XPath processor will go through the entire tree of objects, and for each will compare its type (article), as well as the presence of the <a href="https://geektimes.ru/users/name/" class="user_link">name</a> property and its equality to the value '123'.  The presence of optimizations makes it possible to replace all such operations, with, for example, one operation of selecting all the articles whose names are equal to '123'. <br>  - XPath expression <code>//*[@active='true']</code> should select the list of ‚Äúcurrent‚Äù objects - site, section, subsection, article (for building the navigation path).  However, enumeration of all objects on the tree is undesirable, therefore these expressions should also be optimized. <br><br>  Arp.Site uses the Apache Commons JXPath library for interpretation.  This library accepts any object as an input (bin, DOM node, JDOM node, etc), or any arbitrary if you explain to the library how to get properties and child objects from this object.  Also, this library allows you to replace some standard handlers with your own.  For example, replace the Step handler for Axis = DESCENDANT_OR_SELF (XPath operation "//") with your optimized one. <br><br>  The input of the library is the object associated with the information tree object.  If necessary, information about its descendants is loaded from the database. <br><br><h5>  SQL Compilation </h5><br>  The second approach was the preliminary compilation of XPath to SQL, after which it was cached for the future and executed. <br><br>  Benefits <br>  - significant acceleration due to the uniqueness of the SQL database query <br><br>  disadvantages <br>  - it is much more difficult to write code, you need to keep track of all used table alias, return values, correctly handle various predicates. <br>  - Work on building SQL comes down to working on strings <br>  - a significant number of optimizations are required to simplify and speed up SQL <br><br>  An example of optimization.  Suppose we have XPATH <code>//site[@active='true']/folder</code> .  Without SQL optimization, it could look like this: <br>  <code>SELECT f.id FROM objects f, objects s WHERE s.id=f.parent AND s.class='site' AND f.class='folder' AND s.id IN (1,4,73,423)</code> (where 1, 4,73,423 - a list of "current" objects). <br>  However, the system can use the following hints: <br>  - site in the object tree cannot be a descendant of site (i.e. it is only one in the list of current objects) <br>  - site exactly is in the database <br>  - its id is "1" <br>  then SQL can obviously be rewritten as <br> <code>SELECT f.id FROM objects f WHERE f.parent=1 f.class='folder'</code> <br> <br>  There are a lot of similar optimizations, although most of them are system-specific. <br><br>  Examples of compilations in SQL: <br><ul><li> <code>//site[@ active='true']/*[@active='true']/*[@state='published']</code> <br> <code>SELECT t7.id FROM struct_cells t7, registry_objects t8 WHERE t7.obj=t8.id AND t7.erased=0 AND t8.erased=0 AND t8.state=2 AND t7.state=3 AND t7.parent=360965</code> </li> <li> <code>//*[@current='true']/*[@state='published'] | //*[@current='true']/*[@state='published']/file[@state='published' or @state='archived']</code> <br> <code>(SELECT t4.id FROM struct_cells t4, registry_objects t5 WHERE t4.obj=t5.id AND t4.erased=0 AND t5.erased=0 AND t5.state=2 AND t4.state=3 AND t4.parent=1) UNION (SELECT t13.id FROM struct_cells t13, registry_objects t14, struct_cells t10, registry_objects t11 WHERE t13.obj=t14.id AND t13.erased=0 AND t14.erased=0 AND t14.class=10 AND (t14.state=2 AND t13.state IN (3,4)) AND t10.obj=t11.id AND t10.erased=0 AND t11.erased=0 AND t11.state=2 AND t10.state=3 AND t10.parent=1 AND t13.parent=t10.id))</code> </li> </ul><br><br><h5>  Compilation in JPAQL </h5><br>  The third approach, developed after the appearance of JPA 2.0, which included the CriteriaQuery API, is to build a query using the corresponding API without direct operations with query strings. <br><br>  Benefits <br>  - significant simplification of query building code <br>  - getting rid of typo errors <br>  - the code will work on any database supported by JPA <br><br>  disadvantages <br>  - a significant number of optimizations are required to simplify and speed up EJBQL <br>  - slight deceleration due to possible non-optimized translator code EJBQL -&gt; SQL <br>  - a significant slowdown due to the need to emulate functions like UNION that are missing in EJBQL. <br>  - the lack of support for some operations, for example, limit / row_number in CriteriaQuery, makes it impossible to support position-predicates, for example, <code>//site/folder[2]</code> . <br><br>  Examples of compilations in JPAQL: <br><ul><li> <code>//site[@active='true']/*[@active='true']/*[@state='published']</code> <br> <code>SELECT t0.id <br> FROM ru.arptek.arpsite.content.Cell as t1, ru.arptek.arpsite.content.Cell as t0 <br> INNER JOIN t0.webObject as t2 <br> WHERE ( t1.parent.id=360930 ) and ( t1.erased=0 ) and ( t1.id in (360965, 360930, 417026, 124316, 63316, 1) ) and ( t1.id=t0.parent.id ) and ( t0.erased=0 ) and ( t2.erased=0 ) and ( ( t2.stateId=2 ) and ( t0.stateId=3 ) )</code> </li> <li> <code>//*[@current='true']/*[@state='published'] | //*[@current='true']/*[@state='published']/file[@state='published' or @state='archived']</code> <br> <code>SELECT t0.id <br> FROM ru.arptek.arpsite.content.Cell as t0 <br> WHERE ( exists ( <br> SELECT 1 <br> FROM ru.arptek.arpsite.content.Cell as t1 <br> INNER JOIN t1.webObject as t2 <br> WHERE ( t1.parent.id=1 ) and ( t1.erased=0 ) and ( t2.erased=0 ) and ( ( t2.stateId=2 ) and ( t1.stateId=3 ) ) and ( t0=t1 )) ) or ( exists ( <br> SELECT 1 <br> FROM ru.arptek.arpsite.content.Cell as t3, ru.arptek.arpsite.content.Cell as t4 <br> INNER JOIN t3.webObject as t5 <br> INNER JOIN t4.webObject as t6 <br> WHERE ( t4.parent.id=1 ) and ( t4.erased=0 ) and ( t6.erased=0 ) and ( ( t6.stateId=2 ) and ( t4.stateId=3 ) ) and ( t4.id=t3.parent.id ) and ( t3.erased=0 ) and ( t5.erased=0 ) and ( t5.objectClassId=10 ) and ( ( t5.stateId=2 ) and ( t3.stateId in (3, 4) ) ) and ( t0=t3 )) )</code> </li> </ul><br><br><h4>  Legal notice </h4><br>  This idea has been used in Arp.Site since 2002 and has only undergone technological changes (interpretation, compilation in SQL, compilation in JPAQL).  I have no direct relation to the implementation of this idea from my other employers (although I helped with tips), so the content of this topic does not fall under the relevant NDA.  Due to the presence of prior art, this technology cannot be protected by patents dated after 2002.  The presence of earlier patents has not been investigated. <br><br>  The author of the initial implementation is Timofey Sysoev, the introduction of compilation technology for SQL and for JPAQL is yours truly. </div><p>Source: <a href="https://habr.com/ru/post/95067/">https://habr.com/ru/post/95067/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../95061/index.html">therules.ru - rules of the Russian language with a very smart search</a></li>
<li><a href="../95063/index.html">10 things that are never taught to programmers in universities</a></li>
<li><a href="../95064/index.html">Tax and Freelancers</a></li>
<li><a href="../95065/index.html">Flash Destroyer: a device for destroying flash drives</a></li>
<li><a href="../95066/index.html">Launch of national SMS billing AltSMS</a></li>
<li><a href="../95068/index.html">New Tariffs of CSO Ukrtelecom in Kiev</a></li>
<li><a href="../95069/index.html">PlayStation 3 3D games will be available June 10th</a></li>
<li><a href="../95070/index.html">Will smart homes of the future be built on the basis of Intel Atom?</a></li>
<li><a href="../95073/index.html">Hero - Firmware VillainROM 6.2 (Android 2.1)</a></li>
<li><a href="../95074/index.html">Two sims for one</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>