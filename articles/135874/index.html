<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another way to update torrents</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On one tracker, I am an active sider. But when it comes time to update the distribution, horror begins for me: some distributions have different names...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another way to update torrents</h1><div class="post__text post__text-html js-mediator-article">  On one tracker, I am an active sider.  But when it comes time to update the distribution, horror begins for me: some distributions have different names in the torrent client and on the tracker, there are a lot of distributions with the same name on the tracker, and it is very difficult to look for any particular distribution.  In addition, I do not have so much time to engage in such a routine matter.  Therefore, I needed a small script that would update the distributions in the client, if they were updated on the tracker. <br><br><a name="habracut"></a><br><h4>  What to do? </h4><br>  I was faced with the task: to find some ready-made solution, or try to write the necessary script myself.  On Habr√© met ways, in some way performing my task, but the method either did not suit me, or I didn‚Äôt quite like it.  At the same time, I never wrote programs or even scripts, so I liked the version of my own handwritten script even more.  First I had to choose a tool, a language that would be easy to learn and dive into programming, and my attention was drawn to python. <br><br>  I immediately liked Python.  It seems that it gives a certain "ease" in writing code.  As the first python reading matter, I chose Mark Lutz‚Äôs book, Learning Python (4th edition).  Well, there is a tool, some kind of help in the form of a book, let's go! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Problem statement and its solution </h4><br>  So, first you need to determine that the torrent file in our client (in this case we mean uTorrent 2.2) is outdated and you need to download a new one.  The first thing I could think of was page parsing and comparison with data in a torrent file.  This method worked, but it had a huge minus in speed: a hundred pages parsing, and this is the limit of the distribution on the tracker, took about three minutes.  In addition, it was necessary to compare all the distribution options with the result of the page parsing, and this also took a lot of time.  This method worked without failures, but I didn‚Äôt particularly like it, so I continued to search for all sorts of solutions to the problem. <br><br>  Soon, after much deliberation and searching, I learned about such a thing as scrape.  Scrape, as Wikipedia says, is an additional client request protocol to the tracker, in which the tracker tells the client the total number of seeds and peers in the hand.  With a scrape request, you can easily find out if a distribution exists or not.  Also scrape-request is sent by clients more often than announce.  But you need to know whether a particular tracker supports this protocol or not.  To my luck, my tracker supports it.  A scrape request is sent using the GET method with a header, and this is how the address to which the request goes: <br><blockquote><code>htt://example.com/scrape.php?info_hash=aaaaaaaaaaaaaaaaaaaa</code> </blockquote> <br>  The hash is unique for each distribution, it includes 20 characters and can be obtained from the resume.dat file.  But before getting information, you need to know that this file, like files with the extension .torrent and settings.dat, is presented in bencode format.  If you need to decrypt the file quickly and without recesses in the encoding method, then you should download a special package for python <a href="">here</a> . <br><br>  Let's proceed to decrypt the file: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import urllib2 from urllib import urlencode from binascii import b2a_hex as bta, a2b_hex as atb from os import remove from shutil import move from lxml.html import document_fromstring as doc from bencode import bdecode, bencode from httplib2 Http http = Http() username = 'username' password = 'password' ut_port = '12345' #  web-  uTorrent'. ut_username = 'utusername' ut_password = 'utpassword' site = 'http://example.com/' scrape_body = site + 'scrape.php?info_hash=' # URL scrape-. login_url = site + 'takelogin.php' torrent_body = site + 'download.php?id={0}&amp;name={0}.torrent' announce = site + 'announce.php?' # URL  . webui_url = 'http://127.0.0.1:{0}/gui/'.format(ut_port) webui_token = webui_url + 'token.html' #   .torrent .    settings.dat,  dir_torrent_files. torrent_path = 'c:/utorrent/torrent/' #      . autoload_path = 'c:/utorrent/autoload/' #     uTorrent'a (   resume.dat) sys_torrent_path = 'c:/users/myname/appdata/utorrent/' def authentication(username, password): data = {'username': username, 'password': password} headers = {'Content-type': 'application/x-www-form-urlencoded', 'User-agent':'Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.0.6'} resp, login = http.request(login_url, 'POST', headers=headers, body=urlencode(data)) #   ,    cookiekeys = ['uid', 'pass', 'PHPSESSID', 'pass_hash', 'session_id'] split_resp = resp['set-cookie'].split(' ') lst = [] #          . for split_res in split_resp: if split_res.split('=')[0] in cookiekeys: lst.append(split_res) cookie = ' '.join(lst) return {'Cookie': cookie} def torrentDict(torr_path): #torr_path    -   resume.dat . Dict = {} with open(u'{0}resume.dat'.format(torr_path), 'rb') as resume: t = bdecode(resume.read()) for name in t: if name != '.fileguard' and name != 'rec': for tracker in t[name]['trackers']: if isinstance(tracker, str) and tracker.startswith(announce): Dict[name.split('\\')[-1]] = bta(t[name]['info']) return Dict</span></span></code> </pre><br>  Now we have a dictionary with names and hashes of distributions.  Now we can only send scrape-requests with a substituted and modified hash and check whether there is a distribution with such a hash on the tracker or it is no longer there.  Also, do not forget that you need to make such a request on behalf of the client, otherwise the tracker will refuse access. <br><br><pre> <code class="python hljs">uthead = {<span class="hljs-string"><span class="hljs-string">'User-Agent'</span></span>:<span class="hljs-string"><span class="hljs-string">'uTorrent/2210(21304)'</span></span>} <span class="hljs-comment"><span class="hljs-comment">#   uTorrent'. main_dict = torrentDict(sys_torrent_path) for key in main_dict: lst = [] for i in range(0, len(main_dict[key]), 2): lst.append('%{0}'.format(main_dict[key][i:i+2].upper())) scrp_str = ''.join(lst) # ,     . resp, scrp = http.request('{0}{1}'.format(scrape_body, scrp_str), 'GET', headers=uthead)</span></span></code> </pre><br><br>  The usual response to a query is: <br><blockquote> <code>d5:filesd20: <b>aaaaaaaaaaaaaaaaaaaa</b> d8:completei <b>5</b> e10:downloadedi <b>50</b> e10:incompletei <b>10</b> eeee</code> </blockquote>  20 characters ‚Äúa‚Äù is a hash of distribution, 5 are siders, 10 are leechers and 50 have finished downloading. <br>  If the distribution does not exist, the response to the request takes the form: <br><blockquote> <code>d5:filesdee</code> </blockquote> <br>  The response to the request is also presented in bencode format, but we do not need to decrypt it, you can simply compare the resulting string with the string returned if there is no distribution on the tracker with such a hash. <br>  Next you need to download our file from the tracker, put it in the client's startup folder and, if possible, delete the record about the outdated torrent in the client itself. <br>  From the tracker just download the file does not work: need authorization.  The function itself is described above under the heading ‚Äúauthentication‚Äù.  And then we log in, download the file, put it in the startup folder and delete the old .torrent file from the folder with the torrents. <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment">#        "for key in Dict:". with open('{0}{1}'.format(torrent_path, key), 'rb') as torrent_file: torrent = bdecode(torrent_file.read()) t_id = torrent['comment'][36:] #        . brhead = authentication(username, password) resp, torrent = http.request(torrent_body.format(t_id), headers=brhead) with open('{0}.torrent'.format(t_id),'wb') as torrent_file: torrent_file.write(torrent) #   .torrent       . remove('{0}{1}'.format(torrent_path, key)) move('{0}.torrent'.format(t_id), '{0}{1}.torrent'.format(autoload_path, t_id)) #     .   . authkey, token = uTWebUI(ut_username, ut_password) webuiActions(main_dict[key], 'remove', authkey, token)</span></span></code> </pre><br><br>  So that a non-existent .torrent file does not confuse us with its record in the client, it should be removed from the client.  But uTorrent is designed in such a way that editing resume.dat, namely, information about all the torrents is stored, when the client is running, it will not give the result: uTorrent will restore resume.dat the way it remembers at startup.  Therefore, for such a case, you need to constantly turn off uTorrent, edit resume.dat, turn on uTorrent.  Such a method would be suitable for one changed distribution per day, and what if the distribution changes in batches, i.e.  several at once?  At first, being far from programming as a whole, I thought that I would have to work with processes directly, which is very difficult for me.  But then I learned about the existence of uTorrent WebUI.  WebUI has an API, the documentation for which is on the <a href="http://www.utorrent.com/community/developers/webapi">official site</a> .  Thanks to the capabilities of the WebUI API, you can delete the record, and not only delete the torrent from the client.  First we need to get a cookie with a special password and token.  The second we need if the parameter webui.token_auth in the client is activated. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uTWebUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ut_name, ut_passw)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#  cookie  token. passmgr = urllib2.HTTPPasswordMgrWithDefaultRealm() passmgr.add_password(None, webui_token, ut_name, ut_passw) authhandler = urllib2.HTTPBasicAuthHandler(passmgr) opener = urllib2.build_opener(authhandler) urllib2.install_opener(opener) req = urllib2.Request(webui_token) tkp = urllib2.urlopen(req) page = tkp.read() token = doc(page).xpath('//text()')[0] passw = req.unredirected_hdrs['Authorization'] return passw, token def webuiActions(torrent_hash, action, password, token): head = {'Authorization': password} if action == 'remove': #       . action_req = '?token={0}&amp;action=remove&amp;hash={1}'.format(token, torrent_hash) r, act = http.request(webui_url+action_req, headers=head)</span></span></code> </pre><br><br>  In uTorrent, the authorization in the web-interface is not implemented in the same way as on the site, so simple data sending will not work.  Then we get the token and together with it we perform some function in the client.  Of course, it would be possible to allocate a class for actions in the client, but I considered that the usual function would be enough for that. <br>  (Note: Unfortunately, my knowledge at the moment was not enough to properly log in to the web interface, so I used the method described on the Internet.) <br><br><h4>  What is the result </h4><br>  As a result, I received a script that satisfies my need, a little knowledge and a lot of pleasure: it is very fun to sit on the code until the morning, and then, when you lie down to sleep, understand what the snag was. <br><br>  I hope this method will be able to help someone. <br><br>  <b>UPD: I</b> wildly apologize for my carelessness: I brought the code into a more readable form before publication, as a result of which I myself got confused and confused you. <br>  The code is uploaded to <a href="https://github.com/walkmanake/Torrents-autoupdate">Github</a> .  I work with him for the first time, so if I did something wrong, contact me. </div><p>Source: <a href="https://habr.com/ru/post/135874/">https://habr.com/ru/post/135874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135865/index.html">Coder vs. Developer vs. Engineer - what's your Job Title,% username%?</a></li>
<li><a href="../135866/index.html">My view on icon design</a></li>
<li><a href="../135870/index.html">In response to the article: ‚ÄúWho teaches whom: a teacher of a student or a student of a teacher?‚Äù</a></li>
<li><a href="../135872/index.html">Read the code, the compiler handles the rest.</a></li>
<li><a href="../135873/index.html">Cloud statistics</a></li>
<li><a href="../135875/index.html">Re: My view on icon design</a></li>
<li><a href="../135876/index.html">New Habr's record: article with a rating of +13 - among the best in 24 hours</a></li>
<li><a href="../135878/index.html">Instagram filters like Photoshop Actions</a></li>
<li><a href="../135880/index.html">To begin, reboot</a></li>
<li><a href="../135881/index.html">How to put your products on the show like PMA / CES?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>