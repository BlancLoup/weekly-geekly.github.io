<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My experience of creating "without smart" at home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My time has come and will share their experience of creating a "without smart" home. To enter into polemics, what is all the same such a smart home an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My experience of creating "without smart" at home</h1><div class="post__text post__text-html js-mediator-article">  My time has come and will share their experience of creating a "without smart" home.  To enter into polemics, what is all the same such a smart home and what he should be able to do is not very desirable.  In my case, we will tame the wifi Sonoff modules from ITEAD and learn how to turn the load on / off from the phone.  The publication will discuss how to flash the module, connect the temperature / humidity sensor to the module, learn how to control the module through the HomeKit (Home) application and Siri.  Add to all this Domoticz home control system on a raspberry pi.  Add wifi to the coffee machine and teach Siri to open the intercom. <br><a name="habracut"></a><br>  I ordered three normal sonoff modules and one SV (Safe Voltage) for testing.  At the time of ordering, the usual 4.85 eternally green module is for stock, although the stock looks indefinite.  SV at a similar price of 4.85.  With delivery to Ukraine, the total cost was 26 green.  China is in China; it is in Africa; the money has gone, but the goods still need to wait three weeks, maybe more.  Of course, it was possible to buy in Ukraine and not to wait, but then a little more expensive. <br><br><h2>  The joy of the first steps on the path of "without smart" home </h2><br>  Four modules arrived, the usual ones are packed in boxes, and the SV is simply in an antistatic bag.  The case and size pleased. <br><br><img src="https://habrastorage.org/web/b03/b90/90e/b03b9090e5f2437fa0fc84260c747fff.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The process of installing native e-Welink software and connecting the module to the home network will not be described, instructions in any languages ‚Äã‚Äãon the Internet, take it ‚Äî I don‚Äôt want to. <br><br>  Without thinking, we go into the corridor and add this module to the ceiling lamp.  The module is small, there is a lot of space in the lamp.  In the corridor, the light is often left on and now you can turn off the light while lying in bed in front of the TV.  The apartment has already been renovated everywhere and installed regular switches.  Repair does not touch and use the existing wiring. <br><br>  It turns out the following logic of work: <br><br>  - The switch is off, the module does not work either; <br>  - The switch is on, the light can be turned off from the application; <br>  - The switch is turned on and the light is turned off through the application, then to turn on the light, you must turn off / on the switch, having previously set ON (when the module is turned on the relay is open) in the ‚Äúpower supply in the area‚Äù module settings and the light turns on. <br><br>  We are happy. <br><br>  The second module is added to the lamp in the bedroom.  Here the lamp is not so spacious was in the hallway.  I had to cut the body a little and reduce / cut the button, did not fit in height.  After that, the module is neatly hidden in the lamp. <br><br><h3>  Remaking the switch under the button </h3><br>  The apartment is installed switches Schneider series Unica.  To alter such a switch, you can install a spring under the key and the place is already prepared in advance. <br><br>  As they say on the Internet, you can try a spring from ballpoint pens.  My attempts to install a spring from a ballpoint pen did not succeed.  Very weak spring and lack of rigidity to return the key to its original position. <br><br>  The original Schneider spring has the following characteristics d = 3.6 mm, wire thickness 0.6 mm, height 10 mm.  I did not hold it in my hands, I did not find it on sale, I found information on a spring on one of the forums. <br><br>  After searching around the house, a similar spring was found, quite elastic and successfully added to the switch.  Without spending a penny and get a button instead of a switch. <br><br><img src="https://habrastorage.org/web/092/72f/5ea/09272f5ea6f34969a9ce5c4774039141.jpg"><br>  <i>It looks like a switch with a spring installed.</i> <br><br>  Now we always have a module with power and in the network.  In the settings, we put that when powering the module, the module changes the state of the relay. <br><br>  The logic of work in this case: <br><br>  - on the sonoff module there is always power, switching the light on and off through the application; <br>  - pressing the button interrupts the power supply and the relay changes its state to the opposite. <br><br>  We can manage the load on the switch and through the application.  The native application and module work through some kind of Chinese server. <br><br>  Yes, yes, I know, at night there is a jump / disconnection and switching on of the voltage and our lights come on.  During the work of the module, this has never happened before, but we live in Ukraine and the headlines are full of promises of fan blackouts. <br><br>  On the table is the third module.  And where are you dear?  And you native will pick and scoff! <br><br><h2>  Installing alternative firmware </h2><br>  An autopsy showed <s>that the patient died from an autopsy,</s> that there is a place under the comb for 5 pins. <br><br><img src="https://habrastorage.org/web/643/e5a/1f4/643e5a1f425645aab6056fce519173d8.jpg"><br><br>  From the button on the case (3,3v Rx, Tx, GND, GPIO 14).  A soldering iron in hand and connect the usb-to-ttl adapter.  In my usb-to-ttl adapter there is 3.3v, I did not try to apply power to the module from 5v and I do not advise it. <br><br>  Next is the software part.  There is a <a href="https://github.com/arendst/Sonoff-MQTT-OTA-Arduino">firmware</a> for such modules on the githaba.  Now there is a new version of the <a href="https://github.com/arendst/Sonoff-Tasmota">firmware</a> .  What is good about these firmware?  There is a web control, mqtt protocol, OTA (Over the air) - firmware over the air.  As for the native firmware, the mqtt protocol in the promises to add, OTA also exists, but only for its own.  The lack of native firmware - works only when connected to the global network.  Why do we need it?  At this stage it is not necessary ... all the more we do not know what and where our module is being sent. <br><br>  Install the Arduino IDE.  I installed the portable version 1.8.1.  Firmware requires IDE version 1.6.10 or higher. <br><br>  - Add support for ESP8266 modules <br>  - Install <a href="https://github.com/knolleary/pubsubclient">pubsubclient</a> <br>  ‚óã Find the src \ PubSubClient.h file and change the MQTT_MAX_PACKET_SIZE value to 400 or more (now the Tasmot version is asking for a value of 500 or higher). <br><br>  We download the sketch, compile, fingers crossed and hope that everything went without errors.  This was not my case, we read the error and add the necessary libraries which were not.  A couple of hours of torment and we have the firmware without errors.  (The main problem was that I installed the Arduino IDE on Win XP).  Edit the configuration file and upload our firmware. <br><br>  That little minimum that I ruled in User_config.h. <br><br><div class="spoiler">  <b class="spoiler_title">User_config.h</b> <div class="spoiler_text"><code>#define PROJECT "bath" //   -         <br> #define STA_SSID1 "your_wifi_station_id" //    <br> #define STA_PASS1 "your_pass" //     <br> #define STA_SSID2 "your_wifi_station_id_plus" //      <br> #define STA_PASS2 " " //      <br> <br> #define SYS_LOG_HOST "192.168.." //  ,    raspberry pi,    <br> //#define USE_I2C //      <br> //#define USE_IR_REMOTE <br> //#define USE_WS2812</code> <br> </div></div><br>  Depending on the version, other settings may be added, which I would turn off without need.  In the latest firmware (Tasmota), more and more settings can be made through the web settings menu and duplicated with User_config.h. <br><br><h3>  Fill the sketch: </h3><br>  - turn off the power from the module (in any convenient way); <br>  - we press the button on the module and connect the power.  The module is ready to receive the firmware; <br>  - press OK in the IDE and again, with fingers crossed, wait for the firmware to start filling in the module. <br><br>  In case of an error, we check the wires, and if everything is well screwed in, we may not have enough power from usb-to-ttl and we need to take an external source.  We dance with a tambourine and repeat the procedure. <br><br>  <b>Important:</b> <i>power to the module is supplied only through the pins of 3.3V.</i>  <i>Connect it to the power load, through the power of the module itself is impossible.</i>  <i>Experienced users write that supplying 220v per module with firmware turns it into a brick, small but brick.</i>  I did not try, I do not know.  Therefore, with the firmware of the module, only four wiring to the pins is connected to it, and everything else is removed away. <br><br>  If everything is ok, after rebooting the module should have connected to the access point, we find the ip address and go to it in the browser. <br><br><img src="https://habrastorage.org/web/c96/316/9a0/c963169a05594c6791d9dfdd706b365e.png"><br>  <i>View start page.</i> <br><br>  If the module is not connected to your access point, then we continue dancing with a tambourine.  There are various solutions, I will not describe them within this article.  I checked the configs and just flashed the module again. <br><br>  Now we have web access to the module and its settings, mqtt, wires can be removed in the box, firmware / update done through the air. <br><br><h3>  And where is Siri? </h3><br>  All this of course is wonderful, it's time to learn to manage this good from the phone.  I tried several programs from the app for the phone and did not get anything interesting.  It was decided to reach the Home application or HomeKit, which also makes it possible to control the modules via Siri. <br><br>  We find on the shelf Raspberry pi and connect to the network.  In my case, there was already a ‚Äúraspberry‚Äù connected to the network.  How to install the OS and connect the "raspberry" to describe it makes no sense. <br><br>  To communicate with HomeKit, you must install Homebridge.  Homebridge is a NodeJS server running on your local network and emulating the iOS HomeKit API. <br><br><pre> <code class="bash hljs">sudo apt-get update sudo apt-get upgrade sudo apt-get install git make sudo apt-get install g++</code> </pre><br>  Depending on your system, you may need to update the C ++ compiler. <br><br>  Install Nodejs.  We go to the store and select the appropriate <a href="https://nodejs.org/dist/">dist</a> .  We copy the address of a distra and further in the image and likeness <br><br><pre> <code class="bash hljs">wget https://nodejs.org/dist/v4.0.0/node-v4.0.0-linux-armv6l.tar.gz tar -xvf node-v4.0.0-linux-armv6l.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> node-v4.0.0-linux-armv6l sudo cp -R * /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/</code> </pre> <br>  I installed v6.9.4 myself, now there are newer ones. <br><br>  Add other necessary packages: <br><br><pre> <code class="bash hljs">sudo apt-get install libavahi-compat-libdnssd-dev</code> </pre> <br>  Install Homebridge itself: <br><br><pre> <code class="bash hljs">sudo npm install -g --unsafe-perm homebridge</code> </pre><br>  If this does not work, try: <br><br><pre> <code class="bash hljs">sudo npm install -g --unsafe-perm homebridge hap-nodejs node-gyp <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/node_modules/homebridge/ sudo npm install --unsafe-perm bignum <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/node_modules/hap-nodejs/node_modules/mdns sudo node-gyp BUILDTYPE=Release rebuild</code> </pre> <br>  After installing Homebridge, you need to install a few more plug-ins, and then proceed to change the settings of the Homebridge server. <br><br>  Plugins are installed in the same way as homebridge itself. <br><br><pre> <code class="bash hljs">sudo npm install -g --unsafe-perm homebridge-plugin-name</code> </pre> <br>  The required plugin is found in <a href="https://www.npmjs.com/browse/keyword/homebridge-plugin">the package manager</a> .  In the same place we find an example of settings that will need to be added to our settings. <br><br>  For a simple switch. <br><br><pre> <code class="bash hljs">npm install -g homebridge-mqttswitch</code> </pre> <br>  Go to the settings, create, if not yet created, the configuration file: <br><br><pre> <code class="bash hljs">sudo nano .homebridge/config.json</code> </pre> <br>  The configuration file looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">config.json</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"bridge"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Homebridge"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"CC:22:3D:E3:CE:30"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">51826</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pin"</span></span>: <span class="hljs-string"><span class="hljs-string">"031-45-154"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"platforms"</span></span>: [ ], <span class="hljs-attr"><span class="hljs-attr">"accessories"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"accessory"</span></span>: <span class="hljs-string"><span class="hljs-string">"mqttswitch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"mqtt://192.168.178.123:1883"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"caption"</span></span>: <span class="hljs-string"><span class="hljs-string">"room"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"topics"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"statusGet"</span></span>: <span class="hljs-string"><span class="hljs-string">"stat/sleeping/POWER"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"statusSet"</span></span>: <span class="hljs-string"><span class="hljs-string">"cmnd/sleeping/power"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"onValue"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offValue"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"integerValue"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> } ] }</code> </pre><br></div></div><br>  Before saving the settings file, check, for example, <a href="https://jsonlint.com/">here</a> .  Once saved, try running: <br><br><pre> <code class="bash hljs">Homebridge</code> </pre> <br>  If everything starts to write to us, something like: <br><br><pre> <code class="bash hljs"> 11:27:43 PM] [] Initializing mqttswitch accessory...</code> </pre><br>  In the same place the code 031-45-154 for connection will be indicated, if it has not been changed in the settings. <br><br>  Now turn on the phone / tablet running iOS.  Find the application "Home" or "HomeKit" ‚Üí Add accessory and wait for our accessory "Homebridge" to appear, add it, enter the code, assign a room for the switch.  And voila, "Hi Siri, turn on / off the light in the room" - it worked.  "Hi Siri" on phones of the 5th series and below works only when connected to charging. <br><br>  If everything works correctly for us, it remains to add Homebridge to the autoload.  <a href="https://gist.github.com/johannrichard/0ad0de1feb6adb9eb61a/">Full instruction</a> in English.  In my case, through <code>init.d</code> , create the file <code>sudo nano /etc/init.d/homebridge</code> <br>  <a href="https://raw.githubusercontent.com/fhd/init-script-template/master/template">The template is</a> copied to the file in this file and changed under the homebridge <br><br><div class="spoiler">  <b class="spoiler_title">/etc/init.d/homebridge</b> <div class="spoiler_text"> <code>#!/bin/sh <br> ### BEGIN INIT INFO <br> # Provides: homebridge <br> # Required-Start: $network $remote_fs $syslog <br> # Required-Stop: $remote_fs $syslog <br> # Default-Start: 2 3 4 5 <br> # Default-Stop: 0 1 6 <br> # Short-Description: Start daemon at boot time <br> # Description: Enable service provided by daemon. <br> ### END INIT INFO <br> <br> dir="/home/pi" <br> cmd="DEBUG=* /usr/local/bin/homebridge" <br> user="pi" <br></code> <br></div></div><br>  We save, we leave. <br><br><pre> <code class="bash hljs">sudo chmod 755 /etc/init.d/homebridge sudo update-rc.d homebridge defaults</code> </pre> <br>  Now homebridge will start at system startup. <br><br><h3>  Screw DHT22 sensor (temperature / humidity) </h3><br>  The attentive reader noticed that there are 5 pins on the comb and one of them is GPIO 14. Again we take the soldering iron in our hands and solder the three wires to 3.3V, GND, GPIO 14 for the DHT22 humidity temperature sensor.  You can have another sensor (ds18b20, DHT 11, or another one that is supported by the firmware), but I had the DHT22 in my box.  Connecting the sensor made through the connector, which is fixed to the side of the native case.  If necessary, it will be possible to connect another sensor without a scalpel and a soldering iron. <br><br><img src="https://habrastorage.org/web/b68/643/a1f/b68643a1f956407286a799bb1b03d223.jpg"><br><br>  In the picture, I just fixed the connector, I haven‚Äôt connected the wires yet.  In the firmware Sonoff-MQTT-OTA-Arduino, you need to check the settings: <br><br><pre> <code class="hljs lisp">#define DHT_PIN <span class="hljs-number"><span class="hljs-number">14</span></span> // GPIO <span class="hljs-number"><span class="hljs-number">14</span></span> = AM2301 (<span class="hljs-name"><span class="hljs-name">Sonoff_TH10A</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>A), Sonoff SV) #define DHT_TYPE AM2301 // DHT module type (<span class="hljs-name"><span class="hljs-name">DHT11</span></span>, DHT21, DHT22, AM2301, AM2302 or AM2321)</code> </pre> <br>  For the Tasmota firmware, pin and sensor type can be specified in the web settings. <br><br>  If everything is correctly connected and configured, then go to the web interface, we will see the status of the relay and sensor readings.  In the settings you can set the sensor polling frequency.  The default is 300 seconds (5 minutes). <br><br><img src="https://habrastorage.org/web/3a2/4a3/3fb/3a24a33fbb3647979f69354039fb808c.png"><br><br>  We dive in search of a plug for Homebridge to work with a temperature and humidity sensor.  We now need to display these readings in the application.  I managed to do all this, but IMHO it was my rake and should not be done. <br><br>  And why?  It's very simple, just screwing the sensor to the sonoff doesn't make sense, it is necessary to turn something on / off based on these readings.  But in the firmware settings there is no such possibility, it is possible to configure the Home / HomeKit application for such purposes, but a tablet is needed that will be constantly at home or an apple tv.  The presence in the firmware of the ability to communicate with Domoticz led me on this thorny path to installing the Domoticz smart home control system. <br><br>  In the form of a small lyrical digression, I say, I tried to connect plug-ins to my homebridge that allow to transfer RTSP stream from a webcam.  I have an ip-camera TOP-201 from the Chinese counterparts. <br><br>  Install the plugin: <br><br><pre> <code class="bash hljs">npm install -g --unsafe-perm homebridge-camera-ffmpeg</code> </pre> <br>  Add to the settings file: <br><br><div class="spoiler">  <b class="spoiler_title">config.json</b> <div class="spoiler_text"><pre> <code class="hljs perl"><span class="hljs-string"><span class="hljs-string">"platforms"</span></span>: [{ <span class="hljs-string"><span class="hljs-string">"platform"</span></span>: <span class="hljs-string"><span class="hljs-string">"Camera-ffmpeg"</span></span>, <span class="hljs-string"><span class="hljs-string">"cameras"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"top-201"</span></span>, <span class="hljs-string"><span class="hljs-string">"videoConfig"</span></span>: { <span class="hljs-string"><span class="hljs-string">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"-re -i rtsp://admin@192.168.178.10:554/user=admin_password=tlJwpbo6_channel=1_stream=0.sdp?real_stream"</span></span>, <span class="hljs-string"><span class="hljs-string">"maxStreams"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"maxWidth"</span></span>: <span class="hljs-number"><span class="hljs-number">640</span></span>, <span class="hljs-string"><span class="hljs-string">"maxHeight"</span></span>: <span class="hljs-number"><span class="hljs-number">480</span></span>, <span class="hljs-string"><span class="hljs-string">"maxFPS"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } } ]</code> </pre> <br></div></div><br>  Additionally, a picture from the camera appears in the HomeKit application, but it all worked very slow and there was no need for this camera.  What would unnecessarily not load the system, deleted the ip-camera.  Let us return to the installation of the system for managing "without smart" home. <br><br><h3>  Installing and configuring Domoticz for Sonoff modules </h3><br>  Putty ‚Üí ssh ‚Üí and again we pick the raspberry.  Surprisingly, the installation in my case did not require dancing with a tambourine and it was enough <br><br><pre> <code class="bash hljs">sudo curl -L install.domoticz.com | sudo bash</code> </pre><br>  Add autorun: <br><br><pre> <code class="bash hljs">sudo cp domoticz.sh /etc/init.d sudo chmod +x /etc/init.d/domoticz.sh sudo update-rc.d domoticz.sh defaults</code> </pre><br>  If necessary, change some settings: <br><br><pre> <code class="bash hljs">sudo nano /etc/init.d/domoticz.sh</code> </pre> <br>  Open the address of the raspberry <a href="http://192.168.xn--u1aaa.xn--u1aaa/">192.168.xxx.xxx</a> : 8080.  And should go to the homepage domotiks.  Further adjustment and adding of sensors already occurs through a web. <br><br><img src="https://habrastorage.org/web/130/93c/ab8/13093cab88b54ac498fbd15d17d4536a.png"><br>  <i>On the screenshot, sonoff sensors and a street sensor have already been added.</i> <br><br>  To add sensors / switches, go to Setup ‚Üí hardware and add Dummy (Does nothing, use for virtual switches only).  Our ‚ÄúDummy‚Äù will appear in the device list.  Clicking on the Create virtual sensor, we call our sensor / switch and select the required type from the list.  Now, in the Setup ‚Üí Devices tab, a new device will appear and in the same place you can now see the idx of the device. <br><br>  We open the web of our switch / sensor and save configuration ‚Üí domoticz ‚Üí idx of our switch.  In the new Tasmota firmware, it is possible to set several idx.  For relay / switch and separately for GPIO.  Depending on the module, it may be an additional sensor or more, since in the SV version there are three additional pins that can be assigned their role in your system (relays / sensors). <br><br>  In the old firmware (Sonoff-MQTT-OTA-Arduino) for the module, I had to perform some dances with a tambourine, what would Domoticz see the readings of humidity and temperature.  I think it makes no sense to describe it here, for a new firmware (Tasmota) this is not needed. <br><br>  According to the readings of humidity, you can control the exhaust in the bathroom.  Where there is an exhaust fan there is enough space for the module and we already have everything we need.  It remains only to adjust the management of the readings of humidity. <br><br>  Setup ‚Üí More options ‚Üí Events <br><br><img src="https://habrastorage.org/web/6ec/865/203/6ec865203b894f579e3fb3c1f0d62261.png"><br><br>  With the help of the designer, we create the logic of the hood operation (as in the picture).  You can still on Lua, but this is not my case.  Further experience has shown that 5 minutes of sensor polling is too large and I reduced to 3 minutes.  Now taking a shower when the humidity rises above 70%, the hood is activated.  In the future, when lowering below 45% off.  Data on humidity picked up by experience.  The only minus, and maybe it is not a minus, but a feature of the system, if you forcefully turn on the hood by pressing a button, then after 3 minutes, interrogating the humidity sensor, the system will shut down. <br><br>  What about Siri?  It turned out, everything is very simple. <br><br><pre> <code class="bash hljs">sudo npm install -g -g --unsafe-perm homebridge-edomoticz</code> </pre><br>  And add to the settings <br><br><pre> <code class="bash hljs">sudo nano .homebridge/config.json</code> </pre><br><pre> <code class="hljs objectivec"> <span class="hljs-string"><span class="hljs-string">"platform"</span></span>: <span class="hljs-string"><span class="hljs-string">"mqtt"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mqtt"</span></span>, <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"mqtt://127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"topic_prefix"</span></span>: <span class="hljs-string"><span class="hljs-string">"homebridge"</span></span>, <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"bar"</span></span></code> </pre><br>  And when you start Homebridge we get <br><br><pre> <code class="bash hljs">[5/8/2017, 11:42:30 PM] [eDomoticz] You have 10 devices defined <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Domoticz. [5/8/2017, 11:42:30 PM] [eDomoticz] Initializing platform accessory <span class="hljs-string"><span class="hljs-string">'bath-temp'</span></span>... [5/8/2017, 11:42:30 PM] [eDomoticz] Initializing platform accessory <span class="hljs-string"><span class="hljs-string">' '</span></span>... [5/8/2017, 11:42:30 PM] [eDomoticz] Initializing platform accessory <span class="hljs-string"><span class="hljs-string">' '</span></span>... [5/8/2017, 11:42:30 PM] [eDomoticz] Initializing platform accessory <span class="hljs-string"><span class="hljs-string">''</span></span>...</code> </pre><br>  All the devices that we added to Domotiks, now we will have to be displayed among our devices in Homekit and can be managed through a friend of Siri.  The need for other plugins for Homebridge has somehow disappeared. <br><br>  We have a bunch of Domoticz-Homebridge and everything works very well and stably.  Already testing not the first month. <br><br>  A temperature / humidity sensor DHT22 from past crafts is bolted to the Raspberry pi and the data is transmitted to narodmon.ru with a python script every 10 minutes.  Add a few lines to the existing script. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#domoticz settings IP = '192.168..' #IP domoticz PORT = '8080' #port of server IDX_1 = '7' #IDX of the DHT temp sensor //‚Ä¶. ,        narodmon.ru url = 'http://{}:{}/json.htm?type=command¬∂m=udevice&amp;nvalue=0&amp;idx={}&amp;svalue={}'.format(IP, PORT, IDX_1, sensor_value_1) request = urllib2.Request(url) response = urllib2.urlopen(request)</span></span></code> </pre><br>  We add one more virtual sensor to Domoticz.  And now we can additionally see the temperature and humidity on the street, both through the web on our local homepage and in the application on iOS. <br><br>  Who is closer to mqtt, then the sensor readings could be sent via mqtt. <br><br><pre> <code class="python hljs"> playload = <span class="hljs-string"><span class="hljs-string">'{{ "idx": {} , "nvalue" : {}, "svalue" : "1" }}'</span></span>.format(IDX_1, humidity) client.publish(TOPIC_DOMOTICZ, playload, qos =<span class="hljs-number"><span class="hljs-number">0</span></span> , retain =<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) <span class="hljs-comment"><span class="hljs-comment">#publish</span></span></code> </pre><br><h2>  We add Wifi to the coffee machine </h2><br>  While my machine is being repaired and waiting for the control unit to arrive from Germany, the Delonghi coffee machine was presented as a gift.  On the panel we have an on / off button, cook a small, double coffee and two more which I do not use because  I do not mix milk with steam, I do not drink latte and other beverages.  The disadvantage, the coffee does not grind itself, it is necessary to fill already ground and on one cup. <br><br>  For coffee machines using Sonoff SV.  Pins 3,3v, Rx, Tx, GND are signed.  Separately, GPIO 4, 5, 14 are also added to the board. Firmware following the same procedure as described above. <br><br>  We open the device and get to the board with buttons. <br><br>  There is 5v power on the board, which is quite enough to power our sonoff sv wireless module.  Labor was not to find where we have the cherished 5c. <br><br>  Pressing the buttons, simply short-circuits the signal to the ground.  We connect our module according to the scheme. <br><br><img src="https://habrastorage.org/web/a3c/559/ba5/a3c559ba5c1f48d6b552aaddaa448209.png"><br><br>  As you can see from the diagram, I made the connection of only two buttons: on / off and make coffee.  By analogy, it was possible to make all the other buttons.  On sonoff sv, we have 3 pins derived on the board, a relay, and you can also use Rx, Tx (in the latest Tasmota firmware). <br><br><img src="https://habrastorage.org/web/a62/efb/5b0/a62efb5b0ea54284b0406b4f16595145.png"><br><br>  Putting it all up according to the scheme, we find the right place inside the coffee maker.  In the module settings in the web interface, add a second relay to GPIO5.  In the menu "console" set the following settings: <br><br><pre> <code class="hljs ruby">PowerOnState <span class="hljs-number"><span class="hljs-number">0</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/   ,     . PulseTime1 10 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   0,1 ,      PulseTime2 10 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     1 . 1  2     .</span></span></code> </pre> <br>  In the homepage settings, we create two more ‚Äúvirtual sensors‚Äù and add their idx to the module settings in the homepage settings menu (Configuration ‚Üí Configure Domoticz ‚Üí IDX 1 and IDX 2). <br><br>  As a result, we get two more switches, one of which presses the on / off button of the coffee machine and the second one presses the coffee making button. <br><br>  To make coffee, anyway, you have to walk with your feet, you need to pour coffee.  But turn on the machine is conveniently obtained.  From the moment you turn on and before making coffee, you need some time to warm up the machine.  Therefore, while sitting in a room, you can remotely turn on the coffee-machine and, after a while, stomp your feet and make yourself a drink. <br><br>  More benefit will be in such a switch on a full machine in a coffee machine, you just have to remember to set the cup in advance.  We are waiting for the management fee. <br><br><h2>  Add wifi to open the door with intercom Vizit </h2><br>  In the common corridor, the vestibule near the elevator is closed by a door with a magnetic lock and the Vizit access system.  The system was installed after the repair was made and the button to open the chain door to the apartment was not held.  In order to start the guests, you have to go out to the door and open it with the button to open the door in the corridor.  The control unit KTM-602M. <br><br><img src="https://habrastorage.org/web/771/ea1/9ab/771ea19abd1144e4b95e39f8ffbe2c73.jpg"><br><br>  The OP + GND closure opens the door / disconnects the magnet for 7 seconds. <br><br>  We separate the power supply of the sonoff sv module and the relay by removing two resistors, as indicated below in the picture. <br><br><img src="https://habrastorage.org/web/c31/85f/644/c3185f6440db4066bf6cf3fd1336d4af.png"><br><br>  We connect the OP to the input ‚Äúinput +‚Äù relay, and at the output ‚Äúoutput +‚Äù relay we fasten GND.  Between ELC and GND control unit 18v from which we supply power to the module itself. <br><br>  Add the door bell to the houses and now Siri can help us open the doors for the guests. <br><br>  Siri assistant recognizes the ‚ÄúOpen door‚Äù voice command, better than ‚Äúturn on the coffee machine‚Äù. <br><br>  At this point I stopped with the sonoff modules. <br><br><h2>  Small bonus </h2><br>  Once such a binge has gone, we will also turn the TV off / on.  Turning off the TV and turning on no longer has anything to do with the wifi modules.  TV is in close proximity with raspberry pi.  Here we are helped by IR LED and a pair of resistances of different denominations.  Install lirc, in the same place in the databases we find the settings for your remote / TV. <br><br>  To work with home run, we run a small python script that translates our wishes to turn on / off the TV from mqtt to lirc. <br><br><div class="spoiler">  <b class="spoiler_title">mqtt to lirc</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> paho.mqtt.client <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> mqtt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json IP = <span class="hljs-string"><span class="hljs-string">'192.168..'</span></span> PORT = <span class="hljs-string"><span class="hljs-string">'1883'</span></span> device = {<span class="hljs-number"><span class="hljs-number">18</span></span> : <span class="hljs-string"><span class="hljs-string">'OpenBox'</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span> : <span class="hljs-string"><span class="hljs-string">'PHILIPS'</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span> : <span class="hljs-string"><span class="hljs-string">'air'</span></span>} TOPIC_DOMOTICZ = <span class="hljs-string"><span class="hljs-string">'domoticz/in'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device, command)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># """ Sends IR-signal to the device """ os.system("irsend SEND_ONCE '" + device + "' '" + command + "'") # The callback for when the client receives a CONNACK response from the server. def on_connect(client, userdata, flags, rc): print("Connected with result code "+str(rc)) # Subscribing in on_connect() means that if we lose the connection and # reconnect then subscriptions will be renewed. client.subscribe(TOPIC_DOMOTICZ,0) def on_publish(client,userdata,result): #create function for callback print("data published \n") pass # The callback for when a PUBLISH message is received from the server. def on_message(client, userdata, msg): domoticz = json.loads(msg.payload) if domoticz ['idx'] in device.keys(): idx = domoticz ['idx'] dev = device [idx] command = 'KEY_POWER' send (dev, command) client = mqtt.Client() client.on_connect = on_connect client.on_message = on_message client.on_publish = on_publish client.connect(IP, PORT, 60) client.loop_forever()</span></span></code> </pre> <br></div></div><br>  We add to Domoticz three more virtual buttons for a TV, receiver and air conditioning. <br>  To control the TV is not convenient from the phone, still the remote, somehow more familiar.  But turn off the TV when I forgot and left the room a nice bonus. <br><br>  A nice addition to all this is the availability for Pebble hours of the Pemoticz app.  Added the address in the settings and the application pulled all the switches.  Not a single Siri can now turn on the coffee machine / open doors and turn off the lights.  The watch is usually on hand, and the phone may not be in close proximity.  This also has its advantages.  Speech recognition for hours did not deal with flashing them, but it is also possible. <br><br><img src="https://habrastorage.org/web/651/e3d/d81/651e3dd81b654be3b0fc324f44dc8b9e.png"><br><br>  On this, perhaps, you can finish the story "without a smart" home. <br><br><h2>  Conclusion </h2><br>  In conclusion, but what next? <br><br>  Todo list: <br><br>  - Air conditioning, it was not possible to find the settings for the remote to lirc and the first attempts to copy the presses did not succeed either.  Sawing further. <br>  - We are waiting for an order from the Chinese company Mi with a gateway and several sensors.  Sensors opening doors by not tricky manipulations become sensors leakage.  We will add to our system.  When triggered sensors will send a notification to the owner. <br>  - This ends my thoughts ... <br><br><h3>  Sources used </h3><br>  ‚Üí <a href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi</a> <br>  ‚Üí <a href="https://github.com/arendst/Sonoff-Tasmota/wiki">Sonoff-Tasmota Wiki</a> <br>  ‚Üí <a href="https://www.domoticz.com/wiki/Raspberry_Pi">Installation of Domoticz on an already running Pi</a> <br>  ‚Üí <a href="http://www.bntdumas.com/2015/07/15/how-to-add-wifi-to-your-coffee-machine-part-1/">How-to: Add WiFi to your coffee machine</a> </div><p>Source: <a href="https://habr.com/ru/post/403869/">https://habr.com/ru/post/403869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../403857/index.html">Oticon presented an unimplantable hearing aid for children based on bone conduction technology</a></li>
<li><a href="../403859/index.html">The state search system ‚ÄúSputnik‚Äù, created for $ 20 million, is on the verge of closing.</a></li>
<li><a href="../403861/index.html">Something wrong is happening to Masterhost.</a></li>
<li><a href="../403865/index.html">Auchan LED Bulbs</a></li>
<li><a href="../403867/index.html">Freedom of information</a></li>
<li><a href="../403871/index.html">BBC Micro - the computer that beat ZX Spectrum</a></li>
<li><a href="../403873/index.html">Balcony Solar Panel: Battery and BMS Testing</a></li>
<li><a href="../403875/index.html">Smart watches and neural networks detect atrial fibrillation with an accuracy of 97%</a></li>
<li><a href="../403877/index.html">NASA's extra heavy booster will cost at least $ 500 million, and its launch will be postponed for another year</a></li>
<li><a href="../403879/index.html">Self-employed citizens will not be prohibited from traveling abroad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>