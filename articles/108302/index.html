<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Large traffic flows and interrupt management in Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I really liked the topic about the load distribution from interruptions of the network adapter across processors, so I decided to describe how this is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Large traffic flows and interrupt management in Windows</h1><div class="post__text post__text-html js-mediator-article">  I really liked the <a href="http://habrahabr.ru/blogs/sysadm/108240/">topic</a> about the load distribution from interruptions of the network adapter across processors, so I decided to describe how this is done in Windows. <br><br>  Disclaimer: judging by some of the comments in previous posts, I should repeat what I started with the first post: I do not give (and can not give) generally applicable recipes.  This is especially true of performance, where the smallest unrecorded part can have a disastrous effect on the result.  Rather, the recommendation I give: TESTING AND ANALYSIS.  The point of my writing is to give people as much information as possible for analysis, because the more you understand how something works, the easier it is to find ways to eliminate bottlenecks. <br><br>  So, network bandwidth scalability.  Requires Windows Server 2003 SP2 +.  A network card that supports Receive Side Scaling (you can say with a fair degree of confidence that any server network card released in the past 5 years or any general 1Gb + NIC will work, although you can often see RSS and 100Mb).  Install Windows Server and drivers on the card ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  <b>EVERYTHING.</b>  <b>Setup complete.</b>  RSS is enabled by default in all versions of Windows in which it is supported. <br><br><h4>  Testing </h4><br>  Take a not-so-new Dell server with two quad core xeons: <br><img src="https://habrastorage.org/storage/722b99f4/0cf66f8e/23148645/cdd81eec.png"><br><br>  There are two dual-port 1Gb network cards and one 10Gb onboard, but I didn‚Äôt find a 10Gb switch, so I couldn‚Äôt get it - but oh well: <br><img src="https://habrastorage.org/storage/65561bd0/cde38429/82aa6ad1/462057bd.png"><br><br>  What is interesting about these cards is that despite RSS support in 8 queues, they do not support <a href="http://en.wikipedia.org/wiki/MSI-X">MSI-X</a> or even MSI.  Moreover, out of the four available pin-based interrupt lines, only one is allocated to each network port (accordingly, it is no longer possible to force interrupts to come to different processors ‚Äî this is a hardware limitation of this configuration).  10 gigabits registered to themselves either 32 or 64 (by eye) interrupt vectors, but using it is not destiny.  Can <a href="http://habrahabr.ru/blogs/system_programming/81067/">Hindu crafts to run games</a> to cope with the task? <br><img src="https://habrastorage.org/storage/42e7d741/57708544/60485c04/f75d49fb.png"><br><br>  Just in case, check the RSS (although if it is not - it will be noticeable and so): <br><img src="https://habrastorage.org/storage/9ecfc428/51de4354/3d75e962/2f954a6a.png"><br><br>  First, turn off RSS (I turned it back on after testing, but in the same window) <br><img src="https://habrastorage.org/storage/a85b7660/00b61c3a/214c28fd/4ddbb979.png"><br><br>  and run the load test: <br>  Fully loaded two cores, all others are idle <br><img src="https://habrastorage.org/storage/5b686b5b/d608a41b/5efcece4/bbb9cdb3.png"><br><br>  Network loaded by third: <br><img src="https://habrastorage.org/storage/37d22d50/5a1f6dbe/90df8379/37e60889.png"><br><br>  50% of one processor is clogged with interrupt processing, another 20% of the same processor is DPC processing.  The rest is the tcpip stack and the application that gives traffic. <br><img src="https://habrastorage.org/storage/c0f3dbc5/2891c041/fcf048bc/8d62b407.png"><br><br>  Turn on RSS (screenshot above).  CPU: <br><img src="https://habrastorage.org/storage/c0e6dbd6/961ff255/db388c0b/7b63583c.png"><br><br>  Network: <br><img src="https://habrastorage.org/storage/88570e7b/913b89f4/ab2680b6/4bd2691c.png"><br><br>  One third of the processor is full of interrupts, but the DPCs are perfectly parallelized. <br><img src="https://habrastorage.org/storage/15bc9b6d/0af050aa/c3f7b265/06ce3aa0.png"><br><br>  In general, on this configuration it would be possible to give about 3 gigabits (from one network card) and only then we would meet a bottle neck. <br><br>  Just in case, I will say that RSS has a less well-known relative - Send Side Scaling.  If you <a href="http://msdn.microsoft.com/en-us/library/ff568410(v%3DVS.85).aspx">set</a> the hash value before sending the list of buffers, the interruption after the completion of the parcel will be delivered in accordance with the established indirection tables. <br><br>  <a href="http://www.microsoft.com/whdc/device/network/NDIS_RSS.mspx">Here</a> you can read about RSS, and <a href="http://download.microsoft.com/download/5/E/6/5E66B27B-988B-4F50-AF3A-C2FF1E62180F/ENT-T556_WH08.pptx">here</a> there is a good presentation in pictures explaining the work of RSS.  If it is interesting, I can try to describe in my own words the mechanisms of RSS operation, but as for me it is better to read the original sources. <br><br><h4>  TCP Offload Engine </h4><br>  If something like RSS in Linux <a href="http://lwn.net/Articles/382428/">is about to</a> appear (I did not find any mention of support for normal hardware RSS in Linux: who knows - give the link - pro-update post).  That's all officially difficult with <a href="http://en.wikipedia.org/wiki/Tcp_offload_engine">TOE</a> in Linux.  The patch from <a href="http://www.chelsio.com/">Chelsio</a> (one of the manufacturers of high-end network cards) that implements TOE support was rejected, and instead some kind of completely <a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/toe">idiotic excuses</a> started (when you read it, you should bear in mind that BSD and Windows have had normal TOE support for many years) . <br><br>  So what is it?  TOE is a complete TCPIP implementation at the hardware level: with delivery confirmation, retransmitting for errors, window control, etc .: a DMA network card directly takes data from memory, cuts packets, attaches headers, and reports (using interrupts) only the most extreme cases. <br><br>  By default, TOE is in automatic mode.  Watch Chimney Offload State: <br><img src="https://habrastorage.org/storage/ea7c4bc3/31e88d3f/2c889505/4e68d3bb.png"><br><br>  The screenshot was taken during active testing, but in statistics it is clear that there is not a single ‚Äúunloaded‚Äù connection to the network interface card (for the reasons later).  We turn on forcibly (and after a while request statistics): <br><img src="https://habrastorage.org/storage/80a71451/7650f8d4/2ccd687b/0c501bed.png"><br><br>  And here is the reason: only 1024 connections can be unloaded into this network card (but the system has really been able to unload 1022).  Quite an expensive resource, so you can unload everything.  The system heuristically tries to detect connections (get / put large files over http, transferring file content to file servers, etc.) that will last a long time and unloads them in the first place. <br><br>  But still look what happened.  The processor has tripled three times: <br><img src="https://habrastorage.org/storage/155f54b8/61192d4a/4414056c/da7c242c.png"><br><br>  The number (and time spent in) of both the ISR and the DPC has drastically decreased: <br><img src="https://habrastorage.org/storage/626878d7/f7210f36/d26800b6/9f674aa6.png"></div><p>Source: <a href="https://habr.com/ru/post/108302/">https://habr.com/ru/post/108302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108294/index.html">Once again about the architecture of network demons</a></li>
<li><a href="../108295/index.html">Getters and Setters in Javascript</a></li>
<li><a href="../108297/index.html">MeeGo 2010: Free Transformers, Upstream 1st, the upcoming MeeGo-smartphones and the inevitable competition</a></li>
<li><a href="../108298/index.html">After all asynchronous calls</a></li>
<li><a href="../108300/index.html">Microblog about English words on Twitter: three months development</a></li>
<li><a href="../108305/index.html">PixelBuzz.tv - experimenting with pixels</a></li>
<li><a href="../108306/index.html">Hatsune Miku Live Concert</a></li>
<li><a href="../108309/index.html">Nexus S will become a contactless analogue of a credit card, will contain an NFC chip and bring the apocalypse closer.</a></li>
<li><a href="../108310/index.html">Fighting typos in posts - easy</a></li>
<li><a href="../108311/index.html">Optimizing GCC Compilation by Gentoo Example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>