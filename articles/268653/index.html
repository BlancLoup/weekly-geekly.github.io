<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rewriting from java to C ++ on the Android platform</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with you the experience of rewriting from java to C ++ on the Android platform and what happened as a result. 

 For its small home pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rewriting from java to C ++ on the Android platform</h1><div class="post__text post__text-html js-mediator-article">  I want to share with you the experience of rewriting from java to C ++ on the Android platform and what happened as a result. <br><br>  For its small home project, the Viola-Jones face search algorithm was used, the java-sources with the model were taken from here <a href="https://code.google.com/p/jviolajones">code.google.com/p/jviolajones</a> with a slight modification - two classes were added: Point and Rectangle.  I‚Äôll clarify why I didn‚Äôt use OpenCV for Android - for its work it is necessary to install a separate library application, which in my case would be very inconvenient, and experiments showed it to fall without warning, did not deal with this for a long time, and also with the search for other libraries decided to take the simplest ready implementation. <br><br>  The speed of the algorithm showed deplorable results, in a 400 by 300 photo on my old broken GT-I9300I - 54 seconds, on avd (virtual device) and even longer - 250 seconds. <br><a name="habracut"></a><br>  Often came across my discussion of the speed of code in java and C ++, somewhere it was shown that java is lagging behind, in some cases even vice versa, small sections of code with one cycle were cited.  Here, the algorithm is a bit more complicated than the order of 6 nested loops, as you can see from the source code.  Therefore, it was decided to try out the rewriting in C ++ by own experience.  For all the articles I read, I got the impression that the speed would increase by a maximum of 20 percent, but as it turned out it was wrong. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The following tasks naturally arose - how to pass input and get output data and how to rewrite the code.  Filling the xml model in the constructor Detector decided to leave on java, which is filled, of course, not quickly, but since working with xml in C ++ sounds very scary for me, I left it as it is.  The type of my professional activity is associated with java, I was associated with C \ C ++ only at the institute and a little at work on old projects.  So I had to study a bit of documentation, read the articles and fill up some cones. <br><br>  <b>Rewriting logic</b>  There were no special problems, a method was adopted - without looking to copy the classes, where eclipse highlighted the red ones it was covered with a hatchet.  All ArrayList'y remade into an array, good - they did not change the size. <br><br>  I will not describe the environment setting for calling native code, there are a lot of articles on this topic. <br><br>  <b>How to transfer data.</b>  With simple types - int, float, boolean, everything is simple and clear.  With one-dimensional, it seems to be easy too: <br><br><pre><code class="hljs mel">JNIEXPORT jint JNICALL Java_com_example_Computations_intFromJni(JNIEnv* <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>, jobject thiz, jintArray arr) { jsize d = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetArrayLength(arr); jboolean j; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> * p = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetIntArrayElements(arr, &amp;j); ... }</code> </pre> <br>  With a two-dimensional bit more complicated: <br><br><pre> <code class="hljs markdown">JNIEXPORT jint JNICALL Java<span class="hljs-emphasis"><span class="hljs-emphasis">_com_</span></span>example<span class="hljs-emphasis"><span class="hljs-emphasis">_Computations_</span></span>findFaces(JNIEnv<span class="hljs-bullet"><span class="hljs-bullet">* env, jobject thiz, jobjectArray image) { int width = env -&gt; GetArrayLength(image); jboolean j2; jintArray dim= (jintArray)env-&gt;GetObjectArrayElement(image, 0); int height = env -&gt; GetArrayLength(dim); int *</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">*imageLocal; imageLocal = new int*</span></span>[<span class="hljs-string"><span class="hljs-string">width</span></span>]; for (int i = 0; i <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jintArray</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">oneDim</span></span></span></span><span class="xml"><span class="hljs-tag">= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(jintArray)env-</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>GetObjectArrayElement(image, i); int *element = env-&gt;GetIntArrayElements(oneDim, &amp;j2); imageLocal[<span class="hljs-string"><span class="hljs-string">i</span></span>] = new int[<span class="hljs-string"><span class="hljs-string">height</span></span>]; for(int j=0; j <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">imageLocal</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">][</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">]= </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">element[j];</span></span></span></span><span class="xml"><span class="hljs-tag"> } } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span></span><span class="xml"><span class="hljs-tag"> }</span></span></span></span></code> </pre><br>  Let's go further, how to pass objects that have a bunch of fields, among which there are List types.  To obtain the object field, the following construction is used: <br><br><pre> <code class="hljs erlang-repl">jclass clsDetector = env-&gt;GetObjectClass(objDetector); jfieldID sizeFieldId = env-&gt;GetFieldID(clsDetector, <span class="hljs-string"><span class="hljs-string">"size"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ldetection/Point;"</span></span>); jobject pointObj = env-&gt;GetObjectField(objDetector, sizeFieldId);</code> </pre><br>  For sheets, we need two get and size methods: <br><br><pre> <code class="hljs mel"> jfieldID stagesFieldId = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetFieldID(clsDetector, <span class="hljs-string"><span class="hljs-string">"stages"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ljava/util/List;"</span></span>); jobject stagesList = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetObjectField(detectorJObj, stagesFieldId); jclass listClass = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;FindClass( <span class="hljs-string"><span class="hljs-string">"java/util/List"</span></span> ); jmethodID getMethodIDList = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetMethodID( listClass, <span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"(I)Ljava/lang/Object;"</span></span> ); jmethodID sizeMethodIDList = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;GetMethodID( listClass, <span class="hljs-string"><span class="hljs-string">"size"</span></span>, <span class="hljs-string"><span class="hljs-string">"()I"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> listStagesCount = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;CallIntMethod( stagesList, sizeMethodIDList ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; listStagesCount; ++i ) { jobject stage = <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-&gt;CallObjectMethod( stagesList, getMethodIDList, i); ...</code> </pre><br>  Data learned to get.  We launch, falls on an error - Local reference table overflow 512 entries.  It turns out that it is necessary to clean all local links jclass and jobject, this is done like this: <br><br><pre> <code class="hljs lisp"> env-&gt;DeleteLocalRef(<span class="hljs-name"><span class="hljs-name">jcls</span></span>)<span class="hljs-comment"><span class="hljs-comment">; env-&gt;DeleteLocalRef(jobj);</span></span></code> </pre><br>  And for arrays too: <br><br><pre> <code class="hljs lisp"> env-&gt;ReleaseIntArrayElements(<span class="hljs-name"><span class="hljs-name">oneDim</span></span>, element, JNI_ABORT)<span class="hljs-comment"><span class="hljs-comment">; env-&gt;DeleteLocalRef(oneDim);</span></span></code> </pre><br>  <b>Return the result.</b>  To simplify your task, returning the result is made in the form of an array Rectangle: <br><br><pre> <code class="hljs php"> jclass cls = env-&gt;FindClass(<span class="hljs-string"><span class="hljs-string">"detection/Rectangle"</span></span>); jobjectArray jobAr =env-&gt;NewObjectArray(faces-&gt;currIndex, cls, <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>); jmethodID constructor = env-&gt;GetMethodID(cls, <span class="hljs-string"><span class="hljs-string">"&lt;init&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"(IIII)V"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; faces-&gt;currIndex; i++) { Rectangle* re = faces-&gt;rects[i]; jobject object = env-&gt;NewObject(cls, constructor, re-&gt;x, re-&gt;y, re-&gt;width, re-&gt;height); env-&gt;SetObjectArrayElement(jobAr, i, object); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jobAr;</code> </pre><br>  So, the solemn moment - search in the same photo - 14 seconds, i.e.  4 times faster, in other photos similar results.  On a virtual android, 132 seconds versus 300 seconds.  But as we know, it is impossible to use the results of one experiment; it is necessary to repeat several times, for one photo, the processing time in seconds. <br><table><tbody><tr><th>  Virtual device </th><th>  Virtual device using cpp </th><th>  My phone is galaxy </th><th>  My phone is galaxy with cpp </th></tr><tr><td>  238 </td><td>  132 </td><td>  84 </td><td>  14 </td></tr><tr><td>  318 </td><td>  137 </td><td>  54 </td><td>  14 </td></tr><tr><td>  472 </td><td>  135 </td><td>  54 </td><td>  14 </td></tr><tr><td>  264 </td><td>  150 </td><td>  54 </td><td>  14 </td></tr><tr><td>  266 </td><td>  138 </td><td>  54 </td><td>  14 </td></tr><tr><td>  262 </td><td>  129 </td><td>  53 </td><td>  14 </td></tr></tbody></table><br>  And in conclusion, I note.  Despite the fact that rewriting has given a lot of acceleration, there is still a lot of limit to perfection, you can use multithreading, which I plan to study in the near future.  And making any adjustments to the algorithm is probably the most difficult part. <br><br>  <b>update</b> Posted <a href="https://drive.google.com/file/d/0B2RMIFu2ZeMPdjUwS05EZTJfd2M/view%3Fusp%3Dsharing">source</a> .  Use as follows: <br><pre> <code class="java hljs"> Detector detector = Detector.create(inputHaas); List&lt;Rectangle&gt; res = detector.getFaces(background_image, <span class="hljs-number"><span class="hljs-number">1.2f</span></span>, <span class="hljs-number"><span class="hljs-number">1.1f</span></span>, .<span class="hljs-number"><span class="hljs-number">05f</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, useCpp);</code> </pre><br>  inputHaas is the model stream, i.e.  the haarcascade_frontalface_default.xml file from the original algorithm, useCpp - use C ++ or not.  In C ++ sources, I don‚Äôt do a freeing of memory, since  wrote in a hurry. </div><p>Source: <a href="https://habr.com/ru/post/268653/">https://habr.com/ru/post/268653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268643/index.html">Tell me where you are and I will tell you where you are</a></li>
<li><a href="../268645/index.html">Couponators are dead. Long live BonJoin</a></li>
<li><a href="../268647/index.html">My first map on Leaflet.js</a></li>
<li><a href="../268649/index.html">Archiving data DOS-applications in connection with the completion of the life cycle</a></li>
<li><a href="../268651/index.html">How the flood in Thailand in 2011 helped Amazon Web Services rethink their work and create a ‚Äúcloud case‚Äù</a></li>
<li><a href="../268655/index.html">LinuxCon + CloudOpen + Embedded LinuxCon Europe 2015: how it was</a></li>
<li><a href="../268657/index.html">Network overlay technologies: OTV, LISP and results. Part 3</a></li>
<li><a href="../268659/index.html">Do banks struggle with skimming in ATMs</a></li>
<li><a href="../268661/index.html">Hackathon VKontakte October 31</a></li>
<li><a href="../268663/index.html">Unity - Conceptual ideas and tips for newcomers igrodeva. Powerful 2D project optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>