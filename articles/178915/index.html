<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Software synthesizer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="And so gentlemen, I finally decided to deal with software synthesis of music, namely with the practical part of the implementation of such a task. Let...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Software synthesizer</h1><div class="post__text post__text-html js-mediator-article">  And so gentlemen, I finally decided to deal with software synthesis of music, namely with the practical part of the implementation of such a task.  Let's see what came of it and how it is implemented ... <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/u4zhw6W1Crk%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700258&amp;usg=ALkJrhiZQTBJKyMhiA9eKiViGHTRw8315A" frameborder="0" allowfullscreen=""></iframe><br><a name="habracut"></a><br><h3>  Create waves </h3><br>  We all perfectly understand that sound is a wave and that the frequency of oscillations of a wave from zero level corresponds to the frequency of a sound wave, and the amplitude of this wave is responsible for its strength or simply speaking loudness, but in the machine representation the sound recorded as pulse code modulation is an array of data , each element of which represents the position of the wave at a specific point in time. <br>  Let's consider a simple sound wave in PCM format better, for this we first write a function that will be a model of a sine wave.  It will take two values ‚Äã‚Äã- the offset and frequency. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Sin(frequency * index); }</code> </pre> <br>  And now we add it to the Program class and write the main function Main which will initialize an array of data of 75 elements in length which will represent our sound and cyclically fill each cell using the model of the sinusoid we just wrote.  To calculate the value of a function for a specific offset, we need to take into account the sinusoid period equal to 2 * Pi and multiply this period by the wave frequency we need.  But in order to understand what the resulting frequency sound will come out in PCM format, you need to know its sampling rate.  The sampling frequency is the sampling rate of elements per unit of time, well, if it is completely simplified, then this is the number of array elements per second, which means that the frequency of sound in PCM format is the frequency of the wave divided by the frequency of its sampling.  Let's generate a sound wave with a frequency of 2 Hz. In this case, we agree that the sampling frequency will be 75 Hz. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[<span class="hljs-number"><span class="hljs-number">75</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  . for (int index = 1; index &lt; 76; index++) { //     . data[index-1] = Sine(index, Math.PI * 2 * 2.0 / 75); //     . } Console.ReadKey(true); //    . } public static double Sine(int index, double frequency) { return Math.Sin(frequency * index); } }</span></span></code> </pre><br>  And now, in order to see the result of our work, we will add to the Program class a new function capable of visualizing our function right in the console (This will be the fastest way), so we will not go into its details. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Draw</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { Console.BufferHeight = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-comment"><span class="hljs-comment">//        . Console.CursorVisible = false; //    . for (int y = 0; y &lt; 19; y++) {//    . Console.SetCursorPosition(77, y + 5);//     . Console.Write(9 - y); //    . } for (int x = 0; x &lt; 75; x++) { //     Console.SetCursorPosition(x, x % 3); //    . Console.Write(x + 1); //   . int point = (int)(data[x] * 9); //         -9  9. int step = (point &gt; 0)? -1 : 1; //     0. for (int y = point; y != step; y += step) {//   Console.SetCursorPosition(x, point + 14 - y); //    . Console.Write("‚ñà"); //  . } } }</span></span></code> </pre><br>  Now we can see what our two hertz looks like in a machine representation. <br><br><img src="http://habrastorage.org/storage2/e73/245/76b/e7324576b6f6a11ad1b2c5f7120f5986.png"><br><br>  But this is only one type of wave while there are many other types of waves, let's describe the functions capable of simulating the main types of waves and consider how they look. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Saw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2.0</span></span> * (index * frequency - Math.Floor(index * frequency )) <span class="hljs-number"><span class="hljs-number">-1.0</span></span>; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Saw function result</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage2/ece/b04/b98/eceb04b98e5d2118d3c760c7c0819bf2.png"><br></div></div><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Triangle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2.0</span></span> * Math.Abs (<span class="hljs-number"><span class="hljs-number">2.0</span></span> * (index * frequency - Math.Floor(index * frequency + <span class="hljs-number"><span class="hljs-number">0.5</span></span>))) - <span class="hljs-number"><span class="hljs-number">1.0</span></span>; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Triangle function result</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage2/b38/774/a47/b38774a4771ff061e7f80fa1ba524ec0.png"></div></div><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Flat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Math.Sin(frequency * index ) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">The result of the function Flat</b> <div class="spoiler_text"><img src="http://habrastorage.org/storage2/d8f/834/f18/d8f834f182e7ce9d6b2871d7ce1b0eaf.png"></div></div><br>  Note that the period of the Sine and Flat functions is 2 * Pi, and the period of the Saw and Triangle functions is one. <br><br><h3>  Write the Wav file </h3><br>  When we were able to create and even consider our sound, we would also like to hear it and for that let's record it in the .wav container and listen.  True, until we know how the Wave container works, we need to correct this annoying mistake!  So, the wave file is very simple: it consists of three parts, the first is the block header, the second is the format block, the third is the data block.  All together it looks like this: <br><img src="http://habrastorage.org/storage2/a05/715/b8c/a05715b8c136246fcae8c4f8e94baf96.png"><br>  Actually everything is very clear, the details on each of the items are described <a href="https://ccrma.stanford.edu/courses/422/projects/WaveFormat/">here</a> .  Since our task is extremely simple, we will always use the bit width equal to 16 bits and only one track.  The function that I will write now will save our PCM sound in the Wav container inside the stream, which will make the work more flexible.  So, this is how it looks. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveWave</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Stream stream, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span> { BinaryWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryWriter(stream); <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> frameSize = (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)(<span class="hljs-number"><span class="hljs-number">16</span></span> / <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     (16    8). writer.Write(0x46464952); //  "RIFF". writer.Write(36 + data.Length * frameSize); //     . writer.Write(0x45564157); //  "WAVE". writer.Write(0x20746D66); //  "frm ". writer.Write(16); //   . writer.Write((short)1); //  1  PCM. writer.Write((short)1); //  . writer.Write(sampleRate); //  . writer.Write(sampleRate * frameSize); //  (    ). writer.Write(frameSize); //    . writer.Write((short)16); // . writer.Write(0x61746164); //  "DATA". writer.Write(data.Length * frameSize); //    . for (int index = 0; index &lt; data.Length; index++) { //      . foreach (byte element in BitConverter.GetBytes(data[index])) { //       . stream.WriteByte(element); //     . } } }</span></span></code> </pre><br>  You see how simple everything is, and most importantly now we can hear our sound, let's generate 1 second of note for the first octave, its frequency is 440 Hz, with such a task, the Main function will look like this <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sampleRate = <span class="hljs-number"><span class="hljs-number">8000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   . short[] data = new short[sampleRate]; //   16  . double frequency = Math.PI * 2 * 440.0 / sampleRate; //   . for (int index = 0; index &lt; sampleRate; index++) { //  . data[index] = (short)(Sine(index, frequency) * short.MaxValue); //      32767  -32767. } Stream file = File.Create("test.wav"); //        . SaveWave(file, data, sampleRate); //     . file.Close(); //  . }</span></span></code> </pre><br>  We start the program and about a miracle!  We have a test.wav by downloading it in the player, listening to the squeaking before reaching the catharsis and moving on.  Let's look at our wave from all sides on the oscilloscope and spectrogram to make sure that we got exactly the result of which we achieved. <br><img src="http://habrastorage.org/storage2/46c/ad1/c63/46cad1c63cb3e39b1ee89f07401a6349.png"><br><img src="http://habrastorage.org/storage2/6d2/67a/fa6/6d267afa6f9918a9001dde07d8dae746.png"><br><br>  But in life the sounds do not sound endlessly, but subside, let's write a modifier that will silence our sound with time.  He will need absolute values, so we will give him a coefficient, a current position, a frequency, a factor multiplier and a sampling frequency, and he will calculate the absolute values ‚Äã‚Äãhimself, the coefficient should always be negative. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Length</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compressor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Exp(((compressor / sampleRate) * frequency * sampleRate * (position / sampleRate)) / (length / sampleRate)); }</code> </pre><br>  The line that calculates the sound level also needs to be changed. <br><br><pre> <code class="cs hljs">data[index] = (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)(Sine(index, frequency) * Length(<span class="hljs-number"><span class="hljs-number">-0.0015</span></span>, frequency, index, <span class="hljs-number"><span class="hljs-number">1.0</span></span>, sampleRate) * <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue);</code> </pre><br>  Now on the oscilloscope we will see a completely different picture. <br><img src="http://habrastorage.org/storage2/2e2/0cc/78e/2e20cc78ebc2b9cea1e0bbffe7dbbd48.png"><br><br><h3>  Write music </h3><br>  Since we managed to play the la note of the fourth octave, no one bothers us to play different notes.  Have you ever wondered how to find out the frequencies of notes?  It turns out there is a beautiful formula 440 * 2 ^ (absolute index of the note / 12).  If you look at any piano-like instrument, then remember that it has blocks of 7 white keys and 5 black, blocks are octaves, white keys are basic notes (up, re, mi, fa, sol, la, si) and black their halftones, that is, only 12 sounds in an octave, this is called a uniformly tempered scale. <br>  Let's look at the graph of this function. <br><img src="http://habrastorage.org/storage2/8f0/1f8/61e/8f01f861e88352b0724494a80eb7647c.png"><br>  But we will write down the notes in scientific notation, therefore we will slightly change the formula by lowering it by 4 octaves and we will write it down in our native form. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> octave</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">27.5</span></span> * Math.Pow(<span class="hljs-number"><span class="hljs-number">2</span></span>, (key + octave * <span class="hljs-number"><span class="hljs-number">12.0</span></span>) / <span class="hljs-number"><span class="hljs-number">12.0</span></span>); }</code> </pre><br>  Now that we have compiled the basic functionality and debugged its work, let's think over the architecture of the future synthesizer. <br>  The synthesizer will be a certain set of elements of the elements that will synthesize sound and overlay it on an empty data array in the right place; this array and elements of the elements will be contained in the track object.  The classes that describe them will be contained in the Synthesizer namespace, let's describe the Element and Track classes. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Element</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> frequency; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> compressor; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compressor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.frequency = Math.PI * <span class="hljs-number"><span class="hljs-number">2</span></span> * frequency / sampleRate ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.start = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(start * sampleRate); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.length = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(length * sampleRate); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compressor = compressor / sampleRate; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> position; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = start; index &lt; start + length * <span class="hljs-number"><span class="hljs-number">2</span></span>; index++) { position = index - start; result = <span class="hljs-number"><span class="hljs-number">0.5</span></span> * Sine(position, frequency) ; result += <span class="hljs-number"><span class="hljs-number">0.4</span></span> * Sine(position, frequency / <span class="hljs-number"><span class="hljs-number">4</span></span>); result += <span class="hljs-number"><span class="hljs-number">0.2</span></span> * Sine(position, frequency / <span class="hljs-number"><span class="hljs-number">2</span></span>); result *= Length(compressor, frequency, position, length, sampleRate) * <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue * <span class="hljs-number"><span class="hljs-number">0.25</span></span>; result += data[index]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &gt; <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue) result = <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result &lt; -<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue) result = -<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue; data[index] = (<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>)(result); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Length</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compressor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Exp((compressor * frequency * sampleRate * (position / sampleRate)) / (length / sampleRate)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.Sin(frequency * index); } }</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Track</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sampleRate; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Element&gt; elements = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Element&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>[] data; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> octave</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">27.5</span></span> * Math.Pow(<span class="hljs-number"><span class="hljs-number">2</span></span>, (key + octave * <span class="hljs-number"><span class="hljs-number">12.0</span></span>) / <span class="hljs-number"><span class="hljs-number">12.0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Track</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sampleRate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sampleRate = sampleRate; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> frequency, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> compressor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.length &lt; (start+ length * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) * sampleRate) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.length = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(start + length * <span class="hljs-number"><span class="hljs-number">2</span></span> +<span class="hljs-number"><span class="hljs-number">1</span></span>) * sampleRate; elements.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Element(frequency, compressor, start, length, sampleRate)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Synthesize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>[length]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> element <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> elements) { element.Get(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> data, sampleRate); } } }</code> </pre><br>  Now we come to the last function that will read the line with notes and generate our melody <br>  To do this, we will create a Dictionary which will associate the names of the notes with the indices, and will also contain the control keys / indices. <br>  The function itself will break the string into words and further process each word separately, dividing it into two parts - left and right, the right part always consists of one character (digit) which is written into the variable octave as a number, and the length of the first part is the word length - 1 (that is, the word minus the right part) and then serves as the key to our dictionary that returns the index of the note, after we have disassembled the word we decide what to do, if the index is managing, then we will execute the function corresponding to the index, and if not, this means that  we have the index of the note and we will add to our track a new sound of the length and frequency of our note we need. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Music</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> melody, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> temp = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">60.0</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] words = melody.Split(<span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> word <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> words) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> note = notes[word.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, word.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> octave = Convert.ToInt32(word.Substring(word.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (note &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (note) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: dtime = Math.Pow(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, octave + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">60.0</span></span> / temp); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: length += (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(Math.Pow(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, octave + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">60.0</span></span> / temp)); position += Math.Pow(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, octave + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">60.0</span></span> / temp); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Add(GetNote(note, octave), <span class="hljs-number"><span class="hljs-number">-0.51</span></span>, position, dtime); position += dtime; } } }</code> </pre><br><br>  From this point on, the melody can be written as <code>L4 B6 S4 D7 B6 F#6 S4 B6 F#6</code> Where L is a command that specifies the length of a note, and S creates a pause, the remaining characters are notes.  Actually, the writing of the software synthesizer is completed on this, and we can check the result by listening to the segment ‚ÄúBach‚Äôs joke‚Äù <br><br>  <a href="http://docs.google.com/uc%3Fid%3D0B4SFNiK8AJd-VUx0Zk9JMVQtMDQ%26export%3Ddownload">Binary file</a> <br>  <a href="http://docs.google.com/uc%3Fid%3D0B4SFNiK8AJd-Nm1VRTJFc2VWQlk%26export%3Ddownload">Source</a> </div><p>Source: <a href="https://habr.com/ru/post/178915/">https://habr.com/ru/post/178915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178895/index.html">Helvetica World, Competition and Event for Designers</a></li>
<li><a href="../178899/index.html">Create a video library with PHPixie</a></li>
<li><a href="../178901/index.html">Let there be Unity in your city</a></li>
<li><a href="../178903/index.html">A simple FM radio transmitter based on FPGA</a></li>
<li><a href="../178905/index.html">Optimistic programmers</a></li>
<li><a href="../178917/index.html">Yii2. Acquaintance</a></li>
<li><a href="../178919/index.html">Instagram filtered logo noise</a></li>
<li><a href="../178925/index.html">Linux Mint 15 "Olivia"</a></li>
<li><a href="../178927/index.html">We continue to train the brain. We add competitions</a></li>
<li><a href="../178937/index.html">Sync iTunes on two or more computers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>