<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chat bot applications via skype, jabber and whatsapp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 I would like to tell you the story of creating one uncomplicated entertainment service chat bots. 

 Introduction 
 About me: Habr has been r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chat bot applications via skype, jabber and whatsapp</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  I would like to tell you the story of creating one uncomplicated entertainment service chat bots. <br><br><h5>  Introduction </h5><br>  About me: Habr has been reading for a long time (5 years old), but I registered a month ago, because I really wanted to share it.  I work in an IT company as a testing engineer.  But I was always drawn to the development.  And 7 years ago I took up freelance in parallel with the main work.  I started, like everything small, understood with the help of google.  He wrote all kinds of web lewdness.  All this in order to achieve certain financial goals.  And in general, all life consisted of a cycle: searching for a goal ‚Äî reaching by any means ‚Äî satisfaction ‚Äî looking for a new goal.  So it was with freelance. <br><br><h5>  Crucial moment </h5><br>  It was the winter of 2012/2013.  I worked on freelance on the project of an <a href="http://habrahabr.ru/post/218421/">online consultant</a> , and I had to do the integration with jabber and skype, that is, so that the operators could work with the client by typing in their im client, and the site user received it all on the web.  After searching in google, it turned out that everything is simple with jabber, any xmpp server to choose from (I chose ejabbered) and the library to work with it JAXL (picked up on github), then version 2.x.  But there were problems with Skype: the site in the Developers section offered some kind of kit for money (and a license prohibiting server use), with unnecessary activations for me and mentioning some kind of api.  And I wanted something more simple.  And then I stumbled upon this api in <a href="http://habrahabr.ru/post/149850/">‚ÄúAccess to Skype API using PHP on * nix systems‚Äù</a> , now on skype there is no mention of working with api already, although it was then, and I downloaded pdf to work with it via dbus.  There was everything that I was looking for. <br><a name="habracut"></a><br>  Several problems arose at once that were not described in the article I read, if the system is x64, then skype required some x86 dependencies: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">sudo dpkg --add-architecture i386 sudo aptitude update</code> </pre> <br><br>  Receiving messages on the server side: <br><br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'#RECEIVED|SENT#Uis'</span></span>)</code> </pre><br>  - does not work correctly, as it responds to all messages <br>  - and in general it is better not to use such a construction, since some messages disappear in the depths of dbus, and php does not get to them, that is, the script for the while () loop often does not have time to receive all messages or does not receive messages at all.  By trial and error method was found 100% catching all the messages and even after idle script or reboot, here it is: <br><br><pre> <code class="php hljs">$oSkype-&gt;Invoke(<span class="hljs-string"><span class="hljs-string">'SEARCH MISSEDMESSAGES'</span></span>)</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">phpSkype</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $iLastId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sNotify)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//.... //.... //.... /* Message serving 4 */ if (preg_match('/^CHATMESSAGES/', $sNotify)) { $sNotify = str_replace('CHATMESSAGES ', '', $sNotify); if ($sNotify != '') { $aMessages = explode(', ', $sNotify); if (sizeof($aMessages)) { foreach ($aMessages as $iMessageId) { $sAuthRaw = $oSkype-&gt;Invoke('GET CHATMESSAGE ' . $iMessageId . ' FROM_HANDLE'); $sMessageRaw = $oSkype-&gt;Invoke('GET CHATMESSAGE ' . $iMessageId . ' BODY'); $aMessage = explode('BODY ', $sMessageRaw); $aUsernameSkype = explode('FROM_HANDLE ', $sAuthRaw); $aChatHash = explode('CHATNAME ', $oSkype-&gt;Invoke('GET CHATMESSAGE ' . $iMessageId . ' CHATNAME')); verifyUserSkypeChatId($aUsernameSkype[1], $aChatHash[1]); if (self::$iLastId &lt; $iMessageId) { self::$iLastId = $iMessageId; addLog($aUsernameSkype[1], $aMessage[1]); self::received($aUsernameSkype[1], trim(strtolower($aMessage[1])), $iMessageId); } else { $oSkype-&gt;Invoke('SET CHATMESSAGE ' . $iMessageId . ' SEEN'); } } } } } //.... //.... //.... } public static function received($sUid, $sMessage, $iLastMsgId) { $oSkype = Zend_Registry::get('$oSkype'); // Mark received message as read $oSkype-&gt;Invoke('SET CHATMESSAGE ' . $iLastMsgId . ' SEEN'); /* Prepare */ $sChatIdRaw = $oSkype-&gt;Invoke('GET CHATMESSAGE ' . $iLastMsgId . ' CHATNAME'); $aChatId = explode('CHATNAME ', $sChatIdRaw); $sMembers = $oSkype-&gt;Invoke("GET CHAT " . $aChatId[1] . " ACTIVEMEMBERS"); $sMembers = str_replace('CHAT ' . $aChatId[1] . ' ACTIVEMEMBERS ', '', $sMembers); $aMembers = explode(' ', $sMembers); if (sizeof($aMembers) &gt; 2) { $oSkype-&gt;Invoke("ALTER CHAT " . $aChatId[1] . " CLEARRECENTMESSAGES"); $oSkype-&gt;Invoke("ALTER CHAT " . $aChatId[1] . " DISBAND"); $oSkype-&gt;Invoke("ALTER CHAT " . $aChatId[1] . " LEAVE"); return false; } //.... //.... //.... } } $oDbus-&gt;registerObject('/com/Skype/Client', 'com.Skype.API.Client', 'phpSkype'); $bSMLastUpdate = 0; while (true) { $s = $oDbus-&gt;waitLoop(1); /* Get new skype messages */ global $bSMLastUpdate; if (time() - $bSMLastUpdate &gt;= $aConfig['skype_get_new_message']) { $bSMLastUpdate = time(); $oSkype-&gt;Invoke('SET USERSTATUS ONLINE'); $oSkype-&gt;Invoke('SEARCH MISSEDMESSAGES'); } }</span></span></code> </pre><br></div></div><br>  Which sends all not processed messages to dbus (which do not have the SEEN flag): <br><pre> <code class="php hljs">$oSkype-&gt;Invoke(<span class="hljs-string"><span class="hljs-string">'SET CHATMESSAGE '</span></span> . $iMessageId . <span class="hljs-string"><span class="hljs-string">' SEEN'</span></span>);</code> </pre><br>  and in the main cycle we catch them with: <br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'/^CHATMESSAGES/'</span></span>, $sNotify)</code> </pre><br>  The same is done for authorizations from users to the bot (the future user can register by simply sending the authorization on skype), namely: <br><pre> <code class="php hljs">$oSkype-&gt;Invoke(<span class="hljs-string"><span class="hljs-string">"SEARCH USERSWAITINGMYAUTHORIZATION"</span></span>)</code> </pre><br>  and not wait: <br><pre> <code class="php hljs">preg_match(<span class="hljs-string"><span class="hljs-string">'/^USER ([a-zA-Z0-9_\.]+) RECEIVEDAUTHREQUEST (.)+/'</span></span>, $sNotify, $aMatches)</code> </pre><br>  which also occasionally misfired.  Another nuance is connected with this, if we need to know that the user has deleted the bot from the contact list, it is initiated: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* Client unlink */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preg_match(<span class="hljs-string"><span class="hljs-string">'/BUDDYSTATUS 2/'</span></span>, $sNotify)) { <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  But you have to be careful and monitor the situation when a similar problem occurs when sending authorization from the bot to the user: <br><pre> <code class="php hljs">$oSkype-&gt;Invoke(<span class="hljs-string"><span class="hljs-string">"SET USER [USER_NAME] BUDDYSTATUS 2 [AUTH_MESSAGE]"</span></span>);</code> </pre><br>  But I couldn‚Äôt solve the problem of skype bots going away after OS users crash after inactivity.  Although in the skype settings there is away_mode = off and this line does not help: <br><pre> <code class="php hljs">$oSkype-&gt;Invoke(<span class="hljs-string"><span class="hljs-string">'SET USERSTATUS ONLINE'</span></span>);</code> </pre><br>  Only after that, skype began to work stably. <br><br>  And so I started setting up on ... freebsd then 9.x, like all my developments, oh, and I liked this system, I struggled with it for a long time, but I didn‚Äôt start skype through dbus, then I rested in <a href="http://askubuntu.com/questions/135573/gconf-error-no-d-bus-daemon-running-how-to-reinstall-or-fix">session</a> x- manager and dbus and their inconsistency and: <br><pre> <code class="bash hljs">  /root/.dbus/session-bus/ id  dbus      <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DBUS_SESSION_BUS_ADDRESS=8c9916eb531f5f9a0458961c000033bc-1</code> </pre><br>  it did not always help, I had to put everything on linux, as indicated in the article on Habr√©, I chose debian.  Though backend web also remained on freebsd and they communicated among themselves through memcache.  Yes, yes, a notable "bicycle", but more on that below. <br>  The chat bots code was associated with the web code, I wanted to make it as soon as possible and therefore, instead of taking good decisions on Message Queues that I hadn‚Äôt used before, and didn‚Äôt understand much, I began to sculpt my turn from php + memcache with my logic lock'ov to make the registration, and the distribution of authorizations and messages in im clients of operators asynchronous.  It was a terrible "machine" in which you could break your eyes - but it worked and still works, as far as I know.  Imagine: 6 bots / OS users, 6 raised virtual desktops separately for each user debian, 6 vnc windows, each of them has 4 scripts (skype and jabber bot, the workers I wrote in line).  Each server reboot turned into hard work, logged in with six users, open for each vnc, open a terminal and run 4 php scripts there.  The bots routinely crashed with some strange errors, in particular JAXL, when using VNC dropped from: <br><pre> <code class="php hljs">Interrupted system call  jaxl_loop.php</code> </pre><br>  it was treated by changing / deleting fields in the place of initialization of ‚Äúnew JAXL ()‚Äù, the search of which in google within the framework of very tight deadlines, did not allow to solve them carefully. <br><br><h5>  Ready, steady, go </h5><br>  In the spring of 2013, I decided to amuse my perfectionism and thought that I should write an interesting and necessary in terms of ideas, and beautiful in terms of code, and not as usual.  And started looking for ideas.  And she, as it turned out, was under my very nose.  For example, I often call the calculator in windows7 or macos or watch the weather in my phone.  And almost all day, while awake, I spend at the computer.  The conclusion asked itself, it is necessary to transfer frequently used operations to constantly open applications and reduce the number of operations performed for existing tasks on the computer.  Bingo.  I frantically went to google to look for ready-made solutions, namely all kinds of applications implemented as chat bots through the popular im protocols.  And at that time I did not find one (I was looking bad?).  You need to write your own, it will be free and most importantly I will use it myself.  I had to write a chat bots, which for USSD teams could interact with users via skype and jabber (later whatsapp), just write better than before and make a complete solution, choose a domain name, logo, site design, the site itself and everything the rest is necessary for this, that is, the full development cycle and deployment to prod. <br><br>  The task is not easy, and I have never done it before.  But one has only to do the 1st step ...  And he was already done.  To be honest, I immediately thought how cool it would be to monitor the server and have an ssh console emulation in my skype / jabber / whatsapp to monitor the server (while this task has been postponed for implementation, although there are some partial developments already). <br>  And I really wanted to have an analogue of the ‚Äúemail for 10 minutes‚Äù service, having written the owner of a popular service about integration into mine, I did not expect anything good, my intuition did not let down, the developer of this system politely refused, saying that the service is free, and the developer barely covers his time spent advertising on this service.  And I use it so often.  Well, okay, I started to make my own bike on this topic, but I haven‚Äôt finished writing it yet, so I didn‚Äôt try to make all the tested ideas quickly. <br>  It didn't work out with freelance (but I was not very upset, it was financially the goal, freelance helped solve it, there were no other goals, oh yes, I took myself a sport bike and now I‚Äôm sure there were no more goals) and free time appeared (although I continued to work constantly in the former IT company, but already on more interesting projects, but still so far from what I liked).  For two months I sawed the code, anyway it was some kind of monster in terms of php code in the chat bot section.  But the design of the site has so far remained almost untouched, I immediately started making flat ui - it seemed to me success in the near future.  The end of spring, I experience personal problems of a different nature, and forget about this service and its development, I return in November 2013 and the first thing I do is delete all the chat bots code.  And I start writing it again and without a queue for memcache. <br><br><h5>  From the scratch </h5><br>  I wrote the text of the future architecture, the structure of modules (web, api, bot).  I compiled a documentation on the storage structure in memcache - in the future it all came to the rescue, so as not to keep large volumes of logic in his ‚Äúmemory palace‚Äù. <br>  The beginning was in my head: <br>  <b>Web</b> : <code>freebsd 10 + php 5.x + apache + mysql 5.x + apc</code> , in the <a href="http://habrahabr.ru/post/70167/">second reading</a> <br> <code>php 5.x  nginx + php-fpm,   apc,    opcache.</code> <br>  <b>Chatbot</b> : <code>debian wheezy  gnome + php 5.x + skype + memcache (    ,      ) + ejabbered  JAXL 2.x (  3.x)+ rabbitMQ (     )  PhpAmqpLib (       memcache   github).</code> <br><br>  Architecture for each application: bot listner for skype, bot listner for jabber, bot listner for whatsapp, user worker (rabbitMQ) to process add / delete user and add / delete service, api worker (rabbitMQ) to call api methods, spamer worker (rabbitMQ) for sending messages and three helpers (for all protocols) are the simplest bot senders that receive commands from the user worker and the spamer worker, are also called in the background and are closed after work and immediately implement all bot activity ( withdraw the authorization, send the authorization with the message ‚ÄúX‚Äù, and send the message). <br><br>  While I was sawing and testing, a colleague from work, who looked at my work, suggested: <br><blockquote>  And come on viber too! </blockquote><br>  And I again turned to my indispensable assistant - google.  There was nothing about open api, but I found options for using whatsapp and screwed it to the service (I took the WhatsProt library code on github).  But wait, because whatsapp is mainly for non-Russian speakers, you need to make translations for bots and on the site.  I read <a href="http://habrahabr.ru/company/alconost/blog/166931/">‚ÄúWhat languages ‚Äã‚Äãto translate the project in the first place?‚Äù</a> And chose English, Russian, Simplified Chinese, German and Spanish, then refused to speak Chinese, no one in my acquaintances in it understood to make artistic changes. <br>  Took ZF 2.x for the basis for the web.  I planned to implement all the applications as a single bot, and then each application - as a separate bot.  The first scheme was very unstable (since I still relied on memcache as an undocumented cache and as a ‚Äúmessage queue‚Äù), and I refused it, but then returned partially.  And the second one after 8 bots began to clutter up my contact list in skype and jabber, and also ate off resources on my local virtual machine at an incredible speed, especially skype itself, since for each bot I had to launch an individual user with my desktop and my skype ( although it is possible to run several different skype in the same environment, and bind to api each by id dbus sessions - but I have not tried it yet), and I abandoned this scheme, later I combined them, now each bot implements several applications grouped by  Thoughts.  I started with this set of applications: <br><ul><li>  Basic (various operations and user statistics) </li><li>  Calculator </li><li>  Weather </li><li>  The game with the mechanics of the "Tower of Hanoi" (I have not yet released it in prod, because I have not yet figured out how to draw ASCII pyramids with art without spreading, on skype the font plays games with me) </li><li>  <a href="http://en.wikipedia.org/wiki/Magic_8-Ball">Magic Ball 8</a> </li><li>  Ability to send a message (even to an unregistered) user from any client to any of the three available (from the bots themselves and from the web site without authorization) </li><li>  Exchange rates <br><ol><li>  Conversion rate </li><li>  <a href="http://openexchangerates.org/">World source</a> </li><li>  European Central Bank </li><li>  OCBC Bank (Singapore) </li><li>  Central Bank of Russia </li><li>  National Bank of Ukraine </li><li>  National Bank of Belarus </li><li>  Bank of China </li><li>  Bank of Canada </li><li>  Bitcoin courses </li></ol></li></ul><br>  For November and December and January I wrote an almost stable version and, most importantly, suitable for testing my friends. <br>  But then the article <a href="http://habrahabr.ru/post/180145/">‚ÄúGoogle refuses to support XMPP‚Äù</a> caught my eye, and I was a little upset.  But after a while, after the article <a href="http://habrahabr.ru/post/180159/">"Do not panic!</a>  <a href="http://habrahabr.ru/post/180159/">About what Google did with XMPP, ‚Äù</a> I realized that everything is just fine and I myself constantly use google xmpp.  It's time to pour everything on the hosting.  My test VM for 7 bots (three scripts for each bot / application (skype-jabber-whatsapp) and 3 workers for each application: user worker, api worker (I wrote all the interaction with the database through api - just why, so far I do not understand, but modularly and with one entry point for the web and bots it turned out, it became easier to test), and the spam worker, all workers worked through the Hare MQ) consumed 3.5 GB of RAM, and all hosters had tariffs of 2 and 4 GB with a cost of 2 times more for 4GB, which did not suit me, so all this is from my own pocket and the service is free, I wrote to the ‚Äúdigital ocean‚Äù (which I also read about  l Habr√©) on the request of the needs of this service is to give the VM with a different number of RAM, but with a weaker processor, it was not critical.  I refused.  Expected.  I found a comparison of hosters on ‚Äúcomparevps‚Äù and for money the same as for 2GB, I took the system with 4GB, although the actual experience with this hoster turned out to be slightly worse than expected, everything is worth its money (in this case, unfortunately).  And I wrote two step-by-step instructions for installing freebsd and debian servers to the stage of a fully working service in order to quickly get purchased VPS. <br><br>  But taking two servers (freebsd for web + debian for chat bots) was not easy, I started to put everything on one.  And it was debian, I was unpleasantly surprised that I couldn‚Äôt put the latest versions of what I needed from packages, how could I do this on the freebsd build and ports.  Then I figured out how I ended up being a linux and debian hater in particular, and became a fanatic in a good way (I now also have to have a Red Hat ‚Äúmust have‚Äù). <br><br>  I added new applications to my friends on the tip: <br><ul><li>  World clock (offsets, time, sunset, sunrise and time zone) </li><li>  Hash generator </li><li>  Habra parser (bot gives me all the links to the best articles per day with a brief description) </li><li>  The horoscope (the difficulty was in that for all supported languages ‚Äã‚Äãit was necessary to look for original horoscopes, since translating them on the fly is bad) </li></ul><br>  Bots became 11, for each 6 scripts (1st ‚Äì skype, 2nd ‚Äìjabber, 3rd - whatsapp and three workers), the system lacked 4GB.  The time has come to understand that it is necessary to combine applications into thematic bots, as I said earlier, it is said - done.  Base, Office (calculator, currency rates, world clocks), Lifestyle (weather, horoscope, 8k), Developer (habra, hash) appeared.  Now 2.5GB and all is well.  Then I was a little tired, slowly read <a href="http://habrahabr.ru/post/208338/">‚ÄúJabber switches to full encryption‚Äù</a> and decided to test my server on xmpp.net and received an A- rating, which could not be good.  By the way, for a long time I could not get my ejabbered server to become public (as well as add inter-server communication) until I did this in the DNS <br><img src="https://habrastorage.org/getpro/habr/post_images/343/2a5/202/3432a5202b097d672d130ffd7c61c2fe.png" alt="image"><br><br>  But I still did not have ssl certificates for either the jabber or the site.  Two for $ 60 I did not smile, and then I found the article <a href="http://habrahabr.ru/post/127643/">"Get a free SSL certificate"</a> and rushed.  Everything is simple and clear. <br><br>  There was always one problem that completely finished me: I was very tired of restoring all services with my hands, when the server because of the hoster fell or after a reboot just stood there, I had to solve somehow the problem that I only found out about it on Monday it happened on saturday.  I tried many different things, in the end, the system after rebooting, completely automatically logs in all * nix users (for skype), the terminal starts under them in a graphical shell, opens six tabs and starts the necessary php script in each one so that I can go in and see it output at any time (for debug occasional minor issues): <br><div class="spoiler">  <b class="spoiler_title">Debian autologin all users and running scripts in the terminal in graphical mode</b> <div class="spoiler_text"><pre> <code class="bash hljs">&gt;&gt;nano /etc/inittab 8:2345:respawn:/bin/login -f _ tty8 &lt;/dev/tty8 &gt;/dev/tty8 2&gt;&amp;1 9:2345:respawn:/bin/login -f lifestyle tty9 &lt;/dev/tty9 &gt;/dev/tty9 2&gt;&amp;1 10:2345:respawn:/bin/login -f developer tty10 &lt;/dev/tty10 &gt;/dev/tty10 2&gt;&amp;1 11:2345:respawn:/bin/login -f xmess tty11 &lt;/dev/tty11 &gt;/dev/tty11 2&gt;&amp;1 12:2345:respawn:/bin/login -f office tty12 &lt;/dev/tty12 &gt;/dev/tty12 2&gt;&amp;1 &gt;&gt;nano /etc/profile sleep 8 [ `tty` == <span class="hljs-string"><span class="hljs-string">'/dev/tty8'</span></span> ] &amp;&amp; startx -- :1 sleep 8 [ `tty` == <span class="hljs-string"><span class="hljs-string">'/dev/tty9'</span></span> ] &amp;&amp; startx -- :2 sleep 8 [ `tty` == <span class="hljs-string"><span class="hljs-string">'/dev/tty10'</span></span> ] &amp;&amp; startx -- :3 sleep 8 [ `tty` == <span class="hljs-string"><span class="hljs-string">'/dev/tty11'</span></span> ] &amp;&amp; startx -- :4 sleep 8 [ `tty` == <span class="hljs-string"><span class="hljs-string">'/dev/tty12'</span></span> ] &amp;&amp; startx -- :5</code> </pre><br>  ‚ÄúSleep‚Äù is needed for everything to start, including skype. <br>  And in the gnome autoload of each OS user (which is designed to execute bot scripts) add skype and bot maintenance scripts to: <br><pre> <code class="bash hljs">/home/USERNAME/.config/autostart/</code> </pre><br><pre> <code class="bash hljs">[Desktop Entry] Type=Application Exec=skype Hidden=<span class="hljs-literal"><span class="hljs-literal">false</span></span> X-GNOME-Autostart-enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> Name[en_US]=skype Name=skype Comment[en_US]= Comment=</code> </pre><br><pre> <code class="bash hljs">[Desktop Entry] Type=Application Exec=gnome-terminal --tab --title=<span class="hljs-string"><span class="hljs-string">"skype"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/_skype_assistant/base_assistant.php"</span></span> --tab --title=<span class="hljs-string"><span class="hljs-string">"jabber"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/_jabber_assistant/base_assistant.php"</span></span> --tab --title=<span class="hljs-string"><span class="hljs-string">"whatsapp"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/_whatsapp_assistant/base_assistant.php"</span></span> --tab --title=<span class="hljs-string"><span class="hljs-string">"user_op"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/lib/worker/user_operations_worker.php base_assistant"</span></span> --tab --title=<span class="hljs-string"><span class="hljs-string">"api"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/lib/worker/api_worker.php base_assistant"</span></span> --tab --title=<span class="hljs-string"><span class="hljs-string">"spamer"</span></span> -e <span class="hljs-string"><span class="hljs-string">"/usr/local/bin/php /home/_/utils/assistant/lib/worker/spamer_worker.php base_assistant"</span></span> Hidden=<span class="hljs-literal"><span class="hljs-literal">false</span></span> X-GNOME-Autostart-enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> Name[en_US]=all_tabs Name=all_tabs Comment[en_US]= Comment=</code> </pre><br><br>  To reload the entire bot, I use: <br><pre> <code class="bash hljs">killall -u lifestyle   background  /bin/login -f lifestyle tty9 &lt;/dev/tty9 &gt;/dev/tty9 2&gt;&amp;1 &amp;</code> </pre><br></div></div><br>  And to get email when shutdown and / or startup used <a href="http://linuxaria.com/pills/email-on-shutdown-and-restart-linux%3Flang%3Den">this</a> script.  Now I always knew what was happening with the server and knew that it would rise completely by itself and all the bots would work, even after surprises.  Plus, I configured backup bd with rotation and storage of dumps into the mail (they are still small). <br><br>  I read on Habr√© about heartbleed, and how, probably, I checked my server - everything was OK, but I couldn‚Äôt turn on TLS 1.2 and get F all the time, and I found exploit for heartbleed at the same time to test various services, because I never I didn‚Äôt study, it was interesting to try myself as a security engineer, I also tried nikto.pl and got inspired by nessus scanners.  But back to the chat bots, I and libssl rearranged and openssl which ‚Äúg‚Äù and checking the nginx dependencies, constantly saw that it was linked from the old lib, it turned out I just put nginx for squeeze instead of wheezy.  Although this was the cause of the old libssl linked to nginx, due to which I did not have a vulnerability.  ‚ÄúAccident,‚Äù you say.  "Accidents are not accidental," I will answer. <br><br>  By the way for whatsapp, as I understand it, the free receipt of the password from the account will be closed after a while, now it is very easy to get it: <br><div class="spoiler">  <b class="spoiler_title">get password for your whatsapp account</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* Request sms code */</span></span> $username = <span class="hljs-string"><span class="hljs-string">""</span></span>; $token = md5($username); $nickname = <span class="hljs-string"><span class="hljs-string">"__"</span></span>; $w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WhatsProt($username, $token, $nickname, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $w-&gt;codeRequest();</code> </pre><br>  Then <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* Get password */</span></span> $username = <span class="hljs-string"><span class="hljs-string">""</span></span>; $token = md5($username); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $token; $nickname = <span class="hljs-string"><span class="hljs-string">"__"</span></span>; $w = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WhatsProt($username, $token, $nickname, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $result = $w-&gt;codeRegister(<span class="hljs-string"><span class="hljs-string">"SMS___"</span></span>); $password = $result-&gt;pw; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Password is $password"</span></span>;</code> </pre><br></div></div><br>  But there is a problem that each new connection (in my scheme, one script listens to commands, and the other sends the answers received through the queue) interrupts the current one.  It was necessary for whatsapp to refuse partly from the queues and to make an automatic restart of the php script itself. <br>  Here is an interesting hint for the jabber bot, so that it shows the ‚Äútyping‚Äù status when the user writes something to it: <br><div class="spoiler">  <b class="spoiler_title">JAXL bot typing status</b> <div class="spoiler_text"><pre> <code class="php hljs">$oJabber-&gt;add_cb(<span class="hljs-string"><span class="hljs-string">'on_chat_message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($oStanza)</span></span></span><span class="hljs-function"> </span></span>{ sMessage = trim(strtolower($oStanza-&gt;body)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$sMessage) { $oStanza-&gt;to = $oStanza-&gt;from; $oStanza-&gt;from = $oJabber-&gt;full_jid-&gt;to_string(); $oJabber-&gt;send($oStanza); } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶. }</span></span></code> </pre><br></div></div><br> ,  whatsapp  skype ,   spamer ,             ,    <br><pre> <code class="php hljs">posix_kill(getmypid(), <span class="hljs-number"><span class="hljs-number">9</span></span>);</code> </pre><br>   jabber  <br><pre> <code class="php hljs">$oJabber-&gt;send_end_stream();</code> </pre><br>    : <br><ul><li>   </li><li> email  10  </li><li>    im </li><li>          skype / jabber       </li></ul><br>        ,        .    ,   ,   ( )   . <br><br>  ,    -       ,                github.        ,      ,      xml  whatsapp      ¬´typing¬ª ,    : <br><div class="spoiler"> <b class="spoiler_title">whatsapp get user message</b> <div class="spoiler_text"><pre> <code class="php hljs">$oWa-&gt;pollMessages(); $mData = $oWa-&gt;getMessages(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($mData)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'message'</span></span> === $mData[count($mData) - <span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;getTag()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">'notify'</span></span> === $mData[count($mData) - <span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;getChildren()[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;getTag()) { $oDbAdapter-&gt;getConnection(); received($oWa-&gt;parseJID($mData[count($mData) - <span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;getAttributes()[<span class="hljs-string"><span class="hljs-string">'from'</span></span>]), $mData[count($mData) - <span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;getChildren()[<span class="hljs-number"><span class="hljs-number">2</span></span>]-&gt;getData());<span class="hljs-comment"><span class="hljs-comment">//$sUid, $sMessage $oDbAdapter-&gt;closeConnection(); } } }</span></span></code> </pre><br></div></div><br> <b></b> :        ¬´¬ª  ,   , !    . <br><br> <b>PS 1</b> :          ,             <a href="http://habrahabr.ru/post/219209/">¬´ :    ¬ª</a> .        ,         .        ,     .     ,       ,      . <br><br> : <a href="https://youtu.be/Efox9e30II8">Free Object Motion Tracking Plugin at Final Cut Pro X, Adobe Premier and DaVinci Resolve.</a> </div><p>Source: <a href="https://habr.com/ru/post/220231/">https://habr.com/ru/post/220231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220215/index.html">We disassemble Sony Xperia Z2, the new flagship with an unusual cooling system</a></li>
<li><a href="../220219/index.html">We distribute 500K to the organization of circles of robotics</a></li>
<li><a href="../220225/index.html">HackDay City: from idea to prototype project for a city in 48 hours!</a></li>
<li><a href="../220227/index.html">What gets into deny ip any any?</a></li>
<li><a href="../220229/index.html">JSCS: JavaScript Code Style</a></li>
<li><a href="../220233/index.html">Creating a Custom Scope in JEE and Spring</a></li>
<li><a href="../220235/index.html">History of one internationalization</a></li>
<li><a href="../220237/index.html">12 little-known CSS features</a></li>
<li><a href="../220239/index.html">Sandbox Augmented Reality</a></li>
<li><a href="../220241/index.html">Domestic processor "Elbrus-4C" will soon be launched into mass production</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>