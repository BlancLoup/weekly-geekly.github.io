<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Again about IDS or ELK for suricata</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Hi! 
 Today I want to share with you the experience of setting up ELK and IDS Suricata. There are many manuals on the Internet, but none of them wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Again about IDS or ELK for suricata</h1><div class="post__text post__text-html js-mediator-article">  Hi Hi! <br>  Today I want to share with you the experience of setting up ELK and IDS Suricata.  There are many manuals on the Internet, but none of them will allow to ‚Äúimport‚Äù a bundle of these products in current versions. <br>  There is also a ready-made SELKS distribution kit - <a href="https://www.stamus-networks.com/open-source/">www.stamus-networks.com/open-source/#selks</a> or, alternatively, a bunch of snort, snorby and barnyard2 in SecOnion - <a href="http://blog.securityonion.net/">blog.securityonion.net</a> . <br>  For the rest I ask under the cat. <br><a name="habracut"></a><br>  So, what we need: <br>  A system that will visually display events from IDS, and that this is not ArcSight, OSSIM, QRadar, etc. <br>  To begin, find something from RHEL7 or CentOS7.  Ubuntu LTS is also possible, which you prefer for production. <br>  As well as the components themselves ELK and IDS. <br>  Suricata - <a href="http://suricata-ids.org/">suricata-ids.org</a> <br>  ElasticSearch - <a href="https://www.elastic.co/products/elasticsearch">www.elastic.co/products/elasticsearch</a> <br>  Logstash - <a href="https://www.elastic.co/products/logstash">www.elastic.co/products/logstash</a> <br>  Kibana - <a href="https://www.elastic.co/products/kibana">www.elastic.co/products/kibana</a> <br>  Well, to blow to make a miracle ... I mean, think! <br><h4>  IDS </h4><br>  First, install the necessary components (java, json): <br><pre><code class="bash hljs">yum -y install java-1.8.0-openjdk-devel.x86_64 yum -y install gcc libpcap-devel pcre-devel libyaml-devel file-devel zlib-devel jansson-devel nss-devel libcap-ng-devel libnet-devel tar make libnetfilter_queue-devel lua-devel</code> </pre> <br>  Download and install ids suricata: <br><pre> <code class="bash hljs">wget http://www.openinfosecfoundation.org/download/suricata-3.0.tar.gz tar -xvzf suricata-3.0.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> suricata-3.0 ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nfqueue --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-lua</code> </pre><br>  Further <br><pre> <code class="bash hljs">make; sudo make install; sudo ldconfig</code> </pre><br>  Or the following commands for automatic configuration: make install-conf;  make install-rules <br>  make install-full ‚ÄìIf you do not need to fine-tune something, I recommend using this command.  Variables will be automatically created, folders and rules will be rendered correspondingly to the / rules directory. <br>  During automatic installation, the directory with logs we need will be located in: <br><pre> <code class="bash hljs">@srv-ids ~]<span class="hljs-comment"><span class="hljs-comment"># cd /var/log/suricata/</span></span></code> </pre><br>  Here are the files: eve.json fast.log http.log stats.log.  But not all files are equally useful.  We need the one whose json tail <br>  Now you need to configure IDS.  We will only focus on the fact that alerts fall into the json file.  Go to /etc/suricata/suricata.yaml and find there a block for logging or alerts.  For output in json you need this config: <br><pre> <code class="bash hljs">- eve-log: enabled: yes filetype: regular <span class="hljs-comment"><span class="hljs-comment">#regular|syslog|unix_dgram|unix_stream|redis filename: eve.json</span></span></code> </pre><br>  The rest of the config is at your discretion.  Fortunately there is something to think about. <br><h4>  ELK </h4><br>  Next elsasticsearch: <br>  Checking what's up with java: <br><pre> <code class="bash hljs">java ‚Äìversion <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span></code> </pre><br>  If everything is ok, we continue (otherwise, to the beginning of the note). <br>  Download and install elasticsearch: <br><pre> <code class="bash hljs">wget https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/rpm/elasticsearch/2.2.1/elasticsearch-2.2.1.rpm sudo rpm -Uvh ./elasticsearch-2.2.1.rpm sudo systemctl daemon-reload sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> elasticsearch.service sudo systemctl start elasticsearch.service sudo systemctl status elasticsearch.service</code> </pre><br>  Status ‚ÄìOK?  Let's go for Logstash <br><pre> <code class="bash hljs">wget https://download.elastic.co/logstash/logstash/packages/centos/logstash-2.2.2-1.noarch.rpm sudo rpm -Uvh ./logstash-2.2.2-1.noarch.rpm</code> </pre><br>  Tver needs to configure it, go to /etc/logstash/conf.d/ <br>  This is how the working logstash config for current versions of software components looks like: <br><pre> <code class="bash hljs">input { file { path =&gt; [<span class="hljs-string"><span class="hljs-string">"/var/log/suricata/eve.json"</span></span>] <span class="hljs-comment"><span class="hljs-comment">#sincedb_path =&gt; ["/var/lib/logstash/"] codec =&gt; json type =&gt; "SuricataIDPS-logs" start_position =&gt; "beginning" } } filter { if [type] == "SuricataIDPS-logs" { date { match =&gt; [ "timestamp", "ISO8601" ] } ruby { code =&gt; "if event['event_type'] == 'fileinfo'; event['fileinfo']['type']=event['fileinfo']['magic'].to_s.split(',')[0]; end;" } } if [src_ip] { geoip { source =&gt; "src_ip" target =&gt; "geoip" #database =&gt; "/opt/logstash/vendor/geoip/GeoLiteCity.dat" add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][longitude]}" ] add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][latitude]}" ] } mutate { convert =&gt; [ "[geoip][coordinates]", "float" ] } } } output { elasticsearch { hosts =&gt; ["localhost:9200"] } #stdout { codec =&gt; rubydebug } }</span></span></code> </pre><br>  Save, check the configuration: <br><pre> <code class="bash hljs">@srv-ids ~]<span class="hljs-comment"><span class="hljs-comment"># service logstash configtest Configuration OK</span></span></code> </pre><br>  Finally, we install the web face of our IDS system - Kibana4. <br><pre> <code class="bash hljs">wget https://download.elastic.co/kibana/kibana/kibana-4.4.2-linux-x64.tar.gz</code> </pre><br>  Unpack it into a folder, like this: / opt / kibana4 / or / var / www / html /.  In the / opt / kibana4 / bin / directory, start the web interface.  You can make the service as - described here <a href="https://discuss.elastic.co/t/run-kibana-as-service-on-centos/23971/2">discuss.elastic.co/t/run-kibana-as-service-on-centos/23971/2</a> .  I did not do it. <br>  It happens that when starting kibana, the error ‚Äúkibana is still indexing‚Äù appears, this can be seen in the console or on the web dashboard in the ‚ÄúStatus‚Äù dashboard.  To eliminate the error, we make the following commands with success checks: <br><pre> <code class="bash hljs">curl -XDELETE http://localhost:9200/.kibana curl -XDELETE http://localhost:9200/*</code> </pre><br>  Now we need indexes.  Come here <a href="https://github.com/StamusNetworks/KTS">github.com/StamusNetworks/KTS</a> .  Here we will find already prepared indexes and dashboards. <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/StamusNetworks/KTS.git patch -p1 -d /opt/kibana4/ &lt; /opt/kibana4/KTS/patches/kibana-integer.patch patch -p1 -d /opt/kibana4/ &lt; /opt/kibana4/KTS/patches/timelion-integer.patch ./load.sh</code> </pre><br><h5>  Go, go, go! </h5><br>  To launch the IDS engine, enter: <br><pre> <code class="bash hljs">@srv-ids ~]<span class="hljs-comment"><span class="hljs-comment"># /usr/bin/suricata -c /etc/suricata//suricata.yaml -i eth0</span></span></code> </pre><br>  Pay attention to the name of the interface and its mode of operation.  For passive analysis, it is necessary to transfer the interface to promisc mode, and a SPAN session is also better to acquire: <br><pre> <code class="bash hljs">@srv-ids ~]<span class="hljs-comment"><span class="hljs-comment"># ifconfig eth0 promisc</span></span></code> </pre><br>  After running IDS, the size of the log files should increase significantly. <br>  If there were no critical errors at startup, go to port 5601.  We select logstash- * indexes, go to Dashboards and create a display interface for ourselves.  There may be something like this: <br><img src="https://habrastorage.org/files/2a6/006/dd1/2a6006dd179e48ebb9a94e280d8e0ba2.jpg"><br>  Or to this (the screen is not mine): <br><img src="https://habrastorage.org/files/ea5/be1/059/ea5be1059ab44d8bbbcbc1ec40227eb0.png"><br>  In order to look at the map, you need to uncomment this line in the logstash config: #database =&gt; "/opt/logstash/vendor/geoip/GeoLiteCity.dat" and download the actual or similar file with geolocation by IP. <br>  Yes, do not forget about the Log rotation. <br>  In /etc/logrotate.d/ create a file suricata with the following content: <br><pre> <code class="bash hljs">/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/suricata/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/suricata/*.json { rotate 3 missingok nocompress create sharedscripts postrotate /bin/<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -HUP $(cat /var/run/suricata.pid) endscript }</code> </pre><br>  I will be glad to your comments. <br>  If you try and not get ELK or suricata, write, maybe that will come out =) </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/280460/">https://habr.com/ru/post/280460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280448/index.html">Games of Thrones: why modern games need popular titles</a></li>
<li><a href="../280450/index.html">Four words that can not (the study of Russian obscene vocabulary on the materials of social media)</a></li>
<li><a href="../280452/index.html">Configure and use Apache Ignite as MyBatis L2 cache (L2 cache)</a></li>
<li><a href="../280454/index.html">Step by step: Transmit data to flightradar24</a></li>
<li><a href="../280456/index.html">New at PHDays: Hardware Village Playground</a></li>
<li><a href="../280462/index.html">JBreak Java Conference: The Conquest of Siberia</a></li>
<li><a href="../280464/index.html">Check your site from Mars? Nothing is impossible</a></li>
<li><a href="../280466/index.html">PowerWare new extortionist using PowerShell</a></li>
<li><a href="../280468/index.html">Tale about how GOST-disk encryption in Android implemented</a></li>
<li><a href="../280470/index.html">Frequency dictionary banned sites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>