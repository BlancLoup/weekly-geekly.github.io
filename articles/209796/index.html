<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Music Box on PIC16F753</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was once very impressed with this post about creating a light-music device on a microcontroller as a gift for my beloved. And once it was my time to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Music Box on PIC16F753</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/dfa/a19/abb/dfaa19abb1c147de942456006902e8b2.jpg"><br><br>  I was once very impressed with <a href="http://habrahabr.ru/post/176403/">this post</a> about creating a light-music device on a microcontroller as a gift for my beloved.  And once it was my time to make such a gift.  Considering the differences from the author of the aforementioned project in skills and tools;  Being very limited in preparation time (3-4 days), I went the other way and developed my music device for installation in a casket bought in a souvenir shop.  It has a simpler design and ease of manufacture.  The article describes the details of my project and their motivation.  Carefully, photos (about 1Mb in total). <br><a name="habracut"></a><br><h4>  Scheme </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/e07/ef9/09d/e07ef909d40b0849af497bad8b94b656.png"><br>  As you can see, there are very few details.  Power supply in the range of +3 .. + 4.8V from three AAA batteries is suitable without the use of stabilizers for both the D1 microcontroller (PIC16F753) and the DA1 amplifier (TDA7052A).  This amplifier chip is unique in its kind, because among its counterparts, it requires a minimum number of external elements.  The use of a power amplifier is necessary: ‚Äã‚Äãwhen you try to connect the output of the microcontroller directly to the speaker, you will not be able to get sufficient volume. <br><br>  For the operation of the amplifier, a capacitor C1 with a capacity of 220 ŒºF is required.  Without a capacitor it is impossible: if the internal resistance of the power supply is not sufficiently small, then it will sound quiet and with strong distortions.  A capacitor C4 is also required for decoupling the DC audio signal.  Trimming Resistor R2 adjusts the volume.  R1 limits the range of adjustment.  Together with the capacitor C3, it also forms a low pass filter.  In principle, you can not put C3.  At first I wanted to do this, but then it seemed to me that in order to reduce the distortion of sound, it would be better to remove the ultrasonic frequencies from it, putting C3. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The TDA7052A (unlike the TDA7052) has a separate volume control input by applying the appropriate voltage to it (not shown in the diagram).  But an attempt to use it in no way simplifies the scheme and does not improve its work.  Fortunately, by leaving this input unconnected, the normal operation of the amplifier is not disturbed. <br><br>  A few words about the choice of the microcontroller.  The main criterion is the supply voltage range.  When the battery is almost discharged, the voltage on it sags to 3V (1V per cell).  In the fresh state, the voltage can rise to + 4.8V and even more.  Unfortunately, more modern 16-bit microcontrollers, which have high speed and a lot of memory, usually require power in the range of +2.7 .. + 3.6V.  To lower the voltage, one would have to apply a stabilizer, and not just any, but with a low voltage drop (Low Drop-out), given the voltage on the battery at the end of its service.  I decided not to complicate things.  From Microchip controllers (I have the most experience with them and I have a programmer), therefore, only 8-bit ones are suitable.  It would also be possible to use 16-bit from the PIC24F series.  In the next music box, I probably will.  Still, the PIC16F753 is very cramped in both speed and memory.  But he has a built-in 9-bit DAC, which is very suitable for sound synthesis. <br><br>  For simplicity and reliability, I also decided not to use any power and power management schemes.  A simple switch (not shown) breaks the battery circuit, and that‚Äôs it. <br><h4>  Assembly </h4><br>  We buy the appropriate size and type of casket.  I found this one.  Unfortunately, the rectangular box was not found, it would be easier to work with it. <br><img src="https://habrastorage.org/getpro/habr/post_images/2a5/2c9/fd7/2a52c9fd74ccdcc5b13c25257377e3e8.jpg"><br>  I did not make a circuit board.  There are no conditions for this at home, but it is too long and expensive to order at the factory.  Therefore, I collected the circuit on the breadboard.  It was possible to cut a piece of board according to the size of the box with a jigsaw.  The dimensions and shape predetermined the layout of the parts.  Here is a photo at the intermediate stages of assembly: <br><img src="https://habrastorage.org/getpro/habr/post_images/010/0fe/bdf/0100febdf145dc77f123dd07d99e4911.jpg"><br>  Wires at the time of writing and debugging the firmware connected programmer.  I put the chips on the sockets, and for good reason: of the two amplifier circuits bought on the radio base, one turned out to be a bat.  It was possible to avoid her soldering. <br><img src="https://habrastorage.org/getpro/habr/post_images/1e9/067/25a/1e906725a11c649de283d091d9ee6756.jpg"><br>  View from the back of the board.  As you can see, long or intersecting connections are made with MGTF wire, and short - with cut off legs from capacitors and resistors.  After checking the performance of the circuit on the test firmware, you can begin to develop and debug the main program.  More about her below. <br><br>  After the firmware is fully debugged, turn off the programmer, rewire the speaker and set the switch.  Last check. <br><img src="https://habrastorage.org/getpro/habr/post_images/560/07a/57c/56007a57cbba66010cd0a22c6ad7714e.jpg"><br>  After that, you need to mount everything in the box and close the top with a cardboard box for aesthetics.  From a black cardboard in the form of a box we cut and bend such a construction. <br><img src="https://habrastorage.org/getpro/habr/post_images/9b1/f55/9af/9b1f559af0f1d20e2fb4ecb4af97c0a3.jpg"><br>  Cut a hole for the switch with a knife.  An awl pierced the holes above the speaker.  Next, glue the switch to the cardboard and the speaker on a regular place of the board: <br><img src="https://habrastorage.org/getpro/habr/post_images/a3b/cec/99b/a3bcec99be716dee79d9004929309fdc.jpg"><br>  The final look of the open box: <br><img src="https://habrastorage.org/getpro/habr/post_images/e75/538/ec7/e75538ec71a4c831a358d9bbfa8dfca0.jpg"><br><br><h4>  Program for PIC and music preparation </h4><br><h5>  1. Sound synthesis </h5><br>  Having a 9-bit DAC, in principle, you can get a rather complex audio signal, but in the case of the PIC16F753 the possibilities are limited due to the small size of the program memory of the microcontroller - only 2048 words.  As experience shows, even a simple player program, written in assembly language and optimized for code size, takes about 1000 words, so there is very little for notes.  And absolutely nothing is left to store samples when using such a method of sound synthesis as <a href="http://en.wikipedia.org/wiki/Wavetable_synthesis">Wavetable</a> .  The use of such powerful methods as <a href="http://en.wikipedia.org/wiki/FM_synthesis">FM synthesis</a> is hampered by insufficient processor speed and the absence of a hardware multiplier in it.  Therefore, there remains only the synthesis of rectangles - symmetric, or with variable porosity.  The second option gives some variety of timbres - see, for example, the collection <a href="http://1bit.i-demo.pl/topic/89/this-is-tritone-episode-2/">‚ÄúThis is Tritone 2‚Äù</a> (also available on <a href="http://youtu.be/QjLLcB3LhzU">Youtube</a> ).  This method I implemented in the box.  It was possible to realize a polyphonic sound: 4 independent audio channels.  You can control the volume of each channel. <br><br>  We find the frequency corresponding to the desired note, according to the formula of <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25BE%25D0%25BC%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2582%25D0%25B5%25D0%25BC%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">uniform temperament</a> : f = 440 * 2 ^ (n / 12), where n is the number of the note in semitones, n = 0 corresponds to "A" of the first octave.  Since we have 4 channels, we need to simultaneously generate 4 signals and sum them up before output.  The most common solution is to use a common sampling rate for all channels.  At the same time, the processor calculates an output count for each channel at regular intervals.  The values ‚Äã‚Äãobtained are summarized and fed to the DAC. <br><br>  The desired periods of rectangular signals, in general, are not multiples of the sampling period.  Say, for the ‚Äúla‚Äù note of the second octave, we have n = 12, f = 880 Hz.  With a sampling frequency of Fs = 27777.8 Hz, each signal period should last ~ 31.57 output samples, which is unrealizable.  There are three ways out: <br><ol><li>  Round up the period to a whole number of samples.  In this case, the resulting period will differ from the specified one, i.e.  music will be fake. </li><li>  Vary the period duration within plus or minus one sample so that the average period of the received signal is 1 / f.  From the point of view of signal processing theory, this is equivalent to the nearest neighbor interpolation.  As a result, there are significant non-harmonic distortions in the sound, peaks at extraneous frequencies appear in the spectrum.  At the hearing, the signal simply becomes "dirty." </li><li>  Interpolate according to Shannon.  This approach eliminates falsity and gives the best sound quality, but in 8-bit microcontrollers is unacceptable because of the complexity of the calculations. </li></ol><br>  So in practice, you can choose between options 1) and 2).  Both of them are used in software synthesis of multi-channel music on a 1-bit audio output in computers such as the ZX Spectrum.  I personally prefer option 1).  With a sufficiently high sampling rate, on not too high notes, the frequency rounding off is insignificant, and the false is almost imperceptible. <br><br>  The sampling frequency must be longitudinal to the processor clock frequency and low enough so that the processor has time to carry out all the necessary calculations for each output sample.  On the other hand, it should be as high as possible in order to reduce falsehood and expand the range of reproducible notes.  For the work of the player program, a table with the periods of each note is necessary.  To calculate this table and calculate the deviation of the received signal frequencies from the desired ones, it was written <br><div class="spoiler">  <b class="spoiler_title">program at Matlab</b> <div class="spoiler_text"><pre><code class="matlab hljs">fs = <span class="hljs-number"><span class="hljs-number">2e6</span></span>/<span class="hljs-number"><span class="hljs-number">72</span></span>; notes = <span class="hljs-number"><span class="hljs-number">-24</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>; f = <span class="hljs-built_in"><span class="hljs-built_in">zeros</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(notes)); d = <span class="hljs-built_in"><span class="hljs-built_in">zeros</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(notes)); fa = <span class="hljs-built_in"><span class="hljs-built_in">zeros</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(notes)); ndifs = <span class="hljs-built_in"><span class="hljs-built_in">zeros</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(notes)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>(notes) f(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = <span class="hljs-number"><span class="hljs-number">440</span></span>*<span class="hljs-number"><span class="hljs-number">2</span></span>^(notes(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)/<span class="hljs-number"><span class="hljs-number">12</span></span>); k = <span class="hljs-built_in"><span class="hljs-built_in">round</span></span>(fs/f(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); fa(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = fs/k; na = <span class="hljs-number"><span class="hljs-number">12</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">log2</span></span>(fa(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)/<span class="hljs-number"><span class="hljs-number">440</span></span>); ndifs(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = na-notes(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); d(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) = k; fprintf(<span class="hljs-string"><span class="hljs-string">'%10.1f %10.1f %3d %4.2f\n'</span></span>,f(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>),fa(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>),notes(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>),ndifs(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-built_in"><span class="hljs-built_in">plot</span></span>(ndifs); ylim([<span class="hljs-number"><span class="hljs-number">-0.5</span></span> <span class="hljs-number"><span class="hljs-number">0.5</span></span>]); fprintf(<span class="hljs-string"><span class="hljs-string">'\n\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>(notes) fprintf(<span class="hljs-string"><span class="hljs-string">'\tretlw\tH''%02X''\n'</span></span>,d(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br></div></div><br>  For each note, the program calculates the period of the signal in samples at the selected sampling rate, rounds it to a whole and performs a downward recalculation into the note number.  In these logarithmic units, the deviation is estimated, the graph of which is displayed on the screen: <br><img src="https://habrastorage.org/getpro/habr/post_images/95e/58d/c1a/95e58dc1a94ab532fdafd67036656590.png"><br>  You can experiment by changing the sampling rate, that is, the number of processor cycles per one period.  Empirically, I picked up a coefficient of 72, which gives the minimum achievable note deviations in a given range. <br><h5>  2. Firmware architecture </h5><br>  PIC16F753 has three timers, but only timer 2 can be programmed to generate interrupts with a specified period.  With its help, we get interrupts at the audio sample rate, i.e.  every 72 processor cycles.  The interrupt routine calculates the next value to output to the DAC.  To avoid sound distortion, it is necessary to update the level on the DAC at strictly equal intervals.  Since the calculations may take different times depending on the state of the program, there are two options.  The first is to ‚Äútrim‚Äù all the branches of the calculations so that they are executed in the same number of cycles.  The second is to immediately output the value calculated during the processing of the previous interruption to the DAC, and then calculate the value for the output in the next interruption.  I chose the second path.  At the same time, the interrupt handling procedure is performed every time at different times, but on the other hand, between interrupts there remains on average more processor time for background calculations. <br><br>  By interrupts, the generation of stationary signals ‚Äî rectangles of constant frequency, duty cycle, and amplitude ‚Äî works.  These parameters are stored in the corresponding memory cells.  When running the firmware, interrupts are never prohibited.  This ensures that there are no inhomogeneities and discontinuities in the sound, except for the moments of switching the generation parameters.  It turns out the same mode of operation as if the system had a sound chip, like Atari Pokey or AY-3-8910: these chips also form stationary signals on each channel until the processor changes the values ‚Äã‚Äãof the parameters in the internal registers of these chips. <br><br>  The generation parameters are updated by procedures running in the background (i.e., between interrupts).  Here I activated timer-1 to ensure the frequency of calling the procedure for updating parameters - 50 Hz.  The same or close frequency is used for these purposes in music players on 8-bit computers. <br><br>  The rest of the firmware architecture is determined by the representation of music in memory.  I went on the principle of <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D0%25B5%25D0%25BA%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D1%2583%25D0%25B7%25D1%258B%25D0%25BA%25D0%25B0">tracker music</a> , which basically created music on 8-bit computers.  I will not go into details here, there is a lot of material on this topic on the Internet. <br><br><h5>  3. Preparing music </h5><br>  Chip music needs something to edit, and today one of the easiest ways is to use <a href="http://openmpt.org/">Open Modplug Tracker</a> .  It is necessary to prepare several samples that sound at least approximately similar to the sound of the chip, and create music in the tracker using them, using no more than 4 channels.  In this case, you also can not use the special effects of the tracker, except those that are implemented in our chip player.  As a result, a tracker file is created in <a href="http://en.wikipedia.org/wiki/Impulse_Tracker">.it</a> format.  I also wrote a converter program that converts notes from an it file into a format recognized by my PIC16F753 firmware.  The converter swears if it encounters notes in the it-file outside the range or unsupported commands by the firmware.  Tools from the it-file are completely ignored by the converter.  They are only needed to control the sound of the music during editing. <br><br>  Samples of rectangles of various porosity, which are needed while editing music, I generated with special programs on Matlab.  But this was done a long time ago as part of another project - the <a href="http://zx.pk.ru/showthread.php%3Ft%3D6425">conversion of music from the ZX Spectrum</a> , so now I just took the tools from those old modules and made music for the box on their base. <br><br>  As a result of the converter operation, a text file is created in the PIC assembler format.  Its contents need to be copied to the end of the firmware source and compiled.  The result will be the firmware in the form of a hex-file with the desired music. <br><br>  Unfortunately, I do not have the talent of a composer or an arranger, so I managed only to get a piece of a famous thing by V. Mozart.  At the same time, part of the player‚Äôs capabilities has remained unused.  It would be easy to add sound effects and much more to the player, but again, where can we get someone who can make a beautiful sound on them? <br><br>  If readers are willing and able to create beautiful chip music for caskets and similar musical handicrafts on microcontrollers, I will be glad to cooperate. <br><h4>  Sources </h4><br>  The full source code of the firmware, the music converter software, as well as the it-file with the music I used in this box, can be downloaded from <a href="https://github.com/mborisov1/musicbox2">Github</a> . </div><p>Source: <a href="https://habr.com/ru/post/209796/">https://habr.com/ru/post/209796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209786/index.html">Results of CES 2014: Samsung Smart Home - the smart home of the future</a></li>
<li><a href="../209788/index.html">Several uses of Sublime Text 3 that you could use</a></li>
<li><a href="../209790/index.html">VMmanager: Comparison of local storage performance</a></li>
<li><a href="../209792/index.html">What technology stacks are used more often on the Jelastic platform?</a></li>
<li><a href="../209794/index.html">Whatsapp: "We will always have time to earn money"</a></li>
<li><a href="../209800/index.html">Clash of Clans traffic scandal, Zynga sad results of the year and other news of the week for a mobile developer</a></li>
<li><a href="../209808/index.html">Tablet Lenovo Yoga Tablet 10: tested in humans</a></li>
<li><a href="../209810/index.html">Stock Market Tools: Derivatives</a></li>
<li><a href="../209812/index.html">Why are there so many Pythons?</a></li>
<li><a href="../209814/index.html">New payment method: Bitcoin and Litecoin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>