<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The simplest modeler for zenoss or the dirty path to a brighter future</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Monitoring 
 (from lat. monitor - the one who reminds, warns) - a comprehensive system of regulated periodic observations, assessing and forecasting c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The simplest modeler for zenoss or the dirty path to a brighter future</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/661/33f/797/66133f797141071a5a75445da4667f9d.png" alt="event tracking" align="right">  <i><b>Monitoring</b></i> <i><br></i>  <i>(from lat. <b>monitor</b> - the one who reminds, warns) - a comprehensive system of regulated periodic observations, assessing and forecasting changes in the state of the environment in order to detect negative changes and develop recommendations for their elimination or attenuation.</i> <br><br><h4>  Introduction and common words </h4><br>  On Habr√©, there are surprisingly few articles on zenoss, although this monitoring system is completely ahead of most of its competitors in terms of functionality.  The description of the system itself can always be found on the official <a href="http://www.zenoss.com/">Zenoss</a> website. <br><br>  Why do I think Zenoss is ahead of the competition?  Because it is easy to configure and receive the systems of observation, alerts and response to alerts that you need.  Zenoss intelligently combines flexibility, functionality and complexity.  The latter grows in proportion to your requests: keeping track of your hard disk space is easier, easier, and monitoring hardware and software systems using your own metrics is much more difficult. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The network has many guides on the initial setup of the system.  Having passed on these guides you can easily start monitoring your servers or communication equipment by basic parameters. <br>  I prefer to use zenoss with snmp servers on hardware.  SNMP server is easy to configure (simple in the name refers not only to the protocol itself;), it is reliable, it allows you to mark the basic rights of access to the information provided, and in general - common software.  In addition, snmp, in one form or another, is supported by most of the hardware. <br>  Monitoring systems with their agents make me somewhat nervous: you never know what is being done in this agent and how well. <br>  If there are no standard snmp agents for the parameters you need, you can implement yours based on the agentx mechanism built into net-snmp.  You can find out more about agentx agents in the guide <a href="http://www.net-snmp.org/tutorial/tutorial-5/toolkit/">www.net-snmp.org/tutorial/tutorial-5/toolkit</a> (A colleague suggests: look at <a href="http://code.google.com/p/linux-administrator-tools/source/browse/">code.google.com/p/linux-administrator-tools/source/browse/#svn%</a> better <a href="http://code.google.com/p/linux-administrator-tools/source/browse/">2Fsnmpd-agent% 2Ftrunk</a> : the documentation is lame there, but all the code is working.) With a small amount of effort, you can monitor everything that can be obtained programmatically from the system, and send this information on snmp via a standard snmp server. <br><br>  So, on this introduction can be considered complete.  Summary: I like zenoss and snmp.  We turn to zenoss denser. <br><a name="habracut"></a><br><h4>  Configuring zenoss for yourself </h4><br>  The simplest way to configure zenoss repeats the way to configure any other monitoring systems: <br><ul><li>  add device </li><li>  define controlled key parameters </li><li>  repeat for each device </li></ul><br><br><img src="http://oxpa.acnet.ru/habra-zen/infrastructure.png" alt="Infrastructure and classes" align="left">  If you have 2 switches and 5 servers, this is done easily, once and for all.  If you have dozens of servers and some of them are ‚Äúrotated‚Äù (for example, you have virtual machines that then appear on the network, then they turn off as unnecessary), then adding and removing devices and monitoring parameters turns into penal servitude. <br><br>  Therefore, modern monitoring systems such as zabbix and zenoss have the autodiscovery functionality of devices: set the range of ip addresses to search for, access parameters and voil√†, the found equipment is added to the system.  It remains to attach monitoring templates to it. <br>  Hanging patterns is also a sad affair.  Mark the hosts in groups or classes and hang the templates on them.  Then it will be sufficient to determine the class of the device and the corresponding monitoring rules will be applied to it. <br><br>  What to do if we have a dozen rules that are hung on the hosts "chaotically"?  So that you can not clearly make classes of devices.  You can go further and describe for the system the rules for assigning monitoring patterns.  In Zenoss, the process of determining the monitoring composition is called ‚Äú <i>device modeling</i> ‚Äù: zenoss queries the snmp server, determines the available parameters, and monitors them if there are monitoring rules. <br><br>  The monitoring rules themselves are provided by ZenPacks.  Zenpack is a way to distribute native extensions of standard functionality.  It can contain event classes, monitoring templates, modeler plugins, interface button descriptions, and more. <br><br>  The correct way to expand monitoring functions is to determine the presence of certain components on a host and link graphs and events (events) to them.  The right zenpack is not a hard thing, but a big one.  Not everyone agrees to invent something for a long time.  I will demonstrate a ‚Äúquick &amp; dirty‚Äù way to get my way. <br><br><h5>  Basic concept </h5><br>  Writing your own components and modeler plugins is difficult.  Hanging monitoring patterns everywhere by hand is long.  Let's combine these two approaches: their disadvantages will ultimately give advantages: the modeler will be simple, I will give its code below, and the templates created once will be hung on devices automatically: if the modeler finds the necessary oids in the snmp server's responses, it will hang monitoring pattern. <br><br>  <b>Why it is fast</b> : we need to create 2 templates and 1 modeler and configure the modeler plugin for class 1 devices (Device-&gt; Server).  Fast, easy, easy, portable (using ZenPacks). <br>  <b>Why it is ‚Äúdirty‚Äù</b> : we will monitor the LSI RAID controller.  The first and only.  If there are many such controllers, they will not be covered by the monitoring system, they will have to create separate templates and modelers.  The approach to creating your own components is more flexible: it would allow to describe the ‚Äúlsi disk controller‚Äù component, to detect and monitor all such controllers. <br><br><h5>  Implementation </h5><br><h6>  SNMP part </h6><br>  So, I had several linux servers with LSI RAID controllers.  Some of them worked on the megaraid driver, some - on mptsas.  After some torment, I found snmp agents to get information about the state of the arrays: <i>sas_snmp-3.17-1123.i386.rpm</i> and <i>sas_ir_snmp-3.17-1126.i386.rpm</i> (yes, 32-bit, others were not).  After installing them, the snmp server is able to give oid from trees <br>  <i>.1.3.6.1.4.1.3582.4</i> and <i>.1.3.6.1.4.1.3582.5</i> respectively. <br>  Among these trees you can find: <br>  <a href="">1.3.6.1.4.1.3582.4.1.4.1.2.1.19.0</a> - the number of degraded logical volumes for the megaraid adapter <br>  <a href="">.1.3.6.1.4.1.3582.5.1.4.1.1.3.1.20.0</a> - the number of degraded logical volumes for the mpt adapter. <br><br>  These are good "integral" metrics that will allow the system administrator to draw attention to the server in case of problems: the disk has crashed - the logical volumes in which it is included will become degraded and will raise the metric from scratch. <br><br>  I will not describe the installation of packages, it is trivial if you know the name of the packages and how sas_snmp differs from sas_ir_snmp. <br><br><h6>  Zenoss part </h6><br>  In Zenoss, we have to create two templates - for megaraid and mpt drivers, and configure two tresholds for them. <br><br>  Go to Advanced -&gt; Monitoring Templates and click the bottom "+" button.  In the window that appears, enter the name - "lsiArray", and select the path - "Server in Devices". <br><br>  After that, a window will appear, divided into three parts: data sources, tresholds and graph definitions.  We will need the first two: <br><ul><li>  Create a data source.  The name "vdDegradedCount", as in mib (but you can, and more).  Source - SNMP </li><li>  Edit the newly created data source: enter our first OID.  In the same window, we can test on any server </li><li>  Create a treshold, give it the name "LSI Degraded virtual drive count", and the type MinMaxTreshold </li><li>  We edit the created treshold: select a single data point, set the minimum and maximum value to 0, denote the event class (I chose / HW / Store).  Event class is required when setting up an alert. </li></ul><br>  After all these actions, we have a template that monitors the megaraid controller and generates an event in case of problems with it. <br>  I will leave the configuration of the second template as an exercise for the reader: there is nothing complicated about it. <br>  We can configure sending a message for this event.  Go to Advanced -&gt; Settings -&gt; Users -&gt; $ Your-user -&gt; Alerting rules and add a new rule there.  We rule and get something in the spirit: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9a2/7c5/b61/9a27c5b61233f4b8738e21a76a813442.png" alt="Alert Configuration"></a> <br><br>  Pay attention to the ‚Äúimportance‚Äù of the event and the beginning of the class chain for the event for which the alert is generated. <br><br>  At this stage, you can hang the resulting pattern on a certain class of devices and calm down.  But this is not our method.  Further, the most interesting: its simplest modeler and zenpak. <br><br><h5>  Creating a modeler plugin. </h5><br>  That's the most interesting.  Create your Zenpack!  Zenpack will create the directory structure we need, in which we place the source code of the plug-in for the modeler.  In addition, we can unload our plugin from the system as part of this Zenpack. <br>  So, go to Advanced -&gt; Settings -&gt; Zenpacks and then click on the gear.  In the menu that appears, select "Create Zenpack".  A window will appear with the name entered.  I chose ZenPacks.HW.Store.LSIArray.  Although, as it turned out later, this is not quite the right name: it was necessary to enter there at least the word community before HW. <br><br>  After creating zenpaka on the screw, a standard tree of files will appear.  We will need to create the file <i>/opt/zenoss/ZenPacks/ZenPacks.HW.Store.LSIArray-*egg/ZenPacks/HW/Store/LSIArray/modeler/plugins/LSIArray.py</i> (tweak the asterisk under the created class) with the following content: <br><pre><code class="python hljs">__doc__=<span class="hljs-string"><span class="hljs-string">"""LSIArray LSIArray modeller maps sas and sasir (mptsas) specific templates $Id: LSIArray.py,v 2.00 2012/04/15 16:01 Exp $"""</span></span> __version__ = <span class="hljs-string"><span class="hljs-string">'$Revision: 2.15 $'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Products.DataCollector.plugins.CollectorPlugin <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SnmpPlugin, GetTableMap, GetMap <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Products.DataCollector.plugins.DataMaps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ObjectMap <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LSIArray</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(SnmpPlugin)</span></span></span><span class="hljs-class">:</span></span> deviceProperties = SnmpPlugin.deviceProperties + (<span class="hljs-string"><span class="hljs-string">'zDeviceTemplates'</span></span>,) mibDesc = { <span class="hljs-string"><span class="hljs-string">'.1.3.6.1.4.1.3582.4.1.4.1.2.1.19.0'</span></span>: <span class="hljs-string"><span class="hljs-string">'lsiArray'</span></span>, <span class="hljs-string"><span class="hljs-string">'.1.3.6.1.4.1.3582.5.1.4.1.1.3.1.20.0'</span></span>: <span class="hljs-string"><span class="hljs-string">'lsiirArray'</span></span>, } snmpGetMap = GetMap( mibDesc ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, device, results, log)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""collect snmp information from this device"""</span></span> log.debug(str(self.deviceProperties)) log.info(<span class="hljs-string"><span class="hljs-string">'processing %s for device %s'</span></span>, self.name(), device.id) getdata, tabledata = results log.debug(str(device.zDeviceTemplates)) newTemplates = [] rmTemplates = [] log.debug(<span class="hljs-string"><span class="hljs-string">'getdata %s mibDesc %s'</span></span>, str(getdata),str(LSIArray.mibDesc)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(getdata.keys()) == getdata.values().count(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>): log.info(<span class="hljs-string"><span class="hljs-string">'no data'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> LSIArray.mibDesc.values(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> getdata.has_key(each) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> getdata[each] != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: newTemplates.append(each) log.debug(<span class="hljs-string"><span class="hljs-string">'newTemplates append: %s'</span></span> % each) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: rmTemplates.append(each) log.debug(<span class="hljs-string"><span class="hljs-string">'rmTemplates append: %s'</span></span> % each) log.info(<span class="hljs-string"><span class="hljs-string">'Current zDeviceTemplaces: %s'</span></span> % str(device.zDeviceTemplates)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> device.zDeviceTemplates: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> newTemplates <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> each <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rmTemplates: newTemplates.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>,each) log.debug(<span class="hljs-string"><span class="hljs-string">'adding to newTemplaces: %s'</span></span> % str(each)) device.zDeviceTemplates=sorted(newTemplates) log.info(<span class="hljs-string"><span class="hljs-string">'New zDeviceTemplates: %s'</span></span> % str(device.zDeviceTemplates)) om = self.objectMap({<span class="hljs-string"><span class="hljs-string">'bindTemplates'</span></span>: newTemplates}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> om</code> </pre> <br><br>  In the source code, everything is quite simple. <br>  At the beginning of a comment describing what the class does. <br>  Then import some zenoss'nyh classes to describe the device model. <br>  The ‚ÄúmibDesc‚Äù object is the most interesting.  It contains a list of oids and corresponding monitoring templates.  If the required oid was found when polling the device, a new monitoring pattern will be hung on the device. <br>  When you edit the example for yourself, try not to miss all the punctuation marks in the text. <br>  Next is a method that performs all checks and comparisons, as well as saves all previous monitoring patterns and adds its own to the list.  The result of this method is the object model (om). <br><br><h6>  Plugin check </h6><br>  After you have copied, corrected and saved the text of the modeler, you need to restart zenoss (zopectl process in Advanced -&gt; Settings -&gt; Daemons) and check that a new one appeared in the list of plugins of the modeler with the name LSIArray (in plug-ins of any device class or in any device).  The plugin must be transferred to the active and run the device modeling. <br>  In the window that appears on the screen, you need to check that the modeler is in the list used for the device.  In addition, an LSIArray.py file will be created on the hard disk, which indicates successful compilation of the script. <br>  If the script is not compiled - check the correctness of the python code. <br>  If the script does not appear in the list of active or available modelers, restart zenoss. <br><br>  After the simulation process, a new monitoring pattern should be added to the device.  Now you can go and pull out the hard drive from the test server, which will transfer the state of the array from ‚Äúnormal‚Äù to ‚Äúdegraded‚Äù.  (If you don't have RAID0, of course).  The number of degraded logical volumes will increase, treshold will be exceeded and the system will generate an event for us.  If you configured alerts, it will come. <br><br><h5>  Conclusion </h5><br>  The method described above allows to achieve several important results: <br><ul><li>  Start using automatic monitoring configuration in zenoss </li><li>  Start figuring out writing your plugins for a modeler </li><li>  Popularizes the use of zenoss as a more flexible and modern monitoring system </li></ul><br><br>  I know perfectly well that there are more complete and ‚Äúcorrect‚Äù guides on writing my zenpacks and modelers.  However, I hope that this text will give impetus to many system administrators to start learning and using zenoss in their systems. </div><p>Source: <a href="https://habr.com/ru/post/142974/">https://habr.com/ru/post/142974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142965/index.html">As a sysadmin sysadmin - tips for beginners</a></li>
<li><a href="../142966/index.html">QML and QtQuick Webinars: User Interaction</a></li>
<li><a href="../142968/index.html">Half-support Cyrillic domains in 12 Firefox</a></li>
<li><a href="../142969/index.html">Intel inside: x86 smartphones in all pockets of the country?</a></li>
<li><a href="../142973/index.html">Prototype Yandex.Disk client for Linux and opening API</a></li>
<li><a href="../142975/index.html">Profiling PHP scripts on a live server</a></li>
<li><a href="../142976/index.html">Translation of tutorials on libGDX - part 1 (setting up a project in Eclipse)</a></li>
<li><a href="../142978/index.html">Kickstarter is a way to avoid financial risks and not give a share in your project.</a></li>
<li><a href="../142980/index.html">Layered Event Processing Model</a></li>
<li><a href="../142982/index.html">Acceler8 2011 - Accelerate 2012 - and so on</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>