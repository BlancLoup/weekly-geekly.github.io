<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nagios-traffic light from the Chinese blocks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As usual, for a start, a small ‚Äúwritten statement of responsibility‚Äù. 



- The goal of all the ridiculous gestures described in the article is one - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nagios-traffic light from the Chinese blocks</h1><div class="post__text post__text-html js-mediator-article">  As usual, for a start, a small ‚Äúwritten statement of responsibility‚Äù. <br><br><ul><li>  The goal of all the ridiculous gestures described in the article is one - to facilitate the monitoring of servers and applications. </li><li>  This bold trick can be repeated at home and at work, even unprepared athletes. </li><li>  I hope that this text will be useful not only to the adherents of Nagios, but also to the radiant Jedi of Zabbix and to the neophytes of other monitoring denominations. </li><li>  There will not be demonstrated the techniques of aerobatics in the use of a soldering station, oscilloscope and Ruby / Fortran / etc masterly possession.  Everything described is primitive, disgusting, but cheap and cheerful.  And most importantly - it works. </li></ul><a name="habracut"></a><br>  Probably, many of those whom spinner sansara brought to the area of ‚Äã‚Äãsystem administration and maintenance of servers in commercial quantities, thought about easing their difficult burden and fantasized more than once how to make it so that it was like in the song: ‚Äúrobots are injected, happy man‚Äù .  I will share my recipe for gaining samadhi. <br><br>  The main ways to monitor the monitoring system are few.  The most common is reading electrical emails and peeping at the web interface.  This functionality is usually available in any monitoring system.  We will not speak about sending SMS and other esoteric.  But there is one thing.  Emails and web interfaces are not always convenient.  And they do not always have the time and energy.  In a situation where there is no dedicated specialist (or even an entire department) of monitoring, you need a means of signaling: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Not distracting from other tasks. </li><li>  Attracting attention in case of problems. </li><li>  Cheap and angry. </li></ol><br>  The initial conditions of the problem are as follows: <br><br><ol><li>  Used by Nagios. </li><li>  All servers are located in DC, far from the support department office.  Ordinary situation. </li><li>  Corporate policies prohibit the use of USB network devices (and drives, by the way).  This means that it will not be possible to use ready-made WiFi and BT controllers of various LED garlands and other pleasures of the smart home and the Internet of things.  It remains the good old serial port.  Or USB-COM adapter.  This wonderful device is not prohibited by domain policies. </li></ol><br>  Thus the following configuration appears.  On the Nagios server, the script checks the status and sends a command over the network to turn on the light bulb located in the tracking department. <br><br>  The conditions of the problem are set, we proceed to the solution. <br><br>  To begin with, we will define a method for obtaining monitoring status.  In Nagios, this is done through the livestatus component.  Setup and installation are described <a href="http://mathias-kettner.de/checkmk_livestatus.html">here</a> .  After installation, you can get the monitoring status in real time with the simplest script.  This query is quite informative: <br><br><pre><code class="bash hljs">GET services Stats: state = 2 Stats: state = 1 Stats: state = 3 Separators: 10 32 44 124</code> </pre> <br>  At the output we get three numbers in one line, separated by a space.  This is the number of services in the state of CRITICAL, WARNING and UNKNOWN, respectively.  At this point, the issue of monitoring monitoring status will be set aside for the time being, we will return to this later.  I get the status from your favorite monitoring system at your discretion. <br><br>  We turn to the most delicious part of our adventure, to the glands and wires. <br><br>  Now it is necessary to select the transmission channel and the way of monitoring status indication.  After some deliberation and searching, the choice fell on a set of infrared light bulbs, an infrared decoder and a USB-COM adapter.  This kit connects to the workstation on which the Nagios client (nsclient ++) is deployed. <br><br>  So, all the ingredients are listed, it remains to shake but do not mix. <br><br>  Let's start with the light bulb. <br><br><img src="https://habrastorage.org/webt/v_/7v/cx/v_7vcxh5cfpbkq948jngyyoqk7e.jpeg" alt="Bulb with remote control"><br><br>  A light bulb (like all the other components) was bought on Ali.  Search for the keywords ‚ÄúIR RGB LED bulb‚Äù.  Very powerful is not needed, enough 3-5 watts.  This is important because the lamp is in direct view all day, and too bright will interfere and blind. <br><br>  And it is also important that it is controlled by the NEC protocol.  Since the ready decoder supports only this protocol.  At the same time do not forget to buy any table or floor lamp for the lamp, if you do not have it.  Light bulb is enough to simply screw into the cover and turn on the 220V network. <br><br>  The next component is an infrared decoder module (complete with a USB-COM adapter). <br><br><img src="https://habrastorage.org/webt/il/bu/mn/ilbumnndhq6sea6endfjqc8r4rk.jpeg" alt="Decoder"><br><br>  In Chinese bins, you can find the words ‚Äúir decoder‚Äù.  For this beautiful module, there is even a diagram and a set of documentation, available <a href="">here</a> . <br><br>  Any Prolific / Silicon Labs / FTDI / CH340 / etc will work as a USB-COM adapter.  It is searched on Ali by the spell ‚Äúserial converter usb ttl‚Äù.  Just in case, let me remind you that at least two of the listed brands (FTDI and Prolific) are seen in an unequal struggle with the users of their products.  This is reflected in the inoperability of fresh drivers with pirated adapters from China.  It is necessary to roll back to previous versions of drivers.  I will not dwell on this in more detail, there is a lot of information in the network. <br><br>  Further narration implies that you have completed a tantric privacy session with a USB-COM adapter and an additional COM port has appeared in your system.  Now we connect a decoder to the adapter (after disconnecting the adapter from the USB port!) To do this, it is enough to connect 8 pins with 4 wires (in no case the opposite!).  Like that: <br><table><tbody><tr><th>  decoder </th><th>  usb com </th></tr><tr><td>  5v </td><td>  5v </td></tr><tr><td>  tx </td><td>  rx </td></tr><tr><td>  rx </td><td>  tx </td></tr><tr><td>  gnd </td><td>  gnd </td></tr></tbody></table><br>  The time has come, with bated breath, connect our design to the USB port.  If white smoke has not left the product, you can check the performance of the entire chain.  It is necessary to make sure that the IR signal is received and sent, and also to record all codes from the control panel of the light bulb.  For this perfect program <a href="https://sourceforge.net/projects/realterm/">RealTerm</a> .  I will not give screenshots, everything is simple and transparent.  I do not want to deprive readers of the pleasure of slightly increasing the blood supply to their neocortex.  It's nice. <br><br>  Now, when you have intercepted codes of the ‚Äú <s>Enigma</s> ‚Äù of the console in your hands, it remains to check the lamp triggering from the decoder.  In the same program RealTerm send the received codes and watch the lamp trigger.  There is a small nuance in sending codes.  If you are too lazy to read the documentation on the adapter, I will give a hint.  By default, after power on, the decoder works with the adapter at 9600. This is more than enough to send several bytes.  But it is possible to increase the exchange rate with the adapter via RS232.  In addition, before sending the code to the decoder, you must first send the prefix A1 F1.  For example, when capturing the red button code, RealTerm issued 00 FF 09. In order for this code to get to the lamp through a decoder, you need to send the sequence A1 F1 00 FF 09. All codes are, of course, hexadecimal. <br><br>  I hope you get to this stage without sacrifice or destruction.  It remains to pack everything into the case and configure Nagios and the agent.  As the body used the old <a href="">mouse</a> .  Everything fits perfectly, looks stylish, fashionable, youth.  The main thing is not to forget to drill a <a href="">hole</a> for the LED according to GOST. <br><br>  Now a few words about the signaling algorithm.  Since the light bulb is one, and simultaneously different services may be in different states, it means there may not be enough light bulbs for everyone.  Therefore, it is necessary to display the worst state at the current time.  It's time to return to the results of the status query via livestatus.  Having received a string of numbers, we look at the very first number.  If it is not equal to 0, turn on the red color and complete the processing of the query results.  All other statuses are no longer interesting to us, since  There are no channels to display them.  If the first number is 0, look at the next number, etc.  If all received values ‚Äã‚Äãare equal to 0, then all services are in OK status and you can safely turn on the green color. <br><br><img src="https://habrastorage.org/webt/ln/jx/ko/lnjxkof8bpkg_zjyoiiioqgxaj8.jpeg" alt="image"><br><br>  The number of services in the OK status is not requested and is not analyzed.  In addition to displaying the status of services, the algorithm implements a kind of ‚Äúheartbeat‚Äù.  This is necessary to understand that the whole chain is working and working properly.  Before any switching of the lamp, the violet color is turned on for one second, and then the corresponding one (red, yellow, orange or green).  After turning on the desired color, a dimming code is sent three times to reduce the lamp brightness to a minimum.  This lamp has only 4 gradations of brightness, and the lamp after switching always turns on the maximum. <br><br>  That's the whole simple algorithm of the light bulb.  Plus, the lamp turns off at night and turns on in the morning. <br><br>  For those who liked the recipe, laid out the scripts and pieces of configs on the <a href="https://github.com/Duremar007/Nagios-Bulb">githab</a> . <br><br>  Everything is very simple there.  If you do everything carefully and carefully, then you definitely ride on the quadrigue.  Good luck. </div><p>Source: <a href="https://habr.com/ru/post/353280/">https://habr.com/ru/post/353280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353268/index.html">JPoint 2018: Debriefing</a></li>
<li><a href="../353270/index.html">Five Myths about Data Science</a></li>
<li><a href="../353272/index.html">7 principles for designing container-based applications</a></li>
<li><a href="../353274/index.html">Tips and Tricks for an IT Administrator: Deploying a Different OS with Windows Deployment Services</a></li>
<li><a href="../353276/index.html">UI tests in iOS project. Is there a profit and why are they being introduced at all?</a></li>
<li><a href="../353282/index.html">Hackers attacked Poloniex users with a fake mobile application</a></li>
<li><a href="../353284/index.html">The smallest computer in the world, an energy efficient chip and other innovations for IoT</a></li>
<li><a href="../353286/index.html">Welcome to the first international web conference Kolesa / Web 2018</a></li>
<li><a href="../353290/index.html">Firefox Gecko, "which we lost"</a></li>
<li><a href="../353292/index.html">Why does "=" mean assignment?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>