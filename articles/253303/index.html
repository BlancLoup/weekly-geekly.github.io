<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>More information about the protocol Mail.Ru Agent</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© already wrote about how Mail.Ru Agent is arranged. At the moment there is no official documentation for the protocol in the public domain, so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>More information about the protocol Mail.Ru Agent</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© already <a href="http://habrahabr.ru/post/136041/">wrote</a> about how Mail.Ru Agent is arranged.  At the moment there is no official documentation for the protocol in the public domain, so you have to investigate the device empirically.  In this article, I will look at sending formatted text messages and creating and sending messages to the conference. <br><a name="habracut"></a><br><h2>  A few words about the protocol </h2><br>  Messages are transmitted in packets of a specific format.  The first 44 bytes are the header, which looks like this: <br><br><pre><code class="python hljs">struct.pack( <span class="hljs-string"><span class="hljs-string">'&lt;7L16s'</span></span>, magic, <span class="hljs-comment"><span class="hljs-comment"># DEAD BEEF,  ,  ,    MMP  proto, #   seq, #    msg, #  : /   /... dlen, #   from_, #  ,      fromport, #  ,       reserved #  16  )</span></span></code> </pre> <br>  The numbers here are transmitted in UL format, which looks like 4 bytes, written from right to left.  Thus, the number 10 will look like 00 00 00 0A.  So we will pack in UL: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MRIMType</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self.value = value <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UL</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MRIMType)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(self.value, int): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.pack(<span class="hljs-string"><span class="hljs-string">"&lt;L"</span></span>, self.value) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.pack(<span class="hljs-string"><span class="hljs-string">"&lt;L"</span></span>, len(self.value))</code> </pre><br>  Text is transmitted in LPS format ‚Äî strings with a given length (the length is specified as UL).  We will pack it in this way: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LPSZ</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MRIMType)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(self.value, (list, tuple)): <span class="hljs-comment"><span class="hljs-comment">#      data = "" data += UL(self.value).pack() for element in self.value: data += element.pack() return data elif isinstance(self.value, MRIMType): #     data = self.value.pack() return struct.pack("&lt;L", len(data)) + data else: data = self.value return struct.pack("&lt;L", len(data)) + data</span></span></code> </pre><br>  We also need to pack the lines in LPS in other encodings: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LPSX</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(MRIMType)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value, encoding)</span></span></span><span class="hljs-function">:</span></span> super(LPSX, self).__init__(value) self.encoding = encoding <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> encoded_data = self.value.encode(self.encoding) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.pack(<span class="hljs-string"><span class="hljs-string">"&lt;L"</span></span>, len(encoded_data)) + encoded_data <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LPSW</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(LPSX)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> super(LPSW, self).__init__(value, encoding=<span class="hljs-string"><span class="hljs-string">"UTF-16LE"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LPSA</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(LPSX)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> super(LPSA, self).__init__(value, encoding=<span class="hljs-string"><span class="hljs-string">"cp1251"</span></span>)</code> </pre><br><h2>  Formatted text messages </h2><br>  Let's see what the messages look like.  The msg field in the header must be filled with the constant 0x1008, otherwise the message packet is as follows: <br><br><pre> <code class="python hljs"> HEADER UL(<span class="hljs-number"><span class="hljs-number">0x80</span></span>), LPSA(recipient), <span class="hljs-comment"><span class="hljs-comment"># email   LPSW(body), # ,   LPSZ(rtf_part)</span></span></code> </pre><br>  The last component of the package is the part of the message related to the formatting of the text.  If we do not need formatting, rtf_part must consist of a space.  In this case, the Mail.Ru Agent that receives this message will use the default fonts installed in the recipient agent. <br><br>  If we want to send a formatted message, then the last part of the packet should be LPSZ (rtf_part), where: <br><br><pre> <code class="python hljs">rtf_part = pack_rtf(rtf) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack_rtf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rtf)</span></span></span><span class="hljs-function">:</span></span> msg = UL(<span class="hljs-number"><span class="hljs-number">2</span></span>).pack() + LPSZ(rtf).pack() + LPSZ(<span class="hljs-string"><span class="hljs-string">"\xFF\xFF\xFF\x00"</span></span>).pack() message = base64.b64encode(msg.encode(<span class="hljs-string"><span class="hljs-string">'zlib'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre><br>  The last item is the background color; when a message is received, the chat window will change its color entirely. <br>  rtf for writing ‚Äúqwerty‚Äù looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">r"{{\rtf1\ansi\ansicpg1252\deff0\deflang1033"</span></span> \ <span class="hljs-comment"><span class="hljs-comment">#  r"{{\fonttbl{{\f0\fnil\fcharset204 Tahoma;}}{{\f1\fnil\fcharset0 Tahoma;}}}}\ # ,   .    r"{{\colortbl ;\red0\green0\blue0;}} " \ #   r"\viewkind4\uc1\pard\cf1\f0\fs32 q\f1 werty\f0\par }}" # , </span></span></code> </pre><br>  You can see that the first letter is written in one font, and the rest in another.  I cannot explain this behavior, but the rtf generated by the Mail.Ru Agent that I managed to get looked like this.  rtfs that do not have this property remain valid.  The remaining parameters (language, font table, Russian) affect the validity of rtf. <br><br>  It remains to be noted that if the rtf-part of the message is not empty, it will come in the message.  If the text part of the message is indicated (body), then we will see this text in the Mail.Ru Agent pop-up window. <br><br><h2>  Conferences </h2><br>  If in order to start a chat with another contact, you just need to send a message, then in order to start chatting in a conference, you need to do a few squats. <br><br><h3>  Creating a conference </h3><br>  Each conference has its own unique name, which looks like 5895986@chat.agent, which we receive from the server in response to this message: <br><br><pre> <code class="hljs objectivec">HEADER <span class="hljs-meta"><span class="hljs-meta">#    0x1019 UL(0x80), LPSW(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">), LPSW(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">), LPSW(chat_name), # ,       LPSW(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">), LPSW(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">), LPSW(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">), LPSZ(LPSZ(LPSZ(packed_recipients))) #    </span></span></code> </pre><br>  In response to this message, a message is received from the server with the same number in the header and the IT manager.  After receiving a response from the server, you can send messages to the conference. <br><br><h3>  Sending messages to the conference </h3><br>  To send a message to the conference, you need to send two packets.  The first package has no meaning, it is preparatory: <br><br><pre> <code class="python hljs">HEADER <span class="hljs-comment"><span class="hljs-comment">#   --  (0x1008) UL(0x200400), LPSA(chat_alias), # ,      LPSZ(" "), LPSZ("")</span></span></code> </pre><br>  And now, directly, the message: <br><br><pre> <code class="python hljs">HEADER UL(<span class="hljs-number"><span class="hljs-number">0x80</span></span>), LPSA(chat_alias), LPSW(body), LPSZ(rtf_part)</code> </pre><br>  It looks like a regular message with a conference receiver. <br><br><h3>  Exit from the conference </h3><br>  I needed these studies to implement autotests.  I quickly encountered a problem - the account may be in the final number of conferences.  Therefore, at the end of the test you need to leave the conference. <br><br><pre> <code class="python hljs">HEADER <span class="hljs-comment"><span class="hljs-comment">#  ,    0x101B UL(absolute_chat_number), #  ,    . UL(0x0081), UL(0xF4244), LPSZ(chat_alias), #   LPSW(chat_name), #   LPSZ(""),</span></span></code> </pre><br>  It was not possible to figure out how to get the absolute conference number, but it was experimentally found that the chat is not identified by it.  Therefore, you can specify any reasonable number, for example, 42. <br><br>  My research is far from being complete, so I will be glad to any corrections and additions. </div><p>Source: <a href="https://habr.com/ru/post/253303/">https://habr.com/ru/post/253303/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253287/index.html">Update Opera Mini servers: Flexbox, ES5, HTML5 parser</a></li>
<li><a href="../253291/index.html">Some pitfalls of IP Cloud technology in Mikrotik routers</a></li>
<li><a href="../253293/index.html">How to make friends Google Drive and Google Calendar? We taste Gas</a></li>
<li><a href="../253297/index.html">Do not learn frameworks, learn architecture</a></li>
<li><a href="../253299/index.html">IBM SmartCloud Storage Access Video Demonstration</a></li>
<li><a href="../253305/index.html">Online translation of the opening of the Microsoft Developer Tour technology expedition</a></li>
<li><a href="../253307/index.html">First look at VMware 6</a></li>
<li><a href="../253309/index.html">JavaScript and Reverse Engineering Contact Points</a></li>
<li><a href="../253311/index.html">‚ÄúHackers and artists‚Äù, ‚ÄúOn Lisp‚Äù and essay in Russian. Learning to write like Paul Graham</a></li>
<li><a href="../253313/index.html">Optimum continuous archive sorting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>