<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From loaded MPP, the DBMS is a vigorous Data Lake with analytical tools: sharing the creation details</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All organizations that have at least some relation to the data, sooner or later face the issue of storing relational and unstructured databases. It is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From loaded MPP, the DBMS is a vigorous Data Lake with analytical tools: sharing the creation details</h1><div class="post__text post__text-html js-mediator-article">  All organizations that have at least some relation to the data, sooner or later face the issue of storing relational and unstructured databases.  It is not easy to find at the same time a convenient, effective and inexpensive approach to this problem.  And also to make sure that data scientists with machine learning models can successfully work on data.  We did it - and even though we had to tinker, the final profit turned out to be even more than expected.  We will tell about all the details below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/755/bd0/32c/755bd032c95a1b46c4f412d65c5a7bf4.png"><br><a name="habracut"></a><br>  Over time, an incredible amount of corporate data accumulates in any bank.  A comparable amount is stored only in Internet companies and telecom.  It happened because of the high requirements of regulatory authorities.  These data do not lie idle - the heads of financial institutions have long figured out how to extract profit from this. <br><br>  It all started with management and financial reporting.  Based on this data, they learned how to make business decisions.  It was often necessary to obtain data from several bank information systems, for which we created consolidated databases and reporting systems.  From this gradually formed what is now called the data warehouse.  Soon, on the basis of this repository, our other systems also started working: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  analytical CRM, which allows to offer the client more convenient products for him; <br></li><li>  credit lines that help to quickly and accurately make a decision on granting a loan; <br></li><li>  loyalty systems that calculate cashback or bonus points according to mechanics of varying complexity. <br></li></ul><br>  All these tasks are solved by analytical applications that use machine learning models.  The more information models can take from storage, the more accurate they will work.  Their need for data is growing exponentially. <br><br>  Approximately we came to this situation two or three years ago.  At that time we had a repository based on MPP Teradata DBMS using ELT-tool SAS Data Integration Studio.  We have been building this storage facility since 2011 together with Glowbyte Consulting.  More than 15 major banking systems have been integrated into it and, at the same time, have accumulated a sufficient amount of data for the implementation and development of analytical applications.  By the way, just at this time, the volume of data in the main layers of the store began to grow nonlinearly due to a multitude of different tasks, and the advanced client analytics became one of the main directions of the bank‚Äôs development.  Yes, and our data scientists were eager to support it.  In general, to build the Data Research Platform, the stars are formed as it should. <br><br><h2>  Planning a solution </h2><br>  Here it is necessary to clarify: industrial software and servers are expensive even for a large bank.  Not every organization can afford to store a large amount of data in the top MPP database.  You always have to make a choice between price and speed, reliability and volume. <br><br>  To make the most of the available opportunities, we decided to do this: <br><br><ul><li>  ELT-load and the most demanded part of the historical data of HD leave on the Teradata DBMS; <br></li><li>  The full history of shipping to Hadoop, which allows you to store information much cheaper. <br></li></ul><br>  At about that time, the Hadoop ecosystem became not only fashionable, but also sufficiently reliable, convenient for enterprise-use.  It was necessary to choose a distribution kit.  You could build your own or use open Apache Hadoop.  But among enterprise-solutions based on Hadoop, ready distributions from other vendors, Cloudera and Hortonworks, have recommended themselves more.  Therefore, we also decided to use a ready-made distribution. <br><br>  Since our main task was to store structured big data, we were interested in the Hadoop stack solutions that were as close as possible to the classic SQL DBMS.  The leaders here are Impala and Hive.  Cloudera develops and integrates Impala, Hortonworks - Hive solutions. <br><br>  For an in-depth study, we organized load testing for both DBMSs, taking into account the load profile for us.  I must say that the data processing engines in Impala and Hive are significantly different - Hive generally represents several different options.  However, the choice fell on Impala - and, accordingly, the distribution kit from Cloudera. <br><br><h2>  What did Impala like? </h2><br><ul><li>  <i>High speed of analytic queries</i> due to an alternative approach to MapReduce.  Intermediate results of calculations are not discarded in HDFS, which significantly speeds up data processing. <br></li><li>  <i>Efficient work with collated data storage in <a href="https://parquet.apache.org/">Parquet</a> .</i>  For analytical tasks, so-called wide tables with many columns are often used.  All columns are rarely used - the ability to raise from HDFS only the ones needed for operation saves RAM and significantly speeds up the request. <br></li><li>  <i>Elegant solution with <a href="https://www.cloudera.com/documentation/enterprise/latest/topics/impala_runtime_filtering.html">runtime filters</a> including bloom filtering.</i>  Both Hive and Impala are significantly limited in the use of indexes common to classic DBMSs due to the nature of the HDFS file system.  Therefore, to optimize the execution of a SQL query, the DBMS engine should effectively use the available partitioning even when it is not explicitly specified in the query conditions.  In addition, he needs to try to predict what the minimum amount of data from HDFS needs to be raised to ensure that all rows are processed.  In Impala, it works very well. <br></li><li>  <i>Impala <a href="https://blog.cloudera.com/blog/2013/02/inside-cloudera-impala-runtime-code-generation/">uses the LLVM</a></i> compiler on a virtual machine with RISC-like instructions to generate the optimal execution code for the SQL query. <br></li><li>  <i>ODBC and JDBC interfaces are supported.</i>  This allows almost out of the box to integrate Impala data with analytical tools and applications. <br></li><li>  <i>It is possible to use Kudu</i> to bypass some of the limitations of HDFS, and, in particular, to write UPDATE and DELETE constructs in SQL queries. <br></li></ul><br><h2>  Sqoop and the rest of the architecture </h2><br>  The next most important tool in the Hadoop stack is Sqoop for us.  It allows you to transfer data between relational databases (we were, of course, interested in Teradata) and HDFS in the Hadoop cluster in various formats, including Parquet.  In tests, Sqoop showed high flexibility and performance, so we decided to use it - instead of developing our own data capture tools via ODBC / JDBC and saving to HDFS. <br><br>  To train the Data Science models and related tasks that are more convenient to perform directly on the Hadoop cluster, we used Apache <a href="https://spark.apache.org/">Spark</a> .  In its field, it has become a standard solution - and for good reason: <br><br><ul><li>  Spark ML machine learning libraries; <br></li><li>  support for four programming languages ‚Äã‚Äã(Scala, Java, Python, R); <br></li><li>  integration with analytical tools; <br></li><li>  in-memory data processing gives excellent performance. <br></li></ul><br>  As a hardware platform, we purchased an Oracle Big Data Appliance server.  We started with six nodes in the production loop with a 2x24-core CPU and 256 GB of memory on each.  The current configuration contains 18 of the same nodes with expanded memory up to 512 GB. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/58f/173/025/58f173025e987a85582e383fd5f4b3d9.png"><br><br>  The diagram shows the high-level architecture of the Data Research Platform and related systems.  The central link is the Hadoop cluster based on the Cloudera distribution (CDH).  It is used for both to get Sqoop and to store QCD data in HDFS - in parquet format that allows the use of compression codecs, for example, Snappy.  The cluster also processes data: Impala is used for ELT-like transformations, Spark is used for Data Science tasks.  Sentry is used to separate data access. <br><br>  Impala has interfaces for almost all modern enterprise analytics.  In addition, arbitrary tools that support ODBC / JDBC interfaces can be connected as clients.  To work with SQL, we consider Hue and TOAD for Hadoop as our main clients. <br><br>  ETL subsystem consisting of SAS tools (Metadata Server, Data Integration Studio) and ETL framework written on the basis of SAS and shell scripts using a database for storing metadata of ETL processes .  Guided by the rules specified in the metadata, the ETL subsystem runs data processing processes on both QCD and the Data Research Platform.  As a result, we have an end-to-end system for monitoring and managing data flows regardless of the environment used (Teradata, Impala, Spark, etc., if there is a need for that). <br><br><h2>  Through the rake to the stars </h2><br>  Unloading QCD seems to be easy.  At the input and output of relational DBMS, take and pour data through Sqoop.  Judging by the description above, everything went very smoothly with us, but, of course, it was not without adventures, and this is perhaps the most interesting part of the whole project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c7/011/2fc/5c70112fc6dae573401cfd4a85733514.png"><br><br>  With our volume to pour all the data entirely every day could not hope.  Accordingly, it was necessary to learn how to allocate a reliable increment from each storage object, which is not always easy when the data for historical business dates can change in the table.  To solve this problem, we systematized objects depending on the methods of loading and maintaining history.  Then, for each type, the correct predicate for Sqoop and the method of loading into the receiver were determined.  Finally, they wrote instructions for developers of new objects. <br><br>  Sqoop is a very high-quality tool, but it does not work absolutely reliably in all cases and combinations of systems.  The Teradata connector did not work optimally on our volumes.  We took advantage of the openness of the Sqoop code and made changes to the connector libraries.  The stability of the connection when moving data has increased. <br><br>  For some reason, when Sqoop is addressed to Teradata, predicates are not quite correctly converted into WHERE conditions.  Because of this, Sqoop sometimes tries to pull out a huge table and filter it later.  We did not manage to patch the connector here, but we found another way out: we forcibly create a temporary table with a predicate for each paged object and ask Sqoop to overflow it. <br><br>  All MPP, and Teradata in particular, have a peculiarity related to the parallel storage of data and the execution of instructions.  If this feature is not taken into account, then it may turn out that one logical node of the cluster will take over all the work, due to which the execution of the query will become much slower, since it is 100-200 times.  Of course, we could not allow this, so we wrote a special engine that uses ETL-metadata of the QCD tables and selects the optimal degree of parallelization of the Sqoop tasks. <br><br>  Historic storage is a delicate matter, especially if you use <a href="https://en.wikipedia.org/wiki/Slowly_changing_dimension">SCD2</a> , while UPDATE and DELETE are not supported in Impala.  Of course, we want the historical tables in the Data Research Platform to look exactly the same as in Teradata.  This can be achieved by combining the incremental acquisition via Sqoop, the allocation of updatable business keys and the deletion of partitions in Impala.  To prevent this fanciful logic from being written to every developer, we packed it into a special library (on our ETL slang ‚Äúloader‚Äù). <br><br>  Finally - a question with data types.  Impala treats type conversion fairly freely, so we encountered some difficulties only in the TIMESTAMP and CHAR / VARCHAR types.  For date-time, we decided to store data in Impala in text (STRING) format YYYY-MM-DD HH: MM: SS.  This approach, as it turned out, quite allows you to use date and time transformation functions.  For string data of a given length, it turned out that storing in the STRING format in Impala is not inferior to them, so we also used it. <br><br>  Usually, to organize Data Lake, data sources are copied in semi-structured formats into a special stage area in Hadoop, after which the Hive or Impala tools set the de-serialization scheme for this data for use in SQL queries.  We went the same way.  It is important to note that not everything and not always makes sense to drag into the data warehouse, since the development of processes for copying files and installing a scheme is much cheaper than loading business attributes into the QCD model using ETL processes.  When it is still not clear how much, for how long, and how often the source data is needed, Data Lake in the described approach is a simple and cheap solution.  Now we regularly load into Data Lake primarily sources that generate user events: data from application analysis, logs and transfer scripts for Avaya auto calls and an Avaya answering machine, card transactions. <br><br><h2>  Analyst Toolkit </h2><br>  We have not forgotten about another goal of the whole project - to enable analysts to use all this wealth.  Here are the basic principles that guided us here: <br><br><ul><li>  Convenience of the tool in use and support <br></li><li>  Applicability in Data Science tasks <br></li><li>  Maximum use of Hadoop cluster computing resources, not application servers or researcher‚Äôs computers <br></li></ul><br>  And on what stopped: <br><br><ul><li>  Python + Anaconda.  IPython / Jupyter is used as a medium. <br></li><li>  R + Shiny.  The researcher works in the desktop or web version of R Studio, Shiny is used to develop web applications that are designed to use algorithms developed in R. <br></li><li>  Spark.  The interfaces for Python (pyspark) and R, configured in the development environments mentioned in the previous paragraphs, are used to work with data.  Both interfaces allow you to use the Spark ML library, which makes it possible to train ML models on a Hadoop / Spark cluster. <br></li><li>  Data in Impala is accessible through Hue, Spark and from development environments using standard ODBC interface and special libraries like implyr <br></li></ul><br>  Data Lake currently contains about 100 TB of data from retail storage plus about 50 TB from a number of OLTP sources.  The lake is updated daily in incremental mode.  In the future, we are going to increase user convenience, bring ELT-load to Impala, increase the number of sources loaded into Data Lake, and expand the possibilities for advanced analytics. <br><br>  In conclusion, I would like to give some general advice to colleagues who are just starting their way in creating large repositories: <br><br><ul><li>  Use best practices.  If we didn‚Äôt have an ETL subsystem, metadata, versioned storage, and a clear architecture, we would not have mastered this task.  Best practices pay for themselves, although not immediately. <br></li><li>  Remember the amount of data.  Big data can create technical difficulties in completely unexpected places. <br></li><li>  Watch out for new technologies.  New solutions appear often, not all of them are useful, but real pearls are sometimes found. <br></li><li>  Experiment more.  Do not trust only the marketing descriptions of solutions - try it yourself. <br></li></ul><br>  <i>By the way, you can read about how our analysts used machine learning and bank data to work with credit risks in a separate <a href="https://habr.com/company/vtb/blog/417739/">post</a> .</i> <i><br></i> </div><p>Source: <a href="https://habr.com/ru/post/420141/">https://habr.com/ru/post/420141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420125/index.html">Automation in the field of finance: bank employees may be left without work due to robots</a></li>
<li><a href="../420129/index.html">Patterns corinne asyncio: outside of await</a></li>
<li><a href="../420131/index.html">Bitcoin Probabilistic Mining Method</a></li>
<li><a href="../420133/index.html">Modeling Dynamic Systems: How does the moon move?</a></li>
<li><a href="../420139/index.html">The book "Site Reliability Engineering. Reliability and reliability as in Google "</a></li>
<li><a href="../420143/index.html">Kotlin performance on Android</a></li>
<li><a href="../420145/index.html">How is the working day of the members of the PC AppsConf</a></li>
<li><a href="../420147/index.html">OpenSource at Clojure</a></li>
<li><a href="../420151/index.html">Easier than it seems. Chapter 12</a></li>
<li><a href="../420153/index.html">3D printing of complex parts made of ABS and PLA plastics with a lot of support</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>