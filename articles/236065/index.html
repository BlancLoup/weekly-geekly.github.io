<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>All on one or as we built CDN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Among high-load (highload) systems, there is a big difference between systems with high load in terms of requests per second (RPS) and high load in te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>All on one or as we built CDN</h1><div class="post__text post__text-html js-mediator-article">  Among high-load (highload) systems, there is a big difference between systems with high load in terms of requests per second (RPS) and high load in terms of generated traffic (that is measured in gigabits per second).  In our ivi.ru load there is one and the other.  Now I want to tell you about how we generate hundreds of gigabits per second, and it does not hurt anyone. <br><br><img src="https://habrastorage.org/files/bc2/d08/1b9/bc2d081b91ad49499bdbadd3c0b4ae81.jpg"><br><a name="habracut"></a><br><h4>  Bike dreams </h4><br>  In the summer of 2011, a terrible thing happened: the RuNet enjoyed watching free movies so much that the growth in load overtook the growth in capacity for some time.  All this went to the channels of a single provider from a single Moscow data center.  It got to the point that some Moscow subscribers received a movie through Amsterdam.  It is clear that in such conditions it is quite problematic to fight for the title of the <s>house of high culture of life of the</s> best Internet cinema in Russia.  It was a volitional decision to use CDN (Content Delivery Network, content delivery network), and everything began to turn (including my modest participation). <br><br>  When we want to convey to the user several megabits of video traffic, we have two fundamental problems (of course, there are more problems, but they are not of such fundamental nature): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. You</b> need server power to give the user these megabits <br>  <b>2.</b> We need communication channels that these megabits will convey to the user <br><br>  TCP insists that the longer the packet turnover time (RTT, return-trip-time), and the greater the packet loss, the slower the data transfer rate.  Again, long-distance trunk lines are the most expensive, which means they are clogged.  As a consequence, the probability of packet loss increases with increasing distances.  Accordingly, we, with our HTTP (working on top of TCP), need to keep servers closer to subscribers. <br><br>  All this can be kept at home, and you can pay your uncle's money and use his CDN.  And you can only pay for the actual consumption, and all sorts of bad topics, such as a shortage of servers or clogged channels, become a headache for others.  Again, such an uncle has several clients, which means that it has large volumes both for the purchase of servers and for the purchase of channels.  Those.  low cost.  But how good is he? <br><br>  On the other hand, building your CDN has three major drawbacks: <br><br>  <b>1.</b> We must learn to build it. <br>  <b>2.</b> We'll have to work with many suppliers (instead of one, okay, two, CDN operator) <br>  <b>3.</b> To support, develop and plow oneself. <br><br>  But is it really scary? <br><br><h4>  Bicycle factory </h4><br>  Most commercial CDN operators offer free (or for a reasonable amount of money) testing.  And we took advantage of this opportunity.  The international CDN operators were surprised by the fact that they could send a subscriber from, say, Novosibirsk to the server where the thread is in South America.  And, of course, there was no server capacity in Russia (and we don‚Äôt show cinema abroad), they didn‚Äôt have at that time.  In fairness, I will say that now some of them are now putting their knots in our country.  And then I learned about a South American specialist from another domestic CDN operator.  In networks affected by Western capitalism, another goal of balancing is that they believe that there are enough communication channels.  They have the limiter is the server power.  That is where the server is more balanced ... <br><br>  Both foreign and domestic CDNs finally showed a level of quality (by which we understood the effective speed of content downloading by the end user), comparable to what we could have done ourselves at that moment.  But at prices everything turned out to be far less rosy than in theory.  Do you understand now why neither the names of companies, nor the numbers of measurements, will not be here? <br><br>  By the way, already this year the study ‚ÄúState of the Union: Ecommerce Page Speed ‚Äã‚Äã&amp; Web Performance‚Äù (available, for example, <a href="http://www.radware.com/spring-sotu2014/">here</a> ) was released - that the use of CDN slows down the loading of the site.  Here, as they say, coincided.  About why this happens, I plan to write separately. <br><br>  Well, okay, back to our CDN.  It became obvious that the network should be its own.  How to build it - that was the main question.  But here we are lucky.  First, it turned out that the server architecture at our central site was already divided into edge (border) and origin (source) servers.  And the edge servers, as it turned out, were very well delivered to external sites. <br><br>  Secondly, it turned out that providers know such a resource as ivi.ru, and most of them want to work with us to localize traffic.  In a significant number of cases, the operators themselves came out to contact and offered cooperation.  This certainly helped in the construction of new hubs.  In several regions, representatives of local providers directly told me: ‚ÄúFor us, the quality with which ivi.ru looks is an important competitive advantage.‚Äù <br><br>  Thirdly, it turned out that we do not need anything from the additional functionality offered by CDN providers.  No need to transcode content "on the fly" (all content is pre-encoded in all possible options).  No need for exotic protocols, like RTMP (we have everything on HTTP, and even the new-fashioned HLS is HTTP).  You do not need a thick channel with QoS to Moscow (for managing a node and updating the cache, a ‚Äúnormal‚Äù Internet is enough in the amount of 50-100 Mbit / s), even the fall of such an Internet does not stop subscriber service.  You do not need a ‚Äúraspasovshchik‚Äù and ‚Äúpatented algorithms of balancing‚Äù (I will not write this now, I will leave it for another article). <br><br>  As a result, we were able in a very short time to deploy our own CDN throughout the country. <br><br><img src="https://habrastorage.org/files/d37/79b/5aa/d3779b5aa56d4d1491c05fbd2b25f7c0.png"><br><br>  As a result of this work, now the ivi.ru sites are present in 23 cities of Russia.  To be honest, after 20 I was already uninteresting to recalculate, new nodes appear constantly.  The deployment of the new node itself takes one working day.  Node sizes range from one to eight servers.  On the multi-server nodes, of course, there is also network equipment: cisco series 3750X or 4500-X.  On the part of the nodes, the servers are connected by an aggregated 4 * 1 GbE link (these are small and medium-sized nodes).  On large nodes, servers connect with 10GbE interfaces. <br><br>  In some cities we have several knots, although with this we are now fighting.  To increase efficiency, it is advisable for us to have one large cluster rather than several small ones.  After all, small caches of the same popular content, and if you combine the same servers into a cluster, the amount of unique cached content will be much larger. <br><br>  More than half of the traffic generated by ivi.ru is now generated by nodes outside Moscow.  Interestingly, the daily fluctuation (the graph shows the ratio of the traffic generated in the regions to the total, Moscow time). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38e/a8c/50b/38ea8c50b685759b53c27c5e9de5f932.png" alt="image">  Clickable: <br><br> <a href=""><img src="https://habrastorage.org/files/38d/f52/a8a/38df52a8a0274017af46d90f322ebdbd.png"></a> <br><br>  It is very clear that at night the load on the CDN is minimal.  There are several reasons for this, but the main one is that people watch unpopular content at night.  One that is not cached (and not cached).  The maximum load on CDN is the time when people to the east of Moscow have already woken up, and Muscovites are still sleeping :) <br><br>  Traffic localization on a node ranges from 40% (small single-server nodes) to 90% (on the largest nodes).  Without a doubt, this could not affect the quality of customer service.  Here is a beautiful chart: <br><br><img src="https://habrastorage.org/files/90f/695/15f/90f69515fbd949de8209b3f40efe151a.png"><br><br>  I will not give fresh data - they have long been fluctuating at the level of statistical error, and such a beautiful ‚Äústep‚Äù cannot be seen there. <br><br>  This article was conceived as an overview about our CDN.  The next aspect I plan to talk about load balancing between cities and villages.  What other aspects of our CDN would be interesting for you? </div><p>Source: <a href="https://habr.com/ru/post/236065/">https://habr.com/ru/post/236065/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236049/index.html">Let's look under the hood: Microsoft Outlook 2013 Attachments Reminder</a></li>
<li><a href="../236053/index.html">Fastest Intel Core</a></li>
<li><a href="../236057/index.html">Traffic Optimization for Apache and Nginx Web Servers</a></li>
<li><a href="../236059/index.html">Results and Digital Trip Team</a></li>
<li><a href="../236061/index.html">CLion - the long-awaited IDE from JetBrains for C / C ++ developers - opens a public EAP</a></li>
<li><a href="../236067/index.html">10 rules for business analyst</a></li>
<li><a href="../236069/index.html">Samsung opens the world of mobile virtual reality with innovative glasses VR Gear</a></li>
<li><a href="../236071/index.html">The results of five years of life in the style of electronics freelance. Last autumn?</a></li>
<li><a href="../236073/index.html">Yandex. Translation: optimization and use</a></li>
<li><a href="../236075/index.html">A recipe article about user friendly GWT development in IDEA using DCEVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>