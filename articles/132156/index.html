<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search in line. Implementation in CPython</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite a while ago, at one of the presentations of graduates of one of the so-called IT academies, the speaker was asked about the details of the imple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search in line. Implementation in CPython</h1><div class="post__text post__text-html js-mediator-article">  Quite a while ago, at one of the presentations of graduates of one of the so-called IT academies, the speaker was asked about the details of the implementation of the search for a substring in the string of toli in Java, and in the net of .Net.  The graduate of course could not answer anything intelligibly, and I put the question in the already long todo list. <br><br>  The time has passed, Python has become more relevant to me enterprise platforms, so that your attention analysis of the search string algorithm in Python. <br><a name="habracut"></a><br>  The implementation of the string object can be found here - <a href="">Objects / stringobject.c</a> .  Definition of functions that are responsible for different types of search ( <i>find</i> , <i>rfind</i> , <i>__contains__</i> ) - <a href="">Objects / stringlib / find.h.</a>  All these functions (along with <i>split</i> , <i>replace</i> , etc.) use the search implemented in <a href="">Objects / stringlib / fastsearch.h</a> .  We will deal with them. <br><br>  The algorithm itself is named ( <a href="http://effbot.org/zone/stringlib.htm">The stringlib Library</a> ) by ( <a href="http://effbot.org/zone/about.htm">Fredrik Lundh</a> ) by the mix of <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%2591%25D0%25BE%25D0%25B9%25D0%25B5%25D1%2580%25D0%25B0_%25E2%2580%2594_%25D0%259C%25D1%2583%25D1%2580%25D0%25B0">Boyer-Moore</a> and <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%2591%25D0%25BE%25D0%25B9%25D0%25B5%25D1%2580%25D0%25B0_%25E2%2580%2594_%25D0%259C%25D1%2583%25D1%2580%25D0%25B0_%25E2%2580%2594_%25D0%25A5%25D0%25BE%25D1%2580%25D1%2581%25D0%25BF%25D1%2583%25D0%25BB%25D0%25B0">Horspul algorithms</a> with several improvements and simplifications.  The algorithm also uses <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%2591%25D0%25BB%25D1%2583%25D0%25BC%25D0%25B0">a bloom filter</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so, let's go.  Function Header: <br><pre><code class="hljs objectivec">fastsearch(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STRINGLIB_CHAR* s, Py_ssize_t n, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STRINGLIB_CHAR* p, Py_ssize_t m, Py_ssize_t maxcount, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mode) <span class="hljs-comment"><span class="hljs-comment">/* s - ,   , n -  , p - ,   (  ), m -  , maxcount -    ,       , mode -  /  /    */</span></span></code> </pre> <br>  Everything seems clear.  Let's look at <i>define</i> operators: <br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/*      mode */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAST_COUNT 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAST_SEARCH 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAST_RSEARCH 2 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* STRINGLIB_BLOOM_WIDTH    \(   )    32, 64, 128 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> STRINGLIB_BLOOM_ADD(mask, ch) ((mask |= (1UL &lt;&lt; ((ch) &amp; (STRINGLIB_BLOOM_WIDTH -1))))) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> STRINGLIB_BLOOM(mask, ch) ((mask &amp; (1UL &lt;&lt; ((ch) &amp; (STRINGLIB_BLOOM_WIDTH -1)))))</span></span></code> </pre><br>  How this implementation of bloom filters works.  Each character is assigned a number on the basis of its last <i>log (STRINGLIB_BLOOM_WIDTH)</i> bits.  For example, for <i>a</i> this is <i>1</i> : <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>ord(<span class="hljs-string"><span class="hljs-string">'a'</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  For <i>q</i> - <i>17</i> : <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>ord(<span class="hljs-string"><span class="hljs-string">'q'</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span></code> </pre><br>  Using the logical "OR" <i>STRINGLIB_BLOOM_ADD</i> accumulates information about the characters seen in the <i>mask</i> filter.  Later you can use <i>STRINGLIB_BLOOM</i> to check if a character has been added to the filter.  Of course, this check may have false positives ( <i>STRINGLIB_BLOOM</i> returns not 0, but the character is not really in the string \ filter): <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>ord(<span class="hljs-string"><span class="hljs-string">']'</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span> &gt;&gt;&gt; ord(<span class="hljs-string"><span class="hljs-string">'}'</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span></code> </pre><br>  But it is quite cheap and helps reduce the number of comparisons. <br><br>  Now you can go to the algorithm itself.  Obvious logic for cases <i>m&gt; n</i> and <i>m &lt;= 1</i> : <br><pre> <code class="hljs kotlin"> w = n - m; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (w &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || (mode == FAST_COUNT &amp;&amp; maxcount == <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  and (part of the code is omitted so as not to tear the article): <br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == FAST_COUNT) { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode == FAST_SEARCH) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s[i] == p[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* FAST_RSEARCH */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  After we have a few new variables and the mask is filled in for the required substring: <br><pre> <code class="hljs matlab"> mlast = m - <span class="hljs-number"><span class="hljs-number">1</span></span>; skip = mlast - <span class="hljs-number"><span class="hljs-number">1</span></span>; mask = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; mlast; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { STRINGLIB_BLOOM_ADD(mask, p[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>] == p[mlast]) skip = mlast - <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>; } STRINGLIB_BLOOM_ADD(mask, p[mlast]);</code> </pre><br>  <i>skip</i> is a number, defaults to the index of the last character of the search string minus 1. If there are characters in the string that are equal to the last, then <i>skip</i> is equal to the difference between the indices of the last character and the last character of the line. <br><br>  Description of the idea of ‚Äã‚Äãthe main algorithm from Wikipedia: <br><br>  <i>Scan from left to right, right to left comparison.</i>  <i>The beginning of the text (string) and the template is combined, the check starts with the last character of the template.</i>  <i>If the characters match, the last-to-last character of the pattern is compared, etc. If all the characters of the pattern match the superimposed characters of the string, then the substring is found and the search is over.</i> <i><br><br></i>  <i>If a character in the pattern does not match the corresponding character in the string, the pattern shifts a few characters to the right, and the test starts again from the last character.</i> <br><br>  Actually the implementation of this description (above <i>w = n - m</i> ): <br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= w; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s[i+m-<span class="hljs-number"><span class="hljs-number">1</span></span>] == p[m-<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-comment"><span class="hljs-comment">/* ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; mlast; j++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s[i+j] != p[j]) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (j == mlast) { <span class="hljs-comment"><span class="hljs-comment">/*  ! */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode != FAST_COUNT) <span class="hljs-comment"><span class="hljs-comment">/*       - ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> count++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count == maxcount) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maxcount; i = i + mlast; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*         ,      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!STRINGLIB_BLOOM(mask, s[i+m])) <span class="hljs-comment"><span class="hljs-comment">/*  ,           */</span></span> i = i + m; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,        'skip' */</span></span> i = i + skip; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*     .      ,        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!STRINGLIB_BLOOM(mask, s[i+m])) <span class="hljs-comment"><span class="hljs-comment">/*  ,           */</span></span> i = i + m; <span class="hljs-comment"><span class="hljs-comment">/*   , i++ */</span></span> } }</code> </pre><br>  A bit of visualization.  Let us work with the string ‚Äúdrum‚Äù and look for the substring ‚Äúaba‚Äù: <br><pre> <code class="hljs ruby">    skip = <span class="hljs-number"><span class="hljs-number">1</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>: _____________<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-params"><span class="hljs-params">| -  , i++ _______ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| i = 1: ______________ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span> -  ,   ______<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span> _____________<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-params"><span class="hljs-params">| -  .    ""  ""   ,   skip,   </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params">   i += 2 _______ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| i = 3: ______________ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span> -  ,   ______<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span> _____________<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-params"><span class="hljs-params">| -  ,   _______ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| ______________ |</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">| |</span></span> -  ,   ______<span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-params"><span class="hljs-params">||</span></span><span class="hljs-params"><span class="hljs-params">||</span></span></code> </pre><br>  Well that's all. <br><br>  If you like it, there are a lot of places in the Python source that are interesting to dig into.  For example, the <i>list.sort</i> implementation in <a href="">Objects / listobject.c</a> or <i>dict.get</i> in <a href="">Objects / dictobject.c</a> . <br><br>  Good luck! :) </div><p>Source: <a href="https://habr.com/ru/post/132156/">https://habr.com/ru/post/132156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132151/index.html">Listen to Habr on the "radio"</a></li>
<li><a href="../132152/index.html">Transferring Flash to iPhone / iPad</a></li>
<li><a href="../132153/index.html">Disposable URI: destroy after reading</a></li>
<li><a href="../132154/index.html">Visit the DevExpress booth at Tech ‚àô Ed Russia and win valuable prizes!</a></li>
<li><a href="../132155/index.html">Methodology for creating a selling online store</a></li>
<li><a href="../132157/index.html">Olympiad in Java programming for students</a></li>
<li><a href="../132159/index.html">Mex is looking for work in the US</a></li>
<li><a href="../132160/index.html">Debugging javascript on mobile devices</a></li>
<li><a href="../132161/index.html">Severe C ++ Subbotnik for severe coders - November 19, Dnepropetrovsk</a></li>
<li><a href="../132162/index.html">Enote V117 Tablet Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>