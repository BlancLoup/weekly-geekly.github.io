<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Objective-C, static libraries, categories, -ObjC, pain‚Ä¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not everyone was lucky to write applications completely on Swift, and even under ios 8+ onli. A lot of legacy in Objective-C, a lot of dependencies co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Objective-C, static libraries, categories, -ObjC, pain‚Ä¶</h1><div class="post__text post__text-html js-mediator-article">  Not everyone was lucky to write applications completely on Swift, and even under ios 8+ onli.  A lot of legacy in Objective-C, a lot of dependencies comes through static, neither cocoapods, nor carthage, all handles.  We are cool developers, so we strictly follow DRY and all reusable snacks are brought out either in separate projects or in library statics.  Now consider the case when we made a cool static library with a no less cool api, and would like to share with colleagues in the shop within the company - put the archiver with liba, headers and, of course, the readme where the whole api is described on the wiki resource / game use it. <br><br>  For example, consider one class + its category. <br><br><img src="https://habrastorage.org/files/61e/c5e/c38/61ec5ec380994fb79744943681bde734.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  In the screenshot we have the structure of the project, where the class + class category, everything is simple.  We collect in the usual way, we write readme.md with the description api and we archive the library.  Everything is cool, poured on the wiki, the boys tweeted in slack / skype / etc and went for another coffee.  You just crouched back with freshly brewed coffee and the mouse cursor almost reached the tab for Habr, some logs fell in chat rooms, and everyone requires your immediate response, since the problem is in freshly liberated.  You were thrown into the pot, because you have a test coverage of 146%, everything was rechecked a hundred times.  At the same time, the same error log is written again in the chat: <br><br><pre><code class="objectivec hljs">*** Terminating app due to uncaught exception <span class="hljs-string"><span class="hljs-string">'NSInvalidArgumentException', reason: '</span></span>-[Deadpool guns]: unrecognized selector sent to instance <span class="hljs-number"><span class="hljs-number">0x7ffecbc12df0</span></span><span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre> <br><br>  After reading the log, the reason is clear and painfully familiar when you often work with statics libs.  Having understood the problem, you confidently wipe the sweat from your forehead, open the previously sent readme.md and append: <br><br>  <i>Don't forget to add the '-ObjC' flag to the 'Other Linker Flags' in Build Settins of Xcode's scheme.</i> <br><br>  After, they updated the wiki, again they notified everyone and everything seemed to calm down, the messengers were silent, the coffee did not even have time to cool down.  ‚ÄúWell, now for sure nobody will stop me‚Äù - your inner voice whispers and the mouse cursor again reaches for the cherished bookmark (Neneen, only Habr!).  From the desired you are separated only by clicking on the left mouse button, but the thought does not leave you: ‚ÄúWas it possible to avoid this error or how to prevent it in the future ?!‚Äù.  ‚ÄúFuck it all!‚Äù Exclaimed the inner voice and the cursor reached for Terminal.app. <br><br><pre> <code class="bash hljs">otool -tV -arch x86_64 libDeadpool.a</code> </pre><br><br>  gives: <br><br><pre> <code class="bash hljs">Archive : libDeadpool.a libDeadpool.a(Deadpool+Guns.o): (__TEXT,__text) section -[Deadpool(Guns) guns]: 0000000000000000 pushq %rbp 0000000000000001 movq %rsp, %rbp 0000000000000004 subq <span class="hljs-variable"><span class="hljs-variable">$0x10</span></span>, %rsp 0000000000000008 leaq 0x71(%rip), %rax <span class="hljs-comment"><span class="hljs-comment">## Objc cfstring ref: @"sword 2" 000000000000000f movd %rax, %xmm0 0000000000000014 leaq 0x45(%rip), %rax ## Objc cfstring ref: @"sword 1" 000000000000001b movd %rax, %xmm1 0000000000000020 punpcklqdq %xmm0, %xmm1 ## xmm1 = xmm1[0],xmm0[0] 0000000000000024 movdqa %xmm1, -0x10(%rbp) 0000000000000029 movq 0x70(%rip), %rdi ## Objc class ref: NSArray 0000000000000030 movq 0x91(%rip), %rsi ## Objc selector ref: arrayWithObjects:count: 0000000000000037 leaq -0x10(%rbp), %rdx 000000000000003b movl $0x2, %ecx 0000000000000040 callq *_objc_msgSend(%rip) 0000000000000046 addq $0x10, %rsp 000000000000004a popq %rbp 000000000000004b retq libDeadpool.a(Deadpool.o): (__TEXT,__text) section -[Deadpool name]: 0000000000000000 pushq %rbp 0000000000000001 movq %rsp, %rbp 0000000000000004 movq 0x1d(%rip), %rsi ## Objc selector ref: class 000000000000000b callq *_objc_msgSend(%rip) 0000000000000011 movq %rax, %rdi 0000000000000014 popq %rbp 0000000000000015 jmp _NSStringFromClass</span></span></code> </pre><br><br>  hmm, in lib itself all the methods are in place, now let's see the source code of the application: <br><br><pre> <code class="bash hljs">otool -tV -arch x86_64 DemoApp.app/DemoApp | grep Deadpool</code> </pre><br><br>  gives: <br><br><pre> <code class="bash hljs">0000000100001ae8 movq 0x21f1(%rip), %rdi <span class="hljs-comment"><span class="hljs-comment">## Objc class ref: Deadpool 0000000100001af6 movq 0x1513(%rip), %r12 ## Objc message: +[Deadpool new] -[Deadpool name]:</span></span></code> </pre><br><br>  WTF!  Okay Google, where is the method from the category? <br><br>  Google skillfully slips us a link to the epl documentation on this problem <a href="https://developer.apple.com/library/mac/qa/qa1490/_index.html">https://developer.apple.com/library/mac/qa/qa1490/_index.html</a> , where a quick translation says the following: <br><br>  <b>The linker</b> <br><br><blockquote>  When the C program is compiled, each file (.c) is compiled into a so-called ‚Äúobject file‚Äù (.o), which contains implementations of functions and other static information.  After the linker collects all these files into one final file - executable.  And this executable file just gets inside our .app by means of Xcode. <br><br>  But when the source file (.c) uses something, for example, a function that is defined in another file (another .c file), then the ‚Äúundefined symbol‚Äù is written to the .o file for this piece of code.  And at the assembly stage, the linker has enough information to understand where it is necessary to pull out the missing thing from the ‚Äúundefined symbol‚Äù in order to collect the final executable.  This description is for building a UNIX static library. </blockquote><br><br>  <b>Objective c</b> <br><br><blockquote>  Due to the dynamic nature of the language, this process in Objective-C is a bit complicated, since the search for the implementation of a method occurs only after the fact that the method is accessed.  Objective-C does not define auxiliary symbols for linker methods, but only defines symbols for classes.  For example, in the class / main.o file there is a code: <br><br>  [[FooClass alloc] initWithBar: nil] <br><br>  that is, FooClass is a separate class, in a separate FooClass.o file, so main.o will only contain an ‚Äúundefined symbol‚Äù for FooClass itself, but no additional symbols for the -initWithBar method: in this class. <br><br>  Since a category is just a separate file with methods, the linker has absolutely no information that this file needs to be linked, since no methods are created for the linker ‚Äúundefined symbol‚Äù. </blockquote><br><br>  So, sort of sorted out, once again look at the byte code of the lib: <br><br><pre> <code class="bash hljs">Archive : libDeadpool.a libDeadpool.a(Deadpool+Guns.o): (__TEXT,__text) section -[Deadpool(Guns) guns]: 0000000000000000 pushq %rbp 0000000000000001 movq %rsp, %rbp 0000000000000004 subq <span class="hljs-variable"><span class="hljs-variable">$0x10</span></span>, %rsp 0000000000000008 leaq 0x71(%rip), %rax <span class="hljs-comment"><span class="hljs-comment">## Objc cfstring ref: @"sword 2" 000000000000000f movd %rax, %xmm0 0000000000000014 leaq 0x45(%rip), %rax ## Objc cfstring ref: @"sword 1" 000000000000001b movd %rax, %xmm1 0000000000000020 punpcklqdq %xmm0, %xmm1 ## xmm1 = xmm1[0],xmm0[0] 0000000000000024 movdqa %xmm1, -0x10(%rbp) 0000000000000029 movq 0x70(%rip), %rdi ## Objc class ref: NSArray 0000000000000030 movq 0x91(%rip), %rsi ## Objc selector ref: arrayWithObjects:count: 0000000000000037 leaq -0x10(%rbp), %rdx 000000000000003b movl $0x2, %ecx 0000000000000040 callq *_objc_msgSend(%rip) 0000000000000046 addq $0x10, %rsp 000000000000004a popq %rbp 000000000000004b retq libDeadpool.a(Deadpool.o): (__TEXT,__text) section -[Deadpool name]: 0000000000000000 pushq %rbp 0000000000000001 movq %rsp, %rbp 0000000000000004 movq 0x1d(%rip), %rsi ## Objc selector ref: class 000000000000000b callq *_objc_msgSend(%rip) 0000000000000011 movq %rax, %rdi 0000000000000014 popq %rbp 0000000000000015 jmp _NSStringFromClass</span></span></code> </pre><br><br>  Indeed, we have compiled two files <b>Deadpool.o</b> and <b>Deadpool + Guns.o</b> , since the second file is just a set of methods for the first, the linker knows nothing about it and therefore we get this error only in runtime. <br><br>  Immediately the first solution is to transfer the category to the main class file.  Yes, it will work :) but for us it is not very convenient, as we used to keep all categories in separate daddies for order. <br><br>  Another solution.  Those who use our lib should specify the -ObjC flag in the ‚ÄúOther Linker Flags‚Äù, this flag tells the linker to load everything everything from the static lib.  Well, this decision suits us that we don't need to rule anything on our side.  But if you think about it, if a developer connects a bunch of libs and only because of ours he has to add this flag, then he can get a sickly weight gain for his application (I guess so). <br><br>  Is it possible to somehow tell the linker to assemble the class and its categories into one file?  It turns out there is such a name for it "Perform Single-Object Prelink" or "GENERATE_MASTER_OBJECT_FILE" in the pbxproj file.  The truth is, it is not just the merging of a class and its category into a single file, but all project files will be like a single ‚Äúobject file‚Äù.  If this value is set to true, then we need to get the behavior we want.  Check it out. <br><br>  Expose: <br><br><img src="https://habrastorage.org/files/ab6/a9f/d56/ab6a9fd56fff4736b27d9a5546e6c48d.png"><br><br><pre> <code class="bash hljs">otool -tV -arch x86_64 libDeadpool.a</code> </pre><br><br>  we get: <br><br><pre> <code class="bash hljs">Archive : libDeadpool.a libDeadpool.a(libDeadpool.a-x86_64-master.o): (__TEXT,__text) section -[Deadpool(Guns) guns]: 0000000000000000 pushq %rbp 0000000000000001 movq %rsp, %rbp 0000000000000004 subq <span class="hljs-variable"><span class="hljs-variable">$0x10</span></span>, %rsp 0000000000000008 leaq 0x149(%rip), %rax <span class="hljs-comment"><span class="hljs-comment">## Objc cfstring ref: @"sword 2" 000000000000000f movd %rax, %xmm0 0000000000000014 leaq 0x11d(%rip), %rax ## Objc cfstring ref: @"sword 1" 000000000000001b movd %rax, %xmm1 0000000000000020 punpcklqdq %xmm0, %xmm1 ## xmm1 = xmm1[0],xmm0[0] 0000000000000024 movdqa %xmm1, -0x10(%rbp) 0000000000000029 movq 0x270(%rip), %rdi ## Objc class ref: NSArray 0000000000000030 movq 0x259(%rip), %rsi ## Objc selector ref: arrayWithObjects:count: 0000000000000037 leaq -0x10(%rbp), %rdx 000000000000003b movl $0x2, %ecx 0000000000000040 callq *_objc_msgSend(%rip) 0000000000000046 addq $0x10, %rsp 000000000000004a popq %rbp 000000000000004b retq -[Deadpool name]: 000000000000004c pushq %rbp 000000000000004d movq %rsp, %rbp 0000000000000050 movq 0x241(%rip), %rsi ## Objc selector ref: class 0000000000000057 callq *_objc_msgSend(%rip) 000000000000005d movq %rax, %rdi 0000000000000060 popq %rbp 0000000000000061 jmp _NSStringFromClass</span></span></code> </pre><br><br>  What they wanted, now everything is in one file <b>libDeadpool.a-x86_64-master.o</b> .  We remove from the application <i>-ObjC</i> and reassemble with the new version of our library and see: <br><br><pre> <code class="bash hljs">otool -tV -arch x86_64 DemoApp.app/DemoApp | grep Deadpool</code> </pre><br><br>  conclusion: <br><br><pre> <code class="bash hljs">0000000100001a70 movq 0x22c9(%rip), %rdi <span class="hljs-comment"><span class="hljs-comment">## Objc class ref: Deadpool 0000000100001a7e movq 0x158b(%rip), %r12 ## Objc message: +[Deadpool new] -[Deadpool(Guns) guns]: -[Deadpool name]:</span></span></code> </pre><br><br>  Fine.  Now it is possible to delete information about <i>-ObjC</i> flag from readme.md, boldly open Habr and finish, unfortunately, already cooled coffee) <br><br>  ps <br><br>  The problem is old, it has long been decided, now I‚Äôm here to write my hands and understand it in more detail) <br>  I'm not sure about the ideal solution, but it helped me with this problem, maybe someone will be interested. <br><br>  Useful links: <br><br>  <a href="https://developer.apple.com/library/mac/qa/qa1490/_index.html">https://developer.apple.com/library/mac/qa/qa1490/_index.html</a> <br>  <a href="http://stackoverflow.com/questions/2567498/objective-c-categories-in-static-library">http://stackoverflow.com/questions/2567498/objective-c-categories-in-static-library</a> </div><p>Source: <a href="https://habr.com/ru/post/283570/">https://habr.com/ru/post/283570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283550/index.html">Distribute pictures by rails after disabling Google‚Äôs svn repositories</a></li>
<li><a href="../283552/index.html">Reduce the size of published npm modules</a></li>
<li><a href="../283554/index.html">Adding Unreal Engine support for dxf format</a></li>
<li><a href="../283556/index.html">Angular 2 Beta, training course "Tour of Heroes" part 4</a></li>
<li><a href="../283560/index.html">Delete your dead code</a></li>
<li><a href="../283572/index.html">PyNSK # 8 - May meeting of the Novosibirsk Python community</a></li>
<li><a href="../283576/index.html">IOS TEAM Developer Portfolio</a></li>
<li><a href="../283580/index.html">The digest of interesting materials for the mobile # 153 developer (May 10-15)</a></li>
<li><a href="../283582/index.html">Video of the best reports of the .NET conference DotNext 2015 Moscow</a></li>
<li><a href="../283584/index.html">LUWRAIN - distribution and work environment, in which it is not necessary to look at the screen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>