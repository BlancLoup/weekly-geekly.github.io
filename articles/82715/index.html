<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DSL elements in PHP: making library APIs easier to use</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing our internal framework (unfortunately, PHP in general is very conducive to the constant reinvention of the bicycle), we tried to desig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DSL elements in PHP: making library APIs easier to use</h1><div class="post__text post__text-html js-mediator-article"> When developing our internal framework (unfortunately, PHP in general is very conducive to the constant reinvention of the bicycle), we tried to design the interfaces of the library modules in such a way so that the client code using these interfaces is simple, concise and readable. <br><br>  Ideally, a specialized module designed to solve a particular task should form a kind of simplified language that allows the developer to describe the solution or the result of solving the problem as close as possible to the terms of the subject area.  In this case, if we do not go beyond the framework of the programming language used, we are talking about the implementation of the so-called <a href="http://www.martinfowler.com/bliki/DomainSpecificLanguage.html">internal DSL</a> . <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A lot has been written about DSL implementation in various languages, for example, a <a href="http://martinfowler.com/dslwip/index.html">catalog of patterns on this topic</a> is available on the Fowler website.  The features of any design pattern are largely determined by the implementation language, for DSL patterns this is doubly true.  Unfortunately, the range of possibilities that PHP can provide is extremely limited.  Nevertheless, using two standard templates - <a href="http://martinfowler.com/dslwip/MethodChaining.html">Method Chaining</a> and <a href="http://martinfowler.com/bliki/ExpressionBuilder.html">Expression Builder</a> , you can achieve a more convenient and readable API. <br><br>  Proper naming of classes and methods is half the battle when developing DSL-style APIs.  It is important that the methods be named as close as possible to the subject area, and not to the software implementation.  It sounds trite, but you can find a lot of examples when the naming is caused, for example, by the implementation of a classic design pattern from <a href="http://en.wikipedia.org/wiki/Design_Patterns">GoF</a> . <br><br>  The use of call chains (method chaining) makes the code more concise and in some cases allows to achieve the effect of a specialized DSL.  When developing library modules, we try to follow the rule: if the method does not return a functionally necessary result, let it return <code>$this</code> .  Also, we usually provide a set of methods for setting the internal properties of an object, which allows you to customize the parameters of an object inside an expression and also makes the code more concise. <br><br>  The Pattern Builder allows you to more conveniently build systems of nested objects, when the parent object contains references to children, those in turn, to their children, and so on.  Note that in PHP it is advisable to avoid bidirectional links (the parent object refers to the child, and the child to the parent), since the garbage collector does not work with circular references. <br><br>  To create such systems, we will create a very simple base class: <br><br><blockquote> <code><a href="http://www.php.net/manual/en/function.method-exists.php"></a> <a href="http://www.php.net/manual/en/function.call-user-func-array.php"></a></code> <ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#0000ff">class</font> DSL_Builder { </li><li></li><li>  <font color="#0000ff">protected</font> <font color="#cc6633">$ parent</font> ; </li><li>  <font color="#0000ff">protected</font> <font color="#cc6633">$ object</font> ; </li><li></li><li>  <font color="#0000ff">public function</font> __construct ( <font color="#cc6633">$ parent</font> , <font color="#cc6633">$ object</font> ) { </li><li>  <font color="#cc6633">$ this</font> -&gt; parent = <font color="#cc6633">$ parent</font> ; </li><li>  <font color="#cc6633">$ this</font> -&gt; object = <font color="#cc6633">$ object</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> __get ( <font color="#cc6633">$ property</font> ) { </li><li>  <font color="#0000ff">switch</font> ( <font color="#cc6633">$ property</font> ) { </li><li>  <font color="#0000ff">case</font> <font color="#008000">'end'</font> : </li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> -&gt; parent?  <font color="#cc6633">$ this</font> -&gt; parent: <font color="#cc6633">$ this</font> -&gt; object; </li><li>  <font color="#0000ff">case</font> <font color="#008000">'object'</font> : </li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> -&gt; <font color="#cc6633">$ property</font> ; </li><li>  <font color="#0000ff">default</font> : </li><li>  <font color="#0000ff">throw new</font> Core_MissingPropertyException ( <font color="#cc6633">$ property</font> ); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> __set ( <font color="#cc6633">$ property</font> , <font color="#cc6633">$ value</font> ) { <font color="#0000ff">throw new</font> Core_ReadOnlyObjectException ( <font color="#cc6633">$ this</font> );  } </li><li></li><li>  <font color="#0000ff">public function</font> __isset ( <font color="#cc6633">$ property</font> ) { </li><li>  <font color="#0000ff">switch</font> ( <font color="#cc6633">$ property</font> ) { </li><li>  <font color="#0000ff">case</font> <font color="#008000">'object'</font> : </li><li>  <font color="#0000ff">return isset</font> ( <font color="#cc6633">$ this</font> -&gt; <font color="#cc6633">$ property</font> ); </li><li>  <font color="#0000ff">default</font> : </li><li>  <font color="#0000ff">return false</font> ; </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> __unset ( <font color="#cc6633">$ property</font> ) { <font color="#0000ff">throw new</font> Core_ReadOnlyObjectException ( <font color="#cc6633">$ this</font> );  } </li><li></li><li>  <font color="#0000ff">public function</font> __call ( <font color="#cc6633">$ method</font> , <font color="#cc6633">$ args</font> ) { </li><li>  method_exists ( <font color="#cc6633">$ this</font> -&gt; object, <font color="#cc6633">$ method</font> )? </li><li>  call_user_func_array ( <font color="#0000ff">array</font> ( <font color="#cc6633">$ this</font> -&gt; object, <font color="#cc6633">$ method</font> ), <font color="#cc6633">$ args</font> ): </li><li>  <font color="#cc6633">$ this</font> -&gt; object-&gt; <font color="#cc6633">$ method</font> = <font color="#cc6633">$ args</font> [ <font color="#008000">0</font> ]; </li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> ; </li><li>  } </li><li>  } </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  Objects of this class set up the target object, the link to which is stored in the <code>$object</code> field, delegating to it a method call and setting properties.  Of course, the builder can define its own set of methods for more complex configuration of the target object.  In this case, the <code>end</code> pseudo-property allows you to return to the parent object builder, and so on. <br><br>  On the basis of this class, we write the simplest DSL to describe the application configuration. <br><br><blockquote> <code><a href="http://www.php.net/manual/en/function.ob-start.php"></a> <a href="http://www.php.net/manual/en/function.ob-end-clean.php"></a> <a href="http://www.php.net/manual/en/function.strpos.php"></a> <a href="http://www.php.net/manual/en/function.substr.php"></a></code> <ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#0000ff">class</font> Config_DSL_Builder <font color="#0000ff">extends</font> DSL_Builder { </li><li></li><li>  <font color="#0000ff">public function</font> __construct (Config_DSL_Builder <font color="#cc6633">$ parent</font> = <font color="#0000ff">null</font> , <font color="#cc6633">stdClass $ object</font> = <font color="#0000ff">null</font> ) { </li><li>  parent :: __ construct ( <font color="#cc6633">$ parent</font> , Core :: if_null ( <font color="#cc6633">$ object</font> , <font color="#0000ff">new</font> <font color="#cc6633">stdClass</font> ())); </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> load ( <font color="#cc6633">$ file</font> ) { </li><li>  ob_start (); </li><li>  <font color="#0000ff">include</font> ( <font color="#cc6633">$ file</font> ); </li><li>  ob_end_clean (); </li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> begin ( <font color="#cc6633">$ name</font> ) { </li><li>  <font color="#0000ff">Return new</font> Config_DSL_Builder ( <font color="#cc6633">$ this</font> , <font color="#cc6633">$ this</font> -&gt; object-&gt; <font color="#cc6633">$ name</font> = <font color="#0000ff">new</font> <font color="#cc6633">stdClass</font> ()); </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> __get ( <font color="#cc6633">$ property</font> ) { </li><li>  <font color="#0000ff">return</font> (strpos ( <font color="#cc6633">$ property</font> , <font color="#008000">'begin_'</font> ) === <font color="#008000">0</font> )? </li><li>  <font color="#cc6633">$ this</font> -&gt; begin (substr ( <font color="#cc6633">$ property</font> , <font color="#008000">6</font> )): </li><li>  parent :: __ get ( <font color="#cc6633">$ property</font> ); </li><li>  } </li><li></li><li>  <font color="#0000ff">public function</font> __call ( <font color="#cc6633">$ method</font> , <font color="#cc6633">$ args</font> ) { </li><li>  <font color="#cc6633">$ this</font> -&gt; object-&gt; <font color="#cc6633">$ method</font> = <font color="#cc6633">$ args</font> [ <font color="#008000">0</font> ]; </li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> ; </li><li>  } </li><li>  } </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  Now we can create a <code>config.php</code> in which we describe the configuration of our application in the following form: <br><br><blockquote><ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#cc6633">$ this</font> -&gt; </li><li>  begin_db-&gt; </li><li>  dsn ( <font color="#008000">'mysql: // user: password @ localhost / db'</font> ) -&gt; </li><li>  end-&gt; </li><li>  begin_cache-&gt; </li><li>  dsn ( <font color="#008000">'dummy: //'</font> ) -&gt; </li><li>  default_timeout ( <font color="#008000">300</font> ) -&gt; </li><li>  timeouts ( <font color="#0000ff">array</font> ( </li><li>  <font color="#008000">'front / index'</font> =&gt; <font color="#008000">300</font> , </li><li>  <font color="#008000">'news / most_popular'</font> =&gt; <font color="#008000">300</font> , </li><li>  <font color="#008000">'news / category'</font> =&gt; <font color="#008000">300</font> )) -&gt; </li><li>  end-&gt; </li><li>  begin_site-&gt; </li><li>  begin_from-&gt; </li><li>  top_limit ( <font color="#008000">7</font> ) -&gt; </li><li>  end-&gt; </li><li>  begin_news-&gt; </li><li>  most_popular_limit ( <font color="#008000">5</font> ) -&gt; </li><li>  end-&gt; </li><li>  end; </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  You can load the configuration by calling: <br><br><blockquote><ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#cc6633">$ config</font> = Config_DSL :: Builder () -&gt; load ( <font color="#008000">'config.php'</font> ); </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  Of course, business is not limited only to configs.  For example, we describe the structure of a REST application like this: <br><br><blockquote><ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  WS_REST_DSL :: Application () -&gt; </li><li>  media_type ( <font color="#008000">'html'</font> , <font color="#008000">'text / html'</font> , <font color="#0000ff">true</font> ) -&gt; </li><li>  media_type ( <font color="#008000">'rss'</font> , <font color="#008000">'application / xhtml + xml'</font> ) -&gt; </li><li>  begin_resource ( <font color="#008000">'gallery'</font> , <font color="#008000">'App.Photo.Gallery'</font> , <font color="#008000">'galleries / {id: \ d +}'</font> ) -&gt; </li><li>  for_format ( <font color="#008000">'html'</font> ) -&gt; </li><li>  get_for ( <font color="#008000">'{page_no: \ d +}'</font> , <font color="#008000">'index'</font> ) -&gt; </li><li>  post_for ( <font color="#008000">'vote'</font> , <font color="#008000">'vote'</font> ) -&gt; </li><li>  index () -&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  begin_resource ( <font color="#008000">'index'</font> , <font color="#008000">'App.Photo.Index'</font> ) -&gt; </li><li>  for_format ( <font color="#008000">'rss'</font> ) -&gt; </li><li>  get ( <font color="#008000">'index_rss'</font> ) -&gt; </li><li>  get_for ( <font color="#008000">'top'</font> , <font color="#008000">'top_rss'</font> ) -&gt; </li><li>  end-&gt; </li><li>  for_format ( <font color="#008000">'html'</font> ) -&gt; </li><li>  get_for ( <font color="#008000">'{page_no: \ d +}'</font> , <font color="#008000">'index'</font> ) -&gt; </li><li>  index () -&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li></li><li>  end; </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  Using fast DSL-style APIs allows you to get short and readable code, for example, in the application controller methods: <br><br><blockquote> <code><a href="http://www.php.net/manual/en/function.count.php"></a> <a href="http://www.php.net/manual/en/function.select.php"></a> <a href="http://www.php.net/manual/en/function.select.php"></a></code> <ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  <font color="#0000ff">public function</font> index ( <font color="#cc6633">$ page_no</font> = <font color="#008000">1</font> ) { </li><li>  <font color="#cc6633">$ pager</font> = Data_Pagination :: pager ( <font color="#cc6633">$ this</font> -&gt; db-&gt; photo-&gt; galleries-&gt; count (), <font color="#cc6633">$ page_no</font> , self :: PAGE_LIMIT); </li><li></li><li>  <font color="#0000ff">return</font> <font color="#cc6633">$ this</font> -&gt; html ( <font color="#008000">'index'</font> ) -&gt; </li><li>  with ( <font color="#0000ff">array</font> ( </li><li>  <font color="#008000">'top'</font> =&gt; <font color="#cc6633">$ this</font> -&gt; db-&gt; photo-&gt; galleries-&gt; most_important () -&gt; select (), </li><li>  <font color="#008000">'pager'</font> =&gt; <font color="#cc6633">$ pager</font> , </li><li>  <font color="#008000">'galleries'</font> =&gt; <font color="#cc6633">$ this</font> -&gt; db-&gt; photo-&gt; galleries-&gt; </li><li>  published () -&gt; </li><li>  paginate_with ( <font color="#cc6633">$ pager</font> ) -&gt; </li><li>  select ())); </li><li>  } </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  In some relatively rare cases, one can go even further.  <code>DSL_Builder</code> slightly expanding the <code>DSL_Builder</code> class, it is possible to describe not only a static structure, but also a set of actions, that is, some script.  For example, with the <a href="http://code.google.com/apis/adwords/docs/developer/index.html">Google AdWords API</a> you can work like this: <br><br><blockquote> <code><a href="http://www.php.net/manual/en/function.bind.php"></a></code> <ol><li>  <font color="#cc6633">&lt;? php</font> </li><li>  Service_Google_AdWords_DSL :: Script () -&gt; </li><li>  for_campaign ( <font color="#cc6633">$ campaign_id</font> ) -&gt; </li><li>  for_ad_group ( <font color="#cc6633">$ group_id</font> ) -&gt; </li><li>  for_each ( <font color="#008000">'text'</font> , <font color="#008000">'keyword1'</font> , <font color="#008000">'keyword2'</font> , <font color="#008000">'keyword3'</font> ) -&gt; </li><li>  add_keyword_criteria () -&gt; </li><li>  bind ( <font color="#008000">'text'</font> ) -&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  add_ad () -&gt; </li><li>  with ( <font color="#008000">'headline'</font> , <font color="#008000">'headline'</font> , </li><li>  <font color="#008000">'displayUrl'</font> , <font color="#008000">'www.techart.ru'</font> , </li><li>  <font color="#008000">'destinationUrl'</font> , <font color="#008000">'http://www.techart.ru/'</font> , </li><li>  <font color="#008000">'description1'</font> , <font color="#008000">'desc1'</font> , </li><li>  <font color="#008000">'description2'</font> , <font color="#008000">'desc2'</font> ) -&gt; </li><li>  format ( <font color="#008000">"Ad Created"</font> ) -&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  for_each_campaign () -&gt; </li><li>  format ( <font color="#008000">"Campaign:% d,% s \ n"</font> , <font color="#008000">'campaign.id'</font> , <font color="#008000">'campaign.name'</font> ) -&gt; </li><li>  dump ( <font color="#008000">'campaign'</font> ) -&gt; </li><li>  for_each_ad_group () -&gt; </li><li>  format ( <font color="#008000">"Ad group:% d,% s \ n"</font> , <font color="#008000">'ad_group.id'</font> , <font color="#008000">'ad_group.name'</font> ) -&gt; </li><li>  for_each_criteria () -&gt; </li><li>  format ( <font color="#008000">"Criteria:% d,% s \ n"</font> , <font color="#008000">'criteria.id'</font> , <font color="#008000">'criteria.text'</font> ) -&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  end-&gt; </li><li>  run_for (Service_Google_AdWords :: Client () -&gt; </li><li>  useragent ( <font color="#008000">'user agent'</font> ) -&gt; </li><li>  email ( <font color="#008000">'email@domain.com'</font> )); </li><li>  <font color="#cc6633">?&gt;</font> </li></ol></blockquote><br><br>  Of course, this approach should be used within reasonable limits, but sometimes it gives a very good result. </div><p>Source: <a href="https://habr.com/ru/post/82715/">https://habr.com/ru/post/82715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../82707/index.html">Travel capsule</a></li>
<li><a href="../82709/index.html">Generic Interfaces in Delphi</a></li>
<li><a href="../82711/index.html">Free paid software</a></li>
<li><a href="../82712/index.html">Specter is one of ten winners of student IGF 2010</a></li>
<li><a href="../82714/index.html">NTT DoCoMo is preparing a mobile phone with LTE</a></li>
<li><a href="../82716/index.html">Does Facebook create a PHP compiler?</a></li>
<li><a href="../82718/index.html">Smile to the world!</a></li>
<li><a href="../82719/index.html">New assembly Opera 10.50 (3218/8215/6204) from February 1</a></li>
<li><a href="../82720/index.html">Aerial view service interface</a></li>
<li><a href="../82721/index.html">Multitouch in Wacom interactive displays: a new evolution?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>