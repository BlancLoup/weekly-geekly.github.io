<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32F4 USB RNDIS driver (device control via web interface)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day, dear friends! 

 First of all, I would like to wish you all the best wishes on the past New Year holidays. 

 Earlier in the article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32F4 USB RNDIS driver (device control via web interface)</h1><div class="post__text post__text-html js-mediator-article">  Good time of day, dear friends! <br><br>  First of all, I would like to wish you all the best wishes on the past New Year holidays. <br><br>  Earlier <a href="http://habrahabr.ru/post/248097">in the article</a> was announced the development of RNDIS USB driver for STM32F4 series controllers.  Since then, the library has gradually evolved and has now grown to the first release version.  The library called LRNDIS (LWIP + RNDIS) allows us to create, on the basis of the STM32F4 controller, both a USB device of the ‚Äúmodem‚Äù class and any other devices that are controlled through a web interface.  An example of managing the stm32f4-discovery card from a web browser on an Android tablet is shown in the video: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/hsqWIqY8b6A%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhh_g5wxjadttW3CYgdto52Gz6_auQ" frameborder="0" allowfullscreen=""></iframe><br><br>  On the video page there is a link to the source codes and the HEX-file of the firmware for the discovery card, with which you can repeat this experiment.  The article describes how and when the technology of access via the WEB interface is useful, as well as how the LRNDIS library works for STM32F4 controllers.  Also there is a training material on the operation of USB and the device Ethernet-networks. <br><a name="habracut"></a><br>  <b>Prehistory of the library</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/2fe/f04/369/2fef04369c44c88a48da1ef2c03122bd.png" alt="image"><br><br>  The background of the project is very typical.  <s>It was a warm summer day.</s>  Ghm ... For the customer there was a task to develop a device with a service management interface. <br><br><div class="spoiler">  <b class="spoiler_title">Details</b> <div class="spoiler_text">  As the firmware was developed, several control commands for the VCP interface were entered.  This means that after connecting a USB device to the OS, a virtual COM port was created.  Using it, control and diagnostic commands were transmitted from the user terminal.  In response, the status of the device and its current state were received from the device. <br><br>  The system is quite typical from a service point of view: there is a serial port and a set of commands for control and diagnostics. <br><br>  Everything changed in a short time.  For objective reasons, the required set of commands has grown.  Interactivity of the output was also needed: some parameters became necessary to be displayed in dynamics.  As, for example, the testimony of a magnetic sensor when a ferromagnet is carried past it.  For this, additional commands were introduced, which, using <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D1%258F%25D1%258E%25D1%2589%25D0%25B8%25D0%25B5_%25D0%25BF%25D0%25BE%25D1%2581%25D0%25BB%25D0%25B5%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8_ANSI">control sequences</a> , printed information in the user terminal with high periodicity.  This created the necessary sense of real-time observation.  Interactive teams were so convenient for engineers that some of the teams were later added in accordance with the concept.  And then there was a crash.  It was necessary to support several teams at once: interactive, diagnostic, control commands.  In this case, periodic code refactoring was associated with time-consuming editing in a large number of processed commands.  It became clear that there still needs to be a user group of teams - for less qualified personnel who will simply follow the operating instructions.  For them, the idea of ‚Äã‚Äãwriting a client terminal with buttons and checkboxes arose ... And here doubts arose: it became clear that we are engaged in the service part, paying less attention to functionality!  But the user program running on the client computer must also have its own requirements: cross-platform and LTS (support duration). <br><br>  Suppose we‚Äôve finished the device, and we have to port and test the custom software with each version of the operating systems being released!  How long? <br><br>  So the question was born - how to get rid of additional labor costs? <br></div></div><br>  It was decided to use standards of guaranteed long-term support.  Those standards that will allow us to create a client device management program that will be supported by the fullest possible set of operating systems in the present and future tense.  In the first couple were found the flaws of popular cross-platform frameworks: <br>  - java: the need for a <a href="https://ru.wikipedia.org/wiki/Java_Virtual_Machine">JVM</a> OS, and the consequent assumption about the need to distribute a virtual machine <br>  - qt: the periodic need for <a href="http://habrahabr.ru/post/164721/">versioned porting</a> and launch <a href="http://www.linux.org.ru/forum/mobile/9806237">nuances</a> for Android. <br><br>  No, these difficulties should not scare.  The question, perhaps, is only in labor hours, which we sometimes underestimate, taking into account the factor of long-term support. <br><br>  So the idea was born to make a WEB-interface to control the device.  It does not require the development of third-party software, browsers to display the control page is in all required OS.  The interface design potential is huge.  The duration of support in terms of http / html / js standards is also beyond doubt. <br><br>  According to the plan, the management was supposed to work as follows. <br>  1. USB connected device represented by network card <br>  2. The client computer (PC or gadget) gets an IP address to work on the network of our device <br>  3. At the request of the web browser on the client computer, our device gives the page <br>  4. The page contains information on the current status and available controls. <br>  5. When the client activates the controls, the corresponding HTTP requests are transmitted from the browser. <br>  In fact, between the browser and the device, the same text commands go, but only in the format of the HTTP protocol. <br>  We must understand that this is just one of the options from a large set of possible solutions.  It has its pros and cons.  It so happened that now manufacturers use mostly network devices to use web-interfaces: setting up modems and routers.  The promise of this article - let's apply what is really convenient.  And let's not be afraid of difficulties on the way: overcoming them now will save us much more time in the future! <br><br>  <b>Library Scope</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c4a/cf6/9a7/c4acf69a7515138c294a5e5cee04351d.jpg" alt="image"><br><br>  Unfortunately, the first announcement was not fully successful, because  The story of the scope has been missed. <br>  Let's try to catch up a little and open this topic. <br>  If we are at the system design stage of the device, then the following considerations may lead us to use web interfaces (regardless of the physical channel, Ethernet or USB): <br>  1. The device must have a control and / or diagnostic interface <br>  2. Controls can be used not only at the development stage, but also at the operation stage (user software) <br>  3. User qualification may not be high enough, which requires a friendly management interface. <br>  4. The method of "friendly" management should be accessible from under different platforms and operating systems. <br>  5. Relevant funds need to be maintained for a long time. <br>  An additional criterion may be whether we initially develop a network device.  And also: would not (otherwise) the addition of a network stack and a web server to the firmware be redundant against the background of much less rich device functionality?  In other words, adding a web interface to a light bulb controller is obviously a redundant solution. <br><br>  If we believed in a web interface, the following considerations may help us in choosing a physical communication channel (from an Ethernet and USB perspective). <br><table><tbody><tr><td>  Type of </td><td>  In-Circuit Connection </td><td>  Typical application </td></tr><tr><td>  Ethernet </td><td>  Ethernet PHY controller </td><td>  - Industrial devices <br>  - Home appliances with network function and add.  nutrition </td></tr><tr><td>  USB </td><td>  ULPI controller or direct connection to the MK </td><td>  Household and part of industrial devices.  In particular, if: <br>  - devices do not have a guaranteed power source (battery power, for example) <br>  - devices potentially connected to the host only with a USB interface (for example, a tablet) <br>  - miniature device class <br></td></tr></tbody></table><br>  I'd add on my own - in spite of all the delights, I would not advise using USB in industrial hubs with the requirement of increased reliability: negative experience is often encountered.  If there is no alternative, then the issue of sustainability needs to be studied thoroughly. <br>  Based on the above points, it becomes clear the scope of the library: household and part of industrial devices, which: <br>  - work on the basis of MK STM32F4 <br>  - must have a friendly management interface <br>  - should be controlled from under different hardware and software set <br>  - may not have a guaranteed power source <br>  - must have a long period of management software support <br>  There are many possible examples of using technology even outside the realm of purely network devices. <br>  For example, at the moment there are plans to turn the stm32f4-discovery into an amateur development tool with the functions of a portable generator / signal analyzer and an oscilloscope.  Connect such an assistant to the phone and look in the dynamics of what is happening in the circuit of interest to you.  From free advantages - it is not required to build or install software;  it is enough to flash the HEX file and open the browser - all the charms of the GUI interface will be present in it.  In my picky taste - what you need.  Of course, the tool is not for professional development, but there is a known interest in it. <br><br>  So, I hope, understood.  And now about how the library works. <br><br>  <b>How does it work</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/f75/950/8af/f759508af0ccdb5dd2df5e634858e8fe.png" alt="image"><br><br>  When answering this question we will not be in a hurry.  A person who has little experience of interacting with networks can quite rightly be embarrassed.  Therefore, referring to one or another interaction protocol, I will also give its brief technical description at that level ... which I once lacked myself. <br><br>  <i>Step 1. Connect the USB device.</i> <br>  As mentioned earlier, at this stage our device says to the host ‚ÄúI am a network card!‚Äù. <br>  Host (i.e. client computer) after connecting our crafts to it, begins to send requests. <br><div class="spoiler">  <b class="spoiler_title">The host needs the following information.</b> <div class="spoiler_text">  - as the product is called <br>  - what is the product's VID and PID (manufacturer and product identifiers, <a href="">see list</a> ) <br>  - what <a href="http://www.usb.org/developers/defined_class">class and subclass</a> is the device <br>  - on which endpoint points and which blocks should be exchanged <br>  Well, and some other information.  Configuration packets are transmitted via endpoint 0. Response packets from the device with information about themselves are usually called ‚ÄúUSB device descriptors‚Äù. <br><br>  Read more about the survey process (enumeration) <a href="http://microsin.net/adminstuff/windows/how-usb-stack-enumerate-device.html">here</a> . <br><br>  In general, the USB protocol is quite rich ... sometimes it even seems to be redundant.  However, this wealth for many years now allows you to connect completely different devices, makes it possible to transfer isochronous streams, data blocks, interrupts.  In general, everything you need that may require a wide range of modern devices.  The flip side of the coin is a high threshold for entry into the development of USB devices. <br></div></div><br>  After receiving information about the device, the host OS searches for a suitable driver for interaction.  In a typical case, like flash-carriers (USB class MSC) or keyboard with a mouse (HID class), the standard driver for the class is loaded.  In a more "heavy" case, like our USB network card (CDC class with an RNDIS subclass), the operating system comes in discretion: <br>  - linux / android / mac OS, as a rule, successfully tries to establish a typical exchange <br>  - windows asks to install an external driver <br>  Our device in the first case works immediately. <br>  In the case of windows OS (later XP), you can install the <a href="http://developer.toradex.com/knowledge-base/how-to-install-microsoft-rndis-driver-for-windows-7">standard Microsoft driver</a> .  For Windows XP, you need to put the inf file that is available in <a href="https://github.com/fetisov/lrndis/tree/master/drivers">the LRNDIS library repository</a> . <br><br>  <i>Step 2. The driver initializes the RNDIS device.</i> <br>  This picture shows the principle of communication with the RNDIS device (Windows OS). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a5/164/1ca/7a51641ca06624a56f8d26d5ab5db264.png" alt="image"><br><br>  You can read more about it <a href="http://www.e-reading.club/chapter.php/89562/139/Russinovich,_Solomon_-_4.Vnutrennee_ustroiistvo_Windows_%2528gl._12-14%2529.html">here</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff569967%2528v%3Dvs.85%2529.aspx">there</a> . <br><br>  In short, the RNDIS protocol is an extension of NDIS for external devices.  The role of the protocol is to provide PnP support and network packet exchange.  In essence, RNDIS is an independent network interface, the information load of which is channel / network layer frames (Ethernet or IP frames, optional). <br><br>  In the diagram below, this implements the ‚ÄúMiniport Remote NDIS‚Äù cube, which is responsible for: <br>  - communication service (ask the network device for its MAC address, packet size, operation speed, etc.) <br>  - wraps network-sent host packets in the RNDIS header <br>  - transmits packets received from the device, discarding the RNDIS header <br>  The Miniport Remote NDIS USB cube is responsible for the transit of RNDIS parcels by working with the USB bus driver. <br>  On the side of the STM32 controller, the usbd_rndis_core.c file is responsible for supporting the RNDIS protocol and working with USB.  He does the same thing as the "cube" of the host "Miniport Remote NDIS" - deals with sticking / unstitching headers, and also answers driver questions.  Answers, such as the MAC address and speed, it takes from the <a href="">usbd_rndis_core.h</a> file. <br>  After successful initialization of RNDIS, the Windows driver creates a network interface, which is subsequently displayed in the "Network Control Center" and in the tray indicator area. <br><br>  <i>Step 3. Obtaining an IP Address</i> <br>  So, why do we need a service for obtaining a dynamic address?  This service is called <a href="https://ru.wikipedia.org/wiki/DHCP">DHCP</a> (Dynamic <a href="https://ru.wikipedia.org/wiki/DHCP">Host Configuration</a> Protocol). <br>  After the host initializes our device, it creates a network interface. <br><br><div class="spoiler">  <b class="spoiler_title">Network interface (if anyone knows)</b> <div class="spoiler_text">  A network interface is a software entity that provides access to physical or virtual network resources. <br>  Most often, each network interface host corresponds to a specific network adapter.  But there are many other interfaces, such as the local loop or those that are used to interact with the virtual machine.  In their case, in a signal form from the host "nothing comes out" - the exchange is programmed. <br><br>  Each host network interface must have at least one IP address associated with it.  According to it, "network residents" can refer to the host. <br><br>  If several networks are addressed ‚Äúon the wire‚Äù (for example, devices with IP addresses 10.4.1.xx and 192.168.1.xx), then the interface can be assigned two ‚Äúpersonal‚Äù IP addresses.  They may look like this: 10.4.1.151 and 192.168.1.200.  You can find out the set of network interfaces and their associated IP addresses in Windows OS using the ipconfig command and using ifconfig in Linux OS. <br><br>  A mask is used to describe networks / subnets.  For example, the correct description of the network 10.4.1.xx is: network 10.4.1.0, mask 255.255.255.0.  Or, if the 4-byte number of the mask is represented in binary form and the number of the leading units is calculated, then the value is 24. Then the network can be described as: 10.4.1.0/24. <br><br>  More information about this can be found in the relevant <a href="https://ru.wikipedia.org/wiki/IP-%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B5%25D1%2581">sources</a> . <br></div></div><br>  There are two main strategies for assigning an IP address to an interface: a static method (when the user enrolls an address to an interface) and a dynamic method (using a DHCP service). <br><br>  The last is that when creating an interface on the host, the DHCP client service is activated.  It begins sending broadcast packets using <a href="https://ru.wikipedia.org/wiki/UDP">UDP</a> to the network (the configuration of which is not yet known), in the hope that there is a DHCP server on the network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b66/d8a/ff6/b66d8aff638d818e09158fe528770c87.png" alt="image"><br><br>  The function of the DHCP server in general, and in particular on our controller, is to respond to the client.  In response, the controller ‚Äúsays‚Äù: client, you are in such and such a network, keep such and such an IP address, and we also have a <a href="https://ru.wikipedia.org/wiki/DNS-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580">DNS server</a> with such and such address. <br><br>  After that, the host ‚Äúfeels better‚Äù: it assigns the issued IP address to the interface and remembers the IP address of the DNS server. <br><br>  Initialization is over, now you can enter the name of the page (run.stm) in the host browser. <br><br>  It must be said that the behavior of the LRNDIS library is configurable.  The DHCP server service can be excluded from the assembly.  Then the host will have to register any address belonging to the range 192.168.7. (2-254).  Such a network is created by default.  Its parameters (192.168.7.0/24) are also configured.  In the example, the client is given addresses in the range 192.168.7.2 ... 192.168.7.4 with a leasing time of 24 hours. <br>  More details on the library settings can be found in the <a href="http://habrahabr.ru/post/248097">previous article</a> . <br><br>  <i>Step 4. Loading page</i> <br>  To download the page, the user can enter the address of our device <a href="http://192.168.7.1/">192.168.7.1</a> directly. <br>  However, remembering the numbers is not required, because  in addition to the DHCP server, it is possible to build a library with the support of a DNS server, the function of which is to resolve network names.  In the published example, the DNS server is trained to resolve the resource name ‚Äúrun.stm‚Äù. <br><br>  Therefore, if we write <a href="http://run.stm/">run.stm</a> in the browser, the host‚Äôs network service will send to our (and not only) DNS server a request in response to which the server will helpfully report: the domain name ‚Äúrun.stm‚Äù corresponds to the IP address <a href="http://192.168.7.1/">192.168.7.1</a> .  Next, the host browser at a known address will make a <a href="https://ru.wikipedia.org/wiki/TCP">TCP</a> connection in order to send an <a href="https://ru.wikipedia.org/wiki/HTTP">HTTP</a> request to get the root page. <br><br>  Request and response between the Firefox browser and the controller: <br><br><img src="https://habrastorage.org/files/0f6/a0f/e1a/0f6a0fe1ae26404bb4ff09dfd72136b7.PNG"><br><br>  Request history when loading the page: <br><br><img src="https://habrastorage.org/files/122/e2d/e34/122e2de34e8b44429ac5ea492e0ac5d2.PNG"><br><br>  From the history we see that, after loading the root HTML document, the browser also loads the other two files from the controller: discovery.svg and zepto.min.js.  The first is the image of the discovery board.  The SVG format is chosen, since, being an image of vector graphics, it occupies little space in the ROM of the microcontroller.  The script file zepto.min.js is included because  is a stripped-down counterpart of the famous <a href="https://ru.wikipedia.org/wiki/JQuery">JQUERY</a> .  It should be noted that there was no scrupulous saving of space in the ROM, because  in spite of the sacrifice of 35 Kb for all static resources, the memory of the controller is still quite enough.  In addition, this size with a further increase in the complexity of the interface promises to grow much slower.  If the interface has grown significantly - there is always a way to store and distribute static resources in compressed form - all known browsers currently support decompression on the fly. <br><br>  Another request that the browser sends is the /state.cgi request.  It is formed by the script from the root HTML-document with a frequency of 5 times per second.  We need a request to obtain the dynamics of the current state of the device. <br>  When receiving this request, the controller generates and responds with the following line in <a href="https://ru.wikipedia.org/wiki/JSON">JSON</a> format: <br><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"systick"</span></span>: <span class="hljs-number"><span class="hljs-number">9528746</span></span>, <span class="hljs-string"><span class="hljs-string">"button"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"acc"</span></span>: [<span class="hljs-number"><span class="hljs-number">54</span></span>, <span class="hljs-number"><span class="hljs-number">-288</span></span>, <span class="hljs-number"><span class="hljs-number">936</span></span>], <span class="hljs-string"><span class="hljs-string">"leds"</span></span>: { <span class="hljs-string"><span class="hljs-string">"g"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"o"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } }</code> </pre> <br>  It contains all the data about the current state of the device, which are subsequently displayed on the page using JavaScript code. <br><br>  Well, and perhaps the last moment in communicating with the browser - a way to control. <br><br>  In the example, three LEDs are controlled.  For example, when you click on the red LED flag with JavaScript tools, an HTTP GET request is sent with the ‚Äúr‚Äù parameter and the value 0 or 1. The complete request looks like this: /ctl.cgi?r=1 <br><br>  In this or alternative ways, you can send any data set, whether it is a logical 0/1 state, or a text field value, or a push button notification.  The beauty of the approach lies in the fact that the program logic may not be aware of the controls at all, because it receives strictly formalized control messages.  You can also change and debug the interface part (HTML + JS) locally with all conveniences, and then upload it once to the controller as part of the firmware.  Local web-development, which is important, can be handled by the appropriate specialist. <br><br>  <b>About the LWIP stack</b> <br>  No network exchange would have been possible if it were not for this network stack, which was built into the library. <br>  Since the library works under the ‚Äúbare‚Äù hardware (without the OS and dynamic memory allocation), the add-in in the form of sockets is not available for use.  Writing network applications therefore occurs using the raw stack API.  Fortunately, there is a lot of <a href="http://lwip.wikia.com/wiki/Raw/TCP">information</a> on this topic. <br><br>  Also in the package of contributions there are many ready-made solutions.  Including from there and was used HTTP-server. <br><br>  In the last article I gave a brief description of the stack and its settings.  At the moment, the set of important definitions for the stack in the file has been clarified: <br><br><div class="spoiler">  <b class="spoiler_title">lwipopts.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NO_SYS 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEM_ALIGNMENT 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_RAW 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_NETCONN 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_SOCKET 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_DHCP 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_ICMP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_UDP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_TCP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_PAD_SIZE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_IP_ACCEPT_UDP_PORT(p) ((p) == PP_NTOHS(67)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEM_SIZE 10000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCP_MSS (1500 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*mtu*/</span></span></span><span class="hljs-meta"> - 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*iphdr*/</span></span></span><span class="hljs-meta"> - 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*tcphhr*/</span></span></span><span class="hljs-meta">) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCP_SND_BUF (2 * TCP_MSS) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETHARP_SUPPORT_STATIC_ENTRIES 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_HTTPD_CGI 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_HTTPD_SSI 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_HTTPD_SSI_INCLUDE_TAG 0</span></span></code> </pre></div></div><br>  Also the problem with mem_malloc was solved.  Although the current firmware version does not use dynamic allocation, the hardware crash kept a watchful when calling mem_malloc.  It was resolved by adding the definition of MEM_ALIGNMENT, which was previously ignored. <br><br>  For the same reason, the HTTP-server supported by the community has steadily earned, which prompted them to abandon plans to create their own. <br><br>  <b>Unsolved Issues</b> <br>  1. Newns relicensing stack lwip, which may have its own conditions for inclusion in the other software; <br>  2. Refinement of the DNS server for processing "multi-query" packets; <br><br>  <b>Instead of conclusion</b> <br>  I thank the reader for his patience and hope that this article will be useful to him.  The source code <a href="https://github.com/fetisov/lrndis">library LRNDIS</a> is available for use under the MIT license.  I think it is wonderful if the work, for which considerable time and spare time was devoted, will be useful to someone else.  At worst, without the use of open libraries, this would not have been possible. <br><br>  The library is currently planned to be supported, therefore you can contact the e-mail address fsenok@gmail.com for questions. </div><p>Source: <a href="https://habr.com/ru/post/274663/">https://habr.com/ru/post/274663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274645/index.html">"Other" logic and reversible calculations</a></li>
<li><a href="../274649/index.html">Interview: Cryptocurrency DASH - current and future</a></li>
<li><a href="../274651/index.html">How via composer it is convenient to replace the system package with an alternative version</a></li>
<li><a href="../274655/index.html">Putting together a simple MariontteJS + ES6 application using Brunch</a></li>
<li><a href="../274659/index.html">PostgreSQL 9.5 Released: UPSERT, RLS and Big Data</a></li>
<li><a href="../274665/index.html">About excitement in the minds</a></li>
<li><a href="../274667/index.html">Selection: 115 useful mailing lists about technologies that you should subscribe to</a></li>
<li><a href="../274671/index.html">Sociology of Algorithms: How Financial Markets and High Frequency Trading are Connected (Part 2)</a></li>
<li><a href="../274675/index.html">What is RESTful in reality?</a></li>
<li><a href="../274677/index.html">Software Internet gateway for a small company (Shorewall, OpenVPN, OSPF). Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>