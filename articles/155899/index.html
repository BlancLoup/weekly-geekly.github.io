<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Indication of the DnD mode on the BLF key in Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DnD is a rather demanded function, but usually the mode is turned on on the phone itself, without notifying Asterisk about it, which will call the use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Indication of the DnD mode on the BLF key in Asterisk</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/589/69c/556/58969c5561e58f95af36f105d5f494b8.jpg" alt="image"><br>  DnD is a rather demanded function, but usually the mode is turned on on the phone itself, without notifying Asterisk about it, which will call the user‚Äôs phone, thinking that it‚Äôs in place and ready to answer the call.  How do we turn on the DnD mode on Asterisk itself and so that the power button with the activated DnD blinked in red? <br>  To do this, we need a phone with BLF buttons and a couple of macros.  Checked on IP phones <a href="http://xtelekom.ru/sip_ip_phone/sip_ip_phone_grandstream">Grandstream GXP</a> series, a variety.  The server is Linux with Elastix, well, you can just <a href="http://xtelekom.ru/asterisk">Asterisk 1.6+</a> . <a name="habracut"></a><br><br>  <i>Attention!</i>  <i>On some phones, a firmware update is required for the BLF keys to work correctly.</i> <br><br>  1. Create macros in /etc/asterisk/extensions_override_freepbx.conf.  It is of course connected in extensions.conf. <br>  Macro text: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">[ext-dnd-hints] exten =&gt; *761000,1,Goto(app-dnd-toggle,*76,1) exten =&gt; *761000,hint,Custom:DEVDND1000</code> </pre> <br><br>  This macro contains phone numbers to be monitored, in the example extension 1000 is indicated. * 76 is this feature code. <br>  By analogy, you need to create entries for each number that needs the DnD function. <br><br><pre> <code class="bash hljs">[app-dnd-toggle] include =&gt; app-dnd-toggle-custom exten =&gt; *76,1,Answer exten =&gt; *76,n,Wait(1) exten =&gt; *76,n,Macro(user-callerid,) exten =&gt; *76,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB(DND/${AMPUSER}</span></span></span><span class="hljs-string">)}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?activate:deactivate) exten =&gt; *76,n(activate),Set(DB(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=YES) exten =&gt; *76,n,Set(STATE=RINGING) exten =&gt; *76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; *76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;activated) exten =&gt; *76,n,Macro(hangupcall,) exten =&gt; *76,n(deactivate),dbDel(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>) exten =&gt; *76,n,Set(STATE=NOT_INUSE) exten =&gt; *76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; *76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;de-activated) exten =&gt; *76,n,Macro(hangupcall,) exten =&gt; sstate,1,Set(DEVICE_STATE(Custom:DND<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(DEVICES=<span class="hljs-variable"><span class="hljs-variable">${DB(AMPUSER/${AMPUSER}</span></span>/device)}) exten =&gt; sstate,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEVICES}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> ]?<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) exten =&gt; sstate,n,Set(LOOPCNT=<span class="hljs-variable"><span class="hljs-variable">${FIELDQTY(DEVICES,&amp;)}</span></span>) exten =&gt; sstate,n,Set(ITER=1) exten =&gt; sstate,n(begin),Set(DEVICE_STATE(Custom:DEVDND<span class="hljs-variable"><span class="hljs-variable">${CUT(DEVICES,&amp;,${ITER}</span></span>)})=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(ITER=$[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> + 1]) exten =&gt; sstate,n,GotoIf($[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> &lt;= <span class="hljs-variable"><span class="hljs-variable">${LOOPCNT}</span></span>]?begin) exten =&gt; sstate,n(<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>),Return()</code> </pre><br><br>  This is the macro itself that switches states; nothing needs to be changed here. <br><br>  2. We include ext-dnd-hints in the context we need, for example: <br><br><pre> <code class="bash hljs">[from-internal] include =&gt; ext-dnd-hints exten =&gt; h,1,Hangup</code> </pre><br><br>  Be careful here, you need to specify all contexts that come from from-internal, otherwise they will stop working. <br><br>  3. Set up a key on the phone: register the number * 761000 on it and turn on the BLF mode.  If the BLF mode does not work, read the text in italics at the beginning of the topic. <br><br>  4. In the CLI, we do dialplan reload and check whether our hint has appeared.  In normal mode, the view will be as follows: <br><br><pre> <code class="bash hljs">xtelekom*CLI&gt; core show hint *761000 *761000@ext-dnd-hints : Custom:DEVDND1000 State:Idle Watchers 1</code> </pre><br><br>  If the phone does not request DnD status, then Watchers will be equal to 0. <br><br>  Some phones with an unavailable BLF (blinking red) when calling, add ** more to the number, in which case the number is obtained like *** 761000.  For this variant to work, the macro is slightly different, I will place it under the spoiler, because it repeats the first macro: <br><div class="spoiler">  <b class="spoiler_title">Another macro</b> <div class="spoiler_text"><pre> <code class="bash hljs">[ext-dnd-hints] exten =&gt; *761000,1,Goto(app-dnd-toggle,*76,1) exten =&gt; ***761000,1,Goto(app-dnd-toggle,***76,1) exten =&gt; *761000,hint,Custom:DEVDND1000 [app-dnd-toggle] include =&gt; app-dnd-toggle-custom exten =&gt; *76,1,Answer exten =&gt; *76,n,Wait(1) exten =&gt; *76,n,Macro(user-callerid,) exten =&gt; *76,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB(DND/${AMPUSER}</span></span></span><span class="hljs-string">)}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?activate:deactivate) exten =&gt; *76,n(activate),Set(DB(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=YES) exten =&gt; *76,n,Set(STATE=RINGING) exten =&gt; *76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; *76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;activated) exten =&gt; *76,n,Macro(hangupcall,) exten =&gt; *76,n(deactivate),dbDel(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>) exten =&gt; *76,n,Set(STATE=NOT_INUSE) exten =&gt; *76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; *76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;de-activated) exten =&gt; *76,n,Macro(hangupcall,) exten =&gt; sstate,1,Set(DEVICE_STATE(Custom:DND<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(DEVICES=<span class="hljs-variable"><span class="hljs-variable">${DB(AMPUSER/${AMPUSER}</span></span>/device)}) exten =&gt; sstate,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEVICES}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> ]?<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) exten =&gt; sstate,n,Set(LOOPCNT=<span class="hljs-variable"><span class="hljs-variable">${FIELDQTY(DEVICES,&amp;)}</span></span>) exten =&gt; sstate,n,Set(ITER=1) exten =&gt; sstate,n(begin),Set(DEVICE_STATE(Custom:DEVDND<span class="hljs-variable"><span class="hljs-variable">${CUT(DEVICES,&amp;,${ITER}</span></span>)})=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(ITER=$[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> + 1]) exten =&gt; sstate,n,GotoIf($[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> &lt;= <span class="hljs-variable"><span class="hljs-variable">${LOOPCNT}</span></span>]?begin) exten =&gt; sstate,n(<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>),Return() exten =&gt; ***76,1,Answer exten =&gt; ***76,n,Wait(1) exten =&gt; ***76,n,Macro(user-callerid,) exten =&gt; ***76,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB(DND/${AMPUSER}</span></span></span><span class="hljs-string">)}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?activate:deactivate) exten =&gt; ***76,n(activate),Set(DB(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=YES) exten =&gt; ***76,n,Set(STATE=) exten =&gt; ***76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; ***76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;activated) exten =&gt; ***76,n,Macro(hangupcall,) exten =&gt; ***76,n(deactivate),dbDel(DND/<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>) exten =&gt; ***76,n,Set(STATE=UNAVAILABLE) exten =&gt; ***76,n,Gosub(app-dnd-toggle,sstate,1) exten =&gt; ***76,n,Playback(<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-not-disturb&amp;de-activated) exten =&gt; ***76,n,Macro(hangupcall,) exten =&gt; sstate,1,Set(DEVICE_STATE(Custom:DND<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>)=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(DEVICES=<span class="hljs-variable"><span class="hljs-variable">${DB(AMPUSER/${AMPUSER}</span></span>/device)}) exten =&gt; sstate,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEVICES}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> ]?<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>) exten =&gt; sstate,n,Set(LOOPCNT=<span class="hljs-variable"><span class="hljs-variable">${FIELDQTY(DEVICES,&amp;)}</span></span>) exten =&gt; sstate,n,Set(ITER=1) exten =&gt; sstate,n(begin),Set(DEVICE_STATE(Custom:DEVDND<span class="hljs-variable"><span class="hljs-variable">${CUT(DEVICES,&amp;,${ITER}</span></span>)})=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) exten =&gt; sstate,n,Set(ITER=$[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> + 1]) exten =&gt; sstate,n,GotoIf($[<span class="hljs-variable"><span class="hljs-variable">${ITER}</span></span> &lt;= <span class="hljs-variable"><span class="hljs-variable">${LOOPCNT}</span></span>]?begin) exten =&gt; sstate,n(<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>),Return()</code> </pre><br></div></div><br><br>  Next time I‚Äôll tell you how to monitor the status of the queue in the same way. <br><br>  PS Sometimes on the grandstream you need to restart the phone, otherwise the button does not work correctly. </div><p>Source: <a href="https://habr.com/ru/post/155899/">https://habr.com/ru/post/155899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155883/index.html">Network infrastructure of RTLS systems</a></li>
<li><a href="../155885/index.html">New file system for Samsung flash drives and performance comparison</a></li>
<li><a href="../155893/index.html">In Britain, continue to close access to "pirated" sites</a></li>
<li><a href="../155895/index.html">Matrix: Reboot: Flurry new application engagement report</a></li>
<li><a href="../155897/index.html">UG007: mini-PC with Bluetooth, dual-core processor and Android 4.1.1 for 60 cu.</a></li>
<li><a href="../155905/index.html">Learning English with LinguaLeo is now possible on Android!</a></li>
<li><a href="../155909/index.html">history of the company</a></li>
<li><a href="../155917/index.html">Runetology (170): Arseny Tarasov, Head of Adobe Russia</a></li>
<li><a href="../155921/index.html">Complete Guide: Tools and Methods for Data Migration to Windows Azure SQL Database</a></li>
<li><a href="../155923/index.html">Programs as works of art‚ÄΩ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>