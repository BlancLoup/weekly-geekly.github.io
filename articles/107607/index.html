<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Here be dragons: Memory management in Windows as it is [2/3]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Catalog: 
 One 
 Two 
 Three 

 It turns out long opuses need to be broken. And I thought ‚Äúmulti-part‚Äù topics are published exclusively for earning a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Here be dragons: Memory management in Windows as it is [2/3]</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/5a77eed8/f911ab64/76fa7131/e11d1a7d.jpg"><br>  Catalog: <br>  <a href="http://habrahabr.ru/blogs/windows7/107605/">One</a> <br>  <a href="http://habrahabr.ru/blogs/windows7/107607/">Two</a> <br>  <a href="http://habrahabr.ru/blogs/windows7/107637/">Three</a> <br><br>  It turns out long opuses need to be broken.  And I thought ‚Äúmulti-part‚Äù topics are published exclusively for earning a rating :-) <br><br>  I will continue right off the bat, as where it‚Äôs broken it‚Äôs broken there, and to write additional introductions to each episode above my powers. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is a little about how pages get from working sets to these lists. <br>  Fall in different ways.  One has already been considered: someone explicitly called the EmptyWorkingSet for the process.  This happens infrequently.  Usually this happens with the help of the so-called trimming (trimming). <br><br>  When the system approaches one of the established limits for free memory, it begins to free this memory.  First, the system finds the processes that maximally exceed their limit on the size of the working set.  For these processes, the process of ‚Äúaging‚Äù of the pages (aging) is launched, to determine which of the pages is the least used.  After that, the oldest pages are ‚Äútrimmed‚Äù in the standby or modified list. <br><br>  From the same lecture: <br><img src="https://habrastorage.org/storage/4d4009e9/c64f1796/af734a5d/d78cad10.png"><br><br>  The diagram shows another Delete page, which happens when the application simply releases the allocated memory - you simply can't do anything with the contents of these pages, because according to all the rules it is not valid and even if the new memory is allocated to the same address - it should be new memory. <br><br><h4>  Pagefile </h4><br>  Finally, I got to everyone's favorite swap file.  Dragons are found here just herds.  Well, let's try to get them out. <br><br>  Myth: To improve performance, you need to reduce the number of calls to the page file. <br>  In fact: To improve performance, you need to reduce the number of calls to the DISK.  Pagefile is almost the same file as the rest. <br><br>  Myth: Winda uses a paging file, even if the free memory is still full. <br>  Actually: The page file can be accessed only from the modified list.  In modified list - when trimming rarely used pages in overgrown applications.  After the page is reset, it remains on the standby list and will not be reread.  Memory is never taken from the standby list if there is still free or zeroed (that is, cached data is never thrown away, if there are still pages with no data at all).  The standby list has 8 priority levels (which, to some extent, can be managed both by the application itself and by Superfetch, which dynamically manages page priorities based on an analysis of the actual use of files / pages), if there is no choice whatsoever - the first thing the Windows throws out the lowest cache priority. <br>  Here is an example of a half-hour job in normal mode: <br><img src="https://habrastorage.org/storage/4a458e2a/fbfba072/53d2bad8/fba847c6.png"><br>  Please note that the files are sorted by name and pagefile.sys would have to be between kernel.etl and ‚ÄúProgram Files‚Äù. <br><br>  Myth: But Windows itself admits that it uses a paging file. <br>  In fact: As discussed above.  Most often it is about Commit Charge, which can be called ‚Äúuse‚Äù, but not at all in the sense in which it is commonly understood.  In most cases, if there is no need, private pages (to be dropped into a paging file) will sit on the modified list (even if they get there) for almost indefinitely long periods. <br><br>  Myth: Disabling a page file improves system performance. <br>  In fact: In rare cases, an application that misuses memory and does not lower the page priority for its threads can lead to a decrease in responsiveness, but in most cases, productivity is only enhanced by unloading unused ‚Äújunk‚Äù into the closet and using the free storage space. more relevant data (thereby reducing the total number of disk accesses). <br><br><h4>  Memory and I / O Priorities </h4><br>  The lower the I / O priority of the stream that performs writing / reading, the less it interferes with normal operation (in general, as with the priority of flows, the round robin algorithm is used for operations that expect the highest priority, while a small part of the bandwidth is given to operations with low priority in order to combat starvation - it‚Äôs not fully translated into Russian).  Run the built-in defragmenter.  Resource Monitor will show 100% of the disk load, but the system at the same time, if it loses responsiveness, then I can‚Äôt notice it by eye. <br>  I already mentioned memory priorities.  Regardless of the i / o priority, there is a page priority (Page Priority).  Each physical page in the system (or more precisely, the data it contains at each time point) takes precedence.  When a page is moved to the Standby list, it falls into one of eight separate lists corresponding to its priority.  Data with a higher priority cannot be replaced with data with a lower one. <br><br><h4>  Prefetch and Superfetch </h4><br>  Prefetch appeared in XP and is a way to speed up the launch of applications.  <a href="http://www.nirsoft.net/utils/win_prefetch_view.html">Here is a utility</a> that allows you to view the contents of pf files.  As a matter of fact, there are the names and offsets of files to which the corresponding application refers in the first few (it seems 10) seconds after launch.  Since the launch is often accompanied by a frantic reading of data from the disk, the ordering of these readings reduces the number of head seek and thereby speeds up the launch.  Works from the SysMain service.  In addition to prefetch and superfetch, this service is also responsible for ReadyBoot (which helped speed up loading in one of the previous posts), ReadyBoost (a pretty pretty useless thing on systems with a lot of RAM, but very useful on low-end systems) and ReadyDrive (this is ReadyBoost, but with the guarantee that the ‚Äúflash drive‚Äù will not be removed between reboots - it allows you to greatly speed up the basic operations without resorting to a complete replacement of HDD with SSD - using so-called hybrid or <a href="http://en.wikipedia.org/wiki/Hybrid_HDD">H-HDD</a> : SSD speed at HDD price). <br><br>  With superfetchem, things are a bit more complicated.  Few people understand its purpose, but everyone tries to blame this service for using memory during Idle and for reading ‚Äúsomething else‚Äù from the disk.  To start reading: <br><img src="https://habrastorage.org/storage/5a5519ba/1656d422/676aee2a/21640112.png"><br>  It is carried out with background priority and almost imperceptibly when used.  If the blinking LED is annoying - it can be sealed with tape.  Moreover, this reading loads the cache with the necessary data (you can look at the increase in standby after loading / waking up, even though the user does not perform any active disk operations).  This data is now loaded with a low priority and with a good ordering, then it will save a few seconds and crazy head movement at the start of an application.  This is most often about loading data to 6-7 priority levels (yes, low priority I / O operations are used to load pages into Standby high levels), which can be pushed out only in the most extreme case when there is not enough memory for what. <br><br>  Memory this service uses to store the history of disk access / memory pages.  Periodically (in Idle) he allocates more in order to analyze this data and build a long-term plan of action (as well as a bootplan for the next download).  In addition, it produces a dynamic redistribution of page priorities.  For example, what happens on my home machine, on which I often use a dotnet (in the form of powershell): <br><img src="https://habrastorage.org/storage/31038e46/1e51620e/e3d22c6b/3f3e7cc9.png"><br>  There, the list presents pages with priorities from 1 to 6 (7 is a special priority that never changes).  But the newly installed virtual machine, where powershell was run once in its life a few seconds before: <br><img src="https://habrastorage.org/storage/f61b6c1e/02549ca4/0ff1b7a3/32334414.png"><br>  The superfetch does not yet know what to do with this file, so all pages have reached the level corresponding to the priority of the thread that downloaded this file.  And this is how the cache of the same file looks on the same virtual machine after several hours of inactivity (just the window minimized in the taskbar): <br><img src="https://habrastorage.org/storage/5724f8c0/83cab900/b90b611d/37637fb7.png"><br>  It is seen that all pages have lowered their priority. <br><br><h4>  Copy large files </h4><br>  Everything is simple here.  We start copying isoshnika.  We see that copying is done with normal I / O priority: <br><img src="https://habrastorage.org/storage/51d792b7/ff8f10fe/72f61156/dbf546bc.png"><br>  I did not save the Page priority stream, but I can say with a high degree of confidence that there is also a ‚Äúnorm‚Äù - that is, 5. Does this mean that copying files sooner or later throws everyone else out of the cache?  Check: <br><img src="https://habrastorage.org/storage/754e6917/31989e8d/86323847/714abf6c.png"><br>  Everything was cached with priority 2 even though reading was done with priority 5. What's the matter?  And here's what: <br><img src="https://habrastorage.org/storage/d3162a57/de427043/c192384d/62f807b0.png"><br><br>  For copy operations, the FILE_FLAG_SEQUENTIAL_SCAN flag is used, which leads to a decrease in cache priority compared to the base one, to using only one VACB for caching and to a more aggressive read-ahead. </div><p>Source: <a href="https://habr.com/ru/post/107607/">https://habr.com/ru/post/107607/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107598/index.html">The tale of how I put an unsupported Wimax / Wifi card in Lenovo X201</a></li>
<li><a href="../107601/index.html">Another open source from Google: Project Szl</a></li>
<li><a href="../107603/index.html">Data model visualization</a></li>
<li><a href="../107605/index.html">Here be dragons: Memory management in Windows as it is [1/3]</a></li>
<li><a href="../107606/index.html">We watch full-screen flash video on the second monitor, we work on the first</a></li>
<li><a href="../107608/index.html">Nabbber.com - we learn foreign words together</a></li>
<li><a href="../107609/index.html">Published source codes F # 2.0 under license Apache 2.0</a></li>
<li><a href="../107613/index.html">Belarusian life :) first in the country started selling Android tablets</a></li>
<li><a href="../107614/index.html">War for the social graph</a></li>
<li><a href="../107619/index.html">Canobuvosti, 64th edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>