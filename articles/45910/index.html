<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP, PREG and UTF-8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post we will discuss the work of PHP5 with multibyte strings by means of preg _ * () functions. 

 I noticed an interesting state of affairs, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP, PREG and UTF-8</h1><div class="post__text post__text-html js-mediator-article">  In this post we will discuss the work of PHP5 with multibyte strings by means of preg _ * () functions. <br><br>  I noticed an interesting state of affairs, in general, something long ago described on the Internet, but still relevant to this day (the question has surfaced due to a recent <a href="http://habrahabr.ru/blogs/php/45886/">post about trim ()</a> ). <br><a name="habracut"></a><br>  For example, here‚Äôs a small script: <br><br><blockquote><code><font color="#000000"><font color="#0000BB">&lt;?&lt;br&gt;    &lt;br&gt;</font> <font color="#007700">print</font> <font color="#DD0000">": "</font> <font color="#007700">.</font> <font color="#0000BB">setLocale</font> <font color="#007700">(</font> <font color="#0000BB">LC_ALL</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">) .</font> <font color="#DD0000">"\n"</font> <font color="#007700">;&lt;br&gt;    &lt;br&gt;</font> <font color="#FF8000">/**&lt;br&gt;     *    preg_match_all&lt;br&gt;     * @param string $comment  &lt;br&gt;     * @param string $pattern    preg_match_all&lt;br&gt;     * @param bool   $usePatch   &lt;br&gt;     * @return void&lt;br&gt;     */&lt;br&gt;    &lt;br&gt;</font> <font color="#007700">function</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#0000BB">$comment</font> <font color="#007700">,</font> <font color="#0000BB">$pattern</font> <font color="#007700">,</font> <font color="#0000BB">$usePatch</font> <font color="#007700">=</font> <font color="#0000BB">false</font> <font color="#007700">) {&lt;br&gt;        &lt;br&gt;</font> <font color="#0000BB">$test</font> <font color="#007700">=</font> <font color="#DD0000">"one   three"</font> <font color="#007700">;&lt;br&gt;        &lt;br&gt;        print</font> <font color="#DD0000">"\n&lt;strong&gt;{$comment}:&lt;/strong&gt; &lt;u&gt;{$pattern}&lt;/u&gt;\n"</font> <font color="#007700">;&lt;br&gt;        &lt;br&gt;        if (</font> <font color="#0000BB">$usePatch</font> <font color="#007700">)</font> <font color="#0000BB">mb_preg_match_all</font> <font color="#007700">(</font> <font color="#0000BB">$pattern</font> <font color="#007700">,</font> <font color="#0000BB">$test</font> <font color="#007700">,</font> <font color="#0000BB">$matches</font> <font color="#007700">,</font> <font color="#0000BB">PREG_OFFSET_CAPTURE</font> <font color="#007700">);&lt;br&gt;        else</font> <font color="#0000BB">preg_match_all</font> <font color="#007700">(</font> <font color="#0000BB">$pattern</font> <font color="#007700">,</font> <font color="#0000BB">$test</font> <font color="#007700">,</font> <font color="#0000BB">$matches</font> <font color="#007700">,</font> <font color="#0000BB">PREG_OFFSET_CAPTURE</font> <font color="#007700">);&lt;br&gt;        &lt;br&gt;        foreach (</font> <font color="#0000BB">$matches</font> <font color="#007700">[</font> <font color="#0000BB">0</font> <font color="#007700">] as</font> <font color="#0000BB">$v</font> <font color="#007700">) print</font> <font color="#DD0000">"  : ¬´{$v[0]}¬ª, : {$v[1]}\n"</font> <font color="#007700">;&lt;br&gt;        &lt;br&gt;    }&lt;br&gt;    &lt;br&gt;</font> <font color="#FF8000">/**&lt;br&gt;     *      ,    &lt;br&gt;     */&lt;br&gt;    &lt;br&gt;</font> <font color="#007700">function</font> <font color="#0000BB">mb_preg_match_all</font> <font color="#007700">(&lt;br&gt;</font> <font color="#0000BB">$ps_pattern</font> <font color="#007700">,&lt;br&gt;</font> <font color="#0000BB">$ps_subject</font> <font color="#007700">,&lt;br&gt;        &amp;</font> <font color="#0000BB">$pa_matches</font> <font color="#007700">,&lt;br&gt;</font> <font color="#0000BB">$pn_flags</font> <font color="#007700">=</font> <font color="#0000BB">PREG_PATTERN_ORDER</font> <font color="#007700">,&lt;br&gt;</font> <font color="#0000BB">$pn_offset</font> <font color="#007700">=</font> <font color="#0000BB">0</font> <font color="#007700">,&lt;br&gt;</font> <font color="#0000BB">$ps_encoding</font> <font color="#007700">=</font> <font color="#0000BB">NULL&lt;br&gt;</font> <font color="#007700">) {&lt;br&gt;        &lt;br&gt;</font> <font color="#FF8000">// WARNING! - All this function does is to correct offsets, nothing else:&lt;br&gt;        //(code is independent of PREG_PATTER_ORDER / PREG_SET_ORDER)&lt;br&gt;        &lt;br&gt;</font> <font color="#007700">if (</font> <font color="#0000BB">is_null</font> <font color="#007700">(</font> <font color="#0000BB">$ps_encoding</font> <font color="#007700">))</font> <font color="#0000BB">$ps_encoding</font> <font color="#007700">=</font> <font color="#0000BB">mb_internal_encoding</font> <font color="#007700">();&lt;br&gt;        &lt;br&gt;</font> <font color="#0000BB">$pn_offset</font> <font color="#007700">=</font> <font color="#0000BB">strlen</font> <font color="#007700">(</font> <font color="#0000BB">mb_substr</font> <font color="#007700">(</font> <font color="#0000BB">$ps_subject</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">,</font> <font color="#0000BB">$pn_offset</font> <font color="#007700">,</font> <font color="#0000BB">$ps_encoding</font> <font color="#007700">));&lt;br&gt;</font> <font color="#0000BB">$ret</font> <font color="#007700">=</font> <font color="#0000BB">preg_match_all</font> <font color="#007700">(</font> <font color="#0000BB">$ps_pattern</font> <font color="#007700">,</font> <font color="#0000BB">$ps_subject</font> <font color="#007700">,</font> <font color="#0000BB">$pa_matches</font> <font color="#007700">,</font> <font color="#0000BB">$pn_flags</font> <font color="#007700">,</font> <font color="#0000BB">$pn_offset</font> <font color="#007700">);&lt;br&gt;        &lt;br&gt;        if (</font> <font color="#0000BB">$ret</font> <font color="#007700">&amp;&amp; (</font> <font color="#0000BB">$pn_flags</font> <font color="#007700">&amp;</font> <font color="#0000BB">PREG_OFFSET_CAPTURE</font> <font color="#007700">))&lt;br&gt;            foreach(</font> <font color="#0000BB">$pa_matches</font> <font color="#007700">as &amp;</font> <font color="#0000BB">$ha_match</font> <font color="#007700">)&lt;br&gt;                foreach(</font> <font color="#0000BB">$ha_match</font> <font color="#007700">as &amp;</font> <font color="#0000BB">$ha_match</font> <font color="#007700">)&lt;br&gt;</font> <font color="#0000BB">$ha_match</font> <font color="#007700">[</font> <font color="#0000BB">1</font> <font color="#007700">] =</font> <font color="#0000BB">mb_strlen</font> <font color="#007700">(</font> <font color="#0000BB">substr</font> <font color="#007700">(</font> <font color="#0000BB">$ps_subject</font> <font color="#007700">,</font> <font color="#0000BB">0</font> <font color="#007700">,</font> <font color="#0000BB">$ha_match</font> <font color="#007700">[</font> <font color="#0000BB">1</font> <font color="#007700">]),</font> <font color="#0000BB">$ps_encoding</font> <font color="#007700">);&lt;br&gt;        &lt;br&gt;        return</font> <font color="#0000BB">$ret</font> <font color="#007700">;&lt;br&gt;        &lt;br&gt;    }&lt;br&gt;    &lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">"¬´ ¬ª"</font> <font color="#007700">,</font> <font color="#DD0000">"/[\w]+/i"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">"Character range"</font> <font color="#007700">,</font> <font color="#DD0000">"/[-a-z]+/i"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">"¬´ ¬ª   ¬´/u¬ª"</font> <font color="#007700">,</font> <font color="#DD0000">"/[\w]+/ui"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">"Character range   ¬´/u¬ª"</font> <font color="#007700">,</font> <font color="#DD0000">"/[-a-z]+/ui"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">" ¬´\pL¬ª,    ¬´/u¬ª"</font> <font color="#007700">,</font> <font color="#DD0000">"/[\pL]+/i"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">" ¬´\p{Cyrillic}¬ª,    ¬´/u¬ª"</font> <font color="#007700">,</font> <font color="#DD0000">"/[\p{Cyrillic}]+/i"</font> <font color="#007700">);&lt;br&gt;</font> <font color="#0000BB">preg_test</font> <font color="#007700">(</font> <font color="#DD0000">"(!)  ¬´\pL¬ª  "</font> <font color="#007700">,</font> <font color="#DD0000">"/[\pL]+/i"</font> <font color="#007700">,</font> <font color="#0000BB">true</font> <font color="#007700">);&lt;br&gt;    &lt;br&gt;</font> <font color="#0000BB">$source</font> <font color="#007700">=</font> <font color="#0000BB">highlight_file</font> <font color="#007700">(</font> <font color="#0000BB">__FILE__</font> <font color="#007700">,</font> <font color="#0000BB">true</font> <font color="#007700">);&lt;br&gt;    &lt;br&gt;</font> <font color="#0000BB">?&gt;</font></font></code> <br> </blockquote><br>  The working example is at <a href="http://test.dis.dj/utf/">http://test.dis.dj/utf/</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What conclusions should be drawn from what he saw: <br><ol><li>  Offset relative to the beginning of the line is always considered in bytes: <br>  3 bytes "one" + <br>  1 byte space + <br>  3 √ó 2 bytes ‚Äútwo‚Äù + <br>  1 byte space + <br>  3 √ó 2 bytes ‚Äútwo‚Äù + <br>  1 byte space = <br>  <em>18 bytes</em> , <br>  and should be <br>  3 + 1 + 3 + 1 + 3 + 1 = <em>12 characters</em> . </li><li>  Cyrillic correctly recognizes only "Character range" with the key "/ u" and the modifier "\ pL", meaning "Unicode letter" </li><li>  The "\ w" modifier with Cyrillic does not work at all, even the "/ u" key does not help </li><li>  On a server running Windows Server 2008, for some unknown reason, the very first construction worked, and the ‚Äú/ u‚Äù key no longer exists :) </li></ol><br>  Useful links: <br><ul><li>  <a href="http://forum.codenet.ru/showthread.php%3Ft%3D46799">Codenet forum thread</a> . </li><li>  More information about the PCRE engine and modifiers can be found in the <a href="http://www.pcre.org/pcre.txt">official documentation</a> . </li><li>  In <a href="http://forum.ixbt.com/topic.cgi%3Fid%3D24:40663">another thread on ixbt</a> it was well written about ‚Äú/ u‚Äù. </li><li>  In the comments to preg_match_all there is a function <a href="http://ru2.php.net/manual/en/function.preg-match-all.php">mb_preg_match_all</a> , which converts the indents into the correct ones (it is just used in this post). </li></ul><br>  Well, we are waiting for PHP6, where it promises normal support for strings in UTF, including the BOM, which will fill up our script, outputting 3 bytes before header ().  Actually there will be a lot of bonuses in PHP6 ... <br><br>  PS Fasting does not in any way claim to be the ‚Äúdiscovery of America‚Äù - I just collected the information I know. <br><br>  UPD.  In the course of the discussion, we came to the following replacement ‚Äú\ w‚Äù: either the recommended conglomerate ‚Äú(?: \ P {L} | \ p {M} | \ p {D} | \ p {Pc})‚Äù or ‚Äú[\ p {L} \ p {Nd}] ‚Äù(if you want a shorter one).  Thank you <a href="https://habrahabr.ru/users/khim/" class="user_link">khim</a> . </div><p>Source: <a href="https://habr.com/ru/post/45910/">https://habr.com/ru/post/45910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45899/index.html">Who performs system testing in your team?</a></li>
<li><a href="../45901/index.html">When dreams come true</a></li>
<li><a href="../45902/index.html">Think differently!</a></li>
<li><a href="../45903/index.html">Futuristic LED Watch</a></li>
<li><a href="../45907/index.html">Whom ‚ÄúOdnoklassniki‚Äù scared ‚ÄúGoogle‚Äù?</a></li>
<li><a href="../45911/index.html">Twiddler2</a></li>
<li><a href="../45912/index.html">Setting up backup in Ubuntu</a></li>
<li><a href="../45913/index.html">Live cook book: our culinary and software hobby</a></li>
<li><a href="../45914/index.html">Using third-party brands in a startup</a></li>
<li><a href="../45919/index.html">Monty Hall's paradox: is there any difference?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>