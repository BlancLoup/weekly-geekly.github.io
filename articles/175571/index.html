<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tree View with "CRUD operations", "drag and drop (DnD)" and "delayed loading" using Dojo Tree, Entity Framework, SQL Server and ASP.NET MVC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The Dojo Toolkit is an open source modular JavaScript library designed to facilitate the rapid development of cross-platform JavaScript...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tree View with "CRUD operations", "drag and drop (DnD)" and "delayed loading" using Dojo Tree, Entity Framework, SQL Server and ASP.NET MVC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/a0d/0bd/504/a0d0bd504fd5763690dfe6b24eeb80ce.png" alt="image"><br><br><h5>  Introduction </h5><br>  The Dojo Toolkit is an open source modular JavaScript library designed to facilitate the rapid development of cross-platform JavaScript / Ajax-oriented applications and websites, which provides some really powerful features for the user interface.  The Dojo Tree component provides a complete, familiar, intuitive, expandable view of hierarchical data.  This component supports deferred branch loading, which makes it well scalable for large amounts of data.  Dojo Tree is a great widget for presenting data with ancestor-child relationships. <br><br>  This article shows the process of creating a tree that supports ‚ÄúCRUD operations‚Äù, ‚Äúdrag and drop (DnD)‚Äù and ‚Äúdeferred loading‚Äù.  To create such a tree, we will use Dojo Tree, Entity Framework, SQL Server and Asp .Net MVC. <br><a name="habracut"></a><br><h5>  Create MVC applications using the Entity Framework </h5><br>  This example uses the Entity Framework ‚Äúfirst model‚Äù approach.  But this does not mean that you cannot use other approaches, such as ‚Äúfirst code‚Äù or ‚Äúfirst database‚Äù.  Julie Lerman has a great article ‚ÄúCreating MVC 3 applications with a‚Äú model first ‚Äùapproach and Entity Framework 4.1‚Äù <a href="http://msdn.microsoft.com/en-us/data/gg685494">here</a> .  You can use this article to create your model, class and database.  Creating the same controllers and views will be consecrated here. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  RESTful service in ASP.NET MVC </h5><br>  Since the Dojo JsonRest Store sends and receives JSON data to provide CRUD operations on entities, we need a RESTful service with ASP.NET MVC 3. You can find a good article ‚ÄúBuilding a RESTful API Architecture in ASP.NET MVC 3 Applications‚Äù written by Justin Schwartzenberger <a href="http://iwantmymvc.com/rest-service-mvc3">here</a> .  We will not use it all, but I used part of the ideas from this article. <br><br>  First we need our own <code>ActionFilterAttribute</code> , which we will create to facilitate the management of several operations (verb) using a single controller action.  Create a class ( <code>RestHttpVerbFilter.cs</code> ) in the model folder, using code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DojoTree.Models</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RestHttpVerbFilter</span></span> : <span class="hljs-title"><span class="hljs-title">ActionFilterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnActionExecuting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ActionExecutingContext filterContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpMethod = filterContext.HttpContext.Request.HttpMethod; filterContext.ActionParameters[<span class="hljs-string"><span class="hljs-string">"httpVerb"</span></span>] = httpMethod; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnActionExecuting(filterContext); } } }</code> </pre><br>  ‚ÄúThis code will intercept HTTP operations (HTTP verb) of the request and store them in the <code>ActionParameters</code> collection.  By applying this attribute to the controller action, we can add the <code>httpVerb</code> parameter and <code>RestHttpVerbFilter</code> will control the attachment of the value of the HTTP request operation to it.  Our controller must support an action method with the same parameters, but accepting different actions based on HTTP operations.  It is impossible to override a method with the same parameters, but with different attributes of HTTP operations.  This custom attribute will allow us to have one controller action method that will work depending on the HTTP operation, without concern for the logic of the operation definition. ‚Äù[6] <br><br><h5>  Model </h5><br>  Add a class of the model containing information about the nodes of the tree.  The class and model are shown in the listing: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Node</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ParentId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NodeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><img src="https://habrastorage.org/storage2/79b/03b/0cc/79b03b0cc87a0eceae8603bd9d4c2893.png" alt="image"><br><br><h5>  Representation </h5><br>  To add the root generation link, you need to change part of the menu in the <code>"_Layout.cshtml"</code> file as shown below: <br><pre> <code class="cs hljs"> &lt;ul id=<span class="hljs-string"><span class="hljs-string">"menu"</span></span>&gt; &lt;li&gt;@Html.ActionLink(<span class="hljs-string"><span class="hljs-string">"Home"</span></span>, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>, <span class="hljs-string"><span class="hljs-string">"Home"</span></span>)&lt;/li&gt; &lt;li&gt;@Html.ActionLink(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"generateRoot"</span></span>, <span class="hljs-string"><span class="hljs-string">"Home"</span></span>)&lt;/li&gt; &lt;/ul&gt;</code> </pre><br><h6>  Home / generateRoot view </h6><br>  Create a view for the "generateRoot" action as shown below: <br><pre> <code class="cs hljs">@{ ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"generateRoot"</span></span>; } &lt;h2&gt;@ViewBag.Message&lt;/h2&gt;</code> </pre><br><h6>  Home / Index view </h6><br>  Code for this view: <br><pre> <code class="cs hljs">@{ ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Dojo Tree"</span></span>; } &lt;h2&gt;@ViewBag.Message&lt;/h2&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojo/resources/dojo.css"</span></span>&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dijit/themes/claro/claro.css"</span></span>&gt; &lt;!-- load dojo and provide config via data attribute --&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojo/dojo.js"</span></span> data-dojo-config=<span class="hljs-string"><span class="hljs-string">"async: true, isDebug: true, parseOnLoad: true"</span></span>&gt;&lt;/script&gt; &lt;script src=<span class="hljs-string"><span class="hljs-string">"/js/tree.js"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt;&lt;/script&gt; &lt;div style=<span class="hljs-string"><span class="hljs-string">" width: 400px; margin: 10px;"</span></span>&gt; &lt;div id=<span class="hljs-string"><span class="hljs-string">"tree"</span></span>&gt;&lt;/div&gt; &lt;/div&gt; &lt;div id=<span class="hljs-string"><span class="hljs-string">"add-new-child"</span></span>&gt;&lt;/div&gt; &lt;div id=<span class="hljs-string"><span class="hljs-string">"remove-child"</span></span>&gt;&lt;/div&gt;</code> </pre><br>  Full article about the code above and below you can see <a href="http://dojotoolkit.org/documentation/tutorials/1.7/store_driven_tree/">here</a> . <br><br>  As can be seen from the code above, we have a link to <code>js/tree.js</code> , below is its content. <br><br><h5>  Description js / tree.js </h5><br>  <code>tree.js</code> contains several parts: <br><br>  This part of the script loads the Dojo modules required for this example: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([<span class="hljs-string"><span class="hljs-string">"dojo/store/JsonRest"</span></span>, <span class="hljs-string"><span class="hljs-string">"dojo/store/Observable"</span></span>, <span class="hljs-string"><span class="hljs-string">"dojo/_base/Deferred"</span></span>, <span class="hljs-string"><span class="hljs-string">"dijit/Tree"</span></span>, <span class="hljs-string"><span class="hljs-string">"dijit/tree/dndSource"</span></span>, <span class="hljs-string"><span class="hljs-string">"dojox/form/BusyButton"</span></span>, <span class="hljs-string"><span class="hljs-string">"dojo/query"</span></span>, <span class="hljs-string"><span class="hljs-string">"dojo/domReady!"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonRest, Observable, Deferred, Tree, dndSource, BusyButton, query</span></span></span><span class="hljs-function">) </span></span>{</code> </pre><br><br>  This part creates a <code>treeStore</code> connection to the <code>TreeController</code> using <code>"target: "/tree/data/""</code> . <br><br><ul><li>  <code>mayHaveChildren</code> property that indicates whether the node has descendants </li><li>  <code>getChildren</code> returns a copy of all the children of the object. </li><li>  <code>getRoot</code> returns the root element, we will a get () and callback the result.  In this example, the root id = 1 </li><li>  <code>getLabel</code> returns the name </li><li>  <code>pasteItem</code> used to drag and drop actions, changes the Id of the descendant of the item being moved. </li><li>  <code>put</code> forces the <code>store</code> to access the database for changes </li></ul><br><br><pre> <code class="javascript hljs">treeStore = JsonRest({ <span class="hljs-attr"><span class="hljs-attr">target</span></span>: <span class="hljs-string"><span class="hljs-string">"/tree/data/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">mayHaveChildren</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">object</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// see if it has a children property return "children" in object; }, getChildren: function (object, onComplete, onError) { // retrieve the full copy of the object this.get(object.id).then(function (fullObject) { // copy to the original object so it has the children array as well. object.children = fullObject.children; // now that full object, we should have an array of children onComplete(fullObject.children); }, function (error) { // an error occurred, log it, and indicate no children console.error(error); onComplete([]); }); }, getRoot: function (onItem, onError) { // get the root object, we will do a get() and callback the result this.get("1").then(onItem, function (error) { alert("Error loading Root"); }); }, getLabel: function (object) { // just get the name return object.NodeName; }, pasteItem: function (child, oldParent, newParent, bCopy, insertIndex) { // This will prevent to add a child to its parent again. if (child.ParentId == newParent.id) { return false; } var store = this; store.get(oldParent.id).then(function (oldParent) { store.get(newParent.id).then(function (newParent) { store.get(child.id).then(function (child) { var oldChildren = oldParent.children; dojo.some(oldChildren, function (oldChild, i) { if (oldChild.id == child.id) { oldChildren.splice(i, 1); return true; // done } }); store.put(oldParent); //This will change the parent of the moved Node child.ParentId = newParent.id; store.put(child); newParent.children.splice(insertIndex || 0, 0, child); store.put(newParent); }, function (error) { alert("Error loading " + child.NodeName); }); }, function (error) { alert("Error loading " + newParent.NodeName); }); }, function (error) { alert("Error loading " + oldParent.NodeName); }); }, put: function (object, options) { this.onChildrenChange(object, object.children); this.onChange(object); return JsonRest.prototype.put.apply(this, arguments); } });</span></span></code> </pre><br><br>  This part of the script defines the Dojo Tree and attaches it to the <code>treeStore</code> and then runs it: <br><pre> <code class="javascript hljs">tree = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tree({ <span class="hljs-attr"><span class="hljs-attr">model</span></span>: treeStore, <span class="hljs-attr"><span class="hljs-attr">dndController</span></span>: dndSource }, <span class="hljs-string"><span class="hljs-string">"tree"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// make sure you have a target HTML element with this id tree.startup();</span></span></code> </pre><br><br>  The following part of the script adds a ‚Äúclaro‚Äù theme for the page: <br><pre> <code class="javascript hljs">dojo.query(<span class="hljs-string"><span class="hljs-string">"body"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"claro"</span></span>);</code> </pre><br><br>  This part of the script defines the <code>BusyButton</code> : <code>addNewChildButton</code> and <code>removeChildButton</code> . <br>  You can read detailed documentation about this item <a href="http://dojotoolkit.org/reference-guide/1.8/dojox/form/BusyButton.html">here.</a> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addNewChildButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BusyButton({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"add-new-child"</span></span>, <span class="hljs-attr"><span class="hljs-attr">busyLabel</span></span>: <span class="hljs-string"><span class="hljs-string">"Wait a moment..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">"Add new child to selected item"</span></span>, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">500</span></span> }, <span class="hljs-string"><span class="hljs-string">"add-new-child"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> removeChildButton = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BusyButton({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"remove-child"</span></span>, <span class="hljs-attr"><span class="hljs-attr">busyLabel</span></span>: <span class="hljs-string"><span class="hljs-string">"Wait a moment..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">label</span></span>: <span class="hljs-string"><span class="hljs-string">"Remove selected item"</span></span>, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">500</span></span> }, <span class="hljs-string"><span class="hljs-string">"remove-child"</span></span>);</code> </pre><br><br>  This part of the script defines the action to click on the <code>add-new-child</code> button.  First, it is determined whether the user has selected a tree item.  Then the selected item <code>selectedObject</code> synchronized with the server and if everything is in order, it is proposed to enter the name of the new item.  Next, a new element is <code>newItem</code> and is added as a descendant of the selected item <code>selectedObject</code> and sent to the server <code>treeStore.put(newItem);</code>  .  After 500 ms, the selected item <code>selectedObject</code> reloaded to get the id of the added child.  To reboot after 500 ms, we use <code>"Deferred.when/dojo.when"</code> , the documentation on this can be viewed <a href="http://dojotoolkit.org/reference-guide/1.8/dojo/when.html">here</a> . <br><pre> <code class="javascript hljs">query(<span class="hljs-string"><span class="hljs-string">"#add-new-child"</span></span>).on(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selectedObject = tree.get(<span class="hljs-string"><span class="hljs-string">"selectedItems"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectedObject) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alert(<span class="hljs-string"><span class="hljs-string">"No object selected"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//Sync selectedObject with server treeStore.get(selectedObject.id).then(function (selectedObject) { var name = prompt("Enter a name for new node"); if (name != null &amp;&amp; name != "") { var newItem = { NodeName: name, ParentId: selectedObject.id, children: "" }; selectedObject.children.push(newItem); treeStore.put(newItem); //Loading recently added node 500ms after puting it var nodeId = new Deferred(); Deferred.when(nodeId, reloadNode); setTimeout(function () { nodeId.resolve(selectedObject.id); }, 500); } else { return alert("Name can not be empty."); } }, function (error) { alert("Error loading " + selectedObject.NodeName); }); });</span></span></code> </pre><br><br>  This part defines click on the <code>remove-child</code> button.  First, it is checked whether the user has selected any element and that the selected element is not the root of the tree.  Next, there is a request for confirmation of the execution of the action: "Are you sure that you want to permanently delete this node and all its descendants?"  If the answer is yes, then the selectedObject object is synchronized with the server, and if everything is in order, the <code>removeAllChildren(selectedObject);</code> method will be called to delete all children and the selected node itself <code>removeAllChildren(selectedObject);</code>  .  After 500 ms, the parent of the selected item <code>selectedObject.ParentId</code> reboots. <br><pre> <code class="javascript hljs">query(<span class="hljs-string"><span class="hljs-string">"#remove-child"</span></span>).on(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selectedObject = tree.get(<span class="hljs-string"><span class="hljs-string">"selectedItems"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!selectedObject) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alert(<span class="hljs-string"><span class="hljs-string">"No object selected"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectedObject.id == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alert(<span class="hljs-string"><span class="hljs-string">"Can not remove Root Node"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = confirm(<span class="hljs-string"><span class="hljs-string">"Are you sure you want to permanently delete this node and all its children?"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (answer) { treeStore.get(selectedObject.id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">selectedObject</span></span></span><span class="hljs-function">) </span></span>{ removeAllChildren(selectedObject); <span class="hljs-comment"><span class="hljs-comment">//Reloading the parent of recently removed node 500ms after removing it var ParentId = new Deferred(); Deferred.when(ParentId, reloadNode); setTimeout(function () { ParentId.resolve(selectedObject.ParentId); }, 500); }, function (error) { alert("Error loading " + selectedObject.NodeName); }); } });</span></span></code> </pre><br><br>  This part of the script defines a double click on <code>dblclick</code> to rename the tree node.  First, the selected item is synchronized with the server and if everything is in order, a new name for the node is requested.  Then the new name is transferred to the server <code>treeStore.put(object)</code> . <br><pre> <code class="javascript hljs"> tree.on(<span class="hljs-string"><span class="hljs-string">"dblclick"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">object</span></span></span><span class="hljs-function">) </span></span>{ treeStore.get(object.id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">object</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = prompt(<span class="hljs-string"><span class="hljs-string">"Enter a new name for the object"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; name != <span class="hljs-string"><span class="hljs-string">""</span></span>) { object.NodeName = name; treeStore.put(object).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// On Error revert Value reloadNode(object.ParentId); alert("Error renaming " + object.NodeName); }); } else { return alert("Name can not be empty."); } }, function (error) { alert("Error loading " + object.NodeName); }); }, true); });</span></span></code> </pre><br><br>  This function reloads the node by the value of id and all descendants of the same level. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reloadNode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">) </span></span>{ treeStore.get(id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Object</span></span></span><span class="hljs-function">) </span></span>{ treeStore.put(<span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>); }) };</code> </pre><br><br>  This function recursively deletes all descendants of a node. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeAllChildren</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function">) </span></span>{ treeStore.get(node.id).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nodeChildren = node.children; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> nodeChildren) { removeAllChildren(nodeChildren[n]); } treeStore.remove(node.id); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) </span></span>{ alert(error); }); };</code> </pre><br><br><h5>  Controller </h5><br>  Now you need to create a controller. <br><br><h6>  Treecontroller </h6><br>  Copy the code below in <code>"TreeController.cs":</code> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data.Entity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DojoTree.Models; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DojoTree.Controllers</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TreeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TreeModelContainer db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeModelContainer(); <span class="hljs-comment"><span class="hljs-comment">// GET /Tree/Data/3 // POST /Tree/Data // PUT /Tree/Data/3 // DELETE /Tree/Data/3 [RestHttpVerbFilter] public JsonResult Data(Node node, string httpVerb, int id = 0) { switch (httpVerb) { case "POST": if (ModelState.IsValid) { db.Entry(node).State = EntityState.Added; db.SaveChanges(); return Json(node, JsonRequestBehavior.AllowGet); } else { Response.TrySkipIisCustomErrors = true; Response.StatusCode = (int)HttpStatusCode.NotAcceptable; return Json(new { Message = "Data is not Valid." }, JsonRequestBehavior.AllowGet); } case "PUT": if (ModelState.IsValid) { db.Entry(node).State = EntityState.Modified; db.SaveChanges(); return Json(node, JsonRequestBehavior.AllowGet); } else { Response.TrySkipIisCustomErrors = true; Response.StatusCode = (int)HttpStatusCode.NotAcceptable; return Json(new { Message = "Node " + id + " Data is not Valid." }, JsonRequestBehavior.AllowGet); } case "GET": try { var node_ = from entity in db.Nodes.Where(x =&gt; x.Id.Equals(id)) select new { id = entity.Id, NodeName = entity.NodeName, ParentId = entity.ParentId, children = from entity1 in db.Nodes.Where (y =&gt; y.ParentId.Equals(entity.Id)) select new { id = entity1.Id, NodeName = entity1.NodeName, ParentId = entity1.ParentId, children = "" // it calls checking children // whenever needed } }; var r = node_.First(); return Json(r, JsonRequestBehavior.AllowGet); } catch { Response.TrySkipIisCustomErrors = true; Response.StatusCode = (int)HttpStatusCode.NotAcceptable; return Json(new { Message = "Node " + id + " does not exist." }, JsonRequestBehavior.AllowGet); } case "DELETE": try { node = db.Nodes.Single(x =&gt; x.Id == id); db.Nodes.Remove(node); db.SaveChanges(); return Json(node, JsonRequestBehavior.AllowGet); } catch { Response.TrySkipIisCustomErrors = true; Response.StatusCode = (int)HttpStatusCode.NotAcceptable; return Json(new { Message = "Could not delete Node " + id }, JsonRequestBehavior.AllowGet); } } return Json(new { Error = true, Message = "Unknown HTTP verb" }, JsonRequestBehavior.AllowGet); } } }</span></span></code> </pre><br><br>  As you can see, the controller performs ‚ÄúGET / POST / PUT / DELETE‚Äù operations in a single URL <code>"/Tree/Data/"</code> , this is possible thanks to <code>RestHttpVerbFilter</code> . <br><ul><li>  POST adds new node </li><li>  PUT edits node </li><li>  GET returns data about a node and its descendants of the same level.  This serves to support deferred loading. </li><li>  DELETE deletes the node. </li></ul><br><br><h6>  Homecontroller </h6><br>  I changed the <code>HomeController</code> only to add the method of generating the root of the tree.  Bring your <code>HomeController</code> to the following form: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Web.Mvc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DojoTree.Models; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DojoTree.Controllers</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ViewBag.Message = <span class="hljs-string"><span class="hljs-string">"Tree supporting CRUD operations Using Dojo Tree, Entity Framework, Asp .Net MVC"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateRoot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TreeModelContainer db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeModelContainer(); Node node = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node(); node= db.Nodes.Find(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//If you deleted Root manually, this couldn't make Root again //because Root Id must be "1", so you must drop the //Tree table and rebuild it //or change the Root Id in "tree.js" Node rootNode = new Node(); rootNode.NodeName = "Root"; rootNode.ParentId = 0; db.Nodes.Add(rootNode); db.SaveChanges(); ViewBag.Message = "Some Nodes have been generated"; } else { ViewBag.Message = "Root Exists."; } } catch { ViewBag.Message = "An Error occurred"; } return View(); } } }</span></span></code> </pre><br><br><h5>  Visual demonstration </h5><br>  Now it's time to look at the result.  Build the solution and click on root generation, then add |  rename |  drag and paste |  remove any tree nodes. <br><img src="https://habrastorage.org/storage2/31d/a53/5bf/31da535bf5eeb8583e254075bdeb825e.png" alt="image"><br>  As you can see in fireBug, data is sent and received via Json REST. <br><br><h5>  Links </h5><br>  This material is a translation of the article "Tree View with" CRUD operations "," drag and drop (DnD) "and" Lazy Loading ‚Äúusing Dojo Tree, Entity Framework, SQL Server, ASP.NET MVC‚Äù <a href="http://www.codeproject.com/Articles/337439/Tree-View-with-CRUD-operations-drag-and-drop-DnD-a">from here</a> .  You can also download the source code of this example. </div><p>Source: <a href="https://habr.com/ru/post/175571/">https://habr.com/ru/post/175571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175553/index.html">A Brief History of Animals on O'Reilly Books</a></li>
<li><a href="../175557/index.html">Moscow public transport fare collection system</a></li>
<li><a href="../175559/index.html">As I wrote skad. Part five</a></li>
<li><a href="../175563/index.html">How to listen to the radio using powershell and node.js</a></li>
<li><a href="../175569/index.html">How Visa and Master Card Benefit from Working with Square</a></li>
<li><a href="../175575/index.html">Date mining and heuristics of finding places in restaurants: almost the same problem as with free parking</a></li>
<li><a href="../175583/index.html">Thinking about fremium games, on the other hand barricades</a></li>
<li><a href="../175587/index.html">SSAS 2012: from multidimensional to tabular data model</a></li>
<li><a href="../175589/index.html">Change file date according to EXIF</a></li>
<li><a href="../175591/index.html">HPC. Program, live stream and free tickets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>