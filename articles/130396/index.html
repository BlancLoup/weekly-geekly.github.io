<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a module for Ejabberd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you need non-standard functionality from the XMPP server ejabberd, you do not know how to set it up with standard tools and did not find a suitable...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a module for Ejabberd</h1><div class="post__text post__text-html js-mediator-article">  If you need non-standard functionality from the XMPP server ejabberd, you do not know how to set it up with standard tools and did not find a suitable module for this module, then you can write this module yourself. <br><br>  So I decided when the authorities declared war to idle talk in jabber, for which it was necessary to prohibit some users from chatting with others, but allowing others to allow them.  And although I still have a vague suspicion that this can be configured using access lists, I decided to write a module that I would be comfortable using.  This module will serve as an example for the story. <br><a name="habracut"></a><br><h4>  Training </h4><br>  First you need to at least learn a little erlang programming language.  I used <a href="">translation of article from RSDN Magazine</a> and <a href="http://www.erlang.org/doc/">official documentation</a> . <br>  After that, you need to prepare a computer to assemble the module.  In addition to the installed erlang and ejabberd, we will need their sources in order to connect some libraries to our module. <br><br>  To check the module in action, you will need: <br><ol><li>  Compile it. <br><pre><code class="bash hljs">$ erlc mod_restrictions.erl</code> </pre> </li><li>  Move the resulting binary into the folder to ejabberd. <br><pre> <code class="bash hljs">$ mv mod_restrictions.beam /usr/lib/ejabberd/ebin/</code> </pre> </li><li>  Load new (updated) module.  To do this, you can simply restart ejabberd: <br><pre> <code class="bash hljs">$ service ejabberd restart</code> </pre>  or you can <a href="http://www.ejabberd.im/tricks">update the module on the fly</a> , for example, in the ejabberd admin panel ( <i>Nodes -&gt; Your site -&gt; Update</i> ) </li></ol>  (commands for Ubuntu 11.04) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The compiler can write something like this: <br><br><pre> <code class="bash hljs">./mod_restrictions.erl:5: Warning: behaviour gen_mod undefined</code> </pre> <br>  It's not scary, everything will work.  If there are any other errors and warnings, then they should be dealt with. <br><br>  To connect a module in the ejabber config (/etc/ejabberd/ejabberd.cfg file), add the line in the list of modules (after <code>{modules,[</code> ): <br><br><pre> <code class="erlang hljs">{mod_restrictions, []}</code> </pre> <br><h4>  Skeleton </h4><br>  Modules ejabberd must inherit the <i>gen_mod</i> interface.  This behavior requires two functions: <i>start / 2</i> and <i>stop / 1</i> , which will be called, respectively, when the module is started and stopped.  We write the following code in the mod_restrictions.erl file: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(mod_restrictions)</span></span>. -behavior(gen_mod). -export([start/<span class="hljs-number"><span class="hljs-number">2</span></span>, stop/<span class="hljs-number"><span class="hljs-number">1</span></span>]). start(_Host, _Opts) -&gt;  ok. stop(_Host) -&gt;  ok.</code> </pre> <br>  Here we: <br><ol><li>  Specify the name of the module (should be as a file name without .erl). </li><li>  We inherit the behavior of gen_mod. </li><li>  We say that the start (with two arguments) and stop (with one argument) functions are accessible from outside the module. </li><li>  We write function.  The lower space in the argument names tells Erlang that these arguments are not used. </li><li>  Return ok </li></ol><br><h4>  We write to the logs </h4><br>  To record an event in the logs (for example, that the module started and stopped), you can use the macro <i>? INFO_MSG</i> : <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(mod_restrictions)</span></span>. -behavior(gen_mod). -include(<span class="hljs-string"><span class="hljs-string">"ejabberd.hrl"</span></span>). -export([start/<span class="hljs-number"><span class="hljs-number">2</span></span>, stop/<span class="hljs-number"><span class="hljs-number">1</span></span>]). start(Host, _Opts) -&gt;  ?INFO_MSG(<span class="hljs-string"><span class="hljs-string">"mod_restrictions   ~p"</span></span>, [Host]),  ok. stop(Host) -&gt;  ?INFO_MSG(<span class="hljs-string"><span class="hljs-string">"mod_restrictions   ~p"</span></span>, [Host]),  ok.</code> </pre> <br>  First, we include the ejabberd.hrl file with the definition of the INFO_MSG macro.  Note that you need to specify the full or relative path to the included file, specifically this one lies in the source code of ejabber. <br>  Our message will appear in the server logs (I have this /var/log/ejabberd/ejabberd.log), and instead of each ~ p there will be an element from the list - the second argument. <br><br><h4>  Ejabberd event handling </h4><br>  Ejabberd allows modules to be built into it using the mechanism of events (events) and hooks (hooks). <br><br><pre> <code class="erlang hljs">ejabberd_hooks:add(Hook, Host, Module, Function, Prioritet) ejabberd_hooks:remove(Hook, Host, Module, Function, Prioritet)</code> </pre> <br>  Ejabberd will call the <i>Module's</i> <i>Function Function</i> <i>Module</i> (use the <i>? MODULE</i> macro for your module) every time a <i>Hook</i> event occurs on the <i>Host</i> node (use <i>global</i> if you want to listen to all nodes).  A list of possible events can be viewed at <a href="https://support.process-one.net/doc/display/MESSENGER/Events%2Band%2Bhooks">this link</a> .  If there are several subscribers to one event, they are executed in turn, first with a higher priority. <br>  We are interested in the <i>filter_packet</i> event, which occurs every time someone sends something to someone (for example, a message). <br>  Now the module looks like this: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-module</span></span><span class="hljs-params"><span class="hljs-params">(mod_restrictions)</span></span>. -behavior(gen_mod). -include(<span class="hljs-string"><span class="hljs-string">"ejabberd.hrl"</span></span>). -export([start/<span class="hljs-number"><span class="hljs-number">2</span></span>, stop/<span class="hljs-number"><span class="hljs-number">1</span></span>, on_filter_packet/<span class="hljs-number"><span class="hljs-number">1</span></span>]). start(_Host, _Opts) -&gt;  ejabberd_hooks:add(filter_packet, global, ?MODULE, on_filter_packet, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ok. stop(_Host) -&gt;  ejabberd_hooks:delete(filter_packet, global, ?MODULE, on_filter_packet, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ok. on_filter_packet(Packet) -&gt;  Packet.</code> </pre> <br><h4>  Add module to admin panel </h4><br>  In order to manage users and groups, I want to add a module to the ejabberd web interface.  Read more about it <a href="http://www.ejabberd.im/webadmin-hooks">here</a> . <br><br>  We connect the necessary files and add-delete hooks: <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-include</span></span><span class="hljs-params"><span class="hljs-params">(</span><span class="hljs-string"><span class="hljs-params"><span class="hljs-string">"web/ejabberd_http.hrl"</span></span></span><span class="hljs-params">)</span></span>. -include(<span class="hljs-string"><span class="hljs-string">"web/ejabberd_web_admin.hrl"</span></span>). start(_Host, _Opts) -&gt;  ...  ejabberd_hooks:add(webadmin_menu_main, ?MODULE, web_menu_host, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ejabberd_hooks:add(webadmin_page_main, ?MODULE, web_page_host, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ... stop(_Host) -&gt;  ...  ejabberd_hooks:delete(webadmin_menu_main, ?MODULE, web_menu_host, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ejabberd_hooks:delete(webadmin_page_main, ?MODULE, web_page_host, <span class="hljs-number"><span class="hljs-number">50</span></span>),  ...</code> </pre> <br><br>  Add an item to the main admin menu: <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">web_menu_host</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Acc, Lang)</span></span></span><span class="hljs-function"> -&gt;</span></span>  Acc ++ [{<span class="hljs-string"><span class="hljs-string">"mod_restrictions"</span></span>, ?T(<span class="hljs-string"><span class="hljs-string">"Restrictions"</span></span>)}].</code> </pre> <br>  And the module page itself: <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">web_page_host</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_,      #request{method = Method,            q = Query,            path = [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mod_restrictions"</span></span></span></span><span class="hljs-function"><span class="hljs-params">],            lang = _Lang})</span></span></span><span class="hljs-function"> -&gt;</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Method <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>    'POST' -&gt; <span class="hljs-comment"><span class="hljs-comment">%% Handle database query      case lists:keyfind("act", 1, Query) of        {"act","add_usrgrp"} -&gt; %% add user to group          {"usr",NewUser} = lists:keyfind("usr", 1, Query),          {"grp",NewGroup} = lists:keyfind("grp", 1, Query),          ?INFO_MSG("mod_restrictions: ADD NewUser=~p NewGroup=~p", [NewUser, NewGroup]);        ...        _ -&gt; none      end;    _ -&gt; none  end,  Res = [?XC("h1", "Restriction module manager"),      ?XE("table",[        ?XE("tr",          [?XC("th","Users"),?XC("th","Groups")]        ),        ?XE("tr",          [?XAE("td",[{"style","vertical-align:top;"}],web_user_list()),?XAE("td",[{"style","vertical-align:top;"}],web_group_list())]        )]      )     ],  {stop, Res}; web_page_host(Acc, _) -&gt; Acc.</span></span></code> </pre> <br>  Here we first process POST requests to change the list of user groups, then return the following HTML code: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Restriction module manager<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Users<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Groups<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vertical-align:top;"</span></span></span><span class="hljs-tag">&gt;</span></span>  - <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"usr"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"grp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"act"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"add_usrgrp"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Add"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vertical-align:top;"</span></span></span><span class="hljs-tag">&gt;</span></span>  - <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"grp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dest"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"act"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"add_grpdest"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Add"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  All HTML generation functions can be viewed in the ejabberd_web_admin.hrl file. <br><br><h4>  Work with database </h4><br>  The easiest way to use the Mnesia database with ejabberd. <br><br>  We will need 2 tables: one for including users in groups, and another for setting group rights. <br>  The structure of the tables is described using erlang-records. <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-record</span></span><span class="hljs-params"><span class="hljs-params">(restrictions_users, {usr, grp})</span></span>. -record(restrictions_groups, {grp, dest}).</code> </pre> <br>  We have created a <i>restrictions_users</i> entry with the user's JID fields and his group, and <i>restrictions_groups</i> entry with the group and direction fields (where it is allowed to send messages). <br><br>  You can work with Mnesia tables in two ways: with transactions and ‚Äúdirty‚Äù methods.  The second method is faster, but does not guarantee the integrity of the database.  We will use it when processing messages. <br><br><h5>  Creating tables </h5><br>  Now in the start function we will create tables corresponding to these entries.  They will not overwrite when the module is restarted, unless they do it on purpose. <br><br><pre> <code class="erlang hljs">mnesia:create_table(restrictions_groups, [{disc_copies, [node()]} , {attributes, record_info(fields, restrictions_groups)}, {type, bag}]), mnesia:create_table(restrictions_users, [{disc_copies, [node()]} , {attributes, record_info(fields, restrictions_users)}, {type, bag}]),</code> </pre> <br>  Among other things, here we indicate that a copy of the table is stored on the hard disk (by default, the tables are stored only in RAM).  The type of the <i>bag</i> table means that the values ‚Äã‚Äãin the fields may not be unique, but each entry in the table is unique. <br><br><h5>  SELECT * FROM table </h5><br>  In the admin area we need to display the tables entirely.  To do this, you can use this design: <br><br><pre> <code class="erlang hljs">mnesia:dirty_match_object(mnesia:table_info(,wild_pattern))</code> </pre> <br>  It will give us a list of all the records in the table.  Then you can use, for example, the function <i>lists: map / 2</i> in order to make an HTML label from the list. <br><br><h5>  JOIN </h5><br>  When processing messages, we will need to join tables to determine the correspondence between the user (usr) and the permissions (dest).  We use the <i>qlc</i> module for this: <br><br><pre> <code class="erlang hljs">Ftemp = <span class="hljs-keyword"><span class="hljs-keyword">fun</span></span>() -&gt;  Qvve = qlc:q([allow || U &lt;- mnesia:table(restrictions_users),              G &lt;- mnesia:table(restrictions_groups),              (U#restrictions_users.usr == FromUsr++<span class="hljs-string"><span class="hljs-string">"@"</span></span>++FromDomain) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>              (U#restrictions_users.grp == G#restrictions_groups.grp) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (                (G#restrictions_groups.dest == <span class="hljs-string"><span class="hljs-string">"all"</span></span>) or                (G#restrictions_groups.dest == ToDomain) or                (G#restrictions_groups.dest == ToUsr++<span class="hljs-string"><span class="hljs-string">"@"</span></span>++ToDomain)              )        ]),  qlc:eval(Qvve) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, ?INFO_MSG(<span class="hljs-string"><span class="hljs-string">"mod_restrictions: allow? ~p"</span></span>, [mnesia:transaction(Ftemp)]),</code> </pre> <br>  If the user From is in a group that has all permission, or permission to write To user to the domain, or To user himself, then the request returns {atomic, [allow, ...]}. <br><br><h4>  Module parameters </h4><br>  We can transfer parameters from the configuration file ejabberd.cfg to the module, replacing the connection string with the following, for example: <br><br><pre> <code class="erlang hljs">{mod_restrictions, [{deny_message,<span class="hljs-string"><span class="hljs-string">"    :("</span></span>}]}</code> </pre> <br>  We will pass in the parameter text of the answering machine when the message is blocked. <br>  In the module, the value of the parameter is obtained using the function get_module_opt: <br><br><pre> <code class="erlang hljs">gen_mod:get_module_opt(Host, Module, Opt, Default)</code> </pre> <br><h4>  Sending a message from the module </h4><br><pre> <code class="erlang hljs">Attrs = [{<span class="hljs-string"><span class="hljs-string">"type"</span></span>,Type},{<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"legal"</span></span>},{<span class="hljs-string"><span class="hljs-string">"to"</span></span>,To#jid.user++<span class="hljs-string"><span class="hljs-string">"@"</span></span>++To#jid.server++<span class="hljs-string"><span class="hljs-string">"/"</span></span>++To#jid.resource},{<span class="hljs-string"><span class="hljs-string">"from"</span></span>,From#jid.user++<span class="hljs-string"><span class="hljs-string">"@"</span></span>++From#jid.server++<span class="hljs-string"><span class="hljs-string">"/"</span></span>++From#jid.resource}], Els = [{xmlcdata,&lt;&lt;<span class="hljs-string"><span class="hljs-string">"\n"</span></span>&gt;&gt;},{xmlelement,<span class="hljs-string"><span class="hljs-string">"body"</span></span>,[],[{xmlcdata,list_to_binary(Message)}]}], DenyMessage = {xmlelement,<span class="hljs-string"><span class="hljs-string">"message"</span></span>,Attrs,Els}, ejabberd_router:route(From,To,DenyMessage)</code> </pre> <br>  The From and To variables are taken from the on_filter_packet parameter, and they represent jid entries. <br><br><h4>  Conclusion </h4><br>  Full text of the module can be found <a href="">here</a> . <br>  Based on <a href="http://metajack.im/2008/08/28/writing-ejabberd-modules-presence-storms/">this article</a> . </div><p>Source: <a href="https://habr.com/ru/post/130396/">https://habr.com/ru/post/130396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130387/index.html">Framework for web applications built on CodeIgniter</a></li>
<li><a href="../130389/index.html">Common truths</a></li>
<li><a href="../130391/index.html">Easy PERL script for sending and receiving SMS via mobile phone</a></li>
<li><a href="../130393/index.html">Clearing the cache in iOS 5</a></li>
<li><a href="../130395/index.html">Mobile application developer brief: 15 key questions to ask the client</a></li>
<li><a href="../130399/index.html">Online photo studio do it yourself</a></li>
<li><a href="../130401/index.html">Tzdata - global knowledge of time zones</a></li>
<li><a href="../130402/index.html">Release MonoDevelop 2.8.1</a></li>
<li><a href="../130403/index.html">On departure from the repair team</a></li>
<li><a href="../130404/index.html">The first post is the most important one. LG Electronics officially on HabraHabr.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>