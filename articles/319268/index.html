<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience creating a mutation testing tool for Erlang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few weeks ago, I heard about mutation testing for Clojure, this is a way to test the quality of tests, in which small changes are made to the source...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience creating a mutation testing tool for Erlang</h1><div class="post__text post__text-html js-mediator-article">  A few weeks ago, I heard about mutation testing for Clojure, this is a way to test the quality of tests, in which small changes are made to the source code and tests either notice this or not.  For example, if the program used the condition "a&gt; 1", and replacing with "a &lt;1" does not change the test results, then the tests could be better. <br><br>  I thought that such a tool would be easy to write for Erlang, because the language provides a wide range of functions for processing internal representations generated by the compiler.  But it was not so easy.  Under the cut, I described the problems and the solution to which I eventually came to. <br><a name="habracut"></a><br>  The main thing I tried to achieve is the usability of the tool.  That is, it should not require complex configuration or installation of Emacs.  I downloaded, launched and was delighted. <br><br>  The following scenario was assumed: a mutation is entered into the code and tests are run.  If the tests did not recognize the mutation, then this information should be stored in an understandable way for the report.  Difficulties began. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Difficulty number 1: run tests </h3><br>  The most universal way to run tests is a shell command, and in Erlang, unfortunately, there are difficulties with getting a return code, this problem is described for example here: <br>  <a href="http://erlang.org/pipermail/erlang-questions/2008-October/039176.html">erlang.org/pipermail/erlang-questions/2008-October/039176.html</a> <br><br>  That is, you can, if you connect an external library (https://github.com/saleyn/erlexec), which requires gcc tricky version and is not tested for osx, and Linux in some cases requires magic, which is described in the Travis file. <br>  <a href="">github.com/saleyn/erlexec/blob/master/.travis.yml#L23</a> <br><br>  Okay, let there be an external library, or some additional utility that starts the mutator first, written in Erlang, then the tests themselves, and then generates a report if required. <br><br><h3>  Difficulty number 2: pretty printer </h3><br>  I started writing a mutator, in order not to be too abstract, I took jsx, there are a lot of unit tests in this package, everything seems to be necessary. <br><br>  I wrote the following code in Erlang: <br><br><pre><code class="erlang hljs">{ok, Forms} = epp:parse_file(<span class="hljs-string"><span class="hljs-string">"src/jsx_decoder.erl"</span></span>, []), io:format(<span class="hljs-string"><span class="hljs-string">"~s"</span></span>, [erl_prettypr:format(erl_syntax:form_list(Forms))]).</code> </pre> <br><br>  I was a little embarrassed by the fact that the design: <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-compile</span></span><span class="hljs-params"><span class="hljs-params">({inline, [handle_event/</span><span class="hljs-number"><span class="hljs-params"><span class="hljs-number">3</span></span></span><span class="hljs-params">]})</span></span>.</code> </pre><br>  turned into <br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-compile</span></span><span class="hljs-params"><span class="hljs-params">({inline, [{handle_event, </span><span class="hljs-number"><span class="hljs-params"><span class="hljs-number">3</span></span></span><span class="hljs-params">}]})</span></span>.</code> </pre><br><br>  It turns out the parser understands this and that way. <br><br>  But most of all the aesthetic pain was caused by the fact that all the code was re-introduced, without comments and to compare it with the initial version, it became quite difficult. <br><br>  I decided to try to ‚Äúcatch‚Äù the parsed code a little earlier in order to somehow save the comments, but it turned out that they disappear immediately after tokenization: <br><br><pre> <code class="hljs erlang-repl"><span class="hljs-meta"><span class="hljs-meta">1&gt; </span></span>erl_scan:string(<span class="hljs-string"><span class="hljs-string">"a. % this is my atom"</span></span>). {ok,[{atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,a},{dot,<span class="hljs-number"><span class="hljs-number">1</span></span>}],<span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre><br><br>  as far as I understand, this is a rather low-level function that is performed before macro substitution: <br><pre> <code class="hljs cs">erl_scan:<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(<span class="hljs-string"><span class="hljs-string">"-define(A)."</span></span>). {ok,[{<span class="hljs-string"><span class="hljs-string">'-'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {atom,<span class="hljs-number"><span class="hljs-number">1</span></span>,define}, {<span class="hljs-string"><span class="hljs-string">'('</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'A'</span></span>}, {<span class="hljs-string"><span class="hljs-string">')'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}, {dot,<span class="hljs-number"><span class="hljs-number">1</span></span>}], <span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre><br><br><h3>  Difficulty number 3: macros </h3><br>  If you look at the pretty-printer exhaust, you will notice their absence.  In the case of jsx, all its tests were eaten when processing a file, because they were inside "-ifdef (TEST).". <br><br>  This is of course a solvable problem, it was enough to pass the correct definition set to epp: parse_file, but the disclosure of macros made the code even less recognizable than just after pretty print. <br><br><h3>  Decision </h3><br>  After a couple days of hesitation, I took up and wrote the Erlang parser on python.  To begin with, I discovered the original Erlang grammar: <br>  <a href="">github.com/erlang/otp/blob/master/lib/stdlib/src/erl_parse.yrl</a> <br><br>  and decided not to transfer it one-to-one, since it did not seem to be a simple task, instead I wrote an Erlang grammar from memory, and then, having run the parser on several well-known projects, I debugged it.  The identity of building AST was not required, it simplified the task.  During the debugging process, I found some funny places in these repositories, like hackney for example: <br>  <a href="">github.com/benoitc/hackney/blob/master/src/hackney.erl#L1025</a> <br><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-define</span></span><span class="hljs-params"><span class="hljs-params">(METHOD_TPL(Method)</span></span>, Method<span class="hljs-params"><span class="hljs-params">(URL)</span></span> -&gt; hackney:request<span class="hljs-params"><span class="hljs-params">(Method, URL)</span></span>). -include(<span class="hljs-string"><span class="hljs-string">"hackney_methods.hrl"</span></span>). -define(METHOD_TPL(Method), Method(URL, Headers) -&gt; hackney:request(Method, URL, Headers)). -include(<span class="hljs-string"><span class="hljs-string">"hackney_methods.hrl"</span></span>) ...     </code> </pre><br><br>  or here, for example, in Virding, in most cases, meaningless use of begin and end: <br>  <a href="">github.com/rvirding/lfe/blob/develop/src/lfe_parse.erl#L238</a> <br><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, [__1|__Vs])</span></span></span><span class="hljs-function"> -&gt;</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> __1 <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs]; reduce(<span class="hljs-number"><span class="hljs-number">1</span></span>, [__1|__Vs]) -&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> value (__1) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs]; reduce(<span class="hljs-number"><span class="hljs-number">2</span></span>, [__1|__Vs]) -&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> value (__1) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs]; reduce(<span class="hljs-number"><span class="hljs-number">3</span></span>, [__1|__Vs]) -&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> value (__1) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs]; reduce(<span class="hljs-number"><span class="hljs-number">4</span></span>, [__1|__Vs]) -&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> value (__1) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs]; reduce(<span class="hljs-number"><span class="hljs-number">5</span></span>, [__1|__Vs]) -&gt; [ <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> make_fun (value (__1)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> | __Vs];</code> </pre><br><br>  The parser stumbled upon all constructions that I did not describe in it, that is, on all constructions that I did not remember or did not know, which turned out to be a rather interesting experience. <br><br>  After the parser was ready the description of transformations (mutations) was already quite a simple matter. <br><br><h3>  Result </h3><br><ol><li>  A bunch of fun. </li><li>  Erlang Python parser under BSD license. </li><li>  A library of mutations that changes the code without changing the formatting and deleting comments, as a result, it creates a diff that can be applied to the source code and get mutated. </li></ol><br><br>  Library code: <br>  <a href="https://github.com/parsifal-47/muterl">github.com/parsifal-47/muterl</a> </div><p>Source: <a href="https://habr.com/ru/post/319268/">https://habr.com/ru/post/319268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319258/index.html">Oracle APEX: Interactive Report with Checkboxes</a></li>
<li><a href="../319260/index.html">Develop and publish a game for Android in a week</a></li>
<li><a href="../319262/index.html">Comparative analysis of traffic balancing methods</a></li>
<li><a href="../319264/index.html">What should be hosting?</a></li>
<li><a href="../319266/index.html">"Breaking Bad 2", Dark Forester - a game at a distance of a small plus</a></li>
<li><a href="../319270/index.html">JSX - details</a></li>
<li><a href="../319272/index.html">I'm cool and this is a problem</a></li>
<li><a href="../319274/index.html">How we went through the UMNIK program for receiving a grant from beginning to end with the CNC machine tool design project</a></li>
<li><a href="../319276/index.html">Programming without internet</a></li>
<li><a href="../319278/index.html">2016: a year of radical change for the CUBA platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>