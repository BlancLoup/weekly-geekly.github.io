<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>1C: Bitrix, protection of arbitrary forms from spam</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Antispam module without CAPTCHA from CleanTalk for 1C: Bitrix makes it possible, in addition to protecting the described forms, to easily protect ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>1C: Bitrix, protection of arbitrary forms from spam</h1><div class="post__text post__text-html js-mediator-article">  The <a href="http://marketplace.1c-bitrix.ru/solutions/cleantalk.antispam/"><b>Antispam</b></a> module <a href="http://marketplace.1c-bitrix.ru/solutions/cleantalk.antispam/"><b>without CAPTCHA</b> from CleanTalk for 1C: Bitrix</a> makes it possible, in addition to protecting the described forms, to easily protect any form.  The module methods were written specifically with a view to the possible expansion of the functional.  Here I will give an example of how to do this. <br><a name="habracut"></a><br><br>  Suppose you need to make a check for spam forms with the following fields: <br>  email, nickname, title and message. <br>  All that is needed is to place the call code of the <b>CleantalkAntispam :: CheckAllBefore method</b> with the necessary parameters in <b>/bitrix/php_interface/init.php</b> . <br><br>  /bitrix/php_interface/init.php <br><pre><code class="hljs bash">&lt;?php /* You can place here your <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> and event handlers AddEventHandler(<span class="hljs-string"><span class="hljs-string">"module"</span></span>, <span class="hljs-string"><span class="hljs-string">"EventName"</span></span>, <span class="hljs-string"><span class="hljs-string">"FunctionName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> FunctionName(params) { //code } */ AddEventHandler(<span class="hljs-string"><span class="hljs-string">'form'</span></span>, <span class="hljs-string"><span class="hljs-string">'onBeforeResultAdd'</span></span>, <span class="hljs-string"><span class="hljs-string">'my_onBeforeResultAdd'</span></span>); CModule::IncludeModule(<span class="hljs-string"><span class="hljs-string">'cleantalk.antispam'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> my_onBeforeResultAdd(<span class="hljs-variable"><span class="hljs-variable">$WEB_FORM_ID</span></span>, <span class="hljs-variable"><span class="hljs-variable">$arFields</span></span>, <span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$ct_status</span></span> = COption::GetOptionString(<span class="hljs-string"><span class="hljs-string">'cleantalk.antispam'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ct_status</span></span> == 1) { global <span class="hljs-variable"><span class="hljs-variable">$APPLICATION</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>[<span class="hljs-string"><span class="hljs-string">'type'</span></span>] = <span class="hljs-string"><span class="hljs-string">'comment'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>[<span class="hljs-string"><span class="hljs-string">'sender_email'</span></span>] = isset(<span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]) ? <span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] : <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>[<span class="hljs-string"><span class="hljs-string">'sender_nickname'</span></span>] = isset(<span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'nickname'</span></span>]) ? <span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'nickname'</span></span>] : <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>[<span class="hljs-string"><span class="hljs-string">'message_title'</span></span>] = isset(<span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'title'</span></span>]) ? <span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'title'</span></span>] : <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>[<span class="hljs-string"><span class="hljs-string">'message_body'</span></span>] = isset(<span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'message'</span></span>]) ? <span class="hljs-variable"><span class="hljs-variable">$arrVALUES</span></span>[<span class="hljs-string"><span class="hljs-string">'message'</span></span>] : <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$aResult</span></span> = CleantalkAntispam::CheckAllBefore(<span class="hljs-variable"><span class="hljs-variable">$aParams</span></span>, FALSE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isset(<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>) &amp;&amp; is_array(<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>[<span class="hljs-string"><span class="hljs-string">'errno'</span></span>] == 0) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>[<span class="hljs-string"><span class="hljs-string">'allow'</span></span>] == 1) { //Not spammer - just <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preg_match(<span class="hljs-string"><span class="hljs-string">'//u'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>[<span class="hljs-string"><span class="hljs-string">'ct_result_comment'</span></span>])) { <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>=preg_replace(<span class="hljs-string"><span class="hljs-string">'/^[^\*]*?\*\*\*|\*\*\*[^\*]*?$/iu'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>[<span class="hljs-string"><span class="hljs-string">'ct_result_comment'</span></span>]); <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>=preg_replace(<span class="hljs-string"><span class="hljs-string">'/&lt;[^&lt;&gt;]*&gt;/iu'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>=preg_replace(<span class="hljs-string"><span class="hljs-string">'/^[^\*]*?\*\*\*|\*\*\*[^\*]*?$/i'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>,<span class="hljs-variable"><span class="hljs-variable">$aResult</span></span>[<span class="hljs-string"><span class="hljs-string">'ct_result_comment'</span></span>]); <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>=preg_replace(<span class="hljs-string"><span class="hljs-string">'/&lt;[^&lt;&gt;]*&gt;/i'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$APPLICATION</span></span>-&gt;ThrowException(<span class="hljs-variable"><span class="hljs-variable">$err_str</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } } } ?&gt;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Actually, the code is very simple: collecting parameters from a form, calling a check, analyzing the result.  This is the way all methods of the module itself for checking forms are made.  If you need to add protection for the next necessary form for customers, we simply add a method similar to the one given.  This can be seen by looking at the module code itself. <br><br>  The <b>$ WEB_FORM_ID parameter is</b> not checked, it can be added if necessary. <br><br>  Note that when checking inside the <b>CleantalkAntispam :: CheckAllBefore ()</b> function, a JavaScript test is used.  The test code is installed automatically on the site pages when the module is turned on (including in the module settings), and calling <b>CleantalkAntispam :: CheckAllBefore () is</b> also needed when the module is <b>turned</b> on, otherwise the JavaScript test will fail. <br><br>  Also note that the <b>$ aResult ['stop_queue']</b> response flag is not parsed here.  This flag speaks of obvious spam and is used, for example, in approving comments: if it is set, the comment is rejected; if cleared, it is sent to manual moderation.  You can easily add such a check yourself.  Detailed information about the CleanTalk API <a href="https://cleantalk.org/help/api-main">is here</a> . </div><p>Source: <a href="https://habr.com/ru/post/302800/">https://habr.com/ru/post/302800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302788/index.html">As a programmer, I bought a car</a></li>
<li><a href="../302792/index.html">Google fixed multiple vulnerabilities in Android</a></li>
<li><a href="../302794/index.html">Gloves for those who complicate things</a></li>
<li><a href="../302796/index.html">Unity3D Speed ‚Äã‚Äãup drawing 2D animations at times? Easy</a></li>
<li><a href="../302798/index.html">How to build a competent testing system? Insights from QA experts: video and presentations from the meeting in Wrike</a></li>
<li><a href="../302802/index.html">How game statistics differ from these playtests</a></li>
<li><a href="../302804/index.html">A minor feature of CHAR and VARCHAR</a></li>
<li><a href="../302806/index.html">Static time analysis demystified. Part 2</a></li>
<li><a href="../302808/index.html">Servers under control</a></li>
<li><a href="../302812/index.html">Not all hyper-convergent solutions are equally useful, or what about the muddy marketing stream ‚Äúwe also have HCI‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>