<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a widget that uses the Yandex.Metrics API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not long ago, Yandex.Metrika announced an open API with which you can access almost all Metric functions from your own program. 
 Today I want to talk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a widget that uses the Yandex.Metrics API</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/b3c8cbdb/94aa4f84/d16f604f/40e3899b.png" align="left">  Not long ago, Yandex.Metrika announced <a href="">an open API</a> with which you can access almost all Metric functions from your own program. <br>  Today I want to talk a little about using this API and how to create a simple widget for Android devices based on it. <br><br><a name="habracut"></a><br><h4>  API Basics </h4><br>  The Yandex.Metrick API is built on the REST principle.  Everything that can be controlled through the API is represented by a resource: counters, targets, filters, etc.  Resource operations (reading, deleting, changing) are performed via HTTP requests to the servers of the Ya.Metrika API, each type of operation has its own HTTP method: <br><ul><li>  GET: reading content </li><li>  POST: add resource </li><li>  PUT: Resource Change </li><li>  DELETE: delete resource </li></ul><br>  For example, to get a list of counters, you need to refer to the resources counters: <code>GET /counters</code> .  For information on a single counter, refer to the resource by its identifier: <code>GET /counter/{id}</code> .  For deletion, access the same resource, but using the DELETE method: <code>DELETE /counter/{id}</code> . <br><br>  Input for REST calls and results can be encoded in two formats: XML and JSON.  In the future, we will use JSON, as a more compact and convenient format for displaying on structures used in programming languages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Naturally, working through the API is possible only with meters that can be accessed from your J. Metrics account.  To identify the account owner, OAuth authentication is used.  It is arranged very simply.  A developer who wants to use the Ya.Metrika API registers his application (see <a href="">instructions</a> ) and obtains an application identifier.  By registering the application, you can get a <a href="">debugging OAuth token</a> for it and immediately start working with the Metrics API.  The debugging token will allow work with the meters available from the account of the developer who registered the application.  The token must be passed in each HTTP request, either as an additional parameter in the URL ( <code>...&amp;oauth_token=&lt;acces_token&gt;</code> ), or as a header in the HTTP request <code>Authorization: OAuth &lt;access_token&gt;</code> . <br><br>  In order for the application to work with arbitrary counters, and not only with the available developer, you need a separate OAuth token for each user of the application.  How to get it: <br><ol><li>  The safest way is when a user is redirected by an application to a special Yandex page, authenticates on it, and (if he hasn‚Äôt already done so) gives the application access to his counters.  After that, the user is redirected back to the application, and the URL to which the redirection is sent contains the parameter with the OAuth token for this user.  The application should read this parameter and remember the token.  Details of this procedure are described in the <a href="">manual</a> . </li><li>  Applications can also receive a token by directly requesting a username and password from the user, transferring them to OAuth to the Yandex server, and receiving the token in response.  This method is less secure: login and password are requested and transmitted explicitly. </li></ol><br>  Through the use of REST, the simplest work with the API (read requests) is possible directly from the browser, without any coding.  For example, <a href="">this request</a> will display information about the meter in the demo account of the API Ya.Metriki.  <a href="">Such a request</a> will issue a report on the attendance of the counter. <br><br>  Despite the simplicity of the REST interface, to fully use the API in a program written in a high-level language, you need to perform quite a lot of gestures: generating request URLs, sending HTTP requests and receiving results, generating and parsing JSON, handling errors, etc.  To simplify life, I created a ready-made library for working with the Ya.Metrika API in Java: <a href="https://github.com/Arturus/Metrika4j">Metrika4j</a> .  The library code is distributed under the Apache License, you can freely change and supplement it to your requirements.  Next, I will tell you how to create a widget for Android devices using this library that displays site traffic. <br><br><h4>  Metrika4j </h4><br>  Metrika4j allows you to work with Yandex.Metrica, using familiar Java developer concepts (classes, function calls, types) and not thinking about low-level work with HTTP and JSON.  The central interface of the library is <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/MetrikaApi.html">MetrikaApi</a> .  It has methods for working with the main entities of the Metrics: counters and reports.  Work with additional entities (targets, filters, etc.) is rendered into separate mini-APIs, obtained from the main class <code>MetrikaApi</code> . <br><br>  The structure of the methods roughly corresponds to the structure of the REST-calls of the Ya.Metrika API.  The arguments passed to the REST call correspond to the arguments passed to the API methods (except for the report management API, which we describe separately). <br>  Metrika4j supports out of the box two libraries for working with JSON: the <a href="http://jackson.codehaus.org/">Jackson JSON processor</a> and <a href="http://www.json.org/java/index.html">org.json</a> .  For Jackson, 100% of the functionality is supported, for org.json - a minimum sufficient for working with reports: reading the list of counters and receiving reports.  The org.json library is built into the Andriod API, so its use is convenient for Android applications.  If necessary, the developer can use any other JSON library by implementing the <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/json/JsonMapper.html">JsonMapper</a> and <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/json/JsonObject.html">JsonObject</a> interfaces with it. <br><br><h5>  Using Metrika4j </h5><br>  First you need to create an instance of <code>MetrikaApi</code> using <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/ApiFactory.html">ApiFactory</a> .  When creating, you need to pass the user's OAuth-token: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   API,  - API   Jackson JSON processor MetrikaApi api = ApiFactory.createMetrikaAPI( "05dd3dd84ff948fdae2bc4fb91f13e22", new JacksonMapper());</span></span></code> </pre> <br><br>  Then, using the created instance, you can perform any operations: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//       Counter[] myCounters = api.getCounters(); //   Counter newCounter = new Counter(); newCounter.setSite("mysite.ru"); newCounter.setName(" "); Counter createdCounter = api.createCounter(newCounter); //  createdCounter   ,   ,    , //  ,  Id System.out.println(createdCounter.getId()); //   api.deleteCounter(createdCounter.id);</span></span></code> </pre><br><br><h5>  Work with reports </h5><br>  Through the API, almost all reports that exist in Metric are available.  The set of available reports is contained in the <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/Reports.html">Reports</a> class.  To build a selected report, call the <code>MetrikaApi.makeReportBuilder(Reports report, int counterId)</code> , which will return a special object - <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/ReportBuilder.html">ReportBuilder</a> report <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/ReportBuilder.html">builder</a> .  In the report builder, you must specify the required report parameters (time interval, sorting, etc.).  When all the parameters have been set, call the <code>ReportBuilder.build()</code> method, which will send the HTTP request to the Metrics API and return the report. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//    " "    id=2138128 ReportBuilder builder = api.makeReportBuilder(Reports.contentPopular, 2138128); //    (  )    Report report = builder.withDateFrom(MetrikaDate.yesterday()) .withDateTo(MetrikaDate.today()) .build();</span></span></code> </pre><br><br>  The report is returned in the form of a <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/Report.html">Report</a> object, which is a table with the results, plus some additional information (totals, a date interval to which the report relates, etc.).  Each row of the result table is a <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/ReportItem.html">ReportItem</a> object, data from which can be obtained by one of the <code>getXXX(String fieldName)</code> methods (similar to getting values ‚Äã‚Äãfrom the <code>ResultSet</code> using JDBC).  The field names and the additional data returned must be specified for each report in the documentation for the Yandex.Metrica API. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//     ReportItem[] items = report.getData(); for (ReportItem item : items) { System.out.printf("pageViews: %4d, url: %s", item.getInt("page_views"), item.getString("url")) .println(); }</span></span></code> </pre><br><br>  A more detailed description of working with Metrika4j is contained in <a href="http://arturus.github.com/Metrika4j/apidocs/ru/metrika4j/package-summary.html">Javadoc</a> . <br><br><h4>  Widget for Android </h4><br>  Having such powerful tools at your disposal as API Ya.Metriki and Metrika4j, you can solve any tasks, including the creation of alternative user interfaces to Yandex.Metrica.  But within the framework of this article we will limit ourselves to a more modest goal: we will create an Android widget that will show the current site traffic.  The widget source code is available on GitHub in the <a href="https://github.com/Arturus/MetrikaWidget">MetrikaWidget</a> project.  Just like the Metrika4j code, it is freely distributed with a minimum of licensing restrictions. <br><br><h5>  OAuth authorization </h5><br>  Let's start by creating <code>MetrikaApi</code> and authorization.  The application works with only one account, so an instance of <code>MetrikaApi</code> can be made Singleton.  Its code is contained in the <a href="">Globals</a> class. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MetrikaApi api; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> MetrikaApi </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (api == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   OAuth token  SharedPreferences String token = getOAuthToken(context); if (token == null) { throw new AuthException(); } else { //   org.json,   Android api = ApiFactory.createMetrikaAPI(token, new OrgJsonMapper()); } } return api; }</span></span></code> </pre><br><br>  If the application is launched for the first time and OAuth token is not yet in SharedPreferences, you need to get it.  To do this, go to the URL request token: <br><br><pre> <code class="java hljs">Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Intent.ACTION_VIEW, Uri.parse(<span class="hljs-string"><span class="hljs-string">"https://oauth.yandex.ru/authorize?response_type=token&amp;client_id=1359488e196b4bfa92615d0885b106d4"</span></span>)); startActivity(intent);</code> </pre><br><br>  For the user, it will look like the opened page ‚ÄúApplication requests access to your data on Yandex‚Äù.  Suppose a user has successfully logged in and allowed access.  Further interesting begins: how to transfer the token from the web interface back to our application?  To do this, you need to register one of the activities in the application, as a handler for a protocol specific to our application (specific - so that our handler does not intersect with other applications).  In <code>AndroidManifest.xml</code> we specify the following: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ru.metrikawidget.AuthTokenActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"OAuth"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.VIEW"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.category.BROWSABLE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:scheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"metwd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:host</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"oauthtoken"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We registered <a href="">AuthTokenActivity</a> as a handler for the metwd protocol for the pseudo-host oauthtoken.  Now it is enough to specify the Callback URI <code>metwd://oauthtoken</code> in the <a href="https://oauth.yandex.ru/client/my">settings of the registered application</a> , and after successful OAuth authentication of the user <code>AuthTokenActivity</code> will be called.  In this activity, you need to parse the resulting string and save the token in SharedPreferences: <br><br><pre> <code class="java hljs">String fragment = getIntent().getData().getFragment(); String[] parts = fragment.split(<span class="hljs-string"><span class="hljs-string">"\\&amp;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String part : parts) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (part.startsWith(<span class="hljs-string"><span class="hljs-string">"access_token="</span></span>)) { String token = part.substring(param.length(), part.length()); <span class="hljs-comment"><span class="hljs-comment">//     preferences getSharedPreferences(Globals.PREF_FILE, 0) .edit() .putString(Globals.PREF_TOKEN, token) .commit(); } }</span></span></code> </pre><br><br><h5>  Data retrieval </h5><br>  The data retrieval code for the widget is extremely simple: <br><br><pre> <code class="java hljs">MetrikaApi api = Globals.getApi(context); <span class="hljs-comment"><span class="hljs-comment">//    Metrika API Report report = api.makeReportBuilder(Reports.trafficSummary, counterId) .withDateFrom(new MetrikaDate()) .withDateTo(new MetrikaDate()) .build(); return new Result(report.getTotals().getInt("visits"));</span></span></code> </pre><br><br>  The nuance is that this code can not be performed "in the forehead."  The API Metrics servers respond fairly quickly, but the HTTP request itself can go to the server and back over slow and unreliable mobile channels.  As a result, the widget that is waiting for a response will ‚Äúfreeze‚Äù from the point of view of the Android OS, and a window will be issued, offering to crash the hung application.  This is clearly not what we need.  Therefore, all requests to the Metrics API are performed asynchronously using the <a href="http://developer.android.com/reference/android/os/AsyncTask.html">AsyncTask</a> class.  Here is a simplified code for loading the list of counters (the full version is in the <a href="">WidgetSetupActivity</a> class): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CountersLoadTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Counter</span></span></span><span class="hljs-class">[]&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ProgressDialog progressDialog; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPreExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ progressDialog = ProgressDialog.show(...); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Counter[] counters)</span></span></span><span class="hljs-function"> </span></span>{ progressDialog.dismiss(); counterList.addAll(Arrays.asList(counters)); <span class="hljs-comment"><span class="hljs-comment">//  ,      listAdapter.notifyDataSetChanged(); } protected Counter[] doInBackground(Void... voids) { return Globals.getApi(WidgetSetupActivity.this).getCounters(); } }</span></span></code> </pre><br><br>  For widgets, working with data is a little more difficult.  Let's start with the fact that the widget provider that receives events ‚Äúit's time to update the widget‚Äù, in Android terminology, is the <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">broadcast receiver</a> .  The life cycle of a broadcast receiver is short: it processes the event, and then immediately dies.  If you start a stream from the event handler, then the receiver's death may occur before the stream finishes: sadness.  Android developer guide strongly recommends using services for such cases.  So <a href="">let's</a> do it: the widget provider ( <a href="">MetrikaWidgetProvider</a> ) receives events and sends them for processing to the <a href="">UpdateService</a> .  <code>UpdateService</code> , in turn, uses asynchronous data loading through <code>AsyncTask</code> (otherwise, we again get the ‚ÄúApplication Not Responding‚Äù window when waiting for a response from the API). <br><br><h5>  Widget display </h5><br>  Working with widgets on Android is a separate large topic that goes beyond the scope of this article and is well covered in both the Android <a href="http://developer.android.com/guide/topics/appwidgets/index.html">developer‚Äôs guide</a> and additional articles.  Therefore, I will tell you briefly, and for the details I will refer to the <a href="https://github.com/Arturus/MetrikaWidget/tree/master/widget/src/ru/metrikawidget">source code of the</a> classes <code>MetrikaWidgetProvider</code> and <code>UpdateService</code> . <br><br>  A widget can be in three states: ‚Äúdata received‚Äù, ‚Äúdata update‚Äù and ‚Äúno connection‚Äù.  Updating the widget occurs on a timer or when you click on the widget. <br><ul><li>  <i>The data is received</i> - the regular state of the widget, in which it displays the number of visits to the site today.  In this state, the widget displays a standard bar graph - ‚Äúrainbow‚Äù, which can be seen in the header of the Yandex.Metrica interface. </li><li>  <i>Data update</i> is an intermediate state, made solely for the convenience of the user, so that he receives visual feedback from the click on the widget.  The widget enters it before sending a request to the API Metrics, and exits after the completion of the request.  In this state, an inverted ‚Äúrainbow‚Äù is displayed. </li><li>  <i>No connection</i> - a state indicating that the actual data could not be obtained.  Displays a ‚Äúrainbow‚Äù with reduced saturation, almost gray. </li></ul><br><br>  If the widget can be in the "no connection" state, it would be logical to update it when this connection appears, so that the user can immediately see the actual data.  To do this, the widget provider subscribes to system events related to the change in the status of the network interface: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ru.metrikawidget.MetrikaWidgetProvider"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.appwidget.action.APPWIDGET_UPDATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.net.conn.BACKGROUND_DATA_SETTING_CHANGED"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.net.conn.CONNECTIVITY_CHANGE"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  When such an event is received, a check is made whether the connection has appeared, and an update is called: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intent.getAction().equals(ConnectivityManager.CONNECTIVITY_ACTION)) { <span class="hljs-comment"><span class="hljs-comment">//     Internet NetworkInfo info = intent.getParcelableExtra(ConnectivityManager.EXTRA_NETWORK_INFO); if (info != null &amp;&amp; info.isConnected() &amp;&amp; !info.isRoaming()) { //   ,  ,      "offline" ... } }</span></span></code> </pre><br><br><h4>  Install Widget </h4><br>  The widget can be compiled from source code located in the <a href="https://github.com/Arturus/MetrikaWidget">MetrikaWidget</a> project. <br><br>  You are not an Android developer, but you want to use the widget?  No problem - you can download the finished widget.  Release from <a href="https://market.android.com/details%3Fid%3Dru.metrikawidget">Android Market</a> or debug build with <a href="https://github.com/Arturus/MetrikaWidget/MetrikaWidget-debug.apk/qr_code">GitHub</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c15/efe/2df/c15efe2df3083eeff6afdc6be7cd6543.gif" alt="image"><br><br>  After installation, you will also have the ‚ÄúYa.Metrika‚Äù application, which is actually a mini-instruction for the widget. </div><p>Source: <a href="https://habr.com/ru/post/127940/">https://habr.com/ru/post/127940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127931/index.html">ItamItut.ru new photo synchronization service in social networks</a></li>
<li><a href="../127932/index.html">How do we ‚Äúback up‚Äù servers in Amazon and fend off piranhas</a></li>
<li><a href="../127934/index.html">REG.RU + Masterhost: short Q & A</a></li>
<li><a href="../127935/index.html">HelpDesk under the hood. Audit of creating user accounts in AD</a></li>
<li><a href="../127938/index.html">Get up, Russia!</a></li>
<li><a href="../127941/index.html">Some features of the development of the portal for the provision of public services to inform about the results of the Unified State Exam using DotNetNuke</a></li>
<li><a href="../127942/index.html">Original Antivirus Test</a></li>
<li><a href="../127943/index.html">Natural string sorting in javascript</a></li>
<li><a href="../127945/index.html">IFA 2011: Galaxy Note, Toshiba AT200, PocketBook A10 "</a></li>
<li><a href="../127947/index.html">".Toster" announces readiness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>