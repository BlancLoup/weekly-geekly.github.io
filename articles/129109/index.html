<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic applications with Ocsigen or Yob returns</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What makes a normal person a cold Sunday morning? Anyone will answer you: a man sleeps on a cold Sunday morning. Because he worked all week and wants ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic applications with Ocsigen or Yob returns</h1><div class="post__text post__text-html js-mediator-article"> What makes a normal person a cold Sunday morning?  Anyone will answer you: a man sleeps on a cold Sunday morning.  Because he worked all week and wants to rest. <br>  What does a programmer do on a cold Sunday morning?  On a cold Sunday morning, a programmer drinks hot tea and writes code.  He drinks tea because the morning is cold, and he has not woken up yet, but he writes the code because he wants to.  A programmer always wants to write code, only on weekdays he writes code for money and this makes him very tired, and on weekends for himself, therefore he rests. <br><br>  This morning we will be writing our first application for Ocsigen.  Those who wish would be well acquainted with the <a href="http://ocsigen.org/tutorial/intro">official manual</a> , however, you should not hope for much, because the manual is unfinished, replete with puzzled lines a la "??????"  and obscene language in French.  Therefore, I will be the main manual. <br><br>  As you may remember, we once <a href="http://habrahabr.ru/blogs/compilers/116301/">wrote an</a> interpreter for the Yoba language.  Since then, the interpreter has been slightly improved, allocated to a separate class, began to accept a line at the input, give the line to the output (instead of working with the console).  Now our task will be to <s>introduce Yobe as the main language of Google‚Äôs</s> transformation of the Yobe interpreter into a web application, and not simple - but client-side.  Although I added an operation counter to the class so that it would be impossible to get bogged down, but all the same - let the user spend computing power on his computer, and not on the server. <br><a name="habracut"></a><br>  First of all, we need to install the ocsigen server.  Since we did not manage to collect 2.0 for the distributions yet, we will follow <a href="http://ocsigen.org/install">this instruction</a> and install the server with a bundle in our home directory.  To make the bundle get right and tasty, before running make, edit the Makefile.config and write there: <br> <code>LOCAL := ${HOME}/bin/ocsigen <br> DEV := YES <br> OCAMLDUCE := YES <br> OCLOSURE := YES <br> OTHERS := YES</code> <br>  Ocaml and Findlib will not be collected, and so they are in the repositories.  We don‚Äôt need an O'Closure this time, but we‚Äôll collect it just in case, so that we don‚Äôt reassemble the oxygen, if you yourself become interested in it or want an article from me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, we immediately edit the file $ {HOME} /bin/ocsigen/etc/ocsigenserver/ocsigenserver.conf: make sure that there is a suitable port, as well as the name and group of the user, from which to start.  Now it's time to prepare a config for the future site.  Create $ {HOME} /bin/ocsigen/etc/ocsigenserver/conf.d/yoba.conf and fill it with the contents: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ocsigen</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">charset</span></span></span><span class="hljs-tag">&gt;</span></span>utf-8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">charset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">findlib-package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ocsigenserver.ext.staticmod"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">findlib-package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ocsigenserver.ext.ocsipersist-sqlite"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">database</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">file</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ocsidb"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">findlib-package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ocsigenserver.ext.deflatemod"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">findlib-package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"eliom.server"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostfilter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">site</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">static</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/home/username/yoba"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">eliom</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">module</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/home/username/yoba/_build/server/yoba.cmo"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache-size</span></span></span><span class="hljs-tag">&gt;</span></span>10000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache-size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">eliom</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">site</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">deflate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"only"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>application/x-javascript<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">deflate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ocsigen</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Briefly about the contents: <br><ul><li>  staticmod allows the server to give out static data (in our case it will be a compiled .js file </li><li>  ocsipersist-sqlite - allows us to work with persistent data, then we will see why this is necessary </li><li>  deflatemod, as expected, shakes the data when sending.  Below you can see in the site settings section deflate, which says that we press only js.  To the note: it is impossible to choose the compression method - gzip or deflate - it is selected automatically based on the client's expectations. </li><li>  eliom.server actually provides the entire server part of the framework </li><li>  In the hostfilter parameter of our host, we say that we are responding to all domains. </li><li>  And indicating an empty path for the site, we say that the site is located at the root of the domain.  By replacing the empty string with, say, ‚Äúyoba‚Äù, we will force our site along with all the static content to be sent to the <a href="http://hostname/yoba/">hostname / yoba address</a> ‚Äî a single profit, you can keep several sites on the same domain and shuffle them as you please </li><li>  / home / username / yoba will be our directory with the code (and the compiled file yoba.js), and _build / server will be the compiled server module.  Of course, ideally, you need to compile, then transfer the code to a separate daddy, and still not store static content in the same folder with the compiled module, but now we‚Äôll do that to quickly check the codec </li></ul><br><br>  Hooray!  Moving on to writing code. <br>  We create the notorious folder / home / username / yoba / and download the <a href="">archive with the Yoba language</a> - we have already written the language itself, and as it is a little bit to file and turn into a class, we are not interested, therefore we will take it immediately.  We unpack it into the same folder and download the standard <a href="http://sorokdva.net/Makefile.config">Makefile.config</a> and <a href="http://sorokdva.net/Makefile.rules">Makefile.rules</a> to the same place - the project build is not easy, you can write a fig file from scratch. <br>  It is time to correct something and immediately find out about the first syntactic innovations: <b>in Eliom, the code can be placed in a section.</b>  <b>The <i>{server {...}}</i> section (the same as the code is just without a section) is compiled and executed on the server, the <i>{client {...}}</i> section is on the client, and <i>{shared {...}}</i> is available both there and there.</b> <br>  Since our interpreter will work on the client, we rename the yobaLang.ml file in yobaLang.eliom, open it, and at the very beginning add the line "{client {", and replace it with ";;"  (two semicolons are the end of the instruction only at the top level of the code, inside the section they cannot be used anymore) on "}}".  The generated ocamllex and ocamlyacc code we will likewise rule in the makefile when we write it. <br>  In the meantime, let's write a file that will do everything.  Let's call it, say, home.eliom. <br>  At the beginning of the file we open the modules for the future and immediately create a line with the model code that will be offered to the visitor. <br><pre> <code class="hljs swift">{shared{ <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Eliom_pervasives</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Lwt</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">HTML5</span></span>.<span class="hljs-type"><span class="hljs-type">M</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Eliom_parameters</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Eliom_request_info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Eliom_output</span></span>.<span class="hljs-type"><span class="hljs-type">Html5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-type"><span class="hljs-type">Ocsigen_extensions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> code_example = ref <span class="hljs-string"><span class="hljs-string">"                    1     2                                       1     50            "</span></span> }}</code> </pre> <br><br>  Next, we will create a module of our application - in order for client-server interaction to work correctly, all services are registered on behalf of an application.  Fortunately, this is easy: <br><pre> <code class="hljs cs">module My_appl = Eliom_output.Eliom_appl ( <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> application_name = <span class="hljs-string"><span class="hljs-string">"yoba"</span></span> end)</code> </pre> <br><br>  Add a function that will execute the code on Yobe and return the result, the function will be purely client, the server will not even know about it <br><pre> <code class="hljs cs">{client{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> yoba_execute str = ( <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> yparser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YobaLang.yoba_interpretator () <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> yparser<span class="hljs-meta"><span class="hljs-meta">#parse str; yparser#get_output) }}</span></span></code> </pre> <br><br>  Create a service that will process user requests.  Services in ocsigen are extremely easy and convenient to create; each service is characterized by a set of strictly typed (!) GET / POST parameters.  Accordingly, the server decides which service to process the request on the basis of the incoming request.  You can create a default service that will process requests without parameters, a second service at the same address that will handle requests with one GET parameter, and a third service with one POST parameter.  And they will not be confused.  But for now we need only one service: <br><pre> <code class="hljs 1c">let empty_service = Eliom_services.service <span class="hljs-symbol"><span class="hljs-symbol">~path</span></span>:[<span class="hljs-string"><span class="hljs-string">""</span></span>] <span class="hljs-symbol"><span class="hljs-symbol">~get_params</span></span>:(Eliom_parameters.unit) ();;</code> </pre> <br>  The path symbolizes that the service will be given on the default path for the site (as an index page in Apache), and in ~ get_params we indicated that the service does not accept parameters. <br><br>  It's time to write a page template: <br><pre> <code class="hljs 1c">let page_template code_input counter_value = html (head (title (pcdata <span class="hljs-string"><span class="hljs-string">"Yoba interpreter"</span></span>)) [] ) (body [ h1 [pcdata <span class="hljs-string"><span class="hljs-string">"Yoba! For human beings"</span></span>]; p [pcdata <span class="hljs-string"><span class="hljs-string">"  !  ‚Äî  !"</span></span>]; div [ raw_textarea <span class="hljs-symbol"><span class="hljs-symbol">~a</span></span>:[a_id <span class="hljs-string"><span class="hljs-string">"clientcode"</span></span>] <span class="hljs-symbol"><span class="hljs-symbol">~name</span></span>:<span class="hljs-string"><span class="hljs-string">"clientcode"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">~rows</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-symbol"><span class="hljs-symbol">~cols</span></span>:<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-symbol"><span class="hljs-symbol">~value</span></span>:code_input (); raw_button <span class="hljs-symbol"><span class="hljs-symbol">~button_type</span></span>:`Button <span class="hljs-symbol"><span class="hljs-symbol">~name</span></span>:<span class="hljs-string"><span class="hljs-string">"clientbutton"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">~a</span></span>:[a_id <span class="hljs-string"><span class="hljs-string">"clientbutton"</span></span>] <span class="hljs-symbol"><span class="hljs-symbol">~value</span></span>:<span class="hljs-string"><span class="hljs-string">"!"</span></span> [pcdata <span class="hljs-string"><span class="hljs-string">"!"</span></span>]; ]; pre <span class="hljs-symbol"><span class="hljs-symbol">~a</span></span>:[a_id <span class="hljs-string"><span class="hljs-string">"clientoutput"</span></span>] []; hr (); p [pcdata <span class="hljs-string"><span class="hljs-string">"-  : "</span></span>; b [pcdata (string_of_int counter_value)]] ]);;</code> </pre> <br>  As you can see, all page elements are functions that take strictly defined parameters as input, due to which static typing of the generated HTML page is carried out.  So, the html function accepts two parameters as input - one of type `Head, and the second of type` Body.  And div - takes as input a list of allowed elements inside the div. <br><br>  But we will dwell on the other.  First, our page_template function accepts two parameters for input: a code and a visitors counter.  The first is placed in the textarea, and the second is placed inside the &lt;p&gt; tag at the very bottom.  Secondly, the names of the raw_textarea and raw_button functions are such ‚Äúraw‚Äù for a reason.  There are similar simple non- ‚Äúraw_‚Äù functions, but they are designed to create elements inside the wonderful strictly typed forms that necessarily refer to some service (in other words, when creating a form, we immediately check that it will send where it is necessary to parameters).  And our textarea and button (this is not the &lt;input&gt; tag, but the most natural &lt;button&gt; tag from HTML5) will not send anything anywhere, but will frolic inside the page, therefore they are not supposed to take forms.  Thirdly, we created a special &lt;pre&gt; in which the results of our interpreter's work will be stored. <br><br>  By the way, did I mention the visitor counter?  I completely forgot, let's write it.  To do this, immediately get acquainted with two new modules: Lwt and Ocsipersist.  The first is responsible for working with cooperative streams, and the second is for persistent storage. <br>  The flow system in the oxygen is cooperative.  This means that instead of the traditional threads that require the creation of a new process, a stack of calls and other Labuda, we get very lightweight flows (so lightweight that they are used for almost every call).  Instead of creating nonsense, we turn to threads to create so-called code in the code.  points of cooperation, on the basis of which the compiler itself does everything that is needed, minimizing the likelihood of deadlock. <br><pre> <code class="hljs kotlin">let get_count = let counter_store = Ocsipersist.open_store <span class="hljs-string"><span class="hljs-string">"counter_store"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> let cthr = Ocsipersist.make_persistent counter_store <span class="hljs-string"><span class="hljs-string">"countpage"</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> let mutex = Lwt_mutex.create () <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; cthr &gt;&gt;= (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> c -&gt; Lwt_mutex.lock mutex &gt;&gt;= </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">fun</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ()</span></span></span></span> -&gt; Ocsipersist.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> c &gt;&gt;= (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> oldc -&gt; let newc = oldc + 1 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> Ocsipersist.</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">set</span></span></span><span class="hljs-function"> c newc &gt;&gt;= </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">fun</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ()</span></span></span></span> -&gt; Lwt_mutex.unlock mutex; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newc) ) ) ) ) ;;</code> </pre> <br>  If you are unaccustomed to OCaml (as I initially), then you will notice that our function is tricky.  The get_count itself is an ‚Äúobject‚Äù that stores the mutex and the storage object.  When we write ‚Äúget_count‚Äù in the code, we return a function that accepts input () and only then does all the work.  Climb now inside the function.  We immediately see the tricky operator "&gt;&gt; =" - this is a special operator that passes the result of the first argument ‚Äî the thread ‚Äî to the input of the second argument ‚Äî the function that creates the new thread.  Formally speaking, the signature of the operator is as follows: <br><pre> <code class="hljs rust">val (&gt;&gt;=) : <span class="hljs-symbol"><span class="hljs-symbol">'at</span></span> -&gt; (<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> -&gt; <span class="hljs-symbol"><span class="hljs-symbol">'bt</span></span>) -&gt; <span class="hljs-symbol"><span class="hljs-symbol">'bt</span></span></code> </pre> <br>  And the return function at the very end returns the result of the thread. <br>  With Ocsipersist, everything is clear, even nothing to tell. <br><br>  Where will we call our get_count and generate a page template?  Here it is, the interpret function: <br><pre> <code class="hljs rust"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> interpret code = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> req = Eliom_request_info.get_ri () <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> Lazy.force_val req.ri_referer with | <span class="hljs-literal"><span class="hljs-literal">None</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">""</span></span> | <span class="hljs-literal"><span class="hljs-literal">Some</span></span> x -&gt; x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Ocsigen_messages.accesslog (<span class="hljs-string"><span class="hljs-string">"Referer: "</span></span> ^ <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>); get_count() &gt;|= (page_template code);;</code> </pre> <br>  This feature introduces us to several more interesting features.  Oksigen, alas, writes to the log only brief information about requests - who, what user agent, which host, which page, when.  And I wanted to get more referer.  Well, we get information about the request, get the referrer out of it.  It is arranged cleverly again - this is a value that may not be (like Null in other languages), and which is also wrapped in a lazy calculation, that is, until I requested it, it was not stored anywhere. <br>  Another new operator "&gt; | =" is similar to "&gt;&gt; =" - with the only difference that the result of the work of the thread is transferred to the input of the function that the new thread does not plan to return at all. <br><br>  Everything came to an end.  It's time to register our service and learn the code to be interpreted: <br><pre> <code class="hljs kotlin">My_appl.register empty_service (<span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> () -&gt; Eliom_services.onload {{ Js.Opt.iter (Dom_html.document##getElementById (Js.string <span class="hljs-string"><span class="hljs-string">"clientbutton"</span></span>)) ( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> clntbutton -&gt; clntbutton##onclick </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;- Dom_html.handler (fun _ -&gt;</span></span></span><span class="hljs-function"> Js.Opt.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iter</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Dom_html.document##getElementById (Js.string </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"clientcode"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>) ( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> cdinput -&gt; Js.Opt.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iter</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Dom_html.document##getElementById (Js.string </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"clientoutput"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>) ( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> cdoutput -&gt; let cdinputarea = Dom_html.CoerceTo.textarea cdinput </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> Js.Opt.iter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cdinputarea</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">fun</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x -&gt; let i = Js.to_string x##value </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cdoutput##innerHTML &lt;- Js.string (yoba_execute i)</span></span></span></span> ) ) ); Js._true ) ) }}; interpret !code_example);;</code> </pre> <br>  The block <b>{{...}}</b> is like a client function - we register it in the page onload handler. <br>  In the client code, our syntax is slightly different.  To refer to methods of Js-objects, instead of a single sharp the double is used, thus Dom_html.document ## getElementById corresponds to a simple "document.getElementById". <br>  The numerous Js.Opt.iter that can be observed here are due to the fact that the getElementById function does not necessarily return anything to us.  Accordingly, Js.Opt.iter will perform an action on the result only if the result really is.  Therefore, for the three objects on the page we were looking for, it took us four Js.Opt.iter.  Four - because by default, the getElementById function returns an object of type element, which has only the most general properties.  And in order to get to the value property in textarea, we are trying to build (Dom_html.CoerceTo) our object into the textarea type, which does not guarantee the result in general. <br><br>  Thus, the registered service handler does only two things - it calls the Js code at the start of the page and returns us our template mentioned above. <br><br>  The attentive reader might have already noticed and wondered why I declared code_example at the very beginning as a reference to the string (ref), and then I dereference it everywhere.  And the thing is that at some point it occurred to me that our Yoba should really be a collective one.  Let's save what the user tried to interpret and show to others. <br>  To do this, next to the first service, we will create a specially trained second service, which will take as input a line with the code and put it in the code_example.  To call the service from javascript, create it on behalf of Eliom_output.Caml: <br><pre> <code class="hljs kotlin">let update_code_service = Eliom_output.Caml.register_service ~path:[<span class="hljs-string"><span class="hljs-string">"update code"</span></span>] ~get_params:(string <span class="hljs-string"><span class="hljs-string">"f"</span></span>) (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; code_example := f; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ());;</code> </pre> <br><br>  Now we change our client function (which is the innermost) by adding just one line: <br><pre> <code class="hljs vbscript"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = Js.to_string x##value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ignore(Eliom_client.call_caml_service ~service:%update_code_service i ()); cdoutput##innerHTML &lt;- Js.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> (yoba_execute i)</code> </pre> <br>  Voila!  Now everyone who came to our page will see the code that was executed last.  True, when restarting the server, our example will still return to the site. <br><br>  Finally, write the Makefile: <br><pre> <code class="hljs smalltalk"><span class="hljs-type"><span class="hljs-type">MODULE</span></span> = yoba <span class="hljs-type"><span class="hljs-type">APP</span></span> = yoba include <span class="hljs-type"><span class="hljs-type">Makefile</span></span>.config <span class="hljs-type"><span class="hljs-type">SERVERFILES</span></span> := home.eliom <span class="hljs-type"><span class="hljs-type">CLIENTFILES</span></span> := yobaType.ml yobaLexer.eliom yobaParser.eliom yobaLang.eliom home.eliom <span class="hljs-type"><span class="hljs-type">SERVERLIB</span></span> := -package eliom.server,ocsigenserver,lwt <span class="hljs-type"><span class="hljs-type">CLIENTLIB</span></span> := -package js_of_ocaml <span class="hljs-type"><span class="hljs-type">INCLUDES</span></span> = <span class="hljs-type"><span class="hljs-type">EXTRADIRS</span></span> = include <span class="hljs-type"><span class="hljs-type">Makefile</span></span>.rules yobaParser.eliom: ocamlyacc yobaParser.mly echo <span class="hljs-string"><span class="hljs-string">'{client{'</span></span> &gt;yobaParser.eliom cat yobaParser.ml &gt;&gt;yobaParser.eliom echo <span class="hljs-string"><span class="hljs-string">'}}'</span></span> &gt;&gt;yobaParser.eliom sed -i <span class="hljs-string"><span class="hljs-string">'s/;;//'</span></span> yobaParser.eliom rm yobaParser.ml yobaParser.mli yobaLexer.eliom: yobaParser.eliom ocamllex yobaLexer.mll echo <span class="hljs-string"><span class="hljs-string">'{client{'</span></span> &gt;yobaLexer.eliom cat yobaLexer.ml &gt;&gt;yobaLexer.eliom echo <span class="hljs-string"><span class="hljs-string">'}}'</span></span> &gt;&gt;yobaLexer.eliom sed -i <span class="hljs-string"><span class="hljs-string">'s/;;//'</span></span> yobaLexer.eliom rm yobaLexer.ml _build/client/yobaLexer.cmo: _build/client/yobaParser.cmo _build/client/yobaLang.cmo: _build/client/yobaLexer.cmo _build/client/yobaParser.cmo <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">STATICDIR</span></span>)/<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">APP</span></span>).js: _build/client/<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MODULE</span></span>}.cmo <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">JS_OF_ELIOM</span></span>} -jsopt -pretty -verbose <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">CLIENTLIB</span></span>} -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$^</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#yui</span></span>-compressor --charset utf<span class="hljs-number"><span class="hljs-number">-8</span></span> <span class="hljs-string"><span class="hljs-string">$@</span></span> &gt; <span class="hljs-string"><span class="hljs-string">$@</span></span>_min <span class="hljs-symbol"><span class="hljs-symbol">#mv</span></span> <span class="hljs-string"><span class="hljs-string">$@</span></span>_min <span class="hljs-string"><span class="hljs-string">$@</span></span> pack: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">STATICDIR</span></span>)/<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">APP</span></span>).js</code> </pre> <br>  Since we need to generate yobaLexer.eliom and yobaParser.eliom, we wrote the appropriate rules for this.  Similarly, alas, the default dependency generator does not cope with the definition of the order in which to compile our lexer and parser, so we helped it with a couple of rules. <br>  Now you can run: <br> <code>make depend <br> make <br> make pack</code> <br>  The first one will generate a compilation order, the second one will compile the server code, and the third one will generate a javascript file that will be automatically called by the server part, although we did not register this call in the page template.  If you uncomment the yui-compressor call and the subsequent mv, then you can compress the js-code a little bit (in my case from 400kb to 209kb). <br>  It is necessary to execute all instructions, having registered the export PATH, about which the ocsigenserver assembly told you at the very end. <br><br>  After that go to $ HOME / bin / ocsigen / bin and say ./ocsigenserver <br>  Open the browser and go to try to interpret.  And if I'm lazy myself, then you can frolic with me: <a href="http://sorokdva.net/">sorokdva.net</a> </div><p>Source: <a href="https://habr.com/ru/post/129109/">https://habr.com/ru/post/129109/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129102/index.html">Site for launching a little-known product on the market</a></li>
<li><a href="../129103/index.html">Meeting with Opera staff in Moscow</a></li>
<li><a href="../129105/index.html">FreeRTOS: introduction</a></li>
<li><a href="../129106/index.html">Zoomify: Looking for the whole picture</a></li>
<li><a href="../129107/index.html">Django and Selenium Integration</a></li>
<li><a href="../129111/index.html">Daily Sales - aggregator of discount offers from Chinese online stores</a></li>
<li><a href="../129114/index.html">Cheap and fast usability testing</a></li>
<li><a href="../129117/index.html">Flood-it game automation</a></li>
<li><a href="../129118/index.html">Software spectrum analyzer on a conventional WiFi-card</a></li>
<li><a href="../129121/index.html">Report on meeting Apple Developers Community # 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>