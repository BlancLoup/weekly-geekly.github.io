<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Back to the future with WebAssembly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to you the translation of the article ‚ÄúBack To The Future With WebAssembly‚Äù by Attila V√°g√≥. 

 This post is a translation of the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Back to the future with WebAssembly</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I present to you the translation of the article <a href="https://hmh.engineering/back-to-the-future-with-webassembly-9a12ab6ec33">‚ÄúBack To The Future With WebAssembly‚Äù</a> by Attila V√°g√≥. <br><br><h4>  This post is a translation of the article, which describes the properties of WebAssemly and Emscripten.  <a href="https//hmh.engineering/back-to-the-future-with-webassembly-9a12ab6ec33">Original</a> article in English. </h4><br>  <i>The author of the article, Attila Vago, is a senior software developer at HMH.</i>  <i>Writes code, blogs and stuff on the Internet.</i>  <i>A polyglot of programming languages, a pragmatic leader, with a passion for JavaScript and easy access.</i>  <i>An easily inspired and inspiring person with a strong passion for nerds, great food, craft beer and Lego.</i>  <i>Uses Mac.</i>  <i>Do exercises at 6 in the morning.</i> <br><br><p>  In 2011, I wrote my first independent line of code not in HTML (I worked with it in 2007), and it was written in that same good C that Professor David J. Malan from Harvard University taught.  He will forever remain my instigator not only in the study of programming, but also in software thinking.  I also remembered that making a peanut butter sandwich was just for me, but it‚Äôs an incredibly difficult task for a computer and equally difficult for a person pretending to be a computer. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wEdvGqxafq8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><p>  If you watched the video, even the first 18 minutes (I know that it is long, but programming takes time), then you will understand why C is close to my heart to this day.  To my disappointment, I never learned it, because let's face it, for web developer C is the smallest of priorities.  I never had a real reason to dive deep into this language, despite buying countless Udemy courses and books on C, I never touched them (keep your judgmental views with you, you did as well) or lie to yourself that if I buy Pebble smart watches, which work on C, I will definitely write a code for them.  Yes exactly!  None of these reasons were compelling enough. </p><br><h4>  What is WebAssembly and how does it overtake JS? </h4><br><p>  WebAssembly (Wasm for short) is a binary instruction format for a stack virtual machine. </p><blockquote>  ‚ÄúWasm is designed as a portable platform for compiling high-level languages ‚Äã‚Äãsuch as C / C ++ / Rust, which allows you to deploy client and server applications on the Internet.‚Äù </blockquote>  - kindly explains webassembly.org <p></p><br><p>  In other words, the above means that you can write modules that work on the Internet, in a browser / server, but are written in languages ‚Äã‚Äãlike C, compiled into a binary file and therefore incredibly fast, as they work directly on the hardware of the machine.  Compared to them, scripting languages ‚Äã‚Äãsuch as JavaScript have several levels of abstraction between code and hardware, which, among other things, makes them slow.  Of course, this does not always matter, and each of them has its place in the program or even the web ecosystem. </p><br><p>  On this basis, Wasm's structure (initially) only supports integers and floating-point numbers, which gives more processing power and, therefore, is often used for implementations of the canvas type.  It is important to understand that WebAssembly does not pose a threat to JavaScript ‚Äî at least for now ‚Äî and, as you will see later in this article, C and JavaScript can actually live very happily in the same project and can run each other‚Äôs code.  Yes, something like that. </p>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Emscripten "sticks together" C and JS </h4><br><p>  Now hold on!  I know what I am saying.  You can't say things like running C in JS and vice versa, and expect the world not to react. No matter how strange it may sound, I am not deceiving. It turns out that Emscripten is a chain of tools for compiling in asm.js and WebAssembly, designed using LLVM (oh my god, I learned half of these things while typing the text of the article), which allows you to run C and C ++ on the Internet at almost native speed without plug-ins. </p><br><p>  Well, here's what you need to set aside for yourself.  Emscripten will help you compile the code written in C in WebAssembly, providing additional tools to ease the burden on the developer when it comes to communication between the two languages, and help launch Wasm in your web project.  The basic Emscripten compilation command is as follows: </p><br><pre><code class="plaintext hljs">emcc lib/strings.c -s WASM=1 -o public/strings.js</code> </pre> <br>  While not a basic command runs like this: <br><br><pre> <code class="plaintext hljs">emcc lib/imports.c -s WASM=1 -s EXPORTED_FUNCTIONS="['_getNum', '_main', '_getDoubleNum', '_greet']" -o public/imports.js</code> </pre> <br><p>  Setting up the Emscripten is not the easiest thing, but it‚Äôs not a rocket launch.  The only thing that complicates the configuration is that it has many dependencies, such as Python, Node, xCode, Git and cMake.  All instructions can be found on the installation page and easy to follow. <br>  Therefore Emscripten: <br><br></p><ul><li>  is an excellent transfer tool that allows you to compile existing projects written in C or C ++ and run them in all modern browsers.  <i>Shoot from here, Internet Explorer!</i> </li><li>  great for APIs because it converts OpenGL to WebGL and allows you to use familiar APIs such as SDL or HTML5 directly.  <i>Oh yeah!</i> </li><li>  And it's pretty darn fast: thanks to LLVM, Emscripten, asm.js, and WebAssembly, the code runs at almost its own speed.  <i>Run, rabbit, run!</i> <br></li></ul><p></p><br><p>  Note: You do not need Emscripten to generate Wasm, because an API is built into all new browsers to support Wasm in the same window that Emscripten runs as the top layer, which makes the developer‚Äôs life much easier.  For example, Emscripten will adjust the amount of memory for you, which can be tedious through C. </p><br><h4>  Examples ... examples are everywhere! </h4><br><p>  You know, as they say, <i>‚Äúa line of code is worth a thousand words</i> ,‚Äù OK, this is the narrator‚Äôs prerogative and all that, so without further ado let's take a look at some real code.  Off-topic comment: I couldn‚Äôt overcome the syntax on that day. It didn‚Äôt compile half the time because my code would be shaky.  And after eight years, I‚Äôm like this: <i>‚ÄúIt‚Äôs like JavaScript</i> . <i>‚Äù</i> </p><br><p>  Guys, if someone starts to see the C code in my React, just bring me back to reality, okay? </p><br><p>  A little off topic, here's a valid C code: </p><br><img src="http://habrastorage.org/webt/ck/lg/et/cklgetgfjlx_kvbbco7_mfazc7w.png" alt="image"><br><br><p>  And, accordingly, in JavaScript: </p><br><img src="http://habrastorage.org/webt/tt/co/wk/ttcowkhhzlmtmqlqgst67lulqbg.png" alt="image"><br><br><p>  OK, what exactly is happening in these files?  Actually quite a lot, so I will list. <br></p><ol><li>  It is important to understand that <b>main ()</b> , unless otherwise specified, is always run first and also compiles by default.  If you want to compile another function, you will need to specifically set it in the <b>EXPORTED_FUNCTIONS</b> array <b>flag</b> , as shown in the previous section. </li><li>  You write your C code, as usual, by importing its regular libraries, but on top of this you get Emscripten syntax sugar, as well as more methods / functions than with any other tool. </li><li>  The <b>imports.js</b> file (the name is arbitrary, but always the same as the C file), referenced by HTML, is nothing more than the ‚Äúglue‚Äù Emscripten, which is automatically generated during compilation.  No need to worry about it, just make sure it is really referenced. </li><li>  <b>Printf</b> is just an ordinary C operator that registers a string on the console.  Nothing special, moving on. </li><li>  Lines 14 and 17 are an anti-pattern, but a good example of running JS in your C code. The only real difference between <b>emscripten_run_script</b> and <b>emscripten_async_run_script</b> is that the latter allows you to run JS in C asynchronously.  Basically with <b>setTimeout ()</b> .  The reason I said that this anti-pattern is because it is.  The whole idea of ‚Äã‚ÄãWebAssembly is to run C in JS, not JS in C, and, therefore, ... </li><li>  Lines 20 and 24 and the associated JS functions in the <b>index.html</b> file represent the correct template, namely, the declaration of your JS in your JS and the return of something for C. </li><li>  <b>EM_JS</b> , which then runs <b>jsFunction</b> , is simply a simpler way ‚Äî to achieve a similar goal, as in points 4 and 5. </li></ol><br><p>  The predictable result of the above is: </p><br><img src="http://habrastorage.org/webt/xd/lp/ew/xdlpewar42x522efjks9j2tdii4.png" alt="image"><br><br><p></p><h4>  Ladies First! </h4><p></p><br><p>  As with any code, WebAssembly also has an execution order.  Do not mess with the queue!  The order in this case is standard for C order.  Everything runs in Main () and whenever <b>main () is</b> ready, ready and wasm.  However, what happens if you need a static function to call at run time?  Well, just a little Emscripten syntax sugar, and everything goes like clockwork: </p><br><img src="http://habrastorage.org/webt/ak/vg/vy/akvgvyjdhbok35-ggr2ktamzsys.png" alt="image"><br><br><h4>  We collect flies from the cake </h4><br><p>  This is well-written code, especially the simple things illustrated in the previous sections, but we all know that the real world is much more than ‚ÄúHello World‚Äù, and half of each developer‚Äôs time is spent figuring out why the code doesn‚Äôt do what should.  Bugs are simply inevitable and in some sense are part of life. </p><br><p>  When you run C in JS or any Wasm, for that matter, everything can become even more depressing.  Fortunately, Emscripten comes to the rescue again by providing two very useful debugging methods: </p><br><pre> <code class="plaintext hljs">// browser debugger gets triggered emscripten_debugger(); // browser console warning with stack-trace emscripten_log(EM_LOG_WARN, ‚Äú'param' your message‚Äù);</code> </pre> <br><h4>  Fast Gonzalez hurries to help </h4><br>  Believe it or not, the creators of Emscripten have thought of everything.  One big feature - and the last one, which I will mention in this article, since there are too many of them to put them all in one - is the basis for rapid development and testing.  You can compile your Wasm, build a project and start the server in one fell swoop: <p></p><br><pre> <code class="plaintext hljs">emrun --port 7777 --no_browser public/index.html Now listening at http://localhost:7777/</code> </pre> <br>  The html page you are running is not emrun-capable.  Stdout, stderr and exit (returncode) capture will not work.  Recompile the program with the flag to enable this, or pass it‚Äôs a way to hide this check. <br><p>  Well, two swings ... the example above works, but the next one works better, which is explained by the error. </p><br><pre> <code class="plaintext hljs">&lt;b&gt;// compile as emrun project emcc lib/strings.c -s WASM=1 --emrun -o public/index.html // run the emrun server again emrun --port 7777 --no_browser public/index.html&lt;/b&gt;</code> </pre> <br><p>  I'll just leave it like that.  Studying WebAssembly, I celebrated St. Patrick's Day and the next day.  Not quite sure what will happen next, but it worried me enough to sit in front of the monitor for two days, trying to penetrate the basics of WebAssebly, and that should mean something, right?  This is the most C code that I have written since 2011, and it feels great.  I think WebAssembly has a real future, but I'm not sure that it will completely capture the network and kill JS, as some people preach.  And what do you think? </p><br><img src="https://cdn-images-1.medium.com/max/800/1*PM2kQWEmOeAsRwenG-bDAA.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/453008/">https://habr.com/ru/post/453008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452998/index.html">Android StackView based card widget (something like Tinder)</a></li>
<li><a href="../453/index.html">Cake!</a></li>
<li><a href="../4530/index.html">40 normal ways to make money on the Internet</a></li>
<li><a href="../453004/index.html">We send Habr to Mars, you can also fly</a></li>
<li><a href="../453006/index.html">–Ü–¢ terms on the example of the potato growing process</a></li>
<li><a href="../453010/index.html">Comparison of 10 halogen lamps H4 Philips, Osram, PIAA, Koito, Bosch. The results are surprising.</a></li>
<li><a href="../453012/index.html">A short photo story about a trip to the Caucasus Mountain Observatory of the SAI MSU</a></li>
<li><a href="../453014/index.html">EyeWire - keep learning brain secrets</a></li>
<li><a href="../453016/index.html">Top 3D Academy invites you to exchange experience at the Folyplast plant</a></li>
<li><a href="../453018/index.html">The study of the influence of various reflectors and diffusers on the shape of the light beam</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>