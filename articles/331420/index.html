<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Z-order in 8D</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Indexes based on self-similar sweeping curves are suitable not only for organizing the search for spatial data. They are efficient on heterogeneous da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Z-order in 8D</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/823/1d6/d77/8231d6d774204a5289c8a1417d5cfd68.png"></div><br>  Indexes based on self-similar sweeping curves are suitable not only for organizing the search for spatial data.  They are efficient on heterogeneous data laid on an integer lattice. <br><br>  Under the cut, we will check the possibility of using the <a href="https://en.wikipedia.org/wiki/Z-order_curve">Z-curve</a> for the implementation of an 8-dimensional index with an eye on the <a href="https://ru.wikipedia.org/wiki/OLAP-%25D0%25BA%25D1%2583%25D0%25B1">OLAP cube</a> . <br><a name="habracut"></a><br><h3>  Summary of the previous series. </h3><br>  Earlier ( <a href="https://habrahabr.ru/post/302606/">1</a> , <a href="https://habrahabr.ru/post/319096/">2</a> , <a href="https://habrahabr.ru/post/319810/">3</a> , <a href="https://habrahabr.ru/post/323192/">4</a> , <a href="https://postgrespro.ru/blog/news/190297">5</a> ) it was shown that the index based on the Z-curve is quite suitable for organizing spatial search.  It is very close in speed (in the absence of restrictions on the buffer cache) to the traditionally used R-tree, but it is noticeably smaller, faster built, not afraid of random data, less reads during the search. <br><br><h3>  Fears. </h3><br>  Technically, there is nothing difficult in the implementation of such an index, it only took <a href="https://github.com/bmuratshin/zcurve/tree/8D">to</a> process an 8-dimensional key.  Dimension 8 was chosen for technological reasons, if you need a 7-dimensional index, you can safely add it with zeros in one of the coordinates, it almost does not affect the speed, except that the key will be longer.  If necessary, nothing prevents you from making a longer one, for example, a 16-dimensional key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is worth considering in advance what pitfalls can expect us and what to do about it. <br><br><ul><li>  <i>We will experiment on pseudo-random data.</i>  <i>But the real data has internal dependencies that are highly dependent on a specific task and difficult to foresee</i> .  Yes, it is, as a simulation, our pseudo-random data will actually be 6-dimensional, and we will simply duplicate the two columns. <br><br>  In general, this problem is fundamental enough for multidimensional R-trees that have page splitting / merging heuristics.  If the dependencies in the data do not fit into the heuristics, it can begin to work counterproductively, which affects both the construction / work time and the size of the index. <br><br>  For the usual B-tree on which our index is built, this problem is not so terrible - the tree itself maintains a balance. <br><br></li><li>  <i>In reality, different dimensions have different scales, the maximum extent can be flattened in one dimension and stretched in another.</i>  Yes, of course, but again, this is quite important when building multidimensional R-trees and much less critical in the case of B-trees. <br><br></li><li>  <i>What about accuracy?</i>  <i>In the current implementation, up to 31 bits are allowed to encode the value.</i>  If the data (with a floating point) is obtained naturally, then 20 digits will most likely be enough for their coding.  There are of course 32-bit ADCs, but this is more exotic.  It is clear that double contains 64 bits, but most of the data without loss (or with minimal losses) can be planted on a 31-bit grid.  If this is not the case, the data were processed, for example, they were averaged. <br><br>  If necessary, the resolution of the described index can be increased.  This will cause key swelling and performance degradation.  However, as long as more than one key fits on a page, they can be organized as a B-tree. <br><br>  On the other hand, a small loss of accuracy is not critical in our case.  After all, we are looking in the interval for each dimension.  To get the correct result, it is enough to take an interval with a margin and remove unnecessary post-filtering. <br><br></li><li>  <i>Data may be hierarchical in nature.</i>  <i>For example, the number encodes the sensor, but the sensors are grouped, their groups form their own hierarchy.</i>  <i>And I want to do a sample of the whole branch of this hierarchy.</i>  This problem <a href="https://www.osp.ru/os/2003/04/182942">is solved by</a> traversing and numbering the nodes of the tree in direct order.  Then each tree node has an interval of values ‚Äã‚Äã- from its own identifier to the identifier of its last descendant. <br><br><img src="https://habrastorage.org/web/61e/c20/09d/61ec2009d3b1495c835a126050a98ae1.png"><br><br>  And the intervals are exactly what we need for the search. <br><br></li><li>  <i>Multidimensional rectangles have a developed surface and the Z-curve coding will be very inefficient.</i>  There are such concerns at the same time and check. <br></li></ul><br><h4>  Benchmark </h4><br>  The following table summarizes the results for several (described below) query types. <br>  Data - 100 000 000 random points, evenly distributed in an 8-dimensional cube with sides [0 ... 1 000 000]. <br><br>  Measurements (as before) were conducted on a virtual machine with two cores and 4 GB of RAM, so the times have no absolute value, but the numbers of the read pages can still be trusted. <br>  The times are shown on the second runs, on the heated server and the virtual machine.  The number of buffers read is on a freshly raised server. <br><br><div class="spoiler">  <b class="spoiler_title">Details</b> <div class="spoiler_text"><ul><li>  Here is this <a href="https://github.com/bmuratshin/zcurve/tree/8D">commit</a> : (SHA-1: 36dd ... 76c7) <br></li><li>  gawk -f gendata.awk„Äâ data.csv <br><pre> BEGIN {
   for (i = 0; i &lt;100000000; i ++)
   {
     x = int (1000000 * rand ());
     y = int (1000000 * rand ());
     z = int (1000000 * rand ());
     a = int (1000000 * rand ());
     b = int (1000000 * rand ());
     c = int (1000000 * rand ());
     print "{" x "," y "," z "," a "," b "," c "," a "," b "}";
   }
 } </pre>  note that ‚Äúa‚Äù and ‚Äúb‚Äù occur twice, we have degenerate data, the real dimension is 6 <br></li><li><code>create table test_points_8d (p integer[8]);</code> <br> </li><li> <code>COPY test_points_8d from '/home/.../postgresql/contrib/zcurve/data.csv';</code> <br>  10 minutes <br></li><li>  \ dt + <br><pre> Schema |  Name |  Type |  Owner |  Size |  Description 
 ------- + ---------------- + ------- + ---------- + ------ --- + -------------
 public |  test_points_8d |  table |  postgres |  8056 MB | 
</pre><br></li><li> <code>create index zcurve_test_points_8d on test_points_8d (zcurve_num_from_8coords (p[1], p[2], p[3], p[4], p[5], p[6], p[7], p[8]));</code> <br>  15 minutes <br></li><li>  \ di + <br><pre> Schema |  Name |  Type |  Owner |  Table |  Size | 
 -------- + ----------------------- + ------- + --------- - + --------------- + ------- + ---
  public |  zcurve_test_points_8d |  index |  postgres |  test_points_8d |  4743 MB  
</pre><br></li><li>  verification request <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> test_points_8d t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c = t.ctid) t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zcurve_8d_lookup_tidonly(<span class="hljs-string"><span class="hljs-string">'zcurve_test_points_8d'</span></span>, <span class="hljs-number"><span class="hljs-number">237000</span></span>,<span class="hljs-number"><span class="hljs-number">291000</span></span>,<span class="hljs-number"><span class="hljs-number">845000</span></span>,<span class="hljs-number"><span class="hljs-number">152000</span></span>,<span class="hljs-number"><span class="hljs-number">585000</span></span>,<span class="hljs-number"><span class="hljs-number">193000</span></span>,<span class="hljs-number"><span class="hljs-number">152000</span></span>,<span class="hljs-number"><span class="hljs-number">585000</span></span>, <span class="hljs-number"><span class="hljs-number">247000</span></span>,<span class="hljs-number"><span class="hljs-number">301000</span></span>,<span class="hljs-number"><span class="hljs-number">855000</span></span>,<span class="hljs-number"><span class="hljs-number">162000</span></span>,<span class="hljs-number"><span class="hljs-number">595000</span></span>,<span class="hljs-number"><span class="hljs-number">203000</span></span>,<span class="hljs-number"><span class="hljs-number">162000</span></span>,<span class="hljs-number"><span class="hljs-number">595000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c) x;</code> </pre>  returns <br> <code>c | t_row <br> ------+----------------------------------------------------------- <br> (0,1) | {237787,291065,845813,152208,585537,193475,152208,585537} <br></code> <br>  as required <br></li></ul><br></div></div><br><table><tbody><tr><th>  Request type </th><th>  NPoints </th><th>  Nreq </th><th>  Time (ms) </th><th>  Reads </th><th>  Shared hits </th></tr><tr><td>  all 10,000 each <br></td><td>  1.1e-4 </td><td>  100,000 </td><td>  .46 </td><td>  2.0175 </td><td>  15.3919 </td></tr><tr><td>  all over 100,000 <br></td><td>  73.9 </td><td>  10,000 </td><td>  47 </td><td>  57.3063 </td><td>  1604.18 </td></tr><tr><td>  3100 000 + <br>  510 000 </td><td>  0.0837 </td><td>  10,000 </td><td>  .9 </td><td>  8.7637 </td><td>  73.8852 </td></tr><tr><td>  2x100,000 + <br>  610 000 </td><td>  0.0096 </td><td>  10,000 </td><td>  .66 </td><td>  5.1771 </td><td>  40.9089 </td></tr><tr><td>  1 whole + <br>  1X100,000 + <br>  6X10,000 </td><td>  0.0978 </td><td>  10,000 </td><td>  1.5 </td><td>  24.2122 </td><td>  199.33 </td></tr><tr><td>  2 whole + <br>  6X10,000 </td><td>  0.9663 </td><td>  10,000 </td><td>  95 </td><td>  115.202 </td><td>  1050.8 </td></tr></tbody></table>  Where <br>  <b>Type of request</b> - one of the following <br><ul><li>  all 10,000 each. The total extent side is 1,000,000, requests in the form of a cube with a side of 10,000, and the beginning of the queries are evenly distributed within the total extent.  The request party is 1E-2 from the maximum.  Since  we have 6 independent parameters, we get 1E-12 of the total volume.  The number of points is 1E8, which means the theoretical probability of finding a point in such an extent is approximately 1E-4 </li><li>  all by 100,000. The extent of the query in is a cube with a side of 100,000, which is 1e-1.  Since  we have 6 independent parameters, we get 1e-6 by volume.  The number of points is 1e8, which means the average number of points in such a query is 100. On the other hand, the probability of getting beyond the extent of one coordinate is 10%, for any of 6 - 53% (0.9 ** 6), if the average getting out is 5%, then the probability is 0.735 (0.95 ** 6), which is consistent with the obtained value <br></li><li>  3100 000 + 510 000. Requests are flattened in 5 dimensions </li><li>  2100 000 + 610 000. Requests are flattened in 6 dimensions </li><li>  1 entirely + 1X100,000 + 6X10,000. Requests are flattened in 6 dimensions, one dimension is taken entirely, one is 100,000. The situation is simulated when one of the values ‚Äã‚Äãis unknown, you have to take the full interval for it. </li><li>  2 entirely + 6X10 000. Two values ‚Äã‚Äãare taken entirely, aggravating the situation with the unknown. </li></ul><br>  <b>NPoints</b> - the average number of points found in the query <br>  <b>Nreq</b> - the size of a series of requests <br>  <b>Time (ms)</b> - the average query time <br>  <b>Reads</b> - the average number of reads per request <br>  <b>Shared Hits</b> - the number of hits in the buffer cache <br><br><h3>  findings </h3><br>  As expected, the area of ‚Äã‚Äãrequest perimeter plays an important role in the cost of the request.  In fact, the larger the perimeter, the more pages it will potentially cross, the more it will have to read, the lower the cache efficiency ... <br><br>  However, for cubic queries, the cost of the query is quite acceptable.  In fact, for a query - a cube with a side of 100,000, an average of 57 pages are read with 74 lines of output.  In order to read these 74 lines, you will most likely have to read about 74 more pages. <br><br>  In addition, these data are obtained on evenly distributed data; on clustered data, it is expected that in order to obtain the same output power, query sizes will be much smaller, as will the number of pages read. <br>  It would be interesting to have a look. <br><br>  <b>PS:</b> on the title picture shows an okterakt - 8-dimensional cube <br>  <b>PPS:</b> thanks to Andrei Borodin (Oktonika, Ekb.) For the tip on </div><p>Source: <a href="https://habr.com/ru/post/331420/">https://habr.com/ru/post/331420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331410/index.html">How semantic technologies improve online education: a project of scientists from the ITMO University</a></li>
<li><a href="../331412/index.html">How to create a compact and efficient javascript using RollupJS</a></li>
<li><a href="../331414/index.html">Seminar "Trifle, but nice: 20 little things that will make the work in the server really comfortable", July 4, Moscow</a></li>
<li><a href="../331416/index.html">Stagnation is inevitable. CRM takes the fight</a></li>
<li><a href="../331418/index.html">We dot the microservices. Avito section on RHS ++ 2017 (Video)</a></li>
<li><a href="../331422/index.html">Welcome to Science Slam Digital July 7</a></li>
<li><a href="../331426/index.html">Videos: Android meetup at Badoo office</a></li>
<li><a href="../331428/index.html">The final of the SAP contest Koder 2017 will be held live</a></li>
<li><a href="../331430/index.html">"Gonochki" on SVG</a></li>
<li><a href="../331432/index.html">SIP: this growth does not stop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>