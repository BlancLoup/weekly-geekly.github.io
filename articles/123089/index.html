<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to insert a seal into the document so that the gods do not kill the kitten</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Elba users had a dream to embed images of seals and signatures into accounts, acts, invoices and other serious documents. Why not please the dreamers,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to insert a seal into the document so that the gods do not kill the kitten</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://www.e-kontur.ru/">Elba</a> users had a dream to embed images of seals and signatures into accounts, acts, invoices and other serious documents.  Why not please the dreamers, we thought.  Looking around, we realized that usually in such cases all the dirty work is blamed on the user (well, you know: "the picture should be 300 by 400 pixels, with high contrast, good resolution and a perfectly white background").  But judging by the experience of our team, which happens in a call center, even a simple download of the image from the camera plunges users into deep depression, and they have to be rescued in ungodly ways, a la ‚Äúinsert a picture into the Word‚Äù.  Of course, there can be no question of forcing users to clean prints in photoshop - let them take pictures as best they can, and Elba will do the rest for them! <br><br><img src="https://habrastorage.org/storage1/058d0608/79c14d86/8db8f03c/223eb6d4.png"><br><br>  If you are interested in knowing what needs to be done with a photo taken with a phone or a soap box, in order to get a clear stamp and signature with a transparent background - read on. <br><a name="habracut"></a><br>  Actually, we have done not one, but three methods for processing seals and signatures.  This is not from a good life - some images are better cleaned in one way, some - in another.  We simultaneously use all three, and then let the user choose: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage1/6ff3a67c/57260491/5e2db142/8fe204ed.png"><br><br><h4>  Method one: a scientific approach </h4><br>  Any picture can be considered as a set of points, each of which has a certain color.  Based on this, our task looks very simple - take only those points that are part of the seal or signature. <br><br>  The idea looks like this: in some way, we will transform the original image into a black and white image (the background is black, the print is white), then we intersect the set of all white dots (mask) with the original image.  Those parts of the original image that coincide in coordinates with white dots are considered a seal.  In more detail: <br><ol><li>  Take a picture <br><br><img src="https://habrastorage.org/storage1/98d2549a/a2188633/bd1dde05/bb6cd030.png"><br><br></li><li>  Translate to gray <br><br><img src="https://habrastorage.org/storage1/5bffe8bb/187da527/117bfb80/cc55209c.png"><br><br></li><li>  Starting the search for edges <br><br>  Here we need to clarify what the edges are and how we look for them.  In our picture there are areas of uniform color (labels and circles) and the actual edges are the borders of these areas.  In many graphics packages and libraries, there is a standard ‚ÄúSobel‚Äôs‚Äù filter that highlights the horizontal and vertical edges separately (and it‚Äôs on the gray image).  Here is a vivid example of the selection of edges according to Sobel: <br><br><img src="https://habrastorage.org/storage1/6abae556/aaff78a2/bc9082a4/6a171da8.jpg"><img src="https://habrastorage.org/storage1/4d18dafa/3f3e6d24/8e754068/f817410e.jpg"><br><br>  And here is how the edges were found in our image: <br><br><img src="https://habrastorage.org/storage1/2ae57bae/ffbbc131/21fddfcc/161f4fdc.png"><br><br></li><li>  So, we got a print outline, but it is not uniform: in addition to black and white areas (background and print), there are quite a few points that are close in color to the background or print.  By declaring such points a background or an image, we immediately improve the quality of recognition.  We harden our picture: <br><br><img src="https://habrastorage.org/storage1/ad91b3b5/f8f40a1d/b2340b3e/6e1f4f3e.png"><br><br></li><li>  After all these transformations, we have pretty well identified the print area.  But there is rubbish all over the picture - ‚Äúlonely‚Äù white dots.  ‚ÄúLonely‚Äù is a keyword, there is always a lot of black around.  Now we will reduce the resolution of our image, instead of each square of 20 √ó 20 points we will make one big point.  We define its color as the average of the colors of all the points that entered this square.  White single points will inevitably turn black.  And after that, we again harden the picture: <br><br><img src="https://habrastorage.org/storage1/3fead966/9318e1af/33d5d928/cf8a8e8b.png"><img src="https://habrastorage.org/storage1/69201c38/606a3add/37b1606b/c9465dd1.png"><br><br></li><li>  As a result, all the garbage in the form of lonely points disappeared, we well identified the area in which the seal is guaranteed.  In addition, we have the edge (remember, found "according to Sobel").  Just cross the edge with what you just got. <br><br><img src="https://habrastorage.org/storage1/aaea9441/668ddd1b/464a9e7c/5806ec3f.png"><br></li></ol><br>  This is what happens if you apply this as a mask to the original print: <br><br><img src="https://habrastorage.org/storage1/3302aec2/711dc203/3a7b94ab/b31f51d1.png"><br><br>  Everything that is far enough away from the elements of the image, we threw out, and this, of course, is a success.  But we did not remove the details of the background near the print.  This happened because the color of the background near the image was not sufficiently different from the picture itself (the photo was poor-quality, unevenly lit, etc.) and during our coarsening these areas were not assigned to the background.  Immediately it begs a very simple step - maximize the difference between the print and the background areas near the print.  It's very easy to do: increase the contrast.  To do this, run the original photo through anti-aliasing and HistogramEqualization: <br><br><img src="https://habrastorage.org/storage1/5d47d7c9/155b5ff8/ef2857d7/c03c73e1.png"><br><br>  As a result, the background, far from printing, has become the same color as the print, but we don‚Äôt give a damn, we have learned to discard it and work only with background areas close to the picture.  Then the matter of technology, no new ideas will be: in gray, inverted, roughened. <br><br><img src="https://habrastorage.org/storage1/602bad57/adcd98f3/ec941f32/483ccef1.png"><img src="https://habrastorage.org/storage1/49049367/d9bd7f72/e2e62955/147fe6cc.png"><img src="https://habrastorage.org/storage1/231c23d4/60c73757/8b197627/664876fb.png"><br><br>  So, we are able to clean everything except the garbage near the print, and we have already seen what the result will be.  We have just learned how to clean the garbage near the seal, now apply what we got to our first result: <br><br><img src="https://habrastorage.org/storage1/1a7b2929/67c1f339/73c60504/79b95dcb.png"><br><br>  Already not bad.  It is clear that we need to slightly blur, raise the contrast, make the background transparent, etc. <br><br><blockquote>  True, we have a problem with photos in high resolution (the race for camera megapixels, alas, did not spare the owners of the phones) - the wide (10, and sometimes 100 pixels) print lines began to disintegrate as a result of the search for edges on two separate lines. <br><br>  To eliminate such minor annoyances, you can use closing.  In our case, the closure will lead to the fact that all areas of the background between the paired strokes will be smeared, but only if the distance between the strokes is not too large.  Here is an example of how the closure works from the AForge.Closing filter documentation: <br><br><img src="https://habrastorage.org/storage1/c2949a7a/312b6f15/d5093838/9fb72657.png"><br><br><img src="https://habrastorage.org/storage1/173f66a8/1ae181b8/375b3d17/eeb0a0be.png"><br><br>  It is seen that the cavity is more than a few pixels in a row the closure is not able to gloss over.  And the size of the cavity depends on the resolution with which the print was photographed. <br><br>  It would seem - well, we will bring the resolution in accordance with the one we need (a specific value will be determined experimentally).  However, the problem is that people can quite (and love) take pictures of print with huge white fields. <br><br>  After compressing the image to the ‚Äúoptimal size‚Äù, we will get a tiny print in the corner of the photo. <br><br>  As a result, we decided not to bother and run the algorithm 2 times.  For the first time we will remove large debris (and, possibly, small parts of the seal), and also understand where the print is in the picture.  After this, we again take the original picture, cut out the now known place with the seal, scale it to the desired size, and again run the cleaning algorithm from the background. <br></blockquote><br>  It seemed that the goal was achieved, but when we began to take examples of stamps and signatures from the Internet, we encountered a new problem.  If for the majority of stamps our algorithm worked quite well, then with the signatures everything was much worse: the level of contrast of photographs was sometimes such that the search for edges simply lost half the lines, and lowering the bar for searching is also dangerous - we risk getting a lot of garbage. <br><br><h4>  Method Two: The Great Bicycle Invention </h4><br>  We decided, why do we need these searches of edges and other bells and whistles?  In the end, a signature is a very simple thing: a few lines drawn with a dark pen on light paper. <br><br>  At first glance, to separate the dark from the light is small science.  To begin with, the algorithm codenamed ‚Äúwho is not with us is against us‚Äù looked very simple: we iterate over all the points that have a higher brightness than the gray color, write them into the ‚Äúbackground‚Äù and destroy them.  All that is darker, leave, for the "pen". <br><br>  Drove on the first available signature - hooray, cool process! <br><br><img src="https://habrastorage.org/storage1/0353d6a6/dcf4aee6/8269ebbf/88c03f1f.png"><img src="https://habrastorage.org/storage1/71e8c555/e880741d/75339453/86514770.png"><br><br>  They drove to the second - a full file. <br><br><img src="https://habrastorage.org/storage1/7fe8f6cd/075277ed/2225d896/32ecc56c.png"><img src="https://habrastorage.org/storage1/1812703c/092f316a/fe896f1f/b02ff884.png"><br><br>  The first thought is to write on the download form ‚ÄúFotay is more contrast, boys‚Äù and score - for some reason, the interface designers did not approve.  I had to turn on the brain.  We figured it, since it works on some photos, but not on others, you just need to normalize the photos yourself a little.  They took a photo, walked through all the points, built a simple histogram: it was trite for each of the 256 possible brightness values ‚Äã‚Äãto count the number of points of this brightness itself.  Found the minimum brightness, then the maximum, chose the point "somewhere in the middle" and cut out the background. <br><br><img src="https://habrastorage.org/storage1/7fe8f6cd/075277ed/2225d896/32ecc56c.png"><img src="https://habrastorage.org/storage1/1116ba7d/f1dfb4e6/6c4fc109/9059d72d.png"><br><br>  Hooray, we said, and began to look for examples of trash signatures with joy.  Well, to find as much evidence as we can do.  Life, as always, turned out to be more interesting: literally in the second photo, a hard file was waiting for us again!  No matter how we chose that point ‚Äúsomewhere in the middle,‚Äù either the background remained in the corner, or part of the signature disappeared. <br><br><img src="https://habrastorage.org/storage1/2ae490d3/e35091d6/8bd531ca/af1a12ef.png"><img src="https://habrastorage.org/storage1/4c004f20/904ae58c/1697c952/3e55285f.png"><br><br>  Fearfully looking at the result, they opened the original and began to think. <br><br>  The puzzles, in general, were not there, just the light went down so that the background on one edge of the photo was darker than the pen on the other (as it turned out - this happens quite often in real life).  Obviously, in this situation, the desired point simply does not exist. <br><br>  Understand that further twist the parameters meaningless.  They began to reason logically: ‚ÄúHere we are looking at the photo and the signature is perfectly visible.  So, the contrast is sufficient.  At least local contrast. ‚Äù <br><br>  When the word ‚Äúlocal‚Äù came to life, they sharply revived and decided: since for the whole picture it is impossible to select a point like ‚Äúthe handle is darker, the background is lighter‚Äù, then we will try to do it on the part of the image! <br><br>  We split into rectangles (a 10x10 grid experimentally arranged for us) and applied the algorithm to each cell separately.  All anything, but a part of the cells was filled exclusively with the background.  It's easier here - since there is nothing but a background, then local contrast is extremely low.  This means that the brightest point and the darkest point in the histogram are very close. <br><br>  It seems to work out. <br><br><img src="https://habrastorage.org/storage1/92c7bd81/6c4594cb/26cd7986/2f47ff86.png"><img src="https://habrastorage.org/storage1/604b5c47/0fd23304/3e644f1d/38e757e3.png"><br><br>  We take a separate cell, build a histogram along it, look at the left edge (minimum brightness) and right edge (maximum brightness).  Then take the delta, which is the contrast.  If the contrast is less than a certain value (at a minimum, it is calculated based on the overall contrast of the image), then we consider the entire cell as the background and discard the excess.  If the contrast is greater - we define the point of the ‚Äúsection‚Äù and cut off everything that is brighter. <br><br><h4>  The third way, the final </h4><br>  Two options seemed to us a little, we decided to add a third one - a simple treatment of ‚Äúalmost perfect‚Äù photos, in which the whole background is white (well, or almost white).  To do this, knocked out all the pixels lighter than 95% of the maximum brightness and cut off the field. <br>  As a result, as we said at the beginning, the user chooses one of three options.  In the event that none of the options came up (which is extremely rare), we show <a href="">instructions</a> on how to correctly press the ‚Äúmasterpiece‚Äù button on the camera. <br><br>  You can <a href="http://www.e-kontur.ru/">try it yourself</a> , even if you do not have a seal, then you probably know how to sign;) </div><p>Source: <a href="https://habr.com/ru/post/123089/">https://habr.com/ru/post/123089/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123078/index.html">Voyage Linux 0.7.5 released</a></li>
<li><a href="../123080/index.html">libral - layer of abstraction access to compression libraries</a></li>
<li><a href="../123083/index.html">Analogue Adobe Flash or what is Swish Max?</a></li>
<li><a href="../123086/index.html">Opera Mini 6.1 and Opera Mobile 11.1</a></li>
<li><a href="../123088/index.html">Plus: Entry is strictly limited.</a></li>
<li><a href="../123090/index.html">Setting up the phone D-Link DPH-300S</a></li>
<li><a href="../123093/index.html">How do you update project dependencies (maven, ivy, just jar-ok warehouse)</a></li>
<li><a href="../123094/index.html">Why do girls still play video games</a></li>
<li><a href="../123095/index.html">Women and games. Key points</a></li>
<li><a href="../123096/index.html">Google Analytics and Google Webmaster Tools have added social network statistics.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>