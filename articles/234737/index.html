<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part 11: Email Support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the eleventh article in the series, where I describe my experience of writing a Python web application using the Flask mic framework. 

 The p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part 11: Email Support</h1><div class="post__text post__text-html js-mediator-article"> This is the eleventh article in the series, where I describe my experience of writing a Python web application using the Flask mic framework. <br><br>  The purpose of this guide is to develop a fairly functional microblog application, which I decided to call <code>microblog</code> in the absence of originality. <br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/193242/">Part 1: Hello, World!</a> <br>  <a href="http://habrahabr.ru/post/193260/">Part 2: Templates</a> <br>  <a href="http://habrahabr.ru/post/194062/">Part 3: Forms</a> <br>  <a href="http://habrahabr.ru/post/196810/">Part 4: Database</a> <br>  <a href="http://habrahabr.ru/post/222983/">Part 5: User Login</a> <br>  <a href="http://habrahabr.ru/post/223375/">Part 6: Profile Page and Avatars</a> <br>  <a href="http://habrahabr.ru/post/223783/">Part 7: Unit Testing</a> <br>  <a href="http://habrahabr.ru/post/230643/">Part 8: Subscribers, Contacts and Friends</a> <br>  <a href="http://habrahabr.ru/post/230897/">Part 9: Pagination</a> <br>  <a href="http://habrahabr.ru/post/234613/">Part 10: Full Text Search</a> <br>  <a href="http://habrahabr.ru/post/234737/">Part 11: Email Support (this article)</a> <br>  <a href="http://habrahabr.ru/post/234785/">Part 12: Reconstruction</a> <br>  <a href="http://habrahabr.ru/post/236753/">Part 13: Date and Time</a> <br>  <a href="http://habrahabr.ru/post/236861/">Part 14: I18n and L10n</a> <br>  <a href="http://habrahabr.ru/post/237065/">Part 15: Ajax</a> <br>  <a href="http://habrahabr.ru/post/237317/">Part 16: Debugging, Testing, and Profiling</a> <br>  <a href="http://habrahabr.ru/post/237489/">Part 17: Deploying to Linux (and even to Raspberry Pi!)</a> <br>  <a href="http://habrahabr.ru/post/237517/">Part 18: Deploying to Heroku Cloud</a> <br></div></div><br><br><h3>  Brief repetition </h3><br>  In the last lessons we dealt mainly with improvements related to our database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we will allow our database to rest for a while, and instead look at one very important function that most web applications have: the ability to send email to the user. <br><a name="habracut"></a><br>  In our small application, we are going to implement a similar function; we will send a notification to the user every time someone subscribes to it.  There are a few more things for which the sending function may be useful, so we will try to design our function so that it can be reused. <br><br><h3>  Introduction to Flask-Mail </h3><br>  Fortunately for us, Flask already has an email processing extension, and although it does not perform 100% of the tasks, it is very close to that. <br><br>  Installing Flask-Mail in our virtual environment is quite simple.  Users on systems other than Windows should do: <br><br><pre> <code class="bash hljs">flask/bin/pip install flask-mail</code> </pre><br>  For Windows users, things are a little more complicated, because one of the dependencies Flask-Mail does not work on this OS.  On Windows, you need to do the following: <br><br><pre> <code class="bash hljs">flask\Scripts\pip install --no-deps lamson chardet flask-mail</code> </pre><br><br><h3>  Configuration </h3><br>  Earlier, when we added Unit testing, we added a configuration for Flask in which we indicated an email to which error notifications should be sent in the production version of our application.  The same information is used to send mail by the application. <br><br>  We need to remember that we need the following information: <br><br><ul><li>  server through which email is sent </li><li>  administrator email </li></ul><br><br>  This is what we did in the previous article ( <code>config.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># email server MAIL_SERVER = 'your.mailserver.com' MAIL_PORT = 25 MAIL_USE_TLS = False MAIL_USE_SSL = False MAIL_USERNAME = 'you' MAIL_PASSWORD = 'your-password' # administrator list ADMINS = ['you@example.com']</span></span></code> </pre><br><br>  Of course, you will have to enter the actual data in this config in order for the application to actually be able to send you emails.  For example, if you want to use the application to send emails via gmail.com, you need to specify the following: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># email server MAIL_SERVER = 'smtp.googlemail.com' MAIL_PORT = 465 MAIL_USE_TLS = False MAIL_USE_SSL = True MAIL_USERNAME = 'your-gmail-username' MAIL_PASSWORD = 'your-gmail-password' # administrator list ADMINS = ['your-gmail-username@gmail.com']</span></span></code> </pre><br><br>  We also need to initialize the Mail object, because  This will be the object that will connect to the SMTP server and send emails for us (file <code>app/__init__.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask.ext.mail <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mail mail = Mail(app)</code> </pre><br><br>  Let's send an email. <br><br>  To understand how Flask-Mail works, we need to send an email from the command line.  Let's run Python from our virtual environment and type the following: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; from flask.ext.mail import Message &gt;&gt;&gt; from app import app, mail &gt;&gt;&gt; from config import ADMINS &gt;&gt;&gt; msg = Message(<span class="hljs-string"><span class="hljs-string">'test subject'</span></span>, sender = ADMINS[0], recipients = ADMINS) &gt;&gt;&gt; msg.body = <span class="hljs-string"><span class="hljs-string">'text body'</span></span> &gt;&gt;&gt; msg.html = <span class="hljs-string"><span class="hljs-string">'&lt;b&gt;HTML&lt;/b&gt; body'</span></span> &gt;&gt;&gt; with app.app_context(): ... mail.send(msg) ....</code> </pre><br><br>  The code snippet above will send a letter to the list of administrators specified in <code>config.py</code> .  The sender will be the first administrator from the list.  The letter will have a text and HTML version, which you will see depends on the settings of your email client.  Please note that we need to create an <code>app_context</code> to send an email.  Recent Flask-Mail releases require this.  The context is created automatically when the request is processed by Flask. <br><br>  Since we are not inside the request, we can create the context with our hands. <br><br>  Now it's time to integrate this code into our application. <br><br><h3>  Simple email framework </h3><br>  Now we will write an additional function that sends email.  This is just a more general version of the above test.  We will put this function in a new file that we will highlight for our email-related functions (file <code>app/emails.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask.ext.mail <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Message <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mail <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span></span></span><span class="hljs-function">:</span></span> msg = Message(subject, sender = sender, recipients = recipients) msg.body = text_body msg.html = html_body mail.send(msg)</code> </pre><br><br>  Please note that Flask-mail supports more than we use.  For example, lists of hidden copies and attachments are available, but we will not use them in our application. <br><br><h3>  Subscription Notifications </h3><br>  Now that we have a basic framework for sending email, we can write a subscriber notification function (file <code>app/emails.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_template <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ADMINS <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">follower_notification</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(followed, follower)</span></span></span><span class="hljs-function">:</span></span> send_email(<span class="hljs-string"><span class="hljs-string">"[microblog] %s is now following you!"</span></span> % follower.nickname, ADMINS[<span class="hljs-number"><span class="hljs-number">0</span></span>], [followed.email], render_template(<span class="hljs-string"><span class="hljs-string">"follower_email.txt"</span></span>, user = followed, follower = follower), render_template(<span class="hljs-string"><span class="hljs-string">"follower_email.html"</span></span>, user = followed, follower = follower))</code> </pre><br><br>  Saw something unexpected? <br>  Our old friend - the <code>render_template</code> function creates a letter view.  If you remember, we used this function to render all the HTML templates from our presentation.  Just like our HTML, the body of the letter is an ideal candidate for using templates.  We want, as far as possible, to separate the logic from the presentation, so the letters will go in the folder with the templates along with the other view. <br><br>  So, now we will write templates for text and HTML versions for our notification.  This is the text version ( <code>app/templates/follower_email.txt</code> file): <br><pre> <code class="django hljs"><span class="xml"><span class="xml">Dear </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{user.nickname}}</span></span><span class="xml"><span class="xml">, </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{follower.nickname}}</span></span><span class="xml"><span class="xml"> is now a follower. Click on the following link to visit </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{follower.nickname}}</span></span><span class="xml"><span class="xml">'s profile page: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{url_for('user', nickname = follower.nickname, _external = True)}}</span></span><span class="xml"><span class="xml"> Regards, The microblog admin</span></span></code> </pre><br><br>  For the HTML version, we can make everything a little more beautiful and show the subscriber‚Äôs avatar and profile information (file <code>app/templates/follower_email.html</code> ): <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Dear {{user.nickname}},<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url_for('user', nickname = follower.nickname, _external = True)}}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{follower.nickname}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> is now a follower.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">valign</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"top"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url_for('user', nickname = follower.nickname, _external = True)}}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{follower.nickname}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag"> /&gt;</span></span> {{follower.about_me}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Regards,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>The <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span>microblog<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span> admin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Notice the <code>_external = True</code> in the <code>url_for</code> field of our template.  By default, the <code>url_for</code> function generates URLs relative to the current page.  For example, the code {url_for ("index")} will be <code>/index</code> , while we are expecting <code>http://localhost:5000/index</code> .  Email does not have a domain context, so we must provide full URLs that include the domain, and <code>_external</code> will help us with <code>_external</code> . <br><br>  The final step will be to connect sending an email with a view function that handles <code>"Follow"</code> (file <code>app/views.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> emails <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> follower_notification @app.route(<span class="hljs-string"><span class="hljs-string">'/follow/&lt;nickname&gt;'</span></span>) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">follow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(nickname)</span></span></span><span class="hljs-function">:</span></span> user = User.query.filter_by(nickname = nickname).first() <span class="hljs-comment"><span class="hljs-comment"># ... follower_notification(user, g.user) return redirect(url_for('user', nickname = nickname))</span></span></code> </pre><br><br>  You must now create two users (if you have not already done so) and make one subscriber to the other to see how the email notification works.  This is what you need?  Are we done? <br><br>  Now we can pat ourselves on the head for a job well done and cross out email notifications from the list of functions that we have to implement. <br><br>  But if you played with our application, you noticed that now that we‚Äôve implemented email notifications, it takes a few seconds after clicking on ‚ÄúFollow‚Äù before the browser refreshes the page.  And before that it happened instantly. <br><br>  So what happened? <br><br>  The problem is that Flask-Mail sends emails synchronously.  The server is blocked until the letter is sent and sends a response to the browser, only when the message is delivered.  Can you imagine what will happen if we try to send an email to a slow server, or, even worse, turned off?  This is bad. <br><br>  This is a very scary limitation, sending an email should be a background task that does not interfere with the server, so let's see how we can fix it all. <br><br><h3>  Asynchronous calls in Python </h3><br>  We want the <code>send_email</code> function <code>send_email</code> end instantly while the job of sending the letter is in the background. <br><br>  It turns out Python already supports launching asynchronous tasks, even in more than one way.  Threading and multiprocessing modules can help us. <br><br>  Starting a new thread, every time we need to send an email, a much less resource-intensive operation than starting a new process, so let's move the <code>mail.send(msg)</code> call to the stream ( <code>app/emails.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Thread <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_async_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg)</span></span></span><span class="hljs-function">:</span></span> mail.send(msg) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span></span></span><span class="hljs-function">:</span></span> msg = Message(subject, sender = sender, recipients = recipients) msg.body = text_body msg.html = html_body thr = Thread(target = send_async_email, args = [msg]) thr.start()</code> </pre><br><br>  If you are testing the ‚ÄúFollow‚Äù function, you will notice that the browser shows the updated page before the letter is sent. <br><br>  So, now we have implemented asynchronous mail sending, but what if in the future we need to implement other asynchronous functions?  The procedure will remain the same, but we will need to duplicate the code for working with threads in each case, which is not good. <br><br>  We can implement our solution in the form of a decorator.  With the decorator, the code above will change to this one: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> decorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_async_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(msg)</span></span></span><span class="hljs-function">:</span></span> mail.send(msg) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span></span></span><span class="hljs-function">:</span></span> msg = Message(subject, sender = sender, recipients = recipients) msg.body = text_body msg.html = html_body send_async_email(msg)</code> </pre><br><br>  Much better, isn't it? <br><br>  The code that makes this magic is actually very simple.  We will write it into a new file ( <code>app/decorators.py</code> file): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Thread <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">async</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> thr = Thread(target = f, args = args, kwargs = kwargs) thr.start() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wrapper</code> </pre><br><br>  Now that we have accidentally created a good basis for asynchronous tasks, we can say that everything is done! <br><br>  For the sake of the exercise, let's consider how our solution would change if we used processes instead of threads. <br>  We do not want the new process to start every time we send an email, instead we can use the <code>Pool</code> class from the <code>multiprocessing</code> module.  This class creates the required number of processes (which are forks of the main process) and all processes are waiting for tasks that are passed through the <code>apply_async</code> method.  This may be useful and interesting for loaded sites, but for now we‚Äôll stop at threads. <br><br><h3>  Final words </h3><br>  The source code of the updated application is available below: <br><br>  Download <a href="">microblog-0.11.zip.</a> <br><br>  I received several requests to place this application on a github or similar site, I think this is a very good idea.  I will work on this in the near future.  Stay in touch. <br><br>  Thank you for following my series of tutorials.  Hope to see you in the following parts. <br><br>  Miguel </div><p>Source: <a href="https://habr.com/ru/post/234737/">https://habr.com/ru/post/234737/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234723/index.html">Data mining. Optimization of orders for goods in the pharmacy (pharmacy)</a></li>
<li><a href="../234727/index.html">We work with notifications in Windows Phone 8.1</a></li>
<li><a href="../234729/index.html">Protecting the site from scanning and chaotic intensive requests</a></li>
<li><a href="../234731/index.html">Algorithm for adopting someone else's project or what to do when managers have a honeymoon</a></li>
<li><a href="../234735/index.html">Changing the structure of sections on Habrahabr</a></li>
<li><a href="../234739/index.html">InFocus M512 - a budget device for Snapdragon 400 and with support for 4G networks</a></li>
<li><a href="../234741/index.html">Speed: terminal acceleration for stock trading with undocumented features</a></li>
<li><a href="../234743/index.html">Open lecture on the basics of Swift from MasterUp</a></li>
<li><a href="../234745/index.html">New virtual monitoring features for System Center with Veeam Management Pack v7</a></li>
<li><a href="../234747/index.html">Python, how would I like to see it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>