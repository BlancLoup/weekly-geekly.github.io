<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bottle and plugins</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Bottle is a Python mini-framework that allows you to write web applications at high speed. 

 That's just the word "mini" adds restrict...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bottle and plugins</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  Bottle is a Python mini-framework that allows you to write web applications at high speed. <br><br>  That's just the word "mini" adds restrictions, for example, there is no quick way to create an administrative panel.  If you need to work with the database, then it must be connected separately.  Thus, bottle is a tool for writing linear web-based applications that do not require too much interaction between application elements. <br><br>  If you need to write a handler that will accept the link to the file, and then download it to s3 with some kind of processing, then the bottle functionality is perfect for checking the functionality. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To work with bottle, it is sufficient to describe the handlers themselves, for example: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bottle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route, run, template @route(<span class="hljs-string"><span class="hljs-string">'/hello/&lt;name&gt;'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(<span class="hljs-string"><span class="hljs-string">'&lt;b&gt;Hello {{name}}&lt;/b&gt;!'</span></span>, name=name) run(host=<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>)</code> </pre> <br>  (Example from <a href="http://bottlepy.org/docs/dev/index.html">documentation</a> .) <br><br>  When writing more semantic functions (for example, the phone book with preservation in the database), very quickly there is a need to work with the database, then with the cache, then with the sessions.  This creates the need to push the functionality of working with the database into the handler itself, then render it into separate modules in order not to duplicate the code.  After that, the code CRUDL for different objects is rewritten as something like meta-functions. <br><br>  But you can go the other way: start using a <a href="http://bottlepy.org/docs/dev/plugins/index.html">bottle plugin</a> .  On the mechanism of plug-ins and will be discussed in this publication. <br><a name="habracut"></a><br><h3>  About plugins bottle </h3><br>  Python has a strong non-rewriting feature expansion mechanism - <a href="http://habrahabr.ru/post/187482/">decorators</a> . <br><br>  The same mechanism is used as the main one for plugins. <br><br>  In essence, a plugin is a decorator, which is called for each handler when a request falls on it. <br><br>  You can even write such code and it will be considered as a plugin: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bottle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> response, install <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopwatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callback)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> start = time.time() body = callback(*args, **kwargs) end = time.time() response.headers[<span class="hljs-string"><span class="hljs-string">'X-Exec-Time'</span></span>] = str(end - start) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> body <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wrapper install(stopwatch)</code> </pre><br>  (Example from <a href="http://bottlepy.org/docs/dev/plugindev.html">Documentation</a> .) <br><br>  However, it is better to write plugins according to the interface described in the <a href="http://bottlepy.org/docs/dev/plugindev.html">documentation</a> . <br><br>  The plugin features include: <br><br><ul><li>  Getting information about the incoming request <br><ul><li>  which url is called </li><li>  HTTP request content, i.e.  all about request </li></ul><br></li><li>  Formation of the output request <br><br><ul><li>  can change the HTTP header </li><li>  add your variable </li><li>  set your answer content (at least empty) </li></ul><br></li></ul><br><br>  In other words, plugins are a tool for complete control over the processing of a request. <br><br><h3>  How to use the plugin </h3><br>  I will not reprint the <a href="http://bottlepy.org/docs/dev/plugindev.html">bottle-sqlite</a> plugin here, but the use itself is worthy of attention: <br><br><pre> <code class="python hljs">sqlite = SQLitePlugin(dbfile=<span class="hljs-string"><span class="hljs-string">'/tmp/test.db'</span></span>) bottle.install(sqlite) @route(<span class="hljs-string"><span class="hljs-string">'/show/:page'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(page, db)</span></span></span><span class="hljs-function">:</span></span> row = db.execute(<span class="hljs-string"><span class="hljs-string">'SELECT * from pages where name=?'</span></span>, page).fetchone() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> row: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(<span class="hljs-string"><span class="hljs-string">'showpage'</span></span>, page=row) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPError(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"Page not found"</span></span>) @route(<span class="hljs-string"><span class="hljs-string">'/admin/set/:db#[a-zA-Z]+#'</span></span>, skip=[sqlite]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">change_dbfile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db)</span></span></span><span class="hljs-function">:</span></span> sqlite.dbfile = <span class="hljs-string"><span class="hljs-string">'/tmp/%s.db'</span></span> % db <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Switched DB to %s.db"</span></span> % db</code> </pre><br>  (Example from <a href="http://bottlepy.org/docs/dev/plugindev.html">Documentation</a> .) <br><br>  The example shows how to install the plugin, as well as how to use it.  This is what I wrote above.  When using the plugin, it is possible to include an object in the handler itself (in this case, db - sqlite database), which can be safely used. <br><br>  Having reviewed the examples from the documentation, I‚Äôll move on to the actual application. <br><br><h3>  Use cases to use plugins </h3><br>  The first use case can be called probros of some object to the handler itself.  This can be seen in the example of using bottle-sqlite (see code above). <br><br>  The second option can be called this. <br><br>  When writing a web application in the development team, some agreements may be formed on the types of data that are received and returned. <br><br>  In order not to go far, I will give a fictional code: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@route('/report/generate/:filename') def example_handler(filename): try result = generate_report(filename) except Exception as e: result = {'ok': False, 'error': str(e)} response.content_type = 'application/json' return json.dumps(result)</span></span></code> </pre><br>  That is, the team agreed that the return type will be json.  You can duplicate lines each time: <br><br><pre> <code class="python hljs">response.content_type = <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps(result)</code> </pre><br>  This seems to be okay, but only calluses the same lines from function to function.  And if this ‚Äúnothing terrible‚Äù lasts not two lines, but ten?  In this case, plugins can save, we write an elementary function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> response.content_type = <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps(callback(*args, **kwargs))</code> </pre><br>  (I will not give the rest of the plugin, because it is very similar to sqlite.) <br><br>  And reduce the amount of code. <br><br>  Let's go further.  In the agreements we agreed not only to give to json, but also to accept.  It would be great not only to check the HTTP header for a type, but also to check the existence of certain keys.  This can be done, for example, as follows: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen_error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(default_error, text_msg)</span></span></span><span class="hljs-function">:</span></span> res = default_error res.update(dict(error=text_msg)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.get_header(<span class="hljs-string"><span class="hljs-string">'CONTENT_TYPE'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) == <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.json: not_found_keys = [] not_found_keys_flag = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> keys: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.json: not_found_keys.append(key) not_found_keys_flag = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> not_found_keys_flag: wr_res = gen_error(self.default_error, <span class="hljs-string"><span class="hljs-string">'Not found keys: | %s | in request'</span></span> % <span class="hljs-string"><span class="hljs-string">', '</span></span>.join(not_found_keys)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: wr_res = callback(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: wr_res = gen_error( self.default_error, <span class="hljs-string"><span class="hljs-string">'Not found json in request'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: wr_res = gen_error( self.default_error, <span class="hljs-string"><span class="hljs-string">'it is not json request'</span></span>) response.content_type = <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps(wr_res)</code> </pre><br>  And use something like this: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@route('/observer/add', keys=['name', 'latitude', 'longitude', 'elevation']) def observer_add(): return set_observer(request.json)</span></span></code> </pre><br>  The plugin will check for the existence of keys in json, and then the answer will also wrap it in json. <br><br>  Use options, of course, more, as with decorators.  It depends on who and how comes up with them. <br><br><h3>  Existing plugins </h3><br>  The list of plug-ins for bottle is not very <a href="http://bottlepy.org/docs/dev/plugins/index.html">extensive</a> . <br><br>  On github, you can find plugins for session management, i18n, facebook, matplotlib, cql, logging, registration and authorization.  However, their number is significantly inferior to flask and django. <br><br><h3>  findings </h3><br>  Bottle-plug-ins allow you to reduce the amount of duplication of code, pull out general checks (such as ‚Äúauthorized by the user‚Äù) to a common place, extend the functionality and create modules that can be reused. </div><p>Source: <a href="https://habr.com/ru/post/250831/">https://habr.com/ru/post/250831/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250819/index.html">Black Swift - at Embedded World Conference</a></li>
<li><a href="../250821/index.html">The quality of data networks. Software and hardware measurements</a></li>
<li><a href="../250823/index.html">Pebble: accelerometer, example of use</a></li>
<li><a href="../250825/index.html">Web technologies through the eyes of a C ++ programmer</a></li>
<li><a href="../250829/index.html">Computer Interfaces in Cinema - Evolution of Imagination</a></li>
<li><a href="../250833/index.html">How to make friends OpenHAB and Arduino. Method # 3: MQTT</a></li>
<li><a href="../250835/index.html">High Frequency Trading Next Door - Part V (Beginning)</a></li>
<li><a href="../250837/index.html">Introducing the new version of Kerio Control 8.5</a></li>
<li><a href="../250841/index.html">JIT compiler as an academic project at the Academic University</a></li>
<li><a href="../250845/index.html">Anti-patterns of design: Dead End</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>