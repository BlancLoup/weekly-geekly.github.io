<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>mysqlnd - explorer between PHP and MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The mysqlnd extension appeared in PHP 5.3, but is still little known among developers. However, it is indispensable if your system is based on MySQL. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>mysqlnd - explorer between PHP and MySQL</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/234125/"><img src="https://habrastorage.org/files/83a/e02/ade/83ae02aded864136b2fce829ae2f6753.png"></a> <br><br>  The mysqlnd extension appeared in PHP 5.3, but is still little known among developers.  However, it is indispensable if your system is based on MySQL.  If you want to know why this extension is so important, what it is, how to use it and what advantages it gives - read the article. <br><a name="habracut"></a><br><h1>  Interaction scheme </h1>  PHP interacts with MySQL through client libraries.  There are two of them - libmysql and mysqlnd.  The first is licensed by Oracle, while mysqlnd is distributed under the PHP license.  However, both are largely supported by Oracle employees.  If the user needs to interact with MySQL using PHP, then one of the three APIs can be used for this: ext / mysql, ext / mysqli, and ext / pdo_mysql. <br><br><h1>  Libraries </h1> <i><b>libmysql.</b></i>  Historically, PHP needs a client library written in C to interact with MySQL.  It is also known as libmysql, and can be installed on the system with the <code>apt-get install libmysql</code> command.  It implements the MySQL API: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;mysql/mysql.h&gt; #include "mysql_example.h" /* Pour MYSQL_HOST, MYSQL_USER, MYSQL_PASS */ int main(int argv, char *argc[]) { MYSQL_RES *results = NULL; MYSQL_ROW row; MYSQL *db = NULL; db = (MYSQL *)malloc(sizeof(MYSQL)); mysql_init(db); mysql_options(db, MYSQL_INIT_COMMAND, "SET NAMES UTF8;"); if(!mysql_real_connect(db, MYSQL_HOST, MYSQL_USER, MYSQL_PASS, NULL, 0, NULL, 0)) { fprintf(stderr, "Failed to connect to host %s (%s)", MYSQL_HOST, mysql_error(db)); exit(EXIT_FAILURE); } mysql_set_character_set(db, "utf8"); mysql_select_db(db, "my_database"); mysql_query(db , "SELECT user_id AS id FROM users WHERE user_description='member' LIMIT 10000"); results = mysql_use_result(db); while(row = mysql_fetch_row(results)) { printf("%s\n", row[0]); } mysql_free_result(results); exit(EXIT_SUCCESS); }</span></span></span></span></code> </pre><br>  You can execute this code by associating your binary file with libmysql, passing the '-lmysql' parameter to GCC.  All information on working with libmysql is contained in the <a href="http://dev.mysql.com/doc/refman/5.0/en/c-api.html">documentation</a> . <br><br>  As you may have noticed, the PHP extensions mysql and mysqli repeat the API for ease of use.  However, using libmysql can bring some problems: <br><ul><li>  Licensing is quite complicated.  If you want to create a closed commercial product, then you have to <a href="http://www.mysql.com/about/legal/licensing/oem/">pay for the license</a> . </li><li>  Updating libmysql entails updating MySQL server in the case of some distributions.  And this circumstance is usually very few people happy. </li></ul><br>  <i><b>mysqlnd.</b></i>  Starting with PHP 5.3, the code for libmysql was completely rewritten, and the mysqlnd extension, the native mysql extension driver, was born.  This library has a PHP license, which is preferable to an Oracle license. <br><br>  The library code that was not part of PHP (libmysql) was also revised, which made it possible to improve interaction between MySQL and PHP.  It must be remembered that mysqlnd does not pass classes and functions to PHP (this is not quite true, but more on that below).  However, it can serve as a solid foundation for other PHP extensions ‚Äî mysql, mysqli, and pdo_mysql ‚Äî when interacting with MySQL servers.  Starting in PHP 5.4, mysqlnd becomes the default library. <br><br><h1>  Extensions </h1>  There are three extensions with which the PHP user can communicate with MySQL servers. <br><br>  <i><b>mysql.</b></i>  This is the very first and oldest extension, it has been leading its history since the late 90s.  The extension passes the mysql_ function to PHP using the C API, which was taken by the MySQL developers from version 3.23.  Today it is considered obsolete and is not recommended for use, and in recent versions of PHP it leads to the appearance of errors E_DEPRECATED.  <b>Please do not use it in your projects.</b> <br><br>  <i><b>mysqli.</b></i>  ‚ÄúI‚Äù at the end means improved.  This extension appeared in PHP 5.0 and was intended to replace the old ext / mysql API, so it is based on a later version of MySQL 4.1 and higher.  Now it supports stored procedures, secure authentication protocol, prepared expressions (prepared statements) and much more.  The extension also provides the PHP user with a procedural and object-oriented API.  Due to the very high similarity, migration from ext / mysql to ext / mysqli is easy. <br><br>  <i><b>PDO.</b></i>  This extension is noticeably different from mysql / mysqli, since it was designed to support relational database management systems (RDBMS) in general, and not specifically MySQL.  For this reason, the PDO is far from perfect and working with it expects a large number of assumptions from the user, which sometimes results in strange extension behavior.  What is meant? <br><br>  PDO interacts with a SQL parser that emulates prepared expressions if the RDBMS does not support them.  The problem is that the behavior of this level is different from the behavior of the RDBMS.  In the case of MySQL, the PDO emulation level is active by default when you prepare a query.  But he will never reach the level of the prepared expression.  In fact, the PDO code will parse and collect your request without interacting with MySQL on this topic.  This is a strange behavior.  Therefore, disable this emulation level as soon as possible: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*     PDO */</span></span> $pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*   ,       0,   1 */</span></span> $pdo-&gt;setAttribute(PDO::MYSQL_ATTR_DIRECT_QUERY, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  If the emulation level is enabled, the PDO will take care of building the request and send the traditional request to the RDBMS.  But, in view of the many flaws, this can cause strange behavior.  Since PDO knows nothing about table columns, its emulation level will quote each parameter, even a numeric type, in quotes.  This leads to similar errors: <br><br><pre> <code class="php hljs">$stmt = $pdo-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT user_id FROM users LIMIT :limit"</span></span>); $stmt-&gt;bindValue(<span class="hljs-string"><span class="hljs-string">'limit'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $stmt-&gt;execute(); $result = $stmt-&gt;fetch(); var_dump($result); <span class="hljs-comment"><span class="hljs-comment">/* PHP Fatal error: Uncaught exception 'PDOException' with message 'SQLSTATE[42000]: Syntax error or access violation: 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''10'' */</span></span></code> </pre><br>  As you can see, PDO quotes the limit parameter, although this was not necessary.  Let's try to disable the emulation level, leaving only the RDBMS level (in this case, MySQL): <br><br><pre> <code class="php hljs">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Disable prepared statement emulation layer */</span></span> $stmt = $pdo-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT user_id FROM users LIMIT :limit"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* A true prepare() will be sent to the RDBMS, it has to support it */</span></span> $stmt-&gt;bindValue(<span class="hljs-string"><span class="hljs-string">'limit'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $stmt-&gt;execute(); $result = $stmt-&gt;fetch(); var_dump($result); <span class="hljs-comment"><span class="hljs-comment">/* array(4) { ["user_id"]=&gt; string(7) "18" [0]=&gt; string(7) "18" } */</span></span></code> </pre> <br>  Now everything is all right.  If you still need a working level of emulation, then you need to specify the PDO that you do not need to touch the numeric parameters: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/* Tells the PDO prepared statement emulation layer that this column is of type integer (SQL type) */</span></span> $stmt-&gt;bindValue(<span class="hljs-string"><span class="hljs-string">'limit'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, PDO::PARAM_INT);</code> </pre> <br>  But this is not all.  Despite the fact that we have explicitly disabled the emulation level of prepared expressions in PDO, it is still a bit active.  He initiated the parsing of parameters.  There are two kinds of parameter syntax: anonymous parameters, represented as ‚Äú?‚Äù In your fill request, and named parameters, like ‚Äú: myparam‚Äù.  Not every RDBMS supports both syntaxes, and MySQL does not support named, only anonymous.  However, our previous request completed without problems.  The thing is, the PDO request analyzer is still active, even with the emulation level turned off.  He intervened and replaced each named parameter with an anonymous one, because he had previously asked the RDBMS (in this case, MySQL) whether that named syntax supports it.  Since MySQL does not support, then PDO and replaced all ‚Äú: myparamname‚Äù with ‚Äú?‚Äù. <br><br>  In fairness, it should be noted that the API in PDO is well designed and can greatly facilitate the life of a PHP developer.  But if you do not know what is happening at the lower levels, then you will have problems. <br><br><h1>  More details about the mysqli extension </h1>  Today, everyone uses PDO, because it greatly facilitates the transition from one RDBMS to another.  However, if you are using MySQL and are not going to change it, then give up the PDO, otherwise you will lose a lot of time and effort.  Look better at how functional the mysqli API is: <br><br><img src="https://habrastorage.org/files/5da/d4a/eb3/5dad4aeb375a4647b6ba91c33a21a8c6.jpg"><br><br>  mysqli is constantly accused of not generating an exception, it gives errors instead.  This is not true: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $db = mysqli_connect(<span class="hljs-string"><span class="hljs-string">'myserver'</span></span>, <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, <span class="hljs-string"><span class="hljs-string">'secret'</span></span>, <span class="hljs-string"><span class="hljs-string">'unknown_database'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (mysqli_sql_exception $e) { <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>($e-&gt;getMessage()); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mysqli_query($db, <span class="hljs-string"><span class="hljs-string">"SELECT foo FROM bar"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(mysqli_sql_exception $e) { }</code> </pre> <br>  mysqli can even tell you that you forgot about the index: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> mysqli_report(MYSQLI_REPORT_INDEX); $db = mysqli_connect(<span class="hljs-string"><span class="hljs-string">'myserver'</span></span>, <span class="hljs-string"><span class="hljs-string">'myuser'</span></span>, <span class="hljs-string"><span class="hljs-string">'secret'</span></span>, <span class="hljs-string"><span class="hljs-string">'my_database'</span></span>); mysqli_query($db, <span class="hljs-string"><span class="hljs-string">"SELECT photo FROM Users WHERE source ='web' LIMIT 1000"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* PHP Warning: mysqli_query(): (00000/0): No index used in query/prepared statement ... */</span></span></code> </pre> <br>  MySQL provides client communication (in our case, PHP) with many things.  For more information, read the <a href="http://dev.mysql.com/doc/internals/en/client-server-protocol.html">documentation</a> . <br><br>  In mysqli, the character encoding change function is supported: <code>mysqli_set_charset()</code> .  You should never use the "SET NAMES" query.  You can read more about this on <a href="http://php.net/mysqlinfo.concepts.charset.php">php.net</a> or <a href="http://dev.mysql.com/doc/refman/5.7/en/charset-connection.html">dev.mysql.com</a> . <br><br>  Now let's talk about buffered queries.  When you request results in MySQL, that is, when you usually use SELECT queries, a set of data containing the results will be generated.  The idea behind the buffered result sets is to organize where they are stored: in client memory (a buffered query) or leave MySQL (an unbuffered query) on the side.  That's all. <br><br>  Notice that we are talking about direct queries, not about prepared expressions.  By default, every direct query from mysqli to MySQL is buffered.  This means that by the time you make a call to <code>mysqli_query()</code> , the entire result set will already be transferred to memory on the PHP side and released on the MySQL side.  You can count it by <code>mysqli_num_rows()</code> , you can search for <code>mysqli_data_seek()</code> , and you can also make another request until the set is released.  For example: <br><br><pre> <code class="php hljs">$mysqli = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*       : PHP */</span></span> $result = mysqli_query($mysqli, <span class="hljs-string"><span class="hljs-string">"SELECT id, nom, email FROM members"</span></span>); $line1 = mysqli_fetch_row($result); mysqli_data_seek($result, mysqli_num_rows($result)); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> $last_result = mysqli_fetch_row($result); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,   ,       :*/</span></span> mysqli_free_result($result);</code> </pre> <br>  This is a classic case of "default."  Do not forget that the entire set is immediately transferred from MySQL to PHP, so if it can be large, then the amount of memory for PHP will increase proportionally.  However, you will not be able to see this volume using <code>memory_get_usage()</code> , and it will not be taken into account in <i>memory_limit</i> until you use mysqlnd as a low-level connector. <br><br>  If you want to make the same query using an unbuffered result set, use the <i>MYSQLI_USE_RESULT</i> flag.  But be careful, because the result will be stored in the memory of the MySQL process for your connection, and MySQL can only store one set per connection.  Therefore, you will not be able to make another direct request on this connection until you release the set.  In addition, it will not be possible to search or count the amount of data: <br><br><pre> <code class="php hljs">$mysqli = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*        MySQL */</span></span> $result = mysqli_query($mysqli, <span class="hljs-string"><span class="hljs-string">"SELECT id, email FROM members"</span></span>, MYSQLI_USE_RESULT); $line1 = mysqli_fetch_row($result); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,    - ‚Äú ‚Äù */</span></span> mysqli_data_seek($result, mysqli_num_rows($result)); <span class="hljs-comment"><span class="hljs-comment">/*     ,          ,     */</span></span> $result2 = mysqli_query($mysqli, <span class="hljs-string"><span class="hljs-string">"SELECT name FROM membres"</span></span>, MYSQLI_USE_RESULT);</code> </pre> <br>  You can free up data using <code>mysqli_free_result()</code> .  By default, any direct query is done in buffered mode, because the MySQL server has something to do instead of allocating memory to store each set. <br><br>  Now let's talk about prepared expressions.  They are very different from traditional direct requests: <br><ul><li>  Prepared expressions do not use the same protocol as direct queries.  Instead, a binary protocol is used that is highly optimized and provides many features, such as data type binding. </li><li>  Result sets for prepared expressions are not buffered by default, unlike direct queries. </li></ul><br>  Let's start by unloading the protocol for a direct request: <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* params */</span></span>); $q = mysqli_query($m, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM Users LIMIT 1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($r = mysqli_fetch_row($q)) { <span class="hljs-comment"><span class="hljs-comment">/* do something */</span></span> } mysqli_free_result($r);</code> </pre> <br><br><img src="http://jpauli.github.io/img/php-mysql-com/mysql-simple-dump.png"><br><br>  As you can see, this is a text protocol, that is, MySQL sends only text in response.  In the request, you indicated a column of numbers, and in response received the text.  First, it means that in MySQL you will have to take additional steps to convert the data into text.  And secondly, on the PHP side, you only get the string data. <br><br>  The same query in the form of a prepared expression: <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* params */</span></span>); $ps = mysqli_prepare($m, <span class="hljs-string"><span class="hljs-string">'SELECT * FROM Users LIMIT 1'</span></span>); mysqli_stmt_execute($ps); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(mysqli_stmt_fetch($ps)) { <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> } mysqli_stmt_close($ps);</code> </pre> <br><br><img src="http://jpauli.github.io/img/php-mysql-com/mysql-ps-dump.png"><br><br>  Each bind and each sample switches MySQL to receive or transmit data over the network.  We do not see this in the screenshot, but the protocol was binary.  This means that the data in each column is sent as is: numeric as numeric, not string.  Also, the binary protocol allows to save traffic, since the transmission, for example, TINYINT 200 will pull by 1 byte, and in text form - 4 bytes.  There are also other types of network replacements. <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* params */</span></span>); $ps = mysqli_prepare($m, <span class="hljs-string"><span class="hljs-string">'SELECT id FROM Users LIMIT 10'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* id INTEGER */</span></span> mysqli_stmt_execute($ps); mysqli_stmt_bind_result($ps, $id); <span class="hljs-comment"><span class="hljs-comment">/*     $id */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(mysqli_stmt_fetch($ps)) { var_dump($id); } <span class="hljs-comment"><span class="hljs-comment">/* int(62) int(64) */</span></span></code> </pre> <br>  From the above example, you can see that PHP receives numeric data, not string. <br><br>  However, you can save data types using text protocol.  To do this, the client (PHP) must convert the received string data to the correct, expected type.  And only mysqlnd can do this, libmysql will not help: <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); $q = mysqli_query($m, <span class="hljs-string"><span class="hljs-string">'SELECT id FROM users LIMIT 10'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($r = mysqli_fetch_row($q)) { var_dump($r[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-comment"><span class="hljs-comment">/* string(2) "62" string(2) "64" */</span></span> $m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); mysqli_options($m, MYSQLI_OPT_INT_AND_FLOAT_NATIVE, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     mysqlnd */</span></span> $q = mysqli_query($m, <span class="hljs-string"><span class="hljs-string">'SELECT id FROM users LIMIT 10'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($r = mysqli_fetch_row($q)) { var_dump($r[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-comment"><span class="hljs-comment">/* int(62) int(64) */</span></span></code> </pre> <br>  The result sets for prepared expressions are not buffered by default, and each <code>fetch()</code> operation will start a network data exchange.  However, you can buffer sets with <code>mysqli_stmt_store_result()</code> . <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); $ps = mysqli_prepare($m, <span class="hljs-string"><span class="hljs-string">'SELECT id, name FROM Users LIMIT 1000'</span></span>); mysqli_stmt_execute($ps); mysqli_stmt_bind_result($ps, $id, $name); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> mysqli_stmt_store_result($ps); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(mysqli_stmt_fetch($ps)) { <span class="hljs-comment"><span class="hljs-comment">/* do something with $id and $name */</span></span> } mysqli_stmt_close($ps);</code> </pre> <br>  We can buffer sets, but in the case of prepared expressions, you must bind each column with the results to a PHP variable in order to be able to read the data.  And yet, if you use mysqlnd, then <code>mysqli_stmt_get_result()</code> is available to you, which turns the result set for the prepared expression into mysqli_result.  This allows you to use the API for direct requests, but with prepared expressions: <br><br><pre> <code class="php hljs">$m = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* params */</span></span>); $ps = mysqli_prepare($m, <span class="hljs-string"><span class="hljs-string">'SELECT id, name FROM Users LIMIT 1000'</span></span>); mysqli_stmt_execute($ps); <span class="hljs-comment"><span class="hljs-comment">/*    mysqli_result */</span></span> $r = mysqli_stmt_get_result($ps); <span class="hljs-comment"><span class="hljs-comment">/*    mysqlnd */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($result = mysqli_fetch_row($r)) { <span class="hljs-comment"><span class="hljs-comment">/* API   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  - */</span></span> } mysqli_free_result($r); mysqli_stmt_close($ps);</code> </pre> <br><h1>  Learn more about the mysqlnd extension. </h1>  We have already figured out that mysqlnd works as a hidden extension that adds many new features to existing APIs, especially mysqli (this is also true for PDO, only to a lesser extent). <br><br><h3>  Memory saving </h3>  Recall some points: <br><ul><li>  A buffered query retrieves all results from MySQL to PHP memory. </li><li>  A buffered result set is created by the library, which is used for communication in both mysqlnd and libmysql. </li><li>  The result set is not used directly in the PHP environment, it must first be converted into an array in a PHP structure, this operation is called fetch. </li></ul><br>  In the example below, a huge part of the memory is lost: <br><br><pre> <code class="php hljs">$db = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); $result = mysqli_query($db, <span class="hljs-string"><span class="hljs-string">"SELECT very_huge_blob_column, lots, of, columns FROM foobar"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($results[] = mysqli_fetch_row($result)) { } mysqli_free_result($result); <span class="hljs-comment"><span class="hljs-comment">/*    ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($results <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $foo) { <span class="hljs-comment"><span class="hljs-comment">/*  - */</span></span> }</code> </pre> <br>  Let us prove this statement: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memory_usage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $pid = getmypid(); $r = explode(<span class="hljs-string"><span class="hljs-string">':'</span></span>,shell_exec(<span class="hljs-string"><span class="hljs-string">"grep VmData /proc/$pid/status"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'-&gt;'</span></span>.trim($r[<span class="hljs-number"><span class="hljs-number">1</span></span>]).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } $db = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"initial memory "</span></span> . memory_usage(); $result = mysqli_query($db,<span class="hljs-string"><span class="hljs-string">"SELECT very_huge_blob_column FROM foobar"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"resultSet stored "</span></span> . memory_usage(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($results[] = mysqli_fetch_row($result)) { } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"query result saved "</span></span> . memory_usage(); mysqli_free_result($result); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"resultSet freed "</span></span> . memory_usage(); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($results); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"saved result freed "</span></span> . memory_usage(); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($db); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Db closed "</span></span> . memory_usage();</code> </pre> <br>  In libmysql: <br><br><pre> <code class="php hljs">&gt; phplibmysql/bin/php poc_mysqli.php initial memory -&gt;<span class="hljs-number"><span class="hljs-number">3348</span></span> kB resultSet stored -&gt;<span class="hljs-number"><span class="hljs-number">72724</span></span> kB query result saved -&gt;<span class="hljs-number"><span class="hljs-number">149012</span></span> kB resultSet freed -&gt;<span class="hljs-number"><span class="hljs-number">81156</span></span> kB saved result freed -&gt;<span class="hljs-number"><span class="hljs-number">25348</span></span> kB Db closed -&gt;<span class="hljs-number"><span class="hljs-number">24260</span></span> kB</code> </pre> <br>  As you can see, as soon as <code>mysqli_query()</code> is <code>mysqli_query()</code> , all result sets are sent to PHP memory.  Its volume increases from 3 to 70 MB.  This is normal for direct buffered queries.  It is important to understand that the memory buffer was allocated by the library libmysql.  And when you need to convert the results into a suitable form for PHP, all the data from the result set will be duplicated into memory, which leads to its swelling. <br><br>  If the buffer is allocated to libmysql, then it will not be displayed in <code>memory_get_usage()</code> , and you will have to monitor your processes in order to notice it in time. <br><br>  Converting all the data from the set into a PHP variable just explodes your memory.  At this stage, the buffer is still allocated and the data is completely duplicated into the PHP array, so 140 MB of memory is already occupied.  Let's verify this by running a memory analyzer: <br><br><pre> <code class="php hljs"><span class="hljs-number"><span class="hljs-number">99.92</span></span>% (<span class="hljs-number"><span class="hljs-number">257</span></span>,<span class="hljs-number"><span class="hljs-number">473</span></span>,<span class="hljs-number"><span class="hljs-number">815</span></span>B) (heap allocation functions) malloc/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[], --alloc-fns, etc. -&gt;<span class="hljs-number"><span class="hljs-number">52.90</span></span>% (<span class="hljs-number"><span class="hljs-number">136</span></span>,<span class="hljs-number"><span class="hljs-number">314</span></span>,<span class="hljs-number"><span class="hljs-number">880</span></span>B) <span class="hljs-number"><span class="hljs-number">0x69A01E</span></span>: _zend_mm_alloc_int (zend_alloc.c:<span class="hljs-number"><span class="hljs-number">1908</span></span>) | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x69A1DE</span></span>: _estrndup (zend_alloc.c:<span class="hljs-number"><span class="hljs-number">2503</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x533BCE</span></span>: php_mysqli_fetch_into_hash (mysqli.c:<span class="hljs-number"><span class="hljs-number">1191</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x53F2E1</span></span>: zif_mysqli_fetch_row (mysqli_nonapi.c:<span class="hljs-number"><span class="hljs-number">352</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x70186A</span></span>: zend_do_fcall_common_helper_SPEC (zend_vm_execute.h:<span class="hljs-number"><span class="hljs-number">320</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x6D9D96</span></span>: execute (zend_vm_execute.h:<span class="hljs-number"><span class="hljs-number">107</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x6B4B98</span></span>: zend_execute_scripts (zend.c:<span class="hljs-number"><span class="hljs-number">1236</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x663D0C</span></span>: php_execute_script (main.c:<span class="hljs-number"><span class="hljs-number">2308</span></span>) | | -&gt;<span class="hljs-number"><span class="hljs-number">52.60</span></span>% (<span class="hljs-number"><span class="hljs-number">135</span></span>,<span class="hljs-number"><span class="hljs-number">528</span></span>,<span class="hljs-number"><span class="hljs-number">448</span></span>B) <span class="hljs-number"><span class="hljs-number">0x73BCDC</span></span>: main (php_cli.c:<span class="hljs-number"><span class="hljs-number">1184</span></span>) | | | -&gt;<span class="hljs-number"><span class="hljs-number">00.31</span></span>% (<span class="hljs-number"><span class="hljs-number">786</span></span>,<span class="hljs-number"><span class="hljs-number">432</span></span>B) in <span class="hljs-number"><span class="hljs-number">1</span></span>+ places, all below ms_print<span class="hljs-string"><span class="hljs-string">'s threshold (01.00%) | -&gt;45.85% (118,130,675B) 0x52DD010: my_malloc (my_malloc.c:37) | -&gt;45.84% (118,112,344B) 0x52E0583: alloc_root (my_alloc.c:219) | | -&gt;45.83% (118,096,024B) 0x5307A40: cli_read_rows (client.c:1418) | | | -&gt;45.83% (118,096,024B) 0x5305955: mysql_store_result (client.c:2957) | | | -&gt;45.83% (118,096,024B) 0x53EF09: zif_mysqli_query (mysqli_nonapi.c:540) | | | -&gt;45.83% (118,096,024B) 0x70186A: zend_do_fcall_common_helper_SPEC (zend_vm_execute.h:320) | | | -&gt;45.83% (118,096,024B) 0x6D9D96: execute (zend_vm_execute.h:107) | | | -&gt;45.83% (118,096,024B) 0x6B4B98: zend_execute_scripts (zend.c:1236) | | | -&gt;45.83% (118,096,024B) 0x663D0C: php_execute_script (main.c:2308) | | | -&gt;45.83% (118,096,024B) 0x73BCDC: main (php_cli.c:1184)</span></span></code> </pre> <br>  To release the result set, you need to call <code>mysqli_free_result()</code> .  After that, the occupied memory will be reduced to 70 MB.  And when we finally release the PHP array containing the copy of the set, the memory will return to its previous size. <br><br>  Duplication can be prevented using mysqlnd. <br><br><pre> <code class="php hljs">&gt; phpmysqlnd/bin/php poc_mysqli.php initial memory -&gt;<span class="hljs-number"><span class="hljs-number">3208</span></span> kB resultSet stored -&gt;<span class="hljs-number"><span class="hljs-number">70452</span></span> kB query result saved -&gt;<span class="hljs-number"><span class="hljs-number">71220</span></span> kB resultSet freed -&gt;<span class="hljs-number"><span class="hljs-number">81148</span></span> kB saved result freed -&gt;<span class="hljs-number"><span class="hljs-number">19196</span></span> kB Db closed -&gt;<span class="hljs-number"><span class="hljs-number">19196</span></span> kB</code> </pre> <br>  When a buffered set is converted to a PHP array, the amount of memory does not change.  Only when you start writing to this array, that is, modifying it, will PHP double the amount of memory for the result, on a case-by-case basis.  Also, mysqlnd uses a memory allocator to store the result set in its own buffer, memory is shared with PHP, <code>memory_get_usage()</code> will show this memory, and you can even get access to <i>memory_limit</i> . <br><br>  Another approach prevents any ‚Äúsampling of everything‚Äù operation.  In PDO, <code>$stmt-&gt;fetchAll()</code> transforms all result sets into a PHP variable.  This allows more economical use of memory for searching in a set and obtaining actual data with the subsequent conversion of any string into a section of a PHP array. <br><br><h3>  Statistics </h3><img src="http://jpauli.github.io/img/php-mysql-com/mysqlnd-stats-phpinfo.png"><br><br>  mysqlnd sees everything - every byte passing between PHP and the MySQL server, and can collect very useful statistics.  You can easily get answers to many important questions without using monitoring plugins: <br><ul><li>  How many MySQL connections are active? </li><li>  How many mistakes were there in the mix? </li><li>  How many requests were prepared but not executed? (   ) </li><li>    ,    ? (      ) </li><li>   ,    ? </li><li>    MySQL-? </li><li>     ? </li></ul><br> mysqlnd      : <br><br><pre> <code class="php hljs">$db = mysqli_connect(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); $result = mysqli_query($db,<span class="hljs-string"><span class="hljs-string">"SELECT user_id, email FROM users LIMIT 5"</span></span>); mysqli_data_seek($result, <span class="hljs-number"><span class="hljs-number">5</span></span>); $data = mysqli_fetch_row($result); do_something($data); mysqli_free_result($result); var_dump(mysqli_get_connection_stats($db)); <span class="hljs-comment"><span class="hljs-comment">/* only available under mysqlnd */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ["buffered_sets"]=&gt; string(1) "1" ["rows_fetched_from_server_normal"]=&gt; string(1) "5" ["rows_buffered_from_client_normal"]=&gt; string(1) "5" ["rows_fetched_from_client_normal_buffered"]=&gt; string(1) "1" ["connect_success"]=&gt; string(1) "1" ["connect_failure"]=&gt; string(1) "0" ["connection_reused"]=&gt; string(1) "0" ["reconnect"]=&gt; string(1) "0" ["active_connections"]=&gt; string(1) "1" */</span></span></code> </pre> <br>  5 ,    ,  , ,   .   5   ?   ,     ,  <i>rows_fetched_from_client_normal_buffered</i>  ,        .       ,   MySQL    PHP-. <br><br>  mysqli-,    : <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JPMysqli</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mysqli</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $stats = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get_connection_stats(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($diff = $stats[<span class="hljs-string"><span class="hljs-string">"rows_fetched_from_server_normal"</span></span>] - ($stats[<span class="hljs-string"><span class="hljs-string">"rows_fetched_from_client_normal_unbuffered"</span></span>] + $stats[<span class="hljs-string"><span class="hljs-string">"rows_fetched_from_client_normal_buffered"</span></span>])) { trigger_error(<span class="hljs-string"><span class="hljs-string">"   *$diff*   "</span></span>, E_USER_NOTICE); } } } $db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JPMysqli(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>); $result = mysqli_query($db,<span class="hljs-string"><span class="hljs-string">"SELECT user_id, email FROM users LIMIT 5"</span></span>); mysqli_data_seek($result, <span class="hljs-number"><span class="hljs-number">5</span></span>); $data = mysqli_fetch_row($result); do_something($data); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/* Notice : "    *4*    " */</span></span></code> </pre> <br>        ,       .    Symfony2,    <a href="https://packagist.org/packages/js/mysqlnd-bundle">mysqlnd-bundle</a>  <a href="https://packagist.org/packages/js/mysqlnd-analytics">mysqlnd-analytics</a> . <br><br><h3>  Plugins </h3>  mysqlnd      .      .      : <br><ul><li> mysqlnd_qc.           . </li><li> mysqlnd_ms. Master-Slave ,        .     . </li><li> myslnd_uh.  .       PHP (  ).    mysqlnd-   ,   SQL-, . </li></ul><br><h1>  Conclusion </h1> ,     ,  PHP   MySQL-.  ,  mysqlnd      ,    -  . <br><br>   Ulf Wendel, Andrey Hristov, Georg Richter  Johannes Schl√ºter ‚Äì   mysqlnd. </div><p>Source: <a href="https://habr.com/ru/post/234125/">https://habr.com/ru/post/234125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234111/index.html">Parallels Plesk 12 Review. VPS Trial Version Free</a></li>
<li><a href="../234117/index.html">5 WordPress Plugins to Strengthen Site Behavioral and Social Metrics</a></li>
<li><a href="../234119/index.html">Checking the Cocos2d-x cross-platform framework</a></li>
<li><a href="../234121/index.html">About cosmic warmth and cold</a></li>
<li><a href="../234123/index.html">How does attracting money to a startup on Visistarte</a></li>
<li><a href="../234127/index.html">Will 2014 be "the year of VoLTE"?</a></li>
<li><a href="../234131/index.html">Unity Android - now on x86!</a></li>
<li><a href="../234133/index.html">ROM for 1 kilobyte of Minecraft blocks</a></li>
<li><a href="../234139/index.html">Video surveillance from idea to ... idea</a></li>
<li><a href="../234141/index.html">The reverse side of the coin or what the CCIE laboratory exam looks like from the other side</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>