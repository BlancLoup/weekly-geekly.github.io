<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java with assembly inserts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, in any language you can write as in Java, and the first love of javista is the writing of Garbage Collectors and JIT Compilers. Many deli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java with assembly inserts</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/r5/yd/cd/r5ydcd6c0t4a_df1rfsgrlvpogk.png"></div><br><br><p>  As you know, in any language you can write as in Java, and the first love of javista is the writing of Garbage Collectors and JIT Compilers.  Many delightful questions are connected with this, for example: how can one directly work with machine code and assembler from managed code? </p><br><p>  In addition, this article will be a small example in C #.  At some point, it became clear that you cannot always learn one Java.  Runtime dynamic languages ‚Äã‚Äãuse a general theory and in practice work within similar problems.  The easiest way to promote your work is to see what your neighbors are doing and copy something good for yourself. </p><br><p>  Now about the assembler and machine code.  Why this is needed - an open question.  For example, you have heard enough about Meltdown and want to write a beautiful API for it :-) Well, don't forget that Oracle is not gods, <a href="https://bugs.openjdk.java.net/browse/JDK-8076276">support for the same AVX-512 was</a> added only in Nine, direct control of hardware transactional memory does not fall on the language, Some standard methods can be implemented better than they did in the SDK, etc.  - we always have something to dig! </p><a name="habracut"></a><br><p>  There are two levels in the problem: </p><br><ul><li> Cannot directly zainlaynit machine code or x86-assembler in Java-code (insert construction <code>__asm()</code> ) </li><li>  you cannot directly execute them (however, in the absence of syntax, it is difficult to get to this problem) </li></ul><br><p>  But you can operate some hacks, which will be further. </p><br><h1 id="naivnyy-variant-a-vozmyom-i-zapustim">  Naive option: take and run! </h1><br><p>  As you know, you can run native code using JNI. <br>  So, we in C ++ can safely dynamically generate the machine code and then pull it. </p><br><p>  To do this, create a memory segment that is available for recording and execution at the same time. </p><br><p>  Here is an example for Windows with VirtualAllocEx (in <a href="https://linux.die.net/man/2/mprotect">posix</a> there is <a href="https://linux.die.net/man/2/mprotect">mprotect (2)</a> , but I'm lazy). <br>  Try to understand what he is doing.  If there is no <code>PAGE_EXECUTE_READWRITE</code> , then this code will immediately kill Data Execution Prevention in Windows. </p><br><pre> <code class="hljs django"><span class="xml"><span class="xml">#include </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">stdio.h</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> #include </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">windows.h</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> typedef unsigned char byte; int arg1; int arg2; int res1; typedef void (*pfunc)(void); union funcptr { pfunc x; byte* y; }; int main( void ) { byte* buf = (byte*)VirtualAllocEx( GetCurrentProcess(), 0, 1</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">MEM_COMMIT</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">PAGE_EXECUTE_READWRITE</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buf</span></span></span></span><span class="xml"><span class="hljs-tag">==</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">byte</span></span></span></span><span class="xml"><span class="hljs-tag">* </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">buf;</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x50;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">push</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x52;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">push</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xA1;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">] (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">*&amp;)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">&amp;arg2;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">sizeof(int*);</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x92;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xchg</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xA1;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">] (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">*&amp;)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">&amp;arg1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">sizeof(int*);</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xF7;</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xEA;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">imul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xA3;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">res1</span></span></span></span><span class="xml"><span class="hljs-tag">],</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">*&amp;)</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">&amp;res1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">+=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">sizeof(int*);</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x5A;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0x58;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> *</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">p</span></span></span></span><span class="xml"><span class="hljs-tag">++ = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0xC3;</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ret</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">funcptr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">func</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">func.y</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">buf;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">123;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">321;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">res1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">func.x</span></span></span></span><span class="xml"><span class="hljs-tag">(); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">call</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">generated</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">code</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">printf</span></span></span></span><span class="xml"><span class="hljs-tag">( "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">%i</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">%i</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">%i</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">func</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">)=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">%i\n</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg1</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arg2</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">res1</span></span></span></span><span class="xml"><span class="hljs-tag"> ); }</span></span></span></span></code> </pre> <br><p>  Of course, doing it manually is not the most sensible idea, and you need to drag some <a href="https://github.com/asmjit/asmjit">AsmJit</a> .  Then from the Java-code we forward specific data, than we fill the buffer, and oh - rolled! </p><br><p>  The problem here is that from inline we are expecting a slightly more fat functionality.  I want to have access to the entire context of the call, plus pull the various system pieces from the SDK.  It is probably possible to make this independent - but long and painful.  Fortunately, everything is stolen before us. </p><br><h1 id="java-native-interface">  Java Native Interface </h1><br><p>  You can still use JNI, but in a different way. </p><br><p>  Suppose we have this class: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyJNIClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printVersion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  The idea is to name the symbol in accordance with the convention of names in JNI, and then it will do everything.  In our case, it will look something like <code>Java_MyJNIClass_printVersion</code> . </p><br><p>  The symbol must be visible from other translation units, and this can be done in NASM using the <code>global</code> directive or in FASM using the <code>public</code> . </p><br><p>  The ASM itself must be written with an understanding of the calling conventions in the architecture used (arguments can be in registers, on the stack, in other memory structures, etc.).  The first argument that arrives in the function will be a pointer to <code>JNIEnv</code> , and it, in turn, will be a pointer to the JNI function table. </p><br><p>  For example, NASM under x86_64 will look like this: </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> Java_MyJNIClass_printVersion section .<span class="hljs-keyword"><span class="hljs-keyword">text</span></span> Java_MyJNIClass_printVersion: mov rax, [rdi] call [rax + <span class="hljs-number"><span class="hljs-number">8</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span>] ; pointer <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x86_64 * index of GetVersion ...</code> </pre> <br><p>  Where <code>GetVersion</code> magic index <code>GetVersion</code> ?  Very simple: they <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/functions.html">are listed in the documentation</a> . </p><br><p>  Here is the <code>GetVersion</code> description: </p><br><pre> <code class="hljs pgsql">GetVersion jint GetVersion(JNIEnv *env); <span class="hljs-keyword"><span class="hljs-keyword">Returns</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the native <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> interface. LINKAGE: <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the JNIEnv interface <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>. PARAMETERS: env: the JNI interface pointer. <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Returns</span></span> the major <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the higher <span class="hljs-number"><span class="hljs-number">16</span></span> bits <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> the minor <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the lower <span class="hljs-number"><span class="hljs-number">16</span></span> bits. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> JDK/JRE <span class="hljs-number"><span class="hljs-number">1.1</span></span>, GetVersion() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-number"><span class="hljs-number">0x00010001</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> JDK/JRE <span class="hljs-number"><span class="hljs-number">1.2</span></span>, GetVersion() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-number"><span class="hljs-number">0x00010002</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> JDK/JRE <span class="hljs-number"><span class="hljs-number">1.4</span></span>, GetVersion() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-number"><span class="hljs-number">0x00010004</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> JDK/JRE <span class="hljs-number"><span class="hljs-number">1.6</span></span>, GetVersion() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-number"><span class="hljs-number">0x00010006</span></span>.</code> </pre> <br><p>  As you can see, the table of functions is just some sort of pointer array.  You need to remember to multiply these indexes by the size of the pointer in the target architecture, of course. </p><br><p>  The second argument is a reference to the class or object that called the function.  All of the following arguments are parameters of the method declared as <code>native</code> in the Java code. </p><br><p>  Next you need to assemble an object from the assembler: <code>nasm -f elf64 -o GetVersion.o GetVersion.asm</code> <br>  From the object library, the library: <code>gcc -shared -z noexecstack -o libGetVersion.so GetVersion.o</code> <br>  And finally collect the file itself: <code>javac MyJNIClass.java</code> </p><br><p>  You can perform much more complex operations.  Here is an example of <a href="">adding elements of an array</a> . </p><br><p>  And it seems that everything would be fine, but I want a few things. </p><br><p>  First, if we code in Java, I would like to have a nice syntax for creating an assembler with static checks (whatever that means in this case), etc.  I‚Äôm blonde and I want registers to choose in IDE autocompletion, and not to be afraid to be sealed in one letter.  Well, at least, let it be a Java API. </p><br><p>  Secondly, it is not a good idea to assemble the library by hand next to the code.  Well, collect files one by one - a complete bottom.  We need infrastructure that will allow not to care about such things.  For example, let an asm code be inline, or a plugin in Maven, or distribute as part of a modified JDK. </p><br><p>  Thirdly, it is not clear whether it is worth choosing an assembler as an abstraction, because there are many different representations. </p><br><h1 id="biblioteki">  Libraries </h1><br><p>  Immediately wrote to the dudes from Oracle, who are engaged in machine code in Java, and received the answer: they do not know normal beautiful libraries. </p><br><p>  But you still need to go to Google, we're not lazy.  Use the keyword "java call x86 assembly library" and meditate on the result. </p><br><p>  The results show that from the point of view of libraries everything is really bad.  Googling a few unfinished things, including <a href="http://www.jembryos.org/inline.html">The Machine Level Java</a> . </p><br><p>  And there even has a beautiful API (how beautiful it can be when using constructs from Java): </p><br><pre> <code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleNativeDemo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X86InlineAssembly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">X86InlineAssembly</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">successor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InlineAssembly</span></span></span><span class="hljs-class"> </span></span>{ static <span class="hljs-comment"><span class="hljs-comment">// static initializer { InlineAssemblyHelper.initializeNativeCode_deleteExistingLibraryAndNoExceptions(new SimpleNativeDemo(System.out)); } // constructor, which defines x86 architecture as a native method's target public SimpleNativeDemo(OutputStream debugStream) { super(Architectures.X86.architecture, false, debugStream); } // native method declaration public static native long multiply(int x, int y); // native method implementation @Override public void writeNativeCode() { parameterIn(r.EAX,IP.In0.ordinal()); parameterIn(r.EBX,IP.In1.ordinal()); mul.x32(r.EBX); } }</span></span></code> </pre> <br><p>  It gives us the syntax (without modifying the Java parser), and the method of execution is good. </p><br><p>  Almost the main problem here is that inside there is a very complex code that needs to be maintained.  It is part of <a href="http://www.jembryos.org/index.html">jEmbryOS</a> - a project to create an entire operating system in Java.  And externally, the project is not very much alive: it is still on Sourceforge (and it is not on GitHub and other popular modern hosting systems), an empty forum with the latest message for 2014.  The last nail in the coffin was that in the 2015 release on Sourceforge there is no license file - you can‚Äôt use a code without a license (the default copyright rules that make such a read-only code apply). </p><br><p>  Okay, that didn't work out.  But in the future you can write yourself, the good is that the idea is clear. </p><br><h1 id="intrinsiki">  Intrinsiki </h1><br><p>  On this occasion there is a whole report here: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/76gyiCteq-I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  If it is worth going to the conference at all, then just for such reports.  Volker zhzhot. <br>  By the way, he will be at the next <a href="https://2018.jbreak.ru//">JBreak in Novosibirsk</a> , with another annealing about the <a href="https://2018.jbreak.ru/talks/76so01njvm2a0eqgagysm/">class data sharing</a> . </p><br><p>  In short, in OpenJDK we have the magic file <code>src/share/vm/classfile/vmSymbols.hpp</code> .  Just <a href="">open it in the browser by the link</a> and you will understand everything.  We can catch specific methods and replace them with an assembler.  Well, rebuild OpenJDK with these changes, of course. </p><br><p>  IMHO, if you really resist, you can do this: write a preprocessor for .java-classes that will catch calls to constructions like <code>__asm("ret")</code> , then generate a patch for intrinsics from them and automatically rebuild OpenJDK. </p><br><p>  Why does this solution seem not so pleasant to me?  First, changing intrinsik leads to rebuilding a large part of OpenJDK.  So you have to drink tea very often, smoke, <del>  get drunk with grief </del>  and kill time in other ways, while hot as a stove a laptop pereklebashivaet C ++. </p><br><p>  Secondly, intrinsics do not work in exactly the same way as native methods.  If we work in JNI in normal mode and the JVM can always roll back to safepoint, then in the case of intrinsic it does not work.  It will be necessary to sweat in order to not break something fatally. </p><br><p>  And thirdly, there is a suspicion that a normal person will not be very pleased to contact this part of OpenJDK.  Most of the code there consists of a serious witch in which you can get bogged down. </p><br><h1 id="a-chto-tam-u-net">  And what about. NET? </h1><br><p>  Some shock was the fact that the dotnetchikov has a completely different approach.  They may not wrap the assembler at all, but run the native code directly from C #! </p><br><p>  The idea set an example, written <a href="https://blogs.msdn.microsoft.com/devinj/2005/07/13/dynamically-writing-and-executing-native-assembly-in-c/">back in 2005</a> .  Unfortunately, the code on the link does not work, because it will be immediately beaten by DEP.  I had to modify it a bit by dragging debris from <code>kernel32.dll</code> : through pinvoke, get <code>VirtualAllocEx</code> and the flags it needs - <code>AllocationType</code> and <code>MemoryProtection</code> .  This is exactly the same trick we used in the C ++ example. </p><br><p>  For simplicity of example, let there be a method that returns an answer to the most important question of Life, the Universe and Everything Else: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { [DllImport(<span class="hljs-string"><span class="hljs-string">"kernel32.dll"</span></span>, SetLastError = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, ExactSpelling = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VirtualAllocEx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hProcess, IntPtr lpAddress, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwSize, AllocationType flAllocationType, MemoryProtection flProtect</span></span></span><span class="hljs-function">)</span></span>; [Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> AllocationType { Commit = <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, Reserve = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>, Decommit = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>, Release = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>, Reset = <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, Physical = <span class="hljs-number"><span class="hljs-number">0x400000</span></span>, TopDown = <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, WriteWatch = <span class="hljs-number"><span class="hljs-number">0x200000</span></span>, LargePages = <span class="hljs-number"><span class="hljs-number">0x20000000</span></span> } [Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> MemoryProtection { Execute = <span class="hljs-number"><span class="hljs-number">0x10</span></span>, ExecuteRead = <span class="hljs-number"><span class="hljs-number">0x20</span></span>, ExecuteReadWrite = <span class="hljs-number"><span class="hljs-number">0x40</span></span>, ExecuteWriteCopy = <span class="hljs-number"><span class="hljs-number">0x80</span></span>, NoAccess = <span class="hljs-number"><span class="hljs-number">0x01</span></span>, ReadOnly = <span class="hljs-number"><span class="hljs-number">0x02</span></span>, ReadWrite = <span class="hljs-number"><span class="hljs-number">0x04</span></span>, WriteCopy = <span class="hljs-number"><span class="hljs-number">0x08</span></span>, GuardModifierflag = <span class="hljs-number"><span class="hljs-number">0x100</span></span>, NoCacheModifierflag = <span class="hljs-number"><span class="hljs-number">0x200</span></span>, WriteCombineModifierflag = <span class="hljs-number"><span class="hljs-number">0x400</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntReturner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; bodyBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); bodyBuilder.Add(<span class="hljs-number"><span class="hljs-number">0xb8</span></span>); bodyBuilder.AddRange(BitConverter.GetBytes(<span class="hljs-number"><span class="hljs-number">42</span></span>)); bodyBuilder.Add(<span class="hljs-number"><span class="hljs-number">0xc3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] body = bodyBuilder.ToArray(); IntPtr buf = VirtualAllocEx(Process.GetCurrentProcess().Handle, (IntPtr) <span class="hljs-number"><span class="hljs-number">0</span></span>, Convert.ToUInt32(body.Length), AllocationType.Commit, MemoryProtection.ExecuteReadWrite); Marshal.Copy(body, <span class="hljs-number"><span class="hljs-number">0</span></span>, buf, body.Length); IntReturner ptr = (IntReturner) Marshal.GetDelegateForFunctionPointer(buf, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IntReturner)); Console.WriteLine(ptr()); Console.ReadKey(); } }</code> </pre> <br><p>  If we suddenly needed a smarter example with parameters, <code>Marshal</code> can allocate unmanaged memory using <code>AllocHGlobal</code> , clean <code>FreeHGlobal</code> and another pack of methods on the same topic. </p><br><p>  Having such superpowers, you can create real game, for example, <a href="https://www.tophertimzen.com/blog/dotNetMachineCodeManipulation/">replace methods in classes</a> .  Before publishing this article, I looked at a large number of projects on GitHub, but, unfortunately, none of these hacks could do without C ++, unsafe and, the saddest thing, is very voluminous code.  So here I will not write all of this and put it in a separate article on hacks in .NET. </p><br><h1 id="jvm-compiler-interface">  JVM Compiler Interface </h1><br><p>  Turning the brains in the right direction, it becomes clear that in Java you can solve the problem in a similar way.  The fact is that in Java 9 <a href="http://openjdk.java.net/jeps/243">JEP 243 is</a> implemented <a href="http://openjdk.java.net/jeps/243">: Java-Level JVM Compiler Interface</a> . </p><br><p>  The developers of this feature understood that the JIT compiler is a serious <del>  piece of govnokod </del>  software that would be good to develop separately, using all possible features of the java ecosystem, such as good free IDEs.  Not all of these features can be used inside OpenJDK - usually you open its code in the IDE, everything is red and ten times highlighted as an error.  There is some justification for a monolithic architecture in subsystems that need direct access to various internal mechanisms (for example, this is needed by the bytecode interpreter or the garbage collector) ‚Äîbut the compiler doesn't care. </p><br><p>  Hence the idea to separate the compiler into a separate entity.  The connection should be made conveniently, in the form of a plug-in, included from the command line.  So was born JVMCI. </p><br><p>  In short, we have the simplest interface: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">JVMCICompiler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] bytecode</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  The Java bytecode arrives at the input, the native code arrives at the output.  Much like what was higher in C #.  We have this in something even better, because such use is not a dirty side effect, but the main use pattern. </p><br><p>  In reality, simply bytecode is not enough.  This is rather a <code>CompilationRequest</code> with additional fields: </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">JVMCICompiler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CompilationRequest request</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">CompilationRequest</span></span> { <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">JavaMethod</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; ... }</code> </pre> <br><p>  Whether long, shortly, you compiled bytecode, and you can safely install it using <code>HotSpot.installCode(...);</code> </p><br><p>  Including, such an approach can solve the initial problem with intrinsics - the need to rebuild OpenJDK. </p><br><p>  The problem part here is that writing your own JVMCI implementation is not a very quick and easy task.  Documentation on this feature is almost absent.  The only comprehensive documentation is the OpenJDK code in C ++, which I really don't want to read. </p><br><p>  But here everything is stolen for us. </p><br><h1 id="graal-i-truffle">  Graal and truffle </h1><br><p>  In the dark scary basements of Oracle Labs, several cool tools are being developed that will change the picture for everyone who is expanding OpenJDK in the near future.  These projects are united under the common name Graal and lie <a href="https://github.com/oracle/graal">here in this repository on GitHub</a> . </p><br><p>  Including: </p><br><ul><li>  <a href="https://github.com/oracle/graal/blob/master/compiler">Graal</a> is an optimizing compiler written in Java and integrating with HotSpot JVM </li><li>  <a href="https://github.com/oracle/graal/blob/master/truffle">Truffle</a> - a framework for creating languages ‚Äã‚Äãand languages ‚Äã‚Äãusing Graal as its main compiler </li><li>  <a href="https://github.com/oracle/graal/blob/master/substratevm">Substrate VM</a> - a framework that allows you to do ahead-of-time (AOT) compilation of Java applications and turn them into executable files </li></ul><br><p>  Interestingly, Graal and Truffle provide their own JVMCI implementation.  And this support is already in OpenJDK 9 - just connect the necessary flags.  Connecting these flags, of course, will not save us from rebuilding Graal itself, but it does show how seriously the developers got down to business.  It shows that all this has already been sufficiently tested and matured in order to turn into an official feature. </p><br><p>  Very good about how Graal works, <a href="http://chrisseaton.com/rubytruffle/jokerconf17/">told Chris Seaton</a> .  By the way, this article was written based on his speech on <a href="https://jokerconf.com/">Joker 2017</a> . </p><br><p>  Now to the question of how well all this works and is applicable in practice.  <a href="http://2017.jokerconf.com/2017/talks/3qdblcadmqy0me2uuieqaq/">Christian Thalinger</a> spoke at the same Joker and told that a significant part of Twitter had already been translated to Graal.  Using it as a compiler turned out to be not only practical, but also increased the performance of existing code by more than 10%. </p><br><p>  In addition, we have a <a href="http://openjdk.java.net/jeps/317">JEP 317: Experimental Java-Based JIT Compiler</a> , which is likely to be included in Java 10. </p><br><p>  In this section, I wanted to write a small, victorious example that shows how to use Graal for our purposes.  Unfortunately, the example is still being written, and it looks like it will be written for a long time.  This is a topic for a separate article. </p><br><h1 id="chto-zdes-propuscheno">  What is missing here </h1><br><p>  The following things were <a href="https://jpoint.ru/talks/7lh7kkir1ye6uamik4w4cs/">unfairly</a> not considered: <a href="https://jpoint.ru/talks/7lh7kkir1ye6uamik4w4cs/">VMStructs</a> , <a href="https://github.com/jnr">Java Native Runtime</a> ( <a href="https://github.com/jnr/jnr-x86asm">JNR-x86asm</a> in this case), <a href="http://openjdk.java.net/projects/panama/">Project Panama</a> as a whole.  In April, after the <a href="https://habrahabr.ru/users/apangin/" class="user_link">apangin</a> report <a href="https://habrahabr.ru/users/apangin/" class="user_link">,</a> you will need to write a spin-off and reveal these topics. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  In this article, a review of how to launch native code directly from Java was shown. </p><br><p>  This is only the first article in the series.  What are the next steps? </p><br><p>  First you need to conduct an interview with Christian Thalinger, who, like no one else, understands Graal.  Interview will be published on Habr√© soon. </p><br><p>  By the way, he is coming to <a href="https://2018.jbreak.ru/">JBreak 2018</a> in Novosibirsk with a new report <a href="https://2018.jbreak.ru/talks/2orcaol74qywkwkscmea6o/">"Graal: how to use the new JVM JIT compiler in real life"</a> - you should go to this report. </p><br><p>  In the following articles on this topic, you need to delve into the architecture and organization of Graal and Truffle and show how we can make simple changes and achieve a quick effect. </p><br><p>  In addition, you can try to associate modern materials with old, but not lost utility works that influenced the design of Graal.  For example, I <a href="https://habrahabr.ru/post/329120/">have already published</a> one such article (context-sensitive inlayning of traces) <a href="https://habrahabr.ru/post/329120/">on Habr√©</a> .  A large amount of material has accumulated on related developments: for example, the current developer of Graal, Doug Simon, used to work on Maxine VM, about which there is an impressive number of publications. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347200/">https://habr.com/ru/post/347200/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347190/index.html">Pros of the "correct" virtual number</a></li>
<li><a href="../347192/index.html">News from the world of OpenStreetMap ‚Ññ391 (09.01.2018-15.01.2018)</a></li>
<li><a href="../347194/index.html">CSS naming conventions and time saving</a></li>
<li><a href="../347196/index.html">DDoS protection at the web server level</a></li>
<li><a href="../347198/index.html">Rust: swing the tape and parsing JSON</a></li>
<li><a href="../347202/index.html">In the US with a bodyshop: go or not go?</a></li>
<li><a href="../347204/index.html">IT solutions architecture. Part 1. Enterprise architecture</a></li>
<li><a href="../347206/index.html">As simple as possible about sorting combinations in real business problems</a></li>
<li><a href="../347208/index.html">Kodein is an interesting alternative to Dagger 2 for dependency injection in Kotlin</a></li>
<li><a href="../347210/index.html">Behaviors - Erlang behaviors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>