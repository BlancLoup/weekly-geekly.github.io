<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple plugin for Twig or expand constants.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Twig is an excellent templating engine and, unlike the others I have come across, I like it more and more over time. Twig has many merits and one of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple plugin for Twig or expand constants.</h1><div class="post__text post__text-html js-mediator-article"> Twig is an excellent templating engine and, unlike the others I have come across, I like it more and more over time.  Twig has many merits and one of them is extensibility. <br><br>  Some time I quietly ruined my life a small problem, which was too lazy to waste time.  Recently, I still forced myself and, I think, its solution would be well suited for a small article about plug-ins in Twig. <br><br>  The problem itself is in constants inside the templates.  There are such tasks when it is necessary to sew up some identifiers in the template.  Numbers to arrange them is not very good, and if there are also constants for them, it‚Äôs a sin not to use the <code>constant</code> function.  But the fact is that after compiling from a template, it is still calculated in runtime. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And what can we do?  We are killing or renaming a constant in the wake of refactoring, and forget about the template.  And IDE forgets, even the praised PHPStorm.  Successfully compile before deploy all our mountain of templates, scatter on the server.  Nothing fell, everything just doesn't work very well, and a huge sheet of identical Vorning falls on our head.  Poorly?  Disgusting! <br><br>  Decision?  Rezolvit constants in the process of compiling the template, the missing - swear. <a name="habracut"></a><br><br>  Those who are not familiar with Twig or are not very well acquainted, tell (very briefly) that each template is parsed by plugins (even the basic features are implemented in the template engine using plugins), processed and compiled into a php class, which is then twitched in the <code>display</code> method.  For example, let's take this template code, just with our constant: <br><br><pre> <code class="ruby hljs">{% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> usertype == constant(<span class="hljs-string"><span class="hljs-string">'Users::TYPE_TROLL'</span></span>) %} ,  ! {% <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> %} ! {% endif %}</code> </pre> <br>  The template will understand a relatively large tree of objects. <br><br><div class="spoiler">  <b class="spoiler_title">Here is a bit shortened, but still a big output print_r of the presentation of our template</b> <div class="spoiler_text"><pre> <code class="php hljs">[body] =&gt; Twig_Node_Body Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [<span class="hljs-number"><span class="hljs-number">0</span></span>] =&gt; Twig_Node_If Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [tests] =&gt; Twig_Node Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [<span class="hljs-number"><span class="hljs-number">0</span></span>] =&gt; Twig_Node_Expression_Binary_Equal Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [left] =&gt; Twig_Node_Expression_Name Object ( [attributes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [name] =&gt; usertype ) ) [right] =&gt; Twig_Node_Expression_Function Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [arguments] =&gt; Twig_Node Object ( [nodes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [<span class="hljs-number"><span class="hljs-number">0</span></span>] =&gt; Twig_Node_Expression_Constant Object ( [attributes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [value] =&gt; Users::TYPE_TROLL ) ) ) ) ) [attributes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [name] =&gt; constant ) ) ) ) [<span class="hljs-number"><span class="hljs-number">1</span></span>] =&gt; Twig_Node_Text Object ( [attributes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [data] =&gt; ,  ! ) ) ) ) [<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>] =&gt; Twig_Node_Text Object ( [attributes:<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>] =&gt; <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> ( [data] =&gt; ! ) ) ) ) ) )</code> </pre> </div></div><br>  It is additionally processed [here we need to wedge in] and as a result, it is compiled into such a file (also a slightly shorter version): <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__TwigTemplate_long_long_hash</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twig_Template</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $context, array $blocks = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($context[<span class="hljs-string"><span class="hljs-string">"usertype"</span></span>]) ? $context[<span class="hljs-string"><span class="hljs-string">"usertype"</span></span>] : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) == twig_constant(<span class="hljs-string"><span class="hljs-string">"Users::TYPE_TROLL"</span></span>))) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">",  !"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"!"</span></span>; } } }</code> </pre> <br>  <code>$context</code> here is what got into a bunch of input variables for this pattern.  I hope everything is clear and no need to explain.  The <code>twig_constant</code> function <code>twig_constant</code> almost the same as the standard <code>constant</code> and resolved in runtime. <br><br>  To look at the problem with our own eyes, we remove the constant from the code and on the render we catch: <br> <code>PHP Warning: constant(): Couldn't find constant Users::TYPE_TROLL in vendor/twig/twig/lib/Twig/Extension/Core.php on line 1387</code> <br> <br>  It is the <code>twig_constant</code> call in the compiled version that we need to replace with the value of the constant. <br><br>  For extensions, the <code>Twig_Extension</code> class is provided in the template engine, from which we inherit our extension.  An extension can provide the template engine with sets of functions, filters, and other nonsense that you can think of through special methods that you can find yourself in the <code>Twig_ExtensionInterface</code> interface.  We are interested in the <code>getNodeVisitors</code> method, which returns an array of objects through which all elements of the template tree will be passed before compiling it. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Template_Extensions_ConstEvaluator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twig_Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNodeVisitors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Template_Extensions_NodeVisitor_ConstEvaluator() ]; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'const_evaluator'</span></span>; } }</code> </pre> <br>  Before compiling, we just need to go through all the nodes, find among them the constant function with the usual text argument and change it to its value, or swear that there is no such constant. <br><br>  This is how our node visitor turns out: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Template_Extensions_NodeVisitor_ConstEvaluator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twig_NodeVisitorInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enterNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Twig_NodeInterface $node, Twig_Environment $env)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   constant  1  if ($node instanceof Twig_Node_Expression_Function &amp;&amp; 'constant' === $node-&gt;getAttribute('name') &amp;&amp; 1 === $node-&gt;count() ) { //    $args = $node-&gt;getNode('arguments'); if ($args instanceof Twig_Node &amp;&amp; 1 === $args-&gt;count() ) { $constNode = $args-&gt;getNode(0); // 1   if ($constNode instanceof Twig_Node_Expression_Constant &amp;&amp; null !== $value = $constNode-&gt;getAttribute('value') ) { if (null === $constantEvaluated = constant($value)) { //     -  throw new Twig_Error( sprintf( "Can't evaluate constant('%s')", $value ) ); } //  ,        //       :] return new Twig_Node_Expression_Constant($constantEvaluated, $node-&gt;getLine()); } } } //  ,  ,  ,     return $node; } public function leaveNode(Twig_NodeInterface $node, Twig_Environment $env) { return $node; } }</span></span></code> </pre> <br>  That's how we replaced almost a third of our template tree with its usual value. <br><br><div class="spoiler">  <b class="spoiler_title">Just in case, I'll show you what happened in the compiled version.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__TwigTemplate_long_long_hash</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Twig_Template</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $context, array $blocks = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($context[<span class="hljs-string"><span class="hljs-string">"usertype"</span></span>]) ? $context[<span class="hljs-string"><span class="hljs-string">"usertype"</span></span>] : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) == <span class="hljs-number"><span class="hljs-number">2</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">",  !"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"!"</span></span>; } } }</code> </pre> </div></div><br>  Simple, interesting, useful. <br><br>  Hopefully this will push someone to delve into Twig and try to expand it with something besides functions and filters.  I am ready to listen to any criticism, and even answer questions in the morning.  Discas! </div><p>Source: <a href="https://habr.com/ru/post/200614/">https://habr.com/ru/post/200614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200596/index.html">Using binary relations over sets to solve a practical problem</a></li>
<li><a href="../200598/index.html">Prefixes in the IA-32 Command System</a></li>
<li><a href="../200604/index.html">PickTime - move the queue to the cloud</a></li>
<li><a href="../200610/index.html">Do geons really exist?</a></li>
<li><a href="../200612/index.html">How to write games on Dendy</a></li>
<li><a href="../200618/index.html">Opened Red Hat Software Collections repository that can be used in Centos</a></li>
<li><a href="../200620/index.html">Developing angularjs directives is just</a></li>
<li><a href="../200632/index.html">We create the first application on NancyFX. Part Four We continue to work with the modules</a></li>
<li><a href="../200634/index.html">Increase security with two clicks</a></li>
<li><a href="../200640/index.html">Astrophotography in every house</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>