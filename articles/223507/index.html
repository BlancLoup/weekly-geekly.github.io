<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Document in perspective, what to do with it? Correction of the results of contactless scanning and photographs of documents</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We came up with the idea of ‚Äã‚Äãthis article after reading the article ‚ÄúHow does the automatic selection of a document on an image work in ABBYY FineSca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Document in perspective, what to do with it? Correction of the results of contactless scanning and photographs of documents</h1><div class="post__text post__text-html js-mediator-article">  We came up with the idea of ‚Äã‚Äãthis article after reading the article <a href="http://habrahabr.ru/company/abbyy/blog/200448/">‚ÄúHow does the automatic selection of a document on an image work in ABBYY FineScanner?‚Äù</a> , Published on Habr√© by ABBYY, which describes in detail an algorithm for determining the boundaries of a document on an image obtained by a mobile phone camera. <br>  The article is certainly interesting and useful.  We, ‚Äúwith a feeling of deep satisfaction,‚Äù noted that ABBYY uses the same mathematical algorithms as we and wisely omits some details, without which the accuracy of determining the boundaries of the document is significantly reduced. <br>  I think that after reading the article a certain part of readers had a reasonable question: ‚ÄúWhat to do with the document found on the picture further?‚Äù I will answer with the words of the Cheshire Cat Alice: ‚ÄúWhere do you want to come?‚Äù If the ultimate goal is to ‚Äúpull out‚Äù the text from the picture data, then you need to maximally facilitate the task of the recognition system.  For this, first of all, it is necessary to correct perspective distortions, the scourge of all photographs of documents "by hand".  If this problem is not solved, an attempt to recognize the data may give a result comparable to attempts to recognize captcha.  On the freelance sites with enviable regularity appear "believers" in the victory of machine intelligence over the captcha for a small price.  Blessed is he who believes, but we are not talking about that now. <br>  So, in this article we will try to pick up the baton from ABBYY and tell you in our own way how to bring the prism-like, at best, document that we identified in the picture (thanks to ABBYY for science) to rectangular form, preferably with preservation original proportions.  We do not consider exotic cases like pentagonal or oval documents, although the question is interesting. <br><a name="habracut"></a><br>  The problem of distorting perspective distortions arose before ALANIS Software not quite from the side from which it was expected.  I mean, the fact that we do not specialize in mobile development.  However, our customer, for whom we are developing a system for scanning and image processing for planetary scanners based on Canon EOS digital mirror cameras (hi, photographers!), At some point wanted to have such functionality in the arsenal.  Moreover, it was not about processing the finished camera image, but about adjusting the video stream, at the LiveView preview stage.  However, the solution we developed works equally well in the correction mode of an already taken snapshot of a document. <br>  <b>Given:</b> <br><ol><li>  image of a rectangular document with a camera with distortion </li><li>  the contours of the document in the picture </li></ol><br>  <b>Task:</b> <br>  to bring the document to its original form the shortest way <br>  <b>Challenge (the Russian equivalent somehow does not occur):</b> <br><ol><li>  the proportions of the original document we are not exactly known </li><li>  the distance to the plane on which the document lies we do not know </li><li>  There are no reference objects on which to navigate (for example, the correct square caught in the lens) </li></ol><br>  <b>Decision:</b> <br>  So, to solve the problem as a whole, we suggest splitting it into two separate ones: <br><ol><li>  Finding, in fact, the distorted contour of the document on the scanned image (perhaps, we will once again highlight this question for those who have not read the article ABBYY). </li><li>  Determining the correct proportions of the document to which the original distorted contour should be mapped in order to get an aligned document. </li></ol><br>  You could, of course, try to reinvent the wheel, and some still succeed, but we took the easier way and used the OpenCV toolkit.  We work mostly in the .NET environment, through <a href="https://github.com/shimat/opencvsharp">C # Wrapper OpenCVSharp</a> .  OpenCVSharp is also available as a Nuget package in Visual Studio.  "That's all" (c) and will use. <br>  Consider the main interesting points in solving the problem of correcting the perspective image in the following image: <br><img src="https://habrastorage.org/getpro/habr/post_images/5ff/7d0/f50/5ff7d0f509960bccd61991790df7926a.png"><br><br>  1. In order to find the outline in the presented image, it is necessary to get rid of small details that may interfere.  This can be done by applying a ‚Äúlow power‚Äù blur spell according to low power, after converting the image into shades of gray: <br> <code>imgSource.CvtColor(imgGrayscale, ColorConversion.BgrToGray); <br> imgSource.Smooth(imgSource, SmoothType.Gaussian, 15);</code> <br> <br>  Here's what happened as a result of applying the above described chain (if I take off my glasses, there will be about the same effect. Hence the moral: ‚ÄúMyopia is not a disease, but intellectual processing of the image, which aims to weed out all unnecessary and make the world more beautiful!‚Äù): <br><img src="https://habrastorage.org/getpro/habr/post_images/434/6f5/02e/4346f502e521d4f753c456ab22f8d822.jpg"><br><br>  2. Next, you need to make the image black and white: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>imgSource.Threshold(imgSource, 0, 255, ThresholdType.Binary | ThresholdType.Otsu);</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/11b/b9e/063/11bb9e0637cd9a24cb22433d575178a8.jpg"><br><br>  3. On the resulting image is easy to find the outline of the document.  We will look for the maximum external contour.  OpenCVSharp has a great CvContourScanner class that can list all the contours of an image found.  Using Linq, you can sort these outlines by area and take the first one, which will be the maximum one. <br><br> <code>using (var storage = new CvMemStorage()) <br> using (var scanner = new CvContourScanner(image, _storage, CvContour.SizeOf, ContourRetrieval.External, ContourChain.ApproxSimple)) <br> { <br> var largestContour = scanner.OrderBy(contour =&gt; Math.Abs(contour.ContourArea())).FirstOrDefault(); <br> }</code> <br> <br>  If you draw the contour found, you get the following image: <br><img src="https://habrastorage.org/getpro/habr/post_images/379/f3a/d55/379f3ad55018602957184eef8ba32690.jpg"><br><br>  4. Cheers!  Found a contour!  However, it can show little - it is necessary to know the exact coordinates of all the corner points - the points of intersection of the sides of the document.  Obviously, to find the coordinates of these points, it is desirable to describe the sides of the contour found by the equations of a straight line.  So how can OpenCV help us?  Very simple!  It has a tool that uses <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25A5%25D0%25B0%25D1%2584%25D0%25B0">the Hough transform</a> .  "Cast" this method on the image obtained in the previous step: <br> <code><code>var lineSegments = imgSource.HoughLines2(storage, HoughLinesMethod.Probabilistic, 1, Math.PI / 180.0, 70, 100, 1).ToArray(); <br>   ,       4 ,     , !   100,    200,     .   ,      ,     ,     (      ¬´¬ª  OpenCV).   ,      - , ,    :  ,  : <br> <br> var verticalSegments = segments <br> .Where(s =&gt; Math.Abs(s.P1.X - s.P2.X) &lt; Math.Abs(s.P1.Y - s.P2.Y)) <br> .ToArray(); <br> <br> var horizontalSegments = segments <br> .Where(s =&gt; Math.Abs(s.P1.X - s.P2.X) &gt;= Math.Abs(s.P1.Y - s.P2.Y)) <br> .ToArray();</code> <br> <br>  ,  ¬´¬ª    ‚Äì  ;   ‚Äì .   ,   ,  : <br> <img src="https://habrastorage.org/getpro/habr/post_images/a84/4eb/c9c/a844ebc9c3d1397a15351a076f4de14a.jpg"> <br> <br> ,         . ,  : <br> <br> <code>var corners = horizontalSegments <br> .SelectMany(sh =&gt; verticalSegments <br> .Select(sv =&gt; sv.LineIntersection(sh)) <br> .Where(v =&gt; v != null) <br> .Select(v =&gt; v.Value)) <br> // exclude points which is out of image area <br> .Where(c =&gt; new CvRect(0, 0, imgSource.Width, imgSource.Height).Contains(c)) <br> .ToArray(); <br></code> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/ad0/ea0/a35/ad0ea0a357e3285220ce5510645f5e4f.jpg"> <br> <br>              : <br> <img src="https://habrastorage.org/getpro/habr/post_images/0ad/880/40c/0ad88040cecb4e5e0ef520769460f026.jpg"> <br> <br> ‚Äì      ).            OpenCVSharp: <br> <br> <code>contour = contour.ApproxPoly(CvContour.SizeOf, storage, ApproxPolyMethod.DP, contour.ArcLength() * 0.02, true);</code> <br> <br> , ! , -     : <br> <img src="https://habrastorage.org/getpro/habr/post_images/700/119/554/7001195547102e53b0a0be65d877df39.jpg"> <br> <br> 5. ,   . ,    ‚Äì        ,       .   ,    ,       .  ,     ‚Äì   -  ,         .      ,      ,    . <br> <br>  , ,  ,            100%     . ,       ,   ,  ,   ,    . <br> ,  ,  .     :                   .          .   ,   , : <br> <img src="https://habrastorage.org/getpro/habr/post_images/acc/d57/9d3/accd579d3e9e22ce5eae705cbc294a64.jpg"> <br> <br>     : <br> <img src="https://habrastorage.org/getpro/habr/post_images/f31/07e/9ac/f3107e9ac5d4a5336c996a8dcb758a13.jpg"> <br> <br> ,   ,     .     ! <br> <br>    -  .    ,                 ( 10,   ‚Äì  ,   ‚Äì   ): <br> <img src="https://habrastorage.org/getpro/habr/post_images/e36/2ec/681/e362ec68189ca4450baf4bc1c10a23ab.jpg"> <br> <br>  ,   ¬´¬ª    .    - ,         ,    .      - ,     ,   : <br> <img src="https://habrastorage.org/getpro/habr/post_images/827/1fc/ce4/8271fcce452bcbd6bf09e764252095c1.jpg"> <br> : <br> <br> <i>deltaX, deltaY</i> ‚Äì        , ; <br> <i>targetWidth, targetHeight</i> ‚Äì   ; <br> <i>topWidth, bottomWidth, leftHeight, rightHeight</i> ‚Äì   . <br> <br>      : <br> <img src="https://habrastorage.org/getpro/habr/post_images/017/848/bce/017848bcefe35f5e3295b29851be12f8.jpg"> <br> <br>      ,   : <br> <img src="https://habrastorage.org/getpro/habr/post_images/d40/a6d/acf/d40a6dacfdeae054b82820c0a4f29572.jpg"> <br> <br>       .   ,        . <br> <br> ,  ¬´¬ª ,   ¬´¬ª      ,   ,      -    ‚Ä¶ <br> <br> ,     - .  ,       .         ,    Canon.    ¬´¬ª  ¬´ ¬ª     LiveView,        . <br> <br> <br> <br>           ,     .     youtube    ,   ,               .   !</code> <iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/_Ww-rNzttGM%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253&amp;usg=ALkJrhhdv_UWrYP457jkkjWYefdhZbmX_g" frameborder="0" allowfullscreen=""></iframe> <code><code>var lineSegments = imgSource.HoughLines2(storage, HoughLinesMethod.Probabilistic, 1, Math.PI / 180.0, 70, 100, 1).ToArray(); <br>   ,       4 ,     , !   100,    200,     .   ,      ,     ,     (      ¬´¬ª  OpenCV).   ,      - , ,    :  ,  : <br> <br> var verticalSegments = segments <br> .Where(s =&gt; Math.Abs(s.P1.X - s.P2.X) &lt; Math.Abs(s.P1.Y - s.P2.Y)) <br> .ToArray(); <br> <br> var horizontalSegments = segments <br> .Where(s =&gt; Math.Abs(s.P1.X - s.P2.X) &gt;= Math.Abs(s.P1.Y - s.P2.Y)) <br> .ToArray();</code> <br> <br>  ,  ¬´¬ª    ‚Äì  ;   ‚Äì .   ,   ,  : <br> <img src="https://habrastorage.org/getpro/habr/post_images/a84/4eb/c9c/a844ebc9c3d1397a15351a076f4de14a.jpg"> <br> <br> ,         . ,  : <br> <br> <code>var corners = horizontalSegments <br> .SelectMany(sh =&gt; verticalSegments <br> .Select(sv =&gt; sv.LineIntersection(sh)) <br> .Where(v =&gt; v != null) <br> .Select(v =&gt; v.Value)) <br> // exclude points which is out of image area <br> .Where(c =&gt; new CvRect(0, 0, imgSource.Width, imgSource.Height).Contains(c)) <br> .ToArray(); <br></code> <br> <br> <img src="https://habrastorage.org/getpro/habr/post_images/ad0/ea0/a35/ad0ea0a357e3285220ce5510645f5e4f.jpg"> <br> <br>              : <br> <img src="https://habrastorage.org/getpro/habr/post_images/0ad/880/40c/0ad88040cecb4e5e0ef520769460f026.jpg"> <br> <br> ‚Äì      ).            OpenCVSharp: <br> <br> <code>contour = contour.ApproxPoly(CvContour.SizeOf, storage, ApproxPolyMethod.DP, contour.ArcLength() * 0.02, true);</code> <br> <br> , ! , -     : <br> <img src="https://habrastorage.org/getpro/habr/post_images/700/119/554/7001195547102e53b0a0be65d877df39.jpg"> <br> <br> 5. ,   . ,    ‚Äì        ,       .   ,    ,       .  ,     ‚Äì   -  ,         .      ,      ,    . <br> <br>  , ,  ,            100%     . ,       ,   ,  ,   ,    . <br> ,  ,  .     :                   .          .   ,   , : <br> <img src="https://habrastorage.org/getpro/habr/post_images/acc/d57/9d3/accd579d3e9e22ce5eae705cbc294a64.jpg"> <br> <br>     : <br> <img src="https://habrastorage.org/getpro/habr/post_images/f31/07e/9ac/f3107e9ac5d4a5336c996a8dcb758a13.jpg"> <br> <br> ,   ,     .     ! <br> <br>    -  .    ,                 ( 10,   ‚Äì  ,   ‚Äì   ): <br> <img src="https://habrastorage.org/getpro/habr/post_images/e36/2ec/681/e362ec68189ca4450baf4bc1c10a23ab.jpg"> <br> <br>  ,   ¬´¬ª    .    - ,         ,    .      - ,     ,   : <br> <img src="https://habrastorage.org/getpro/habr/post_images/827/1fc/ce4/8271fcce452bcbd6bf09e764252095c1.jpg"> <br> : <br> <br> <i>deltaX, deltaY</i> ‚Äì        , ; <br> <i>targetWidth, targetHeight</i> ‚Äì   ; <br> <i>topWidth, bottomWidth, leftHeight, rightHeight</i> ‚Äì   . <br> <br>      : <br> <img src="https://habrastorage.org/getpro/habr/post_images/017/848/bce/017848bcefe35f5e3295b29851be12f8.jpg"> <br> <br>      ,   : <br> <img src="https://habrastorage.org/getpro/habr/post_images/d40/a6d/acf/d40a6dacfdeae054b82820c0a4f29572.jpg"> <br> <br>       .   ,        . <br> <br> ,  ¬´¬ª ,   ¬´¬ª      ,   ,      -    ‚Ä¶ <br> <br> ,     - .  ,       .         ,    Canon.    ¬´¬ª  ¬´ ¬ª     LiveView,        . <br> <br> <br> <br>           ,     .     youtube    ,   ,               .   !</code> </div><p>Source: <a href="https://habr.com/ru/post/223507/">https://habr.com/ru/post/223507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223485/index.html">A student development and innovation center has been created at MIREA.</a></li>
<li><a href="../223491/index.html">Free seminar ADVANSERV and Huawei May 28, 2014</a></li>
<li><a href="../223497/index.html">Law enforcement agencies detain hacking group Blackshades</a></li>
<li><a href="../223501/index.html">HTML5 attacks: what you need to know</a></li>
<li><a href="../223505/index.html">The future comes to AMF 2014</a></li>
<li><a href="../223509/index.html">At Indiegogo raise money for a prototype of an inexpensive fusion reactor</a></li>
<li><a href="../223511/index.html">Using MultiSSID in life</a></li>
<li><a href="../223515/index.html">Promotion of applications in the AppStore (Google Play)</a></li>
<li><a href="../223517/index.html">Game Development: Getting Started</a></li>
<li><a href="../223519/index.html">Getting ready for 2014 Zabbix conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>