<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible and ChatOps or how to manage 100+ servers from the chat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Updated: February 21, 2017 


 What is ChatOps? 
 ChatOps is still fresh and rare in the DevOps world when working with infrastructure is transferred ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible and ChatOps or how to manage 100+ servers from the chat</h1><div class="post__text post__text-html js-mediator-article">  <em>Updated: February 21, 2017</em> <br><br><img src="https://habrastorage.org/files/aa4/6e3/556/aa46e355610f4f6682a5568d678fec5d.png" alt="Ansible and ChatOps with StackStorm, Slack and Hubot"><br><h2>  What is ChatOps? </h2><br>  ChatOps is still fresh and rare in the DevOps world when working with infrastructure is transferred to a general chat.  You can run commands directly from the chat, while the developers / system administrators see what is happening in real time, they can view the change history, run their teams, maintain communication around work, and even share experiences.  Thus, information and workflow belong to the whole team - and this has many advantages. <br><br>  You can think of such things as deploying code or deploying servers from a chat, viewing monitoring schedules, sending SMS, managing clusters, or simply launching shell commands.  ChatOps can be a high-level view of your really complex <abbr title="Continuous Integration">CI</abbr> / <abbr title="Continuous Deployment">CD</abbr> system, bringing simplicity with a command in a chat like this:! Deploy <code>!deploy that thing</code> .  This approach does wonders for improving visibility and reducing complexity around the deployment process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h2>  Superior ChatOps </h2><br>  <a href="https://stackstorm.com/">StackStorm</a> - OpenSource project with special attention to automation and ChatOps.  The platform connects a huge number of existing DevOps tools like configuration management, monitoring, graphs, alerts, and so on.  together, allowing everyone to rule from a single checkpoint.  And this is ideal from the point of view of ChatOps - you can create and automate imaginable and inconceivable workflows, controlling any set of tools directly from the chat. <br><br>  In StackStorm there is <a href="https://stackstorm.com/2015/06/05/new-in-stackstorm-ansible-integration/">Ansible integration</a> and starting with <a href="https://stackstorm.com/2015/06/08/enhanced-chatops-from-stackstorm/">&lt;1.0</a> versions, even more ChatOps features in <a href="https://stackstorm.com/2015/12/08/stackstorm-1-2-0-the-new-chatops/">1.2</a> and <a href="https://stackstorm.com/2016/04/20/stackstorm-v1-4/">1.4</a> releases are added, which opens the way for real use of ChatOps, not just posting photos of funny cats using a bot.  In this article we will explain how to make ChatOps and Ansible work using the StackStorm platform. <br><blockquote>  By the way, StackStorm, like Ansible, is declarative, written in Python and uses Yaml + Jinja, which will make it easier for you to figure it out. </blockquote><br><br><h2>  Plan </h2><br>  First, we are going to install a control machine that will run under Ubuntu 14. Then we will configure the StackStorm platform on it, including the Ansible management packs and the Hubot framework ChatOps.  Finally, we will connect the entire system to the Slack chat, and show some simple but real examples of interactive use of Ansible. <br><br>  Let's start, and at the same time, we will check how far we have come and come the <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2585%25D0%25BD%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B8%25D0%25BD%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2580%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">technological singularity</a> , giving root access to some chat bots and allowing them to manage our 100+ servers or even data centers (by the way, RackSpace works with ChatOps). <br><br><h2>  Step 0. Preparing Slack </h2><br>  As already mentioned, we will use <a href="https://slack.com/">Slack.com</a> as a chat platform (although other integrations are available).  Sign up for a Slack account if you don‚Äôt have one yet.  Enable the integration of Hubot in the settings. <br><blockquote>  <a href="https://hubot.github.com/">Hubot</a> - bot framework from GitHub, created specifically for ChatOps </blockquote><br><img src="https://habrastorage.org/files/c5f/ab7/b80/c5fab7b80cba447a901ec57d4d34c9de.png" alt="Enable Hubot Slack Integration"><br>  As a result, Slack will give you an API token like: <br><pre> <code class="bash hljs">HUBOT_SLACK_TOKEN=xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu</code> </pre><br>  Next, we set up the StackStorm platform, show real examples of usage, and of course, tell you how to create your own ChatOps commands. <br>  But wait, there is an easy way! <br><br><h2>  For the most lazy </h2><br>  For those who are lazy (most DevOps developers are), there is a specially prepared repository from Vagrant that installs everything you need using the simplest bash scripts, taking you from the start line right to the finish line, allowing you to immediately start ChatOps commands from the Slack chat <a href="https://github.com/StackStorm/showcase-ansible-chatops">showcase</a> after the automatic installation <a href="https://github.com/StackStorm/showcase-ansible-chatops">-ansible-chatops</a> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     export HUBOT_SLACK_TOKEN=xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu git clone https://github.com/StackStorm/showcase-ansible-chatops.git cd showcase-ansible-chatops vagrant up</span></span></code> </pre><br>  For those who are interested in the details - switch from automatic to manual mode and go through all the steps.  Just keep in mind if something <a href="https://github.com/StackStorm/showcase-ansible-chatops">goes wrong</a> - check out examples from the <a href="https://github.com/StackStorm/showcase-ansible-chatops">ansible &amp; chatops demo repository</a> . <br><br><h2>  Step 1. Install StackStorm </h2><br>  Installation is simple.  Total 1 team: <br><pre> <code class="bash hljs">curl -sSL https://stackstorm.com/packages/install.sh | sudo bash -- --user=demo --password=demo</code> </pre><br><blockquote>  Keep in mind, this is for demonstration purposes.  When deploying production, use <a href="https://github.com/stackstorm/ansible-st2">Ansible playbooks</a> , <a href="https://github.com/stackstorm/ansible-st2">verify</a> signatures and do not trust the installation commands on one line!  Installation details are described in the documentation: <a href="https://docs.stackstorm.com/install/deb.html">docs.stackstorm.com/install/deb.html</a> </blockquote><br><br><h2>  Step 2. Install the StackStorm plugin: Ansible </h2><br>  The idea of ‚Äã‚Äãintegration packs (plug-ins) in StackStorm is that they connect the system with other tools and external services. <br>  So, we need Ansible pack, install: <br><pre> <code class="bash hljs">st2 pack install ansible</code> </pre><br>  Ansible C will be available in Python virtualenv: <code>/opt/stackstorm/virtualenvs/ansible</code> <br><blockquote>  A complete list of integrations: <a href="https://exchange.stackstorm.org/">exchange.stackstorm.org</a> , among them: <code>AWS</code> , <code>GitHub</code> , <code>RabbitMQ</code> , <code>Pagerduty</code> , <code>Jenkins</code> , <code>Nagios</code> , <code>Docker</code> , - more than 100+ in total! </blockquote><br><br><h2>  Step 3. Configure ChatOps </h2><br>  Now you need to configure the <code>/opt/stackstorm/chatops/st2chatops.env</code> file with environment variables.  This is how it looked for a Slack bot named <code>stanley</code> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Bot name export HUBOT_NAME=stanley export HUBOT_ALIAS='!' # StackStorm API key # Use: `st2 apikey create -k` to generate # Replace with your key (!) export ST2_API_KEY="123randomstring789" # ST2 AUTH credentials # Replace with your username/password (!) export ST2_AUTH_USERNAME="demo" export ST2_AUTH_PASSWORD="demo" # Configure Hubot to use Slack export HUBOT_ADAPTER="slack" # Replace with your token (!) export HUBOT_SLACK_TOKEN="xoxb-5187818172-I7wLh4oqzhAScwXZtPcHyxCu"</span></span></code> </pre><br><br>  After the changes, do not forget to restart the service: <br><pre> <code class="bash hljs">sudo service st2chatops restart</code> </pre><br><br><h2>  Step 4. First ChatOps experience </h2><br>  At this stage, the Stanley bot should be online in the chat.  To invite him to a certain Slack room: <br><pre> <code class="bash hljs">/invite @stanley</code> </pre><br>  Get a list of available commands: <br><pre> <code class="bash hljs">!<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre><br>  Surely you will like <a href="https://github.com/hubot-scripts/hubot-shipit">shipit</a> : <br><pre> <code class="bash hljs">!ship it</code> </pre><br>  Having played enough with the existing teams, we will deal with really serious things. <br><br><h2>  Step 5. Creating your own ChatOps commands </h2><br>  One of the features of StackStorm is the ability to create simple aliases / wrappers around commands, making it easier to work with ChatOps.  Instead of typing a long command, you can simply bind it into something more friendly and light, syntactic sugar. <br><br>  So, create your own StackStorm pack that will contain the commands we need.  Forknite <a href="https://github.com/StackStorm/st2-pack-template">StackStorm template pack</a> on GitHub.  Our first action alias <a href=""><code>aliases/ansible.yaml</code></a> : <br><pre> <code class="python hljs">--- name: <span class="hljs-string"><span class="hljs-string">"chatops.ansible_local"</span></span> action_ref: <span class="hljs-string"><span class="hljs-string">"ansible.command_local"</span></span> description: <span class="hljs-string"><span class="hljs-string">"Run Ansible command on local machine"</span></span> formats: - display: <span class="hljs-string"><span class="hljs-string">"ansible &lt;command&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"ansible {{ args }}"</span></span> result: format: | Ansible command `{{ execution.parameters.args }}` result: {~} {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.result.stderr %}*Stdout:* {% endif %} ```{{ execution.result.stdout }}``` {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.result.stderr %}*Stderr:* ```{{ execution.result.stderr }}```{% endif %} extra: slack: color: <span class="hljs-string"><span class="hljs-string">"{% if execution.result.succeeded %}good{% else %}danger{% endif %}"</span></span></code> </pre><br><blockquote>  For reference: the above alias uses <a href="https://github.com/StackStorm-Exchange/stackstorm-ansible">ansible st2 integration pack</a> </blockquote><br>  Send changes to the newly created <a href="https://github.com/armab/st2_chatops_aliases">GitHub repository</a> and you can install our pack.  For this, there is already a ChatOps alias: <br><pre> <code class="bash hljs">!pack install https://github.com/armab/st2_chatops_aliases</code> </pre><br><br>  Now you can run simple <a href="https://docs.ansible.com/intro_adhoc.html">Ansible ad-hoc commands</a> directly from the Slack chat: <br><pre> <code class="bash hljs">!ansible <span class="hljs-string"><span class="hljs-string">"uname -a"</span></span></code> </pre><br><img src="https://habrastorage.org/files/126/07f/8db/12607f8dbf4547b787a81cc6b47c587a.png" alt="Running ansible commands - ChatOps"><br>  At a low level, this is the same as: <br><pre> <code class="bash hljs">/opt/stackstorm/virtualenvs/ansible/bin/ansible all --connection=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> --args=<span class="hljs-string"><span class="hljs-string">'uname -a'</span></span> --inventory-file=<span class="hljs-string"><span class="hljs-string">'127.0.0.1,'</span></span></code> </pre><br>  But let's look at more useful examples of interactive ChatOps. <br><br><h3>  Example 1. We get the status of servers </h3><br>  Ansible has a <a href="https://docs.ansible.com/ping_module.html">ping module</a> that connects to hosts and returns <code>pong</code> if successful.  A simple but powerful example that allows you to understand the status of servers directly from the chat in a matter of seconds without the need to enter the terminal. <br><br>  To do this, create an <code>action</code> in our pack that launches the real command and <code>action alias</code> , which is syntactic sugar for the action and allows you to create such a ChatOps structure: <br><pre> <code class="bash hljs">!status <span class="hljs-string"><span class="hljs-string">'web'</span></span></code> </pre><br>  Action <a href=""><code>actions/server-status.yaml</code></a> : <br><pre> <code class="python hljs">--- name: server_status description: Show server status by running ansible ping ad-hoc command runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: description: <span class="hljs-string"><span class="hljs-string">"Run command with sudo"</span></span> type: boolean immutable: true default: true kwarg_op: immutable: true cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> type: string immutable: true default: <span class="hljs-string"><span class="hljs-string">"/opt/stackstorm/virtualenvs/ansible/bin/ansible {{hosts}} --module-name=ping"</span></span> hosts: description: <span class="hljs-string"><span class="hljs-string">"Ansible hosts to ping"</span></span> type: string required: true</code> </pre><br><blockquote>  By the way, in addition to <code>bash</code> scripts, Action can work with the <a href="https://docs.stackstorm.com/runners.html">Python runner,</a> or in general with any binary that can return <code>json</code> , here is all the flexibility of use. </blockquote><br><br>  Action alias <a href=""><code>aliases/server_status.yaml</code></a> : <br><pre> <code class="bash hljs">--- name: chatops.ansible_server_status action_ref: st2_chatops_aliases.server_status description: Show status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hosts (ansible ping module) formats: - display: <span class="hljs-string"><span class="hljs-string">"status &lt;hosts&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"status {{ hosts }}"</span></span> - <span class="hljs-string"><span class="hljs-string">"ping {{ hosts }}"</span></span> result: format: | Here is your status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> `{{ execution.parameters.hosts }}` host(s): {~} ```{{ execution.result.stdout }}``` extra: slack: color: <span class="hljs-string"><span class="hljs-string">"{% if execution.result.succeeded %}good{% else %}danger{% endif %}"</span></span> fields: - title: Alive value: <span class="hljs-string"><span class="hljs-string">"{{ execution.result.stdout|regex_replace('(?!SUCCESS).', '')|wordcount }}"</span></span> short: <span class="hljs-literal"><span class="hljs-literal">true</span></span> - title: Dead value: <span class="hljs-string"><span class="hljs-string">"{{ execution.result.stdout|regex_replace('(?!UNREACHABLE).', '')|wordcount }}"</span></span> short: <span class="hljs-literal"><span class="hljs-literal">true</span></span> footer: <span class="hljs-string"><span class="hljs-string">"{{ execution.id }}"</span></span> footer_icon: <span class="hljs-string"><span class="hljs-string">"https://stackstorm.com/wp/wp-content/uploads/2015/01/favicon.png"</span></span></code> </pre><br>  Make sure you add the necessary hosts to the Ansible inventory file: <code>/etc/ansible/hosts</code> <br><br>  After sending the code to the repository, do not forget to reload your pack from the chat: <br><pre> <code class="bash hljs">!pack install armab/st2_chatops_aliases</code> </pre><br>  It is very convenient that we can store all our ChatOps settings in the form of a st2 pack and pick up changes from the repository - infrastructure as a code. <br><br>  The result of the newly created Slack team: <br><img src="https://habrastorage.org/files/f34/c5b/2d4/f34c5b2d4cf640f2892902a91f317afc.png" alt="Show server status - ChatOps"><br><br>  This is really convenient, even your <abbr title="Chief executive officer">CEO</abbr> can see the status without having access to the servers!  With this approach, communication, deployment and work around the infrastructure can occur right in the chat: whether you are in the office or working remotely (some of us can work directly from the beach). <br><br><h3>  Example 2. Restarting services </h3><br>  Has it ever happened to you that a simple restart of the service helped?  Not an ideal way, but often a quick fix is ‚Äã‚Äãa must.  Let's create a ChatOps command that would overload the specified service on certain servers. <br>  The task to get this design: <br><pre> <code class="bash hljs">!service restart <span class="hljs-string"><span class="hljs-string">"rabbitmq-server"</span></span> on <span class="hljs-string"><span class="hljs-string">"mq-01"</span></span></code> </pre><br>  To do this, in the existing st2 package, create the <a href=""><code>actions/service_restart.yaml</code></a> : <br><pre> <code class="python hljs">--- name: service_restart description: Restart service on remote hosts runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: description: <span class="hljs-string"><span class="hljs-string">"Run command with sudo"</span></span> type: boolean immutable: true default: true kwarg_op: immutable: true cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> type: string immutable: true default: <span class="hljs-string"><span class="hljs-string">"/opt/stackstorm/virtualenvs/ansible/bin/ansible {{hosts}} --become --module-name=service --args='name={{service_name}} state=restarted'"</span></span> hosts: description: <span class="hljs-string"><span class="hljs-string">"Ansible hosts"</span></span> type: string required: true service_name: description: <span class="hljs-string"><span class="hljs-string">"Service to restart"</span></span> type: string required: true</code> </pre><br>  ChatOps <a href=""><code>aliases/service_restart.yaml</code></a> alias: <br><pre> <code class="python hljs">--- name: chatops.ansible_service_restart action_ref: st2_chatops_aliases.service_restart description: Restart service on remote hosts formats: - display: <span class="hljs-string"><span class="hljs-string">"service restart &lt;service_name&gt; on &lt;hosts&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"service restart {{ service_name }} on {{ hosts }}"</span></span> result: format: | Service restart `{{ execution.parameters.service_name }}` on `{{ execution.parameters.hosts }}` host(s): {~} {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.result.stderr %} *Exit Status*: `{{ execution.result.return_code }}` *Stderr:* ```{{ execution.result.stderr }}``` *Stdout:* {% endif %} ```{{ execution.result.stdout }}``` extra: slack: color: <span class="hljs-string"><span class="hljs-string">"{% if execution.result.succeeded %}good{% else %}danger{% endif %}"</span></span> fields: - title: Restarted value: <span class="hljs-string"><span class="hljs-string">"{{ execution.result.stdout|regex_replace('(?!SUCCESS).', '')|wordcount }}"</span></span> short: true - title: Failed value: <span class="hljs-string"><span class="hljs-string">"{{ execution.result.stdout|regex_replace('(?!(FAILED|UNREACHABLE)!).', '')|wordcount }}"</span></span> short: true footer: <span class="hljs-string"><span class="hljs-string">"{{ execution.id }}"</span></span> footer_icon: <span class="hljs-string"><span class="hljs-string">"https://stackstorm.com/wp/wp-content/uploads/2015/01/favicon.png"</span></span></code> </pre><br>  Result: <br><img src="https://habrastorage.org/files/cdc/505/75c/cdc50575c2fd4975b6ce0b596f07b132.png" alt="Reboot Nginx service on remote servers - ChatOps"><br>  And you know what?  Thanks to the Slack mobile app, you can restart services right from your phone! <br><br><h3>  Example 3. MySQL processlist </h3><br>  We want to create a simple Slack command that displays a list of executed SQL queries on the MySQL server: <br><pre> <code class="bash hljs">!show mysql processlist</code> </pre><br>  Action <a href=""><code>actions/mysql_processlist.yaml</code></a> : <br><pre> <code class="python hljs">--- name: mysql_processlist description: Show MySQL processlist runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: immutable: true default: true kwarg_op: immutable: true cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> type: string immutable: true default: <span class="hljs-string"><span class="hljs-string">"/opt/stackstorm/virtualenvs/ansible/bin/ansible {{ hosts }} --become --become-user=root -m shell -a \"mysql --execute='SHOW PROCESSLIST;' | expand -t 10\""</span></span> hosts: description: <span class="hljs-string"><span class="hljs-string">"Ansible hosts"</span></span> type: string default: db</code> </pre><br>  Action alias for ChatOps: <a href=""><code>aliases/mysql_processlist.yaml</code></a> : <br><pre> <code class="python hljs">--- name: chatops.mysql_processlist action_ref: st2_chatops_aliases.mysql_processlist description: Show MySQL processlist formats: - display: <span class="hljs-string"><span class="hljs-string">"show mysql processlist &lt;hosts=db&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"show mysql processlist {{ hosts=db }}"</span></span> - <span class="hljs-string"><span class="hljs-string">"show mysql processlist on {{ hosts=db }}"</span></span> result: format: | {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.status == <span class="hljs-string"><span class="hljs-string">'succeeded'</span></span> %}MySQL queries on `{{ execution.parameters.hosts }}`: ```{{ execution.result.stdout }}```{~}{% <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> %} *Exit Code:* `{{ execution.result.return_code }}` *Stderr:* ```{{ execution.result.stderr }}``` *Stdout:* ```{{ execution.result.stdout }}``` {% endif %}</code> </pre><br>  Note that we made the <code>hosts</code> parameter optional ( <code>db</code> by default), so these two commands are equivalent: <br><pre> <code class="bash hljs">!show mysql processlist !show mysql processlist <span class="hljs-string"><span class="hljs-string">'db'</span></span></code> </pre><br><img src="https://habrastorage.org/files/0b0/07a/70b/0b007a70bbcd41eaa773b8c5f158763b.png" alt="Show list of executed SQL queries - ChatOps"><br>  Your <abbr title="Database Administrator">DBA</abbr> will be happy! <br><br><h3>  Example 4. Get HTTP statistics from nginx </h3><br>  We want to get an array of HTTP status codes from the nginx log, sort them according to the number and display them nicely in the chat in order to understand how many <code>200</code> or <code>50x</code> errors <code>50x</code> on the web servers, whether they are normal or not: <br><pre> <code class="bash hljs">!show nginx stats on <span class="hljs-string"><span class="hljs-string">'web'</span></span></code> </pre><br>  To do this, create an action that runs the shell command, <a href="https://github.com/armab/st2_chatops_aliases/blob/master/actions/"><code>actions/http_status_codes.yaml</code></a> : <br><pre> <code class="python hljs">--- name: http_status_codes description: Show sorted http status codes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nginx logs runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: immutable: true default: true kwarg_op: immutable: true cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> type: string immutable: true default: <span class="hljs-string"><span class="hljs-string">"/opt/stackstorm/virtualenvs/ansible/bin/ansible {{ hosts }} --become -m shell -a \"awk '{print \\$9}' /var/log/nginx/access.log|sort |uniq -c |sort -k1,1nr 2&gt;/dev/null|column -t\""</span></span> hosts: description: <span class="hljs-string"><span class="hljs-string">"Ansible hosts"</span></span> type: string required: true</code> </pre><br>  Alias <a href="https://github.com/armab/st2_chatops_aliases/blob/master/aliases/"><code>aliases/http_status_codes.yaml</code></a> : <br><pre> <code class="python hljs">--- name: chatops.http_status_codes action_ref: st2_chatops_aliases.http_status_codes description: Show sorted http status codes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nginx on hosts formats: - display: <span class="hljs-string"><span class="hljs-string">"show nginx stats on &lt;hosts&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"show nginx stats on {{ hosts }}"</span></span> result: format: <span class="hljs-string"><span class="hljs-string">"```{{ execution.result.stdout }}```"</span></span></code> </pre><br><blockquote>  Thanks to <a href="https://github.com/bcoca">Brian Coca</a> , Ansible core developer for a great idea! </blockquote><br><img src="https://habrastorage.org/files/3f4/5ed/cb0/3f45edcb06754c869d271477df39d21d.png" alt="Show the list of nginx status codes on servers - ChatOps"><br>  More and more, it looks like a <s>flight</s> control control center.  You can run entire chains of commands on servers directly from the chat and everyone can see the result in real time.  Fine! <br><br><h3>  Example 5. Security patching </h3><br>  Imagine that you urgently need to eliminate another critical vulnerability like <a href="https://en.wikipedia.org/wiki/Shellshock_%2528software_bug%2529">Shellshock</a> .  To do this, you need to update <code>bash</code> on all servers.  Ansible perhaps the perfect tool for such atomic operations.  But instead of running a single-line ansible command, let's create a good playbook: <br>  <a href=""><code>playbooks/update_package.yaml</code></a> : <br><pre> <code class="python hljs">--- - name: Update package on remote hosts, run on <span class="hljs-number"><span class="hljs-number">25</span></span>% of servers at a time hosts: <span class="hljs-string"><span class="hljs-string">"{{ hosts }}"</span></span> serial: <span class="hljs-string"><span class="hljs-string">"25%"</span></span> become: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> become_user: root tasks: - name: Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Package <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> installed command: dpkg-query -l {{ package }} register: is_installed failed_when: is_installed.rc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> changed_when: no - name: Update Package only <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installed apt: name={{ package }} state=latest update_cache=yes cache_valid_time=<span class="hljs-number"><span class="hljs-number">600</span></span> when: is_installed.rc == <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  <code>Playbook</code> update the package only if it is already installed, the operation is performed on 20% of the hosts at a time, those in 5 steps.  It is useful when you need to update something more serious like <code>nginx</code> on a really large number of servers.  Thus, we do not send the entire web cluster to down.  Additionally, you can add disconnection from the load balancer groups.  An example from real life. <br><br>  It can be seen that the playbook variables <code>{{hosts}}</code> and <code>{{package}}</code> come from somewhere outside, namely from the action in our StackStorm <a href=""><code>actions/update_package.yaml</code></a> : <br><pre> <code class="python hljs">--- name: update_package description: Update package on remote hosts runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: immutable: true default: true kwarg_op: immutable: true timeout: default: <span class="hljs-number"><span class="hljs-number">6000</span></span> cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> immutable: true <span class="hljs-comment"><span class="hljs-comment">#   default: "/opt/stackstorm/virtualenvs/ansible/bin/ansible-playbook /opt/stackstorm/packs/${ST2_ACTION_PACK_NAME}/playbooks/update_package.yaml --extra-vars='hosts={{ hosts }} package={{ package }}'" hosts: description: "Ansible hosts" type: string required: true package: description: "Package to upgrade" type: string required: true</span></span></code> </pre><br>  Action alias, which makes it possible to launch the playbook as a simple ChatOps command, <br>  <a href=""><code>aliases/update_package.yaml</code></a> : <br><pre> <code class="python hljs">--- name: chatops.ansible_package_update action_ref: st2_chatops_aliases.update_package description: Update package on remote hosts formats: - display: <span class="hljs-string"><span class="hljs-string">"update &lt;package&gt; on &lt;hosts&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"update {{ package }} on {{ hosts }}"</span></span> - <span class="hljs-string"><span class="hljs-string">"upgrade {{ package }} on {{ hosts }}"</span></span> result: format: | Update package `{{ execution.parameters.package }}` on `{{ execution.parameters.hosts }}` host(s): {~} {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.result.stderr %} *Exit Status*: `{{ execution.result.return_code }}` *Stderr:* ```{{ execution.result.stderr }}``` *Stdout:* {% endif %} ```{{ execution.result.stdout }}``` extra: slack: color: <span class="hljs-string"><span class="hljs-string">"{% if execution.result.succeeded %}good{% else %}danger{% endif %}"</span></span> fields: - title: Updated nodes value: <span class="hljs-string"><span class="hljs-string">"{{ execution.result.stdout|regex_replace('(?!changed=1).', '')|wordcount }}"</span></span> short: true - title: Executed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> value: <span class="hljs-string"><span class="hljs-string">":timer_clock: {{ execution.elapsed_seconds | to_human_time_from_seconds }}"</span></span> short: true footer: <span class="hljs-string"><span class="hljs-string">"{{ execution.id }}"</span></span> footer_icon: <span class="hljs-string"><span class="hljs-string">"https://stackstorm.com/wp/wp-content/uploads/2015/01/favicon.png"</span></span></code> </pre><br>  Here she is: <br><pre> <code class="bash hljs">!update <span class="hljs-string"><span class="hljs-string">'bash'</span></span> on <span class="hljs-string"><span class="hljs-string">'all'</span></span></code> </pre><br><img src="https://habrastorage.org/files/c0d/c0d/5a0/c0dc0d5a040043dba29cd087084b120c.png" title="Updating installed packages on remote hosts using Ansible and Chat-Ops"><br>  An important part of DevOps engineer work is process improvement, making the work of developers easier, team communication is better, problem diagnosis is faster through automation and the use of the right tools ‚Äî all to make the company more successful. <br>  ChatOps helps solve these problems in a completely new, effective way! <br><br><h3>  In conclusion.  Holy cow </h3><br>  As you know, Ansible <a href="https://github.com/ansible/ansible/issues/10530"><code>    cowsay</code></a> .  Let's transfer it to ChatOps! <br><br>  Install the utility for starters: <br><pre> <code class="bash hljs">sudo apt-get install cowsay</code> </pre><br>  Action <a href=""><code>actions/cowsay.yaml</code></a> : <br><pre> <code class="python hljs">--- name: cowsay description: Draws a cow that says what you want runner_type: local-shell-cmd entry_point: <span class="hljs-string"><span class="hljs-string">""</span></span> enabled: true parameters: sudo: immutable: true kwarg_op: immutable: true cmd: description: <span class="hljs-string"><span class="hljs-string">"Command to run"</span></span> type: string immutable: true default: <span class="hljs-string"><span class="hljs-string">"/usr/games/cowsay {{message}}"</span></span> message: description: <span class="hljs-string"><span class="hljs-string">"Message to say"</span></span> type: string required: true</code> </pre><br>  Alias <a href=""><code>aliases/cowsay.yaml</code></a> : <br><pre> <code class="python hljs">--- name: chatops.cowsay action_ref: st2_chatops_aliases.cowsay description: Draws a cow that says what you want formats: - display: <span class="hljs-string"><span class="hljs-string">"cowsay &lt;message&gt;"</span></span> representation: - <span class="hljs-string"><span class="hljs-string">"cowsay {{ message }}"</span></span> ack: enabled: false result: format: | {% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> execution.status == <span class="hljs-string"><span class="hljs-string">'succeeded'</span></span> %}Here <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> your cow: ```{{ execution.result.stdout }}``` {~}{% <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> %} Sorry, no cows this time {~} Exit Code: `{{ execution.result.return_code }}` Stderr: ```{{ execution.result.stderr }}``` Hint: Make sure `cowsay` utility <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> installed. {% endif %}</code> </pre><br>  Call Sacred ChatOps Cow: <br><pre> <code class="bash hljs">!cowsay <span class="hljs-string"><span class="hljs-string">'Holy ChatOps Cow!'</span></span></code> </pre><br><img src="https://habrastorage.org/files/697/694/5be/6976945beaef40debd8ac4d0a518489e.png" alt="Sacred ChatOps Cow"><br><blockquote>  For reference: All the results of command execution can be viewed in the StackStorm control panel. <br>  <a href="https://www.chatops/">https: // chatops /</a> login: <code>demo</code> password: <code>demo</code> <br>  (replace hostname with IP if you haven‚Äôt used the <a href="https://github.com/StackStorm/showcase-ansible-chatops">Vagrant demo</a> ) <br></blockquote><br><br><h2>  Do not stop there! </h2><br>  These were simple but combat examples of use.  More complex things when several DevOps tools are connected to a dynamic workflow will be shown in the following articles.  Here <a href="https://stackstorm.com/">StackStorm</a> demonstrates all its power, making decisions depending on the situation: this is called <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D0%25B1%25D1%258B%25D1%2582%25D0%25B8%25D0%25B9%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B0%25D1%2580%25D1%2585%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0">event-oriented architecture</a> like self-restoring systems after the incident. <br><blockquote>  If you did not find the required functionality in StackStorm, suggest an idea or add a <a href="https://github.com/StackStorm/st2">Pull Request to GitHub</a> (Python is our main language).  There is also a community where you can ask a question or share your experience: a <a href="https://stackstorm.typeform.com/to/K76GRP">public Slack channel</a> (with a pre-installed demo bot) and IRC: <a href="https://webchat.freenode.net/%3Fchannels%3Dstackstorm"><code>#StackStorm</code> on freenode.net</a> . <br></blockquote><br><br>  Thank you for your attention, I hope it turned out to highlight the features of this fairly new approach in the world of DevOps. <br>  And for what cases would you use ChatOps?  Please share ideas and stories (we love stories). </div><p>Source: <a href="https://habr.com/ru/post/260917/">https://habr.com/ru/post/260917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260899/index.html">Introduction to the magic of patterns</a></li>
<li><a href="../260903/index.html">Snowden: NSA is spying on foreign antivirus companies</a></li>
<li><a href="../260907/index.html">Google implements proprietary code in free (?) Chromium</a></li>
<li><a href="../260911/index.html">Development of MMO RPG - a practical guide. Server (Part 2)</a></li>
<li><a href="../260913/index.html">PentestBox - portable assembly of popular security utilities</a></li>
<li><a href="../260919/index.html">The results of the distribution boards. Upgrade stock good</a></li>
<li><a href="../260923/index.html">Access rights - the owner can do anything</a></li>
<li><a href="../260927/index.html">What is Master Data and why is it needed?</a></li>
<li><a href="../260929/index.html">7 web design trends in the near future</a></li>
<li><a href="../260931/index.html">Jii - a JavaScript framework with architecture from Yii 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>