<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenVPN, we unite home networks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article focuses on the integration of several home LANs with the provision of transparent shared access to network resources using VPN. For the i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenVPN, we unite home networks</h1><div class="post__text post__text-html js-mediator-article">  This article focuses on the integration of several home LANs with the provision of transparent shared access to network resources using VPN.  For the implementation of VPN taken <a href="http://openvpn.net/">openvpn</a> .  Clients and the openvpn server are installed on home network routers, in a particular case, routers of the asus wl500 family, but this manual is quite applicable to other routers where there is access to the OS and you can install openvpn. <br><br>  Although such manuals on the Internet are a dime a dozen, they are written more for administrators who have extensive experience with * nix systems, while users of home routers are mostly not hackers, but ordinary users who may first see the Linux command line the router itself.  I will try to write so that it is clear to everyone. <br><br>  For those who do not like a lot of letters, so that it is clear what they mean under the cut, I bring a picture <br><img src="http://static.ivlis.com/inet_pubs/habrahabr/openvpn/openvpn_wl500g.png"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, once again formalize the task.  We have several networks having access to the Internet through a router, we need to provide access to the resources of each other‚Äôs networks through an encrypted Internet tunnel. <br><br><h3>  What is needed there </h3><br><ol><li>  Routers of the asus wl500 family </li><li>  It is very desirable to provide routers with usb-flash drives, since there is very little flash and RAM in the router, absolutely any will do, well, except for a completely old junk, that is, less than 9Mb.  What is not a great reason to please yourself with a new flash drive?  :) </li><li>  At least one of the routers must go to the Internet with a real IP address, or all routers must be in the same segment of the provider's local network. </li><li>  Networks behind routers should have a different address range. </li><li>  Little time and brain </li></ol><br><br>  It will be necessary to configure routers together, therefore it is desirable to have access to them simultaneously.  Running from one apartment to another is not very convenient, so you can either provide access from the Internet to computers behind routers (as I did), or simply assemble routers in one apartment and attach client routers to the server, then on the spot their constant work will only need to change the address of the openvpn server. <br><br><h3>  Theory </h3><br><br>  Consider briefly how the system will work.  The network consists of a server (in the figure, this is the Mars router) and Earth and Mercury clients.  The server provides virtual network operation, traffic encryption and packet routing from one network to another. <br><br>  The server operation is shown in more detail in the following figure (the figure is very conditional, it is for general understanding only and does not reflect program components).  In client mode, openvpn works in the same way, but does not perform routing. <br><br><img src="http://static.ivlis.com/inet_pubs/habrahabr/openvpn/openvpn_server.png"><br><br>  So, we have a network with the address range 192.168.1.1-192.168.1.255 behind the first router (Mars) and with the range 192.168.2.1-192.168.2.255 behind the Earth router.  OpenVPN creates a special virtual network card tun0, and the packets that get there are encrypted and sent to the server (on the server computer locally, on the client via the Internet), where they are decrypted and sent via the necessary tunnels to the addressee. <br><br>  For example, consider the passage of a package from a Phobos computer to a Moon computer.  A packet from Phobos is sent to its gateway by default - Mars, where the routing table says that it needs to be sent to the tun0 tunnel, where it gets into openvpn, which already knows that packets to the network which includes Moon should be sent to the tunnel to Earth .  Having come to Earth, the package will be safely sent to the Moon connected to the loaklke. <br><br><h3>  Practice </h3><br>  We are flashing routers with firmware from Oleg and installing ikpg.  I think many users wl500th this procedure is known.  It is very detailed written here: <a title="http://wl500g.info/showthread.php?t=3171" href="http://wl500g.info/showthread.php%3Ft%3D3171">http://wl500g.info/showthread.php?t=3171</a> .  We need steps 1-4, the actual firmware and 7, the installation of additional packages. <br><br>  After everything is ready we put the packages there with the command ipkg install &lt;package name&gt; <br><ul><li>  openvpn - well, it is not hard to guess :) </li><li>  vim is a text editor (the one that is built into the shell is completely useless) </li><li>  wget-ssl - will be needed to update the records in dns, if the server has a dynamic external ip. </li></ul><br><br>  While the packages are being installed, we digress a bit from Linux and generate keys for the vpn connection.  How to do it under Windows (Linux, I think, already in the topic :)) has already been considered <a href="http://gtbear.habrahabr.ru/blog/36845/">in</a> detail <a href="http://gtbear.habrahabr.ru/blog/36845/">on Habr√©</a> , it makes no sense to repeat, you just need to add that ca.key should be removed somewhere far away, for example, write to an unnecessary USB flash drive.  <s>, and put the flash drive in the chest under 33 locks</s> , since knowing ca.crt and ca.key you can easily connect to your home network, which is clearly not part of our plans. <br><br>  Having certificates at hand they need to be put on the router which will be the server, since these are ordinary text files, then you can just copy them into a text editor on the router. <br>  Connect via telnet to the router, for example <br><br>  C: \&gt; telnet 192.168.1.1 <br><br>  Further: <br><br>  $ vim /opt/etc/openvpn/keys/ca.crt <br>  Then press the i button, paste the contents of the ca.crt file.  We do the same with the dh2048.pem, mars.crt and mars.key files. <br><br>  After that, you need to create an openvpn configuration file, the included one can be discarded and inserted: <br><br>  $ rm /opt/etc/openvpn/openvpn.conf <br>  $ vim /opt/etc/openvpn/openvpn.conf <br><br><blockquote>  dev tun <br><br>  tls-server <br>  server 192.168.255.0 255.255.255.0 <br>  ifconfig 192.168.255.1 192.168.255.2 <br><br>  client-config-dir ccd <br><br>  route 192.168.255.0 255.255.255.0 #IP Range of VPN <br>  route 192.168.2.0 255.255.255.0 #IP Range of Earth <br><br>  push "route 192.168.1.0 255.255.255.0" <br>  #Say to clients that Mars has 192.168.1.0/24 LAN <br><br>  #keys <br><br>  dh /opt/etc/openvpn/keys/dh1024.pem <br>  ca /opt/etc/openvpn/keys/ca.crt <br>  cert /opt/etc/openvpn/keys/home2.crt <br>  key /opt/etc/openvpn/keys/home2.key <br><br>  #Do not change unless you know what you are doing <br><br>  client-to-client <br><br>  port 1194 <br>  proto udp <br><br>  user nobody <br>  group nobody <br><br>  comp-lzo <br>  persist tun <br>  persist-key <br>  verb 3 <br><br>  log-append /opt/var/log/openvpn/openvpn.log <br>  status /opt/var/log/openvpn/status.log <br><br>  keepalive 10 60 <br></blockquote><br><br>  Create a directory in which there will be a configuration for clients <br><br>  $ mkdir / opt / etc / openvpn / ccd / <br><br>  In this directory, you must create files for those clients behind which will be located the network to be joined.  In our case, this is the Earth client, we create the Earth file. <br><br>  $ vim / opt / etc / openvpn / ccd / Earth <br><br>  We will have one whole line <br><blockquote>  iroute 192.168.2.0 255.255.255.0 <br></blockquote><br><br>  This line tells openvpn where to send packets for the 192.168.2.0/24 network. <br><br>  So, before the openvpn start, it remains only to correct the startup script /opt/etc/init.d/S20openvpn and remove the line return 0 from there. <br><br>  Everything, we start openvpn <br><br>  /opt/etc/init.d/S20openvpn <br><br>  If everything is ok, then netstat -ul output |  grep 1194 should issue a stitch <br> <code>udp 0 0 *:1194 *:* <br></code> <br>  and in the /opt/var/log/openvpn/openvpn.log file an entry about the successful launch of the server appears. <br><br>  So, the server is working, it is necessary to allow packets to pass through the firewall. <br>  For this: <br> <code>$iptables -I INPUT -p udp --dport 1194 -j ACCEPT <br> $iptables -I FORWARD -i br0 -o tun0 -j ACCEPT <br> $iptables -I FORWARD -i tun0 -o br0 -j ACCEPT <br> $iptables -I INPUT -i tun0 -p tcp --dport 80 -j ACCEPT <br></code> <br><br>  For the rules to be applied each time they need to be added to the / usr / local / sbin / post-firewall file, and the line /opt/etc/init.d/S20openvpn should be added to the post-mount so that the server starts each time the router is started ($ means Command line request; no need to add it to the files!). <br><br>  (Did you remember to write the changes in flashfs?) <br><br>  At this point, the server setup is almost complete.  The only thing is, if the server has a dynamic ip, then you need to take care that the clients know what IP the server currently has.  To do this, there is such a thing as DDNS, that is, dynamic DNS.  Asus has built-in support for some DDNS providers, but not all, such as <a href="http://namecheap.com/">mine</a> .  Therefore, I wrote a simple script that updates IP to DNS if the IP of the router has changed: <br><blockquote> <code>#!/bin/sh <br> IFACE="ppp0" <br> TMPFILE="/tmp/oldip.txt" <br> <br> /sbin/ifconfig $IFACE &gt; /dev/null 2&gt;&amp;1 <br> if [ "$?" -ne "0" ] <br> then <br> logger "update_ip.sh: Interface $IFACE is down, exiting..." <br> exit 1 <br> fi <br> <br> new=`/sbin/ifconfig $IFACE|grep inet\ addr|sed -e 's/.*\ addr:\([0-9\.]*\).*/\1/'` <br> <br> if [ -f $TMPFILE ] <br> then <br> old=`cat $TMPFILE` <br> else <br> touch $TMPFILE <br> old=" " <br> fi <br> <br> if [ "$new" != "$old" ] <br> then <br> /opt/bin/wget --no-check-certificate "https://dynamicdns.park-your-domain.com/update?host=mars&amp;domain=yourdomain&amp;password=PASSWORD" &gt; /dev/null 2&gt;&amp;1 <br> logger "update_ip.sh: New ip $new detected" <br> echo $new &gt; $TMPFILE <br> fi <br></code> <br></blockquote><br><br>  How to install and configure cron is written in great detail here: <a href="http://wl500g.info/showpost.php%3Fp%3D52524%26postcount%3D1">wl500g.info/showpost.php?p=52524&amp;postcount=1</a> <br><br>  And so, now go to the client.  Client installation is absolutely the same as the server, the only thing is to overtake the client keys (we will need ca.crt, Earth.crt, Earth.key) and the other config file.  Do not forget to correct the startup script. <br><br>  Client config, in the remote field you need to insert the server address <br><blockquote> <code>client <br> dev tun <br> proto udp <br> remote mars.yourdomain 1194 <br> resolv-retry infinite <br> nobind <br> persist-key <br> persist-tun <br> ca /opt/etc/openvpn/keys/ca.crt <br> cert /opt/etc/openvpn/keys/Earth.crt <br> key /opt/etc/openvpn/keys/Eartth.key <br> ns-cert-type server <br> comp-lzo <br> verb 3 <br> log-append /opt/var/log/openvpn/openvpn.log <br> status /opt/var/log/openvpn/status.log <br></code> <br></blockquote><br><br>  Similarly, apply the rules iptables: <br> <code>$iptables -I FORWARD -i br0 -o tun0 -j ACCEPT <br> $iptables -I FORWARD -i tun0 -o br0 -j ACCEPT <br> $iptables -I INPUT -i tun0 -p tcp --dport 80 -j ACCEPT <br></code> <br><br>  We launch openvpn on the client, it connects to the server and enjoy life.  You can watch movies, photos and chopped into games like lokalke. <br><br>  The only thing that I could not do is to synchronize the internal DNS servers, so you need to access computers between networks by their ip. <br><br>  Well, I hope this will be useful to someone, I'm tired of writing this epic manual. <br><br>  For homework, connect your Mercury computer so that it can access local resources from anywhere, such as gprs or public wifi. <br><br>  As an advanced homework, take away from mercury the ability to connect to the network, changing only the configuration of Mars. <br><br>  (C) Ivan Lisenkov 2009 </div><p>Source: <a href="https://habr.com/ru/post/56652/">https://habr.com/ru/post/56652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../56646/index.html">A gallery of websites based on Microsoft technologies has been opened.</a></li>
<li><a href="../56647/index.html">CD turntables</a></li>
<li><a href="../56648/index.html">Little Red Riding Hood eyes of engineers</a></li>
<li><a href="../56650/index.html">Renting a printer is cheaper than using a purchased one.</a></li>
<li><a href="../56651/index.html">The history of the development of the project idea</a></li>
<li><a href="../56655/index.html">Changing the role of IP in the transition to an innovative model of the economy</a></li>
<li><a href="../56657/index.html">Non-standard approach to language icons</a></li>
<li><a href="../56658/index.html">Postcards Opera Mini - in your city!</a></li>
<li><a href="../56660/index.html">The new version of XMIND is now available in open source!</a></li>
<li><a href="../56661/index.html">Fashionable phone - the race for fashion or the need?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>