<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shadows of the characters in the video The Blacksmith</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One fine morning last fall, we learned the long-awaited news: the antagonist is ready! 
 It was just a rough model: no hair, skin and the appropriate ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shadows of the characters in the video The Blacksmith</h1><div class="post__text post__text-html js-mediator-article"> One fine morning last fall, we learned the long-awaited news: the antagonist is ready! <br>  It was just a rough model: no hair, skin and the appropriate setting of materials, but we were still very happy.  Someone immediately suggested: ‚ÄúLet's quickly stick materials to it!  I can't wait to see this guy on the screen! ‚Äù <br><br>  So we did.  But something went wrong ... "Stop, and we just set it up to get dynamic shadows?" That's right.  But the result did not meet our expectations at all. <br><br><img src="https://habrastorage.org/files/c6d/128/d61/c6d128d61efc4d328f6e4e9bc801dabe.jpg"><br><a name="habracut"></a><br>  <b>Problem</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having rummaged in the shader, we found the essence of the problem: half of the shadows were not displayed in principle, and the second half was not displayed correctly. <br><br><img src="https://habrastorage.org/files/411/b82/840/411b828409af407b82d50a09f951cbce.png"><br><br>  ‚ÄúWhat is the matter?‚Äù You ask.  - ‚ÄúWhat about the new filtering algorithm in Unity 5, which makes the shadows softer and more realistic?‚Äù.  But the fact is that in some scenes the camera was at a distance of up to 3000 meters, and we wanted the shadows to be displayed on each pixel within its field of view.  Of course, we specifically set up cascade splits and offset parameters for high-quality display of shadows both directly in front of the camera and at a great distance. <br><br>  The problem is that we didn‚Äôt foresee a close-up of the character in such a large-scale scene.  Not only did we lack resolution for creating soft shadows, so the depth offset that we set up for the stage was so big that the character was left without shadows.  It turns out that the soft shadow cast by a leather strap on the armor is very different from the soft shadow cast by a large cobblestone on the surface of the earth.  Who would have thought! <br><br>  So, we needed to find a solution to this problem.  We could bring the first cascade as close as possible to the camera, but then we would have to sacrifice the general cascade for the whole shot.  Such an option would be suitable only for scenes with a very close-up, which in principle was required. <br><br>  <b>Decision</b> <br><br>  Nevertheless, we decided to apply a more traditional technology: make separate shadow maps for the characters.  Two hundred lines of code - and voila!  Here's what we got: <br><br><img src="https://habrastorage.org/files/b23/21f/a3a/b2321fa3a50e43a6a783a2d70f071877.png"><br><br>  At this stage, we already had enough data to apply almost any shadow filter.  But there was not enough time for its fine tuning, so we decided to stop at a simple sampling, taking into account the distance, similar to the Nvidia PCSS shadow technology [1]. <br><br>  In addition, we have the opportunity to collect data from static objects that are outside the close-up and cast shadows on dynamic objects, that is, on characters.  Static objects were projected onto the front plane of the rendering camera, which provided the maximum distance of the Blocker-to-Receiver in the soft shadow filtering scheme. <br><br>  It remains only to integrate our solution into the overall pipeline rendering.  Having a little puzzled over this issue, we found a very simple way of replacing the functions of shadows used in almost all standard Unity shaders.  After several iterations, we simplified it to two lines of code: <br><br> <code>#pragma multi_compile _ UNIQUE_SHADOW UNIQUE_SHADOW_LIGHT_COOKIE <br> #include "UniqueShadow_ShadowSample.cginc" <br></code> <br><br>  Please note that for this function to work correctly, the #include line must be written before any other #include lines in the code.  If you plan to use this method for similar purposes, please note that the entire complexity of the replacement lies in the code hidden in the include file: <br><br> <code>#if SOME_CONDITION_ENABLING_OUR_FEATURE <br> #include "AutoLight.cginc" <br> #undef SHADOW_COORDS <br> #undef TRANSFER_SHADOW <br> #undef SHADOW_ATTENUATION <br> #define SHADOW_COORDS(i) SOME_OTHER_COORD(i) <br> #define TRANSFER_SHADOW SOME_OTHER_TRANSFER <br> #define SHADOW_ATTENUATION(i) SOME_OTHER_ATTEN(i) <br> #endif <br></code> <br><br>  In this case, we have 2 conditions: whether support for unique shadows is enabled and whether a source of directional light is rendered.  The second condition allows to combine this function with other light sources that cast shadows. <br><br>  <b>Result</b> <br><br>  So, have we managed to achieve satisfactory results?  See for yourself!  Here is the same render with unique shadows and without them: <br><br><img src="https://habrastorage.org/files/dc0/9d6/863/dc09d6863a6a4d949cfe98090b5d4ca3.gif"><br><br>  <b>Conclusion</b> <br><br>  Do not forget that additional shadow maps, like any other rendering functions, require additional resources.  They take up more video memory, use more render calls when rendering, and also require more bandwidth and processing power for use in the shader. <br><br>  For The Blacksmith video, we specifically added the ability to turn on and off unique shadows depending on how far away the characters are from the camera.  Thus, the system load was increased only during the rendering of close-up shots.  In games where the approach of the camera to the player is not foreseen in principle, this function can be added only for individual close-ups in splash screens. <br><br>  To better demonstrate this feature, we have created a small demo project that <a href="https://www.assetstore.unity3d.com/en/">can be downloaded from the Asset Store.</a>  Using the example from the movie scene, you can see how to maintain a high detail of a close-up of the character in a large open space.  Despite the fact that the first cascade covers only 1% of total Shadow Distance, the difference is obvious: a model with unique shadows on the left looks much better than a model with cascading shadows on the right. <br><br><img src="https://habrastorage.org/files/c20/fc1/be3/c20fc1be365b415798e5ffbfeaf1d57a.png"><br><br>  <a href="http://developer.download.nvidia.com/shaderlibrary/docs/shadow_PCSS.pdf">References</a> </div><p>Source: <a href="https://habr.com/ru/post/272673/">https://habr.com/ru/post/272673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272659/index.html">Next, in search of palindromes 3</a></li>
<li><a href="../272661/index.html">NOT unlimited mailbox, or Tale about the secret limitation of Mail.ru</a></li>
<li><a href="../272667/index.html">Practice: How to set up an HP ProLiant ML10v2 server and prepare it for OS installation</a></li>
<li><a href="../272669/index.html">Tarantool as an application server</a></li>
<li><a href="../272671/index.html">ICQ mobile application design contest</a></li>
<li><a href="../272675/index.html">PostgreSQL Designing a Document-Oriented API: Comprehensive Queries (Part 4)</a></li>
<li><a href="../272677/index.html">Perl5 plugin for IntelliJ IDEA v1.2: Moose and Signatures</a></li>
<li><a href="../272679/index.html">Neural network in Python, part 2: gradient descent</a></li>
<li><a href="../272681/index.html">Compare Swift and Rust</a></li>
<li><a href="../272689/index.html">Own index types in Cach√© DBMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>