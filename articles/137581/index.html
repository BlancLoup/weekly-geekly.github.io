<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic Access Control for ASP.NET MVC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ASP.NET MVC has a built-in ability to restrict access to certain controllers and their actions. This feature is provided by the AuthorizeAttribute att...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic Access Control for ASP.NET MVC</h1><div class="post__text post__text-html js-mediator-article"> ASP.NET MVC has a built-in ability to restrict access to certain controllers and their actions.  This feature is provided by the <code>AuthorizeAttribute</code> attribute, but it clearly lacks the capabilities and flexibility (or rather, there are practically none).  Rights can be defined only at the development stage and cannot be changed without recompiling.  But to create your own attribute with the necessary functionality is not at all difficult. <br><a name="habracut"></a><br>  So let's get started.  We create a new project in Visual Studio, select the type ASP.NET MVC 3 Web Application, call <i>DynamicAuthorize</i> .  We are waiting for the studio to generate the project. <br>  How to store and define access rights can be done in various ways: in the <abbr title="Database">database</abbr> , retrieved from a remote service, in an xml file, etc.  It all depends on the task and your preferences.  For an example, in order not to be distracted by the implementation of these mechanisms, we will make a class that returns permissions information, and replace it with the implementation you need, I think it will not cause problems.  Actually <code>PermissionManager</code> class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PermissionManager</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidatePermissions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> controller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> user</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isUserAccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-string"><span class="hljs-string">"user1"</span></span> &amp;&amp; controller == <span class="hljs-string"><span class="hljs-string">"Home"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Test"</span></span>: isUserAccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user == <span class="hljs-string"><span class="hljs-string">"user2"</span></span> &amp;&amp; controller == <span class="hljs-string"><span class="hljs-string">"Home"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Edit"</span></span>: isUserAccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">//       " " if (controller == "Home" &amp;&amp; (action == "Index" || action == "About")) { isUserAccess = true; } return isUserAccess; } }</span></span></code> </pre> <br>  The class is elementary, so I don‚Äôt need to explain what it does.  As for the authorization itself, MVC has an <code>IAuthorizationFilter</code> interface, in which the only <code>OnAuthorization</code> method is <code>OnAuthorization</code> .  This method is called if necessary to authorize the user, i.e.  check if he has rights to this operation.  This is exactly what we need.  Well, enough of the theory, let's start creating the attribute itself, i.e.  class <code>DynamicAuthorizeAttribute</code> : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DynamicAuthorizeAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">FilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IAuthorizationFilter</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAuthorization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AuthorizationContext filterContext</span></span></span><span class="hljs-function">)</span></span> { PermissionManager permissionManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PermissionManager(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> action = filterContext.ActionDescriptor.ActionName; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> controller = filterContext.ActionDescriptor.ControllerDescriptor.ControllerName; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> user = filterContext.HttpContext.User.Identity.Name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!permissionManager.ValidatePermissions(controller, action, user)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnauthorizedAccessException(<span class="hljs-string"><span class="hljs-string">"     "</span></span>); } } }</code> </pre> <br>  In the passed parameter of the type <code>AuthorizationContext</code> there are many useful properties that make it possible to organize the checking of access rights in many ways, but in this case the check is elementary, we just use the method of the <code>PermissionManager</code> class. <br>  This, in fact, the creation of dynamic authorization is completed.  I said it was not difficult.  Well, proceed to the tests.  Let's create two additional actions (two were kindly created by the studio) of the <code>Home</code> controller: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Edit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); }</code> </pre> <br>  We create representations for them (I used the Visual Studio generator) <br>  And mark the controller with our newly created attribute: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Attributes.DynamicAuthorize</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span></code> </pre> <br>  Add links to the created controller actions to the <code>Index</code> view: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ActionLink("Test", "Test") <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ActionLink("Edit", "Edit") <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Now you need to build a project, press <i>Ctrl + Shift + B</i> , it should work without errors. <br>  Now we will create test users, we launch <i>ASP.NET Admin tools</i> <br><img src="http://img708.imageshack.us/img708/3102/createuser.png" alt="image"><br>  Go to the <i>"Security"</i> section and add 2 users with the names <i>user1</i> and <i>user2</i> .  Everything can run the project.  Now, if you click on one of the links without logging in, you will get an access error.  If you log in as user1, the Test action will be available, but not Edit.  If you log in as user2, then the opposite is true. <br>  In conclusion, I would like to say that, despite the simplicity of implementation, beginners often have a question about how to organize dynamic access rights checking.  I hope this post will help people faced with this issue to cope with it and make the authorization exactly as it was intended. <br>  Download the project <a href="http://zalil.ru/32638896">here</a> . </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/137581/">https://habr.com/ru/post/137581/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137567/index.html">Announced hardware support for transactional memory in Haswell</a></li>
<li><a href="../137569/index.html">Image design on CSS3. Part 2</a></li>
<li><a href="../137571/index.html">EX.UA, LOIC and helpless Ukrainian police</a></li>
<li><a href="../137577/index.html">Ruby on rails to the masses: webvybory2012.ru issue a standard error page for the development of the Rails environment</a></li>
<li><a href="../137578/index.html">Opera Mini update - even if it is not installed</a></li>
<li><a href="../137582/index.html">Mysterious indents between inline elements</a></li>
<li><a href="../137584/index.html">Create a datepicker similar to the standard in Harmattan</a></li>
<li><a href="../137585/index.html">IT in tourism is a myth</a></li>
<li><a href="../137587/index.html">DNS server BIND (theory)</a></li>
<li><a href="../137588/index.html">Weigh CSS selectors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>