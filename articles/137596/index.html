<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make a controlled outlet from a Chinese router, or another project for a smart home and office</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lately, there are more and more articles on Habr√© on the topic ‚ÄúSmart Home‚Äù, ‚ÄúMake it Yourself‚Äù, and this makes me happy. I will also make my modest c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make a controlled outlet from a Chinese router, or another project for a smart home and office</h1><div class="post__text post__text-html js-mediator-article">  Lately, there are more and more articles on Habr√© on the topic ‚ÄúSmart Home‚Äù, ‚ÄúMake it Yourself‚Äù, and this makes me happy.  I will also make my modest contribution to the development of civilization.  Welcome to the world of smart things! <br><br><a name="habracut"></a><br><br><img src="http://dl.dropbox.com/u/931321/MZ_BOX/MZ_box_top.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Brief prehistory </h5><br>  At first there was chaos ... Let's skip the stages of creation of the world and the era of dinosaurs and go straight to the 21st century.  Around wireless technology, electronics everywhere, spacecraft are flying to Mars ... <br><br>  Having discovered the Chinese online stores of various goods, I bought all the good.  In particular, kits were purchased for remote control of light bulbs: a remote control and several boxes for it.  As a result, I made 4 controlled outlets at home and now, lying on the sofa in the evening and reading Habr, you can turn on or turn off the lights in the room and in the hallway, without getting up from the sofa.  Conveniently. <br><br>  Also absolutely wonderful small cheap WiFi routers were <a href="http://www.aliexpress.com/">purchased</a> .  One of them was used as a "extension" for wireless Internet in the nursery, and the other remained in reserve.  By the way, I recommend very good specifications for less than 600 rubles. <br>  There were many different good things in the ‚Äúbins of the Motherland‚Äù, and there were great New Year's holidays.  And the project was born ... <br><br><h5>  Purpose and means </h5><br>  It was decided that an absolutely necessary thing in my ‚Äúsmart home‚Äù is an electrical outlet that can be controlled via the Internet.  For this, the necessary details were collected: <br><ul><li>  router </li><li>  AtMega16 microcontroller board from an old project </li><li>  solid-state relays </li><li>  2-line LCD display </li><li>  body </li><li>  wires and other consumables </li></ul><br><br><h5>  Technical task </h5><br>  The device was given the name "MZ-switch", and it had to do the following things: <br><ul><li>  receive commands from the host via the Internet </li><li>  work as a load control relay and as a time relay </li><li>  work as a "pingovalka" and be able to reboot the router and disconnect the load in the absence of ping </li><li>  program the parameters of work from the command line and save them in your memory </li><li>  show status on display </li><li>  please the master with his existence </li></ul><br><br><h5>  Code injection into the router </h5><br>  When I received the <a href="">router</a> , then, of course, immediately got inside.  At first I got there not mechanically, but metaphysically, through telnet. <br>  It <s>turned</s> out that he has Linux <s>neon</s> inside, and you can even write and run your own script if you wish.  You can even save it in the memory of the router, but how to make the script automatically run at startup? <br>  A few days were killed to find the ability to run the script.  The main idea was in the "code injection" in the launch of some kind of startup script, and such a script was found!  The injection looks like this: <br><br><img src="http://dl.dropbox.com/u/931321/MZ_BOX/MZ_code_inject.jpg" alt="code_inject"><br><br>  Now, when my router starts, it extracts the scripts stored there from its memory and runs them.  Therefore, you can implement your own algorithm of interaction with the outside world. <br><br>  Having achieved the launch of the scripts from the router, I got into it mechanically.  Inside there was a serial port through which you can access the console.  Having soldered 3 pins to the right points of the board, I was able to control the router via the serial port using a microcontroller. <br><br><h5>  Microcontroller and control program </h5><br>  The microcontroller must be able to communicate through the serial port with the router, manage the load, display the results of the work and generally do all the dirty work.  From the previous project, there was a motherboard with an AtMega16 microcircuit having the necessary functionality.  She went to work. <br>  The basic algorithm of the microcontroller is as follows: we get a string with a command, analyze, execute, return a string with the answer.  It reminded me of the logic of analog modems: <b>S-registers</b> with data and <a href="http://en.wikipedia.org/wiki/Hayes_command_set"><b>AT-</b></a> control <a href="http://en.wikipedia.org/wiki/Hayes_command_set"><b>commands</b></a> . <br>  Respecting copyrights and generally for diversity, the algorithm operates with the concepts of <b>R-</b> registers and <b>MZ-</b> commands.  Registers store numbers and strings, and commands allow you to change registers and control the logic of work. <br>  An example of the display contrast adjustment command: " <i>MZ + R0 = 200</i> " <br><br><h5>  Clever algorithm </h5><br>  The algorithm of the microcontroller consists of several separate tasks: <br><ul><li>  data transmission from the transmission buffer </li><li>  receiving data and storing them in the receive buffer </li><li>  analysis of received data and determination of commands </li><li>  read and write internal R-registers </li><li>  load management and logic </li><li>  indication of operating modes </li><li>  countdown time intervals </li></ul><br><br>  All this managed to be placed in the amount of 8K code and 512 bytes of data, using only half of the <a href="http://atmel.com/devices/ATMEGA16.aspx">resources of the microcontroller</a> .  So you can still come up with something and program.  For example, show the time, weather, play music and move around the apartment. <br>  The control program was written and debugged on a common terminal.  No device was harmed. <br><br>  The result is the following device functionality: <br><ul><li>  pause after power on: allows you to wait for the router to load and not respond to the ‚Äúgarbage‚Äù that it gives to the console </li><li>  if authorization is required, then enter the login and password in response to a request from the router </li><li>  running a script that allows you to configure the router to work with the device (init) </li><li>  running the main script that will be executed by the router during operation (loop) </li><li>  receiving commands from the router and sending response messages </li><li>  watchdog timer to restart the router when there is no activity </li><li>  running a script reloading the router (halt) </li><li>  load switching on and off using an opto-isolated relay </li><li>  the ability to customize all parameters and store them in the memory of the microcontroller </li></ul><br><br><h5>  Shaytan machine </h5><br>  For some reason, very often the implementation of the functionality of some simple thing reminds me of the task from the <b>Incredible machine</b> game.  Well, how can the ‚Äúturn on the light bulb‚Äù purpose consist of such intricate things and actions?  That's how: <br><ul><li>  So that the router could execute our scripts, we will do ‚Äúcode injection‚Äù into one of its own scripts. </li><li>  The injected code creates several service scripts in the / tmp folder, which we will use later. </li><li>  The router does not allow creating files with the attribute "executable" and, thanks to caring Chinese, it does not have the chmod command. </li><li>  But we elegantly bypass this trouble: first, copy some executable script under the name we need into the / tmp folder, and then overwrite its contents! </li><li>  The router has a WEB-interface to manage, but you cannot change / add your page: everything is read-only </li><li>  But we elegantly bypass this trouble: it turns out there is a page for launching any command, but there are no direct links to it.  We type the address of this page manually, and we can run our scripts!  Although not a beautiful button, but an old school command line. </li><li>  In order for the device to receive a command from the user, we use the ‚Äúsave-and-pass‚Äù method: one script is called from the command entry form and saves the user input to the file.  Another script constantly checks for the presence of this file, and when it finds it, it sends it via a serial port to the microcontroller. </li><li>  Having received user input, the microcontroller selects a command from it and executes it.  For example, the command "turn on the load." </li></ul><br>  Everything, the problem is solved! <br><br><h5>  Assembly in the case </h5><br>  Many projects do not live to see the release due to the fact that laziness or nothing to do with a normal body.  In this case, the goal was originally set: to make an ‚Äúindustrial design‚Äù so that it looked adult, and not as usual. <br>  The hull was spacious enough to accommodate everything there without crowding.  A couple of days off with a drill and a file, yo-ho-ho and a bottle of rum, and now the device is assembled.  All fasteners were found in the closet, where the remnants of furniture assembly and <s>trash</s> in general household items are kept.  Do not be surprised with dowel fasteners: there were no screws with nuts for the required diameter. <br>  An indispensable material during assembly is the "Chinese snot" - plastic tubes for glue guns.  In the absence of such a pistol, all the work was done with the tip of an ordinary soldering iron. <br><br>  Here's what happened in the end: <br>  outside <br><img src="http://dl.dropbox.com/u/931321/MZ_BOX/MZ_box_show.jpg" alt="outside"><br>  from the inside <br><img src="http://dl.dropbox.com/u/931321/MZ_BOX/MZ_box_inner.jpg" alt="from the inside"><br><br><h5>  Why was it necessary </h5><br>  I will not say that a unique device has been created, which has no analogs yet.  Although why not?  I will!  Any new product in marketing materials is referred to as ‚Äúunique‚Äù and ‚Äúunparalleled‚Äù.  In the extreme case, "several times better than normal ...".  Therefore, I say: it turned out really <b>unique</b> device, more than <b>9,000 times</b> smarter than a <i>regular outlet</i> . <br>  You can connect an electric kettle and turn it on with a laptop via Wi-Fi.  And you can turn on the ship siren, if the Internet is gone in the house.  And you can connect the <a href="http://kremlin.ru/">Main Server</a> to the device and restart it while at home. <br>  In fact, this project was implemented as a ‚Äúwarm-up for the mind‚Äù, so as not to lose the skills in programming microcontrollers and owning a soldering iron. <br><br>  <a href="">Project materials</a> are allowed to copy and modify.  It is desirable with reference to the author of the project. </div><p>Source: <a href="https://habr.com/ru/post/137596/">https://habr.com/ru/post/137596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137589/index.html">fbi.gov also uses nginx</a></li>
<li><a href="../137590/index.html">How to protect against unexpected commenting by Ctrl + Enter?</a></li>
<li><a href="../137593/index.html">Another step to PyCon.RU - ekb.py</a></li>
<li><a href="../137594/index.html">One more video glasses from Nabes LLC</a></li>
<li><a href="../137595/index.html">The use of an inertial navigation system (INS) with several sensors on the example of the task of stabilizing the height of a quadrocopter</a></li>
<li><a href="../137597/index.html">Mint 4200 floor polisher is another smart mop. Now with gps</a></li>
<li><a href="../137598/index.html">RIM offers PlayBook 16 Gb to developers for BlackBerry apps (UPD)</a></li>
<li><a href="../137599/index.html">Problem with accuracy and overflow</a></li>
<li><a href="../137600/index.html">Native vs Web. Part 0: +1 argument in favor of developing native mobile apps</a></li>
<li><a href="../137601/index.html">Breaking LostFilm Captcha (php)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>