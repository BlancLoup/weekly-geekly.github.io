<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bypassing Windows Defender cheap and cheerful: Mimikatz obfuscation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. Today we will consider the option of running mimikatz on Windows 10. Mimikatz is a tool that implements the functionality of Windows Credential...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bypassing Windows Defender cheap and cheerful: Mimikatz obfuscation</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/654/4e0/ef1/6544e0ef1426f38bf9111062ac398b49.jpg" alt="image"></div><br>  Hello.  Today we will consider the option of running mimikatz on Windows 10. Mimikatz is a tool that implements the functionality of Windows Credentials Editor and allows you to extract the authentication data of the user logged in in the open form. <br><br>  During the Pentest, it is useful to have a piece that will reset the passwords of users, but now even the standard Windows Defender built into Windows becomes a problem and can interfere with our grandiose plans. <br><br>  I note that this method is also suitable for other anti-virus products (Virustotal BEFORE and AFTER also thinks so), which carry out a static analysis of binary files by signatures. <br>  So even though this method is unlikely to help you against EDR solutions, it will easily help to bypass Windows Defender. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Previously, it could be circumvented by changing the words in the file from mimikatz to mimidogz, deleting a couple of lines in the metadata and banners.  Now it has become more difficult, but still possible. <br><a name="habracut"></a><br>  For the idea of ‚Äã‚Äãall this action I express my gratitude to the person with the nickname ippsec. <br><br>  In this article we will use: <br><br><ul><li>  Windows 10 with Windows Defender enabled (with updated databases) </li><li>  <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a> </li><li>  <a href="https://visualstudio.microsoft.com/ru/">Visual studio</a> </li><li>  <a href="https://mh-nexus.de/en/hxd/">HxD</a> (hex editor) </li></ul><br>  By copying mimikatz to the victim's computer, we expectedly see such an alert. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fef/45e/382/fef45e382ec0516c4d017fcd8c6a6382.jpg" alt="image"></div><br><br>  Next, we will conduct a series of manipulations so that Defender will stop seeing the threat here. <br><br>  First, find and replace the words mimikatz.  Replace mimikatz for example with thunt (you can replace it with anything), and MIMIKATZ with THUNT.  It looks like this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/06d/d9d/3f9/06dd9d3f90d0be4fb6748ee962257939.jpg" alt="image"></div><br>  Next we edit the mimikatz \ mimikatz \ mimikatz.rc file (which is now thunt.rc after our replacement) in Visual Studio, replacing mimikatz and gentilkiwi with anything, and also do not forget to replace mimikatz.ico with any other icon.  Click ‚Äúrebuild solution‚Äù (or rebuild solution) and get our updated version of mimikatz.  We will copy on the victim's computer, iii ... alert.  Let's find out what works Defender.  The easiest way is to copy a binary with a different size before the first antivirus is triggered. <br><br>  First, copy the half and copy to the machine with Windows 10. <br><br><pre><code class="bash hljs">head ‚Äìc 600000 mimikatz.exe &gt; hunt.exe</code> </pre> <br>  Defender is silent, not bad.  Experimenting, we find the first response.  I looked like this: <br><br><pre> <code class="plaintext hljs">head -c 900000 mimikatz.exe &gt; hunt.exe ‚Äì   head -c 950000 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 920000 mimikatz.exe &gt; hunt.exe ‚Äì   head -c 930000 mimikatz.exe &gt; hunt.exe ‚Äì   head -c 940000 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 935000 mimikatz.exe &gt; hunt.exe ‚Äì   head -c 937000 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 936000 mimikatz.exe &gt; hunt.exe ‚Äì   head -c 936500 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 936400 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 936300 mimikatz.exe &gt; hunt.exe ‚Äì  head -c 936200 mimikatz.exe &gt; hunt.exe ‚Äì  </code> </pre> <br>  Open hunt.exe in the hex editor and see what the Defender can do.  The eye clung to the string KiwiAndRegistryTools. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/056/977/94b/05697794b81a7d4423c20f8576b9d68c.jpg" alt="image"><br><br>  Let's play with a random caps - it was KiWIAnDReGiSTrYToOlS, save and copy.  Silence, which means that we guessed.  Now we find all the occurrences of these lines in the code, replace and rebuild our project.  To verify, we run head -c 936300 mimikatz.exe&gt; ‚Äã‚Äãhunt.exe.  The last time Defender worked, now no.  Moving on. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/023/8e4/017/0238e401735da0efcc4e751033f2542c.jpg" alt="image"></div><br>  In this not tricky way, adding more and more lines to our hunt.exe, the trigger words were found - wdigest.dll, isBase64InterceptOutput, isBase64InterceptInput, multirdp, logonPasswords, credman.  Changing them with a random caps, I ensured that Defender stopped swearing at them. <br>  But it can not be all so easy, Defender thought and worked on the functions that are imported and case sensitive.  These are functions that are called from the netapi32.dll library. <br><br><ul><li>  I_NetServerAuthenticate2 </li><li>  I_NetServerReqChallenge </li><li>  I_NetServerTrustPasswordsGet </li></ul><br>  If we take a look at netapi32.dll (C: \ windows \ system32 \ netapi32.dll), we will see that each function is assigned a number. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9d/a63/057/b9da6305790eca73f118bd026615e538.jpg" alt="image"><br><br>  Change the function call with the view <br>  windows.netapi32.I_NetServerTrustPasswordsGet (args) <br>  on <br>  windows.netapi32 [62] (args) <br>  For this we need to replace mimikatz \ lib \ x64 \ netapi32.min.lib.  Create a netapi32.def file and write the following lines there: <br><br><pre> <code class="plaintext hljs">LIBRARY netapi32.dll EXPORTS I_NetServerAuthenticate2 @ 59 I_NetServerReqChallenge @ 65 I_NetServerTrustPasswordsGet @ 62</code> </pre> <br>  Save and execute the command (don‚Äôt forget to backup the original netapi32.min.lib just in case) <br><br><pre> <code class="bash hljs">lib /DEF:netapi32.def /OUT:netapi32.min.lib</code> </pre> <br>  Once again we will rebuild the project and copy what we have done.  Defender is silent.  Run the resulting mimikatz as an administrator. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9d/de3/bf1/e9dde3bf1406d3def0d55dae31481157.jpg" alt="image"><br><br>  Success.  Thus, mimikatz was launched and Windows Defender did not work, which is what we wanted.  Passwords, turnout and hashes are issued. <br><br>  <b>Underwater rocks</b> <br><br>  Expectation: <br><br><pre> <code class="plaintext hljs">* Username : thunt * Domain : DESKTOP-JJRBJJA * Password : Xp3#2!^&amp;qrizc</code> </pre> <br>  Reality: <br><br><pre> <code class="plaintext hljs">* Username : thunt * Domain : DESKTOP-JJRBJJA * Password : (null)</code> </pre> <br>  The situation in life is somewhat different from laboratory conditions.  You may have to work with the registry to view the password.  For example, enable or create the UseLogonCredential key (HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ SecurityProviders \ WDigest).  But with this, problems may arise, since  When rebooting, keys can be set back. <br><br>  It may be even worse if in case of launch on one of the latest versions of Windows 10, instead of the password in plain-text you will see this: <br><br><pre> <code class="plaintext hljs">* Password : _TBAL_{68EDDCF5-0AEB-4C28-A770-AF5302ECA3C9}</code> </pre> <br>  It's all about the TBAL mechanism, which is the successor of Automatic Restart Sign-On ( <a href="https://docs.microsoft.com/ru-ru/windows-server/security/windows-authentication/winlogon-automatic-restart-sign-on-arso">ARSO</a> ).  Now, when a TBAL is requested, lsasrv checks if the account is a local or MS account, and based on this, it uses msv1_0 or cloudAP to save everything needed to resume the user's session.  After that, the autologon mechanism is set up with a password of _TBAL_ {68EDDCF5-0AEB-4C28-A770-AF5302ECA3C9}. <br><br>  Nevertheless, under laboratory conditions, we received a user password, and in a combat situation we can at least get hashes. </div><p>Source: <a href="https://habr.com/ru/post/454758/">https://habr.com/ru/post/454758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454748/index.html">MongoDB Survival Guide</a></li>
<li><a href="../45475/index.html">PostgreSQL horizontal scaling using PL / Proxy.</a></li>
<li><a href="../454750/index.html">Swift UI - at a gallop across Europe</a></li>
<li><a href="../454754/index.html">When is it worth testing the hypothesis of no less effectiveness?</a></li>
<li><a href="../454756/index.html">Checking the effectiveness of the site and advertising settings, the cost of attracting customers wholesale company</a></li>
<li><a href="../45476/index.html">My city.ru - a social network in an urban environment</a></li>
<li><a href="../454760/index.html">Intel Optane Memory M15 - faster than M10</a></li>
<li><a href="../454766/index.html">HBO, thank you for reminding me ... "Chernobyl first-aid kit" of a Belarusian pharmacist</a></li>
<li><a href="../45477/index.html">What kind of Internet startup students can come up with in one hour?</a></li>
<li><a href="../454770/index.html">Samsung Startup Membership - a new program for startups in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>