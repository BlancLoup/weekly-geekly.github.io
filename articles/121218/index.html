<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with KVM virtual machines. Virtual machine cloning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue a series of articles on virtualization based on KVM. In previous articles it was told about the toolkit , about setting up a host machine ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with KVM virtual machines. Virtual machine cloning</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/25b/b00/3ea/25bb003ea65a73f1b27de8b6f13d8459.jpg" alt="Clone" align="left"><br><br>  We continue a series of articles on virtualization based on KVM.  In previous articles it was told <a href="http://habrahabr.ru/blogs/virtualization/120432/">about the toolkit</a> , about setting up a host machine and <a href="http://habrahabr.ru/blogs/virtualization/120717/">creating a virtual machine</a> .  Today we will talk about creating an image of a virtual machine and its cloning. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The research of the question gave depressing results: the information on creating images of virtual machines on the network is very difficult to find, and the one that is, the quality and completeness is not different. <br><br>  To obtain an image of a virtual machine in a minimal system, it is enough to change just a couple of files in it to get a normally working system, but in the case of Debian there are some minor difficulties. <br><br>  To create a new virtual machine based on the existing system, you need to make the following changes: <br><br><ul><li>  change hostname </li><li>  fix the hosts file </li><li>  change DNS settings </li><li>  replace ssh host keys </li><li>  change root password </li></ul><br><br>  The <a href="http://libguestfs.org/">libguestfs</a> library turned out to be a great find for me - it allows you to manage disks and operate virtual machine files both interactively and according to a predefined script. <br><br>  This library was written by Richard Jones of the notorious Red Hat company.  It allows you to work with file systems (starting from ext2 and ending with NTFS in Windows, UFS in FreeBSD - in general, with all the file systems with which the kernel can work), system images, LVM partitions, in case of installing guest OS from the MS family Windows - edit the registry (via the hivex library).  In general, the utility is very feature rich and very flexible.  And most importantly - does not require administrative (root) rights to use it. <br><br><h4>  Explore the image </h4><br><br>  So let's get down to work. <br><br>  The main tool with which we will work with the image of the guest system is <b>guestfish</b> . <br><br>  Let's try to perform some operations online: <br><br> <code>$ guestfish <br> &gt;&lt;fs&gt; add-drive debian_5_i386.img <br> &gt;&lt;fs&gt; run <br> &gt;&lt;fs&gt; list-filesystems <br> /dev/vda1: ext3 <br> &gt;&lt;fs&gt; mount-vfs rw ext3 /dev/vda1 / <br> &gt;&lt;fs&gt; cat /etc/fstab <br> # /etc/fstab: static file system information. <br> # <br> # &lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt; <br> proc /proc proc defaults 0 0 <br> /dev/vda1 / ext3 errors=remount-ro 0 1 <br> /dev/hdc /media/cdrom0 udf,iso9660 user,noauto 0 0 <br></code> <br><br>  What is very cool - all the necessary operations can be performed in non-interactive mode (according to a pre-compiled script).  I will give an example of a script that edits the hosts, hostname and interfaces files in the system: <br><br> <code>$ guestfish &lt;&lt;EOF <br> add-drive debian_guest.img <br> run <br> mount-vfs rw ext3 /dev/vda1 / <br> upload -&lt;&lt;END /etc/hosts <br> 127.0.0.1 localhost.localdomain localhost debian_guest.local debian_guest <br> 10.10.10.100 debian_guest.local <br> END <br> upload -&lt;&lt;END /etc/resolv.conf <br> nameserver 8.8.8.8 <br> END <br> upload -&lt;&lt;END /etc/hostname <br> debian_guest.local <br> END <br> upload -&lt;&lt;END /etc/network/interfaces <br> auto lo <br> iface lo inet loopback <br> allow-hotplug eth0 <br> iface eth0 inet static <br> address 10.10.10.100 <br> gateway 10.10.10.10 <br> netmask 255.255.255.0 <br> network 10.10.10.0 <br> broadcast 10.10.10.255 <br> END <br> EOF <br></code> <br><br>  The use of <b>heredoc</b> was very convenient in this context. <br><br>  (By the way: if there are any questions about the library, the author himself responds very quickly to the IRC channel <b>#libguestfs</b> on irc.freenode.net. And indeed the guy is very interesting.) <br><br><h4>  Secure hell </h4><br><br>  As the name implies, I suffered for a long time with this question: in Debian / Ubuntu, there is simply no automatic key regeneration when they are deleted.  In other systems that I tried to use, this is all right, but for deb-based operating systems there are problems with this. <br><br>  I did this: <br><br> <code>$ guestfish <br> &gt;&lt;fs&gt; add-drive debian_guest.img <br> &gt;&lt;fs&gt; run <br> &gt;&lt;fs&gt; mount-vfs rw ext3 /dev/vda1 / <br> &gt;&lt;fs&gt; download /etc/init.d/ssh /home/username/debian_5_etc_init_ssh <br></code> <br><br>  Further, the following changes were made: <br><br> <code>--- /home/username/debian_5_etc_init_ssh 2012-12-21 00:00:00.000000000 +0000 <br> +++ /home/username/debian_5_etc_init_ssh_fixed 2012-12-21 00:00:00.000000000 +0000 <br> @@ -32,6 +32,10 @@ <br> ([ "$previous" ] &amp;&amp; [ "$runlevel" ]) || [ "$runlevel" = S ] <br> } <br> <br> +check_ssh_host_key() { <br> +    if [ ! -e /etc/ssh/ssh_host_key ] ; then <br> +        echo "Generating Hostkey..." <br> +         /usr/bin/ssh-keygen -t rsa1 -f /etc/ssh/ssh_host_key -N '' || return 1 <br> +    fi <br> +    if [ ! -e /etc/ssh/ssh_host_dsa_key ] ; then <br> +        echo "Generating DSA-Hostkey..." <br> +         /usr/bin/ssh-keygen -d -f /etc/ssh/ssh_host_dsa_key -N '' || return 1 <br> +     fi <br> +    if [ ! -e /etc/ssh/ssh_host_rsa_key ] ; then <br> +        echo "Generating RSA-Hostkey..." <br> +        /usr/bin/ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N '' || return 1 <br> +    fi <br> +} <br> + <br> check_for_no_start() { <br> # forget it if we're trying to start, and /etc/ssh/sshd_not_to_be_run exists <br> if [ -e /etc/ssh/sshd_not_to_be_run ]; then <br> @@ -75,6 +79,7 @@ <br> <br> case "$1" in <br> start) <br> +       check_ssh_host_key <br> check_privsep_dir <br> check_for_no_start <br> check_dev_null <br> @@ -106,6 +111,7 @@ <br> ;; <br> <br> restart) <br> +       check_ssh_host_key <br> check_privsep_dir <br> check_config <br> log_daemon_msg "Restarting OpenBSD Secure Shell server" "sshd" <br></code> <br><br>  <i>Attention, the patch is not working, it is given as an example of the necessary changes.</i> <br><br>  And for two versions of Debian / Ubuntu, I made a similar file with an already modified ssh file.  Then you can simply load it into a virtual machine. <br><br> <code>&gt;&lt;fs&gt; upload /home/username/debian_5_etc_init_ssh_fixed /etc/init.d/ssh</code> <br> <br>  Now delete the keys so that they are generated automatically: <br><br> <code>&gt;&lt;fs&gt; glob rm /etc/ssh_host_*_key*</code> <br> <br>  Deleting by mask does not work.  Since this method is not implemented in the API, the glob prefix allows you to expand the mask into a list of files. <br><br>  For FreeBSD and CentOS, it is enough just to delete the keys, they will be generated at startup. <br><br><h4>  User identification </h4><br><br>  First of all, it‚Äôs worthwhile to talk about how the storage of information about users in Linux / FreeBSD is presented.  It will be a bit boring, but necessary to understand what we are doing.  Although at a minimum there is enough information only about the shadow file. <br><br>  All necessary for user authentication is stored in the / etc / passwd and /etc/shadow (/etc/master.passwd in FreeBSD) files. <br><br>  Consider the structure of the / etc / passwd file <br><br> <code>root:x:0:0:root:/root:/bin/bash</code> <br> <br>  I will quote from the <a href="http://ru.wikipedia.org/wiki//etc/passwd">wiki</a> how to use the fields: <br><br><ul><li>  login name or login </li><li>  password hash (currently not used, password hidden in shadow is used) </li><li>  user ID </li><li>  default group id </li><li>  GECOS information field </li><li>  initial (it is home) directory </li><li>  registration shell </li></ul><br><br>  Consider the structure <b>/ etc / shadow</b> <br><br> <code>root:$1$APv1HQOB$HJQhYFq9JSnhusQ.1Ql10.:14977:0:99999:7:::</code> <br> <br>  Again <a href="http://ru.wikipedia.org/wiki//etc/passwd">from the wiki</a> : <br><br><ul><li>  Username </li><li>  password hash </li><li>  last password change date </li><li>  after how many days it will be possible to change the password </li><li>  after how many days the password will expire </li><li>  how many days before the password becomes obsolete, start reminding you to change the password </li><li>  How many days after the password becomes obsolete, block the user account </li><li>  the date on which the account is blocked </li><li>  reserved field </li></ul><br><br>  We need to change specifically the second field (password hash).  It can be divided into three parts: <br><br><ul><li>  1 - md5 encryption type, 2 - SHA512 (correct me if I'm wrong) </li><li>  APv1HQOB - salt through which the password is encrypted </li><li>  HJQhYFq9JSnhusQ.1Ql10.  - directly password hash with salt. </li></ul><br><br>  The hash is generated by the command: <br><br> <code>$ mkpasswd --method=md5 --salt="APv1HQOB" "$password" <br> $1$APv1HQOB$HJQhYFq9JSnhusQ.1Ql10.</code> <br> <br>  We need to substitute it in the / etc / shadow file. <br><br>  I wrote a small script that will generate a random password and an 8-character salt, output it, generate a hash and substitute it into the desired file: <br><br> <code>#!/bin/bash <br> tempfile=`mktemp` <br> shadow="/etc/shadow" <br> salt=`pwdgen` <br> passwd=`pwdgen` <br> hash=`pwhash $salt $password` <br> hash_esc=`escape_hash $hash ` <br> pwdgen() { <br> charspool=('a' 'b' 'c' 'd' 'e' 'f' 'g' 'h' 'i' 'j' 'k' 'l' 'm' 'n' 'o' 'p' 'q' 'r' 's' 't' 'u' 'v' 'w' 'x' 'y' 'z' '0' '1' '2' '3' '4' '5' '6' '7' '8' '9' '0' 'A' 'B' 'C' 'D' 'E' 'F' 'G' 'H' 'I' 'J' 'K' 'L' 'M' 'N' 'O' 'P' 'Q' 'R' 'S' 'T' 'U' 'V' 'W' 'X' 'Y' 'Z'); <br> len=${#charspool[*]} <br> for c in $(seq 8); do <br> echo -n ${charspool[$((RANDOM % len))]} <br> done <br> } <br> <br> pwhash(){ <br> salt=$1 <br> password=$2 <br> hash=`mkpasswd --method=md5 --salt=$salt $password` <br> echo $hash <br> } <br> <br> #  ,  sed       $ <br> escape_hash() { <br> echo $1 | sed -e 's/\//\\\//g' -e 's/\$/\\\$/g' <br> } <br> <br> guestfish &lt;&lt;EOF <br> add-drive debian_guest.img <br> run <br> mount-vfs rw ext3 /dev/vda1 / <br> download /etc/shadow $tempfile <br> ! sed 's/^root:[^:]\+:/root:$hash_esc:/' $tempfile &gt; $tempfile.new <br> upload $tempfile.new $shadow <br> EOF <br></code> <br><br>  As you probably noticed, we used an external command inside the script, in which we replaced the contents of the first section with the hash received in the script.  The external operator " <b>!</b> " <b>Is</b> used for this: it is very convenient when we need to do some small operations without interrupting the process of working with <b>guestfish</b> (since it takes some time to launch the <b>guestfish</b> ). <br><br><h4>  Preparing Master Image </h4><br><br>  Since the images need to be updated periodically (in case of important updates or errors in the image are corrected), we should prepare master images in which we will perform the necessary manipulations.  For deployment, we will prepare these images using a separate script. <br><br>  What we need to remove in our image: <br><br><ol><li>  Clear logs </li><li>  Remove traces of being in the system </li><li>  Remove downloaded packages (relevant for Debian and Ubuntu, only they are littering) </li><li>  Delete the file with the settings of the network card </li><li>  Delete keys. </li></ol><br><br>  After that we will need to reduce the size of the file system, reduce the partition and cut off the excess from the image. <br><br>  I will attach a small section of code that performs the first part of the required action: <br><br> <code>guestfish &lt;&lt;EOF <br> add-drive debian_guest.img <br> run <br> mount-vfs rw ext3 /dev/vda1 / <br> upload /home/username/debian_5_etc_init_ssh_fixed /etc/init.d/ssh <br> -glob rm /etc/ssh/ssh_host_* <br> -glob rm /etc/udev/rules.d/70-persistent-net.rules <br> -glob rm /root/* <br> -glob rm /root/.* <br> -glob rm /var/log/* <br> -glob rm /var/cache/apt/archives/*deb <br></code> <br>  EOF <br><br>  The "-" flag in front of the command means that we should not exit if any of the commands returns <b>-1</b> .  This was done on purpose so that the absence of any files does not interrupt the execution of the remaining commands;  thus, customization of this script for different distributions becomes unnecessary, although it is possible. <br><br>  And now we proceed to reducing the image: <br><br> <code>$ guestfish &lt;&lt;EOF <br> add-drive add-drive ${images}/${os}_${version}_${arch}.img <br> run <br> e2fsck-f /dev/vda1 <br> resize2fs-M /dev/vda1 <br> tune2fs /dev/vda1 | grep "Block count:" | sed -e 's/Block\ count:\ //g' -e 's/$/*4+2144/g' | bc &gt; /tmp/block_count <br> EOF <br> $ foo=`cat /tmp/block_count` <br> $ guestfish &lt;&lt;EOF <br> allocate debian_guest_minimal.img ${foo}k <br> EOF <br></code> <br><br>  The number <b>2144</b> is the size of the boot loader and partition table. <br><br>  Briefly, the essence of what was done is as follows: we shrink the file system to the minimum size, calculate how much it began to occupy (the minimum number of blocks), and multiply them by 4, since the block size is 4 kB, then create an image of the resulting value. <br><br>  After that, we will need to use the <b>virt-resize</b> utility from the <b>libguestfs toolkit</b> to transfer the resulting file system to a new, smaller image. <br><br> <code>$ virt-resize --shrink /dev/vda1 debian_guestl.img debian_guest_minimal.img</code> <br> <br>  You should immediately discuss the limitations of this method: this is applicable only to ext2-4 file systems, since resize2fs only works with them.  For something non-standard, you can easily finish the necessary functionality (although, as I mentioned <a href="http://habrahabr.ru/blogs/virtualization/120432/">earlier</a> , libguestfs is very difficult to build).  For a sample, you can view my <a href="http://git.annexia.org/%3Fp%3Dlibguestfs.git%3Ba%3Dcommitdiff%3Bh%3D4ffa2d6798f7a2bf0baec8e1084659cf6358bc31">patch to implement resize2fs-M</a> . <br><br>  Unfortunately, with FreeBSD everything is much more complicated, and so far there are no options for solving the problem with it except adding another disk to the virtual machine config and mounting it. <br><br>  Now we must, of course, optionally pack the resulting image with <b>xz</b> (this is a long time, but the result is worth it): <br><br> <code>$ xz -9 debian_guest.img <br> $ ls -lsha debian_guest.img.xz <br> 107M -rw-r--r-- 1 username username 107M Dec 21 00:00 debian_guest.img.xz <br></code> <br><br><h4>  Unfolding image </h4><br><br>  So, we got the virtual machine image, but the images are not ready-made working systems.  To get a working system, we need to perform several operations: <br><br><ol><li>  Allocate image to disk </li><li>  Copy bootloader and partition table </li><li>  Transfer information from the template to the virtual machine image </li><li>  Expand file system </li><li>  Change root password </li><li>  register network settings </li></ol><br><br>  For Linux, everything is <b>simple</b> : as part of <b>libguestfs,</b> there is a wonderful utility written in OCaml - <b>virt-resize</b> , items 2 through 4 are executed by it without problems. <br><br>  For a number of reasons, it is impossible to implement a resizing of a disk on <b>guestfish</b> (copying mbr into <b>guestfish is</b> impossible), therefore more functional means should be used. <br><br> <code>$ guestfish &lt;&lt;EOF <br> allocate debian_guest_clone.img 10G <br> EOF <br> $ virt-resize --expand /dev/vda1 debian_guest.img debian_guest_clone.img <br></code> <br><br>  Actually, this is all that is minimally required to know to implement the cloning of images of virtual machines. <br><br>  The next article will tell about the limitation of virtual machine resources. </div><p>Source: <a href="https://habr.com/ru/post/121218/">https://habr.com/ru/post/121218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121210/index.html">Anonymous networks and timing attacks: principles of building secure systems (conclusion)</a></li>
<li><a href="../121213/index.html">The effect of the second system</a></li>
<li><a href="../121214/index.html">Evernote for iOS has the opportunity to share notes on social networks and much more.</a></li>
<li><a href="../121215/index.html">What kind of web framework do you use when working with scala?</a></li>
<li><a href="../121216/index.html">Autoconfiguration of network interfaces in Debian GNU / Linux</a></li>
<li><a href="../121219/index.html">JavaScript Tutorial - on Github</a></li>
<li><a href="../121220/index.html">History of one virus</a></li>
<li><a href="../121222/index.html">Workshop Zend Framework. Part Two: Route and Registry</a></li>
<li><a href="../121223/index.html">Cancellation of registration</a></li>
<li><a href="../121225/index.html">A stack of directories. Again, a simple thing + add-ons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>