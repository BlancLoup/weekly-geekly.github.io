<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Runtime Magic: Changing the Objective-C Method on the Fly</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reading the Mac OS X 10.6 Reference Library, I experienced mixed emotions: so many new features, but if you use them, the programs will not run on Pow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Runtime Magic: Changing the Objective-C Method on the Fly</h1><div class="post__text post__text-html js-mediator-article">  Reading the Mac OS X 10.6 Reference Library, I experienced mixed emotions: so many new features, but if you use them, the programs will not run on PowerPC poppies, and besides, not everyone will want to install the Snow Leopard if Leo quite suits them.  The simplest solution seems to not use these features, but it means to limit yourself.  I don‚Äôt know about you, but I don‚Äôt like to be limited.  I want the program to use all the advantages of the Snow Leopard, but at the same time it could work on the previous version of Mac OS X. Is it possible? <br><a name="habracut"></a><br>  Maybe!  And with Objective-C you make it as transparent as possible.  Imagine (and this is only a small part) that using functions from the Objective-C Runtime Library (objc / runtime.h) you can add methods and variables to an object, replace implementations of methods, get and set the value of object variables from functions, and that's it. during the execution of the program!  With other (especially compiled) languages, you will not be able to achieve the same flexibility. <br><br><h4>  Version detection </h4><br>  Cocoa changes only with a change in the minor version of Mac OS X, and new versions of Cocoa are not backported and cannot be installed on older versions of Mac OS X. Given these facts, it is very easy to determine the functionality of Cocoa: you just need to know the version of the system.  Gestalt Manager lets you know almost everything about the system, but now we only need its version. <br><br> <code>SInt32 version; <br> <br> Gestalt(gestaltSystemVersionMinor, &amp;version); <br> <br> if (version &lt;= 5) { <br> // 10.5 <br> } <br> else { <br> // 10.6 and later <br> }</code> <br> <br><h4>  Register a new method </h4><br>  You can simply declare a method in a protocol or interface and refuse to implement it altogether!  Thus, neither this method nor its implementation exists at the time of program launch, and you can (and are obliged not to raise an exception when you receive the corresponding message) add it to the class during program execution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Use the <i>class_addMethod</i> function <i>(Class cls, SEL name, IMP imp, const char * types)</i> to register a new method and implement the <i>resolveInstanceMethod:</i> or <i>resolveClassMethod:</i> methods for class or instance methods.  These messages are sent to Cocoa before launching the message forwarding mechanism. <br><br> <code>+ (BOOL) resolveInstanceMethod: (SEL) aSEL { <br> <br> if (aSEL == @selector(null)) { <br> class_addMethod([self class], aSEL, (IMP) _null, "v@:"); <br> return YES; <br> } <br> else if (aSEL == @selector(isHidden)) { <br> class_addMethod([self class], aSEL, (IMP) _isHidden, "c@:"); <br> return YES; <br> } <br> else if (aSEL == @selector(setHidden:)) { <br> class_addMethod([self class], aSEL, (IMP) _setHidden, "v@:c"); <br> return YES; <br> } <br> <br> return [super resolveInstanceMethod: aSEL]; <br> }</code> <br> <br>  The most interesting thing about <i>class_addMethod</i> is the third argument - a pointer to a string with the type schema of the return value and the arguments of the function that implements the method.  Each base type corresponds to a string of characters, first the type of the return value is written, then the types of two required arguments: the <i>self</i> object and the selector <i>_cmd</i> , after the types of explicit parameters. <br><br>  Character code table: <br><br> <code>: : <br> <br> c char <br> i int <br> s short <br> l long, l  32   64-  <br> q long long <br> C unsigned char <br> I unsigned int <br> S unsigned short <br> L unsigned long <br> Q unsigned long long <br> f float <br> d double <br> B C++ bool  C99 _Bool <br> v void <br> *   (char *) <br> @  <br> #  (Class) <br> :  (SEL) <br> [array type]  <br> {name=type...}  (struct) <br> (name=type...)  (union) <br> b <i>num</i>    <i>num</i>  <br> ^ <i>type</i>   <i>type</i> <br> ?   (    )</code> <br> <br>  Much better, especially with redefined and complex types, use the <i>@encode ()</i> directive to create a string with a schema, for example: <br><br> <code>const char *types = [[NSString stringWithFormat: @"%s%s%s%s", @encode(void), @encode(id), @encode(SEL), @encode(BOOL)] UTF8String];</code> <br> <br>  How it works?  If you send a message to the object with a missing method, its selector is passed to <i>resolveInstanceMethod:</i> or <i>resolveClassMethod:</i> for the purpose of dynamic resolution.  If you want the object to be able to send this message, you need to return for its selector <i>NO</i> : <br><br> <code>if (aSEL == @selector(setHidden:)) { <br> class_addMethod([self class], aSEL, (IMP) _setHidden, "v@:c"); <br> return NO; <br> }</code> <br> <br>  This method is great if you just need to add a method, for example, if you want to write an existing method from Cocoa yourself.  In this case, you do not need to check the system version: just if the program was launched at 10.5, the method is missing on it, it will be registered, if it is launched at 10.6 and the method exists, then its selector will not be the argument of the <i>resolveInstanceMethod:</i> message and nothing will change. <br><br>  Everything would be fine, but, unfortunately, the implementation of all the features of system methods can be very difficult, and secondly, and most importantly, we simply may not know the private classes and structures used, or the methods and functions, respectively, in some cases this option. <br><br>  Moreover, if you need to use several implementations of one (not Cocoa) method depending on the conditions, then this is not very convenient: the message is sent with each selector, you need to create a string with a schema, independent implementations for the methods of the class and the instance.  Because of all this, the code is repeatedly duplicated and replete with if `s, which does not look very good and is even worse debugged.  In general, avoid obscure architecture. <br><br><h4>  We use several implementations of the method </h4><br>  To get away from these problems, we implement the <i>+ initialize</i> method, this message is sent to Cocoa only once to each class, and it is guaranteed to receive it before any other message, which is what we need.  We also use the <i>class_replaceMethod</i> function <i>(Class cls, SEL name, IMP imp, const char * types)</i> , it is somewhat safer, because, for example, if the method does not exist, then it will simply add it as <i>class_addMethod</i> , if the class has a method, it will replace its implementation as <i>method_setImplementation</i> and ignore the <i>types</i> string.  This means that we can write an empty method and use the following code: <br><br> <code>+ initialize { <br> <br> SInt32 version; <br> <br> Gestalt(gestaltSystemVersionMinor, &amp;version); <br> <br> const char *types = [[NSString stringWithFormat: @"%s%s%s", , @encode(BOOL), @encode(id), @encode(SEL)] UTF8String]; <br> <br> if (version &lt; 6) { <br> class_replaceMethod([self class], @selector(isHidden), (IMP) Legacy_HSFileSystemItem_IsHidden, types); <br> } <br> else { <br> class_replaceMethod([self class], @selector(isHidden), (IMP) HSFileSystemItem_isHidden, types); <br> } <br> } <br> <br> - (BOOL) isHidden { <br> <br> return NO; <br> }</code> <br> <br><h4>  Change the implementation of the method </h4><br>  Still, this is not the best way, because you need to write several functions and monitor their proper operation.  If you want, for example, to abandon support for Mac OS X 10.5, you will need to rewrite methods and do other non-creative crap.  In order not to do this, it is better to write methods with a calculation on the latest version of Cocoa, then write only one function used by the legacy system, and, if necessary, replace the implementation with it! <br><br>  In addition, in order not to write a type string, use the <i>class_getClassMethod (Class cls, SEL name)</i> , <i>class_getInstanceMethod (Class cls, SEL name)</i> and <i>method_setImplementation (Method m, IMP imp) functions.</i> <i>Method</i> is a pointer to the method structure. <br><br>  The final option: <br><br> <code>// HSFileSystemItem.m <br> <br> #import "HSFileSystemItem.h" <br> <br> #ifdef __HS_Legacy__ <br> <br> #import "HSFileSystemItem_Legacy.h" <br> #import &lt;CoreServices/CoreServices.h&gt; <br> <br> #endif // __HS_Legacy__ <br> <br> @implementation HSFileSystemItem <br> <br> #ifdef __HS_Legacy__ <br> <br> + initialize { <br> <br> SInt32 version; <br> <br> Gestalt(gestaltSystemVersionMinor, &amp;version); <br> <br> if (version &lt; 6) { <br> Method _isHidden_method = class_getInstanceMethod([self class], @selector(isHidden)); <br> method_setImplementation(_isHidden_method, (IMP) HSFileSystemItem_isHidden); <br> } <br> } <br> <br> #endif // __HS_Legacy__ <br> <br> - (BOOL) isHidden { <br> <br> id value = nil; <br> [_url getResourceValue: &amp;value forKey: NSURLIsHiddenKey error: nil]; <br> <br> return [value boolValue]; <br> } <br> <br> // Other <br> <br> @end</code> <br> <br>  But how to change the implementation in the category, if you do not know whether the class has <i>initialize</i> ?  <i>+ Load</i> methods come to the rescue, the class and each category can have its own implementation of this method and they will not be redefined or competed, great, isn't it? <br><br><h4>  Instance variables </h4><br>  Finally, everything, or not?  The unanswered question is how to get the instance variables in the function.  You can simply use setter, getter or KVC, or, if you are not looking for easy ways, <i>object_getInstanceVariable (id obj, const char * name, void ** outValue)</i> , <i>object_setInstanceVariable (id obj, const char * name, void * value),</i> <i>class_getInstanceVariable (Class cls, const char * name)</i> . <br><br>  The first two functions can get and set the value of an instance variable.  In addition, all three functions return <i>Ivar</i> , a pointer to a structure with information about an instance variable that can be cached.  If you need to get or set the value of variables several times, use <i>Ivar</i> with the <i>object_getIvar</i> functions <i>(id obj, Ivar ivar)</i> , <i>object_setIvar (id ob, Ivar ivar, id value)</i> . <br><br> <code>// HSFileSystemItem_Legacy.m <br> <br> #import &lt;ApplicationServices/ApplicationServices.h&gt; <br> #import &lt;CoreServices/CoreServices.h&gt; <br> #import &lt;objc/runtime.h&gt; <br> #import "HSFileSystemItem.h" <br> <br> static BOOL HSFileSystemItem_isHidden(id self, SEL _cmd) <br> { <br> NSURL *_url = nil; <br> object_getInstanceVariable(self, "_url", &amp;_url); <br> <br> LSItemInfoRecord itemInfo; <br> <br> // Get file`s item info <br> OSStatus err = LSCopyItemInfoForURL((CFURLRef) _url, kLSRequestAllFlags, &amp;itemInfo); <br> <br> if (err != noErr) { <br> NSLog(@"LSCopyItemInfoForURL: error getting item info for %@. The error returned was: %d", _url, err); <br> } <br> <br> return itemInfo.flags &amp; kLSItemInfoIsInvisible; <br> }</code> <br> <br>  or <br><br> <code>static BOOL HSFileSystemItem_isHidden(id self, SEL _cmd) <br> { <br> static Ivar _url_ivar = class_getInstanceVariable([self class], "_url"); <br> NSURL *_url = object_getIvar(self, _url_ivar); <br> <br> // Get file`s item info <br> OSStatus err = LSCopyItemInfoForURL((CFURLRef) _url, kLSRequestAllFlags, &amp;itemInfo); <br> <br> if (err != noErr) { <br> NSLog(@"LSCopyItemInfoForURL: error getting item info for %@. The error returned was: %d", _url, err); <br> } <br> <br> return itemInfo.flags &amp; kLSItemInfoIsInvisible; <br> }</code> <br> <br>  Do not use <i>object_getInstanceVariable</i> , <i>object_setInstanceVariable</i> , <i>object_getIvar</i> , <i>object_setIvar</i> , if you have instance variables - ordinary C types!  They assume that instance variables are pointers to objects.  The point is that the pointers, no matter what they indicate, have the same size: 32 or 64 bits.  If the size of the variable is different from the size of the pointer, then what you want will be copied at all.  Instead, you need to play around with the pointers: <br><br> <code>static Ivar _int_ivar = class_getInstanceVariable([self class], "_num"); <br> int *_num = (int *) ((uint8_t *) self + ivar_getOffset(ivar));</code> <br> <br>  Or you can use the <i>NSObject</i> category written by John Calsbeek, with it you can get an instance variable from any object (regardless of the programmer‚Äôs desire ;-)): <br><br> <code>@implementation NSObject (InstanceVariableForKey) <br> <br> - (void *) instanceVariableForKey: (NSString *) aKey { <br> if (aKey) { <br> Ivar ivar = object_getInstanceVariable(self, [aKey UTF8String], NULL); <br> if (ivar) { <br> return (void *)((char *)self + ivar_getOffset(ivar)); <br> } <br> } <br> return NULL; <br> } <br> <br> @end</code> <br> <br> <code>int _num = *(int *) [self instanceVariableForKey: "_num"];</code> <br> <br><h4>  Epilogue </h4><br>  Bonus: a variant allowing the method to determine its implementation in the first call (you have to be a pervert ;-)) <br><br> <code>- (BOOL) isHidden { <br> <br> SInt32 version; <br> <br> Gestalt(gestaltSystemVersionMinor, &amp;version); <br> <br> const char *types = [[NSString stringWithFormat: @"%s%s%s", , @encode(BOOL), @encode(id), @encode(SEL)] UTF8String]; <br> <br> if (version &lt; 6) { <br> class_replaceMethod([self class], _cmd, (IMP) HSFileSystemItem_Legacy_IsHidden, types); <br> } <br> else { <br> class_replaceMethod([self class], _cmd, (IMP) HSFileSystemItem_isHidden, types); <br> } <br> <br> return [self isHidden]; <br> }</code> <br> <br><h4>  Links </h4><br><br>  Key links: <br>  <a href="http://developer.apple.com/library/mac/">Gestalt_Manager / Reference / reference.html</a> <br>  <a href="http://developer.apple.com/library/mac/">ObjCRuntimeGuide / Introduction / Introduction.html</a> <br>  <a href="http://developer.apple.com/library/mac/">ObjCRuntimeRef / Reference / reference.html</a> <br>  <a href="http://developer.apple.com/library/mac/">NSObject_Class / Reference / Reference.html</a> <br><br>  References: <br>  <a href="http://cocoasamurai.blogspot.com/2010/01/understanding-objective-c-runtime.html">http://cocoasamurai.blogspot.com/2010/01/understanding-objective-c-runtime.html</a> <br>  <a href="http://mikeash.com/pyblog/friday-qa-2009-03-13-intro-to-the-objective-c-runtime.html">http://mikeash.com/pyblog/friday-qa-2009-03-13-intro-to-the-objective-c-runtime.html</a> <br>  <a href="http://stackoverflow.com/questions/1219081/object-getinstancevariable-works-for-float-int-bool-but-not-for-double">http://stackoverflow.com/questions/1219081/object-getinstancevariable-works-for-float-int-bool-but-not-for-double</a> </div><p>Source: <a href="https://habr.com/ru/post/110179/">https://habr.com/ru/post/110179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110174/index.html">My journey to the future</a></li>
<li><a href="../110175/index.html">Obtained root on the newly released Google Nexus S</a></li>
<li><a href="../110176/index.html">How to arrange a DoS attack on the database server in one line</a></li>
<li><a href="../110177/index.html">Sort array by O (N) on CUDA</a></li>
<li><a href="../110178/index.html">PHP 5.2.16 released and end of support for 5.2.x</a></li>
<li><a href="../110180/index.html">Posterous.com: new service - Posterous Groups</a></li>
<li><a href="../110182/index.html">Rambler-News for iPhone</a></li>
<li><a href="../110183/index.html">Opera Extensions - Let Everyone Know</a></li>
<li><a href="../110184/index.html">UJAM opens public alpha testing</a></li>
<li><a href="../110185/index.html">Writers wrote a letter to Medvedev against free licenses and other amendments to the Civil Code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>