<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Yahoo moved from Flash to HTML5 to video</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Adobe Flash was once the de facto standard in the world of web media, but over time the industry turned away from it for security and performance reas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Yahoo moved from Flash to HTML5 to video</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/2c4/ad7/ccb/2c4ad7ccbf8e4241a99ef11562fb2607.jpg"></p><br><p>  Adobe Flash was once the de facto standard in the world of web media, but over time the industry turned away from it for security and performance reasons.  Requiring users to install a plugin for video playback is also a bad practice.  As a result, we turn to HTML5 for the video. </p><br><p>  Development in the field of video playback on HTML5 is still <a href="https://developer.jwplayer.com/articles/html5-report/">in its infancy</a> , and browsers initially supported these features in the most primitive way.  Only recently has support been expanded to include adaptive streaming.  Adaptive streaming has two main advantages: </p><br><ul><li>  Adaptive Bitrate (ABR): The algorithm determines the user channel bandwidth, processor power, player size, etc.  in real time and adjusts the video settings. </li><li>  Resizable buffer size: a feature that allows us to control the time it takes to start playback. </li></ul><br><p>  These features allowed the video streaming industry to move from Flash to HTML5 and JavaScript. </p><br><p>  Our <a href="http://www.yahoo.com/">Yahoo</a> video player uses HTML5 in all modern browsers.  In this post, we describe our path to the realization of these opportunities, describe the problems we have encountered, and describe the opportunities that we see. <a name="habracut"></a></p><br><h2>  First steps towards HTML5 </h2><br><p>  We took the first steps towards HTML5 in October 2015, when we organized the <a href="https://yahooeng.tumblr.com/post/132155634066/under-the-hood-delivering-the-first-free-global">global live broadcast of the NFL game</a> for the first time.  For this event, we rolled out a "clean" HTML5-player on Safari.  It was based on native HTML5 support in the browser for <a href="http-live-streaming-19">HTTP Live Streaming (HLS)</a> .  As part of this event, we have developed special features to enable different types of render depending on the client‚Äôs browser (Flash support, device configuration, operating system, browser, etc.). </p><br><h2>  Architectural solutions </h2><br><p>  To achieve HTML5 support in all browsers, we needed to re-design the streaming in our player.  We faced a choice, and the decision could affect the entire Yahoo business and user experience. </p><br><p>  The first, and perhaps most important, point is which streaming protocol to support.  The choice was between HLS and <a href="http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm%3Fcsnumber%3D65274">DASH</a> , they both support HTTP streaming streaming.  However, in order to keep the stack simple enough, and the development is fast enough, we decided to support HLS.  For iOS, we would have to support HLS anyway, and as the standard evolves, at some point <a href="https://w3c.github.io/media-source/">Media Source Extensions (MSE)</a> can start working with HLS.  MSE is a recent development of the HTML5 standard that allows you to dynamically generate media streams for playback via <a href="https://dev.w3.org/html5/spec-author-view/video.html">tag</a> . </p><br><p>  The next question is to build by yourself, buy ready-made or use an open source HTML5 player.  Yahoo is not the only one who needs an HTML5 player.  There are also several open source projects.  To use them is to save time at the beginning.  However, analysis, including real-world testing by other players in the market, showed that existing players do not provide enough of the quality, performance and scalability that we expect from Yahoo Video Player. </p><br><p>  And finally, our existing video player, which supports Flash, was already mature and proven.  We needed to decide whether to port design and logic from Flash to JavaScript, or build and design a player from scratch.  We chose the latter.  This made it possible to achieve some architectural goals, including a level of extensibility that allowed DASH to be maintained at later stages.  This solution allowed us to avoid problems and shortcomings associated with the previous design. </p><br><p>  As you will see below, all these decisions have brought us many benefits. </p><br><h2>  Zoom into the future </h2><br><p>  Armed with these solutions, we began developing a player that would free us from Flash.  The project was given the code name "Zoom", this is the main enemy of the superhero Flash from the DC Comics universe. </p><br><p>  The media pipeline for HLS streaming looked like this: <br><img src="https://habrastorage.org/files/bd3/b4a/53f/bd3b4a53ff8e49459f109f6cb57540f8.png" alt="img"><br>  <em>Figure 1. Media pipeline for HTML5</em> </p><br><p>  The player acts as a demultiplexer for the incoming transport stream ( <a href="http://www.etsi.org/deliver/etsi_ts/101100_101199/101154/01.09.01_60/ts_101154v010901p.pdf">MPEG-TS</a> ).  It splits the stream into audio and video, which are then packaged in the fragmented <a href="http://www.iso.org/iso/catalogue_detail.htm%3Fcsnumber%3D68960">MP4</a> format, which is received by the MSE layer in the browser. </p><br><p>  When we designed the new HTML5 player, we had several goals.  It should be: </p><br><ul><li>  Modular: each component must be developed separately and tested independently </li><li>  Expandable: a new player must be able to support new features (for example, DASH) without having to redesign the player. </li><li>  Stateless: we can use components (like ABR) in different instances of the player on the same page or in the same application. </li></ul><br><p>  Figure 2 below shows the high-level architecture of the new HTML5 MSE player. </p><br><p><img src="https://habrastorage.org/files/6b6/4a7/b00/6b64a7b003d84c1db6f34a829cca45e6.png" alt="img"><br>  <em>Figure 2. Yahoo's HTML5 player architecture</em> </p><br><ul><li>  <em>Framework Services</em> provides common features such as the HTTP downloader (for downloading videos), Web Workers (for multithreading), and the channel bandwidth determiner. </li><li>  <em>Stream &amp; Media Services</em> includes services that process media at different stages of the pipeline.  This includes loading the transport stream, splitting the stream and packing to MP4, which will be played using MSE. </li><li>  <em>Streaming Controller</em> is the component that controls the streaming of video content.  It also communicates with the ABR engine to determine the desired bitrate. </li><li>  <em>Playback Controller</em> is responsible for playing videos using different modules.  It stores a state machine with different playback states.  It also provides an API for play, pause, rewind, and so on. </li></ul><br><h2>  Problems </h2><br><p>  First, we moved from a single framework (Adobe Flash), which provided the same environment in all browsers, to several frameworks (MSE, <a href="http://www.w3.org/TR/XMLHttpRequest/">XHR</a> , Web Workers, HTML5 Media Elements) on different platforms and browsers (Chrome, Firefox, IE, Edge , Safari, etc.), each of which added its own troubles to the system. </p><br><p>  The second problem was advertising.  Video playback was turned to HTML5, but most advertisers in the video world continued to use Flash.  Therefore, we had to find a way to show ads on Flash, and the video at the same time play through HTML5.  We made our player use several render components, each of which supported their own rendering technique (Flash, HTML5, etc.).  This allowed us to maintain optimal conditions for the user and not lose revenue. </p><br><p>  The third problem is how to improve user involvement, a key metric for successful video consumption.  We wanted users to get involved and interact with the video all the time, and that it didn‚Äôt require any action on their part, such as a click or additional page load.  At the same time, we did not want the pages to have consistent playback.  Therefore, we have included "playlists" in the first-class API in the video player itself.  Now we can set a curated list of videos that are highly context sensitive and personalized for a specific user. </p><br><p>  Figure 3 below shows the high-level architecture of the Yahoo video player. </p><br><p><img src="https://habrastorage.org/files/3a5/2df/fe8/3a52dffe8dff4cada8ba01e50c7445a2.png" alt="img"><br>  <em>Figure 3. Yahoo video player architecture</em> </p><br><ul><li>  <em>The controller</em> is responsible for switching the render components and provides access to various playback functions. </li><li>  <em>Ads Controller</em> manages and roars video ads. </li><li>  <em>Playlist Manager</em> manages video playlists and provides access to playlist functions. </li></ul><br><p>  Performance (rebuffering and startup time) is the main driver for user engagement.  Performance changes are always associated with obstacles. </p><br><p>  Audio / video demultiplexing and MP4 packaging are expensive for processor operations.  If you perform these operations in the main browser UI thread, this will affect the responsiveness of the user interface of the page and the player.  Fortunately, browsers have web workers that allow multi-threading, but using them means that you need to transfer messages between threads. </p><br><p> From our experience, in Firefox, using a worker for splitting the stream and MP4 packaging was 20% more efficient (compared to the version without a worker).  On the other hand, we found that the additional load associated with the transfer of messages between threads is particularly noticeable in IE and Edge, and this leads to an increase in re-buffering.  To solve these problems, we made the following changes: </p><br><ul><li>  Run handler units inside the workers </li><li>  Minimize messages between threads </li></ul><br><p>  Effective use of web workers for media transformation has given our player a performance advantage over other players.  This is a 10% -20% improvement for the processor and a 30% improvement in re-buffering. </p><br><h2>  Opportunities </h2><br><p>  Despite the fact that we faced a lot of problems, designing our player gave us the opportunity to add features that were not available in the past player. </p><br><p>  Since we added the ability to switch render components and advertise on Flash, and the content on HTML5, we were able to preload the video.  That is, we can start downloading the next video in the playlist even before it starts playing.  For example, when the ad is loaded and started to play, we can preload the content in the background.  The transition from advertising to video is obtained as in the TV. </p><br><p>  We also improved the algorithm that determines the bandwidth of the channel.  It was originally based solely on content download time.  We added to it the information received from the API, for example TTFB (Time To First Byte - time to the first byte). </p><br><p>  We also added a feature that allows you to switch the bitrate at the level of key frames.  This helped us respond better to unexpected changes in network conditions. </p><br><h2>  results </h2><br><p>  We started rolling out a new HTML5 player in Google Chrome, and over time, added support for other browsers.  Now the new player works in all modern browsers.  Figure 4 below shows the number of video plays, depending on the render component used.  Today we use HTML5-rendering for approximately 70% of the traffic.  This number will grow with the introduction of the player to other parts of the Yahoo network.  The most visible platform that does not support MSE is IE in Windows 7. Flash continues to be used there. </p><br><p><img src="https://habrastorage.org/files/d89/67c/893/d8967c8939f44744a4d0e629196e817e.png" alt="img"><br>  <em>Figure 4. Views and render method</em> </p><br><p>  As for such an important metric as a re-buffering indicator, the HTML5 player is approximately at the same level or slightly better than Flash (Fig. 5). </p><br><p><img src="https://habrastorage.org/files/e3a/86b/041/e3a86b04123347a3a92f91f4784cce90.png" alt="img"><br>  <em>Figure 5. Rebuffering Rate - Flash vs.</em>  <em>HTML5</em> </p><br><p>  HTML5 is better when it comes to starting time after the user has clicked on "PLAY".  Figure 6 shows the delay between clicking on ‚ÄúPLAY‚Äù and rendering the first frame of the video (Click To Play Latency) for Flash and for HTML5 players. </p><br><p><img src="https://habrastorage.org/files/0a0/229/94f/0a022994fe9a4768bcca3105b02c7f4e.png" alt="img"><br>  <em>Figure 6. Click To Play Latency - Flash vs.</em>  <em>HTML5</em> </p><br><p>  The advantages of the HTML5 player are clearly seen on these charts: faster loading, better performance, and so on. </p><br><h2>  What's next </h2><br><p>  Adaptive streaming on the Internet is developing rapidly.  The industry is focused on optimizing playback in the context of a single player, while at Yahoo we are also working on streaming optimization of several videos on one page.  We are also working to ensure that MSE-HTML5-players come to the mobile web world. </p><br><p>  Apple recently <a href="http://www.streamingmedia.com/Articles/News/Online-Video-News/HLS-Now-Supports-Fragmented-MP4-Making-it-Compatible-With-DASH-111796.aspx">announced support for</a> fragmented MP4 as a transport stream in HLS.  This solution fits well with our decision to work with HLS.  This gives us three advantages: </p><br><ul><li>  Simplify the player, as MP4 is natively compatible with MSE. </li><li>  Improved player performance due to avoiding expensive processor-related operations for splitting the stream and assembling into MP4. </li><li>  Reducing the amount of information transmitted and improving the quality and start time. </li></ul><br><p>  We continue to focus on improving modern streaming technologies on the Internet, and we are hiring new people!  Write letters to <a href="">amitnj@yahoo-inc.com</a> , and we will discuss career opportunities in our team. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311302/">https://habr.com/ru/post/311302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311292/index.html">RMM-systems: remote monitoring and corporate network management (with an example of quick implementation)</a></li>
<li><a href="../311294/index.html">Prototyping iOS animations with Framer</a></li>
<li><a href="../311296/index.html">8 myths about deduplication</a></li>
<li><a href="../311298/index.html">The book "Graphic Design. Basic concepts "</a></li>
<li><a href="../311300/index.html">Do you remember a wonderful moment?</a></li>
<li><a href="../311304/index.html">CSN-Ajax programming template</a></li>
<li><a href="../311306/index.html">We work in the cloud based on Hyper-V, Part 2: Deploying Exchange Server</a></li>
<li><a href="../311308/index.html">Dino Esposito: "Here, developers are more in demand, and their work is paid higher"</a></li>
<li><a href="../311310/index.html">Samsung Pay launched at its own risk in Russia - expert opinions</a></li>
<li><a href="../311312/index.html">Cellular radiation: dangerous?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>