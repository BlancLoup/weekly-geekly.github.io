<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect NetFlow cheaply and angrily</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR : The author has assembled a NetFlow / sFlow collector from GoFlow , Kafka , ClickHouse , Grafana and a crutch on Go. 


 Hello, I am an exploi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect NetFlow cheaply and angrily</h1><div class="post__text post__text-html js-mediator-article"><p>  <strong>TL; DR</strong> : The author has assembled a NetFlow / sFlow collector from <a href="https://github.com/cloudflare/goflow">GoFlow</a> , <a href="https://kafka.apache.org/">Kafka</a> , <a href="https://clickhouse.yandex/">ClickHouse</a> , <a href="https://grafana.com/">Grafana</a> and a crutch on Go. </p><a name="habracut"></a><br><p>  Hello, I am an exploiter and I love to know what is happening in the infrastructure.  And I also love to climb into someone else's business, and this time I climbed into the net. </p><br><p>  Suppose you have your network equipment and a bag of monoliths sticking to the Internet, microservices and microservices monoliths with their dependencies in the form of databases, caches and FTP servers.  And sometimes some of the inhabitants of this bag begin to misbehave on the net. </p><cut></cut><br><p>  Here are just some examples of such pranks: </p><br><ul><li>  backup outside the prescribed window in 40 streams; </li><li>  configuration errors sending the application in one DC to the cache of another DC; </li><li>  application questions in the next rack to the same cache ‚Äúgive me this half-megabyte object from the cache two hundred times a second. </li></ul><br><p>  SNMP counters from switch ports or VMs will only give an approximate picture of what is happening, but I want accuracy and speed of problem analysis.  The <a href="https://en.wikipedia.org/wiki/NetFlow">NetFlow</a> / <a href="https://en.wikipedia.org/wiki/IPFIX">IPFIX</a> and <a href="https://en.wikipedia.org/wiki/SFlow">sFlow</a> protocols come to the rescue, which generate rich traffic information directly from the network equipment.  It remains to put it somewhere and somehow process it. </p><br><p>  From the available NetFlow collectors, the following were considered: </p><br><ul><li>  flow-tools - did not like storage in files (for a long time to make samples, especially operative in the process of reacting to an incident) or MySQL (having a table there in billions of rows seems like a rather bleak idea); </li><li>  Elasticsearch + Logstash + Kibana is a very resource-intensive bundle, with up to 6 cores of an old 2.2 GHz CPU for receiving 5000 flows (flows) per second.  However, Kibana allows you to stick across any filters in the browser, which is valuable; </li><li>  <a href="https://github.com/VerizonDigital/vflow">vflow</a> - did not like the output format (JSON, which without modification cannot be added to the same Elasticsearch); </li><li>  box solutions - did not like either the high price or the small difference from the selected one. </li></ul><br><p>  A selected was described in the <a href="http://ripe75.ripe.net/wp-content/uploads/presentations/33-RIPE75-High-scale-network-monitoring-at-Cloudflare-4.pdf">presentation of Louis Poinsignon at RIPE 75</a> .  The general scheme of a simple collector is as follows: </p><br><p><img src="https://habrastorage.org/webt/4w/uu/yu/4wuuyuia-fb2zckehgxszy3ouwi.png"></p><br><p>  GoFlow parses NetFlow / sFlow packages and puts them into a local Kafka in protobuf format.  The self-written ‚Äúshovel‚Äù goflow2ch takes the messages out of Kafka and puts them in Clickhouse in batches for better performance.  The scheme does not address the issue of high availability at all, but for each component there are either standard or more or less simple external means of its provision. </p><br><p>  Tests have shown that the CPU cost of parsing and saving the same 5000 threads per second is about a quarter of the CPU core, and the disk space occupied is on average 11-14 bytes per slightly truncated stream. </p><br><p>  To display information, use either a Web UI for ClickHouse called <a href="https://tabix.io/">Tabix</a> , or a <a href="https://github.com/Vertamedia/clickhouse-grafana">plugin for Grafana</a> . </p><br><p>  Advantages of the scheme: </p><br><ul><li>  the ability to ask arbitrary questions about the state of the network using the SQL dialect; </li><li>  undemanding of resources and horizontal scalability.  Old / slow processors and magnetic hard disks will do; </li><li>  if necessary, a full-fledged data pipeline is collected for analyzing network events, including in real time using Kafka Streams, Flink or analogs; </li><li>  the ability to change the storage to an arbitrary minimum means. </li></ul><br><p>  Cons too decent: </p><br><ul><li>  to ask questions, you need to know well SQL and its ClickHouse dialect; there are no ready reports and graphs; </li><li>  Many new moving parts in the form of Kafka, Zookeeper and ClickHouse.  The first two are in Java, which can cause rejection for religious reasons.  For me personally, this was not a problem, since all this was somehow used in the organization; </li><li>  have to write code.  Either a ‚Äúshovel‚Äù transferring data from Kafka to ClickHouse, or an adapter for recording directly from GoFlow. </li></ul><br><p>  Features encountered: </p><br><ul><li>  It is necessary to adjust the rotation according to the size of the data in Kafka and ClickHouse, and then check that it really works.  In Kafka there is a limit on the size of the log partition, and in ClickHouse there is a partition with an arbitrary key.  A new partition every hour and the removal of unnecessary partitions every 10 minutes work well for operational monitoring and are made from a few lines of script; </li><li>  ‚ÄúShovel‚Äù benefits from the use of <a href="http://kafka.apache.org/documentation/">consumer groups</a> , allowing you to add more ‚Äúshovels‚Äù in order to scale and resiliency; </li><li>  Kafka allows you not to lose data when dropping ‚Äúshovels‚Äù or ClickHouse itself (for example, from a heavy query and / or incorrectly limited resources), but it is better, of course, to carefully configure the database; </li><li>  If you will be collecting sFlow, remember that some switches by default change the sampling rate of packets on the fly, and it is indicated for each flow. </li></ul><br><p>  As a result, a tool for monitoring the situation in the network, in real-time plus or minus, as well as in historical perspective, was obtained from open source components and blue electrical tape.  Despite his knee pads, he has already helped reduce the time to resolve several incidents at times. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/424321/">https://habr.com/ru/post/424321/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424309/index.html">DevCore: DevBoy software part</a></li>
<li><a href="../424311/index.html">Asynchronous business logic today</a></li>
<li><a href="../424313/index.html">EveryLang is a program that can do almost anything.</a></li>
<li><a href="../424315/index.html">New round of import substitution. Where to run and what to do?</a></li>
<li><a href="../424319/index.html">The structure of the online store. Part 2</a></li>
<li><a href="../424323/index.html">An example of working with the ICE method from a Google and Microsoft product manager</a></li>
<li><a href="../424325/index.html">Training Splunk - training center now in Russia</a></li>
<li><a href="../424327/index.html">Zuckerberg finances: How to "make friends" optical technology and biomedicine</a></li>
<li><a href="../424329/index.html">Take it and do it: how to pump in programming and development</a></li>
<li><a href="../424331/index.html">Kubernetes 1.12: a review of major innovations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>