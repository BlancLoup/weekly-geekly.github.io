<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fighting hardcodes with static C # analyzers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will tell you how we wrote our own code analyzers and use them to clean our .net codebase from the most acute / frequent jambs. The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fighting hardcodes with static C # analyzers</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will tell you how we wrote our own code analyzers and use them to clean our .net codebase from the most acute / frequent jambs.  The main message is to make it quite simple, do not be afraid to write your analyzers to deal with exactly your bugs.  Secondary message - try our analyzers and report the results.  I will not write a complete guide, there are quite a lot of them on the Internet, but a small overview that this is how and what problems I encountered, I hope, will be useful to you. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  In December 2016, I changed jobs and moved to a new company.  The new office was in the process of transition from ‚Äúa department and a half to a programmer on the knee is a small service for internal needs‚Äù in ‚ÄúAn IT company of 100 people is developing an ERP system for the needs of a group of companies and is preparing a product for external users‚Äù. <br><br>  Naturally, in the course of this transition, many knee-knee ‚Äúthings so accepted‚Äù things became serious and correspond to diverse best practices.  In particular, the company appeared a few months before my arrival, a full-fledged hierarchy of test environments, and the testing department steadily fought to match the test environments to the combat environment. <br><br>  The authors of the inherited architecture professed a microservice approach, the deadlines were tight, the percentage of juniors was large.  When deploying to a test environment, testers were faced with the fact that suddenly microservice A, deployed on a test environment, could cause microservice B directly on the prode.  We look at the code - and see - the microservice B URL is sewn inside the microservice code A. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the course of work, in addition to the problem of ‚Äúhardcoded reference to microservice‚Äù, other problems of the code were revealed.  Code-review check list all grew, swearing became all angrier.  It was necessary to have a solution that would reveal all the problems and prevent the occurrence of such situations in the future. <br><br><h2>  Static analyzers </h2><br>  The new C # compiler, Roslyn, is fully open source and includes support for pluggable static analyzers.  Analyzers can produce errors, warnings and hints, they work both during compilation and in real time in the IDE. <br><br>  Analyzers have access to <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">AST</a> (abstract syntax tree) and can subscribe to elements of a particular type, for example, numbers or strings, or method calls.  In its simplest form, it looks something like this: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzeLiteral</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SyntaxNodeAnalysisContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (syntaxNode <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> LiteralExpressionSyntax literal) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = literal.Token.ValueText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-string"><span class="hljs-string">"@"</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.Contains(<span class="hljs-string"><span class="hljs-string">"@"</span></span>)) { context.ReportDiagnostic( Diagnostic.Create(Rule, context.Node.GetLocation(), <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } }</code> </pre> <br>  (This is my very first attempt to write a parser for hard emails). <br><br>  You can walk up and down the tree and sideways, and there is no need to distinguish, say, a comment from a string literal ‚Äî the compiler parser does it all for us.  However, the syntax level may not be enough.  For example, <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guid = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-string"><span class="hljs-string">"..."</span></span>);</code> </pre> <br>  At the syntactic level, we cannot understand what type of constructor we are calling.  Most likely, this is System.Guid.  And what if not?  At the syntax tree level, this is simply a ‚Äúclass constructor with an identifier equal to‚Äú Guid ‚Äù.  For a more accurate diagnosis, we need to call the so-called semantic model and get information from it about which symbol corresponds to the element of the syntax tree. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnalyzeCtor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SyntaxNodeAnalysisContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Node.GetContainingClass().IsProbablyMigration()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Node <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ObjectCreationExpressionSyntax createNode) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = context.SemanticModel.GetTypeInfo(createNode).Type <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> INamedTypeSymbol; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guidType = context.SemanticModel.Compilation.GetTypeByMetadataName(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(System.Guid).FullName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Equals(type, guidType)) { .. } } }</code> </pre> <br>  The semantic model is intermediate compilation results.  Unlike syntax, it may be incomplete (I remind you that we are working in the context of the IDE, the programmer can write the class being analyzed right now).  So get ready, the methods of the semantic model are many and often return null. <br><br>  Analyzers are put into the project, as usual NuGet packages.  After recompilation, errors and warnings begin to appear.  We in the office made an internal NuGet package (in general, the entire assembly of everything goes through the packages), which puts the recommended combination of analyzers.  We also plan to add our specific office items there, and we can add not our packages there (for example, I added <a href="https://www.nuget.org/packages/AsyncFixer">AsyncFixer</a> , a very handy thing, I recommend it to everyone). <br><br>  This is how it looks in the editor. <br><br><img src="https://habrastorage.org/web/40a/d33/0fa/40ad330fa02f4d12b982d590a1b47be1.png"><br><br>  And so in the results of the compilation <br><br><img src="https://habrastorage.org/web/57b/8a7/f5e/57b8a7f5e24b411e8bc4be394d4b8c07.png"><br><br><h2>  What analyzers we made </h2><br><h3>  Shortened URL Analyzer </h3><br>  The most important analyzer for us.  Stupidly looking for all the literals with http, https, ftp, and so on.  The list of exceptions is quite large - mostly various auto-generated code, SOAP attributes, namespace and all that. <br><br><h3>  Hard VAT Rate Analyzer </h3><br>  Rarely, but aptly occurring problem in our code.  Sometimes the ‚Äúamount with VAT‚Äù is calculated from the ‚Äúamount without VAT‚Äù by multiplying by 1.18.  These are two problems at once.  First, the VAT rate may change, and to search all the places in the code is a big problem.  Secondly, the VAT rate is actually not a constant, but an attribute of a specific order - it can be with a VAT rate of 0% (carriers often have such legal entities), it can be transferred to another jurisdiction, and finally, when the VAT rate changes, it changes to new orders, and for old will be the same. <br>  Therefore, no hard VAT! <br><br>  The exceptions here are mainly the substring cut functions.  Sometimes there it makes sense to pass the hardcoded 18. You have to catch by the names of the parameters of the method. <br><br><h3>  Guid Buggy Analyzer </h3><br>  We often refer to the base id from the code (we have taken Guid).  This is bad.  Especially we suffer because of the status tables, which really would be just to make an enum (we get rid of them, but they exist).  So far, as an interim solution, we have agreed that the code can meet id, if they are the same in all environments (which means they are created by migrations) and if they are located directly in the code of the corresponding Entity (yes, we use Entity Framework 6 and are not shy). <br><br><h3>  What are our plans </h3><br>  - analyzer zharkozhenny email <br>  - analyzer, obliging to write controller methods asynchronous <br><br><h2>  Difficulties and strange moments </h2><br><h3>  Shared library </h3><br>  It was natural to divide the analyzers according to the principle 1 analyzer = 1 assembly = 1 nuget package.  The fact is that all analyzers we have written are very opinionated, and it is logical to provide the ability to connect / disconnect them one by one.  In the process of writing analyzers, I began to actively move the common code from the analyzers to the common library and a problem arose: if different versions of the analyzers are loaded into the studio, they cannot load different versions of the common library.  The easiest solution was to merge each analyzer with a common library into a single assembly at the build stage.  For this, I used <a href="https://github.com/gluck/il-repack">ILRepack</a> , which has a convenient binding for MSBuild (ILRepack.MSBuild.Task).  Unfortunately, the binding is a bit outdated, but this does not seem to be affected. <br><br>  Standard analyzer dependencies (Microsoft.CodeAnalysis. *) Do not need to be carried with you, and NuGet should not depend on them either.  Visual Studio itself will give us the necessary libraries. <br><br><h3>  Build with Appveyor </h3><br>  I'm used to setting up a continuous build of source code projects using Appveyor.  Collect and publish NuGet, he also knows how.  But analyzers are special magic.  In particular, in terms of the directory structure inside the package, everything is special there, you need to decompose into the analyzers folder instead of the standard lib.  I <a href="https://stackoverflow.com/search%3Fq%3Duser%253A408666%2B%255Bappveyor%255D">suffered a</a> little and came to a solution - in csproj, as this assembly, the call Nuget.exe is registered, which we carry with us in the package.  Ugly, as it seems to me, but I did not find a more beautiful solution. <br><br><h3>  Writing unit tests </h3><br>  Unit tests for analyzers are super cool and convenient.  I used the standard MS wrapper for the unit tests of the analyzer, any false positives were immediately drawn up by the unit tests.  Cool!  Much nicer than messing with fuzzy human TK. <br><br><h3>  Switch to .netstandard </h3><br>  I haven't been able to switch to .netstandart yet.  The attempt failed right away; the official template still generates the portable class of the library.  We are waiting for the updated template and try to make it.  <a href="https://github.com/dotnet/roslyn/issues/18414">https://github.com/dotnet/roslyn/issues/18414</a> <br><br><h2>  Conclusion </h2><br>  I would be happy to kick about my approach.  The source can be <a href="https://github.com/leotsarev/hardcode-analyzer">found here</a> . <br><br>  I would also be happy if someone advises good open source C # projects on which to check analyzers, or checks them on their own (maybe not even open source ones) and reports bugs. <br><br>  I would really like links to other useful analyzers, preferably not duplicating Resharper functionality. </div><p>Source: <a href="https://habr.com/ru/post/335792/">https://habr.com/ru/post/335792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335782/index.html">3 controversial ideas of the support manager</a></li>
<li><a href="../335784/index.html">The last frontier: how the second line of technical support in retail works</a></li>
<li><a href="../335786/index.html">Kaggle: Amazon's Terrain Analysis from Satellite Images</a></li>
<li><a href="../335788/index.html">XBRL: just about the complex - Chapter 6. Immersion in the XBRL - Part 2. Improving the result</a></li>
<li><a href="../335790/index.html">10 free and cool fonts</a></li>
<li><a href="../335794/index.html">The return of Locky and Mamba: users are attacking new versions of encryption viruses</a></li>
<li><a href="../335796/index.html">Baruch Sadogursky, JFrog: Developer Advocate, Java 9 and Kotlin's world domination (but you better look at Groovy)</a></li>
<li><a href="../335798/index.html">What a job scheduler can do in Postgres Pro</a></li>
<li><a href="../335800/index.html">The Great Silk Road: from tablets from China to a nanny-robot from Moscow region</a></li>
<li><a href="../335804/index.html">Random forest vs neural network: who will better cope with the task of recognizing gender in speech (part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>