<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cluster that is always with you</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wanted strange. 
 First, pile up a bunch of virtual machines directly to your laptop. 
 And secondly, to smoke one virtualization inside another. 

 W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cluster that is always with you</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/8f2/f13/e13/8f2f13e138afa4faa0097f967bae650d.png" alt="lxc">  Wanted strange. <br>  First, pile up a bunch of virtual machines directly to your laptop. <br>  And secondly, to smoke one virtualization inside another. <br><br>  We will talk about the use of <b>containers LXC</b> , and inside another virtual machine. <br><br><a name="habracut"></a><br><br clear="all"><h2>  WTF!  Why the hell is it necessary? </h2><br>  First of all, to experiment with various tools: <ul><li>  Distributed databases, file systems, parallel computing, etc. </li><li>  Infrastructure management systems (such as Chef, Puppet, Fabric, etc.) </li><li>  Testing and assembly in different environments </li><li>  Your option (write in the comments) </li></ul><br>  In this case, I want to have access to this laboratory always, regardless of the availability of the Internet.  Well, why not smoke some Hadoop somewhere on the road?  :-) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I think this post will be useful both for those who have Windows or Mac OS X on the desktop, and those who have Linux (the LXC part). <br><br><br><h2>  Task </h2><br>  Run on an average laptop 10-20 virtual machines that <br>  - can go to the Internet (via NAT) <br>  - see each other and the host computer (that is, our laptop) <br>  - accessible from the host computer (that is, you can access any of these virtual machines via ssh) <br><br><br><h2>  Decision </h2><br><ol><li>  On a computer (with Windows or Mac OS X) run VirtualBox </li><li>  Install Linux on it </li><li>  Inside Linux, make a bunch of LXC containers with independent Linux </li></ol><br>  Actually, this could put an end. <br>  Below is just a step-by-step cheat sheet (Ubuntu was used) how to set it all up quickly. <br><br><hr><br><h2>  1. Install VirtualBox and system on a virtual machine </h2><br>  There is nothing special to describe here. <br>  After installing the system - do not forget to put Guest Additions. <br><br><br><h2>  2. Configure network interfaces in VirtualBox </h2><br>  A virtual machine should have two network interfaces: <ul><li>  NAT connection type (it is created by default).  Through it, our virtual machines will be able to go to the Internet (for example, to download packages). </li><li>  The type of connection is Host-only networking (in Russian it is called ‚ÄúVirtual Host Adapter‚Äù). </li></ul>  In order to add a Host-only interface, first go to the general Virtualbox settings and add the Host-only adapter on the host machine.  Then we add the second interface to the virtual machine configuration. <br><br>  Important!  You must enable "Promiscuous mode" on the Host-only interface.  This will allow the containers to see the host machine and each other. <br><br><img alt="Virtual box - Promiscuous mode" src="https://habrastorage.org/storage1/75e47e52/7cfb5e21/534b28ec/c143e172.png"><br><br><br><h2>  3. Configure network interfaces </h2><br>  In the guest system, you need to configure bridge interfaces.  We will need them to operate the network in containers.  To do this, you must install the <b>bridge-utils</b> package ( <code># apt-get install bridge-utils</code> ) and make changes to the <b>/ etc / network / interfaces</b> file (see man bridge-utils-interfaces). <br>  You should have something similar: <table><tbody><tr><th>  It was </th><th>  It became </th></tr><tr><td><pre>  auto eth0
 iface eth0 inet dhcp
</pre></td><td><pre>  auto br0
 iface br0 inet dhcp
     bridge_ports eth0
     bridge_fd 0

 auto br1
 iface br1 inet static
     address 192.168.56.2
     netmask 255.255.255.0
     bridge_ports eth1
     bridge_fd 0 </pre></td></tr></tbody></table>  Let the IP address on br0 (eth0) be assigned by VirtualBox itself via DHCP, we don‚Äôt need to know this address.  And on br1 (eth1) we will assign the IP address with our hands - this is more convenient, then we will go to it via ssh from the host machine. <br><br>  We restart the virtual machine to make sure that both interfaces inside the virtual machine go up, the virtual machine itself is available at 192.168.56.2 (via the Host-only interface) and the Internet is accessible inside it (via the NAT interface). <br><br><br><h2>  4. Mount the cgroup file system </h2><br>  LXC containers require the cgroup utility file system.  The mount point is not important - you can mount anywhere. <br><br>  Add a line to <b>/ etc / fstab</b> : <br><pre> <code class="bash hljs">cgroup /var/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/cgroup cgroup defaults 0 0</code> </pre> <br>  and mount <pre> <code class="bash hljs">mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/cgroup mount cgroup</code> </pre><table><tbody><tr><td>  <i>In Ubuntu 11.10 (oneiric), <b>cgroup</b> need not be mounted.</i>  <i>The <b>lxc</b> package depends on the <b>cgroup-lite</b> package, which mounts the <b>cgroup</b> in <b>/ sys / fs / cgroup /</b></i> </td></tr></tbody></table><br><h2>  5. Install packages for working with LXC </h2><br><pre> <code class="bash hljs">apt-get install lxc apt-get install debootstrap</code> </pre> <br>  The <b>lxc</b> package contains management utilities and scripts for creating containers.  The <b>debootstrap</b> package is a utility that downloads the right packages and deploys the minimal basic system (ubuntu or debian).  In addition, there is the <b>febootstrap</b> package - it downloads and deploys Fedora. <table><tbody><tr><td>  <i>The fastest way to learn <b>lxc</b> : type <code>lxc-</code> and press " <b>Tab</b> " twice</i> </td></tr></tbody></table><br><h2>  6. Create the first LXC container </h2><br>  In the <b>/ usr / lib / lxc / templates / directory</b> there are files like <code>lxc-debian</code> , <b>lxc-natty</b> , <code>lxc-oneiric</code> , <code>lxc-fedora</code> , etc.  These are the so-called "templates".  In fact, these are scripts that create an appropriate working environment. <br><br>  Create a container (with Ubuntu 11.04) <br><pre> <code class="bash hljs">lxc-create -n node01 -t natty</code> </pre> <br>  Our container will appear in the <b>/ var / lib / lxc / node01 / directory</b> . <br>  In the created environment, the <b>root</b> user has the <b>root</b> password.  Do not forget to change! <table><tbody><tr><td>  <i>In Ubuntu 11.10 (oneiric) the <b>lxc</b> package <b>is</b> fresher: you can pass parameters to the " <b>ubuntu</b> " pattern, including the desired version of the distribution.</i>  <i>To find out which parameters a template accepts, run <b>lxc-create --template ubuntu --help</b></i> </td></tr></tbody></table><br><h2>  7. Configure the network in the container </h2><br><h3>  7.1.  Network interfaces </h3><br>  There are not enough network parameters in the container configuration file - they need to be added manually.  Then you can use the template config or simply clone the container. <br><br>  Open the file <pre> <code class="bash hljs">vi /var/lib/lxc/node01/config</code> </pre> <br>  and add such lines (we put the necessary MAC-and IP-addresses): <pre> <code class="hljs django"><span class="xml"><span class="xml">lxc.network.type = veth lxc.network.flags = up lxc.network.link = br0 </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span><span class="xml"><span class="hljs-tag">    </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.name</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">eth0</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag">     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.hwaddr</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">ac:de:48:00:00:01</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.ipv4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">10.0.2.101/24</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.type</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">veth</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.flags</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">up</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.link</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">br1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.name</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">eth1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.hwaddr</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">ac:de:48:00:ff:01</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lxc.network.ipv4</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">192.168.56.101/24</span></span></span></span></span></span></code> </pre><br>  Here <code>10.0.2.101/24</code> is a network that is commonly used for NAT interfaces in VirtualBox.  Through this interface the container will go online. <br>  <code>192.168.56.101/24</code> - this is our Host-Only network.  Through this interface, the container will communicate with the local network and other containers. <br><br>  I recommend setting the MAC address and IP address manually.  This is not necessary, but convenient.  For example, when you need to listen to network traffic.  I put the same last digit in all the numbers (node0 <u>1</u> - 10.0.2.10 <u>1</u> - ac: de: 48: 00: 00: 0 <u>1</u> ). <br><br>  Note that the configuration file <b>/ etc / network / interfaces</b> inside the container does not need to be touched.  Interfaces are enough to configure outside. <br><br><br><h3>  7.2.  DNS in the container </h3><br>  Add something meaningful to /etc/resolv.conf to make the DNS work: <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"nameserver 8.8.8.8"</span></span> &gt; /var/lib/lxc/node01/rootfs/etc/resolv.conf</code> </pre>  For local address resolution you can do <b>/ etc / hosts</b> .  The <b>/ etc / hosts file</b> can be made common to all containers if mounted with the <b>bind</b> option. <br><br><br><h2>  8. Run and check the container. </h2><br>  We start the container <pre> <code class="hljs pgsql">lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-comment"><span class="hljs-comment">--logfile /tmp/lxc-node01.log --logpriority DEBUG --name node01</span></span></code> </pre> <br>  We go (root / root) and check that the network is accessible in all directions. <br><table><tbody><tr><td>  <i>To run the container in the background, add the key " <b>--daemon</b> "</i> </td></tr></tbody></table><br><h2>  9. Clone containers </h2><br>  To clone containers, just copy it all. <pre> <code class="bash hljs">cp -a node01 node02</code> </pre> <br>  and fix the configuration files (paths, MAC- and IP-addresses): <pre> <code class="bash hljs">vi node02/config vi node02/fstab vi node02/rootfs/etc/hostname</code> </pre> <table><tbody><tr><td>  <i>Starting with version <b>lxc 0.7.5</b> , the utility <b>lxc-clone has appeared</b> .</i>  <i>It corrects the paths and hostname correctly, but you still need to edit the IP addresses with your hands.</i> </td></tr></tbody></table><br><h2>  10. Autorun containers </h2><br>  The <b>lxc</b> package includes the <b>/etc/init.d/lxc</b> script, which launches certain containers at system startup.  In the <b>/ etc / default / lxc file,</b> you need to list which containers to run.  This script expects container configuration files to be in <b>/ etc / lxc</b> and have the extension <b>* .conf</b> . <br>  I just did some symlinks: <pre> <code class="bash hljs">/var/lib/lxc/nodeXX/config -&gt; /etc/lxc/nodeXX.conf</code> </pre> <br><br><h2>  11. How else can you refine this kitchen </h2><br><ul><li>  Write scripts that automate the routine for creating containers (template configuration, setting IP addresses, creating users, configuring ssh using keys, etc.) </li><li>  Install apt-cacher-ng proxy to not download the same packages several times. </li><li>  Mount directories and files (using the bind option) so that some files are shared </li><li>  Put the containers under the control of <a href="http://libvirt.org/drvlxc.html">libvirt</a> (I have not tried. Perhaps this is a topic for a separate note) </li><li>  Try aufs to run ‚Äúoverlay‚Äù containers, when unchangeable files can be common to all containers (as well as the lxc-start-ephemeral utility). </li></ul></div><p>Source: <a href="https://habr.com/ru/post/130522/">https://habr.com/ru/post/130522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130515/index.html">When trigger replication is preferable to PostgreSQL built-in</a></li>
<li><a href="../130516/index.html">UnityCar - cars with physics for Unity3D</a></li>
<li><a href="../130518/index.html">Odnoklassniki office</a></li>
<li><a href="../130519/index.html">6 student tips</a></li>
<li><a href="../130520/index.html">Git 1.7.7</a></li>
<li><a href="../130524/index.html">And which applications on android phone do you use?</a></li>
<li><a href="../130526/index.html">Adobe Flash Player and Streaming without Server, Part 1: Peering Broadcasting</a></li>
<li><a href="../130527/index.html">We struggle with a color rendition of photos on the Internet</a></li>
<li><a href="../130529/index.html">Everytell - own contextual advertising system</a></li>
<li><a href="../130530/index.html">Simple real-time communication with the visitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>