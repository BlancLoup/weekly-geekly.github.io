<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We attach the Web Map service to the unsuspecting OpenSource database.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time, we constructed a spatial index, and now we‚Äôll just use this skill to make a live (non-static) map service with a web interface and performa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We attach the Web Map service to the unsuspecting OpenSource database.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c4b/654/2eb/c4b6542eb74b8ab895f522eec5acf692.png" alt="image"><br>  Last <a href="http://habrahabr.ru/post/196682/">time,</a> we constructed a spatial index, and now we‚Äôll just use this skill to make a live (non-static) map service with a web interface and performance of, say, a million queries per day on a completely ordinary hardware. <br><a name="habracut"></a><br><h4>  <b>The data</b> . </h4><br><ul><li>  Their source will be <a href="http://www.openstreetmap.org/">OSM.</a> </li><li>  The format for storing data in the DBMS is serialization from <a href="http://ru.wikipedia.org/wiki/Shapefile">shpfile.</a> </li><li>  We'll use <a href="http://gis-lab.info/qa/osmshp.html">dataset of</a> Russia as test data. </li><li>  From all layers we take only three - reservoirs, forests and buildings (water-polygon, vegetation-polygon, building-polygon).  This will be enough to confirm the performance of the technology and evaluate its performance. </li></ul><br><h4>  <b>Filling data</b> . </h4><br><ul><li>  As a DBMS, we will continue to use ready-made <a href="http://virtuoso.openlinksw.com/dataspace/doc/dav/wiki/Main/VOSDownload">Virtuoso V7.0.0</a> </li><li>  Create a table of the same name for each layer of interest. </li><li>  The field of type long varbinary with geometry will be called ‚ÄúShape‚Äù </li><li>  All existing fields will remain </li><li>  Add new ones <br><ul><li>  _OBJECTID_ - record number </li><li>  minx_, miny_, maxx_, maxy_ - record extent </li></ul></li><li>  Create a spatial index in the same way as we <a href="http://habrahabr.ru/post/196682/">did</a> before. </li><li>  The difference is that we now have areal, and not point objects, so one object can be indexed several times. </li><li>  We will do the rasterization of the most primitive - in the index gets the entire extent of the object, regardless of its geometry.  But the real rasterization is considered to be a premature optimization. </li><li>  Another difference is in the uneven population of the map: thanks to Chukotka, the longitude varies from -180 to +180 degrees, and the latitude from ~ 40 to 80. Therefore, we will make the block index step such that on average one object falls into one index block.  Why it is so will be discussed later. </li><li>  To work with the source data we will use the open library <a href="http://shapelib.maptools.org/">Shapefile C Library</a> </li><li>  To work with BLOBs, you will have to add <i>SHPSerializeObject</i> and <i>SHPDeserializeObject</i> functions to it, similar to the native <i>SHPWriteObject</i> and <i>SHPReadObject</i> , but for working with memory </li><li>  To communicate with the server, we will use the native ODBC interface, but using the built-in driver, bypassing the system driver manager </li><li>  For speed, turn off autocommit connections and we will commit ourselves every 1000 objects </li><li>  In this mode <ul><li>  Filling forests (~ 660 thousand objects) takes 1 min 56 seconds </li><li>  fill reservoirs (~ 380 thousand objects) - 1 min 9 seconds </li><li>  building fill (~ 5.3 million objects) - 16 min 18 seconds </li></ul></li></ul><br><h4>  <b>Performance evaluation of the web interface</b> . </h4><br><ul><li>  Yes, virtuoso has a web interface that looks like php.  The vsp files (virtuoso server pages) with inserts on PL / SQL turn into stored procedures that form the html output. <br>  We will create a simple page (test.vsp), which will only increase the counter and use it to check the rate of fire of the server. <br><pre><code class="php hljs">&lt;html&gt;&lt;body&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cnt integer; cnt := sequence_next (<span class="hljs-string"><span class="hljs-string">'xxx.YYY.__cnt'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;table width=<span class="hljs-string"><span class="hljs-string">"100%"</span></span> border=<span class="hljs-string"><span class="hljs-string">"1"</span></span>&gt; &lt;tr&gt;&lt;td align=<span class="hljs-string"><span class="hljs-string">"center"</span></span>&gt;<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp= cnt <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>&lt;/td&gt;&lt;/tr&gt; &lt;/table&gt; &lt;/body&gt;&lt;/html&gt;</code> </pre>  The built-in function <i>sequence_next</i> atomically increments the counter and returns its value. </li><li>  To execute this page, we will put it in the test folder in the root ( <i>ServerRoot</i> parameter of the <i>[HTTPServer]</i> section of the <i>virtuoso.ini</i> file) and allow execution of files from this folder via isql (isql localhost: 1111 dba dba) <pre> <code class="sql hljs">VHOST_DEFINE(lpath=&gt;'/test/',ppath=&gt;'/test/',vsp_user=&gt;'DBA');</code> </pre></li><li>  Check that the page works through <br> <code><a href="http://localhost/"></a> localhost:8890/test/test.vsp</code> <br> </li><li>  And we will massively demand it using <a href="http://ru.wikipedia.org/wiki/Wget">wget</a> </li><li>  The work of 20 parallel wget-s, each of which requested the mentioned page 10,000 times, took 28 seconds on the desktop under windows (i7, 8 cores).  Consequently, the required performance of ~ 7000 requests per second and for us it is in no way (given that we aimed at a million requests per day) can not be a bottleneck. </li></ul><br><h4>  <b>Draw a map</b> </h4><br><ul><li>  First, how do we get the data?  Like that: <pre> <code class="sql hljs"> for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xxx.YYY.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_water-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { ... }</code> </pre>  We will deal with this query in more detail. <ul><li>  <code>xxx.YYY."water-polygon"</code> is a table of reservoirs that we have just created and filled with data. </li><li>  <code>xxx.YYY."v_water-polygon_spx_enum_items_in_box"</code> is a procedural view on top of an auxiliary table that serves as a block spatial index.  In fact, this is a coarse spatial filter that works up to the size of a spatial index block. </li><li>  <code>a.minx = cminx and...</code> - we set the call parameters for view, <i>cminx ...</i> - borders of the map fragment that we want to draw </li><li>  <code>x."_OBJECTID_" = a.oid</code> - join between the data table and the synthetic resultset obtained from the procedural view </li><li>  <code>x.maxx_ &gt;= cminx and x.minx_ &lt;= cmaxx ...</code> intermediate spatial filter that allows you not to crawl behind blobs with geometries, if they are certainly not useful </li><li>  All together, this gives us the opportunity in the body of the cycle to engage in, for example, drawing with good efficiency.  At the same time, the drawing itself can be considered as a thin spatial filter. </li></ul></li><li>  Once we have three layers of data, we will have to execute three subqueries for each client request. </li><li>  Now about the schedule.  In order to draw directly in the process of the cursor, you have to write <a href="http://docs.openlinksw.com/virtuoso/cinterface.html">C - plugin</a> .  It is a dynamic library that the server loads at startup and gives you the opportunity to register new built-in functions PL / SQL. </li><li>  Actually for drawing we will use the library <a href="http://en.wikipedia.org/wiki/GD_Graphics_Library">GD</a> </li><li>  Add the following functions: <ul><li>  img_create - creates a context for drawing a given size </li><li>  img_tostr - make gif from the current context </li><li>  img_fromptr - magic virtuoso for changing the pointer tag </li><li>  img_destroy - destroy context </li><li>  img_alloc_color - make the color identifier from RGB values </li><li>  img_draw_polyline - draw a polyline from a blob where the shape object is saved </li><li>  img_draw_polygone - the same for the polygon </li></ul></li><li><div class="spoiler">  <b class="spoiler_title">Content part of the plugin under the spoiler</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _USRDLL #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"plugin.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"import_gate_virtuoso.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> wi_inst (wi_instance_get()[0]) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;libutil.h&gt; #include "sqlnode.h" #include "sqlbif.h" #include "wi.h" #include "Dk.h" #endif #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;math.h&gt; #include "gd_utils.h" #include "gd/gd_lib.h" #include "shplib/shapefil.h" typedef struct img_ctx_s { int dx_; int dy_; double minx_; double miny_; double maxx_; double maxy_; double mulx_; double muly_; int black_; int red_; int green_; int blue_; int attr_; gdImagePtr img_; } img_ctx_t; caddr_t img_create_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)dk_alloc_box (sizeof (img_ctx_t), DV_STRING); ptr-&gt;dx_ = bif_long_arg (qst, args, 0, "img_create_proc"); ptr-&gt;dy_ = bif_long_arg (qst, args, 1, "img_create_proc"); ptr-&gt;minx_ = bif_double_arg (qst, args, 2, "img_create_proc"); ptr-&gt;miny_ = bif_double_arg (qst, args, 3, "img_create_proc"); ptr-&gt;maxx_ = bif_double_arg (qst, args, 4, "img_create_proc"); ptr-&gt;maxy_ = bif_double_arg (qst, args, 5, "img_create_proc"); ptr-&gt;attr_ = bif_long_arg (qst, args, 6, "img_create_proc"); ptr-&gt;img_ = gdImageCreateTrueColor (ptr-&gt;dx_, ptr-&gt;dy_); ptr-&gt;mulx_ = ptr-&gt;dx_/fabs(ptr-&gt;maxx_ - ptr-&gt;minx_); ptr-&gt;muly_ = ptr-&gt;dy_/fabs(ptr-&gt;maxy_ - ptr-&gt;miny_); ptr-&gt;black_ = gdImageColorAllocate (ptr-&gt;img_, 0, 0, 0); ptr-&gt;blue_ = gdImageColorAllocate (ptr-&gt;img_, 0, 0, 255); ptr-&gt;red_ = gdImageColorAllocate (ptr-&gt;img_, 255, 0, 0); ptr-&gt;green_ = gdImageColorAllocate (ptr-&gt;img_, 0, 255, 0); return (caddr_t)ptr; } caddr_t img_saveas_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_saveas_proc"); gdImagePtr im = ptr-&gt;img_; caddr_t fname = bif_string_arg (qst, args, 1, "img_saveas_proc"); FILE *out = fopen (fname, "wb"); if (NULL != out) { gdImageGif (im, out); fclose (out); return (caddr_t)0; } return (caddr_t)-1; } static unsigned char clip(int value) { if (value &lt; 0) value = 0; else if (value &gt; 255) value = 255; return value; } caddr_t img_fromptr_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { ptrlong addr = unbox(bif_long_arg (qst, args, 0, "img_fromptr_proc")); return addr; } caddr_t img_tostr_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_tostr_proc"); gdImagePtr im = ptr-&gt;img_; void *rv = NULL; caddr_t ret = NULL; int size = 0; gdIOCtx *out = gdNewDynamicCtx (2048, NULL); gdImageGifCtx (im, out); rv = gdDPExtractData (out, &amp;size); if (NULL == rv || size &lt;= 0) return 0; out-&gt;gd_free (out); ret = dk_alloc_box (size, DV_STRING); memcpy (ret, rv, size); gdFree(rv); return (caddr_t)box_num (ret); } caddr_t img_destroy_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_destroy_proc"); gdImagePtr im = ptr-&gt;img_; gdImageDestroy(im); /*dk_free_box (ptr);*/ return 0; } caddr_t img_draw_polyline_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_draw_polyline_proc"); gdImagePtr im = ptr-&gt;img_; caddr_t data = bif_string_arg (qst, args, 1, "img_draw_polyline_proc"); SHPObject *shp = SHPDeserialize (data); int nparts = shp-&gt;nParts; int npoints = shp-&gt;nVertices; double *px = shp-&gt;padfX; double *py = shp-&gt;padfY; int i, j; int color = bif_long_arg (qst, args, 2, "img_draw_polyline_proc"); gdImageSetAntiAliased (im, color); for (i = 0; i &lt; nparts; i++) { long ps = shp-&gt;panPartStart[i]; long psz = (i==(nparts-1))? npoints-ps : shp-&gt;panPartStart[i+1]-ps; gdPointPtr points = (gdPointPtr)malloc(sizeof (gdPoint) * psz); for (j = 0; j &lt; psz; j++) { points[j].x = (px[ps+j] - ptr-&gt;minx_) * ptr-&gt;mulx_; points[j].y = (ptr-&gt;attr_ &amp; 1) ? ptr-&gt;dy_ - (py[ps+j] - ptr-&gt;miny_) * ptr-&gt;muly_: (py[ps+j] - ptr-&gt;miny_) * ptr-&gt;muly_; } for (j = 1; j &lt; psz; j++) { /*if (points[j].x == points[j-1].x &amp;&amp; points[j].y == points[j-1].y) gdImageSetPixel (im, points[j].x, points[j].y, ptr-&gt;blue_); else*/ gdImageLine (im, points[j].x, points[j].y, points[j-1].x, points[j-1].y, gdAntiAliased); } free (points); } SHPDestroyObject (shp); return 0; } caddr_t img_draw_polygone_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_draw_polygone_proc"); gdImagePtr im = ptr-&gt;img_; caddr_t data = bif_string_arg (qst, args, 1, "img_draw_polygone_proc"); SHPObject *shp = SHPDeserialize (data); int nparts = shp-&gt;nParts; int npoints = shp-&gt;nVertices; double *px = shp-&gt;padfX; double *py = shp-&gt;padfY; int i,j; int color = bif_long_arg (qst, args, 2, "img_draw_polygone_proc"); int bcolor = bif_long_arg (qst, args, 3, "img_draw_polygone_proc"); for (i = 0; i &lt; nparts; i++) { long ps = shp-&gt;panPartStart[i]; long psz = (i==(nparts-1))? npoints-ps : shp-&gt;panPartStart[i+1]-ps; gdPointPtr points = (gdPointPtr)malloc (sizeof (gdPoint) * psz); for (j = 0; j &lt; psz; j++) { points[j].x = (px[ps+j] - ptr-&gt;minx_) * ptr-&gt;mulx_; points[j].y = (ptr-&gt;attr_ &amp; 1) ? ptr-&gt;dy_ - (py[ps+j] - ptr-&gt;miny_) * ptr-&gt;muly_: (py[ps+j] - ptr-&gt;miny_) * ptr-&gt;muly_; } gdImageSetAntiAliased (im, color); gdImageFilledPolygon (im, points, psz, gdAntiAliased); if (bcolor &gt;= 0) { gdImageSetAntiAliased (im, bcolor); gdImagePolygon (im, points, psz, gdAntiAliased); } free (points); } SHPDestroyObject(shp); return 0; } caddr_t img_alloc_color_proc (caddr_t * qst, caddr_t * err, state_slot_t ** args) { img_ctx_t *ptr = (img_ctx_t *)bif_arg (qst, args, 0, "img_alloc_color_proc"); gdImagePtr im = ptr-&gt;img_; int r = bif_long_arg (qst, args, 1, "img_alloc_color_proc"); int g = bif_long_arg (qst, args, 2, "img_alloc_color_proc"); int b = bif_long_arg (qst, args, 3, "img_alloc_color_proc"); return box_num(gdImageColorAllocateAlpha (ptr-&gt;img_, r, g, b, 0)); } void init_shcall_gd_utils () { bif_define ("img_create", img_create_proc); bif_define ("img_saveas", img_saveas_proc); bif_define ("img_tostr", img_tostr_proc); bif_define ("img_fromptr", img_fromptr_proc); bif_define ("img_destroy", img_destroy_proc); bif_define ("img_alloc_color", img_alloc_color_proc); bif_define ("img_draw_polyline", img_draw_polyline_proc); bif_define ("img_draw_polygone", img_draw_polygone_proc); }</span></span></span></span></code> </pre><br></div></div></li><li>  Now drawing reservoirs will look like this: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> img <span class="hljs-keyword"><span class="hljs-keyword">any</span></span>; img := img_create (512, 512, cminx, cminy, cmaxx, cmaxy, 1); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> bg <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; cl := img_alloc_color (img, 0, 0, 255); bg := img_alloc_color (img, 0, 0, 200); whenever not found goto nf; for <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xxx.YYY.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_water-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { img_draw_polygone (img, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, cl, bg); } nf:; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ptr <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>; ptr := img_tostr (img); <span class="hljs-comment"><span class="hljs-comment">--  gif img_destroy (img); --   declare image any; image := img_fromptr(ptr); --   http_header ('Content-type: image/gif\t\n'); --   http(image); --     </span></span></code> </pre></li><li>  The transfer of coordinates page itself will pass through the parameters of the URL, <div class="spoiler">  <b class="spoiler_title">body of the page under the spoiler</b> <div class="spoiler_text"><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ({?<span class="hljs-string"><span class="hljs-string">'getfile'</span></span>} &lt;&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>) { http_header (<span class="hljs-string"><span class="hljs-string">'Content-type: image/gif\t\n'</span></span>); -- set the header to jpg <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> s_params any; s_params := deserialize (decode_base64 (get_keyword (<span class="hljs-string"><span class="hljs-string">'params'</span></span>, params, <span class="hljs-string"><span class="hljs-string">''</span></span>))); -- dbg_obj_print(s_params); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"min_x"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"min_y"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"max_x"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"max_y"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cminx"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cminy"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cmaxx"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cmaxy"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> varchar; s := get_keyword (<span class="hljs-string"><span class="hljs-string">'minx'</span></span>, s_params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cminx := min_x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cminx := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'miny'</span></span>, s_params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cminy := min_y; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cminy := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'maxx'</span></span>, s_params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cmaxx := max_x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cmaxx := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'maxy'</span></span>, s_params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cmaxy := max_y; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cmaxy := atof(s); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> img any; img := img_create (<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, cminx, cminy, cmaxx, cmaxy, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cl integer; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> bg integer; { cl := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); bg := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); whenever not found <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> nf; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> select blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data from xxx.YYY.<span class="hljs-string"><span class="hljs-string">"water-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_water-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a where a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { img_draw_polygone (img, data, cl, bg); } nf:; cl := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); bg := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); whenever not found <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> nf2; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> select blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data from xxx.YYY.<span class="hljs-string"><span class="hljs-string">"vegetation-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_vegetation-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a where a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { img_draw_polygone (img, data, cl, bg); } nf2:; cl := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); bg := img_alloc_color (img, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); whenever not found <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> nf3; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> select blob_to_string(Shape) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data from xxx.YYY.<span class="hljs-string"><span class="hljs-string">"building-polygon"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x, xxx.YYY.<span class="hljs-string"><span class="hljs-string">"v_building-polygon_spx_enum_items_in_box"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a where a.minx = cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.miny = cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxx = cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.maxy = cmaxy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.<span class="hljs-string"><span class="hljs-string">"_OBJECTID_"</span></span> = a.oid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxx_ &gt;= cminx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.minx_ &lt;= cmaxx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.maxy_ &gt;= cminy <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> x.miny_ &lt;= cmaxy <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { img_draw_polygone (img, data, cl, bg); } nf3:; } <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> ptr integer; ptr := img_tostr (img); img_destroy (img); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> image any; image := img_fromptr(ptr); http(image); -- table <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> display --dbg_obj_print(<span class="hljs-string"><span class="hljs-string">'boom'</span></span>,{?<span class="hljs-string"><span class="hljs-string">'id'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;!DOCTYPE HTML <span class="hljs-keyword"><span class="hljs-keyword">PUBLIC</span></span> <span class="hljs-string"><span class="hljs-string">"-//W3C//DTD HTML 4.0 Transitional//EN"</span></span>&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"min_x"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"min_y"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"max_x"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"max_y"</span></span> double precision; min_x := <span class="hljs-number"><span class="hljs-number">82.</span></span>; max_x := <span class="hljs-number"><span class="hljs-number">84.</span></span>; min_y := <span class="hljs-number"><span class="hljs-number">54.</span></span>; max_y := <span class="hljs-number"><span class="hljs-number">56.</span></span>; params := vector_concat (params, vector (<span class="hljs-string"><span class="hljs-string">'minx'</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'%g'</span></span>, min_x), <span class="hljs-string"><span class="hljs-string">'maxx'</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'%g'</span></span>, max_x), <span class="hljs-string"><span class="hljs-string">'miny'</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'%g'</span></span>, min_y), <span class="hljs-string"><span class="hljs-string">'maxy'</span></span>, sprintf(<span class="hljs-string"><span class="hljs-string">'%g'</span></span>, max_y))); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;html&gt; &lt;body zonload=<span class="hljs-string"><span class="hljs-string">"window.location.reload();"</span></span>&gt; &lt;script language=<span class="hljs-string"><span class="hljs-string">"JavaScript"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">full_extent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value=<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=min_x <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value=<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=min_y <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value=<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=max_x <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value=<span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=max_y <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>; } &lt;/script&gt; &lt;script language=<span class="hljs-string"><span class="hljs-string">"JavaScript"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zoom_in</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dx = Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value); dx = dx/<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value; tmp -= dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value = tmp; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value; tmp -= -dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value = tmp; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dy = Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value); dy = dy/<span class="hljs-number"><span class="hljs-number">8</span></span>; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value; tmp -= dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value = tmp; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value; tmp -= -dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value = tmp; } &lt;/script&gt; &lt;script language=<span class="hljs-string"><span class="hljs-string">"JavaScript"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zoom_out</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dx = -Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value); dx = dx/<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value; tmp -= dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value = tmp; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value; tmp -= -dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value = tmp; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dy = -Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value); dy = dy/<span class="hljs-number"><span class="hljs-number">8</span></span>; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value; tmp -= dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value = tmp; tmp = document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value; tmp -= -dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value = tmp; } &lt;/script&gt; &lt;script language=<span class="hljs-string"><span class="hljs-string">"JavaScript"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pan_left</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dx = Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value); dx = dx/<span class="hljs-number"><span class="hljs-number">8</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value -= dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value -= dx; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pan_right</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dx = -Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value); dx = dx/<span class="hljs-number"><span class="hljs-number">8</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxx.value -= dx; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].minx.value -= dx; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pan_up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dy = -Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value); dy = dy/<span class="hljs-number"><span class="hljs-number">8</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value -= dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value -= dy; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pan_down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dy = Math.abs(document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value - document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value); dy = dy/<span class="hljs-number"><span class="hljs-number">8</span></span>; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].maxy.value -= dy; document.forms[<span class="hljs-string"><span class="hljs-string">'form1'</span></span>].miny.value -= dy; } &lt;/script&gt; &lt;form method=<span class="hljs-string"><span class="hljs-string">"GET"</span></span> id=<span class="hljs-string"><span class="hljs-string">"form1"</span></span> name=<span class="hljs-string"><span class="hljs-string">"form1"</span></span>&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cminx"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cminy"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cmaxx"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"cmaxy"</span></span> double precision; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> varchar; s := get_keyword (<span class="hljs-string"><span class="hljs-string">'minx'</span></span>, params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cminx := min_x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cminx := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'miny'</span></span>, params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cminy := min_y; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cminy := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'maxx'</span></span>, params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cmaxx := max_x; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cmaxx := atof(s); s := get_keyword (<span class="hljs-string"><span class="hljs-string">'maxy'</span></span>, params, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s = <span class="hljs-string"><span class="hljs-string">''</span></span>) cmaxy := max_y; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cmaxy := atof(s); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> mashtab double precision; mashtab := floor((cmaxx-cminx)*<span class="hljs-number"><span class="hljs-number">96.</span></span>/(<span class="hljs-number"><span class="hljs-number">512.</span></span>*<span class="hljs-number"><span class="hljs-number">2.54</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cnt integer; cnt := sequence_next (<span class="hljs-string"><span class="hljs-string">'xxx.YYY.__cnt'</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"minx"</span></span> value=<span class="hljs-string"><span class="hljs-string">'&lt;?vsp=cminx ?&gt;'</span></span>/&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"miny"</span></span> value=<span class="hljs-string"><span class="hljs-string">'&lt;?vsp=cminy ?&gt;'</span></span>/&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"maxx"</span></span> value=<span class="hljs-string"><span class="hljs-string">'&lt;?vsp=cmaxx ?&gt;'</span></span>/&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"hidden"</span></span> name=<span class="hljs-string"><span class="hljs-string">"maxy"</span></span> value=<span class="hljs-string"><span class="hljs-string">'&lt;?vsp=cmaxy ?&gt;'</span></span>/&gt; &lt;table width=<span class="hljs-string"><span class="hljs-string">"100%"</span></span> border=<span class="hljs-string"><span class="hljs-string">"1"</span></span> cellpadding=<span class="hljs-string"><span class="hljs-string">"0"</span></span> cellspacing=<span class="hljs-string"><span class="hljs-string">"0"</span></span> summary=<span class="hljs-string"><span class="hljs-string">""</span></span>&gt; &lt;tr&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;Min X&lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;Min Y&lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;Max X&lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;Max Y&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span> extent&lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=min_x <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=min_y <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=max_x <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=max_y <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt;Current extent&lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=sprintf(<span class="hljs-string"><span class="hljs-string">'%10.3f'</span></span>, cminx) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=sprintf(<span class="hljs-string"><span class="hljs-string">'%10.3f'</span></span>, cminy) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=sprintf(<span class="hljs-string"><span class="hljs-string">'%10.3f'</span></span>, cmaxx) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>vsp=sprintf(<span class="hljs-string"><span class="hljs-string">'%10.3f'</span></span>, cmaxy) <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: full_extent(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"[*]"</span></span>/&gt; &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: zoom_in(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"+"</span></span> /&gt; &lt;br&gt;&lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: zoom_out(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"-"</span></span> /&gt; &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: pan_up(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"^"</span></span> /&gt; &lt;br&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: pan_down(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"V"</span></span> /&gt; &lt;/td&gt; &lt;td width=<span class="hljs-string"><span class="hljs-string">"20%"</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span> &gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: pan_left(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> /&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"button"</span></span> onclick=<span class="hljs-string"><span class="hljs-string">"javascript: pan_right(); document.forms['form1'].submit ();"</span></span> value=<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span> /&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt;&lt;td colspan=<span class="hljs-number"><span class="hljs-number">5</span></span> align=<span class="hljs-string"><span class="hljs-string">"center"</span></span>&gt; &lt;p&gt;&lt;img src=<span class="hljs-string"><span class="hljs-string">""</span></span>&gt;&lt;/p&gt; &lt;/td&gt;&lt;/tr&gt; &lt;/table&gt; &lt;/form&gt;&lt;/body&gt;&lt;/html&gt;</code> </pre><br></div></div></li><li>  And here is the result: <br><img src="https://habrastorage.org/getpro/habr/post_images/a02/ecc/b0e/a02eccb0e43a3586fddae887a92a456b.png" alt="image"></li></ul><br><h4>  <b>Performance evaluation.</b> </h4><br><ul><li>  We will do it in about the same way as when we investigated the actual web interface. </li><li>  We will launch 4 wget in parallel, each of which will make 10,000 pairs of requests - to the page and the picture.  Inside one wget, the requests are the same, different between them.  This was done in view of the fact that there is not very much data, and they will somehow end up in memory, but if requests are made random, there will be a difficult estimated time to warm up.  And if all requests are made the same, they will begin to be pushed by elbows.  Nobody canceled the transaction requirements. </li><li>  Since  after starting the processes in the background, there is a barrier (wait in bash), it will be measured at the slowest request. </li><li>  Requests will not be very large ~ 3X3 km, </li><li>  Attentive reader will say that these tests are sharpened by the index settings and there is no universality here.  Yes it is.  The nature of a block index is such that it effectively works only on queries that are commensurate with the size of its cell.  This is on the one hand.  And on the other <br>  nobody forbids us to use several block indices simultaneously for different scales of the map.  In addition, on the block indexes the light did not come together.  If you consider the extent as a four-dimensional point, you can use, for example, <a href="http://habrahabr.ru/post/186564/">point indices</a> . <br></li><li>  So, the total running time is 8 minutes 12 seconds.  Or 81 requests per second. </li><li>  A million requests take 3 hours and 32 minutes, i.e.  There is no significant degradation. </li><li>  The data flow through the network - 52 Mbps must be divided in half, because  we have both clients and server on the same host </li><li>  CPU usage - 68%, the server takes 66 of them </li><li>  The server takes from 1.1 to 1.6 GB of RAM, there are apparently no leaks, in any case, after a million requests, 1.3 GB were used </li><li>  Database file size - ~ 3 GB </li></ul><br><h4>  <b>findings</b> </h4><br><ul><li>  The performance goal has been achieved, experience has shown that a million requests per day are easily handled with a solid margin for peak loads. </li><li>  Given that desktop windows is not a server OS at all </li><li>  Yes, and the hardware was not server </li><li>  It should be noted that not even a prototype is presented, but a technology demonstrator.  Only three layers were used, albeit fairly populated.  In real life, of course, there are dozens of layers, but not all of them are needed at the same time.  To make life easier, on a small scale, generalized layers are used.  Etc.  etc.  But, once again, there was no task to repeat OSM, only to test the operation of the technology. </li><li>  If the interface seems to be ... ascetic, it is worth referring to the previous paragraph. </li><li>  Not implemented labeling ... </li><li>  Not implemented projections ... </li><li>  An important feature of this technology is the imperative description of the map project - in the form of PL / SQL text.  This has its drawbacks, but also an undoubted plus - flexibility and complete freedom of action.  So you can implement a system with the power of a full-fledged GIS and static tile pyramid performance.  For example, start signing streets on top of traffic signs. </li></ul><br><h4>  <b>PS</b> : </h4>  <i>Whoever first correctly calls the pass at number 40 on a map fragment in the header of the article will receive thanks from the author.</i> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/200642/">https://habr.com/ru/post/200642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200618/index.html">Opened Red Hat Software Collections repository that can be used in Centos</a></li>
<li><a href="../200620/index.html">Developing angularjs directives is just</a></li>
<li><a href="../200632/index.html">We create the first application on NancyFX. Part Four We continue to work with the modules</a></li>
<li><a href="../200634/index.html">Increase security with two clicks</a></li>
<li><a href="../200640/index.html">Astrophotography in every house</a></li>
<li><a href="../200644/index.html">Harmony collections NOW</a></li>
<li><a href="../200646/index.html">Build Android applications on Travis CI</a></li>
<li><a href="../200652/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 81 (October 27 - November 2, 2013)</a></li>
<li><a href="../200654/index.html">We are refining equipment Turnigy 9x</a></li>
<li><a href="../200658/index.html">Is your disassembler working correctly?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>