<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart pointers and RAII in the service of a programmer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Historically, management wanted the task to be completed quickly. To do this, programmers preserve the beauty and purity of the code. This post appear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart pointers and RAII in the service of a programmer</h1><div class="post__text post__text-html js-mediator-article">  Historically, management wanted the task to be completed quickly.  To do this, programmers preserve the beauty and purity of the code.  This post appeared as a reminder of the rarely used innovations in C ++ 11 - smart points that allow you to specify a functor for freeing resources. <br>  For example, let's take the file stream FILE from stdio.h, which they love for simplicity and speed, we will try to add to it the beauty and basic guarantee with exceptions: <br><pre><code class="hljs mel">unique_ptr&lt;FILE, decltype(&amp;<span class="hljs-keyword"><span class="hljs-keyword">fclose</span></span>)&gt; my_file(<span class="hljs-keyword"><span class="hljs-keyword">fopen</span></span>(<span class="hljs-string"><span class="hljs-string">"test.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>), &amp;<span class="hljs-keyword"><span class="hljs-keyword">fclose</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(my_file) <span class="hljs-keyword"><span class="hljs-keyword">fwrite</span></span>(<span class="hljs-string"><span class="hljs-string">"test"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, my_file.get());</code> </pre> <br>  As a result, the code depends only on STL and requires a small modification of file accesses, it is written quickly, it looks modern.  That's how RAII turned out to be pure. <br><a name="habracut"></a><br><h4>  How it works? </h4><br>  The fopen function returns a pointer to an object of type FILE, which is stored in the variable my_file along with a pointer to the function fclose.  In this way, ownership of this file stream is transferred to a local variable. <br><br><h4>  When will the fclose function be called automatically? </h4><br><ol><li>  When leaving the scope of a variable (for example, from a function). </li><li>  When an exception occurs after creating my_file. </li><li>  When the assignment function is called on my_file. </li><li>  When calling my_file.reset (). </li></ol><br><h4>  What are the overhead costs? </h4><br><ol><li>  The programmer needs to complicate the creation of the file, remove the call to fclose and supplement with the call to unique_ptr &lt;...&gt; :: get () all references to the file. </li><li>  In the worst case, the compiler will need a memory location to hold a pointer to the file deletion function.  At best, it will simply place the fclose call in the right place for you, fully optimizing the my_file object. </li></ol><br><h4>  What are the advantages of this approach? </h4><br><ol><li>  As with any smart pointer, you explicitly indicate how you own the object.  In this case, it is indicated that the object is not shared (unique_ptr). </li><li>  You can get rid of excess copy-paste by declaring your type like this: <pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;FILE, <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(&amp;fclose)&gt; MyFileType;</code> </pre> </li><li>  If you use a lot of files, it makes sense to write a small wrapper. <br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-function">MyFileType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* mode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;FILE, <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(&amp;fclose)&gt;(fopen(filename, mode), &amp;fclose); }</code> </pre>  ... and use it like this: <br><pre> <code class="hljs lisp">auto my_file = MakeFile(<span class="hljs-string"><span class="hljs-string">"test.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> </li><li>  Allows you to get rid of writing extra code in the destructor.  Why superfluous?  You have already indicated to the compiler how you want to manage this resource and now it‚Äôs his job. </li><li>  You can use objects of type MyFileType in standard STL containers: <br><pre> <code class="hljs cpp"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;MyFileType&gt; my_files; my_files.push_back(MakeFile(<span class="hljs-string"><span class="hljs-string">"test.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>));</code> </pre>  ... and do not waste your time on controlling the lifetime of objects.  In C ++ 11, vector &lt;MyFileType&gt; can be safely returned from a function. </li></ol><br><h4>  Here are some more ideas from the C Runtime Library: </h4><br>  Those who are puzzled or keen on optimizing for Windows know that access to aligned data is faster.  So you can create a pointer to memory aligned to 16 bytes using the Microsoft Visual C Runtime library: <br><pre> <code class="hljs cpp"><span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[], <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(&amp;::_aligned_free)&gt; my_buffer((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)(_aligned_malloc(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>)), &amp;_aligned_free); my_buffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'x'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre><br>  Once you write a template: <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;T[], <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(&amp;::_aligned_free)&gt; MakeAlignedBuffer(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> element_count, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> alignment = alignment_of&lt;T&gt;::value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;T[], <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(&amp;::_aligned_free)&gt; (<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;T*&gt;(_aligned_malloc(element_count*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(T), alignment)), &amp;_aligned_free); }</code> </pre>  You can forget about the errors of allocating and deleting memory with different functions (created with new [] in one module, deleted with delete in another). <br><br><h4>  And what to do if a certain WinAPI resource owns several objects? </h4><br>  For example, consider the situation when several different objects in a GUI application use functions that are in a dynamically loaded DLL.  In this case, it is not so easy to program the timely unloading of the library as we would like: <br>  Loading the library ... <br><pre> <code class="hljs lisp">auto my_module = shared_ptr&lt;HMODULE&gt;(<span class="hljs-name"><span class="hljs-name">new</span></span> HMODULE(<span class="hljs-name"><span class="hljs-name">LoadLibrary</span></span>(<span class="hljs-name"><span class="hljs-name">_T</span></span>(<span class="hljs-string"><span class="hljs-string">"my_library.dll"</span></span>))), [](<span class="hljs-name"><span class="hljs-name">HMODULE*</span></span> instance){ FreeLibrary(<span class="hljs-name"><span class="hljs-name">*instance</span></span>)<span class="hljs-comment"><span class="hljs-comment">; //         });</span></span></code> </pre>  Next, distribute my_module objects ... <br><pre> <code class="hljs objectivec">module_owner1.set_module(my_module); module_owner2.set_module(my_module); <span class="hljs-comment"><span class="hljs-comment">//     vector  </span></span></code> </pre>  We use the necessary functions in the object ... <br><pre> <code class="hljs lisp">if(<span class="hljs-name"><span class="hljs-name">my_module</span></span> <span class="hljs-symbol"><span class="hljs-symbol">&amp;&amp;</span></span> *my_module) { auto func1 = GetProcAddress(*my_module, <span class="hljs-string"><span class="hljs-string">"MyFunc"</span></span>)<span class="hljs-comment"><span class="hljs-comment">; }</span></span></code> </pre>  When we stop using the functions and the object reference count is zero, the my_module object will be called FreeLibrary function and the object will be deleted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  How to use lambda function in unique_ptr? </h4><br>  You need to use the function template like this: <br><pre> <code class="hljs php">auto my_instance = std::unique_ptr&lt;HMODULE, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HMODULE*)</span></span></span><span class="hljs-function">&gt;&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(new HMODULE</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(LoadLibrary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(_T</span></span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">(</span></span></span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"my_library.dll"</span></span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params">, []</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(HMODULE* instance)</span></span></span></span><span class="hljs-function"><span class="hljs-params">{ FreeLibrary</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(*instance)</span></span></span></span><span class="hljs-function"><span class="hljs-params">; })</span></span></span></span>;</code> </pre><br><h4>  Conclusion </h4><br>  Dear readers, remember that any technology is developed for a specific purpose and should not be used where its use is not justified, i.e.  Do not rush to replace all the pointers to smart pointers without thinking about the need and not analyzing the consequences.  There are also disadvantages to these approaches, and they have been repeatedly discussed in Habr√©.  Be professional. <br>  Thank. </div><p>Source: <a href="https://habr.com/ru/post/207842/">https://habr.com/ru/post/207842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207830/index.html">Cellular Automatics on Dart</a></li>
<li><a href="../207832/index.html">Intel Inside: disassemble the latest Digma devices on the Intel platform and wonder about the progress of Chinese engineering</a></li>
<li><a href="../207834/index.html">Our experience in optimizing nginx to distribute video content</a></li>
<li><a href="../207838/index.html">For improving the search for information on Habr√©</a></li>
<li><a href="../207840/index.html">Dokku: the smallest PaaS</a></li>
<li><a href="../207844/index.html">How to start mining for beginners</a></li>
<li><a href="../207846/index.html">We compiled a snake in the browser</a></li>
<li><a href="../207848/index.html">MS-DOS, which we have never seen</a></li>
<li><a href="../207850/index.html">Why not play Tanki Online</a></li>
<li><a href="../207852/index.html">How were pictures of the rise of the Earth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>