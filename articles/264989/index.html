<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cartesius - a method of storing and retrieving tree structures in relational databases or SQL trees without worms and cockroaches</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is better not to think about finding any truth at all than to do it without any method. (Rene Descartes) 


 A database developer often has to deal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cartesius - a method of storing and retrieving tree structures in relational databases or SQL trees without worms and cockroaches</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>It is better not to think about finding any truth at all than to do it without any method.</i>  <i>(Rene Descartes)</i> </blockquote><br><img src="https://habrastorage.org/getpro/habr/post_images/e1f/a94/6fc/e1fa946fcd0e0ddb307c1ddaa49b2055.jpg" alt="image"><br><br>  A database developer often has to deal with tree structures.  Everything in this world is part of one or many hierarchies, and therefore the ability to effectively store and manage this kind of data is a very important task. <br><br>  There are many methods from the most primitive to very complex and perhaps too complex.  We will not describe them in this article.  If you wish, you can find many excellent review articles on the Internet ‚ÄúGoogle forever‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We present to the developers the Cartesius method which is based on the representation of the hierarchical structure on the coordinate plane where each node has its coordinate in the form of two parameters ord and dep. <br><a name="habracut"></a><br>  So let's get started.  Take for example the following hierarchy of wines. <br><br><ul><li>  Wines <br><ul><li>  White wines <br><ul><li>  French white wines <br><ul><li>  Chardonnay </li><li>  Colombard </li><li>  Folle blanche </li><li>  Ugni blanc </li><li>  Muscadelle </li><li>  Sauvignon </li></ul></li><li>  Italian white wines <br><ul><li>  Castelli Romani Bianco </li><li>  Tusculum bianco </li></ul></li></ul></li><li>  Red wines <br><ul><li>  French red wines <br><ul><li>  Cabernet <br><ul><li>  Franc </li><li>  Sauvignon </li></ul></li><li>  Carmenere </li><li>  Beaujolais nouveau </li></ul></li><li>  Italian red wines <br><ul><li>  Bardolino </li><li>  Syrah cabernet </li><li>  Castelli Romani Rosso </li></ul></li></ul></li></ul></li></ul><br>  Place the entire hierarchy on the coordinate plane and get the coordinates of each node in the hierarchy. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3b/661/466/c3b661466b3969ac68ea0b1ca44b8581.jpg" alt="image"><br><br>  The Y axis, which goes from top to bottom, will be called ord (from the word order - order), and the X axis will be called dep (from the word depth - depth). <br><br>  Now each node has its own coordinates.  For example, Bardolino (ord 20, dep 3), Chardonnay (ord 3, dep 3), Sauvignon (ord 16, dep 4), etc. <br><br>  Create a SQL table and enter this data into it.  (in this article, all examples are developed under MySQL). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`tree`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> auto_increment, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> utf8_bin <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ord`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`dep`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span>=utf8_bin; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">`tree`</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>, <span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`ord`</span></span>, <span class="hljs-string"><span class="hljs-string">`dep`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'Chardonnay'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'Colombard'</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">'Folle blanche'</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">'Ugni blanc'</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-string"><span class="hljs-string">'Muscadelle'</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">'Chenin'</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">'Castelli Romani Bianco'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">'Tusculum Bianco'</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">'Cabernet'</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">'Franc'</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>), (<span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">'Sauvignon'</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>), (<span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-string"><span class="hljs-string">'Carmenere'</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-string"><span class="hljs-string">'Beaujolais nouveau'</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-string"><span class="hljs-string">'Bardolino'</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-string"><span class="hljs-string">'Syrah Cabernet'</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-string"><span class="hljs-string">'Castelli Romani Rosso'</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">We get the following table:</b> <div class="spoiler_text"><table><tbody><tr><td>  <strong>id</strong> <br></td><td>  <strong>name</strong> <br></td><td>  <strong>ord</strong> <br></td><td>  <strong>dep</strong> <br></td></tr><tr><td>  one <br></td><td>  Wines <br></td><td>  0 <br></td><td>  0 <br></td></tr><tr><td>  2 <br></td><td>  White wines <br></td><td>  one <br></td><td>  one <br></td></tr><tr><td>  3 <br></td><td>  French white wines <br></td><td>  2 <br></td><td>  2 <br></td></tr><tr><td>  four <br></td><td>  Chardonnay <br></td><td>  3 <br></td><td>  3 <br></td></tr><tr><td>  five <br></td><td>  Colombard <br></td><td>  four <br></td><td>  3 <br></td></tr><tr><td>  6 <br></td><td>  Folle blanche <br></td><td>  five <br></td><td>  3 <br></td></tr><tr><td>  7 <br></td><td>  Ugni blanc <br></td><td>  6 <br></td><td>  3 <br></td></tr><tr><td>  eight <br></td><td>  Muscadelle <br></td><td>  7 <br></td><td>  3 <br></td></tr><tr><td>  9 <br></td><td>  Chenin <br></td><td>  eight <br></td><td>  3 <br></td></tr><tr><td>  ten <br></td><td>  Italian white wines <br></td><td>  9 <br></td><td>  2 <br></td></tr><tr><td>  eleven <br></td><td>  Castelli Romani Bianco <br></td><td>  ten <br></td><td>  3 <br></td></tr><tr><td>  12 <br></td><td>  Tusculum bianco <br></td><td>  eleven <br></td><td>  3 <br></td></tr><tr><td>  13 <br></td><td>  Red wines <br></td><td>  12 <br></td><td>  one <br></td></tr><tr><td>  14 <br></td><td>  French red wines <br></td><td>  13 <br></td><td>  2 <br></td></tr><tr><td>  15 <br></td><td>  Cabernet <br></td><td>  14 <br></td><td>  3 <br></td></tr><tr><td>  sixteen <br></td><td>  Franc <br></td><td>  15 <br></td><td>  four <br></td></tr><tr><td>  17 <br></td><td>  Sauvignon <br></td><td>  sixteen <br></td><td>  four <br></td></tr><tr><td>  18 <br></td><td>  Carmenere <br></td><td>  17 <br></td><td>  3 <br></td></tr><tr><td>  nineteen <br></td><td>  Beaujolais nouveau <br></td><td>  18 <br></td><td>  3 <br></td></tr><tr><td>  20 <br></td><td>  Italian red wines <br></td><td>  nineteen <br></td><td>  2 <br></td></tr><tr><td>  21 <br></td><td>  Bardolino <br></td><td>  20 <br></td><td>  3 <br></td></tr><tr><td>  22 <br></td><td>  Syrah cabernet <br></td><td>  21 <br></td><td>  3 <br></td></tr><tr><td>  23 <br></td><td>  Castelli Romani Rosso <br></td><td>  22 <br></td><td>  3 <br></td></tr></tbody></table><br></div></div><br>  So, we have two parameters, ord and dep, as well as the name and id of each node. <br><br>  Add another node called artesius_plug with a maximum ord value of 23 in this case and a dep value of 0. This node will always have a maximum ord.  Why we did it you will be a little later. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tree (<span class="hljs-string"><span class="hljs-string">`id`</span></span>, <span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`ord`</span></span>, <span class="hljs-string"><span class="hljs-string">`dep`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'24'</span></span>, <span class="hljs-string"><span class="hljs-string">' artesius_plug'</span></span>, <span class="hljs-string"><span class="hljs-string">'23'</span></span>, <span class="hljs-string"><span class="hljs-string">'0'</span></span>);</code> </pre><br>  We define the most common tasks that developers encounter. <br><ul><li>  Print all tree </li><li>  Print the node and all its descendants </li><li>  Output node and descendants of the first level </li><li>  Print the node and all its ancestors </li><li>  Add a node </li><li>  Delete node </li></ul><br><br>  <b>Print all tree</b> <br><br>  Since the node artesius_plug has only a technical purpose, it does not need us to output the entire tree, so the query will look like this. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &lt; (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span></code> </pre><br>  Note that in our example, the Root root node (ord 0, dep 0) is only one, but there can be as many of them as you like. <br><br><div class="spoiler">  <b class="spoiler_title">The result is</b> <div class="spoiler_text"><table><tbody><tr><td>  <strong>Name</strong> <br></td><td>  <strong>ord</strong> <br></td><td>  <strong>dep</strong> <br></td></tr><tr><td>  Wines <br></td><td>  0 <br></td><td>  0 <br></td></tr><tr><td>  White wines <br></td><td>  one <br></td><td>  one <br></td></tr><tr><td>  French white wines <br></td><td>  2 <br></td><td>  2 <br></td></tr><tr><td>  Chardonnay <br></td><td>  3 <br></td><td>  3 <br></td></tr><tr><td>  Colombard <br></td><td>  four <br></td><td>  3 <br></td></tr><tr><td>  Folle blanche <br></td><td>  five <br></td><td>  3 <br></td></tr><tr><td>  Ugni blanc <br></td><td>  6 <br></td><td>  3 <br></td></tr><tr><td>  Muscadelle <br></td><td>  7 <br></td><td>  3 <br></td></tr><tr><td>  Chenin <br></td><td>  eight <br></td><td>  3 <br></td></tr><tr><td>  Italian white wines <br></td><td>  9 <br></td><td>  2 <br></td></tr><tr><td>  Castelli Romani Bianco <br></td><td>  ten <br></td><td>  3 <br></td></tr><tr><td>  Tusculum bianco <br></td><td>  eleven <br></td><td>  3 <br></td></tr><tr><td>  Red wines <br></td><td>  12 <br></td><td>  one <br></td></tr><tr><td>  French red wines <br></td><td>  13 <br></td><td>  2 <br></td></tr><tr><td>  Cabernet <br></td><td>  14 <br></td><td>  3 <br></td></tr><tr><td>  Franc <br></td><td>  15 <br></td><td>  four <br></td></tr><tr><td>  Sauvignon <br></td><td>  sixteen <br></td><td>  four <br></td></tr><tr><td>  Carmenere <br></td><td>  17 <br></td><td>  3 <br></td></tr><tr><td>  Beaujolais nouveau <br></td><td>  18 <br></td><td>  3 <br></td></tr><tr><td>  Italian red wines <br></td><td>  nineteen <br></td><td>  2 <br></td></tr><tr><td>  Bardolino <br></td><td>  20 <br></td><td>  3 <br></td></tr><tr><td>  Syrah cabernet <br></td><td>  21 <br></td><td>  3 <br></td></tr><tr><td>  Castelli Romani Rosso <br></td><td>  22 <br></td><td>  3 <br></td></tr></tbody></table><br></div></div><br>  <i>From this data, create XML or JSON.</i>  <i>If someone has an interest, we can give an example of constructing json-a from this data in Perl, in one cycle</i> . <br><br>  <b>Print the node and all its descendants</b> <br><br>  Suppose we need to derive the node ‚ÄúRed wines‚Äù (ord 12, dep 1) and all its descendants.  Therefore, we need to derive nodes for which ord&gt; = 12 and which is less than ord-and break points. <br><br>  What is a break point?  The break point is a node that has the following requirements: <br><ol><li>  ord must be greater than the ord node of the descendants of which you want to output </li><li>  dep must be less than or equal to the dep-node of whose descendants you want to output </li><li>  It must have a minimum ord of the set of nodes that meet the previous two conditions. </li></ol><br>  For example, for the node ‚ÄúFrench white wines‚Äù the point of the gap will be the node ‚ÄúItalian white wines‚Äù, its ord is greater than the ord node of the node ‚ÄúFrench white wines‚Äù, dep is equal to dep-y ‚ÄúFrench white wines‚Äù and, finally, has the minimum ord from the set of nodes that follow the node ‚ÄúFrench white wines‚Äù, that is, the first node that follows the descendants of the node ‚ÄúFrench white wines‚Äù. <br><br><img src="http://zentsoft.com/habr/cart2.jpg" alt="image"><br><br>  So, the node ‚ÄúRed varieties of wines‚Äù has id = 13.  The SQL query will look like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&lt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span></code> </pre><br>  In the above query <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>)</code> </pre><br>  gives us ord break points, which in this case is artesius_plug which has ord 23. <br><br><div class="spoiler">  <b class="spoiler_title">We get the result:</b> <div class="spoiler_text"><table><tbody><tr><td>  <strong>name</strong> <br></td><td>  <strong>ord</strong> <br></td><td>  <strong>dep</strong> <br></td></tr><tr><td>  Red wines <br></td><td>  12 <br></td><td>  one <br></td></tr><tr><td>  French red wines <br></td><td>  13 <br></td><td>  2 <br></td></tr><tr><td>  Cabernet <br></td><td>  14 <br></td><td>  3 <br></td></tr><tr><td>  Franc <br></td><td>  15 <br></td><td>  four <br></td></tr><tr><td>  Sauvignon <br></td><td>  sixteen <br></td><td>  four <br></td></tr><tr><td>  Carmenere <br></td><td>  17 <br></td><td>  3 <br></td></tr><tr><td>  Beaujolais nouveau <br></td><td>  18 <br></td><td>  3 <br></td></tr><tr><td>  Italian red wines <br></td><td>  nineteen <br></td><td>  2 <br></td></tr><tr><td>  Bardolino <br></td><td>  20 <br></td><td>  3 <br></td></tr><tr><td>  Syrah cabernet <br></td><td>  21 <br></td><td>  3 <br></td></tr><tr><td>  Castelli Romani Rosso <br></td><td>  22 <br></td><td>  3 <br></td></tr></tbody></table><br></div></div><br>  It's time to explain the purpose of the artesius_plug node.  Note that at the node ‚ÄúRed wines varieties‚Äù descendants reach the end of the hierarchy.  Accordingly, we could not find a break point for this node.  This is where artesius_plug comes to the rescue, which always has the maximum ord and in this case will be a break point for the ‚ÄúRed wines‚Äù node. <br><br>  If it is necessary to display only descendants, without a parent node, it is enough to take nodes whose ord-s are larger, but not equal to the ord-Red node of the wines. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&lt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span></code> </pre><br><br>  <b>Output node and descendants of the first level</b> <br><br>  To output a node and descendants only of the first level, it suffices to add to the previous query the condition limiting the depth: <br><pre> <code class="sql hljs">dep &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) dep &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>)</code> </pre><br><br>  The SQL query will look like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt;= ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &lt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt; ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep &lt;= ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep &gt;= (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Result:</b> <div class="spoiler_text"><table><tbody><tr><td>  <strong>name</strong> <br></td><td>  <strong>ord</strong> <br></td><td>  <strong>dep</strong> <br></td></tr><tr><td>  Red wines <br></td><td>  12 <br></td><td>  one <br></td></tr><tr><td>  French red wines <br></td><td>  13 <br></td><td>  2 <br></td></tr><tr><td>  Italian red wines <br></td><td>  nineteen <br></td><td>  2 <br></td></tr></tbody></table><br></div></div><br><br>  <b>Print the node and all its ancestors</b> <br><br>  To solve this problem, just look at the coordinate plane.  The ancestors of the node ‚ÄúFrench red wines‚Äù are the tops of the yellow columns.  Thus, nodes whose ord are smaller than the ord ‚Äúfrench red wines‚Äù node and which have the maximum ord are grouped by dep, and finally, the dep must be less than or equal to the dep ‚Äî at the french red wines node. <br><br>  The SQL query will look like this: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(a.ord)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree a <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> a.ord&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> a.dep <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> a.ord</code> </pre><br><img src="http://zentsoft.com/habr/cart3a.jpg" alt="image"><br><br>  Result: <br><ul><li>  Wines </li><li>  Red wines </li><li>  French red wines </li></ul><br><br>  <u><i><b>Add a node</b></i></u> <br><br>  To add a new node, follow these steps. <br><br>  A. If it is added after any node, for example after the ‚ÄúTusculum Bianco‚Äù node <br><ol><li>  Define break point for ‚ÄúTusculum Bianco‚Äù </li><li>  Add to ord that are greater than or equal to the ord break point one </li><li>  Insert a new node with ord th equal to the ord break point and dep th equal to the dep point of the ‚ÄúTusculum Bianco‚Äù </li></ol><br>  B. If added as a descendant for example to the ‚ÄúTusculum Bianco‚Äù node <br><ul><li>  We add to ord-s, which are larger than the ord-s of the ‚ÄúTusculum Bianco‚Äù node </li><li>  Insert the new node with the ord-th equal to the ord-at the node ‚ÄúTusculum Bianco‚Äù + 1 and dep-th equal to the dep-at the node ‚ÄúTusculum Bianco‚Äù +1 </li></ul><br>  This is best done with a procedure.  Below is the universal procedure code. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER=<span class="hljs-string"><span class="hljs-string">`root`</span></span>@<span class="hljs-string"><span class="hljs-string">`localhost`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`sp_add`</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> relativ_menu <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> direct tinyint, <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> name_menu <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">charset</span></span> utf8 ) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> relativ_menu_ord <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> relativ_menu_dep <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF (direct=0) THEN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> relativ_menu_ord, relativ_menu_dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = relativ_menu; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;=relativ_menu_ord; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tree (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (name_menu, relativ_menu_ord, relativ_menu_dep); ELSEIF (direct=1) THEN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> relativ_menu_ord <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> =relativ_menu) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep&lt;=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> =relativ_menu); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dep <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> relativ_menu_dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> =relativ_menu; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;=relativ_menu_ord; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tree (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (name_menu, relativ_menu_ord, relativ_menu_dep); ELSEIF (direct=2) THEN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> relativ_menu_ord, relativ_menu_dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> =relativ_menu; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt;relativ_menu_ord; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> tree (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (name_menu, relativ_menu_ord+<span class="hljs-number"><span class="hljs-number">1</span></span>, relativ_menu_dep+<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$$</code> </pre><br>  where direct = 0 add to selected node, direct = 1 add after selected node, direct = 2 add child to selected node <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> sp_add (<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'node_name'</span></span>)</code> </pre><br>  <b>Delete node</b> <br><br>  To delete a node, follow these steps: <br><br>  A. If a single node is deleted, for example ‚ÄúCabernet‚Äù: <br><ol><li>  Determine break point for ‚ÄúCabernet‚Äù </li><li>  We subtract from ord-s that are larger than the ord "Cabernet" unit </li><li>  We subtract a unit from the dep-s at nodes whose ord-s are greater than the ‚ÄúCabernet‚Äù ord and less than the ord-point break point </li><li>  Remove the node </li></ol><br>  B. If a node and all its descendants are deleted, for example ‚ÄúCabernet‚Äù: <br><ol><li>  Determine break point for ‚ÄúCabernet‚Äù </li><li>  Determine the number of nodes to be deleted  the node itself, plus all its descendants. </li><li>  Remove nodes whose ord are greater than or equal to the ord of the node being deleted and less than the ord of the break point </li><li>  We subtract from ord-s that are greater than or equal to ord-the break point the number of nodes to be removed which was determined in paragraph 2 </li></ol><br>  This is best done with a procedure.  Below is the universal procedure code. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> DEFINER=<span class="hljs-string"><span class="hljs-string">`root`</span></span>@<span class="hljs-string"><span class="hljs-string">`localhost`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-string"><span class="hljs-string">`sp_del`</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> id_menu <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> direct tinyint) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> min_ord <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> max_ord <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> count_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> menu_ord <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> menu_dep <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> id_node_pr <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>, dep <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> menu_ord, menu_dep <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = id_menu; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> max_ord <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>&gt; menu_ord <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dep&lt;= menu_dep; IF (direct=0) THEN <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> dep=dep<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt; menu_ord <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &lt; max_ord; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt; menu_ord; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=id_menu; ELSEIF (direct=1) THEN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> count_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt;= menu_ord <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &lt; max_ord; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt;= menu_ord <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &lt; max_ord; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> tree <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">ord</span></span>-count_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ord</span></span> &gt;= max_ord; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$$</code> </pre><br>  where direct = 0 deletes one node, direct = 1 deletes a node and all its descendants <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> sp_del(<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> sp_del(<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Well, in the end the total dump</b> <div class="spoiler_text">  CREATE TABLE IF NOT EXISTS `tree` ( <br>  `id` int (11) NOT NULL auto_increment, <br>  `name` varchar (255) collate utf8_bin NOT NULL, <br>  `ord` int (11) unsigned NOT NULL, <br>  `dep` int (11) NOT NULL, <br>  PRIMARY KEY (`id`) <br>  ) ENGINE = MyISAM DEFAULT CHARSET = utf8 COLLATE = utf8_bin AUTO_INCREMENT = 50; <br><br>  - - Dumping data for table `tree` <br>  - INSERT INTO `tree` (` id`, `name`,` ord`, `dep`) VALUES <br>  (1, 'Wines', 0, 0), <br>  (2, 'White wines', 1, 1), <br>  (3, 'French white wines', 2, 2), <br>  (4, 'Chardonnay', 3, 3), <br>  (5, 'Colombard', 4, 3), <br>  (6, 'Folle blanche', 5, 3), <br>  (7, 'Ugni blanc', 6, 3), <br>  (8, 'Muscadelle', 7, 3), <br>  (9, 'Chenin', 8, 3), <br>  (10, 'Italian white wines', 9, 2), <br>  (11, 'Castelli Romani Bianco', 10, 3), <br>  (12, 'Tusculum Bianco', 11, 3), <br>  (13, 'Red wines', 12, 1), <br>  (14, 'French red wines', 13, 2), <br>  (15, 'Cabernet', 14, 3), <br>  (16, 'Franc', 15, 4), <br>  (17, 'Sauvignon', 16, 4), <br>  (18, 'Carmenere', 17, 3), <br>  (19, 'Beaujolais nouveau', 18, 3), <br>  (20, 'Italian red wines', 19, 2), <br>  (21, 'Bardolino', 20, 3), <br>  (22, 'Syrah Cabernet', 21, 3), <br>  (24, 'artesius_plug', 23, 0), <br>  (23, 'Castelli Romani Rosso', 22, 3); <br><br>  DELIMITER $$ <br>  - - Procedures <br>  - CREATE DEFINER = `root` @` localhost` PROCEDURE `sp_add` ( <br>  IN relativ_menu int, <br>  IN direct tinyint, <br>  IN name_menu varchar (255) charset utf8 <br>  ) <br>  BEGIN <br><br>  DECLARE relativ_menu_ord INT; <br>  DECLARE relativ_menu_dep INT; <br><br>  IF (direct = 0) THEN <br><br>  SELECT ord, dep INTO relativ_menu_ord, relativ_menu_dep FROM tree WHERE id = relativ_menu; <br>  UPDATE tree SET ord = ord + 1 WHERE ord&gt; = relativ_menu_ord; <br>  INSERT INTO tree (name, ord, dep) VALUES (name_menu, relativ_menu_ord, relativ_menu_dep); <br><br>  ELSEIF (direct = 1) THEN <br><br>  SELECT MIN (ord) INTO relativ_menu_ord FROM tree WHERE ord&gt; (SELECT ord FROM tree WHERE id = relativ_menu) AND dep &lt;= (SELECT dep FROM tree WHERE id = relativ_menu); <br><br>  SELECT dep INTO relativ_menu_dep FROM tree WHERE id = relativ_menu; <br>  UPDATE tree SET ord = ord + 1 WHERE ord&gt; = relativ_menu_ord; <br>  INSERT INTO tree (name, ord, dep) VALUES (name_menu, relativ_menu_ord, relativ_menu_dep); <br><br>  ELSEIF (direct = 2) THEN <br><br>  SELECT ord, dep INTO relativ_menu_ord, relativ_menu_dep FROM tree WHERE id = relativ_menu; <br>  UPDATE tree SET ord = ord + 1 WHERE ord&gt; relativ_menu_ord; <br>  INSERT INTO tree (name, ord, dep) VALUES (name_menu, relativ_menu_ord + 1, relativ_menu_dep + 1); <br><br>  END IF; <br><br>  END $$ <br><br>  CREATE DEFINER = `root` @` localhost` PROCEDURE `sp_del` (IN id_menu int, IN direct tinyint) <br>  BEGIN <br><br>  DECLARE min_ord INT; <br>  DECLARE max_ord INT; <br>  DECLARE count_id INT; <br>  DECLARE menu_ord INT; <br>  DECLARE menu_dep INT; <br>  DECLARE id_node_pr INT; <br><br>  SELECT ord, dep INTO menu_ord, menu_dep FROM tree WHERE id = id_menu; <br><br>  SELECT MIN (ord) INTO max_ord FROM tree WHERE ord&gt; menu_ord AND dep &lt;= menu_dep; <br><br>  IF (direct = 0) THEN <br><br>  UPDATE tree SET dep = dep-1 WHERE ord&gt; menu_ord AND ord &lt;max_ord; <br>  UPDATE tree SET ord = ord-1 WHERE ord&gt; menu_ord; <br>  DELETE FROM tree WHERE id = id_menu; <br><br>  ELSEIF (direct = 1) THEN <br><br>  SELECT COUNT (id) INTO count_id FROM tree WHERE ord&gt; = menu_ord AND ord &lt;max_ord; <br><br>  DELETE FROM tree WHERE ord&gt; = menu_ord AND ord &lt;max_ord; <br><br>  UPDATE tree SET ord = ord-count_id WHERE ord&gt; = max_ord; <br><br>  END IF; <br><br>  END $$ <br><br>  DELIMITER; <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/264989/">https://habr.com/ru/post/264989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264977/index.html">The University of Innopolis opened a school of high-performance computing in scientific and engineering problems</a></li>
<li><a href="../264981/index.html">Asterisk. Start</a></li>
<li><a href="../264983/index.html">In search of an analogue of first-order functions in the Cach√© DBMS</a></li>
<li><a href="../264985/index.html">Sync CI Notifications with Telegram</a></li>
<li><a href="../264987/index.html">Median: precisely, sometimes precisely and almost exactly</a></li>
<li><a href="../264991/index.html">Total Mobilization with MobilizeToday</a></li>
<li><a href="../264993/index.html">Tasks, microtasks, queues and plans</a></li>
<li><a href="../264997/index.html">Bayes and the challenge about Morpheus</a></li>
<li><a href="../265001/index.html">Build system for large modular projects</a></li>
<li><a href="../265007/index.html">How to easily understand logistic regression</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>