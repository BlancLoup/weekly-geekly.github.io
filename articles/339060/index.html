<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About interval indices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Under the cut, we will understand whether a special index is needed for indexing intervals, how to deal with multidimensional intervals, is it true th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About interval indices</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/d0/a1/59d0a1d49a6dd095800910.png"></div><br><br>  Under the cut, we will understand whether a special index is needed for indexing intervals, how to deal with multidimensional intervals, is it true that a 2-dimensional rectangle can be treated as a 4-dimensional point, etc.  All this with the PostgreSQL example. <br><a name="habracut"></a><br>  In the development of the topic ( <a href="https://habrahabr.ru/post/302606/">1</a> , <a href="https://habrahabr.ru/post/319096/">2</a> , <a href="https://habrahabr.ru/post/319810/">3</a> , <a href="https://habrahabr.ru/post/323192/">4</a> , <a href="https://postgrespro.ru/blog/news/190297">5</a> , <a href="https://habrahabr.ru/post/331420/">6</a> , <a href="https://habrahabr.ru/post/338088/">7</a> ). <br><br>  Sometimes data are not values, but, say, a confidence interval.  Or is it really the intervals of values.  Again, the rectangle is also an interval, only not one-dimensional.  Is it possible to check for logarithmic time the presence of intervals in the data intersecting with the desired one? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Yes of course.  Sometimes they <a href="https://infostart.ru/public/551583/">come up with</a> ingenious schemes for this with calculating and indexing block (with further accurate filtering) values ‚Äã‚Äãbased on, for example, <a href="https://en.wikipedia.org/wiki/Gray_code">Gray codes</a> .  In this case, the interval with loss of accuracy is encoded into a certain (indexable) number; when searching for an interval, it generates a set of values ‚Äã‚Äã(subintervals) that should be checked.  This set is limited to logarithm. <br><br>  But GiST <a href="https://habrahabr.ru/company/postgrespro/blog/333878/">can</a> use R-trees for indexing time intervals (tsrange). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> reservations(during tsrange); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> reservations(during) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'[2016-12-30, 2017-01-09)'</span></span>), (<span class="hljs-string"><span class="hljs-string">'[2017-02-23, 2017-02-27)'</span></span>), (<span class="hljs-string"><span class="hljs-string">'[2017-04-29, 2017-05-02)'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> reservations <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> gist(during); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> reservations <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> during &amp;&amp; <span class="hljs-string"><span class="hljs-string">'[2017-01-01, 2017-04-01)'</span></span>;</code> </pre> <br>  Of course, the author, with his <s>crusade against R-trees</s> , with his love for multidimensional indexes could not get past such a topic. <br><br>  So how does an R-tree handle intervals?  Just like with other spatial objects.  An interval is a one-dimensional rectangle; when splitting a page, an R-tree tries to minimize the dispersion inside the descendant pages and maximize it between them. <br><br>  Is it possible to turn the interval to a point?  Considering, for example, its beginning is X, and the end is Y. Formally, after all, who can forbid us to use two numbers as a two-dimensional point?  But in such data there will be an internal dependence.  And semantics in data will lead to semantics in search queries and interpretation of results. <br><br>  The easiest way to understand the situation, looking at her eyes. <br>  Here are 100 random intervals ranging in size from 0 to 10,000 with the beginning of the interval from 0 to 100,000. <br><br><img src="https://habrastorage.org/webt/59/d0/a3/59d0a396bceed668705972.png"><br>  1 <br><br>  The search query is [41 000 ... 47 000], we are interested in all the intervals intersecting with the specified range. <br><br>  The numbers indicate the search zones that arise.  All that is below the diagonal for obvious reasons does not exist. <br><br>  So, by zones: <br><br><ol><li>  here are the intervals that are strictly inside the search query </li><li>  here everything that began and ended before the interval we need </li><li>  these intervals began before, and ended during the search query </li><li>  here those intervals that completely cover the search </li><li>  these intervals began at the time, and ended after the request </li><li>  here everything that began and ended after him </li></ol><br>  Thus, to search for all intersections, the query must be expanded to [0 ... 47 000, 41 000 ... 100 000], i.e.  it should include zones 1,3,4,5. <br><br>  The fact that the request has become the size of a quarter of the entire layer should not be frightening, because only a narrow strip along the diagonal is inhabited.  Yes, there may be large intervals the size of the entire layer, but they are relatively small. <br><br>  Of course, large objects will have an impact on performance, but nothing can be done about it, because they really exist and really should get into issuing almost any request.  If you try to index the ‚Äúmacaroni monster‚Äù, the index will actually stop working, it will be cheaper to look at the table and filter out the excess. <br>  However, apparently, any method of indexation is sick of such data. <br><br>  Are there any other disadvantages of this approach?  Since the data has ‚Äúdegenerated‚Äù in some way, it is possible that the heuristics of splitting the pages of the R-tree will be less effective.  But the biggest inconvenience is that we must constantly keep in mind that we are dealing with an interval and correctly set search queries. <br><br>  However, this already refers not to the R-tree, but to any spatial index.  Including the Z-curve (built on a Z-order B-tree), which we used earlier.  For Z-curve, data degeneration does not matter, because these are just numbers with their natural order. <br><br>  Among other things, the Z-curve is also more compact than the R-tree.  Therefore, we will try to clarify its perspectives in the designated area. <br><br>  For example, we have assumed that the <b>X-coordinate is the beginning of the segment, and the Y-its end.</b>  <b>What if the opposite</b> ?  The R-tree should not care, for Z-curve, too, little will change.  The crawling of pages will be organized differently, but on average the number of pages read will be the same. <br><br>  <b>How about mirroring the data on one of the axes</b> .  In the end, we have the same Z-curve (mirrored by Y), so let the data lie on the slanting crossbar of the letter Z. Well, let's do a numerical experiment. <br><br>  Take 1000 random intervals and divide them into 10 pages depending on the Z-value.  Those.  sort and divide by 100 pieces, then see what we did.  Prepare 2 sets - X, Y and max (X) -X, Y <br><br><img src="https://habrastorage.org/webt/59/d0/a5/59d0a524be935845535391.png"><br>  Figure 2: Normal Z-curve <br><br><img src="https://habrastorage.org/webt/59/d0/a5/59d0a57e18adf309193887.png"><br>  Figure 3 Mirrored data. <br><br>  It is clearly seen how ‚Äúworse‚Äù the displayed data is arranged, the pages crawl over each other, the perimeter of the pages is much larger, and this is a guarantee that on average, other things being equal, this option will read more pages. <br><br>  Why did this happen?  In this case, the reason lies on the surface.  For the 2-dimensional rectangle Z-value of the lower left corner &lt;= than for the upper right.  Therefore, the ideal way to more carefully cut into pages almost linear data is to arrange them along the line X = Y. <br><br>  <b>And if you index not the beginning-end of the range, but its center-length</b> ?  In this case, the data will stretch along the X axis, as if we had rotated Figure 2 clockwise by 45 degrees.  The problem is that at the same time the search area will also rotate 45 degrees and it will no longer be possible to search for it with a single query. <br><br>  <b>Is it possible to index intervals with more than one dimension</b> ?  Of course.  A 2-dimensional rectangle turns into a 4-dimensional point.  The main thing is not to forget which of the coordinates that we put. <br><br>  <b>Is it possible to mix intervals with noninterval values</b> ?  Yes, because the search algorithm for Z-curve does not know the semantics of values, it works with faceless numbers.  If the search extent is specified in accordance with this semantics and the interpretation of the results goes with its consideration, no problems arise. <br><br><h3>  Numerical experiment </h3><br>  Let's try to test the performance of the Z-curve in conditions close to the ‚Äúmacaroni monster‚Äù.  The data model is: <br><br><ul><li>  8-dimensional index, the performance and performance of which we have already <a href="https://habrahabr.ru/post/331420/">tested</a> </li><li>  as usual, 100 million points </li><li>  objects - 3-dimensional parallelepipeds - occupy 6 dimensions </li><li>  we will give the remaining 2 dimensions under the time interval </li><li>  parallelepipeds of 100 pieces - they form a 10X10 grid on X &amp; Y </li><li>  each parallelepiped lives one unit of time </li><li>  for each unit of time the parallelepiped grows by 10 units in Z, starting from height 0 </li></ul><br><img src="https://habrastorage.org/webt/59/d0/a6/59d0a6d6eadf5618132616.png"><br>  Figure 4 data slice at time T = 1000 <br><br>  On this test we will check the indexation of extended objects, as it affects the search performance. <br><br>  Create an 8-dimensional table, fill the data and index <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> test_points_8d (p <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[<span class="hljs-number"><span class="hljs-number">8</span></span>]); COPY test_points_8d from '/home/.../data.csv'; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> zcurve_test_points_8d <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> test_points_8d (zcurve_num_from_8coords (p[<span class="hljs-number"><span class="hljs-number">1</span></span>], p[<span class="hljs-number"><span class="hljs-number">2</span></span>], p[<span class="hljs-number"><span class="hljs-number">3</span></span>], p[<span class="hljs-number"><span class="hljs-number">4</span></span>], p[<span class="hljs-number"><span class="hljs-number">5</span></span>], p[<span class="hljs-number"><span class="hljs-number">6</span></span>], p[<span class="hljs-number"><span class="hljs-number">7</span></span>], p[<span class="hljs-number"><span class="hljs-number">8</span></span>]));</code> </pre> <br>  Key order: xmax, xmin, ymax, ymin, zmax, zmin, tmax, tmin <br>  data file (data.csv): <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">50</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">60</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">70</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>} {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">90</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>} ...</code> </pre> <br>  Test request [200 000 ... 300 000;  200,000 ... 300,000;  100 ... 1000;  10 ... 11]: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> test_points_8d t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c = t.ctid) t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zcurve_8d_lookup_tidonly(<span class="hljs-string"><span class="hljs-string">'zcurve_test_points_8d'</span></span>, <span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c) x;</code> </pre> <br>  Answer: <br><br><pre> <code class="cpp hljs"> c | t_row -------------+------------------------------------------- (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">103092</span></span>,<span class="hljs-number"><span class="hljs-number">87</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">103092</span></span>,<span class="hljs-number"><span class="hljs-number">88</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">10309</span></span>,<span class="hljs-number"><span class="hljs-number">38</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">10309</span></span>,<span class="hljs-number"><span class="hljs-number">39</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">113402</span></span>,<span class="hljs-number"><span class="hljs-number">17</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">113402</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">206185</span></span>,<span class="hljs-number"><span class="hljs-number">66</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">206185</span></span>,<span class="hljs-number"><span class="hljs-number">67</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">216494</span></span>,<span class="hljs-number"><span class="hljs-number">93</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">216494</span></span>,<span class="hljs-number"><span class="hljs-number">94</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">20618</span></span>,<span class="hljs-number"><span class="hljs-number">65</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">20618</span></span>,<span class="hljs-number"><span class="hljs-number">66</span></span>) | {<span class="hljs-number"><span class="hljs-number">210000</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">123711</span></span>,<span class="hljs-number"><span class="hljs-number">44</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">123711</span></span>,<span class="hljs-number"><span class="hljs-number">45</span></span>) | {<span class="hljs-number"><span class="hljs-number">260000</span></span>,<span class="hljs-number"><span class="hljs-number">250000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">226804</span></span>,<span class="hljs-number"><span class="hljs-number">23</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>} (<span class="hljs-number"><span class="hljs-number">226804</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>) | {<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">310000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">110</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>} (<span class="hljs-number"><span class="hljs-number">18</span></span> rows)</code> </pre> <br>  Why such a data model is good, you can easily evaluate the correctness of the result. <br><br>  On a freshly raised server, the same query via EXPLAIN (ANALYZE, BUFFERS) <br>  shows: that <b>501</b> pages have been read. <br><br>  Ok, let's move the index.  And what if you look at the same query on the index with the order of the key - xmin, ymin, zmin, xmax, ymax, zmax, tmin, tmax.  The launch shows <b>531</b> readings.  Too much. <br><br>  Well, let's eliminate the geometric imbalance, let the columns now grow not by 10, but by 1 unit per tact.  Request (key: xmax, xmin, ymax, ymin, zmax, zmin, tmax, tmin) <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ANALYZE</span></span>,BUFFERS) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> test_points_8d t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c = t.ctid) t_row <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> zcurve_8d_lookup_tidonly(<span class="hljs-string"><span class="hljs-string">'zcurve_test_points_8d'</span></span>, <span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">200000</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">300000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>,<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c) x;</code> </pre> <br>  says <b>156</b> pages have been read! <br><br>  Now for some statistics, let's look at the average number of cache reads / hits for different types of keys in a series of 10,000 random queries. <br>  size 100 000100 000100 00010 <br><br>  When key order is <br>  (xmin, 1,000,000-xmax, ymin, 1,000,000-ymax, zmin, 1,000,000-zmax, tmin, 1,000,000-tmax) <br>  The average number of reads is 21.8217, and cache hits are 2437.51. <br>  The average number of objects in the issue - 17.81 <br><br>  When the key order is (xmax, xmin, ymax, ymin, zmax, zmin, tmax, tmin) <br>  The average number of readings is 14.2434, and cache hits are 1057.19. <br>  The average number of objects in the issue - 17.81 <br><br>  When the key order is (xmin, xmax, ymin, ymax, zmin, zmax, tmin, tmax) <br>  The average number of reads is 14.0774, cache hit is 1053.22. <br>  The average number of objects in the issue - 17.81 <br><br>  As you can see, the page cache works very effectively in this case.  This number of readings is already acceptable. <br><br>  And finally, let's see with our eyes, just out of curiosity, how the Z-curve algorithm copes with 8-dimensional space. <br>  Below are the projections of parsing the query in the extent - <br>  [200,000 ... 300,000;  200,000 ... 300,000;  0 ... 700 001;  700,000 ... 700,001]. <br>  A total of 18 results, 1687 subqueries.  The generated subqueries are shown, the green crosses are readings in the B-tree, the blue crosses are the results found. <br>  Under each cross can hide several marks.  Nearly located marks merge, for example, time 700 000 and 700 001. <br><br><img src="https://habrastorage.org/webt/59/d0/a9/59d0a99a8cd5c605213351.png"><br>  Figure 5 X-axis <br><br><img src="https://habrastorage.org/webt/59/d0/aa/59d0aa07da5a8795044709.png"><br>  6 Y-axis <br><br><img src="https://habrastorage.org/webt/59/d0/aa/59d0aa5d0cf59766220276.png"><br>  7 Z-axis <br><br><img src="https://habrastorage.org/webt/59/d0/aa/59d0aaa69fe65273161826.png"><br>  Fig.8 Time </div><p>Source: <a href="https://habr.com/ru/post/339060/">https://habr.com/ru/post/339060/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339046/index.html">Work with resources, or how I pushed through @Cleanup</a></li>
<li><a href="../339048/index.html">Swift Generics: Styles for UIView and more. # 2</a></li>
<li><a href="../339050/index.html">Habr advise: how to win the NTI olympiad for schoolchildren in the Big Data profile</a></li>
<li><a href="../339052/index.html">The history of the clock synchronizer DCF77</a></li>
<li><a href="../339054/index.html">How the MobX library helps to manage the state of web applications. Lecture in Yandex</a></li>
<li><a href="../339064/index.html">MUK becomes an Oracle distributor</a></li>
<li><a href="../339066/index.html">Information security in process control systems: attack vector interface converters</a></li>
<li><a href="../339070/index.html">Winning the nomination ‚ÄúThe best startup with the prospect of entering the American market‚Äù, Spb Startup Day 2017 and thoughts about pitches</a></li>
<li><a href="../339072/index.html">Affixing a project to a partner and new 3CX call center reports</a></li>
<li><a href="../339074/index.html">How to legalize the sale of game items</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>