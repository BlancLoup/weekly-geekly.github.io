<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Re-checking TortoiseSVN with the help of the PVS-Studio code analyzer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For some time we sent a free key for the PVS-Studio analyzer to the TortoiseSVN developers. Before they had time to use it, I decided to quickly downl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Re-checking TortoiseSVN with the help of the PVS-Studio code analyzer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d97/7ae/e6d/d977aee6d2555399fc5c13904f5b5750.png" alt="TortoiseSVN and PVS-Studio"><br>  For some time we sent a free key for the PVS-Studio analyzer to the TortoiseSVN developers.  Before they had time to use it, I decided to quickly download the source code for TortoiseSVN and perform the analysis myself.  The goal is clear.  Another small article for PVS-Studio advertising. <br><a name="habracut"></a><br>  We have already <a href="http://habrahabr.ru/company/pvs-studio/blog/109163/">tested the</a> project TortoiseSVN.  It was a long time ago.  The verification of the project coincided with the release of PVS-Studio 4.00, where general diagnostic rules first appeared. <br><br>  From time to time we repeat the checks to demonstrate the benefits of regular use of the tool.  It makes no sense to check the project once or twice.  In the code being changed, new errors constantly appear.  And then slowly and sadly corrected.  Accordingly, the maximum benefit will be achieved with daily use of PVS-Studio.  Better yet, using <a href="http://www.viva64.com/ru/d/0218/">incremental analysis</a> . <br><br>  So, let's see what we managed to find interesting in the project with the help of <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> version 5.05.  The source codes for TortoiseSVN were taken on 06/19/2013 from <a href="http://tortoisesvn.googlecode.com/svn/trunk">http://tortoisesvn.googlecode.com/svn/trunk</a> .  By the way, the TortoiseSVN project is very high quality and has a huge user base of programmers.  So if you find at least something, this is a great achievement. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Strange conditions </h2><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ColouriseA68kDoc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((sc.state == SCE_A68K_NUMBER_DEC) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isdigit</span></span>(sc.ch)) .... || ((sc.state == SCE_A68K_MACRO_ARG) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isdigit</span></span>(sc.ch)) || ((sc.state == SCE_A68K_MACRO_ARG) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isdigit</span></span>(sc.ch)) .... }</code> </pre> <br>  Diagnostic message: V501 There are identical sub-expressions '((sc.state == 11) &amp;&amp; isdigit (sc.ch))' to the left |  operator.  lexa68k.cxx 160 <br><br>  There are two identical comparisons.  There may be a typo. <br><br>  A typo is probably present in the following code.  The value of the 'rv' variable is checked twice. <br><pre> <code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hentry</span></span></span></span> * AffixMgr::compound_check( .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rv &amp;&amp; forceucase &amp;&amp; (rv) &amp;&amp; ....) .... }</code> </pre> <br>  Diagnostic message: V501 operator &amp; r; &amp; force; &amp; (rv): <br><ul><li>  affixmgr.cxx 1784 </li><li>  affixmgr.cxx 1879 </li></ul><br>  The following code snippet: <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsAllASCII7</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CString&amp; s</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, count = s.GetLength(); i &lt; count; ++i) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s[i] &gt;= <span class="hljs-number"><span class="hljs-number">0x80</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  Diagnostic message: V547 Expression 's [i]&gt; = 0x80' is always false.  The value range of char type: [-128, 127].  logdlgfilter.cpp 34 <br><br>  The IsAllASCII7 () function always returns 'true'.  The condition 's [i]&gt; = 0x80' is always false.  The value of a variable of type 'char' cannot be greater than or equal to 0x80. <br><br>  The following code snippet with the wrong comparison: <br><pre> <code class="hljs vbscript"><span class="hljs-built_in"><span class="hljs-built_in">int</span></span> main(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> argc, char **argv) { .... DWORD ticks; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (run_timers(<span class="hljs-built_in"><span class="hljs-built_in">now</span></span>, &amp;<span class="hljs-keyword"><span class="hljs-keyword">next</span></span>)) { ticks = <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> - GETTICKCOUNT(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ticks &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ticks = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ticks = INFINITE; } .... }</code> </pre> <br>  Diagnostic message: V547 Expression 'ticks &lt;0' is always false.  Unsigned type value is never &lt;0. winplink.c 635 <br><br>  The variable 'ticks' is unsigned.  This means that the ‚Äúif (ticks &lt;0)‚Äù check does not make sense.  An overflow situation will not be processed. <br><br>  Consider an error due to which the function 'strncmp' does not fully compare strings. <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AffixMgr::parse_convtable(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * keyword) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * piece; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(piece, keyword, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(keyword)) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... }</code> </pre> <br>  Diagnostic message: V579  It is possibly a mistake.  Inspect the third argument.  affixmgr.cxx 3654 <br><br>  The 'sizeof' operator calculates the size of the pointer.  This value is not related to the length of the string. <br><h2>  Suspicious string formation </h2><br>  <a href="http://www.viva64.com/ru/t/0069/">Functions with a variable number of arguments are</a> always everywhere, and as always dangerous. <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CTSVNPath</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">mutable</span></span> CString m_sBackslashPath; <span class="hljs-keyword"><span class="hljs-keyword">mutable</span></span> CString m_sLongBackslashPath; <span class="hljs-keyword"><span class="hljs-keyword">mutable</span></span> CString m_sFwdslashPath; .... }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FileStatusCacheEntry * SVNFolderStatus::BuildCache( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CTSVNPath&amp; filepath, ....) { .... CTraceToOutputDebugString::Instance() (_T(__FUNCTION__) _T(<span class="hljs-string"><span class="hljs-string">": building cache for %s\n"</span></span>), filepath); .... }</code> </pre> <br>  Diagnostic message: V510 The 'operator ()' function is not expected to receive class-type variable as second actual argument: <br><ul><li>  svnfolderstatus.cpp 150 </li><li>  svnfolderstatus.cpp 355 </li><li>  svnfolderstatus.cpp 360 </li></ul><br>  The qualifier "% s" indicates that the function expects a string as the actual argument.  However, the variable 'filepath' is not a string at all, but a complex object consisting of multiple lines.  It‚Äôs hard to say what will be printed and whether this code will fall at all. <br><br>  It is dangerous to use functions such as 'printf ()' as follows: "printf (myStr);".  If control qualifiers are present inside 'myStr', the program can print out what it is not supposed to or terminate abnormally. <br><br>  Consider the code from TortoiseSVN: <br><pre> <code class="hljs cpp">BOOL CPOFile::ParseFile(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(File.getloc().name().c_str()); .... }</code> </pre> <br>  Diagnostic message: V618 It‚Äôs dangerous to call it.  The example of the safe code: printf ("% s", str);  pofile.cpp 158 <br><br>  If the file name is "myfile% s% i% s.txt", then the result will be pitiable. <br><br>  <b><i>Note.</i></b>  <b><i>We have an interesting note on the <a href="http://www.viva64.com/ru/b/0129/"><i>dangers of using the printf () function</i></a> .</i></b> <br><br><h2>  Wrong reset of arrays </h2><br>  I do not know how dangerous it is for TortoiseSVN to leave the contents of the buffers without resetting them.  Perhaps generally safe.  However, there is code to reset the buffers.  And since it does not work, it is worth mentioning about it.  Errors look like this: <br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sha_mpint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SHA_State * s, Bignum b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> lenbuf[<span class="hljs-number"><span class="hljs-number">4</span></span>]; .... <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(lenbuf, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(lenbuf)); }</code> </pre> <br>  Diagnostic message: V597 The compiler could delete the memset function call, which is used to flush the lenbuf buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  sshdss.c 23 <br><br>  Before exiting the function, the 'lenbuf' array should be cleared.  Since the array is then no longer used, the optimizer will remove the call to the 'memset' function.  To prevent this from happening, you need to use special functions. <br><br>  Other places where the compiler will remove the call 'memset ()': <br><ul><li>  sshdss.c 37 </li><li>  sshdss.c 587 </li><li>  sshdes.c 861 </li><li>  sshdes.c 874 </li><li>  sshdes.c 890 </li><li>  sshdes.c 906 </li><li>  sshmd5.c 252 </li><li>  sshrsa.c 113 </li><li>  sshpubk.c 153 </li><li>  sshpubk.c 361 </li><li>  sshpubk.c 1121 </li><li>  sshsha.c 256 </li></ul><br><h2>  Strange </h2><br><pre> <code class="hljs objectivec"><span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> InitInstance(HINSTANCE hResource, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nCmdShow) { .... app.hwndTT; <span class="hljs-comment"><span class="hljs-comment">// handle to the ToolTip control .... }</span></span></code> </pre> <br>  Diagnostic message: V607 Ownerless expression 'app.hwndTT'.  tortoiseblame.cpp 1782 <br><br>  Most likely, in the 'InitInstance ()' function, the 'hwndTT' member should be initialized with something.  However, due to a typo, the code was unfinished. <br><br><h2>  64-bit errors </h2><br>  I make the search for mistakes very superficially.  I am attentive, just enough to give me enough examples to write an article.  No, I'm not a byaka.  Simply, the authors of the project will still perform the analysis more qualitatively than I can do. <br><br>  I look at <a href="http://www.viva64.com/ru/t/0002/">64-bit errors</a> even more superficially.  It is very difficult to judge, not knowing the structure of the project, it is possible the occurrence of a particular error or not. <br><br>  I will give only a couple of dangerous places: <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> LoginDialog::CreateModule(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { .... DialogBoxParam(g_hmodThisDll, MAKEINTRESOURCE(IDD_LOGIN), g_hwndMain, (DLGPROC)(LoginDialogProc), (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); .... }</code> </pre> <br>  Diagnostic message: V220 Suspicious sequence of types of castings: memsize -&gt; 32-bit integer -&gt; memsize.  The value being casted: 'this'.  logindialog.cpp 105 <br><br>  The 'this' pointer is <a href="http://www.viva64.com/ru/t/0015/">explicitly cast</a> to the 'long' type.  It then <a href="http://www.viva64.com/ru/t/0021/">implicitly</a> expands to type LPARAM (LONG_PTR).  The important thing is that the pointer turns into a 'long' for a while.  This is bad if the program is 64-bit.  The pointer occupies 64-bit.  The 'long' type in <a href="http://www.viva64.com/ru/t/0055/">Win64</a> is still a 32-bit type.  As a result, the high bits of the 64-bit variable will be lost. <br><br>  If the object is created outside the lower 4 GB of RAM, the program will become unpredictable.  The probability of such an event is certainly not great, but such an error is extremely difficult to reproduce. <br><br>  The correct code is: DialogBoxParam (...., (LPARAM) this); <br><br>  Consider another dangerous type cast: <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmpforsearch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *av, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bv</span></span></span><span class="hljs-function">)</span></span> { Actual_Socket b = (Actual_Socket) bv; unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> = (unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) av, bs = (unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) b-&gt;s; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &lt; bs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &gt; bs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> +<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Diagnostic message: V205 Explicit conversion of pointer type to 32-bit integer type: (unsigned long) av: <br><ul><li>  winnet.c 139 </li><li>  winhandl.c 359 </li><li>  winhandl.c 348 </li></ul><br>  Pointers are explicitly cast to the type 'unsigned long' and placed in the variables 'as' and 'bs'.  Since the upper bits of the address may be lost, the comparison may not work correctly.  It‚Äôs not at all clear why here pointers are cast to integer types.  You can simply compare pointers. <br><br><h2>  Outdated null pointer checks </h2><br>  The 'new' operator, when it cannot allocate memory, has not returned NULL long ago.  It throws an exception std :: bad_alloc.  Of course, you can have the 'new' operator return 0, but this is irrelevant now. <br><br>  However, the following code continues to live in programs: <br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _tmain(....) { .... pBuf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[maxlength]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pBuf == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { _tprintf(_T(<span class="hljs-string"><span class="hljs-string">"Could not allocate enough memory!\n"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] wc; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] dst; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] src; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERR_ALLOC; } .... }</code> </pre> <br>  Diagnostic Message: V680 pbuf  The exception will be generated in the case of memory allocation error. <br><ul><li>  subwcrev.cpp 912 </li><li>  repositorybrowser.cpp 2565 </li><li>  repositorybrowser.cpp 4225 </li><li>  svnstatuslistctrl.cpp 5254 </li><li>  svnprogressdlg.cpp 2357 </li><li>  bugtraqassociations.cpp 116 </li><li>  xmessagebox.cpp 792 </li><li>  xmessagebox.cpp 797 </li><li>  hyperlink_base.cpp 166 </li><li>  affixmgr.cxx 272 </li><li>  hashmgr.cxx 363 </li><li>  hashmgr.cxx 611 </li></ul><br><h2>  And so it will come down </h2><br>  About the many errors that I encounter when studying the code, I do not write in articles.  The fact is that they do not interfere with the work of the program.  This time I decided to write about a couple of such cases.  It's just very funny to watch situations when the program works not because it is written correctly, but because of luck. <br><pre> <code class="hljs ruby">void CBaseView::OnContextMenu(CPoint point, DiffStates state) { .... popup.AppendMenu(MF_STRING <span class="hljs-params"><span class="hljs-params">| oWhites.HasTrailWhiteChars ? MF_ENABLED : (MF_DISABLED|</span></span>MF_GRAYED), POPUPCOMMAND_REMOVETRAILWHITES, temp); .... }</code> </pre> <br>  Diagnostic message: V502 Perhaps the '?:' Operator works in a different way than it was expected.  The '?:' Operator has a lower than the '|'  operator.  baseview.cpp 2246 <br><br>  Depending on the value of the variable 'oWhites.HasTrailWhiteChars', you need to get one of the combinations of constants: <br><ul><li>  MF_STRING |  MF_ENABLED </li><li>  MF_STRING |  MF_DISABLED |  MF_GRAYED </li></ul><br>  But the code does not work at all.  Priority of operation '|'  higher than the priority of the '?:' operation.  Place brackets for clarity: <br><br>  (MF_STRING | oWhites.HasTrailWhiteChars)?  MF_ENABLED: MF_DISABLED |  MF_GRAYED <br><br>  The code works correctly only because the constant 'MF_STRING' is equal to 0. It has no effect on the result.  As a result, the wrong expression works correctly. <br><br>  Consider another example of luck.  In the TortoiseSVN program, the HWND type is often used as the 'unsigned' type.  To do this, explicit type conversions must be performed.  For example, as shown in the following functions: <br><pre> <code class="hljs objectivec">HWND m_hWnd; <span class="hljs-built_in"><span class="hljs-built_in">UINT_PTR</span></span> uId; INT_PTR CBaseView::OnToolHitTest(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... pTI-&gt;uId = (<span class="hljs-built_in"><span class="hljs-built_in">UINT</span></span>)m_hWnd; .... } <span class="hljs-built_in"><span class="hljs-built_in">UINT_PTR</span></span> idFrom; HWND m_hWnd; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> CBaseView::OnToolTipNotify( <span class="hljs-built_in"><span class="hljs-built_in">UINT</span></span>, NMHDR *pNMHDR, LRESULT *pResult) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pNMHDR-&gt;idFrom != (<span class="hljs-built_in"><span class="hljs-built_in">UINT</span></span>)m_hWnd) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; .... }</code> </pre> <br>  Or, for example, the value of a variable of type HWND is printed as if it were a type of 'long'. <br><pre> <code class="hljs coffeescript">bool CCommonAppUtils::RunTortoiseProc(....) { .... CString sCmdLine; sCmdLine.Format(L<span class="hljs-string"><span class="hljs-string">"%s /hwnd:%ld"</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LPCTSTR)</span></span></span><span class="hljs-function">sCommandLine, AfxGetMainWnd</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">-&gt;</span></span>GetSafeHwnd()); .... }</code> </pre> <br>  Formally, this code is incorrect.  The fact is that the type 'HWND' is a pointer.  So, it cannot be turned into 32-bit integer types.  And the PVS-Studio analyzer is worried about this, issuing warnings. <br><br>  But the interesting thing is that this code will work perfectly! <br><br>  The HWND type is used to store descriptors that are used in Windows to work with various system objects.  The same types are HANDLE, HMENU, HPALETTE, HBITMAP and so on. <br><br>  Although descriptors are 64-bit pointers, for greater compatibility (for example, to allow interaction between 32-bit and 64-bit processes) they use only the lower 32-bits.  See " <a href="http://www.viva64.com/go.php%3Furl%3D381">Microsoft Interface Definition Language (MIDL): 64-Bit Porting Guide</a> " (USER and GDI handles are sign extended 32b values) for details. <br><br>  By placing the HWND type in 32-bit types, the developers were hardly based precisely on these assumptions.  Most likely, this is not a very neat code that works correctly thanks to the luck and efforts of the developers of the Windows API. <br><br><h2>  Conclusion </h2><br>  Use static analysis regularly during development, and you will find a lot of errors at the earliest stages.  I naturally recommend first of all to get acquainted with the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> code analyzer.  However, there are many other good code analyzers: <a href="http://www.viva64.com/ru/t/0074/">static code analysis tools</a> . <br><br><h2>  Links </h2><br>  Additional links that can explain some of the subtle points described in the article. <br><ol><li>  Knowledge base.  <a href="http://www.viva64.com/ru/k/0041/">Overwrite memory - why?</a> </li><li>  Documentation.  V668.  <a href="http://www.viva64.com/ru/d/0293/">It was not allowed to use the operator.</a> </li><li>  Knowledge base.  <a href="http://www.viva64.com/ru/k/0005/">How to correctly cast a pointer to an int in a 64-bit program?</a> </li><li>  Karpov Andrey, Evgeny Ryzhkov.  <a href="http://www.viva64.com/ru/l/">Lessons learned from developing 64-bit C / C ++ applications</a> . </li></ol></div><p>Source: <a href="https://habr.com/ru/post/184542/">https://habr.com/ru/post/184542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184526/index.html">Construction of the most powerful laser in the world began in Romania</a></li>
<li><a href="../184528/index.html">Easy layout in forced places: helpers, decorators, form elements</a></li>
<li><a href="../184530/index.html">Video interview from Silicon Valley. Interview with the CEO of the company, worth> 1,000,000,000 $. Phil Libin - CEO of Evernote</a></li>
<li><a href="../184538/index.html">Lua in 15 minutes</a></li>
<li><a href="../184540/index.html">Access to SOAP web services 1C from JavaScript and Html</a></li>
<li><a href="../184546/index.html">An inside look at the tips of search queries in Evernote</a></li>
<li><a href="../184548/index.html">SQL Reporting services in the clouds. Part 3: Multi-tenant</a></li>
<li><a href="../184550/index.html">O Backbone.js is very simple and brief for fans of MVC frameworks.</a></li>
<li><a href="../184552/index.html">DXperience 13.1 - New version of .NET components from DevExpress</a></li>
<li><a href="../184554/index.html">Crazy DIY toy: a homemade cell phone with a built-in dosimeter. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>