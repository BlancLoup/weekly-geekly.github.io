<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we implemented the navigation from Jetpack into the combat application. Report Yandex. Food</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mobile applications are increasingly using deep links. These are links that allow you not only to go into the application from the outside, but to get...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we implemented the navigation from Jetpack into the combat application. Report Yandex. Food</h1><div class="post__text post__text-html js-mediator-article">  Mobile applications are increasingly using deep links.  These are links that allow you not only to go into the application from the outside, but to get to a specific screen.  Android developer from Yandex. Edy Vladislav Kozhushko explained why we implemented navigation from Jetpack to implement deep links, what problems we encountered, how they were solved and what happened in the end. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5uKceY3fZbo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - Hello!  My name is Vlad.  I‚Äôm interested in Android development since 2013, in Yandex. I‚Äôm working since last summer.  I will tell you about our way of introducing the Navigation Components library into the combat application. <br><br><a name="habracut"></a>  It all started with the fact that we had a technical task of refactoring navigation.  Then product managers came to us and said that we will make diplinks, there will be a lot of them, they will lead to different screens. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And then we thought - navigation, presented on Google I / O 2018, is very well suited for the implementation of tasks on diplinks.  We decide to see what happens.  Our colleagues with iOS in Xcode have a convenient graphical editor in which they can use the mouse to stumble across the entire layout of the screens, as well as set the transitions between the screens.  Now we also have this opportunity, we can use the mouse to set transitions, diplinks to the screens and link them with fragments.  In addition, we can set arguments on the screen. <br><br><img src="https://habrastorage.org/webt/x_/az/di/x_azdiz_lzuq41qa1em7im23l7k.jpeg"><br><br>  That is, the arguments must either be stumbled into the UI editor, or entered into XML.  In addition to the transition between screens, an action tag appeared in which we indicate its id and the screen to which we need to go. <br><br><img src="https://habrastorage.org/webt/7k/sf/s7/7ksfs7qzvn4tqxkxxfzziaw-d_y.jpeg"><br><br>  We also specified the diplink that we want to open the screen.  In this case, there is an itemId parameter, if we pass a parameter of this type, and it will lead to a fragment, then the value of this parameter will be passed to the fragment's arguments, and by the itemId key we will be able to get it and use it.  Another library supports uplinks.  If we set uplink, for example, navdemo.ru/start/{itemId}, then we will no longer need to take care to register http / https schemes to open such diplinks.  The library will do everything for us. <br><br>  Now let's talk about the arguments.  We added two arguments, integer and boolean, and also gave them default values. <br><br><img src="https://habrastorage.org/webt/wt/fc/xx/wtfcxx7fsl5z7vjgb6x0tbr6-u0.jpeg"><br><br>  After that, when assembling the fragment, we will have the NextFragmentArgs class.  It has a Builder, with which you can build and set the arguments we need.  Also in the NextFragmentArgs class itself, there are getters for getting our arguments.  You can build NextFragmentArgs from the bundle and convert the bundle, which is very convenient. <br><br><img src="https://habrastorage.org/webt/ti/qb/a7/tiqba7tr-2zbzaryvnwmllffqrs.jpeg"><br><br>  About the main features of the library.  She has a convenient UI-editor in which we can do all the navigation.  We have a readable XML markup that inflates the same way as Views.  And we have no such pains as iOS developers, when they corrected something in a graphic editor, and a lot of things have changed. <br><br>  Deeplinks can work both with fragments and with Activity, and for this you do not need to register a large amount of IntentFilter in the manifest.  We also support uplinks, and with Android 6 you can enable autoverify for verification.  In addition, when assembling projects, code generation takes place with arguments to the desired screen.  Navigation supports nested graphs and nested navigation, which allows you to logically decompose all navigation into separate subcomponents. <br><br><img src="https://habrastorage.org/webt/bv/5o/ct/bv5oct566mctqouri8o483_b91k.jpeg"><br><br>  Now we will talk about our path, which we have passed, introducing the library.  It all started with alpha version 3. We implemented everything, we replaced all the navigation with Navigation components, everything is super, everything works, the diplinks open, but problems appear. <br><br><img src="https://habrastorage.org/webt/nj/zz/f7/njzzf7kherhavxsfdwqkdicnrtq.jpeg"><br><br>  The first problem is IllegalArgumentException.  It appeared in two cases: inconsistency of the graph, because there was a desynchronization of the representation of the graph and fragments in the stack, because of this, this exception occurred.  The second problem is double clicks.  When we made the first click, we are navigating.  The transition to the next screen occurs, and the state of the graph changes.  When we make a second click, the graph is already in a new state, and it is trying to make the old transition, which no longer exists, so we get such an exception.  In this version, there were no diplinks opened, the scheme of which contains a dot, for example, project.company.  This was decided in the next versions of the library, and in the stable version everything works well. <br><br>  Also not supported shared elements.  You've probably seen how Google Play works: there is a list of applications, you click on the application, you have a screen, and a beautiful animation of moving the icon takes place.  We also have this in the application on the list of restaurants, but we needed the support of shared elements.  Also, SafeArgs did not work for us, so we lived without them. <br><br><img src="https://habrastorage.org/webt/me/kw/kg/mekwkgnoug7sm5mq1wkxybu7d8g.jpeg"><br><br>  It was easy to fix the diplink.  It was necessary to replace the scheme, which was in the library, with its own scheme, which supports the point.  With reflection, we knock on the class, change the value of the regex, and everything works. <br><br><img src="https://habrastorage.org/webt/cm/mm/po/cmmmpoanuuvi0e7zjxjnwrfnmcg.jpeg"><br><br>  To correct a double click, we used the following method.  We have extension functions to set navigation clicks.  After clicking on a button or another item, we update ClickListener and navigate to avoid double transition.  Or, if you have RxJava in your project, I recommend using the RxBindingsgs library from Jake Worton, and using it you can handle events from View in a reactive style, using the operators available to us. <br><br><img src="https://habrastorage.org/webt/cg/_y/fh/cg_yfhpc4uvios5bvpqy5q2rwg8.jpeg"><br><br>  Let's talk about shared elements.  Since they appeared a little later, we decided to finish the navigator, add navigation to it.  We are programmers, why not? <br><br><img src="https://habrastorage.org/webt/8f/in/sb/8finsbjtbk0uckv15eid7gqxfec.jpeg"><br><br>  The revision was as follows: we inherit our navigator from the navigator that is in the library.  Here, not all the code is presented, but this is the main part that we have finalized.  I want to note, before doing the navigation, the state of the FragmentManager is checked.  If it was saved, then we lose our teams.  In my opinion, this is a flaw. <br><br>  Also, when we start a fragment transaction, we create a transaction and set all our Views that need to be searched.  But the question arises, what kind of class is this TransitionDestination?  This is our custom class in which it is possible to set Views.  We inherit it from Destination and extend the functionality.  Set Views and our Destination is ready to share. <br><br><img src="https://habrastorage.org/webt/cu/do/qh/cudoqhbr1telv86fghwc4hf61mw.jpeg"><br><br>  The next part - we need to make navigation.  We are looking for when you click on the button on the id destination, pull out the top of the graph to which you want to go.  After that we convert it to our TransitionDestination, in which we have Views.  Further we set all our Views for animation of transitions, and we do navigation.  Everything works, everything is super.  But then alpha06 appeared. <br><br>  This does not mean that we did jumps between versions.  We tried to update the libraries as necessary, but perhaps these are the most basic changes we have encountered. <br><br>  There are problems with alpha06.  Since this was the alpha version of the library, there were constant changes related to renaming methods, callbacks, interfaces, not to mention the fact that parameters were added and removed in methods.  Since we wrote our own navigator, we had to synchronize the library navigator code with ours in order to also fill in bugfixes and new features. <br><br>  Also in the library itself, as the transition from early alpha versions to stable versions, behavior changed, some possibilities were removed.  There used to be a launchDocument flag, but it was never used, then it was removed. <br><br><img src="https://habrastorage.org/webt/lk/27/e8/lk27e8i0ha-eeysxxbgarfiy2bc.jpeg"><br><br>  For example, there was a change in which the developers said that the navigateUp () method that works with DrawerLayout is outdated, use another one in which the parameters were simply swapped. <br><br><img src="https://habrastorage.org/webt/1z/-u/-4/1z-u-4ub3ofpcvgz2dgknqlomhs.jpeg"><br><br><img src="https://habrastorage.org/webt/tt/ls/bs/ttlsbse7jt_q_dok28qtuzinama.jpeg"><br><br>  Our next big migration was on alpha11.  Here fixed the main problems with navigation when working with the graph.  We finally removed our doped controller and used everything that was out of the box.  Safe args still didn't work for us, and we were upset. <br><br>  Then the beta01 version came out, and in this version nothing actually changed with the navigation behavior, but the following problem appeared: if a number of screens are open in the application, then we clean up the stack before opening our diplink.  This behavior did not suit us.  Safe args still did not work. <br><br><img src="https://habrastorage.org/webt/lo/tw/9j/lotw9jlnmyrsnhx95etgnrs3ink.jpeg"><br><br>  We wrote an issue in Google, to which we were told that all the rules were originally conceived, and this was done in the code itself because before going to diplink, we returned to the root fragment using the id of the graph that lies at the root.  Also, in the setPopUpTo () method, the flag is passed, saying that by returning to this screen, we also need to drop it from the stack. <br><br><img src="https://habrastorage.org/webt/br/qa/mq/brqamqzlwzsg-muws3e0ss_ptyq.jpeg"><br><br>  We decided to return our doped navigator and correct what we consider wrong. <br><br><img src="https://habrastorage.org/webt/mn/fa/qr/mnfaqrgvrtsox_awvaq_axr6ewq.jpeg"><br><br>  Here it is, the original problem that caused the stack to be cleared.  We solved it as follows.  We check if startDestination is equal to zero, the initial screen, then we will use it, take as the IT manager the IT leader of the graph.  If our startDestination aydishnik is not zero, then we will take this aydishnik from the graph, thanks to which we can not clean the stack and open the diplink on top of the content that we have.  Or, alternatively, you can simply remove the pop-up true in the navigation options.  In theory, everything should work too. <br><br>  And finally comes the stable version.  We were delighted, we thought that everything was fine, but in a stable version the behavior, by and large, did not change.  They just made it finalized.  We finally got safe args, so we actively began to add arguments on our screens and use them everywhere in the code.  We also found that navigation does not work with DialogFragments.  Since we had DialogFragments, we wanted to transfer all of them into a graph, into XML, and describe the transitions between them.  But we did not. <br><br><img src="https://habrastorage.org/webt/1f/nd/kg/1fndkgqleynvgu0vno1xf_p9ux0.jpeg"><br><br>  Double opening.  We also had a problem that haunted us from the very first version, the double opening of the Activity during the cold start of the application. <br><br><img src="https://habrastorage.org/webt/k6/y6/fm/k6y6fm59psyrtdsaqv47hfdl_cm.jpeg"><br><br>  It happens as follows.  There is an excellent handle method deeplink, which we can call from our code, for example, when in activation we get onNewIntent () in order to intercept the diplink.  Here, the ACTIVITY_NEW_TASK flag comes to the Intent when the application is launched by diplink, so the following happens: a new Activity is started, and if there is a current Activity, it is killed.  Therefore, if we start the application, the white screen starts up first, then it disappears, another screen appears, and they look very beautiful. <br><br>  As a result, having introduced this library, we received the following advantages. <br><br><img src="https://habrastorage.org/webt/ip/x2/dv/ipx2dv_nu1w0-8erk2de8buctsm.jpeg"><br><br>  We have documentation on our navigation, as well as a graphic representation of the transitions between screens, and if a person comes to us in a project, he quickly understands this by looking at the graph, opening his presentation in the Studio. <br><br>  We have SingleActivity.  All screens are made on fragments, all diplinks lead to fragments, and I find it convenient. <br><br>  It turned out a simple linking of the diplink with the fragments, just add the deeplink tag to the fragment, and the library does everything for us.  We also broke our navigation into nested subgraphs, made nested navigation.  These are different things.  Just a nested graph, in fact, is include within the graph, and nested navigation is when a separate navigator is used to walk on the screens. <br><br>  We also change the graph dynamically in the code, we can add vertices, we can delete vertices, we can change the start screen - it all works. <br><br>  We almost forgot how to work with FragmentManager, since all the logic of working with it is encapsulated inside the library, and the library does all the magic for us.  The library also works with DrawerLayout, if you have a root fragment specified, the library itself will draw a hamburger on it, and when moving to the next screens, it will draw an arrow and do it animated when returning from the last but one fragment. <br><br>  We also moved all the arguments, most of them, to SafeArgs, and everything is created when we build the project.  In addition, we coped with all the problems that we were pursued, and finalized the library to fit our needs. <br><br>  SafeArgs can generate code on Kotlin, for this a separate plugin is used. <br><br><img src="https://habrastorage.org/webt/kr/gw/lo/krgwloyigbrzjumonwtftiygi7w.jpeg"><br><br>  In addition, the library has drawbacks.  The first is that a clean version has been delivered to the stable version.  I don‚Äôt know why it was done, maybe it‚Äôs so convenient for someone, but in the case of our application, we would like to open diplinks above the content that we have. <br><br>  The fragments themselves are created by the fragment navigator, and are created through reflection.  I do not think this is a plus in implementation.  The condition for diplinks is not supported.  Your application may have secret screens that are accessible only to authorized users.  And in order to open diplinks by condition, you need to write crutches for this, since you cannot set a diplink handler in which we would get control and tell what to do, either open the diplink screen or open another screen. <br><br>  Also, the transition commands are lost, all because the fragment of the navigator checks the state, whether it is saved or not, and if it is saved, then we simply do nothing. <br><br>  We also had to modify the library with a file, this is not a plus.  And another major drawback - we do not have the opportunity to open a chain of screens in front of a link.  In the case of our application, we would like to make a diplink on the basket, in front of which we open all the previous screens: restaurants, a particular restaurant, and only after that the basket. <br><br>  Also, to work with navigation, you must have an instance of View.  To get a navigator, you need to refer to View - the navigation library itself will contact the parents of this View - and try to find a navigator in it.  If she finds it, then the transition to the desired screen occurs. <br><br>  But the question arises: is it worth to use the library in battle?  I will say yes if: <br><br><img src="https://habrastorage.org/webt/ao/nv/th/aonvthsqh1m-ompt19yxq30ofug.jpeg"><br><br>  If we need to get a quick result.  The library is implemented very quickly, it can be inserted into the project in about 20 minutes, all transitions are poked with the mouse, everything is convenient.  Just as quickly it is written in XML, quickly assembled, works quickly.  Everything is super. <br><br>  If you need to have in the application a lot of screens that work with diplinks, and there are no conditions under which they should open. <br><br>  No single Activity.  Here I mean not only single Activity.  We can navigate both on fragments with one Activity, and on a mixture of fragments and an Activity, just in the column it will also be possible to describe an Activity.  To do this, use the provider inside the navigator, in which there are two implementations of navigation.  One is for Activity, which creates Intents to go to the necessary Activities, the second implementation is a fragment-navigator, which works inside itself with a fragment-manager. <br><br>  If you do not have complex logic to switch between screens.  Each application is unique in its own way, and if there is a complex logic for opening screens, this library is not for you. <br><br>  You are ready to go into the sources and modify it as we do.  Actually it is very interesting. <br><br><img src="https://habrastorage.org/webt/x5/hb/gh/x5hbghbpwhocquyhtflyjth2xka.jpeg"><br><br>  I will say no, if the application has complicated navigation logic, if you need to open a chain of screens in front of the link, if you need difficult conditions for opening screens through the link.  In principle, using the example of authorization, this can be done by simply opening the screen you need, and on top of it - the authorization screen.  If the user is not authorized by you, then you drop to the stack to the previous screen, in front of which the secret screen was opened.  Such a crutch decision. <br><br>  Losing teams is critical for you.  The same Cicerone can save commands to the buffer, and when the navigator becomes available, it executes them. <br><br>  If you do not want to finish the code, it does not mean that you, as a developer, do not want to do something.  Suppose you have a deadline, you product managers say that you need to cut features, business wants to roll out features.  You need a turnkey solution that works out of the box.  Navigation Components is not about this case. <br><br>  Another critical thing is that DialogFragments are not supported.  Navigator, which would work with them, you could add, but for some reason did not add.  The problem is that, in themselves, they open like normal fragments.  The checkbox on isShowing is not set and, accordingly, the DialogFragments life cycle for creating a dialog is not executed.  In fact, DialogFragment opens as a normal fragment, the entire screen without creating a window. <br><br>  I have it all.  Dig the source, it is really interesting and fun.  Here are <a href="https://github.com/bagrusss/navigation_demo">useful materials</a> for those who are interested in working with the navigation library.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/455479/">https://habr.com/ru/post/455479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455469/index.html">To be full and not be them</a></li>
<li><a href="../45547/index.html">What is more effective: fine or work?</a></li>
<li><a href="../455471/index.html">Translation of the book ‚ÄúUsing Google Analytics with R‚Äù (Michal Brys)</a></li>
<li><a href="../455473/index.html">Generics in TypeScript: sorting out together</a></li>
<li><a href="../455475/index.html">Product Design Digest May 2019</a></li>
<li><a href="../455481/index.html">Three stories about wild hunting</a></li>
<li><a href="../455483/index.html">Artist Ai-Da: a humanoid robot prepares for his first solo exhibition</a></li>
<li><a href="../455485/index.html">Check Point Scripts - run scripts directly from the Smart Console</a></li>
<li><a href="../455487/index.html">Training Cisco 200-125 CCNA v3.0. Day 10. Modes of operation ports switch</a></li>
<li><a href="../455489/index.html">Connect third-party audio and video solutions to Microsoft Teams</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>