<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The book "High-performance code on the platform. NET. 2nd edition ¬ª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This book will teach you how to maximize the performance of managed code, ideally without sacrificing any of the benefits of the .NET environment, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The book "High-performance code on the platform. NET. 2nd edition ¬ª</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/ru/company/piter/blog/458520/"><img src="https://habrastorage.org/webt/sl/sj/0d/slsj0dvgahq6ejfp9lenc9s8mzu.jpeg" align="left" alt="image"></a>  This book will teach you how to maximize the performance of managed code, ideally without sacrificing any of the benefits of the .NET environment, and in the worst case sacrificing the minimum number.  You will learn rational programming techniques, learn what to avoid and, perhaps most importantly, how to use freely available tools to measure your level of productivity without much difficulty.  In the educational material will be a minimum of water - only the most necessary.  The book gives exactly what you need to know, it is relevant and concise, does not contain too much.  Most chapters begin with general information and background, followed by specific tips, like a recipe, and at the end - a section for step-by-step measurements and debugging for a variety of different scenarios. <br><br>  Along the way, Ben Watson plunges into specific components of the .NET environment, in particular, the Common Language Runtime (CLR), which forms the basis for its foundation, and see how your machine‚Äôs memory is managed, code is generated, multithreaded execution is being done, and much more is done .  You will be shown how the .NET architecture simultaneously limits your software and gives it additional capabilities and how the choice of programming paths can significantly affect the overall performance of the application.  As a bonus, the author will share with you stories from the experience of creating very large, complex, high-performance .NET-systems at Microsoft in the past nine years. <br><a name="habracut"></a><br><h3>  Snippet. Choose the appropriate size of the thread pool. </h3><br>  Over time, the thread pool is configured independently, but at the very beginning it does not have a history and it will be launched in the initial state.  If your software product is extremely asynchronous and significantly utilizes the CPU, it may suffer from prohibitively high initial startup costs while waiting for the creation and availability of even more threads.  Faster achievement of the steady state will help the adjustment of the starting parameters so that from the moment the application is launched, you have at your disposal a certain number of ready threads: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> int MinWorkerThreads = <span class="hljs-number"><span class="hljs-number">25</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> int MinIoThreads = <span class="hljs-number"><span class="hljs-number">25</span></span>; ThreadPool.SetMinThreads(MinWorkerThreads, MinIoThreads);</code> </pre> <br>  Here it is necessary to proceed with caution.  When using Task objects, they will be dispatched based on the number of threads available for this.  If there are too many of them, Task objects can be subject to excessive dispatching, which at a minimum will lead to a decrease in the efficiency of application of the central processor due to more frequent context switching.  If the workload is not so high, the thread pool will be able to switch to an algorithm that can reduce the number of threads, bringing it to a number below the specified one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can also set their maximum using the SetMaxThreads method, but this technique is subject to similar risks. <br><br>  To find out how many threads you need, leave this parameter alone and analyze your application in a steady state using the methods ThreadPool.GetMaxThreads and ThreadPool.GetMinThreads or performance counters that show the number of threads involved in the process. <br><br><h3>  Do not interrupt flows </h3><br>  Interrupting the work of threads without agreeing with the work of other threads is a rather dangerous procedure.  Threads must cleanse themselves, and the Abort method call for them does not allow closing them without negative consequences.  When a stream is destroyed, parts of the application are in an undefined state.  It would be better to perform an emergency exit from the program, but ideally you need a clean restart. <br><br>  To safely shut down a thread, you need to use some kind of shared state, and the thread function itself should check this state to determine when its operation should end.  Security must be achieved through consistency. <br><br>  In general, you should always use Task-objects - the API for interrupting a Task is not provided.  To be able to consistently terminate the flow, you need, as noted earlier, to use the CancellationToken. <br><br><h3>  Do not change the priority of threads. </h3><br>  In general, changing the priority of threads is an extremely unfortunate idea.  In Windows, threads are dispatched according to their priority levels.  If high-priority flows are always ready to start, then low-priority ones will be ignored and rarely get a chance to start.  Increasing the priority of a thread, you say that its work should take precedence over the rest of the work, including other processes.  It is unsafe for a stable system. <br><br>  It is better to lower the priority of a thread if it is running something that can wait until the completion of tasks of normal priority.  One of the compelling reasons for lowering the priority of a thread can be the detection of an out-of-control thread performing an infinite loop.  It is impossible to safely stop a thread, so the only way to return this thread and processor resources is to restart the process.  Until it becomes possible to close the stream and do it cleanly, lowering the priority of the out-of-control stream would be a reasonable means of minimizing the consequences.  It should be noted that even threads with a lower priority still have a guaranteed start over time: the longer they are deprived of starts, the higher their dynamic priority set by Windows will be.  The exception is the idle time priority THREAD_ ‚Äë PRIORITY_IDLE, in which the operating system only schedules the execution of a thread when it literally has nothing more to run. <br><br>  There may be well justified reasons for raising the priority of the flow, for example, the need to quickly respond to rare situations.  But to use such techniques should be very cautious.  Dispatching threads in Windows is done independently of the processes to which they belong, so the high-priority thread from your process will be launched to the detriment of not only your other threads, but all threads from other applications running on your system. <br><br>  If a thread pool is used, then any changes to priorities are reset each time the thread returns to the pool.  If using the Task Parallel library to continue managing base streams, it should be borne in mind that several tasks can be started on the same stream before it returns to the pool. <br><br><h3>  Synchronization of threads and locks </h3><br>  As soon as it comes to multiple threads, it becomes necessary to synchronize them.  Synchronization consists in providing access to only one stream to a shared state, for example, to a class field.  Normally, synchronization of threads is performed using synchronization objects such as Monitor, Semaphore, ManualResetEvent, etc. Sometimes they are informally called locks, and the synchronization process in a particular stream is called blocking. <br><br>  One of the fundamental truths about locks is this: they never improve performance.  At best, if there is a well-implemented synchronization primitive and there is no contention, the lock can be neutral.  It leads to stopping the performance of useful work by other threads and to the fact that the CPU time is wasted, increases the context switching time and causes other negative consequences.  This has to be tolerated because correctness is much more important than simple performance.  Whether the wrong result is quickly calculated, does not play any role! <br><br>  Before we begin to solve the problem of using the device lock, consider the most fundamental principles. <br><br><h3>  Do I need to worry about performance at all? </h3><br>  First justify the need to improve performance.  This brings us back to the principles discussed in Chapter 1. Performance is not equally important for all of your application‚Äôs code.  Not all code has to be optimized for degree n.  As a rule, it all starts with an ‚Äúinner loop,‚Äù the code executed most often or most critical to performance, and spreads in all directions until the costs exceed the benefits.  There are many areas in the code that are much less important in terms of performance.  In such a situation, if you need a lock, calmly apply it. <br><br>  And now it is necessary to show prudence.  If your noncritical code snippet runs in a thread from the thread pool and you block it for a long time, the thread pool can begin to insert more threads to cope with other requests.  If one or two threads do it from time to time, no big deal.  But if such things are doing a lot of flows, a problem may arise, because of this, the resources that have to do the real work are wasted because of this.  Inadvertently starting a program with a significant constant load can cause a negative impact on the system even from those parts for which high performance is not important, due to unnecessary context switches or unreasonable use of the thread pool.  As in all other cases, to assess the situation you need to perform measurements. <br><br><h3>  Do you really need a lock? </h3><br>  The most effective locking mechanism is the one that does not exist.  If you can get rid of the need to synchronize threads at all, this will be the best way to get high performance.  This is the ideal, which is not so easy to achieve.  This usually means that you need to ensure that there is no mutable shared state ‚Äî every request that passes through your application can be processed independently of another request or some centralized, changeable (via read-write) data.  Such an opportunity will be the best scenario for achieving high performance. <br><br>  And yet be careful.  With restructuring, it‚Äôs easy to overdo it and turn the code into a messy mess that no one, including yourself, can figure out.  Do not go too far, unless high performance is a truly critical factor and cannot be achieved otherwise.  Turn the code into asynchronous and independent, but so that it remains understandable. <br><br>  If several threads simply read from a variable (and there are no hints of writing to it from any thread), synchronization is not needed.  All threads can have unlimited access.  This automatically propagates to immutable objects such as strings or values ‚Äã‚Äãof immutable types, but can relate to any type of objects, if it is guaranteed that its values ‚Äã‚Äãare immutable during the reading by multiple threads. <br><br>  If there are multiple threads leading to writing to a shared variable, see if you can eliminate the need for synchronized access by switching to using a local variable.  If you can create a temporary copy for your work, the need for synchronization will disappear.  This is especially important for repetitive synchronized access.  From re-accessing a shared variable, you need to switch to re-accessing a local variable following the one-time access to the shared variable, as in the following simple example of adding elements to a collection shared by several threads. <br><br><pre> <code class="javascript hljs">object syncObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> object(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> masterList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;long &gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NumTasks</span></span></span><span class="hljs-function"> = 8; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">[] </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NumTasks</span></span></span><span class="hljs-function">]; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int i = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; i &lt; NumTasks; i++</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">] = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">5000000</span></span>; j++) { lock (syncObj) { masterList.Add(j); } } }); } Task.WaitAll(tasks);</code> </pre> <br>  This code can be converted as follows: <br><br><pre> <code class="javascript hljs">object syncObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> object(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> masterList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;long &gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NumTasks</span></span></span><span class="hljs-function"> = 8; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">[] </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NumTasks</span></span></span><span class="hljs-function">]; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">int i = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">; i &lt; NumTasks; i++</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tasks</span></span></span><span class="hljs-function">[</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">] = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Task</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">)=&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;long &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">5000000</span></span>; j++) { localList.Add(j); } lock (syncObj) { masterList.AddRange(localList); } }); } Task.WaitAll(tasks);</code> </pre> <br>  On my machine, the second version of the code runs more than twice as fast as the first. <br>  Ultimately, a variable shared state is the principal enemy of performance.  It requires synchronization for data security, which degrades performance.  If your design has even the slightest opportunity to avoid blocking, then you are close to implementing an ideal multi-threaded system. <br><br><h3>  Sync Preference Order </h3><br>  When deciding whether any type of synchronization is necessary, it should be understood that not all of them have the same performance or behavior characteristics.  In most situations, you just need to use a lock, and usually this should be the initial option.  Using something other than blocking to justify additional complexity requires intensive measurements.  In general, consider the synchronization mechanisms in the following order. <br><br>  1. lock / class Monitor - preserves simplicity, availability of code for understanding and provides a good balance of performance. <br><br>  2. Complete lack of synchronization.  Get rid of shared variable states, restructure and optimize.  This is more difficult, but if it works, it will generally work better than the use of a lock (except when errors are made or the architecture is degraded). <br><br>  3. Simple Interlocked Interlocked Methods - In some scenarios, it may be more appropriate, but as soon as the situation starts to get complicated, go on to use the lock. <br><br>  And finally, if you can really prove the benefits of using them, use more sophisticated, complex locks (keep in mind: they are rarely as useful as you expect): <br><br><ol><li>  asynchronous locks (to be discussed later in this chapter); </li><li>  other. </li></ol><br>  Specific circumstances may dictate or impede the use of some of these technologies.  For example, combining several Interlocked methods is unlikely to outperform a single lock statement. <br><br>  ¬ªMore information about the book can be found on <a href="https://www.piter.com/collection/new/product/vysokoproizvoditelnyy-kod-na-platforme-net-2-e-izdanie">the publisher site</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610911/978544610911_X.pdf">Table of Contents</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610911/978544610911_p.pdf">Excerpt</a> <br><br>  For Habrozhiteley 25% discount coupon - <b>.NET</b> <br><br>  Upon payment of the paper version of the book, an e-book is sent to the e-mail. </div><p>Source: <a href="https://habr.com/ru/post/458520/">https://habr.com/ru/post/458520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458504/index.html">13 tricks to work with npm, which help save time</a></li>
<li><a href="../458508/index.html">An inside look: graduate school at EPFL. Part 4.2: the financial side</a></li>
<li><a href="../458514/index.html">For violation of the GDPR is punished more actively - fresh fines and the impact of regulations outside the EU</a></li>
<li><a href="../458516/index.html">Get worklog from jira</a></li>
<li><a href="../45852/index.html">Coming large-scale reform of education and science</a></li>
<li><a href="../458524/index.html">Word Clouds from VK</a></li>
<li><a href="../458530/index.html">Zabbix, time series and timescaleDB</a></li>
<li><a href="../458532/index.html">Pioneers of new technologies: Vadim Artsev told how he ceased to be blind</a></li>
<li><a href="../458536/index.html">Python + Pyside2 or just "Calculator"</a></li>
<li><a href="../458548/index.html">Creating a library in the style of Spring Data Repository do-it-yourself using Dynamic Proxy and Spring IoC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>