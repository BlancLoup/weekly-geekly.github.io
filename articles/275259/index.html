<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bareos: tapes, Hyper-V and more</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a post about life after Getting Started with Bareos, and what a comprehensive manual had to read the longest. 


 Storoj 

 If you already dro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bareos: tapes, Hyper-V and more</h1><div class="post__text post__text-html js-mediator-article">  This is a post about life after Getting Started with Bareos, and what a <a href="http://doc.bareos.org/master/html/bareos-manual-main-reference.html">comprehensive manual</a> had to read the longest. <br><br><img src="https://habrastorage.org/web/aa9/b8c/0e5/aa9b8c0e515b43ed91fd223d75c0a131.jpg"><br>  <i>Storoj</i> <br><br>  If you already drove test tasks in the sandbox and can communicate with the baros via bconsole, then climb through the cat. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Situation </h2><br>  We just have an organization, not an IT profile, not a hosting.  Backing up virtual machines from Hyper-V clusters, files from file farms and database dumps, and there are also various trivia. <br><br><h2>  Why baros </h2><br>  Because the screw client is available.  As you know, Bareos is a dramatic fork of Bacula, well-deserved and proven.  But during the selection of Bakula, the source code (and even binaries) of its <abbr title="File daemon">fd</abbr> for Windows was clamped, so no.  Veeam is good, but it's worth as an armchair of the stadium of FC ¬´Zenit¬ª.  There was DPM, but how much Antoan and I from Microsoft technical support did not fight with him, love never arose. <br><br><h2>  Installation </h2><br>  has been described repeatedly.  Who is the director and what he does with other demons - you can read, for example, <a href="https://habrahabr.ru/company/simnetworks/blog/313124/">here</a> .  I note only that <abbr title="Director">dir</abbr> and <abbr title="Storage daemon">sd are</abbr> extremely desirable to be the same version, the fd version is not so important.  Feels like changers, the version is better to have 16 or higher. <br><br><h2>  Basic setting </h2><br>  According to the DPM habit, I wanted to create a big task and cram a lot into it.  It turned out that small tasks are more convenient: in case of unsuccessful execution, a small one will be executed again faster and crawls through the spooler better (more on that later).  The size of the task does not affect the recovery process, except that a task with hundreds of thousands of files can slow down at the stage of their selection. <br><br><h2>  Hyper-v </h2><br>  Virtual Machines (VMs) run on Hyper-V clusters.  Within the cluster on the nodes, the fd settings are the same, the hostname for all is the cluster name.  The director as a client also indicates a cluster with its cluster address.  VM can move to another cluster volume, therefore we specify not a specific path, but the path to the script: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="hljs pgsql">FileSet { #       ,    <span class="hljs-type"><span class="hljs-type">Name</span></span> = "VM_lamachine-fs" <span class="hljs-keyword"><span class="hljs-keyword">Include</span></span> { #    (/ "example.com"  ) File = "\\|C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -file c:/cmd/search-vm.ps1 -machine lamachine.example.com" <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> { #      Compression = LZO #     RegexFile = ".*/Virtual Machines/.*.bin" <span class="hljs-keyword"><span class="hljs-keyword">Exclude</span></span> = yes } } }</code> </pre> <br>  But c: \ cmd \ search-vm.ps1, which gives the path to the machine: <br><br><pre> <code class="hljs bash">Param( [string]<span class="hljs-variable"><span class="hljs-variable">$level</span></span>, [string]<span class="hljs-variable"><span class="hljs-variable">$machine</span></span> = <span class="hljs-string"><span class="hljs-string">"NOEXISTENTVM.example.com"</span></span> ) Import-Module failoverclusters <span class="hljs-variable"><span class="hljs-variable">$backuppath</span></span> = @() <span class="hljs-variable"><span class="hljs-variable">$Cluster</span></span> = Get-Cluster <span class="hljs-variable"><span class="hljs-variable">$ClusterMachines</span></span> = @() <span class="hljs-variable"><span class="hljs-variable">$ClusterMachines</span></span> += Get-ClusterResource -Cluster <span class="hljs-variable"><span class="hljs-variable">$Cluster</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> { <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.ResourceType -like <span class="hljs-string"><span class="hljs-string">"Virtual Machine"</span></span> } | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> { <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Name -like <span class="hljs-string"><span class="hljs-string">"*</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$machine</span></span></span><span class="hljs-string">"</span></span>} | ` select -Property OwnerNode,Name, @{ Name =<span class="hljs-string"><span class="hljs-string">"VmID"</span></span>;Expression ={ (Get-ClusterParameter -Cluster <span class="hljs-variable"><span class="hljs-variable">$Cluster</span></span> -InputObject <span class="hljs-variable"><span class="hljs-variable">$_</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> { <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Name -eq <span class="hljs-string"><span class="hljs-string">"VmID"</span></span> } | select -Property Value).Value } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ClusterMachines</span></span>.Count -eq 0 ) { <span class="hljs-string"><span class="hljs-string">"NO MACHINES"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 2 } foreach (<span class="hljs-variable"><span class="hljs-variable">$ClusterMachine</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ClusterMachines</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$VM</span></span> = Get-VM -ComputerName <span class="hljs-variable"><span class="hljs-variable">$ClusterMachine</span></span>.OwnerNode -Id <span class="hljs-variable"><span class="hljs-variable">$ClusterMachine</span></span>.VmID <span class="hljs-variable"><span class="hljs-variable">$path</span></span> = <span class="hljs-variable"><span class="hljs-variable">$VM</span></span>.Path.Replace(<span class="hljs-string"><span class="hljs-string">'\'</span></span>,<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-variable"><span class="hljs-variable">$backuppath</span></span> += <span class="hljs-variable"><span class="hljs-variable">$path</span></span> foreach (<span class="hljs-variable"><span class="hljs-variable">$HardDrive</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$VM</span></span>.HardDrives){ <span class="hljs-variable"><span class="hljs-variable">$drivepath</span></span> = <span class="hljs-variable"><span class="hljs-variable">$HardDrive</span></span>.Path | Split-Path -Parent <span class="hljs-variable"><span class="hljs-variable">$drivepath</span></span> = <span class="hljs-variable"><span class="hljs-variable">$drivepath</span></span>.Replace(<span class="hljs-string"><span class="hljs-string">'\'</span></span>,<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$drivepath</span></span> -notin <span class="hljs-variable"><span class="hljs-variable">$backuppath</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$backuppath</span></span> += <span class="hljs-variable"><span class="hljs-variable">$drivepath</span></span> } } } <span class="hljs-variable"><span class="hljs-variable">$backuppath</span></span></code> </pre> </div></div><br>  Before backup, snapshot is done, after backup it is deleted, for this there are a couple of someone else's roughly doped scripts. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  Creature: <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#Copyright</span></span> disclaimer: # <span class="hljs-type"><span class="hljs-type">Copyright</span></span> (<span class="hljs-type"><span class="hljs-type">C</span></span>) <span class="hljs-number"><span class="hljs-number">2015</span></span>, <span class="hljs-type"><span class="hljs-type">ITHierarchy</span></span> <span class="hljs-type"><span class="hljs-type">Inc</span></span> (www.ithierarchy.com). <span class="hljs-type"><span class="hljs-type">ALl</span></span> rights reserverd. # <span class="hljs-type"><span class="hljs-type">This</span></span> program is free software: you can redistribute it and/or modify # it under the terms of the <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> as published by # the <span class="hljs-type"><span class="hljs-type">Free</span></span> <span class="hljs-type"><span class="hljs-type">Software</span></span> <span class="hljs-type"><span class="hljs-type">Foundation</span></span>, either version <span class="hljs-number"><span class="hljs-number">3</span></span> of the <span class="hljs-type"><span class="hljs-type">License</span></span>, or # (at your option) any later version. # # <span class="hljs-type"><span class="hljs-type">This</span></span> program is distributed in the hope that it will be useful, # but <span class="hljs-type"><span class="hljs-type">WITHOUT</span></span> <span class="hljs-type"><span class="hljs-type">ANY</span></span> <span class="hljs-type"><span class="hljs-type">WARRANTY</span></span>; without even the implied warranty of # <span class="hljs-type"><span class="hljs-type">MERCHANTABILITY</span></span> or <span class="hljs-type"><span class="hljs-type">FITNESS</span></span> <span class="hljs-type"><span class="hljs-type">FOR</span></span> <span class="hljs-type"><span class="hljs-type">A</span></span> <span class="hljs-type"><span class="hljs-type">PARTICULAR</span></span> <span class="hljs-type"><span class="hljs-type">PURPOSE</span></span>. <span class="hljs-type"><span class="hljs-type">See</span></span> the # <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> for more details. # # <span class="hljs-type"><span class="hljs-type">You</span></span> should have received a copy of the <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> # along with this program. <span class="hljs-type"><span class="hljs-type">If</span></span> not, see &lt;http://www.gnu.org/licenses/&gt;. <span class="hljs-type"><span class="hljs-type">Param</span></span>( [string]<span class="hljs-string"><span class="hljs-string">$l</span></span>evel, [string]<span class="hljs-string"><span class="hljs-string">$m</span></span>achine = <span class="hljs-comment"><span class="hljs-comment">"noexist.example.com"</span></span>, #[string]<span class="hljs-string"><span class="hljs-string">$p</span></span>refix = <span class="hljs-comment"><span class="hljs-comment">""</span></span>, [int]<span class="hljs-string"><span class="hljs-string">$D</span></span>ayOfWeekForFullBackup = <span class="hljs-number"><span class="hljs-number">2</span></span> ) <span class="hljs-type"><span class="hljs-type">Import</span></span>-<span class="hljs-type"><span class="hljs-type">Module</span></span> failoverclusters <span class="hljs-comment"><span class="hljs-comment">"Processing $machine via $env:computername"</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ow = [int]<span class="hljs-string"><span class="hljs-string">$(</span></span>get-date).<span class="hljs-type"><span class="hljs-type">DayOfWeek</span></span> if (<span class="hljs-string"><span class="hljs-string">$d</span></span>ow -eq <span class="hljs-string"><span class="hljs-string">$D</span></span>ayOfWeekForFullBackup){ <span class="hljs-string"><span class="hljs-string">$p</span></span>refix=<span class="hljs-comment"><span class="hljs-comment">"Weekly"</span></span> } <span class="hljs-string"><span class="hljs-string">$D</span></span>ateStamp=<span class="hljs-string"><span class="hljs-string">$(</span></span>((get-date)).<span class="hljs-type"><span class="hljs-type">ToString</span></span>(<span class="hljs-comment"><span class="hljs-comment">"yyyyMMddTHHmmss"</span></span>)) if (<span class="hljs-string"><span class="hljs-string">$l</span></span>evel -eq <span class="hljs-comment"><span class="hljs-comment">"Full"</span></span>){<span class="hljs-string"><span class="hljs-string">$B</span></span>ackup=<span class="hljs-comment"><span class="hljs-comment">" Bacula -*"</span></span>}<span class="hljs-type"><span class="hljs-type">Else</span></span>{<span class="hljs-string"><span class="hljs-string">$B</span></span>ackup=<span class="hljs-comment"><span class="hljs-comment">" Bacula -$level*"</span></span>} #<span class="hljs-string"><span class="hljs-string">$H</span></span>yperVPath=<span class="hljs-comment"><span class="hljs-comment">"C:\Hyper-V"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#Set</span></span> path to your <span class="hljs-type"><span class="hljs-type">Hyper</span></span>-<span class="hljs-type"><span class="hljs-type">V</span></span> <span class="hljs-type"><span class="hljs-type">Machines</span></span> to be backed up <span class="hljs-symbol"><span class="hljs-symbol">#Sort</span></span> out <span class="hljs-type"><span class="hljs-type">Actual</span></span> <span class="hljs-type"><span class="hljs-type">Volume</span></span> path to <span class="hljs-type"><span class="hljs-type">VM</span></span> #<span class="hljs-string"><span class="hljs-string">$V</span></span>MDrive=<span class="hljs-string"><span class="hljs-string">$H</span></span>yperVPath.<span class="hljs-type"><span class="hljs-type">Substring</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) #<span class="hljs-string"><span class="hljs-string">$v</span></span>olume=<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Volume</span></span> <span class="hljs-string"><span class="hljs-string">$V</span></span>MDrive #<span class="hljs-string"><span class="hljs-string">$T</span></span>rueHyperVPath=<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">$H</span></span>yperVPath.<span class="hljs-type"><span class="hljs-type">Replace</span></span>(<span class="hljs-comment"><span class="hljs-comment">"$($VMDrive):\"</span></span>,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">$V</span></span>olume.path))) <span class="hljs-symbol"><span class="hljs-symbol">#Get</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span> of <span class="hljs-type"><span class="hljs-type">VMs</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>luster = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Cluster</span></span> # let<span class="hljs-string"><span class="hljs-string">'s initialize it like array (for simplier size check) $ClusterMachines = @() $ClusterMachines += Get-ClusterResource -Cluster $Cluster | where { $_.ResourceType -like "Virtual Machine" } | where { $_.Name -like "*$machine"} | ` select -Property OwnerNode,Name, @{ Name ="VmID";Expression ={ (Get-ClusterParameter -Cluster $Cluster -InputObject $_ | where { $_.Name -eq "VmID" } | select -Property Value).Value } } if ($ClusterMachines.count -gt 1){ "Ambiguous machine name" exit 2 } if ($ClusterMachines.count -ne 1){ "Machine not found: absent, not in failover cluster or something" exit 2 } foreach ($ClusterMachine in $ClusterMachines){ $VM = Get-VM -ComputerName $ClusterMachine.OwnerNode -Id $ClusterMachine.VmID write-host "Working on VM $($vm.Name) @ '</span></span><span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">$v</span></span>m.<span class="hljs-type"><span class="hljs-type">Path</span></span>)<span class="hljs-string"><span class="hljs-string">'" $CurrentSnapShots = $VM | Get-VMSnapshot foreach ($SnapShot in $CurrentSnapShots){ if ($SnapShot.Name -like ("$($prefix)Backup*")){ write-host "Removing VM Checkpoint '</span></span><span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">$S</span></span>napShot.<span class="hljs-type"><span class="hljs-type">Name</span></span>)<span class="hljs-string"><span class="hljs-string">'" $SnapShot | Remove-VMSnapshot # -ComputerName $ClusterMachine.OwnerNode $LoopCount=0 do { Write-host "Waiting for snapshot '</span></span><span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-string"><span class="hljs-string">$S</span></span>napShot.name)<span class="hljs-string"><span class="hljs-string">' to delete..." Start-Sleep -s 10 $LoopCount=$LoopCount+1 }while ($VM.Status -eq "Merging disks" -and $LoopCount -lt 30) } } $label = "$($prefix)Backup-$level-$DateStamp" write-host "Creating Checkpoint $label ($($VM.Name))" $VM | Checkpoint-VM -SnapshotName $label }</span></span></code> </pre> <br>  Uninstall: <br><br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#Copyright</span></span> disclaimer: # <span class="hljs-type"><span class="hljs-type">Copyright</span></span> (<span class="hljs-type"><span class="hljs-type">C</span></span>) <span class="hljs-number"><span class="hljs-number">2015</span></span>, <span class="hljs-type"><span class="hljs-type">ITHierarchy</span></span> <span class="hljs-type"><span class="hljs-type">Inc</span></span> (www.ithierarchy.com). <span class="hljs-type"><span class="hljs-type">ALl</span></span> rights reserverd. # <span class="hljs-type"><span class="hljs-type">This</span></span> program is free software: you can redistribute it and/or modify # it under the terms of the <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> as published by # the <span class="hljs-type"><span class="hljs-type">Free</span></span> <span class="hljs-type"><span class="hljs-type">Software</span></span> <span class="hljs-type"><span class="hljs-type">Foundation</span></span>, either version <span class="hljs-number"><span class="hljs-number">3</span></span> of the <span class="hljs-type"><span class="hljs-type">License</span></span>, or # (at your option) any later version. # # <span class="hljs-type"><span class="hljs-type">This</span></span> program is distributed in the hope that it will be useful, # but <span class="hljs-type"><span class="hljs-type">WITHOUT</span></span> <span class="hljs-type"><span class="hljs-type">ANY</span></span> <span class="hljs-type"><span class="hljs-type">WARRANTY</span></span>; without even the implied warranty of # <span class="hljs-type"><span class="hljs-type">MERCHANTABILITY</span></span> or <span class="hljs-type"><span class="hljs-type">FITNESS</span></span> <span class="hljs-type"><span class="hljs-type">FOR</span></span> <span class="hljs-type"><span class="hljs-type">A</span></span> <span class="hljs-type"><span class="hljs-type">PARTICULAR</span></span> <span class="hljs-type"><span class="hljs-type">PURPOSE</span></span>. <span class="hljs-type"><span class="hljs-type">See</span></span> the # <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> for more details. # # <span class="hljs-type"><span class="hljs-type">You</span></span> should have received a copy of the <span class="hljs-type"><span class="hljs-type">GNU</span></span> <span class="hljs-type"><span class="hljs-type">General</span></span> <span class="hljs-type"><span class="hljs-type">Public</span></span> <span class="hljs-type"><span class="hljs-type">License</span></span> # along with this program. <span class="hljs-type"><span class="hljs-type">If</span></span> not, see &lt;http://www.gnu.org/licenses/&gt;. <span class="hljs-type"><span class="hljs-type">Param</span></span>( [string]<span class="hljs-string"><span class="hljs-string">$l</span></span>evel, [string]<span class="hljs-string"><span class="hljs-string">$m</span></span>achine = <span class="hljs-comment"><span class="hljs-comment">"noexist.example.com"</span></span>, [string]<span class="hljs-string"><span class="hljs-string">$v</span></span>mmserver = <span class="hljs-comment"><span class="hljs-comment">"vldvmm.example.com"</span></span> ) <span class="hljs-type"><span class="hljs-type">Import</span></span>-<span class="hljs-type"><span class="hljs-type">Module</span></span> failoverclusters <span class="hljs-string"><span class="hljs-string">$C</span></span>luster = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Cluster</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachines = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ClusterResource</span></span> -<span class="hljs-type"><span class="hljs-type">Cluster</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>luster | where { <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">ResourceType</span></span> -like <span class="hljs-comment"><span class="hljs-comment">"Virtual Machine"</span></span> } | where { <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> -like <span class="hljs-comment"><span class="hljs-comment">"*$machine"</span></span>} | ` select -<span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">OwnerNode</span></span>,<span class="hljs-type"><span class="hljs-type">Name</span></span>, @{ <span class="hljs-type"><span class="hljs-type">Name</span></span> =<span class="hljs-comment"><span class="hljs-comment">"VmID"</span></span>;<span class="hljs-type"><span class="hljs-type">Expression</span></span> ={ (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ClusterParameter</span></span> -<span class="hljs-type"><span class="hljs-type">Cluster</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>luster -<span class="hljs-type"><span class="hljs-type">InputObject</span></span> <span class="hljs-string"><span class="hljs-string">$_</span></span> | where { <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Name</span></span> -eq <span class="hljs-comment"><span class="hljs-comment">"VmID"</span></span> } | select -<span class="hljs-type"><span class="hljs-type">Property</span></span> <span class="hljs-type"><span class="hljs-type">Value</span></span>).<span class="hljs-type"><span class="hljs-type">Value</span></span> } } # <span class="hljs-type"><span class="hljs-type">FIXME</span></span> foreach    foreach (<span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachine in <span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachines){ <span class="hljs-string"><span class="hljs-string">$V</span></span>M = <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">VM</span></span> -<span class="hljs-type"><span class="hljs-type">ComputerName</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachine.<span class="hljs-type"><span class="hljs-type">OwnerNode</span></span> -<span class="hljs-type"><span class="hljs-type">Id</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachine.<span class="hljs-type"><span class="hljs-type">VmID</span></span> write-host <span class="hljs-comment"><span class="hljs-comment">"Working on VM $($vm.Name) @ '$($vm.Path)'"</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentSnapShots = <span class="hljs-string"><span class="hljs-string">$V</span></span>M | <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">VMSnapshot</span></span> foreach (<span class="hljs-string"><span class="hljs-string">$S</span></span>napShot in <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentSnapShots){ if (<span class="hljs-string"><span class="hljs-string">$S</span></span>napShot.<span class="hljs-type"><span class="hljs-type">Name</span></span> -like (<span class="hljs-comment"><span class="hljs-comment">"Backup*"</span></span>)){ write-host <span class="hljs-comment"><span class="hljs-comment">"Removing VM Checkpoint '$($SnapShot.Name)'"</span></span> <span class="hljs-string"><span class="hljs-string">$S</span></span>napShot | <span class="hljs-type"><span class="hljs-type">Remove</span></span>-<span class="hljs-type"><span class="hljs-type">VMSnapshot</span></span> # -<span class="hljs-type"><span class="hljs-type">ComputerName</span></span> <span class="hljs-string"><span class="hljs-string">$C</span></span>lusterMachine.<span class="hljs-type"><span class="hljs-type">OwnerNode</span></span> <span class="hljs-string"><span class="hljs-string">$L</span></span>oopCount=<span class="hljs-number"><span class="hljs-number">0</span></span> do { <span class="hljs-type"><span class="hljs-type">Write</span></span>-host <span class="hljs-comment"><span class="hljs-comment">"Waiting for snapshot '$($SnapShot.name)' to delete..."</span></span> <span class="hljs-type"><span class="hljs-type">Start</span></span>-<span class="hljs-type"><span class="hljs-type">Sleep</span></span> -s <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-string"><span class="hljs-string">$L</span></span>oopCount=<span class="hljs-string"><span class="hljs-string">$L</span></span>oopCount+<span class="hljs-number"><span class="hljs-number">1</span></span> }while (<span class="hljs-string"><span class="hljs-string">$V</span></span>M.<span class="hljs-type"><span class="hljs-type">Status</span></span> -eq <span class="hljs-comment"><span class="hljs-comment">"Merging disks"</span></span> -and <span class="hljs-string"><span class="hljs-string">$L</span></span>oopCount -lt <span class="hljs-number"><span class="hljs-number">30</span></span>) } } }</code> </pre> <br></div></div><br>  Snapshot can not be deleted, then it will be possible to make incremental backups (the script has the beginnings of such functionality - DayOfWeekForFullBackup). <br><br><h2>  Cassette </h2><br>  We use tape libraries: such a <s>dvuhunitovaya dvuhinyunitovaya</s> <s>dvuhshshkovaya</s> box with cassettes, one or two streamers and a robot avto-changer.  Bacula, and by inheritance, and Bareos, are excellent friends with tapes (better than with HDD).  What confused me - in one library, the Baros discovered two autochanger, this should not be.  It turned out that the device was programmatically divided into two ‚Äúlogical libraries‚Äù since the time of the struggle with DPM.  Go to the device admin panel and disable it unnecessary, now the system has the correct number of changers - one.  The devices will be shown by the command <code>ls /dev/tape/by-id/</code> , with the suffix "-nst" - writing drive, without it - a robot avto-changer. <br><br>  Regarding the use of two drives for parallel writing to one pool (set of volumes): this would reduce the recording time, but did not do so.  In the selected window backups and so fit, but the flow of the film may increase.  But if anyone wants a parallel entry, do not forget to set the <code>Prefer Mounted Volumes</code> to <code>No</code>  You can write in two different pools without problems and an overhead projector. <br><br>  Scratch pools.  I want to draw attention to them: of them, the baros takes the tapes to add to the other pools to which he is going to write.  An unknown tape without a baros baron will not be added to the work pool.  Therefore, all new tapes are added to the Scratch pool: <br><br><pre> <code class="hljs pgsql">label barcodes storage=mylittlestorage slot=<span class="hljs-number"><span class="hljs-number">1</span></span> pool=Scratch</code> </pre> <br>  You can add not to Scratch, but immediately to the working pool, but if there are several pools, it is not always possible to predict how many cassettes you need.  Therefore, let him take it out of necessity. <br><br>  The size of blocks and files need to be put more, it will have a beneficial effect on the speed of the tapes.  <i>‚ÄúIf you‚Äôre looking for a LTO-4 or newer drive, you</i> can‚Äôt make it a little bit more. <i>‚Äù</i> So don't be shy. <br><br>  In order for the baros not to be tempted to write something onto a cassette that is already in a distant safe, it is better to change its status from Append to Used before recess: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> volume=KYF389L6 volstatus=Used</code> </pre> <br>  The same command can change other properties of the cassette, say, move to another pool: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> volume=KYF389L6 pool=YetAnotherPool</code> </pre> <br>  The cassette is easy to steal (well, easier than the IBM DS8800), so it is highly desirable to encrypt the data.  You can do this by means of the writer itself, but I like software solutions as more versatile and flexible.  Just <a href="http://doc.bareos.org/master/html/bareos-manual-main-reference.html">don't forget</a> . <br><br>  It happens that the baros has once written a label on a cassette, but does not have a record of this cassette in the database.  The second time the <code>label</code> does not work (‚Äúerror: already labeled‚Äù), there is an <code>add</code> command, but in my case it caused problems, after which it was impossible to use the cassette.  In this case, such a one-liner was born (it is executed in bash on the sd server, the bareos-sd itself must be stopped): <br><br><pre> <code class="hljs pgsql">mtx -f /dev/sg10 <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> &amp;&amp; mt -f /dev/st0 rewind &amp;&amp; mt -f /dev/st0 weof &amp;&amp; mt -f /dev/st0 rewind &amp;&amp; mtx -f /dev/sg10 unload</code> </pre> <br>  If it does not allow unloading, then <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mt</span></span> -f /dev/st0 offline</code> </pre> <br><h2>  Spooling </h2><br>  This is when the data is written first to the SSD (or at least a fast HDD), and then to the tape.  Compared with the sequential execution, the runtime of the streamer is reduced (he writes faster) and the total time of task execution, if there are a lot of them.  If the task is one, the time taken to use the drive will also be reduced, but the total time to complete the task will increase. <br><br>  To work, first on the sd side you need to specify the location and size of the spooler: <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">Device</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">Name</span></span> = Drive-<span class="hljs-number"><span class="hljs-number">0</span></span> ... <span class="hljs-comment"><span class="hljs-comment">#   Maximum Concurrent Jobs = 20 Spool Directory = /mnt/backup/spool Maximum Spool Size = 1950 G Maximum Job Spool Size = 1200 G }</span></span></code> </pre> <br>  and then enable for specific tasks: <br><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">JobDefs</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">Name</span></span> = <span class="hljs-string"><span class="hljs-string">"SundayTape"</span></span> ... Spool Data = Yes }</code> </pre> <br>  I have this directive in the template of the ‚Äúribbon‚Äù task, and for the ‚Äúdisk‚Äù tasks the spooling is practically useless. <br><br>  The principles are: <br><br><ul><li>  The assignment can be read from the source and written to the spooler (hereinafter ‚Äúreading‚Äù) or read from the spooler and written to the tape (hereinafter referred to as ‚Äúwriting‚Äù).  At the same time, both are not; for this, you will need to split the task into two.  Therefore, I recommended above to do smaller tasks. </li><li>  it is desirable that the writer write at the maximum speed, for this purpose, there should always be data ready for writing in the spooler (in status storage = my-little-storage, they are marked with the flag spool_wait). </li><li>  it is necessary that the spooler does not overflow.  If it overflows, then all the data from it (all the tasks at once!) Will want to be recorded on the tape (arrogate), causing fragmentation on the tape.  Some 300 GB can be spread over three 2.5 TB tapes, but we don‚Äôt need it. </li></ul><br>  The size of the spooler and the number of simultaneous tasks depend on the total number of tasks, sizes of tasks, data reading speed (which can rest on the network or spooler speed), tape recording speed, ratios of sizes and speeds of different tasks, human desires (get results faster, or less Piskaku, or spend less cassettes).  All this can be connected with the hellish matan, but I recommend setting up the spool as a god will put it, because even the simplified rules are not simple: <br><br><ul><li>  you need to select the number of simultaneously running jobs, so that in total they give more data than the bandwidth of the tape.  The speeds of different sources can vary greatly, even the speed of one source can vary greatly.  For example, fixed vhdx can give 100 MB / s at the beginning and 500 KB / s at the end, when fd returns shrunk zeros.  This makes calculation difficult, but c'est la vie, take it with a margin. </li><li>  ideally, the spooler should accommodate all the simultaneously executed tasks.  But not everyone has so much SSD, and the HDD speed may be less than the speed of some LTO-6. </li><li>  while data from one source is still being read (spooled), other data may already be recorded and make room in the spooler, due to this the spooler can be reduced.  Here, the greater the difference in the size of the tasks, the better (if all the tasks cannot be made small). </li><li>  if all the tasks have been completed, except for the one of the largest, then let it spooled / despall as much as possible, it will not do any more fragmentation. </li><li>  if you want to arrange your tasks in a certain order (say, first run a couple of small ones and the biggest, and then all the others - this is advantageous in time), then set them with different schedules or different priorities (but in this case do not forget <code>Allow Mixed Priority</code> ) </li></ul><br>  The number of simultaneously performed tasks is limited in many places, look in the documentation ‚ÄúConcurrent Jobs =‚Äù.  It turned out to be convenient for me to put a large number with a margin everywhere, and limit it to the required number on a specific device ( <a href="http://doc.bareos.org/master/html/bareos-manual-main-reference.html">sd device</a> ). <br><br><h2>  About files </h2><br>  Linuksovaya habit - to crawl into the guts, pick open and ruffle.  I wanted the same thing with the Baros file volumes so that you can find the volume you need and restore it even when the director is not working.  For this, I tried for each task to create a new file with a name containing the name of the task.  I had to delete obsolete volumes with a crown script, and also make sure that each volume has a task in the database and vice versa.  Bareos quickly began to grow into eerie crutches, it was decided to abandon the human-readable naming, use meaningless names and Recycle (cleaning and reusing the file for another task).  Still, without a director, nowhere, if you lose a server one, you need to restore it first of all. <br><br>  And <a href="http://www.ibm.com/developerworks/ru/library/l-Backup_4/">IBM recommends</a> storing one task in one file, and so far I agree with them. <br><br><h2>  Monitoring </h2><br>  Some reporting facilities on the street ^ W ^ W also had to be added with scripts.  The script that returns the status of the last task launch was the most popular. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash RED='\033[0;31m' NC='\033[0m' # No Color GREEN='\033[0;32m' YELLOW='\033[0;33m' JOBS=`su - postgres -c "psql -d bareos -c \"WITH summary AS ( SELECT name,jobstatus,jobid, ROW_NUMBER() OVER(PARTITION BY name ORDER BY starttime DESC) AS rk FROM job p WHERE starttime &gt; current_date - INTERVAL '5 days') SELECT s.* FROM summary s WHERE s.rk=1;\"" | grep "1$" | sed 's/ //g'` #echo "$JOBS" for job in $JOBS; do jobstatus=`echo $job | cut -d '|' -f2` jobname=`echo $job | cut -d '|' -f1` jobid=$(echo $job | cut -d '|' -f3) if [ "$jobstatus" == "R" ]; then printf "%-30s" "$jobname ($jobid)" echo -e "$YELLOW running$NC ($jobstatus)" elif [ "$jobstatus" == "W" ]; then printf "%-30s" "$jobname ($jobid)" echo -e "$YELLOW warning$NC ($jobstatus)" elif [ "$jobstatus" == "T" ]; then if [[ $1 == "printall" ]]; then printf "%-30s" "$jobname ($jobid)" echo -e "$GREEN OK$NC ($jobstatus)" fi else printf "%-30s" "$jobname ($jobid)" echo -e "$RED failed$NC ($jobstatus)" fi done</span></span></code> </pre></div></div><br>  The original version of the script also checked the fact of encryption, but this turned out to be a breeze.  If there are problems with encryption, the task is fatally completed, which will be seen again by status. <br><br><div class="spoiler">  <b class="spoiler_title">There is a version for Zabbix</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash JOBS=`su - postgres -c "psql -d bareos -c \" SELECT name,starttime,jobstatus FROM job p WHERE starttime &gt; current_date - INTERVAL '62 days' AND name = '$1' ORDER BY starttime DESC LIMIT 1;\"" | sed 's/ //g' | grep "|.$"` for job in $JOBS; do jobname=`echo $job | cut -d '|' -f1` jobstatus=`echo $job | cut -d '|' -f3` if [ "$jobstatus" == "E" ] || [ "$jobstatus" == "f" ]; then #echo "Job $jobname failed ($jobstatus)." echo "3" exit elif [ "$jobstatus" == "W" ]; then #echo "Job $jobname with warning ($jobstatus)." echo "1" exit elif [ "$jobstatus" != "T" ] &amp;&amp; [ "$jobstatus" != "R" ]; then #echo "Job $jobname not ok ($jobstatus)." echo "2" exit elif [ "$jobfiles" == 0 ] || [ "$jobbytes" == 0 ] ; then #echo "Job $jobname is empty." echo "4" exit else echo "0" exit fi done</span></span></code> </pre> <br>  The discovery script (LLD) is pinned to the bconsole output format and can easily break, but it still works.  And JSON is molded by hand, but for now it also works. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash FIRST=true JOBS=$(echo "show jobs" | bconsole | grep "^ *Name = \|Enabled = no" | sed 'N;/\n Enabled = no/d;P;D' | grep -v -e "-test\"$" | cut -d'=' -f 2 | grep -o "[a-zA-Z0-9_-]*" ) echo '{ "data": [' for job in $JOBS; do if [ "$FIRST" = false ]; then echo -n "," fi FIRST=false echo "" echo " {" echo " \"{#JOBNAME}\": \"$job\"" echo -n " }" done echo ' ] }'</span></span></code> </pre> <br></div></div><br>  And I also love stacked graphics in zabbiks, for example, the volume of film occupied by different tasks: <br><br><img src="https://habrastorage.org/web/3c4/07b/92f/3c407b92f9554af78db90908f496703b.png"><br><br>  It is evident that it is time to divide the blue task into several small ones. <br><br><h2>  Pleasant trifles </h2><br><ul><li>  From the very beginning I used the <code>status storage=</code> command, but for some reason it didn‚Äôt occur to me to make the <code>status director</code> .  A convenient summary was found there (and if the <code>watch "echo 'status director' | bconsole"</code> , then it is practically a dashboard), its simplicity is especially useful for operators of cassette changers. </li><li>  BashI's Ctrl + R (search through command history), Ctrl + W (delete word) and the like work in bconsole. </li></ul><br><h2>  Future achievements </h2><br><ul><li>  Bootstraps.  If the director of Baros is lost in a disaster along with the business servers, the admin will be called into the recovery of production servers may be delayed in the wristworm ^ W ^ W ^ W ^ W.  To quickly restore the director, the director backs up himself and sends bootstraps to my mail.  But I do not know what to do with them, the instructions are not very intelligible, I have not tested them yet.  Therefore, at the end of the session, the baros still stupidly backs up the virtual machine with itself and immediately restores it to another server.  And still there is a backup director with a copy of configs and a <a href="https://www.8host.com/blog/replikaciya-baz-dannyx-postgresql-po-tipu-masterslave/">replica postgres</a> .  But bootstraps will have to be mastered. </li><li>  Make a normal migration.  There is such a theoretically cool thing - migration: for example, we keep backups for today and yesterday on disks, and then they move to tapes.  But beautifully it is not working now.  Bareos will not write multiple volume files on one tape (which is also a volume).  He wants to write each file on a separate tape.  This is logical, but extremely impractical, because we have one task in the file, and the tasks are small, remember? </li><li>  Unlink the pool from the library.  I have two libraries (one of them is dual-drive), and the entry in each pool is tied to a specific device (data can be restored on any device, there are no problems with this).  In the description of the pool, you can specify several devices, then a matter of time: you need to sit down, make and potestit. </li><li>  Get lz4 to work on linux-fd.  Something collected <a href="https://github.com/bareos/fastlzlib/">from here</a> , but did not work right <a href="https://github.com/bareos/fastlzlib/">away</a> , until I figured it out. </li></ul><br>  Ask questions, the software is clear, although with character, I want to contribute to its spread. <br><br>  And do not forget <a href="http://checkyourbackups.work/">to check your backups.</a> </div><p>Source: <a href="https://habr.com/ru/post/275259/">https://habr.com/ru/post/275259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275245/index.html">The best gift book for well-read fans of JavaScript</a></li>
<li><a href="../275247/index.html">Almost perfect computer security may be closer than you think.</a></li>
<li><a href="../275249/index.html">The problem of duplication and obsolescence of knowledge in mock objects or Integration tests is good</a></li>
<li><a href="../275251/index.html">Notes on SQL and relational algebra</a></li>
<li><a href="../275255/index.html">We write MVP application on Kotlin for Android</a></li>
<li><a href="../275265/index.html">The digest of interesting materials for the mobile # 136 developer (on January 11-17)</a></li>
<li><a href="../275267/index.html">Personal account for dealers in 5 minutes</a></li>
<li><a href="../275269/index.html">Parallel Sequential Scan Commited</a></li>
<li><a href="../275271/index.html">The story of one integration, or how we stopped worrying and fell in love with InterSystems Ensemble</a></li>
<li><a href="../275273/index.html">How to reduce the number of measurements and benefit from it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>