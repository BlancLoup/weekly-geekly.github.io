<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Virtual quadrocopter on Unity + OpenCV (Part 3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Today I would like to continue the series on how to make friends with Unity, C ++ and OpenCV. As well as how to get a virtual environment fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Virtual quadrocopter on Unity + OpenCV (Part 3)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/615/d6d/2af/615d6d2af5d64a1b8ee955dae6e5aef8.png" alt="CPDV"><br><br>  Hello! <br><br>  Today I would like to continue the series on how to make friends with Unity, C ++ and OpenCV.  As well as how to get a virtual environment for testing computer vision algorithms and navigating drones based on Unity.  In previous articles, I talked about <a href="http://habrahabr.ru/post/267791/">how to make a virtual quadrocopter in Unity</a> and <a href="http://habrahabr.ru/post/269007/">how to connect the C ++ plugin, transfer the image from the virtual camera there and process it using OpenCV</a> .  In this article I will explain how to make a stereo pair of two virtual cameras on a quadrocopter and how to get a disparity map, which can be used to estimate the depth of image pixels. <br><a name="habracut"></a><br><h4>  Idea </h4><br>  How to make a 3D reconstruction is written not enough.  For example, there is a <a href="http://habrahabr.ru/post/130300/">wonderful article on Habr√©</a> .  I strongly advise you to read it, if you are not at all in the subject.  More strictly mathematically can be read <a href="https://www.robots.ox.ac.uk/~vgg/hzbook/">here</a> .  Here I will sooo simplify the basic idea.  The technique for obtaining the displacement map to be used is called a dense 3d reconstruction (two-dimensional reconstruction).  It is used that two adjacent and having the same orientation of the camera see the same scene from slightly different points of view.  This is called a <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2580%25D0%25B0">stereo pair</a> .  We will use the usual horizontal stereo pair, that is, cameras that are perpendicular to the direction of the camera‚Äôs ‚Äúview‚Äù.  If we find the same point of the scene on the first and second images, that is, we find two projections of the point of the scene, then we can see that, in general, the coordinates of these two projections do not match.  That is, the projections are shifted relative to each other in the case of overlapping images.  This makes it possible to calculate the depth of the point of the scene by the magnitude of the displacement (simplified: the more shifted points are closer than the less shifted points). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/d80/b6c/a3f/d80b6ca3fc0f4a72a81557e2c9859ff5.jpg" alt="Stereo pair and depth points"><br>  image from <a href="http://www.adept.net.au/news/newsletter/201211-nov/article_3D_stereo.shtml">www.adept.net.au/news/newsletter/201211-nov/article_3D_stereo.shtml</a> <br><br>  To do this you need to calibrate the camera.  Next, you need to calibrate the stereo pair, remove <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D1%2581%25D1%2582%25D0%25BE%25D1%2580%25D1%2581%25D0%25B8%25D1%258F">distortion</a> and straighten the image, so that those same projection points lie on the same horizontal line.  This is a requirement of the dense 3D reconstruction algorithm from OpenCV, which accelerates the search for the corresponding points.  We will use the easiest and fastest algorithm from OpenCV - StereoBM.  Description of the API is <a href="http://docs.opencv.org/3.0-beta/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html">here</a> .  Let's get started <br><br><h4>  Camera Calibration </h4><br>  How to add another camera to a quadrocopter and get an image from it is described in the previous article, so let's start with camera calibration right away.  I use two cameras with a viewing angle (field of view) of 70 degrees, image textures from cameras with a resolution of 512 x 512 pixels.  Calibrating the camera means getting a 3x3 matrix of internal parameters and a vector of parameters for its distortion.  Calibration is done by obtaining a set of calibration samples.  One calibration sample is the coordinates of the points of the calibration pattern with a previously known geometry in the two-dimensional reference system of the camera image.  The quality of the calibration is very dependent on the work of all algorithms that use it, so it is very important to calibrate the camera well.  I calibrate by 40-50 calibration samples, and the large variability of calibration samples is important, that is, whenever possible, it is necessary to get as wide a spread as possible on the orientations and positions of the calibration pattern relative to the camera.  The presentation of almost identical 50 calibration samples will give a low quality camera calibration.  I use <a href="">this calibration pettarn</a> .  It‚Äôs just possible to drag-and-drop in Unity and set it with a texture for a 2D sprite.  All the dimensions in the program I specify in pixels, the size of the side of the square of this pattern is 167 pixels.  For him, there is already a function to search it on the image in OpenCV.  For inspiration, you can use the example from opencv-source / samples / cpp / calibration.cpp.  Actually, I did. <br><br><div class="spoiler">  <b class="spoiler_title">Code for basic calibration functions</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/** @brief             . Size boardSize (9, 6) -    ,      ,  sampleFound        */</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> CameraCalibrator::findSample (const cv::Mat&amp; img) { currentSamplePoints.clear(); <span class="hljs-type"><span class="hljs-type">int</span></span> chessBoardFlags = CALIB_CB_ADAPTIVE_THRESH | CALIB_CB_NORMALIZE_IMAGE; sampleFound = findChessboardCorners( img, boardSize, currentSamplePoints, chessBoardFlags); currentImage = &amp;img; } <span class="hljs-type"><span class="hljs-type">bool</span></span> CameraCalibrator::isSampleFound () { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sampleFound; } <span class="hljs-comment"><span class="hljs-comment">/** @brief     */</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> CameraCalibrator::acceptSample () { //      Mat viewGray; cvtColor(*currentImage, viewGray, COLOR_BGR2GRAY); cornerSubPix( viewGray, currentSamplePoints, Size(<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>), Size(<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>), TermCriteria( TermCriteria::EPS+TermCriteria::COUNT, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span> )); //      (     ) drawChessboardCorners(*currentImage, boardSize, Mat(currentSamplePoints), sampleFound); //  samplesPoints.push_back(currentSamplePoints); } <span class="hljs-comment"><span class="hljs-comment">/** @brief     */</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> CameraCalibrator::makeCalibration () { vector&lt;Mat&gt; rvecs, tvecs; vector&lt;<span class="hljs-type"><span class="hljs-type">float</span></span>&gt; reprojErrs; <span class="hljs-type"><span class="hljs-type">double</span></span> totalAvgErr = <span class="hljs-number"><span class="hljs-number">0</span></span>; //  ,       //     , //   -   ,   //     ,  //   <span class="hljs-type"><span class="hljs-type">float</span></span> aspectRatio = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> flags = CV_CALIB_FIX_ASPECT_RATIO; <span class="hljs-type"><span class="hljs-type">bool</span></span> ok = runCalibration(samplesPoints, imageSize, boardSize, squareSize, aspectRatio, flags, cameraMatrix, distCoeffs, rvecs, tvecs, reprojErrs, totalAvgErr); //      stringstream sstr; sstr &lt;&lt; "--- calib result: " &lt;&lt; (ok ? "Calibration succeeded" : "Calibration failed") &lt;&lt; ". avg reprojection error = " &lt;&lt; totalAvgErr; DebugLog(sstr.str()); saveCameraParams(imageSize, boardSize, squareSize, aspectRatio, flags, cameraMatrix, distCoeffs, rvecs, tvecs, reprojErrs, samplesPoints, totalAvgErr); } <span class="hljs-comment"><span class="hljs-comment">/** @brief      */</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> calcChessboardCorners(Size boardSize, <span class="hljs-type"><span class="hljs-type">float</span></span> squareSize, vector&lt;Point3f&gt;&amp; corners) { corners.resize(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; boardSize.height; ++i ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( <span class="hljs-type"><span class="hljs-type">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; boardSize.width; ++j ) corners.push_back(Point3f(j*squareSize, i*squareSize, <span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">/** @brief    */</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> runCalibration( vector&lt;vector&lt;Point2f&gt; &gt; imagePoints, Size imageSize, Size boardSize, <span class="hljs-type"><span class="hljs-type">float</span></span> squareSize, <span class="hljs-type"><span class="hljs-type">float</span></span> aspectRatio, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, Mat&amp; cameraMatrix, Mat&amp; distCoeffs, vector&lt;Mat&gt;&amp; rvecs, vector&lt;Mat&gt;&amp; tvecs, vector&lt;<span class="hljs-type"><span class="hljs-type">float</span></span>&gt;&amp; reprojErrs, <span class="hljs-type"><span class="hljs-type">double</span></span>&amp; totalAvgErr ) { //     cameraMatrix = Mat::eye(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, CV_64F); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( flags &amp; CALIB_FIX_ASPECT_RATIO ) cameraMatrix.at&lt;<span class="hljs-type"><span class="hljs-type">double</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) = aspectRatio; //   distCoeffs = Mat::zeros(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, CV_64F); //      //    //    vector&lt;vector&lt;Point3f&gt; &gt; objectPoints(<span class="hljs-number"><span class="hljs-number">1</span></span>); calcChessboardCorners(boardSize, squareSize, objectPoints[<span class="hljs-number"><span class="hljs-number">0</span></span>]); objectPoints.resize(imagePoints.size(),objectPoints[<span class="hljs-number"><span class="hljs-number">0</span></span>]); // OpenCV   //objectPoints -      //imagePoints -   //imageSize -    <span class="hljs-type"><span class="hljs-type">double</span></span> rms = calibrateCamera(objectPoints, imagePoints, imageSize, cameraMatrix, distCoeffs, rvecs, tvecs, flags|CALIB_FIX_K4|CALIB_FIX_K5); //<span class="hljs-comment"><span class="hljs-comment">/*|CALIB_FIX_K3*/</span></span>|CALIB_FIX_K4|CALIB_FIX_K5); //rms -   ,   , //     ,   <span class="hljs-number"><span class="hljs-number">1</span></span> printf("RMS error reported by calibrateCamera: %g\n", rms); <span class="hljs-type"><span class="hljs-type">bool</span></span> ok = checkRange(cameraMatrix) &amp;&amp; checkRange(distCoeffs); totalAvgErr = computeReprojectionErrors(objectPoints, imagePoints, rvecs, tvecs, cameraMatrix, distCoeffs, reprojErrs); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ok; }</code> </pre> <br></div></div><br><h4>  Stereo pair </h4><br>  Now we need to make a stereo pair from our two cameras.  For this, the <a href="http://docs.opencv.org/3.0-beta/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html">stereoCalibrate</a> function is <a href="http://docs.opencv.org/3.0-beta/modules/calib3d/doc/camera_calibration_and_3d_reconstruction.html">used</a> .  For her, we will need samples of both cameras.  We will use samples taken from the camera calibration step.  Therefore, it is important to save only those samples where the calibration pattern is found on two images at once.  The matrixes of cameras and their distortion parameters will be needed as good initial approximations. <br><br><div class="spoiler">  <b class="spoiler_title">Stereo calibration code</b> <div class="spoiler_text"><pre> <code class="hljs php"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@brief</span></span></span><span class="hljs-comment"> ,    */</span></span> void StereoCalibrator::makeCalibration ( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> std::vector&lt;std::vector&lt;cv::Point2f&gt;&gt;&amp; camera1SamplesPoints, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> std::vector&lt;std::vector&lt;cv::Point2f&gt;&gt;&amp; camera2SamplesPoints, cv::Mat&amp; camera1Matrix, cv::Mat&amp; camera1DistCoeffs, cv::Mat&amp; camera2Matrix, cv::Mat&amp; camera2DistCoeffs ) { <span class="hljs-comment"><span class="hljs-comment">//       std::vector&lt;vector&lt;Point3f&gt;&gt; objectPoints; for( int i = 0; i &lt; camera1SamplesPoints.size(); i++ ) { objectPoints.push_back(chessboardCorners); } double rms = stereoCalibrate( objectPoints, camera1SamplesPoints, camera2SamplesPoints, //        camera1Matrix, camera1DistCoeffs, camera2Matrix, camera2DistCoeffs, //   imageSize, //         rotationMatrix, //        translationVector, //    essentialMatrix, //    fundamentalMatrix, //,        //       CV_CALIB_USE_INTRINSIC_GUESS, TermCriteria(TermCriteria::COUNT+TermCriteria::EPS, 100, 1e-5) ); //      - // , ,  ,      1 stringstream outs; outs &lt;&lt; "--- stereo calib: done with RMS error=" &lt;&lt; rms; DebugLog(outs.str()); }</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/files/108/89a/876/10889a8763c14b169347d244d3056129.png" alt="Unity stereo pair"><br><br><div class="spoiler">  <b class="spoiler_title">The calibration parameters I got</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"> //512, 70 deg Mat cam1 = (Mat_</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(3, 3) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">355.3383989449604</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">258.0008490063121</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">354.5068750418187</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">255.7252273330564</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mat</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dist1</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(Mat_</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(5, 1) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.02781875153957544</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.05084431574408409</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.0003262438299225566</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.0005420218184546293</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.06711413339515834</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mat</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cam2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(Mat_</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(3, 3) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">354.8366825622115</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">255.7668702403205</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">353.9950515096826</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">254.3218524455621</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mat</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dist2</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(Mat_</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(12, 1) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.03429254591232522</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.04304840389703278</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.0005799461588668822</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.0005396568753307817</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.01867317550268149</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mat</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">R</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(Mat_</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(3, 3) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.9999698145104303</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3.974878365893637e-06</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.007769816740176146</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-3.390471048492443e-05</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.9999925806915616</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.003851936175643478</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.00776974378253147</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-0.003852083336451321</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.9999623955607145</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Mat</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">T</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">(Mat_</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">(3, 1) </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">498.2890078004688</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0.3317087752736566</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-6.137837861924672</span></span></span></span><span class="xml"><span class="hljs-tag">);</span></span></span></span></code> </pre><br></div></div><br><h4>  Displacement map </h4><br>  Now it is the turn to calculate the displacement map.  Even if you did all the previous steps correctly, it‚Äôs not a fact that you can immediately calculate it.  The fact is that the algorithm for calculating the map offset the order of 10 parameters that you need to choose the right to get a good picture.  It helps to understand what's the point here is this video <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/FX7AMktf24E%3Ffeature%3Doembed&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgUN98rbIKxrf14nqv9HJNpUbqT3g" frameborder="0" allowfullscreen=""></iframe><br><br>  from <a href="http://blog.martinperis.com/2011/08/opencv-stereo-matching.html">this article</a> .  Regarding the setting of parameters, I also do not advise you to pick up the TextureThreshold parameter greater than 50, since it is known that the StereoBM algorithm starts to fall spontaneously. <br><br><div class="spoiler">  <b class="spoiler_title">Offset Card Receipt Code</b> <div class="spoiler_text"><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     DisparityMapCalculator::DisparityMapCalculator () { bm = StereoBM::create(16,9); } /</span></span>** @brief         *<span class="hljs-regexp"><span class="hljs-regexp">/ void DisparityMapCalculator::set ( cv::Mat camera1Matrix, cv::Mat camera2Matrix, cv::Mat camera1distCoeff, cv::Mat camera2distCoeff, cv::Mat rotationMatrix, cv::Mat translationVector, cv::Size imageSize ) { this-&gt;camera1Matrix = camera1Matrix; this-&gt;camera2Matrix = camera2Matrix; this-&gt;camera1distCoeff = camera1distCoeff; this-&gt;camera2distCoeff = camera2distCoeff; this-&gt;rotationMatrix = rotationMatrix; this-&gt;translationVector = translationVector; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ()  stereoRectify( camera1Matrix, camera1distCoeff, camera2Matrix, camera2distCoeff, imageSize, rotationMatrix, translationVector, R1, R2, P1, P2, Q, /</span></span>*CALIB_ZERO_DISPARITY*<span class="hljs-regexp"><span class="hljs-regexp">/0, -1, imageSize, &amp;roi1, &amp;roi2 ); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     initUndistortRectifyMap(camera1Matrix, camera1distCoeff, R1, P1, imageSize, CV_16SC2, map11, map12); initUndistortRectifyMap(camera2Matrix, camera2distCoeff, R2, P2, imageSize, CV_16SC2, map21, map22); bm-&gt;setROI1(roi1); bm-&gt;setROI2(roi2); } /</span></span>** @brief        *<span class="hljs-regexp"><span class="hljs-regexp">/ void DisparityMapCalculator::setBMParameters ( int preFilterSize, int preFilterCap, int blockSize, int minDisparity, int numDisparities, int textureThreshold, int uniquenessRatio, int speckleWindowSize, int speckleRange, int disp12maxDiff ) { bm-&gt;setPreFilterSize(preFilterSize); bm-&gt;setPreFilterCap(preFilterCap); bm-&gt;setBlockSize(blockSize); bm-&gt;setMinDisparity(minDisparity); bm-&gt;setNumDisparities(numDisparities); bm-&gt;setTextureThreshold(textureThreshold); bm-&gt;setUniquenessRatio(uniquenessRatio); bm-&gt;setSpeckleWindowSize(speckleWindowSize); bm-&gt;setSpeckleRange(speckleRange); bm-&gt;setDisp12MaxDiff(disp12maxDiff); } /</span></span>** @brief    *<span class="hljs-regexp"><span class="hljs-regexp">/ void DisparityMapCalculator::compute ( const cv::Mat&amp; image1, const cv::Mat&amp; image2, cv::Mat&amp; image1recified, cv::Mat&amp; image2recified, cv::Mat&amp; disparityMap ) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   remap(image1, image1recified, map11, map12, INTER_LINEAR); remap(image2, image2recified, map21, map22, INTER_LINEAR); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/          . /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     OpenGL  ,   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   , /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      OpenGL  OpenCV /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      ,     flip(image1recified, L, 1); flip(image2recified, R, 1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ stereo bm -     sgbm, /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ StereoBM        cv::cvtColor(L, image1gray, CV_RGBA2GRAY, 1); cv::cvtColor(R, image2gray, CV_RGBA2GRAY, 1); int numberOfDisparities = bm-&gt;getNumDisparities(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   bm-&gt;compute(image1gray, image2gray, disp); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,    disp.convertTo(disp8bit, CV_8U, 255/</span></span>(numberOfDisparities*<span class="hljs-number"><span class="hljs-number">16</span></span>.)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,       Unity flip (disp8bit, disp, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-number"><span class="hljs-number">4</span></span>   /<span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 4  cv::cvtColor(disp, disparityMap, CV_GRAY2RGBA, 4); }</span></span></code> </pre><br></div></div><br>  You can also watch the video how it all works for me. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/7nm1UAeaf6E%3Ffeature%3Doembed&amp;xid=25657,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhVrwe4YmJAeYyO28bnkhht4LvG8g" frameborder="0" allowfullscreen=""></iframe><br><br>  The algorithm used to calculate the displacement map is quite old, so the result is not very nice.  I think that it can be improved by using some more modern algorithm, but for this OpenCV alone is not enough. <br><br>  Thank you for the scene <a href="https://sketchfab.com/ThomasKole">ThomasKole</a> <br>  The code can be taken <a href="https://github.com/parilo/quadrocopter-unity-opencv">from github</a> , branch habr_part3_disparity_map_opencv_stereobm <br><br>  Thanks for attention </div><p>Source: <a href="https://habr.com/ru/post/271337/">https://habr.com/ru/post/271337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271323/index.html">Drupal 8 released - critical look</a></li>
<li><a href="../271325/index.html">The digest of news from the world of development on Unity</a></li>
<li><a href="../271329/index.html">New Yandex.Webmaster</a></li>
<li><a href="../271331/index.html">Dynamic creation of Windows and Web CRUD interfaces and not only for business applications with XAF + Entity Framework. Part 1</a></li>
<li><a href="../271333/index.html">Pirate metrics: how to create an email campaign based on the AARRR principle. Part 5</a></li>
<li><a href="../271339/index.html">‚ÄúMy code doesn't interest anyone‚Äù or why good web studios should challenge this</a></li>
<li><a href="../271341/index.html">New PandaLabs Quarterly Lab Quarterly Report</a></li>
<li><a href="../271343/index.html">Can nanoCAD replace western CAD solutions? Let's look for an answer ...</a></li>
<li><a href="../271345/index.html">How Microsoft participated in the 8-week hackathon "AlfaCamp 2.0"</a></li>
<li><a href="../271347/index.html">Digging just down</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>