<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage your browser with PHP and Selenium</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 
 Hello! Today I will tell you about how PHP can work with Selenium . 

 Most often it is necessary when you are faced with the task of writing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage your browser with PHP and Selenium</h1><div class="post__text post__text-html js-mediator-article"><h2>  Intro </h2><br>  Hello!  Today I will tell you about how PHP can work with <a href="https://www.seleniumhq.org/">Selenium</a> . <br><br>  Most often it is necessary when you are faced with the task of writing autotests for the web interface or your parser / crawler. <br><br><div class="spoiler">  <b class="spoiler_title">From wikipedia</b> <div class="spoiler_text">  <i>‚ÄúSelenium is a tool to automate web browser actions.</i> <i><br></i>  <i>In most cases, it is used to test web applications, but this does not</i> <i><br></i>  <i>is limited.</i>  <i>In particular, the implementation of Selenium WebDriver for the phantomjs browser</i> <i><br></i>  <i>often used as a web grabber. ‚Äù</i> <br></div></div><br>  We will consider the following nuances: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Using <a href="http://behat.org/en/latest/">Behat</a> / <a href="http://mink.behat.org/en/latest/">Mink</a> to connect to Selenium <br></li><li>  Run Selenium in docker, and remote access via <a href="https://ru.wikipedia.org/wiki/Virtual_Network_Computing">VNC</a> <br></li><li>  Expand Behat functionality with the Extension Feature <br></li></ul><a name="habracut"></a><br>  So let's go! <br><br><h2>  1. Cooking Behat and Mink </h2><br>  Behat is a php framework that was originally created for behavioral testing (BDD).  It is the official PHP implementation of the more well-known <a href="https://cucumber.io/">Cucumber</a> product, which is often used in other programming languages. <br><br>  By itself, he does not know how to work with Selenium and is intended more for writing functional tests without using a browser. <br><br>  Installed as a regular package: <br><br><pre><code class="hljs ruby">$ composer <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"behat/behat"</span></span></code> </pre> <br>  To teach behat how to work with a browser, we need its Mink extension, as well as a bridge for working with a specific vendor (in our case, it is Selenium).  A complete list of vendors can be found on the <a href="http://mink.behat.org/en/latest/">Mink page</a> .  Given the versions, your composer.json should look something like this: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"behat/behat"</span></span> : <span class="hljs-string"><span class="hljs-string">"^3.4"</span></span>, <span class="hljs-string"><span class="hljs-string">"behat/mink-extension"</span></span> : <span class="hljs-string"><span class="hljs-string">"2.2"</span></span>, <span class="hljs-string"><span class="hljs-string">"behat/mink-selenium2-driver"</span></span> : <span class="hljs-string"><span class="hljs-string">"^1.3"</span></span> }</code> </pre> <br>  After installation, you will have the <i>vendor / bin / behat</i> file responsible for running the tests.  If <i>vendor / bin / behat --version</i> showed you the installed version, then with high probability the installation was successful :) <br><br>  The final phase is the configuration <br><br><div class="spoiler">  <b class="spoiler_title">Create the main configuration file behat.yml in the project root</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: #     ¬´¬ª  autoload: <span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-string"><span class="hljs-string">'%paths.base%/src/Context'</span></span> suites: #    facebook_suite: # ()   ,   Gherkin <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> paths: - <span class="hljs-string"><span class="hljs-string">'%paths.base%/scenario/facebook'</span></span> contexts: #   ¬´¬ª   . # API     - Dossier\Context\FacebookContext: #       FacebookContext base_url: <span class="hljs-string"><span class="hljs-string">'https://www.facebook.com/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">'email@gmail.com'</span></span> pass: <span class="hljs-string"><span class="hljs-string">'password'</span></span> vk_suite: paths: - <span class="hljs-string"><span class="hljs-string">'%paths.base%/scenario/vk'</span></span> contexts: - Dossier\Context\VkContext: #       - "@lookup" services: #      lookup: <span class="hljs-string"><span class="hljs-string">'Dossier\Context\AccessLimit\Lookup'</span></span> extensions: #   ,  behat Behat\MinkExtension: browser_name: <span class="hljs-string"><span class="hljs-string">'chrome'</span></span> default_session: <span class="hljs-string"><span class="hljs-string">'selenium2'</span></span> selenium2: #  Selenium .     IP (     localhost   ) wd_host: <span class="hljs-string"><span class="hljs-string">'http://172.17.0.1:4444/wd/hub'</span></span> #     browser: chrome</code> </pre> <br></div></div><br>  Script files or (* .feature files) - yml files written in the <a href="http://docs.behat.org/en/v2.5/guides/1.gherkin.html">Gherkin</a> pseudo-language contain, in fact, a set of step-by-step instructions that your browser will execute during the execution of a particular suite.  You can learn more about the syntax by clicking on the link above. <br><br>  Each such ‚Äúinstruction‚Äù, in turn, is matched to the methods of the ‚Äúcontext‚Äù class using <b>regular expressions</b> specified in the class annotations.  <a href="https://github.com/Behat/MinkExtension/blob/master/src/Behat/MinkExtension/Context/MinkContext.php">Behat \ MinkExtension \ Context \ MinkContext</a> <br>  The names of the methods themselves do not matter, although it will be good practice to stick to the similar naming annotations in CamelCase. <br><br>  If you lack the default Gherkin constructs, you can extend the functionality in the classes inherited by MinkContext by correctly specifying annotations.  This role is performed by the "context" classes. <br><br><h2>  2. Install and configure the environment </h2><br>  Those of you who have already worked with Selenium know that after starting the test, the browser will start on the machine and go through the steps specified in the .feature file. <br><br>  Running Selenium in Docker is a little more difficult.  First, you will need X in the container, and second, you will want to see what is happening inside the container. <br><br>  The guys from Selenium have already <a href="https://github.com/SeleniumHQ/docker-selenium">taken care of</a> everything and you don‚Äôt have to collect your container.  A container with a Standalone server on board will be immediately available on port 5900, where you can knock on any VNC client (for example, from <a href="https://www.remmina.org/wp/">this</a> ).  Inside the container you will be greeted by a friendly Fluxbox interface with Chrome preinstalled.  In my case, it looks like this: <br><br><img src="https://habrastorage.org/webt/zm/av/ei/zmaveivng51njyrgab906elbpwo.png"><br><br>  To achieve success, you can launch the docker container, according to the instructions on the site: <br><br><pre> <code class="hljs pgsql">$ docker run -d -p <span class="hljs-number"><span class="hljs-number">4444</span></span>:<span class="hljs-number"><span class="hljs-number">4444</span></span> -p <span class="hljs-number"><span class="hljs-number">5900</span></span>:<span class="hljs-number"><span class="hljs-number">5900</span></span> -v /dev/shm:/dev/shm selenium/standalone-chrome-<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>:<span class="hljs-number"><span class="hljs-number">3.11</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>-californium</code> </pre> <br>  An important point, without a shared volume <i>/ dev / shm, there is</i> not enough memory for the <i>chrome</i> and it will not be able to start, so do not forget to specify it. <br><br>  In my case, <a href="https://docs.docker.com/compose/">docker-compose is used</a> , and the YAML file will look like this: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">version:</span></span> <span class="hljs-string"><span class="hljs-string">'2'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">services:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">selenium:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> selenium/standalone-chrome-<span class="hljs-symbol"><span class="hljs-symbol">debug:</span></span><span class="hljs-number"><span class="hljs-number">3.11</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-string"><span class="hljs-string">"4444:4444"</span></span> - <span class="hljs-string"><span class="hljs-string">"5900:5900"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/dev/shm</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/dev/shm</span></span> <span class="hljs-symbol"><span class="hljs-symbol">network_mode:</span></span> <span class="hljs-string"><span class="hljs-string">"host"</span></span></code> </pre><br>  I want my tests to go to Facebook through a VPN that is enabled on the host machine, so it‚Äôs important to specify the <a href="https://docs.docker.com/compose/compose-file/">network_mode</a> . <br><br>  To run the container using compose, run the following command: <br><br><pre> <code class="hljs ruby">$ docker-compose up</code> </pre> <br>  Now we try to connect via VNC to localhost: 5900 and open the browser inside the container.  If you succeeded and you see something similar to the screenshot above - you have passed this level. <br><br><h2>  3. From theory to practice.  Automating </h2><br>  In the example below, I‚Äôll retrieve all Facebook users by the transferred last and first name.  The script will look like this: <br><br><div class="spoiler">  <b class="spoiler_title">src / scenario / facebook / facebook.feature</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">Feature: Facebook Parse <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> parse fb @first-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> Scenario: Find person <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> facebook Given I am <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> "https://facebook.com/" <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> I fill <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> "email" <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> "some@gmail.com" <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> I fill <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> "pass" <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> "somepass" #   <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> I press tricky facebook <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> button <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> I should see "" #   <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> I am searching <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> params <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> I dump users</code> </pre> <br></div></div><br>  And accordingly Context class (constructor and namespaces are omitted) <br><br><div class="spoiler">  <b class="spoiler_title">src / Context / FacebookContext.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacebookContext</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Then</span></span></span><span class="hljs-comment"> /^I press tricky facebook login button$/ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pressFacebookButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getSession()-&gt;getPage()-&gt;find( <span class="hljs-string"><span class="hljs-string">'css'</span></span>, <span class="hljs-string"><span class="hljs-string">'input[data-testid="royal_login_button"]'</span></span> )-&gt;click(); } <span class="hljs-comment"><span class="hljs-comment">/** *    . , , .  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Then</span></span></span><span class="hljs-comment"> /^I dump users$/ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dumpUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $session = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getSession(); $users = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getSession()-&gt;getPage()-&gt;findAll( <span class="hljs-string"><span class="hljs-string">'xpath'</span></span>, $session-&gt;getSelectorsHandler() -&gt;selectorToXpath(<span class="hljs-string"><span class="hljs-string">'css'</span></span>, <span class="hljs-string"><span class="hljs-string">'div._4p2o'</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$users) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \InvalidArgumentException(<span class="hljs-string"><span class="hljs-string">"The user with this name was not found"</span></span>); } $collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserCollection(<span class="hljs-string"><span class="hljs-string">'facebook_suite'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $user) { $img = $user-&gt;find(<span class="hljs-string"><span class="hljs-string">'xpath'</span></span>, $session-&gt;getSelectorsHandler() -&gt;selectorToXpath( <span class="hljs-string"><span class="hljs-string">'xpath'</span></span>, $session-&gt;getSelectorsHandler()-&gt;selectorToXpath(<span class="hljs-string"><span class="hljs-string">'css'</span></span>, <span class="hljs-string"><span class="hljs-string">'img'</span></span>) )); $link = $user-&gt;find(<span class="hljs-string"><span class="hljs-string">'xpath'</span></span>, $session-&gt;getSelectorsHandler() -&gt;selectorToXpath( <span class="hljs-string"><span class="hljs-string">'xpath'</span></span>, $session-&gt;getSelectorsHandler()-&gt;selectorToXpath(<span class="hljs-string"><span class="hljs-string">'css'</span></span>,<span class="hljs-string"><span class="hljs-string">'a._32mo'</span></span>) )); $outputInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputUserInfo(<span class="hljs-string"><span class="hljs-string">'facebook_suite'</span></span>); $outputInfo-&gt;setName($link ? $link-&gt;getText(): <span class="hljs-string"><span class="hljs-string">''</span></span>) -&gt;addPublicLinks($link ? $link-&gt;getAttribute(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) : <span class="hljs-string"><span class="hljs-string">''</span></span>) -&gt;setPhoto($img ? $img-&gt;getAttribute(<span class="hljs-string"><span class="hljs-string">'src'</span></span>) : <span class="hljs-string"><span class="hljs-string">''</span></span>); $collection-&gt;append($outputInfo); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;saveDump($collection); } <span class="hljs-comment"><span class="hljs-comment">/** *        URL * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Then</span></span></span><span class="hljs-comment"> /^I am searching by input params$/ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Registry::has(<span class="hljs-string"><span class="hljs-string">'query'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \BadMethodCallException(<span class="hljs-string"><span class="hljs-string">'No search query received'</span></span>); } $criteria = Registry::get(<span class="hljs-string"><span class="hljs-string">'query'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getSession()-&gt;visit(<span class="hljs-string"><span class="hljs-string">"https://www.facebook.com/search/people/?q="</span></span> . urldecode($criteria-&gt;getQuery())); } }</code> </pre><br></div></div><br>  Often there is a need for custom methods like FacebookContext :: pressFacebookButton, because by default all selectors in mink can only search by name | value | id | alt | title. <br><br>  If you need a sample for another attribute, you will have to write your method.  The Login button for facebook has an id attribute, but changes its value periodically according to some logic of its own.  Therefore, I had to re-connect to data-testid, which, so far, remains static. <br><br>  Now, in order for all this to start, you need to make sure that Selenium is running and listening to the specified port. <br><br>  Then execute: <br><br><pre> <code class="hljs ruby">$ vendor/bin/behat</code> </pre> <br>  The browser instance should start inside the container and go to follow the specified instructions. <br><br><h2>  4. behat customization.  Extensions </h2><br>  The Behat framework has an excellent extension mechanism built in through <i>behat.yml</i> .  Note that many framework classes are declared <i>final</i> to temper the temptation to simply inherit them. <br><br>  The extension allows you to add functionality to behat, declare new console arguments and options, modify the behavior of other extensions, etc. It consists of the class implementing <br>  <a href="https://github.com/Behat/Behat/blob/master/src/Behat/Testwork/ServiceContainer/Extension.php">Behat \ Testwork \ ServiceContainer \ Extension</a> interface (also specified in behat.yml) and helper classes, if needed. <br><br>  I want to teach behat to accept the full name of the person being sought through the new incoming argument - <i>search-by-fullname</i> , in order to use this data within the suite. <br><br>  Below is the code that performs the necessary operations: <br><br><div class="spoiler">  <b class="spoiler_title">SearchExtension</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Gherkin</span></span>\<span class="hljs-title"><span class="hljs-title">ServiceContainer</span></span>\<span class="hljs-title"><span class="hljs-title">GherkinExtension</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Testwork</span></span>\<span class="hljs-title"><span class="hljs-title">Cli</span></span>\<span class="hljs-title"><span class="hljs-title">ServiceContainer</span></span>\<span class="hljs-title"><span class="hljs-title">CliExtension</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Testwork</span></span>\<span class="hljs-title"><span class="hljs-title">ServiceContainer</span></span>\<span class="hljs-title"><span class="hljs-title">Extension</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Testwork</span></span>\<span class="hljs-title"><span class="hljs-title">ServiceContainer</span></span>\<span class="hljs-title"><span class="hljs-title">ExtensionManager</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Config</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">Builder</span></span>\<span class="hljs-title"><span class="hljs-title">ArrayNodeDefinition</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">ContainerBuilder</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">DependencyInjection</span></span>\<span class="hljs-title"><span class="hljs-title">Reference</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *       Extensions   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerBuilder $container)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** *       behat.yml * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConfigKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'search'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** *        ,  *    configure().    *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ExtensionManager $extensionManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExtensionManager $extensionManager)</span></span></span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ArrayNodeDefinition $builder */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ArrayNodeDefinition $builder)</span></span></span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** *      * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> ContainerBuilder $container * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $config */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ContainerBuilder $container, array $config)</span></span></span><span class="hljs-function"> </span></span>{ $definition = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Definition(<span class="hljs-string"><span class="hljs-string">'Dossier\BehatSearch\SearchController'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reference(GherkinExtension::MANAGER_ID) )); $definition-&gt;addTag(CliExtension::CONTROLLER_TAG, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'priority'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)); $container-&gt;setDefinition( CliExtension::CONTROLLER_TAG .<span class="hljs-string"><span class="hljs-string">' . search'</span></span>, $definition ); } }</code> </pre><br></div></div><br>  In the <i>SearchExntesion :: load</i> method, the SearchController Service is <i>forwarded</i> , which is directly responsible for the declaration of parameters and their reception / processing. <br><br><div class="spoiler">  <b class="spoiler_title">SearchController</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Behat</span></span>\<span class="hljs-title"><span class="hljs-title">Testwork</span></span>\<span class="hljs-title"><span class="hljs-title">Cli</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Dossier</span></span>\<span class="hljs-title"><span class="hljs-title">Registry</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Dossier</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">Criteria</span></span>\<span class="hljs-title"><span class="hljs-title">FullnameCriteria</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span>\<span class="hljs-title"><span class="hljs-title">Command</span></span> <span class="hljs-title"><span class="hljs-title">as</span></span> <span class="hljs-title"><span class="hljs-title">SymfonyCommand</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Exception</span></span>\<span class="hljs-title"><span class="hljs-title">InvalidOptionException</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Input</span></span>\<span class="hljs-title"><span class="hljs-title">InputInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Input</span></span>\<span class="hljs-title"><span class="hljs-title">InputOption</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Console</span></span>\<span class="hljs-title"><span class="hljs-title">Output</span></span>\<span class="hljs-title"><span class="hljs-title">OutputInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SEARCH_BY_FULLNAME = <span class="hljs-string"><span class="hljs-string">'search-by-fullname'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Configures command to be executable by the controller. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> SymfonyCommand $command */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SymfonyCommand $command)</span></span></span><span class="hljs-function"> </span></span>{ $command-&gt;addOption( <span class="hljs-string"><span class="hljs-string">'--'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SEARCH_BY_FULLNAME, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, InputOption::VALUE_OPTIONAL, <span class="hljs-string"><span class="hljs-string">"Specify the search query based on fullname of the user. Must be started from surname"</span></span> ); } <span class="hljs-comment"><span class="hljs-comment">/** * Executes controller. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> InputInterface $input * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> OutputInterface $output * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> null|integer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputInterface $input, OutputInterface $output)</span></span></span><span class="hljs-function"> </span></span>{ $reflect = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ReflectionClass(<span class="hljs-keyword"><span class="hljs-keyword">__CLASS__</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($reflect-&gt;getConstants() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $constName =&gt; $option) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($input-&gt;hasOption($option) &amp;&amp; ($optValue = $input-&gt;getOption($option))) { $queryArgs = explode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $optValue); Registry::set(<span class="hljs-string"><span class="hljs-string">'query'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FullnameCriteria( $queryArgs[<span class="hljs-number"><span class="hljs-number">0</span></span>], $queryArgs[<span class="hljs-number"><span class="hljs-number">1</span></span>] ?? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $queryArgs[<span class="hljs-number"><span class="hljs-number">2</span></span>] ?? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \InvalidOptionException(<span class="hljs-string"><span class="hljs-string">"You must specify one of the following options to proceed: "</span></span> . implode(<span class="hljs-string"><span class="hljs-string">', '</span></span>, $reflect-&gt;getConstants())); } }</code> </pre> <br></div></div><br>  If everything is declared correctly, then the list of available commands behat will be supplemented by a new argument - <i>search-by-fullname</i> : <br><br><pre> <code class="hljs pgsql">$ vendor/bin/behat <span class="hljs-comment"><span class="hljs-comment">--help</span></span></code> </pre> <br><pre> <code class="hljs coffeescript">[mkardakov@mkardakov-local dossier.io]$ vendor/bin/behat --help | grep search-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-fullname --search-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-fullname[=SEARCH-BY-FULLNAME] Specify the search query based <span class="hljs-literal"><span class="hljs-literal">on</span></span> fullname <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the user. Must be started <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> surname [mkardakov@mkardakov-local dossier.io]$</code> </pre> <br>  Having received the input data inside SearchController, they can be transferred to the Context classes directly, or stored in a database, etc. In the example above, I use the Registry pattern for this.  The approach is quite working, but if you know how to do it differently, please tell us in the comments. <br><br>  That's all.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/353612/">https://habr.com/ru/post/353612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353602/index.html">The perfect way to offline from online</a></li>
<li><a href="../353604/index.html">Synergistic organizations and Pokupo. How do we work and where does Ethereum?</a></li>
<li><a href="../353606/index.html">DotVVM - First Look</a></li>
<li><a href="../353608/index.html">Sberbank's Dao Integration: From Local Area Networks to Kafka and Streaming Development</a></li>
<li><a href="../353610/index.html">The dispute about the ‚Äúright to oblivion‚Äù: whether to consider the work of search engines as journalism?</a></li>
<li><a href="../353614/index.html">Internet Marketing and Web Analytics Strategy Avinash Koshyk</a></li>
<li><a href="../353616/index.html">We manage a big long project: why is it important to speak with words</a></li>
<li><a href="../353618/index.html">Reservoir Dogs: Angular 2 vs React</a></li>
<li><a href="../353622/index.html">We optimize (debounce) the triggering of events in React</a></li>
<li><a href="../353624/index.html">Javascript java what's the difference now</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>