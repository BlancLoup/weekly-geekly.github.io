<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous C # program update</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends! 

 In my previous articles ( once and twice ) I wrote about the implementation of the automatic program update function and having ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous C # program update</h1><div class="post__text post__text-html js-mediator-article">  Good day, friends! <br><br>  In my previous articles ( <a href="http://habrahabr.ru/post/217325/">once</a> and <a href="http://habrahabr.ru/post/217633/">twice</a> ) I wrote about the implementation of the automatic program update function and having many shortcomings, it was decided to improve it, and also to make the code more ‚Äúfriendly‚Äù or something.  By shortening the lines and optimizing the format, I was able to achieve better asynchronous file downloads, virtually eliminating the likelihood of replacing the update file (checksum verification), and several new developments were added.  There, I am making the next attempt to rehabilitate myself. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cef/a5d/e76/cefa5de76842fa58a87d2a70f30c5ed6.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In my work, my program uses the following files in the same folder as the executable file: <br><ul><li>  <b>Ionic.Zip.dll</b> - implementation of archiving debug files; </li><li>  <b>LanguagePack.dll</b> - own library containing translation of the name of form elements into the desired language; </li><li>  <b>Newtonsoft.Json.dll</b> - JSON-library; </li><li>  <b>ProcessesLibrary.dll</b> - its own library containing a list of processes; </li><li>  <b>restart.exe</b> - utility restarting the main application; </li><li>  <b>updater.exe</b> - main application update utility </li><li>  <b>settings.xml</b> - <b>settings</b> file. </li></ul><br>  In previous versions of the code, each file was downloaded separately, which caused a lot of inconvenience, starting from the waiting time for downloading.  There was also no checksum check function, which did not have a good effect on the safety of their use. <br>  What has changed in the code that I decided to write a third article about the same story? <br><a name="habracut"></a><br>  First, the <b>version.xml</b> file located on the server has changed: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">myprogram</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"05b2b2eb79c4f11834b25095acc047f9"</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.7.88<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">myprogram</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">updater</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aaef7c8a1f9437138acfc80fb2c4354b"</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0.7<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">updater</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">restart</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"d3904a3fe5ff2ab3a0f246bdde293345"</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.1.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">restart</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">processesLibrary</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2b999c9eb771374c87490f5dee5da9ec"</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.1.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">processesLibrary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">languagePack</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"d5724f066cea211eb5f0efb6365ba0c9"</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">languagePack</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Newtonsoft.Json</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5619e5d4b93e544c7b9174c062f6c40b"</span></span></span><span class="hljs-tag">&gt;</span></span>6.0.1.17001<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Newtonsoft.Json</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Ionic.Zip</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">checksumm</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"6ded8fcbf5f1d9e422b327ca51625e24"</span></span></span><span class="hljs-tag">&gt;</span></span>1.9.1.8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Ionic.Zip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><h4>  Changes </h4><br>  As you have noticed, compared to its <a href="http://habrahabr.ru/post/217325/">previous</a> version, the <b>checksumm</b> attribute was added, containing just the <b>MD5</b> sum of a specific file. <br><br>  When using the code, as unnecessary, the components of the backgroundWorker class were removed in favor of the <b>Task</b> , and the following lines were added to the class definition: <br><br><pre> <code class="cs hljs">debug debug = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> debug(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> url = <span class="hljs-string"><span class="hljs-string">@"http://mysite/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ProgressBar downloadPercent = <span class="hljs-literal"><span class="hljs-literal">null</span></span>;</code> </pre><br>  The <b>debug</b> class writes errors to a file for better logging.  But in this article we will not talk about it. <br>  The string parameter <b>url</b> sets the path to the folder on the site containing all of our files.  Before this path for each file was registered - but in vain. <br>  The <b>downloadPercent</b> component from the <b>ProgressBar</b> class is used to display the percent download of the update of the main program file. <br><br>  Further, the function of starting the update process <b>Check ()</b> was reduced to the form: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> launcher = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ProgressBar report = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { XmlDocument doc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDocument(); doc.Load(url + <span class="hljs-string"><span class="hljs-string">"version.xml"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!File.Exists(<span class="hljs-string"><span class="hljs-string">"settings.xml"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient()) Task.Factory.StartNew(() =&gt; client.DownloadFile(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(url + <span class="hljs-string"><span class="hljs-string">"settings.xml"</span></span>), <span class="hljs-string"><span class="hljs-string">"settings.xml"</span></span>)).Wait(); } <span class="hljs-comment"><span class="hljs-comment">//     ,    if (File.Exists("settings.xml") &amp;&amp; new FileInfo("settings.xml").Length == 0) { File.Delete("settings.xml"); } if (File.Exists("Ionic.Zip.dll") &amp;&amp; new FileInfo("Ionic.Zip.dll").Length == 0) { File.Delete("Ionic.Zip.dll"); } if (File.Exists("restart.exe") &amp;&amp; new FileInfo("restart.exe").Length == 0) { File.Delete("restart.exe"); } if (File.Exists("updater.exe") &amp;&amp; new FileInfo("updater.exe").Length == 0) { File.Delete("updater.exe"); } if (File.Exists("Newtonsoft.Json.dll") &amp;&amp; new FileInfo("Newtonsoft.Json.dll").Length == 0) { File.Delete("Newtonsoft.Json.dll"); } if (File.Exists("ProcessesLibrary.dll") &amp;&amp; new FileInfo("ProcessesLibrary.dll").Length == 0) { File.Delete("ProcessesLibrary.dll"); } if (File.Exists("LanguagePack.dll") &amp;&amp; new FileInfo("LanguagePack.dll").Length == 0) { File.Delete("LanguagePack.dll"); } if (File.Exists("launcher.update") &amp;&amp; new FileInfo("launcher.update").Length == 0) { File.Delete("launcher.update"); } if (!launcher) { var task1 = Task.Factory.StartNew(() =&gt; DownloadFile("Ionic.Zip.dll", doc.GetElementsByTagName("Ionic.Zip")[0].InnerText, doc.GetElementsByTagName("Ionic.Zip")[0].Attributes["checksumm"].InnerText)); var task2 = Task.Factory.StartNew(() =&gt; DownloadFile("restart.exe", doc.GetElementsByTagName("restart")[0].InnerText, doc.GetElementsByTagName("restart")[0].Attributes["checksumm"].InnerText)); var task6 = Task.Factory.StartNew(() =&gt; DownloadFile("LanguagePack.dll", doc.GetElementsByTagName("languagePack")[0].InnerText, doc.GetElementsByTagName("languagePack")[0].Attributes["checksumm"].InnerText)); Task.WaitAll(task1, task2, task6); }</span></span></code> </pre><br>  Now about all the details. <br>  At the very beginning, we check if the program settings file ( <b>settings.xml</b> ) exists and if it is missing - download it <br>  Further (sometimes it happened), if the files are of zero length, then we also delete them.  Why do we need non-working files.  Right, right? <br>  After that, there is a check whether the <b>launcher</b> parameter was set during the function initialization.  It is needed to determine the sequence of code execution, as well as to optimize the solution, since only 3 files from the above list are required when initializing the form of the main window.  If the <b>launcher</b> parameter is <b>false</b> , then we download the main files (Ionic.Zip.dll, LanguagePack.dll, restart.exe), and then initialize the code of the main program. <br><br>  To check for updates of the main program and auxiliary files, in the code of the main form in the handler <b>public Form1 ()</b> after calling the function <b>InitializeComponent ();</b>  add a call to our update class.  Yes class, since all its code is placed separately (for convenience). <br><br><pre> <code class="cs hljs">update_launcher update = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> update_launcher(); update.Check(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, pbDownload);</code> </pre><br>  In the call <b>update.Check (true, progressBar1);</b>  we, as the first parameter, we indicate that checks for updates of auxiliary files and updates for the main file of the application will now be made.  As the second, we indicate the progressBar, which is responsible for displaying the percent load of the main file. <br><br>  Since we specified the <b>launcher = true</b> parameter, the program will execute the following code from the <b>Check ()</b> function (continuation of the code specified above): <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task3 = Task.Factory.StartNew(() =&gt; DownloadFile(<span class="hljs-string"><span class="hljs-string">"updater.exe"</span></span>, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"updater"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"updater"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes[<span class="hljs-string"><span class="hljs-string">"checksumm"</span></span>].InnerText)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task4 = Task.Factory.StartNew(() =&gt; DownloadFile(<span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json.dll"</span></span>, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes[<span class="hljs-string"><span class="hljs-string">"checksumm"</span></span>].InnerText)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task5 = Task.Factory.StartNew(() =&gt; DownloadFile(<span class="hljs-string"><span class="hljs-string">"ProcessesLibrary.dll"</span></span>, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"processesLibrary"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"processesLibrary"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes[<span class="hljs-string"><span class="hljs-string">"checksumm"</span></span>].InnerText)); Task.WaitAll(task3, task4, task5); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(FileVersionInfo.GetVersionInfo(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>).FileVersion) &gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion)) { Process.Start(<span class="hljs-string"><span class="hljs-string">"updater.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"launcher.update \""</span></span> + Application.ProductName + <span class="hljs-string"><span class="hljs-string">".exe\""</span></span>); Process.GetCurrentProcess().CloseMainWindow(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion) &lt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (report != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { downloadPercent = report; downloadPercent.Value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Task.Factory.StartNew(() =&gt; DownloadFile(<span class="hljs-string"><span class="hljs-string">"launcher.exe"</span></span>, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText, doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes[<span class="hljs-string"><span class="hljs-string">"checksumm"</span></span>].InnerText, <span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>)).Wait(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>)) { File.Delete(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex1) { debug.Save(<span class="hljs-string"><span class="hljs-string">"public void Check(bool launcher = false)"</span></span>, <span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>, ex1.Message); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { debug.Save(<span class="hljs-string"><span class="hljs-string">"public void Check(bool launcher = false)"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, ex.Message); } }</code> </pre><br>  What we have here.  Do not forget to add <b>using System.Threading.Tasks;</b>  , we initialize the <a href="http://msdn.microsoft.com/ru-ru/library/system.threading.tasks.task.aspx"><b>Task</b></a> object, assigning variables to them ( <b>task3</b> , <b>task4</b> , <b>task5</b> ). <br>  For those who are not in the subject, the Task class is a wrapper over threads for performing asynchronous operations, giving the developer the opportunity to forget about how to create a stream, start it and destroy it when finished. <br>  In general, in our case, we set the function <b>DownloadFile ()</b> as a parameter <b>;</b>  By passing it the necessary parameters, namely: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DownloadFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xmlVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xmlChecksumm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> localFile = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> showStatus = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  Where: <br><br><ul><li>  <b>filename</b> - the name of the file located on the server; </li><li>  <b>xmlVersion</b> - version of the file on the server (read from <b>version.xml</b> ); </li><li>  <b>xmlChecksumm</b> - a string containing the checksum of the file (read from <b>version.xml</b> ); </li><li>  <b>localFile</b> - an optional parameter, needed if the file stored locally differs by name from that located on the site (in our case it is used only when downloading updates of the main application file); </li><li>  <b>showStatus</b> is an optional parameter used to determine whether the file download status is displayed in the progressBar.  Used only with the <b>localFile</b> parameter. </li></ul><br>  <b>Task.Factory.StartNew ()</b> function <b>;</b>  Allows you to asynchronously run any processes for execution.  In order to determine when all the files were downloaded, the <b>Task.WaitAll</b> function was used <b>(task3, task4, task5);</b>  , waiting for completion of code execution in all specified elements. <br>  So, after downloading additional files, you can go to check for updates of the main one, and since updates can already be downloaded, we first check the existence and version of the local update file, if it exists. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(FileVersionInfo.GetVersionInfo(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>).FileVersion) &gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion))</code> </pre><br>  Why there is no function to check the checksum, I will tell a little later, but for now let us return to this one. <br>  If the update file (‚Äúlauncher.update‚Äù) exists and its version is more recent, then run the additional utility <b>updater.exe</b> , passing the file names to the parameter (see the code above). <br><br>  Further, if the update file is missing or its version is not fresh, then we use the following compliance check, where we check the software version with the version on the site: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion) &lt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText))</code> </pre><br>  If a more recent version is found, then go on to downloading it.  And more about that later. <br>  The third condition is valid when the first two are not met, namely, if the file is present and has an older version, then we simply delete it. <br><br>  Call the function <b>debug.Save ();</b>  saves information about the error handler to a file so that it can be read later.  For software updates, this code does not matter much, and it is placed so that people do not ask "why you have <b>catch (Exception) {}</b> , this is not comme il faut."  This is how it is. <br>  Go ahead. <br><br><h4>  Download </h4><br>  For downloading files the private function <b>DownloadFile ();</b>  , which has a set of parameters described above, and its <s>cat</s> code you can see below: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DownloadFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xmlVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xmlChecksumm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> localFile = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> showStatus = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { localFile = localFile != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? localFile : filename; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(localFile) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(localFile).Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { File.Delete(localFile); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((File.Exists(localFile) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(FileVersionInfo.GetVersionInfo(localFile).FileVersion) &lt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(xmlVersion)) || !File.Exists(localFile)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (showStatus &amp;&amp; downloadPercent != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { client.DownloadProgressChanged += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadProgressChangedEventHandler(ProgressChanged); } client.DownloadFileAsync(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(url + filename), localFile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Checksumm(localFile, xmlChecksumm) &amp;&amp; File.Exists(localFile)) { File.Delete(localFile); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { debug.Save(<span class="hljs-string"><span class="hljs-string">"private void DownloadFile(string filename, string xmlVersion, string xmlChecksumm)"</span></span>, <span class="hljs-string"><span class="hljs-string">"Filename: "</span></span> + filename + Environment.NewLine + <span class="hljs-string"><span class="hljs-string">"Localname: "</span></span> + (localFile != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? localFile : <span class="hljs-string"><span class="hljs-string">"null"</span></span>) + Environment.NewLine + <span class="hljs-string"><span class="hljs-string">"URL: "</span></span> + url, ex.Message); } } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex1) { debug.Save(<span class="hljs-string"><span class="hljs-string">"private void DownloadFile(string filename, string xmlVersion, string xmlChecksumm)"</span></span>, <span class="hljs-string"><span class="hljs-string">"Filename: "</span></span> + filename + Environment.NewLine + <span class="hljs-string"><span class="hljs-string">"Localname: "</span></span> + (localFile != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? localFile : <span class="hljs-string"><span class="hljs-string">"null"</span></span>) + Environment.NewLine + <span class="hljs-string"><span class="hljs-string">"URL: "</span></span> + url, ex1.Message); } }</code> </pre><br>  At the very beginning, the transferred value is checked in the <b>localFile</b> parameter <b>,</b> and if the parameter equals <b>null</b> , then we assign the value of the <b>filename</b> parameter to it.  After that, the file is checked for <s>length</s> and if it is zero, we delete it. <br>  Then the key part of the function begins - we check the existence of the file and the relevance of its version, and if the file is missing or a new version is found, then go on to download, otherwise, skip. <br>  Just before downloading, we check the <b>showStatus</b> parameter, which we need to enable / disable the display of the download status.  I will consider an example when status is needed.  So, if the <b>showStatus</b> parameter <b>is</b> not <b>null</b> and the <b>downloadPercent</b> parameter is set, then the <b>client</b> object of the <b>WebClient ()</b> class is connected to the <b>ProgressChanged ()</b> function <b>;</b>  to track download status. <br>  Next is the process of asynchronous downloading of the <b>DownloadFileAsync ()</b> file.  File downloaded, what next? <br>  And then we check the checksum of the downloaded file with the value on the site in the <b>version.xml</b> file through the function <b>Checksumm ()</b> in the parameters of which the name of the local file and the string containing the md5-cache from the site are transferred. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Checksumm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> summ</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(filename) &amp;&amp; summ != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(filename).Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (FileStream fs = File.OpenRead(filename)) { System.Security.Cryptography.MD5 md5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Security.Cryptography.MD5CryptoServiceProvider(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] fileData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[fs.Length]; fs.Read(fileData, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)fs.Length); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] checkSumm = md5.ComputeHash(fileData); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BitConverter.ToString(checkSumm) == summ.ToUpper() ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { debug.Save(<span class="hljs-string"><span class="hljs-string">"private bool Checksumm(string filename, string summ)"</span></span>, <span class="hljs-string"><span class="hljs-string">"Filename: "</span></span> + filename, ex.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre><br>  If the checksum of the local file matches the value on the site, the function returns <b>true</b> , otherwise, by the action of logic. <br>  And what is there in <b>DownloadFile ()</b> ?  If the checksum is correct, then terminate the function; if not, delete the file. <br><br>  What else has not indicated?  Um ... oh yeah!  Load status processing function: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">Private </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProgressChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, DownloadProgressChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { downloadPercent.Value = e.ProgressPercentage; }</code> </pre><br>  And, I almost forgot, in the specified code, the update of the main program is downloaded to the file <b>launcher.update</b> .  The application of the update will be carried out automatically upon the subsequent launch of the program, that is, no notification will be issued to the user, which, in my opinion, increases the ‚Äúfriendliness‚Äù of the program. <br><br><h4>  Conclusion </h4><br>  That is, in fact, the entire update code, and given that it is located in a separate class, it can easily be used in any kind of project, specifying your sources of updates and the number and names of files. <br>  PS: in the <b>debug</b> class, when saving, 3 parameters are set - it is easier for them to look for the right place by code. <br><br>  If anyone needs it, since November 2017 the repository is posted <a href="https://github.com/andrey-helldar/Csharp-updaters">HERE</a> . <br><br>  <i>Sincerely, Andrei Helldar!</i> </div><p>Source: <a href="https://habr.com/ru/post/217627/">https://habr.com/ru/post/217627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217609/index.html">German scientists measured the electron mass 13 times more accurately than before.</a></li>
<li><a href="../217611/index.html">Remote in Russian. New book from 37signals</a></li>
<li><a href="../217615/index.html">Lectorium launches MOOC direction</a></li>
<li><a href="../217617/index.html">Testing ‚Äúfast MongoDB‚Äù - TokuMX in conditions close to reality</a></li>
<li><a href="../217625/index.html">First look at the prototype Yotaphone 2</a></li>
<li><a href="../217629/index.html">VPS as an anonymous proxy and not only ...</a></li>
<li><a href="../217631/index.html">Python-digest # 20. News, interesting projects, articles and interviews [March 23, 2014 - March 30, 2014]</a></li>
<li><a href="../217633/index.html">Automatic update programs in C #. Part 2</a></li>
<li><a href="../217637/index.html">Certification of goods in the Russian Federation or 9 circles of hell</a></li>
<li><a href="../217639/index.html">Working with SQL Server in Hybrid Cloud Scripts. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>