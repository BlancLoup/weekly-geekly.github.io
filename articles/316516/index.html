<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Low-level optimization and measurement of code performance on R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past decade, R has come a long way: from the niche (as a rule, academic) tool to the mainstream ‚Äúbig ten‚Äù most popular programming languages....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Low-level optimization and measurement of code performance on R</h1><div class="post__text post__text-html js-mediator-article"><p>  Over the past decade, R has come a long way: from the niche (as a rule, academic) tool to the mainstream <a href="http://spectrum.ieee.org/computing/software/the-2016-top-programming-languages">‚Äúbig ten‚Äù</a> most popular programming languages.  Such interest is caused by many reasons, among which are membership in open source, an active community, and an actively growing segment of the application of machine learning / data mining methods in a variety of business tasks.  It's nice to see when one of your favorite languages ‚Äã‚Äãconfidently gains new positions, and when even users who are far from professional development become interested in R. But there is, however, one big problem: <a name="habracut"></a>  R language is written, in the words of the creators, "statisticians for statisticians."  Therefore, it is high-level, flexible, with a huge and reliable functionality out of the box, not to mention thousands of additional packages;  and at the same time, it is a very frivolous in terms of semantics, combining fundamentally different paradigms and possessing wide possibilities for writing monstrously inefficient code.  And if we take into account the fact that lately this is the first "real" programming language for many, the situation becomes even more threatening. </p><br><p>  However, improving the quality and speed of code execution on R is a universal task that not only beginners, but also experienced users constantly face.  That is why it is very important to return from time to time to the simplest structures and basic principles of R work, in order to remember the sources of inefficiencies and ways to eliminate them.  In this article I will talk about one case that I first met during the work on the study of financial strategies, and then was adapted by me as a training course for an online course. </p><br><h3>  How not to get caught in the matrix </h3><br><p>  Omitting all irrelevant details, we can formulate our test problem as follows.  For arbitrary natural <img src="https://tex.s2cms.ru/svg/n" alt="n">  you need to quickly generate matrices of size <img src="https://tex.s2cms.ru/svg/n%20%5Ctimes%20n" alt="n \ times n">  of this kind (an example is given for <nobr><img src="https://tex.s2cms.ru/svg/n%3D5" alt="n = 5"></nobr>  <nobr>):</nobr> </p><br><pre><code class="hljs">1 2 3 4 5 2 3 4 5 4 3 4 5 4 3 4 5 4 3 2 5 4 3 2 1</code> </pre> <br><p>  This is a special case of the so-called <a href="https://en.wikipedia.org/wiki/Hankel_matrix">Hankel matrices</a> .  Here, the upper left and lower right corners always contain one, the entire secondary diagonal (from the lower left to the upper right corner) consists of the number <nobr><img src="https://tex.s2cms.ru/svg/n" alt="n"></nobr>  <nobr>,</nobr> and all other values ‚Äã‚Äãare located by steps.  As a result, we have something similar to a mountain range or roof slope. </p><br><p>  It is natural to expect that the parameter <img src="https://tex.s2cms.ru/svg/n" alt="n">  can vary in some reasonable range, say, from units to hundreds.  Therefore, we will solve the problem as a separate function, and <img src="https://tex.s2cms.ru/svg/n" alt="n">  will be an argument in it. </p><br><p>  The simplest calculation shows that the matrix we need is determined elementwise using the condition <nobr><img src="https://tex.s2cms.ru/svg/M_%7Bi%2C%20j%7D%20%3D%20%5Cmin(i%20%2B%20j%20-%201%2C%202n%20-%20i%20-%20j%20%2B%201)" alt="M_ {i, j} = \ min (i + j - 1, 2n - i - j + 1)"></nobr>  <nobr>.</nobr>  If we wrote in one of the classical imperative languages ‚Äã‚Äã(such as C or <nobr>C ++</nobr> ), then the solution would be complete, since it reduces to an elementary double loop.  On R, this ‚Äúnaive solution‚Äù looks like this: </p><br><pre> <code class="hljs matlab">build_naive &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matrix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, n, n)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i in 1:n)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(j in 1:n)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i, j]</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i + j - 1, 2*n - i - j + 1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> }</span></span></code> </pre><br><p>  Even in spite of the fact that we initialize the matrix of the required size in advance (the absence of the first row ‚Äî preallocation of memory ‚Äî a frequent <a href="https://datalearner.wordpress.com/2013/08/06/efficient-r-preallocating-memory-for-matrices/">error of</a> beginners), this solution works very slowly.  For experts on the language, such a result is quite predictable: since R is an interpreted language, each iteration of the cycle entails a lot of <a href="http://stackoverflow.com/questions/7142767/why-are-loops-slow-in-r">overhead</a> for execution.  Examples with non-optimal use of cycles are found, perhaps, in every textbook on R. And the conclusion is always the same: if possible, use the so-called vectorized functions.  They are usually implemented at a low level (C) and extremely optimized. </p><br><p>  So, in our case, when the matrix element is a function of two indices <img src="https://tex.s2cms.ru/svg/i" alt="i">  and <nobr><img src="https://tex.s2cms.ru/svg/j" alt="j"></nobr>  <nobr>, a</nobr> combination of the <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/outer.html"><code>outer</code></a> and <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Extremes.html"><code>pmin</code></a> functions <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Extremes.html"><code>pmin</code></a> : </p><br><pre> <code class="hljs lua">build_outer_pmin &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { outer(<span class="hljs-number"><span class="hljs-number">1</span></span>:n, <span class="hljs-number"><span class="hljs-number">1</span></span>:n, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, j)</span></span></span></span> pmin(i + j - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>*n - i - j + <span class="hljs-number"><span class="hljs-number">1</span></span>)) }</code> </pre><br><p>  The <code>pmin</code> function differs from <code>min</code> in that it operates with vectors on both the input and the output.  Compare: <code>min(3:0, 1:4)</code> searches for a common minimum (zero in this case), and <code>pmin(3:0, 1:4)</code> returns a vector from pairwise minima: <code>(1, 2, 1, 0)</code> .  The concept of vectorized function is not easy to formulate formally, but the general idea, I hope, is understandable.  This is the function that the <code>outer</code> function expects as an argument.  That is why it is impossible to pass <code>min</code> into it, as in a naive solution, try this and make sure that an error occurs.  By the way, if we still want to use a combination of <code>outer</code> and <code>min</code> , we can perform a forced vectorization of the <code>min</code> function, wrapping it in the <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/Vectorize.html"><code>Vectorize</code></a> function: </p><br><pre> <code class="hljs lua">build_outer_min &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { outer(<span class="hljs-number"><span class="hljs-number">1</span></span>:n, <span class="hljs-number"><span class="hljs-number">1</span></span>:n, Vectorize(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, j)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(i + j - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>*n - i - j + <span class="hljs-number"><span class="hljs-number">1</span></span>))) }</code> </pre><br><p>  It should be remembered at the same time that compulsory vectorization of this kind will always work more slowly than the natural one.  However, in some situations it is <code>Vectorize</code> to do without <code>Vectorize</code> - for example, if the definition of a matrix element contains a conditional <code>if</code> . </p><br><p>  Another way to get rid of the inefficiency of a naive solution is to somehow remove the nesting of cycles ‚Äî it is to iterate not by the unit elements of the matrix, but by the vectors or submatrices.  There can be many options, I will show only one of them, recursive.  We will build the matrix "by the floor", from the center to the edges: </p><br><pre> <code class="hljs matlab">build_recursive &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n == 0)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matrix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, n, n)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[-1, -n]</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n - 1)</span></span></span><span class="hljs-function"> + 1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1, ]</span></span></span><span class="hljs-function"> &lt;- 1:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[, n]</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function">:1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> }</span></span></code> </pre><br><p>  In this case, efficiency is achieved due to the fact that the number of high-level iterations is not <nobr><img src="https://tex.s2cms.ru/svg/n%5E2" alt="n ^ 2"></nobr>  <nobr>,</nobr> as in a naive decision, but only <img src="https://tex.s2cms.ru/svg/n" alt="n">  (the role of the loop is taken by the call stack). </p><br><p>  Finally, in the case when optimization at the level of basic functions R does not lead to the desired result, there is always another option: implement the slow part at the lowest possible level.  That is, to write a piece of code in pure C or C ++, compile it and call it from R. Such an approach is popular among package developers because of its extreme efficiency and simplicity, and also because there is a <a href="http://www.rcpp.org/">great</a> <code>Rcpp</code> <a href="http://www.rcpp.org/">package</a> for working with <nobr>C ++</nobr> . </p><br><pre> <code class="hljs lisp">library(<span class="hljs-name"><span class="hljs-name">Rcpp</span></span>) cppFunction(<span class="hljs-string"><span class="hljs-string">"NumericMatrix build_cpp(const int n) { NumericMatrix x(n, n); for (int i=0; i&lt;n; i++) for (int j=0; j&lt;n; j++) x(i, j) = std::min(i + j + 1, 2*n - i - j - 1); return x;}"</span></span>)</code> </pre><br><p>  When we call <code>cppFunction</code> in a similar way, the code will be compiled in <nobr>C ++</nobr> , and upon its completion we will get the <code>build_cpp</code> function in the global environment, which can be called like any other function we have defined.  Of the obvious drawbacks of such an approach, the need to compile can be noted (this also takes time), not to mention the fact that it is necessary to be fluent in <nobr>C ++</nobr> .  Of course, using <code>Rcpp</code> not a ‚Äúsilver bullet‚Äù, and writing slow C / <nobr>C ++ code is</nobr> also quite simple. </p><br><h3>  <code>microbenchmark</code> package </h3><br><p>  When we talked about the speed of decisions, we relied on a priori knowledge of how language works.  Theory is theory, but any reasoning about performance should be accompanied by experiments - measuring the time of execution with specific examples.  Moreover, in such cases it is always better to check and recheck everything yourself, because any such measurements are not absolute truth: they depend on the hardware and the state of the processor, on the operating system and its load at the time of measurement. </p><br><p>  There are several typical ways to measure the speed of code execution on R. One of the most common is the <code>system.time</code> function.  When using this function, they usually do something like <code>system.time(replicate(expr, 100))</code> .  This is a good option, but there are several packages that do the same, but in a much more convenient and customizable version.  In fact, the standard is a package called <code>microbenchmark</code> , which we will use.  All work will be performed by a function of the same name, to which you can pass an arbitrary number of expressions (see <a href="https://cran.r-project.org/doc/manuals/r-patched/R-lang.html">unevaluated expression</a> ) for measurement.  By default, each expression will be executed a hundred times, and we will see the collected statistics on the execution time. </p><br><pre> <code class="hljs matlab">library(microbenchmark) measure &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">microbenchmark</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build_naive(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_pmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_recursive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_cpp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">) } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">measure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(100)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Unit</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">microseconds</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">min</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lq</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">median</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uq</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">max</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">neval</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_naive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 20603.310 21825.7975 24380.0332 22884.3255 24215.368 66753.031 100 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 22624.873 25430.4985 28164.4496 26662.8955 29028.744 84972.926 100 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_pmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 159.755 187.8325 295.3822 204.1985 225.069 3710.103 100 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_recursive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 1741.992 2822.2910 5990.9897 3241.1980 3918.055 55059.974 100 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_cpp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 21.321 23.4230 33.6600 34.2335 38.588 91.289 100</span></span></code> </pre><br><p>  In the obtained output, the measurement results are presented in the form of a table with a set of descriptive statistics.  In addition, the resulting object can be drawn: <code>plot(m)</code> or <code>ggplot2::autoplot(m)</code> . </p><br><h3>  Package <code>benchr</code> </h3><br><p>  Currently, another package is being developed, designed to measure the execution time of expressions - the <code>benchr</code> package.  The functionality and syntax is almost identical to the <code>microbenchmark</code> package, but with some key differences.  Briefly, these differences can be described as follows: </p><br><ol><li>  We use a single cross-platform measurement mechanism based on a timer from <nobr>C ++ 11;</nobr> </li><li>  The user is provided with more options to configure the measurement process; </li><li>  The output of text and graphic results becomes more detailed and visual. </li></ol><br><p>  The <code>benhcr</code> package is in <a href="https://cran.r-project.org/web/packages/benchr/index.html">CRAN</a> (for version R older than 3.3.2), and the development version <a href="https://gitlab.com/artemklevtsov/benchr">is available on gitlab</a> , there are also installation instructions.  Using <code>benchr</code> in our example will look like this (all you need is to replace the <code>microbenchmark</code> function with the <code>benchmark</code> function): </p><br><pre> <code class="hljs matlab">install.packages(<span class="hljs-string"><span class="hljs-string">"benchr"</span></span>) library(benchr) measure2 &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">benchmark</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(build_naive(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_outer_pmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_recursive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_cpp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">) } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m2</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">measure2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(100)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m2</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Benchmark</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">summary</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Time</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">units</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">microseconds</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eval</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">min</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lw</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qu</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">median</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qu</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">max</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">total</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">relative</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 100 21800 24300 25600.0 27400.0 28100.0 79300.0 2740000 906.00 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 100 24400 28800 30100.0 31600.0 33700.0 44000.0 3160000 1070.00 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 100 157 189 198.0 738.0 217.0 43400.0 73800 7.02 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 100 1820 1980 3380.0 4910.0 4050.0 50000.0 491000 120.00 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build5</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function"> 100 21 27 28.2 29.4 30.5 50.1 2940 1.00</span></span></code> </pre><br><p>  In addition to convenient textual output (the relative column allows you to quickly evaluate the advantage of the fastest solution), we can use various visualizations.  By the way, if you have the <code>ggplot2</code> package <code>ggplot2</code> , it will be used for drawing graphs.  If for some reason you do not want to use <code>ggplot2</code> , this behavior can be changed using the <code>benchr</code> package <code>benchr</code> .  Three typical visualization of the measurement results are now supported: dotplot, boxplot and violin plot. </p><br><pre> <code class="hljs lisp">plot(<span class="hljs-name"><span class="hljs-name">m2</span></span>) boxplot(<span class="hljs-name"><span class="hljs-name">m2</span></span>) boxplot(<span class="hljs-name"><span class="hljs-name">m2</span></span>, violin = TRUE)</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/32b/793/9c0/32b7939c000e77d392d7b1c23a55f521.png" alt="dotplot"><br><img src="https://habrastorage.org/getpro/habr/post_images/26c/9b2/d5e/26c9b2d5ef8b61ed2847be5d3b76d4e2.png" alt="boxplot"><br><img src="https://habrastorage.org/getpro/habr/post_images/cfb/3b7/742/cfb3b7742f8d8e84f2973a7d2d96bac8.png" alt="violin plot"><br><h3>  Results </h3><br><p>  So, according to the results of measurements, we can formulate the following conclusions. </p><br><ol><li>  The reference (naive) solution works slowly, since a double <code>for</code> loop produces <img src="https://tex.s2cms.ru/svg/n%5E2" alt="n ^ 2">  high-level iterations, which does not correspond to the vectorial orientation of the language R; </li><li>  Direct transfer of the loop to the <code>outer</code> function with forced vectorization via <code>Vectorize</code> does not solve the problem, because the solution is semantically identical to the naive one; </li><li>  The recursive solution is faster by an order of magnitude, because high-level iterations become <nobr><img src="https://tex.s2cms.ru/svg/n" alt="n"></nobr>  <nobr>,</nobr> and operations with submatrices in R are fast enough; </li><li>  Using <code>outer</code> in combination with the natural vectorization of the <code>pmin</code> function is two orders of magnitude faster due to the low-level implementation (compiled C); </li><li>  Direct access to <code>Rcpp</code> is three orders of magnitude faster (without taking into account C ++ compilation time), since the <code>Rcpp</code> package <code>Rcpp</code> additionally optimized with the help of modern features of the <nobr>C ++ language.</nobr> </li></ol><br><p>  And now the most important thing that I would like to bring this article.  If you know how the language of R and what philosophy he professes;  if you remember about the natural vectorization and a powerful set of functions of the base R;  Finally, if you arm yourself with modern means of measuring the execution time, then even the most difficult task can turn out to be quite lifting, and you will not have to spend long minutes and even hours waiting for the completion of your code. </p><br><p>  Small disclaimer: the <code>benchr</code> package <code>benchr</code> conceived and implemented by Artem Klevtsov ( <a href="https://github.com/artemklevtsov">@artemklevtsov</a> ) with additions and improvements from me (Anton Antonov, <a href="https://github.com/tonytonov">@tonytonov</a> ) and Phillip <a href="https://www.researchgate.net/profile/Philipp_Upravitelev">Upravitelev</a> ( <a href="https://www.researchgate.net/profile/Philipp_Upravitelev">@konhis</a> ).  We will welcome bug reports and feature suggestions. </p><br><p>  Tasks like this form the basis of the course <a href="https://stepik.org/course/%25D0%259E%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B2%25D1%258B-%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F-%25D0%25BD%25D0%25B0-R-497/">‚ÄúBasics of Programming on R‚Äù</a> on the Stepik.org platform.  The course is open without deadlines (it can be held at a free pace) and is included in the <a href="http://data.stepik.org/">data analysis</a> professional retraining <a href="http://data.stepik.org/">program</a> (SPbAU RAS, <a href="http://bioinformaticsinstitute.ru/">Institute of Bioinformatics</a> ). </p><br><p>  If you are in St. Petersburg, we will be glad to see you at one of the regular meetings of the SPb R user group ( <a href="https://vk.com/spbrug/">VK</a> , <a href="https://www.meetup.com/St-Petersburg-R-User-Group/">meetup</a> ). </p><br><p>  Materials and additional reading on the topic: </p><br><ol><li>  Norman Matloff, The Art of R Programming: A Tour of Statistical Software Design </li><li>  Patrick Burns, The R Inferno </li><li>  Hadley Wickham, Advanced R </li><li>  Dirk Eddelbuettel, Seamless R and <nobr>C ++</nobr> Integration with Rcpp </li><li>  A. B. Shipunov, E. M. Baldin et al. Visual statistics.  Use R! </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/316516/">https://habr.com/ru/post/316516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316498/index.html">Release DBMS InterSystems Cach√© 2016.2</a></li>
<li><a href="../316500/index.html">The loudest cyber attacks on critical infrastructures</a></li>
<li><a href="../316504/index.html">Infrastructure in a box: Schneider Electric container data centers</a></li>
<li><a href="../316506/index.html">Brilliance and misery php. Language evolution from 4.x to 7.1</a></li>
<li><a href="../316512/index.html">How IT professionals work. Daniel Pivovarov, Vscale</a></li>
<li><a href="../316518/index.html">OSPF protocol in Quagga (one zone)</a></li>
<li><a href="../316520/index.html">Own platform. Part 0.1 Theory. Little about processors</a></li>
<li><a href="../316522/index.html">Five aspects of information security that will change with the development of fifth-generation mobile networks</a></li>
<li><a href="../316524/index.html">Attackers exploit the 0day vulnerability in the Tor web browser for cyber attacks</a></li>
<li><a href="../316526/index.html">About broadband microwave switches from Peregrine Semiconductor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>