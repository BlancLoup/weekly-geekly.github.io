<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From Excel to MySQL. Small PHP function (fixed)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Hello $ habrauser ! 

 It happens that you need to import an Excel file into MySQL, but there is no ready-made solution anywhere. So I,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From Excel to MySQL. Small PHP function (fixed)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Hello <b>$ habrauser</b> ! <br><br>  It happens that you need to import an Excel file into MySQL, but there is no ready-made solution anywhere.  So I, when a friend asked me to look for an easy way to import, first decided to <s>google to</s> look for a solution.  Alas, the <i>php excel to mysql</i> query did not give anything concrete, or the methods described were not quite convenient.  Then I decided to find a library for working with Excel in PHP, and I got PHPExcel.  But again, I was disappointed; the <i>phpexcel to mysql</i> query did not give anything worthwhile (I am a lazy user and do not go beyond the 1st page).  In the end, I decided to create my own <s>bike</s> script, which I want to share with you. <br><a name="habracut"></a><br><h4>  Start </h4><br>  So, I found the library, <a href="http://phpexcel.codeplex.com/">downloaded</a> and began to understand.  To begin with, it was necessary to connect the library and create a connection to the database, which is not at all difficult: <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">"PHPExcel.php"</span></span>; $connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> mysqli(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, <span class="hljs-string"><span class="hljs-string">"base"</span></span>); $connection-&gt;set_charset(<span class="hljs-string"><span class="hljs-string">"utf8"</span></span>);</code> </pre> <br>  Next you need to open the Excel file for reading: <br><pre> <code class="php hljs">$PHPExcel_file = PHPExcel_IOFactory::load(<span class="hljs-string"><span class="hljs-string">"./file.xlsx"</span></span>);</code> </pre><br>  After opening the file, we need to go through all the sheets in it and add each to the MySQL database (you can also add 1 specific one, but more on that later): <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($PHPExcel_file-&gt;getWorksheetIterator() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $worksheet) { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  And now the most interesting ... <br><br><h4>  Brute force and add </h4><br>  We will proceed from the fact that we do not have a table (or we have it, but with other data) and need to create it.  To do this, we need to get the names for the columns (as requested by a friend, the names can be in the 1st row of the table): <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      MySQL $columns_str = ""; //     Excel $columns_count = PHPExcel_Cell::columnIndexFromString($worksheet-&gt;getHighestColumn()); //    Excel        for ($column = 0; $column &lt; $columns_count; $column++) { $columns_str .= ($columns_name_on1line ? "column" . $column : $worksheet-&gt;getCellByColumnAndRow($column, 1)-&gt;getCalculatedValue()) . ","; } //  ,     $columns_str = substr($columns_str, 0, -1);</span></span></code> </pre><br>  Next, delete the table from the database, if it existed, and create a new one: <br><pre> <code class="php hljs">$connection-&gt;query(<span class="hljs-string"><span class="hljs-string">"DROP TABLE IF EXISTS exceltable"</span></span>); $connection-&gt;query(<span class="hljs-string"><span class="hljs-string">"CREATE TABLE exceltable ("</span></span> . str_replace(<span class="hljs-string"><span class="hljs-string">","</span></span>, <span class="hljs-string"><span class="hljs-string">" TEXT NOT NULL,"</span></span>, $columns_str) . <span class="hljs-string"><span class="hljs-string">" TEXT NOT NULL)"</span></span>);</code> </pre><br>  As can be seen from the code, the values ‚Äã‚Äãwill be of type <i>TEXT</i> .  Now we are going to actually search the cells and add them to the database.  Of course, such an algorithm is not difficult to find in the vast <a href="http://stackoverflow.com/">Stack Overflow</a> , however, it was noticed that an error occurred when trying to read the merged cells (more precisely, the mismatch of the number of columns and values ‚Äã‚Äãin the query).  This is what I decided to take into account: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     Excel $rows_count = $worksheet-&gt;getHighestRow(); //    Excel for ($row = 1; $row &lt;= $rows_count; $row++) { //         Excel $value_str = ""; //    Excel for ($column = 0; $column &lt; $columns_count; $column++) { //       Excel $merged_value = ""; //   Excel $cell = $worksheet-&gt;getCellByColumnAndRow($column, $row); //      Excel foreach ($worksheet-&gt;getMergeCells() as $mergedCells) { //    - , if ($cell-&gt;isInRange($mergedCells)) { //      ,       //   $merged_value = $worksheet-&gt;getCell(explode(":", $mergedCells)[0])-&gt;getCalculatedValue(); break; } } // ,    :  ,    ,    //   $value_str .= "'" . (strlen($merged_value) == 0 ? $cell-&gt;getCalculatedValue() : $merged_value) . "',"; } //  ,     $value_str = substr($value_str, 0, -1); //     MySQL $connection-&gt;query("INSERT INTO exceltable (" . $columns_str . ") VALUES (" . $value_str . ")"); }</span></span></code> </pre><br><h4>  It's all about the function! </h4><br>  Of course, this script would be much more convenient if everything were combined into a function.  Therefore, the final result is: <br><div class="spoiler">  <b class="spoiler_title">Excel2mysql function</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   require_once "PHPExcel.php"; //    Excel   MySQL,      . //    . : // $worksheet -  Excel // $connection -   MySQL (mysqli) // $table_name -   MySQL // $columns_name_line -      MySQL (0 -   column + n) function excel2mysql($worksheet, $connection, $table_name, $columns_name_line = 0) { //    MySQL if (!$connection-&gt;connect_error) { //      MySQL $columns_str = ""; //     Excel $columns_count = PHPExcel_Cell::columnIndexFromString($worksheet-&gt;getHighestColumn()); //    Excel        for ($column = 0; $column &lt; $columns_count; $column++) { $columns_str .= ($columns_name_line == 0 ? "column" . $column : $worksheet-&gt;getCellByColumnAndRow($column, $columns_name_line)-&gt;getCalculatedValue()) . ","; } //  ,     $columns_str = substr($columns_str, 0, -1); //   MySQL,    if ($connection-&gt;query("DROP TABLE IF EXISTS " . $table_name)) { //   MySQL if ($connection-&gt;query("CREATE TABLE " . $table_name . " (" . str_replace(",", " TEXT NOT NULL,", $columns_str) . " TEXT NOT NULL)")) { //     Excel $rows_count = $worksheet-&gt;getHighestRow(); //    Excel for ($row = $columns_name_line + 1; $row &lt;= $rows_count; $row++) { //         Excel $value_str = ""; //    Excel for ($column = 0; $column &lt; $columns_count; $column++) { //       Excel $merged_value = ""; //   Excel $cell = $worksheet-&gt;getCellByColumnAndRow($column, $row); //      Excel foreach ($worksheet-&gt;getMergeCells() as $mergedCells) { //    - , if ($cell-&gt;isInRange($mergedCells)) { //      ,       //   $merged_value = $worksheet-&gt;getCell(explode(":", $mergedCells)[0])-&gt;getCalculatedValue(); break; } } // ,    :  ,    ,    //   $value_str .= "'" . (strlen($merged_value) == 0 ? $cell-&gt;getCalculatedValue() : $merged_value) . "',"; } //  ,     $value_str = substr($value_str, 0, -1); //     MySQL $connection-&gt;query("INSERT INTO " . $table_name . " (" . $columns_str . ") VALUES (" . $value_str . ")"); } } else { return false; } } else { return false; } } else { return false; } return true; } //    MySQL $connection = new mysqli("localhost", "user", "pass", "base"); //   UTF-8 $connection-&gt;set_charset("utf8"); //   Excel $PHPExcel_file = PHPExcel_IOFactory::load("./file.xlsx"); //    Excel   MySQL $PHPExcel_file-&gt;setActiveSheetIndex(0); echo excel2mysql($PHPExcel_file-&gt;getActiveSheet(), $connection, "excel2mysql0", 1) ? "OK\n" : "FAIL\n"; //    Excel     MySQL foreach ($PHPExcel_file-&gt;getWorksheetIterator() as $index =&gt; $worksheet) { echo excel2mysql($worksheet, $connection, "excel2mysql" . ($index != 0 ? $index : ""), 1) ? "OK\n" : "FAIL\n"; }</span></span></code> </pre><br></div></div><br><h4>  Conclusion </h4><br>  Well, I hope this article will help you.  Well, or if you want to <s>invent your bike, but only</s> write a script <s>with a small motor</s> , this article will help you get started. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  PS </h4><br>  This is my first, and I think not the last article.  Therefore, I am waiting for your advice and amendments, as is customary here, in the comments. <br><br><h4>  Update </h4><br>  I see, nevertheless, I managed to create a small discussion, but not everyone understands why it was done this way.  I will try to explain. <br><br>  First of all: an older person had to work with this and it would be difficult for him to explain how to save the file to CSV without losing the data (and this cannot be ruled out, besides, they have their own format on the XLS file that comes from above) and, Moreover, how to import it via phpMyAdmin (which, by the way, since version 3.4.5 <a href="http://wiki.phpmyadmin.net/pma/import">does not support XLS / XLSX</a> , I advise you to see why) or the like.  So it does not fit. <br><br>  Secondly: all this should be located on the hosting, and the installation of modules both on the server and for local programs is not suitable (besides, there is Linux, and not Windows, as some have thought). <br><br>  Thirdly: this business is carried out every six months, but from idleness, I decided to write such a function, which is able to generalize the import (all of a sudden who needs it). <br><br>  Now for the good: rewrote this function in the class, corrected something and added the ability to export from MySQL to Excel.  You can pick up <a href="https://github.com/BOOMER74/excel_mysql">from here</a> . <br><br>  Sorry for not answering in the comments, I decided that the article itself would be relevant. </div><p>Source: <a href="https://habr.com/ru/post/178089/">https://habr.com/ru/post/178089/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178073/index.html">Two-factor SMS authorization in Redmine</a></li>
<li><a href="../178081/index.html">WebMarkupMin HTML Minifier - a modern HTML minimizer for the .NET platform</a></li>
<li><a href="../178083/index.html">Crashes caused by exceptions</a></li>
<li><a href="../178085/index.html">Scrum implementation notes - which will necessarily lead to iteration failure if nothing is done</a></li>
<li><a href="../178087/index.html">Bread crumbs (breadcrumbs) in asp.net MVC3</a></li>
<li><a href="../178091/index.html">AWS AMAZON - how do you optimize resources</a></li>
<li><a href="../178095/index.html">What is ASO and why it is urgently needed by today's developers</a></li>
<li><a href="../178097/index.html">An open letter to Eric Schmidt about banning private drones</a></li>
<li><a href="../178099/index.html">The first Ukrainian SSD drive or the second life of a Swiss computer</a></li>
<li><a href="../178103/index.html">Mathematical model of the engine Lego NXT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>