<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a little OpenID authorization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A look into the future 
 Recently, all sorts of social networks and Internet-leading services in general, in terms of attendance and number of account...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a little OpenID authorization</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b37/c71/2f9/b37c712f91cdb302e5d00743e4c5e181.png" alt="image" align="left"><br><h4>  A look into the future </h4><br>  Recently, all sorts of social networks and Internet-leading services in general, in terms of attendance and number of accounts, have created a very good, in my opinion, habit - providing unique <a href="http://ru.wikipedia.org/wiki/OpenID">OpenID identifiers</a> for users so that they can be used to access a third-party site.  In addition, a very similar, but not entirely derivative <b><a href="http://ru.wikipedia.org/wiki/OAuth">OAuth</a></b> technology is being developed in parallel, which was born thanks to the efforts of the creators of the notorious Twitter and, quoting Wikipedia, ‚Äúallows the third party to access the protected resources of the user, without having to pass it on ) login and password". <br>  Personally, I am very pleased with this trend, and, moreover, I am almost certain that this technology will have a future.  In particular, in the future there will definitely be new mashaps for aggregating information from a heap of sites (in particular, I would like to recall the very good, but unfairly forgotten service <a href="http://pipes.yahoo.com/pipes/">Yahoo Pipes</a> , which was never able to conquer hearts and minds simply because its time had not come yet Perhaps still ahead), and it is this ‚Äúform factor‚Äù that requires a login for a bunch of services at once. <a name="habracut"></a><br>  Singing the praises of such technologies can be very long, but personally, for example, I have always been strained by sites that need to register from scratch to download something.  After all, we all invariably faced with the fact that when you are looking for where to download this or that material - it often ends up on some completely left and incomprehensible website with a name in the spirit of allbooksmusicwarezzz.omg.su, which also requires registration.  No, it's not about piracy, the fact is that there are plenty of sites with all kinds of junk made on my knee.  But the human memory for logins-passwords is limited, and there is nothing you can do.  But the pleasant moment here is that many OpenID providers, besides the information that directly serves for authorization, can also provide, upon request, basic information about the user - e-mail, full name, preferred language, etc.  And on many of these services, you can control what to give and what to keep secret.  For example, wouldn‚Äôt it be nice for a user to see a friendly inscription ‚ÄúWelcome, Vasya!‚Äù In pure Russian, and the profile is already ready for use, along with the avatar, habits and nickname of a beloved cat ? <br><br><h4>  We do business and work work </h4><br>  Quite lyric, I think, to whom it is necessary as a developer - he already knows everything already written, and simple material is unlikely to be interesting to simple users.  Even more laudatory speeches and reasonings are easy to find <a href="http://softwaremaniacs.org/blog/">on Ivan Sagalayev‚Äôs blog</a> , and we‚Äôll try to make our authorization system through OpenID (for example, for a blog) in Python, with preference and pianists. <br>  For my blog, which is currently under development in my <i>Projects</i> daddy, I decided to completely abandon the registration and authorization system using my login password, and leave OpenID only.  <a href="http://pylonshq.com/">Pylons</a> was chosen as a framework, and for screwing OpenID to Django projects, there is a project with a simple and clear name <a href="http://github.com/simonw/django-openid">django-openid</a> .  For Pylons, in general, there is also a solution called <a href="http://authkit.org/">AuthKit</a> , but I somehow didn‚Äôt have a very good relationship with him, and all I found on the network are a few snippets that I had to figure out. <br>  First you need to install the <a href="http://github.com/openid/python-openid">python-openid</a> module to provide technology support, and then create a controller (request handler by URL, the nearest association is jung views.py) and begin to conjure. <br> <code>$ paster controller auth</code> <br>  At once I will make a reservation that the code is working exactly to the extent that it provides direct authentication, what to do next and how to arrange all this is up to you, gentlemen‚Äôs creators.  The beginning is pretty standard: <br><blockquote> <code><a href="http://s-c.me/8248/s"></a> <a href="http://s-c.me/8248/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">from</font> openid.consumer.consumer <font color="#0000ff">import</font> Consumer, SUCCESS, FAILURE, DiscoveryFailure </li><li>  <font color="#0000ff">from</font> openid.store <font color="#0000ff">import</font> filestore </li><li>  <font color="#0000ff">from</font> openid <font color="#0000ff">import</font> sreg </li><li>  <font color="#0000ff">from</font> datetime <font color="#0000ff">import</font> datetime </li><li>  <font color="#0000ff">from</font> hashlib <font color="#0000ff">import</font> md5 </li><li></li><li>  <font color="#0000ff">class</font> <font color="#cc6633">AuthController</font> (BaseController): </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">__before__</font> (self): </li><li>  <b>self</b> .openid_session = session.get ( <font color="#008000">"openid_session"</font> , {}) <font color="#696969"># check if there is a openid session</font> </li><li></li><li>  <font color="#0000ff">def</font> <font color="#cc6633">index</font> (self): </li><li>  <font color="#0000ff">return</font> render ( <font color="#008000">'/accounts/enter.html'</font> ) </li><li></li><li>  @ rest.dispatch_on (POST = <font color="#008000">"signin_POST"</font> ) <font color="#696969"># separate GET and POST requests for different handlers for convenience</font> </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">signin</font> (self): </li><li>  <font color="#0000ff">if</font> c.user: <font color="#696969"># check if the login user has already tried to log in again</font> </li><li>  session [ <font color="#008000">'message'</font> ] = <font color="#008000">'Already signed in.'</font> </li><li>  session.save () </li><li>  redirect (url (action = <font color="#008000">'index'</font> )) <font color="#696969"># and if so, do not let go</font> </li><li>  session.clear () </li><li>  <font color="#0000ff">return</font> render ( <font color="#008000">'/index.html'</font> ) </li></ol></blockquote><br><br>  Now we come to the most interesting: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://s-c.me/8245/s"></a> <a href="http://s-c.me/8245/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">def</font> <font color="#cc6633">signin_POST</font> (self): </li><li>  problem_msg = <font color="#008000">'A problem ocurred comunicating to your OpenID server.</font>  <font color="#008000">Please try again. '</font> </li><li></li><li>  g.openid_store = filestore.FileOpenIDStore ( <font color="#008000">'.'</font> ) <font color="#696969"># create temporary storage for storing OpenID data, g here is an array of global Pylons variables</font> </li><li></li><li>  <b>self</b> .consumer = Consumer ( <b>self</b> .openid_session, g.openid_store) <font color="#696969"># yeah, that‚Äôs our client</font> </li><li>  openid = request.params.get ( <font color="#008000">'openid'</font> , None) <font color="#696969"># get a string from the request with an OpenID - identifier</font> </li><li>  ... </li></ol></blockquote><br><br>  Yeah, and here is some magic.  SReg is the extension that allows us to request additional user data from the server.  Fields, the value of which I would like to know, are listed in the optional list, and additional data, if anything, can always be requested from the user later.  If any additional information is required directly from the nose, you can request it in required, but if the server does not give it away - there will be an error. <br><br><blockquote> <code><a href="http://s-c.me/8246/s"></a> <a href="http://s-c.me/8246/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  ... </li><li>  sreg_request = sreg.SRegRequest ( </li><li>  <font color="#696969">#required = ['email'],</font> </li><li>  optional = [ <font color="#008000">'fullname'</font> , <font color="#008000">'timezone'</font> , <font color="#008000">'language'</font> , <font color="#008000">'email'</font> , <font color="#008000">'nickname'</font> ] </li><li>  ) </li><li></li><li>  <font color="#0000ff">if</font> openid <font color="#0000ff">is</font> None: </li><li>  session [ <font color="#008000">'message'</font> ] = problem_msg </li><li>  session.save () </li><li>  <font color="#0000ff">return</font> render ( <font color="#008000">'/index.html'</font> ) </li><li>  ... </li></ol></blockquote><br><br>  Here I allowed myself to shuffle and wrote this code only to explain the difference between a simple OpenID and cross-login from a Google account.  The fact is that Google does not represent users of the OpenID-identifier of the form <i><a href="https://vasya_pupkin.google.com/">vasya_pupkin.google.com</a></i> , but everything is much simpler and more fun.  The identification URL for all Google users looks exactly the same - <i><a href="https://www.google.com/accounts/o8/id">www.google.com/accounts/o8/id</a></i> .  It is curious that when requesting this URL, Google returns a ready-made XRDS (XML-like document <a href="http://ru.wikipedia.org/wiki/Yadis">returned by the server using the OpenID 2.0 standard</a> ), which already contains everything necessary for authorization, and you as a user are assigned a unique ID, which is essentially , id OpenID. <br><blockquote> <code><a href="http://s-c.me/8249/s"></a> <a href="http://s-c.me/8249/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">if</font> openid == <font color="#008000">'google'</font> : </li><li>  openid = <font color="#008000">'https://www.google.com/accounts/o8/id'</font> </li><li></li><li>  <font color="#0000ff">try</font> : </li><li>  authrequest = <b>self</b> .consumer.begin (openid) <font color="#696969"># paneled</font> </li><li>  <font color="#0000ff">except</font> DiscoveryFailure, e: <font color="#696969"># what if an error in the address or such a provider exists only in your imagination?</font> </li><li>  session [ <font color="#008000">'message'</font> ] = problem_msg </li><li>  session.save () </li><li>  <font color="#0000ff">return</font> redirect (url (controller = <font color="#008000">'auth'</font> , action = <font color="#008000">'signin'</font> )) </li><li></li><li>  authrequest.addExtension (sreg_request) <font color="#696969"># connect SReg to extract the required fields for the profile</font> </li><li></li><li>  redirecturl = authrequest.redirectURL (h.url_for ( <font color="#008000">'/'</font> , qualified = True), </li><li>  return_to = h.url_for (action = <font color="#008000">'verified'</font> , qualified = True), </li><li>  immediate = False </li><li>  ) <font color="#696969"># after all that we had with the server, we must somehow live on</font> </li><li>  session [ <font color="#008000">'openid_session'</font> ] = <b>self</b> .openid_session </li><li>  session.save () </li><li>  <font color="#0000ff">return</font> redirect (url (redirecturl)) </li></ol></blockquote><br><br>  Well, now you can talk to the server, will we stay friends. <br><br><blockquote> <code><a href="http://s-c.me/8247/s"></a> <a href="http://s-c.me/8247/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  ... </li><li>  <font color="#0000ff">def</font> <font color="#cc6633">verified</font> (self): </li><li>  problem_msg = <font color="#008000">'A problem ocurred comunicating to your OpenID server.</font>  <font color="#008000">Please try again. '</font> </li><li>  <b>self</b> .consumer = Consumer ( <b>self</b> .openid_session, g.openid_store) </li><li>  info = <b>self</b> .consumer.complete (request.params, (h.url_for (controller = <font color="#008000">'auth'</font> , </li><li>  action = <font color="#008000">'verified'</font> , </li><li>  qualified = True))) </li><li>  <font color="#0000ff">if</font> info.status == SUCCESS: <font color="#696969"># all in a bunch</font> </li><li></li><li>  sreg_response = sreg.SRegResponse.fromSuccessResponse (info) <font color="#696969"># retrieve the fields requested in SReg</font> </li><li></li><li>  user = User (by_openid = info.identity_url) <font color="#696969"># looking for user by id in database</font> </li><li></li><li>  <font color="#0000ff">if not</font> <b>user</b> .exist: <font color="#696969"># but here you can do anything.</font>  <font color="#696969">For example, to add a user to the database</font> </li><li>  newuser = User () </li><li>  <font color="#0000ff">try</font> : </li><li>  email = sreg_response.get ( <font color="#008000">'email'</font> , u <font color="#008000">''</font> ), </li><li>  <font color="#0000ff">except</font> : </li><li>  email = u <font color="#008000">''</font> </li><li>  newuser.create ( </li><li>  openid = <b>unicode</b> (info.identity_url), </li><li>  email = email, </li><li>  password = <b>unicode</b> ( <b>md5</b> (info.identity_url) .hexdigest ()), </li><li>  ip = request.environ [ <font color="#008000">'REMOTE_ADDR'</font> ] </li><li>  ) </li><li></li><li>  session.clear () <font color="#696969"># mutima session</font> </li><li>  session [ <font color="#008000">'openid'</font> ] = info.identity_url </li><li>  session.save () </li><li></li><li>  <font color="#0000ff">if</font> <font color="#008000">'redirected_from'</font> <font color="#0000ff">in</font> session: </li><li>  red_url = session [ <font color="#008000">'redirected_from'</font> ] </li><li>  <font color="#0000ff">del</font> (session [ <font color="#008000">'redirected_from'</font> ]) </li><li>  session.save () </li><li>  <font color="#0000ff">return</font> redirect (url (red_url)) </li><li>  <font color="#0000ff">return</font> redirect (url (controller = <font color="#008000">'auth'</font> , action = <font color="#008000">'index'</font> )) </li><li>  <font color="#0000ff">else</font> : <font color="#696969"># the fakir was drunk</font> </li><li>  session [ <font color="#008000">'message'</font> ] = problem_msg </li><li>  session.save () </li><li>  <font color="#0000ff">return</font> redirect (url (action = <font color="#008000">'signin'</font> )) </li></ol></blockquote><br><br>  That's all.  What to do with the received data - put in cookies, continue registration and ask the user for additional information - it is up to you to decide.  Yes, and more, this code does not work with OpenID from <b>Yahoo</b> .  If the hunt on Kozma Prutkov's will to pozor in the root - there is <a href="http://softwaremaniacs.org/blog/2008/11/21/yahoo-openid-on-cicero/">information all in the same blog of Ivan Sagalayev</a> .  I will be glad to hear any criticism, clarification, suggestions.  I will try to deal further with <b>OAuth</b> and organize interested in a little code on the cross-topic from Twitter. <br><br>  For the opportunity to scratch my head with an awl, like Master Vinogradinka, I really thank <a href="http://pylonshq.com/pasties/by_tag/openid">this link</a> and all the comrades who left their snippets there. <br><br>  <b>UPD:</b> Habrayuzer <a href="https://habrahabr.ru/users/mustangostang/" class="user_link">mustangostang</a> <a href="http://habrahabr.ru/blogs/python/101221/">reveals the secrets of AX</a> (how to get the returned information from Google), because Google does not give out SReg. </div><p>Source: <a href="https://habr.com/ru/post/101221/">https://habr.com/ru/post/101221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101213/index.html">GPRS inside. Part 3</a></li>
<li><a href="../101215/index.html">Display the weather forecast on the display.</a></li>
<li><a href="../101218/index.html">How do I use (used?) Google Wave</a></li>
<li><a href="../101219/index.html">The desire to choose and manage with us since birth</a></li>
<li><a href="../101220/index.html">Google experimental search using keyboard shortcuts</a></li>
<li><a href="../101222/index.html">Conflicts at collective sites: possible solutions</a></li>
<li><a href="../101224/index.html">Illiteracy liquidators</a></li>
<li><a href="../101225/index.html">The site of the Minsk branch of the Belarusian Chygunki was hacked</a></li>
<li><a href="../101226/index.html">The secret of success for startups: invest before taking the product to the market, double the rate AFTER</a></li>
<li><a href="../101227/index.html">Caching data, maybe the last thing you should use</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>