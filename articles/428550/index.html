<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Inverter with a pure sine in 15 minutes or ‚Äúpower electronics for everyone‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is power electronics? Without a doubt, this is a whole world! Modern and full of comfort. Many people imagine power electronics as something ‚Äúmag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Inverter with a pure sine in 15 minutes or ‚Äúpower electronics for everyone‚Äù</h1><div class="post__text post__text-html js-mediator-article">  What is power electronics?  Without a doubt, this is a whole world!  Modern and full of comfort.  Many people imagine power electronics as something ‚Äúmagical‚Äù and distant, but look around - almost everything that surrounds us contains a power converter: a power supply unit for a laptop, an LED lamp, UPS, various regulators, voltage stabilizers, chastotniki (FC ) in ventilation or elevator and more.  Most of this equipment makes our lives comfortable and safe. <br><br>  Development of power electronics for several reasons is one of the most difficult areas of electronics - the cost of error here is very high, while the development of power converters has always attracted amateurs, DIY engineers and not only.  Surely you wanted to build a powerful power supply for some of your project?  Or maybe online UPS for a couple of kW and not go broke?  Or maybe chastotnik to the workshop? <br><br>  Today I will talk about my small open project, or rather about its part, which will allow anyone who wants to be able to step into the world of power electronics development and stay alive.  As a demonstration of the possibilities, I will show you how to assemble a voltage inverter from 12V DC to 230V AC with a sine output in 15 minutes.  Intrigued?  Go! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/na/rx/gk/narxgkn5e_6tiuqmfysesuukoug.jpeg"><br><a name="habracut"></a><br><br><h2>  The reasons for the appearance of the project </h2><br>  In the last couple of years, the development of power converters makes up about 90% of my orders, the main labor costs are mainly spent on software development and prototyping, circuit design + final trace of the board from the total costs is usually no more than 10-15%.  Here comes the understanding that the prototyping process, which includes software development, needs to be somehow reduced and optimized. <br><br>  As always, there are at least two ways out: to buy ready-made debugging, for example, from Texas Instrumets or Infineon, but they are usually sharpened for a specific task and cost from $ 500 to $ 5000, and there is no guarantee that there will be a similar order and this investment with high probability just does not pay off. <br>  The second option is to do it yourself, but doing it thoroughly is almost the same as running ‚Äú+1 iron revision‚Äù, which will result in additional expenses for the customer.  If you do not do it thoroughly, then as usual everything will be on snot and somewhere something will fall off and while the layout, components and terms. <br>  After some time, I noticed an obvious solution.  It is so simple and obvious that for a long time I wondered why the same TI or Infineon had not done this yet.  Now I will tell about my "enlightenment". <br><br>  Let's look at some of the most popular topology power converters: <br><br><img src="https://habrastorage.org/webt/d8/_c/0v/d8_c0v8ih8ydkihocalqkrqc2xw.png"><br><img src="https://habrastorage.org/webt/gt/hy/fn/gthyfnx_nnsjohhak7ls4xjszny.png"><br><img src="https://habrastorage.org/webt/bk/ag/qq/bkagqqyzbrqjntnfuxsrrvuxpyy.png"><br><img src="https://habrastorage.org/webt/0y/w0/xp/0yw0xpwofk5jjf47usbdrwglyfy.png"><br><img src="https://habrastorage.org/webt/-c/mz/z_/-cmzz_9skvlq8ux30pjluy0zkvi.png"><br><br>  Now look again carefully.  I drew specially without strapping, only the key components to make it clearer.  What is common in these topologies?  The first thing that strikes you is a series of general points: <br><ul><li>  All topologies include major components - capacitors, transistors and inductance (choke or transformer).  These are 3 whales of power electronics; </li><li>  Transistors are switched on everywhere in the same way and form the so-called ‚Äúhalf bridge‚Äù.  Almost all converter topologies are built from it; </li><li>  The option of switching on the ‚Äúhalf-bridge + capacitor‚Äù bundle does not change on all topologies.  The type of inductance and options for the inclusion of half-bridges is changing. </li></ul><br><br>  From this we can conclude that with a standard module in the form of a bundle ‚Äúhalf-bridge + capacitor‚Äù, you can build any converter, adding only the desired choke or transformer.  Therefore, the obvious solution to simplify prototyping was the creation of such a module: <br><img src="https://habrastorage.org/webt/vx/d6/ec/vxd6ec8swnwqef7v6uhkljsysek.png"><br><br><h2>  Fight good with evil </h2><br>  Unfortunately, a limited number of hours per day and banal laziness dictate their conditions.  I came to the need to make this module a year ago, but the implementation was constantly being transferred under the slogan - <i>‚ÄúI will definitely do it next weekend!‚Äù</i> . <br><br>  Probably the idea would have remained on the shelf, if not for 2 events.  Firstly, 2 customers came to me in one month and everyone wanted a complex and interesting converter in its implementation, and most importantly they were ready to pay very well.  Although considering that he is from Europe, it could have turned out to be even cheaper for them)) Both projects were interesting for me, for example, one of them was ‚Äúthree-phase voltage stabilizer with electrical isolation (sic!)‚Äù, That is, 3-phase PFC + 3 bridge converters (phase shifted) + synchronous rectifier + 3-phase inverter.  All this on SiC and very compact.  In general, I took up two large orders, each of them for ~ 800 man-hours and a period of 6 months.  As a result, I was ‚Äúforced‚Äù to look for ways to optimize. <br><br>  Secondly, the guys from <a href="https://www.pcbway.com/">PCBway</a> wrote to me unexpectedly, many probably ordered the boards from them, and offered to cooperate.  They very actively support open iron projects, that is, the very initiative of CERN - Open Source Hardware.  Cooperation is simple, understandable for both parties - they supply me with free boards for my projects, and I open them, well, I post them on their website, in other places already at will.  For me, this has become an additional motivation, and most importantly my conscience is clear, because  I have been ordering boards and prototypes from them for several years, and for mass production I have been telling them to my friends and partners.  Now I‚Äôve got a bun in the form of free boards for small projects for this, you can write to Habr more often)) <br><br>  And then the ice started, it was decided to create not just the module described earlier, but a whole set of the developer of power electronics and make it open and accessible to everyone. <br><br><h2>  Project structure </h2><br>  At the beginning of the article I mentioned that I‚Äôll tell you today about only one part - this is the <b>power module of the half bridge</b> .  He alone allows you to create a converter, simply by screwing a control circuit, for example, debugging STM32-Discovery, Arduino, TMS320, TL494 or what you own there.  Binding to any platform or MK is not at all. <br><br>  Only this is not the whole project, but part)) What is the power converter made of?  First of all, the power unit, in order for it to work, a certain control module is needed in order to understand what is happening, an indication is needed, and to understand what is happening from a safe distance, also an interface, for example, Modbus RTU or CAN. <br><br>  As a result, the overall structure of the project looks like this: <br><br> <a href=""><img src="https://habrastorage.org/webt/oh/tj/ix/ohtjixc8dimubg0tr7mbjym_aqc.png"></a> <br><br>  Probably in the future I will also write a program for calculating transformers and chokes, both conventional and planar.  So far so.  Different parts of the diagram in draft form have already been implemented and tested in two projects, after minor improvements, articles will also be written on them and source codes will be available. <br><br><h2>  Half bridge power module </h2><br>  Now it's time to take a closer look at today's hero.  The module is universal and allows working with Mosfet and IGBT transistors, both low-voltage and high-voltage switches up to 1200V. <br><br>  <u>Module features:</u> <br><ul><li>  Galvanic isolation of the control (digital) side from the power.  Insulation breakdown voltage 3 kV; </li><li>  The upper and lower keys are independent, each has its own galvanically isolated driver and galvanically isolated dc / dc; </li><li>  A modern driver from Infineon is used - 1EDC60I12AHXUMA1.  Pulse current opening / closing - 6A / 10A.  The maximum frequency is 1 MHz (tested up to 1.5 MHz is stable); </li><li>  Current protection hardware: shunt + op-amp + comparator + optocoupler; </li><li>  The maximum current is 20A.  Limited not by keys, but by the size of the radiator and the thickness of the copper polygons. </li></ul><br><br>  The article features the 1st revision of the module, it is fully operational, but there will be a 2nd revision, in which purely constructive shortcomings are eliminated and the connectors are changed to more convenient ones.  After completing the creation of the documentation, I threw the gerber into the PCBway and after 6 days the courier knocked on the door and handed me such delight: <br><br> <a href=""><img src="https://habrastorage.org/webt/bj/dw/lt/bjdwlt-ijg3_gdxfx0wfkwggk18.jpeg"></a> <br><br>  A week later, finally, the <s>dogs</s> were brought <s>in</s> components from one excellent domestic store.  As a result, everything was mounted: <br><br> <a href=""><img src="https://habrastorage.org/webt/kw/mv/cg/kwmvcghxvdiimkk9ili2zqfnorg.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/ea/dg/cz/eadgczqqlkscl5n89r7ynnvyivm.jpeg"></a> <br><br>  Before moving on, let's look at the module schematic diagram.  You can download it here - <a href="https://drive.google.com/open%3Fid%3D1kIVepLqDq-ezdxGTXLm5kH1wuoRjUEQU">PDF</a> . <br><br>  There is nothing complicated or magical.  Normal half bridge: 2 keys below, 2 above, you can solder one by one.  The driver as above wrote from the family 1ED, very angry and immortal.  Everywhere on the power there is an indication, including + 12V output dc / dc.  The protection is implemented on the AND logical element, in case of overcurrent, the comparator will produce + 3.3V, they will light the optocoupler and it will pull one of the AND inputs to the ground, which means establishing log.0 and the PWM signal from the drivers will disappear.  AND with 3 inputs is used specially, in the next revision I plan to make also protection against radiator overheating and get the error signal there too.  All sources will be at the end of the article. <br><br><h2>  We assemble the inverter model </h2><br>  I thought for a long time on how to demonstrate the operation of the module, so that it is not too boring, and useful, and not very difficult, so that anyone could repeat it.  Therefore, I stopped at the voltage inverter, they are used to work with solar panels, if something bangs on the low-voltage side, it‚Äôs not scary, but on the high-voltage side, just when you turn on, don‚Äôt put your hands in there. <br><br>  The inverter itself is outrageously simple, by the way, MAP Energia rivets just such, here's an example of even the commercial realization of this idea.  The operation of the inverter is to form from a constant voltage of 12V alternating sinusoidal form with a frequency of 50 Hz, because the usual 50 Hz transformer is used to work with just that.  I use some kind of Soviet, like OSM, 220V factory winding and is used as a secondary, and the primary ~ 8V is wound with a copper bus.  It looks like this: <br><br> <a href=""><img src="https://habrastorage.org/webt/xf/6c/js/xf6cjsweiig-ter1invjtnfslci.jpeg"></a> <br><br>  And this monster is only 400 watts!  The weight of the transformer is about 5-7 kg.  Actually, this is the minus of inverters with "iron" transformers, they are huge and heavy.  Plus them is that these inverters are soooo simple, do not require any experience to create and of course are cheap. <br><br>  Now let's connect the modules and the transformer.  In fact, the module for the developer should be presented simply as a ‚Äúblack box‚Äù which has an input of 2 PWMs and 3 power outputs: VCC, GND and the actual output of the half bridge. <br><br><img src="https://habrastorage.org/webt/yt/4f/l5/yt4fl55ueuuzkxi2ytlanqt_z58.png"><br><br>  Now, from these ‚Äúblack boxes‚Äù, let's draw our inverter: <br><br><img src="https://habrastorage.org/webt/ht/ar/pu/htarpuz2ma1w3bduxmbpculsxia.png"><br><br>  Yeah, it took only 3 external elements: a transformer + LC filter.  For the latter, I made a choke by winding the wire from the module to the transformer onto a ring of Kool Mu material, size R32, with a permeability of 60, and an inductance of about 10 ŒºH.  Of course, the throttle should be calculated, but we need 15 minutes later)) In general, if you drive something like 400 W, then you need a ring of R46 size (this is the outer diameter).  Capacity - 1-10 microfarad film, that's enough.  In fact, you can not put a capacitor as a saving, because the capacity of the transformer winding is healthy ... in general, the Chinese and MAP did just that)) The choke looks like this: <br><br><img src="https://habrastorage.org/webt/b0/wl/zy/b0wlzyrj0gxbmarg2rz5kuppdoc.jpeg"><br><br>  It remains to throw a test load on the output, I have a pair of 20 W LED bulbs (nothing visual was at hand), they themselves eat 24W, efficiency however.  Also the no-load current of the transformer is about 1A.  With the battery will eat about 5A.  As a result, we have such a stand: <br><br> <a href=""><img src="https://habrastorage.org/webt/3s/w2/q2/3sw2q2qvocpryrps6vj4ynvwavo.jpeg"></a> <br><br>  Also in the layout is used battery Delta HR12-17, respectively, 12V and a capacity of 17 Ah.  We will control the converter from the STM32F469-Discovery debug board. <br><br><h2>  Code </h2><br>  Initially, the control was supposed to use my STM32VL-Disco, obtained at the exhibition back in 2010, but it so happened that it was on this layout that she was destined to die when all the code was written and the layout was launched.  Forgot about oscilloscope probes and combined 2 lands, amen.  As a result, everything was rewritten on the STM32F469NIH6, it was this debugging that was at hand, so there will be 2 projects: for the F100 and for the F469, both are checked.  Project compiled for TrueSTUDIO, version of the Eclipse from ST. <br><br><div class="spoiler">  <b class="spoiler_title">Footcloth code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"main.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/********************************************* Sinus table **********************************************************/</span></span></span><span class="hljs-meta"> uint16_t sinData[240] = {0,13,26,39,52,65,78,91,104,117,130,143,156,169,182,195,207,220,233,246,258,271,284,296,309,321,333,346,358,370, 382,394,406,418,430,442,453,465,477,488,500,511,522,533,544,555,566,577,587,598,608,619,629,639,649,659,669,678,688,697, 707,716,725,734,743,751,760,768,777,785,793,801,809,816,824,831,838,845,852,859,866,872,878,884,891,896,902,908,913,918, 923,928,933,938,942,946,951,955,958,962,965,969,972,975,978,980,983,985,987,989,991,993,994,995,996,997,998,999,999,999, 999,999,999,998,997,996,995,994,993,991,989,987,985,983,980,978,975,972,969,965,962,958,955,951,946,942,938,933,928,923, 918,913,908,902,896,891,884,878,872,866,859,852,845,838,831,824,816,809,801,793,785,777,768,760,751,743,734,725,716,707, 697,688,678,669,659,649,639,629,619,608,598,587,577,566,555,544,533,522,511,500,488,477,465,453,442,430,418,406,394,382, 370,358,346,333,321,309,296,284,271,258,246,233,220,207,195,182,169,156,143,130,117,104,91,78,65,52,39,26,13,0}; uint16_t sinStep; uint8_t sinStatus; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/******************************************** Used functions ********************************************************/</span></span></span><span class="hljs-meta"> void StartInitClock (void) { RCC-&gt;CR |= RCC_CR_HSEON; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Enable HSE while (!(RCC-&gt;CR &amp; RCC_CR_HSERDY)); FLASH-&gt;ACR |= FLASH_ACR_LATENCY_5WS; RCC-&gt;PLLCFGR = 0x00; RCC-&gt;PLLCFGR |= RCC_PLLCFGR_PLLM_3; // Div for HSE = 8 RCC-&gt;PLLCFGR |= RCC_PLLCFGR_PLLN_4 | RCC_PLLCFGR_PLLN_5 | RCC_PLLCFGR_PLLN_6 | RCC_PLLCFGR_PLLN_7; // PLL mult x240 RCC-&gt;PLLCFGR |= RCC_PLLCFGR_PLLSRC; // Source HSE RCC-&gt;CR |= RCC_CR_PLLON; while((RCC-&gt;CR &amp; RCC_CR_PLLRDY) == 0){} RCC-&gt;CFGR &amp;= ~RCC_CFGR_SW; RCC-&gt;CFGR |= RCC_CFGR_SW_PLL; // Select source SYSCLK = PLL while((RCC-&gt;CFGR &amp; RCC_CFGR_SWS) != RCC_CFGR_SWS_1) {} // Wait till PLL is used RCC-&gt;CR |= RCC_CR_PLLSAION; while ((RCC-&gt;CR &amp; RCC_CR_PLLSAIRDY) == 0) {} } void EnableOutputMCO (void) { RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN; // Enable clock port A GPIOA-&gt;MODER &amp;= ~GPIO_MODER_MODER8; GPIOA-&gt;MODER |= GPIO_MODER_MODER8_1; // Alternative PP GPIOA-&gt;OSPEEDR |= GPIO_OSPEEDER_OSPEEDR8; // Very high speed RCC-&gt;CFGR |= RCC_CFGR_MCO1; // Source PLL RCC-&gt;CFGR &amp;= ~RCC_CFGR_MCO1PRE; // Div = 1 } void InitIndicatorLED (void) { /* * LED1 - PG6 * LED2 - PD4 * LED3 - PD5 * LED4 - PK3 */ RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOGEN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIODEN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOKEN; GPIOG-&gt;MODER &amp;= ~GPIO_MODER_MODER6; GPIOG-&gt;MODER |= GPIO_MODER_MODER6_0; // Output PP GPIOD-&gt;MODER &amp;= ~GPIO_MODER_MODER4; GPIOD-&gt;MODER |= GPIO_MODER_MODER4_0; // Output PP GPIOD-&gt;MODER &amp;= ~GPIO_MODER_MODER5; GPIOD-&gt;MODER |= GPIO_MODER_MODER5_0; // Output PP GPIOK-&gt;MODER &amp;= ~GPIO_MODER_MODER3; GPIOK-&gt;MODER |= GPIO_MODER_MODER3_0; // Output PP } void EnableIndicatorLED (void) { GPIOG-&gt;BSRR |= GPIO_BSRR_BR_6; GPIOD-&gt;BSRR |= GPIO_BSRR_BR_4; GPIOD-&gt;BSRR |= GPIO_BSRR_BR_5; GPIOK-&gt;BSRR |= GPIO_BSRR_BR_3; } void InitLowPWM (void) { /* * TIM1-CH1 - PA8 * TIM1-CH1N - PB13 */ RCC-&gt;APB2ENR |= RCC_APB2ENR_TIM1EN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOAEN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOBEN; /*********** GPIO **********/ GPIOA-&gt;MODER &amp;= ~GPIO_MODER_MODER8; GPIOA-&gt;MODER |= GPIO_MODER_MODER8_1; // Alternative output PP GPIOA-&gt;AFR[1] |= GPIO_AFRH_AFRH0_0; // Select TIM1-CH1 GPIOB-&gt;MODER &amp;= ~GPIO_MODER_MODER13; GPIOB-&gt;MODER |= GPIO_MODER_MODER13_1; // Alternative output PP GPIOB-&gt;AFR[1] |= GPIO_AFRH_AFRH5_0; // Select TIM1-CH1N /*********** Timer *********/ TIM1-&gt;PSC = 2400-1; // div for clock: F = SYSCLK / [PSC + 1] TIM1-&gt;ARR = 1000; // count to 1000 TIM1-&gt;CR1 &amp;= ~TIM_CR1_CKD; // div for dead-time: Tdts = 1/Fosc = 41.6 ns TIM1-&gt;CCR1 = 500; // duty cycle 50% TIM1-&gt;CCER |= TIM_CCER_CC1E | TIM_CCER_CC1NE; // enable PWM complementary out to PB15 and to PA10 TIM1-&gt;CCER &amp;= ~TIM_CCER_CC1NP; // active high level: 0 - high, 1 - low TIM1-&gt;CCMR1 &amp;= ~TIM_CCMR1_OC1M; TIM1-&gt;CCMR1 |= TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1; // positiv PWM1_CH3 and PWM1_CH3N TIM1-&gt;BDTR &amp;= ~TIM_BDTR_DTG; // clear register TIM1-&gt;BDTR |= TIM_BDTR_DTG_2 | TIM_BDTR_DTG_1 | TIM_BDTR_DTG_0; // value dead-time: = 31*Tdts = 32*41,6ns = 1.29us TIM1-&gt;BDTR |= TIM_BDTR_MOE | TIM_BDTR_AOE; // enable generation output and dead-time TIM1-&gt;CR1 &amp;= ~TIM_CR1_DIR; // count up: 0 - up, 1 - down TIM1-&gt;CR1 &amp;= ~TIM_CR1_CMS; // aligned on the front signal: 00 - front; 01, 10, 11 - center TIM1-&gt;CR1 |= TIM_CR1_CEN; // start count } void InitSinusPWM (void) { /* * TIM3-CH1 - PB4 * TIM3-CH2 - PC7 */ RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM3EN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOBEN; RCC-&gt;AHB1ENR |= RCC_AHB1ENR_GPIOCEN; /*********** GPIO **********/ GPIOB-&gt;MODER &amp;= ~GPIO_MODER_MODER4; GPIOB-&gt;MODER |= GPIO_MODER_MODER4_1; // Alternative output PP GPIOB-&gt;AFR[0] |= GPIO_AFRL_AFRL4_1; // Select TIM3-CH1 GPIOC-&gt;MODER &amp;= ~GPIO_MODER_MODER7; GPIOC-&gt;MODER |= GPIO_MODER_MODER7_1; // Alternative output PP GPIOC-&gt;AFR[0] |= GPIO_AFRL_AFRL7_1; // Select TIM3-CH2 /*********** Timer *********/ TIM3-&gt;PSC = 5-1; // div for clock: F = SYSCLK / [PSC + 1] TIM3-&gt;ARR = 1000; // count to 1000 TIM3-&gt;CCR1 = 0; // duty cycle 0% TIM3-&gt;CCR2 = 0; // duty cycle 0% TIM3-&gt;CCER |= TIM_CCER_CC1E; // enable PWM out to PA8 TIM3-&gt;CCER &amp;= ~TIM_CCER_CC1P; // active high level: 0 - high, 1 - low TIM3-&gt;CCER |= TIM_CCER_CC2E; // enable PWM complementary out to PA9 TIM3-&gt;CCER &amp;= ~TIM_CCER_CC1P; // active high level: 0 - high, 1 - low TIM3-&gt;CCMR1 &amp;= ~(TIM_CCMR1_OC1M | TIM_CCMR1_OC2M); TIM3-&gt;CCMR1 |= TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1; // positiv PWM1_CH1 and PWM1_CH2 TIM3-&gt;CR1 &amp;= ~TIM_CR1_DIR; // count up: 0 - up, 1 - down TIM3-&gt;CR1 &amp;= ~TIM_CR1_CMS; // aligned on the front signal: 00 - front; 01, 10, 11 - center TIM3-&gt;CR1 |= TIM_CR1_CEN; // start count } void InitStepSinus (void) { RCC-&gt;APB1ENR |= RCC_APB1ENR_TIM6EN; // enable clock for basic TIM6 TIM6-&gt;PSC = 5-1; // div, frequency 24 kHz TIM6-&gt;ARR = 1000; // count to 1000 TIM6-&gt;DIER |= TIM_DIER_UIE; // enable interrupt for timer TIM6-&gt;CR1 |= TIM_CR1_CEN; // start count NVIC_EnableIRQ(TIM6_DAC_IRQn); // enable interrupt TIM6_DAC_IRQn } /************************************* Main code *********************************************/ int main (void) { StartInitClock(); // EnableOutputMCO(); InitIndicatorLED(); InitLowPWM(); InitSinusPWM(); InitStepSinus(); EnableIndicatorLED(); while(1) { } } /****************************** Interrupts ******************************************************/ void TIM6_DAC_IRQHandler (void) { TIM6-&gt;SR &amp;= ~TIM_SR_UIF; if (sinStatus == 0) {TIM3-&gt;CCR1 = sinData[sinStep];} if (sinStatus == 1) {TIM3-&gt;CCR2 = sinData[sinStep];} sinStep++; if (sinStep &gt;= 240) { sinStep = 0; sinStatus = sinStatus ? 0 : 1; } }</span></span></span></span></code> </pre> <br></div></div><br>  In general, in his other article he sooo described in detail and clearly how to form a sinusoidal signal, how to write code, and so on.  You can read - <a href="https://habr.com/post/358172/">here</a> . <br><br>  Read?  Want to collect?  Keep the project: <br><br><ul><li>  <a href="https://drive.google.com/open%3Fid%3D12eoCTCAi0Vft2rMYtK-mWHzvNNEgXWm2">Project for F469</a> </li><li>  <a href="https://drive.google.com/open%3Fid%3D1-FeLKK0u5AmS4OjdJkIxDin9cr-a6eHv">Project for F100</a> </li></ul><br>  We launch the code, we arm ourselves with an oscilloscope and go further.  First of all, we check for the presence of a signal at the driver input, it should be like this: <br><br><img src="https://habrastorage.org/webt/nd/gc/5f/ndgc5fcjhtwnxk_oxdwnanbwtkq.png"><br><br>  It should be noted that I am sending two signals to one half-bridge (module), drawing a sine, and to the other 2 signals defining 50 Hz.  Moreover, one diagonal is ‚Äúred + yellow‚Äù and the other is ‚Äúblue + green‚Äù.  The article that gave above about this is written in detail, if you suddenly do not understand.  Now, as we have given signals, we throw on both half-bridges + 12V and GND from the laboratory power supply unit.  Immediately I do not advise the battery, if something is mistaken, it can burn something.  The protection on the board saves from overcurrent, but not from obvious jambs when plus and minus are confused, but the lab is saving.  12V and 1A for tests is enough.  We take the oscilloscope probe, its earth wire to the output of the first half-bridge, and the probe itself to the output of the other half-bridge should be such a picture: <br><br><img src="https://habrastorage.org/webt/px/6j/fk/px6jfknnkrrf4y_l09t-_h9csfk.png"><br><br>  Where is the sine you ask?  The fact is that the resistance of the oscilloscope input is large and it does not represent a load, so the current does not flow and the sine does not come from.  Add the load, I made 10 ohm resistors with a 90 ohm load by simply connecting 9 pieces in series.  We cling to the outputs of the half-bridges and see the following picture: <br><br><img src="https://habrastorage.org/webt/a1/ro/7b/a1ro7ba6mmxhagnpiyau1mjstqo.png"><br><br>  Do you have the same?  So it's time to connect the choke, transformer, load and try to start.  <b>Achtung!</b>  <b>You can not include this model without load, because at idle at the exit can be up to 350 ... 380V.</b>  <b>So that this does not need a load or OS.</b>  We will not have the last one, this is the topic of a separate article, you can fasten the simplest P-regulator as an elective, you already have a project template. <br><br><h2>  Turning on </h2><br>  After switching on, we get about 230V at the output, the output is of course not stabilized and will float 230V + -30V, it will go for tests, in another article we will finalize the layout and decide how to tell about P and PI controllers and their implementation. <br><br>  Now you can enjoy the result of the work, and if necessary, pack everything in a box and even apply it on the farm or in the country to provide yourself with light and other amenities. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Te0OhTMt0Tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  You probably noticed a delay between the ‚Äúclick‚Äù, that is, the power supply to the Discovery and the switching on of the lamps - this is the time that the MC spent on initialization.  This delay can be reduced by writing one digit to the register at once, rather than splitting the register entry into a bunch of lines.  I shattered solely for clarity.  Although it is not scary, with the code on HAL the delay is 3 times longer and the people somehow live with it)) <br><br>  Until I forgot, the source code of the project: <br><br><ul><li>  Schematic diagram - <a href="https://drive.google.com/open%3Fid%3D1kIVepLqDq-ezdxGTXLm5kH1wuoRjUEQU">pdf</a> </li><li>  BOM - <a href="https://drive.google.com/open%3Fid%3D1-W1I82anpk86ctsdYZnuAC542qULpBsC">Excel</a> </li><li>  Gerber-files - <a href="https://drive.google.com/open%3Fid%3D1_isTHDtdZjp4VmFh9zyXubO99S-e-PRD">RAR</a> </li></ul><br><br>  It remains to see how there are temperatures on the board, whether there are any particularly hot places.  5-6A is certainly not enough, but if the through-current is on or some serious error, then that will be enough to turn the board into a kettle: <br><br><img src="https://habrastorage.org/webt/xz/fp/ln/xzfplnlxfklygc-vjabjtpws1em.png"><br><br>  As you can see, the hottest element is the dc / dc module for galvanic isolation, which is 2 watts, it heats up to 34 degrees, and also a shunt.  The transistors themselves and the radiator have an ambient temperature after 30 minutes of the converter operation)) <br><br><h2>  Thanks and plans </h2><br>  In the near future, I plan to write about the DSP board and will not be managing from the discovery debugging, but already from the ‚Äúspecialized‚Äù module.  The 2nd revision boards have already come to it from the same PCBway, waiting for the components and writing right away. <br><br>  I hope you liked the article and the idea itself.  In the future, on the same modules, I will show how to assemble the frequency counter, the mppt controller, and maybe something else interesting.  If you have questions, feel free to ask them in the comments or in a personal, if you suddenly do not have a full account, I will try to answer all the questions. <br><br>  Now a few thanks to the company <a href="https://www.pcbway.com/">PCBway</a> , in fact, it‚Äôs very good that they support open source development.  Zheleznyachniki may even catch up with software writers in terms of the quantity and quality of open source projects. <br><br><img src="https://habrastorage.org/webt/hm/pu/px/hmpupxkj9ov6-oum1vvnqmi0oqu.png"></div><p>Source: <a href="https://habr.com/ru/post/428550/">https://habr.com/ru/post/428550/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428540/index.html">Clinical trials have shown a decrease in Alzheimer's disease progression by more than half</a></li>
<li><a href="../428542/index.html">Tourists in the European Union will be checked using AI</a></li>
<li><a href="../428544/index.html">Vulnerability in Bluetooth opens up opportunities to attack wireless access points</a></li>
<li><a href="../428546/index.html">Three years of those. support, 152 health facilities, 3740 pcs</a></li>
<li><a href="../428548/index.html">Aspect-oriented programming, Spring AOP</a></li>
<li><a href="../428552/index.html">Algorithm: How to find the next lexicographic permutation</a></li>
<li><a href="../428556/index.html">‚ÄúProduction environment out of your control‚Äù: Rian Lewis about testing blockchain projects</a></li>
<li><a href="../428558/index.html">How I created a ‚Äúwizard‚Äù for WordPress from my deep laziness</a></li>
<li><a href="../428560/index.html">Unscheduled Friday Announcement</a></li>
<li><a href="../428562/index.html">Droidcon London. How it was</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>