<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Functional shell programming using the xargs example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Abstract : a story about how quickly and beautifully to do list processing in a shell, a little manual on xargs and a lot of water about the philosoph...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Functional shell programming using the xargs example</h1><div class="post__text post__text-html js-mediator-article">  <u>Abstract</u> : a story about how quickly and beautifully to do list processing in a shell, a little manual on xargs and a lot of water about the philosophy of either programming or administration. <br><br>  Some SEO optimization: currying, lambda-function, composition of functions, map, list filtering, work with sets in the shell. <br><br><h1>  Example </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/9c5/a24/498/9c5a244986a449cb7e97ec700c592fde.png" align="right"><br>  System administrators are often in a situation where you need to take the output of one program, and apply a different program to each element of the output.  Or not even one.  As an amusing (and useless) example, we take the following: it is required to calculate the total size of all executable files currently running on the system along with all the dynamic libraries they use. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is not a real ‚Äútask‚Äù, this is an educational example, solving which (the solution will be a one-liner) I will tell you about a very unusual and powerful system administration tool - linear functional programming.  It is linear, because the use of the pipe "|"  This is linear programming, and using xargs allows you to turn a complex program with nested loops into a one-line functional type.  The purpose of the article will not show ‚Äúhow to find the size of libraries‚Äù and not retell the arguments of xargs, but explain the spirit of the decision, explain the philosophy behind it. <br><br><h1>  Lyrics </h1><br>  There are several programming styles.  One of them looks like this: for each element of the list, make a cycle in which for each element of the list, if it is not an empty string, take the file name, and if the file size is not zero, then add to the counter.  Oh yes, first you need to make the counter zero. <br><br>  Another looks like this: <br>  Apply a function to the list, which is applied to each element of the list, if this element is a non-empty string and the file size is not zero with this name, add to the sum. <br><br>  Even the words show that the second option is shorter. <br><a name="habracut"></a><br>  Taking into account the expressive means of programming languages, constructions are capacious and devoid of the problems of ordinary cycles - loops, incorrect exit from a cycle, etc. <br><br>  In fact, in the context of the problem under discussion, we are talking about specifying a function to be applied to each element of the list.  The function itself, in turn, can also be a list handler, with its processing function. <br><br><h1>  Data to solve </h1><br>  To solve the problem, we need to get a list of running processes.  This is simpler than it looks - all processes are in / proc / [0-9] +.  Next, we need the paths to the binary.  And this is also simple: / proc / PID / exe for all processes except nuclear, points to the path to the process.  Next task: we need a list of libraries for the file.  This is done by the ldd command, which expects a file path and displays (in a tricky format) a list of libraries.  Next issue of technology and walking on symlinks - we need to go through the library symlinks to the very stop, and then calculate the size of each of the files. <br><br>  Thus, the high-level description of the task looks like this: take lists of executable files and libraries, and for each of them find out the size. <br><br>  Note that in the process the list of executable files will be used twice - once ‚Äúby itself‚Äù, the second time - to get the list of libraries of each file. <br><br><h1>  Imperative decision </h1><br>  (I exaggerate and omit the details) <br><pre><code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_exe_list</span></span></span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `ls /proc/*; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> readlink -f <span class="hljs-variable"><span class="hljs-variable">$a</span></span>/exe; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> } <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_lib</span></span></span></span>(){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `cat `; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ldd <span class="hljs-variable"><span class="hljs-variable">$a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> |awk <span class="hljs-string"><span class="hljs-string">'{print $3}'</span></span> } <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calc</span></span></span></span>(){ sum=0 sum=$(( <span class="hljs-variable"><span class="hljs-variable">$sum</span></span> + `<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(cat); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> du -b <span class="hljs-variable"><span class="hljs-variable">$a</span></span>|awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>` )) } exe_list=`get_exe_list|sort -u` lib_list=`<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$exe_list</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> get_lib <span class="hljs-variable"><span class="hljs-variable">$a</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">done</span></span>|sort -u` size=$(( calc_size <span class="hljs-variable"><span class="hljs-variable">$exe_list</span></span> + calc_size <span class="hljs-variable"><span class="hljs-variable">$lib_list</span></span>)) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$size</span></span></code> </pre> <br><br>  Disgusting, right?  This, we note, without regexp on the proper filtering of pids (we do not need to try to read a non-existing / proc / mdstat / exe) and without handling numerous cases of errors. <br><br><h1>  Lists </h1><br>  We are aware of the task.  Since our input data is homogeneous files, we can simply present them as a list, and process them the same way.  Caps I will write "not written" sections of code. <br><br><h2>  Part One: Double List Processing </h2><br><br>  We‚Äôre cheating a bit, and we‚Äôll use stderr to duplicate the list. <br><br><pre> <code class="bash hljs">(EXE_LIST |tee /dev/stderr|LIB_LIST) 2&gt;&amp;1 | CALC</code> </pre><br><br>  What does this code do?  Unwritten until part of EXE_LIST generates an exe list in the system.  tee takes this list, writes to stderr (stream number 2) and writes to stdout (stream number 1).  Stream # 1 is passed to LIB_LIST.  Then we combine the output of all three commands (brackets) with stderr and push into stdout with a single list and transfer to CALC. <br><br>  Now we need to do EXE_LIST <br><br><h2>  Part Two: Filtering Lists </h2><br><br>  (Note. To see _all_ processes in the system, you need to be root). <br><br>  We will go in a slightly unusual way, and instead of ls in a loop, use find.  In principle, it is possible to use ls, but there will be more problems with the processing of symlinks. <br><br>  So: <code>find /proc/ -maxdepth 2 -name "exe" -ls</code> <br>  we need maxdepth to ignore threads, we get a conclusion similar to the output of ls.  We need to filter it. <br><br>  So, we improve EXE_LIST: <br><br><pre> <code class="bash hljs">find /proc/ -name <span class="hljs-string"><span class="hljs-string">"exe"</span></span> -ls 2&gt;/dev/null|awk <span class="hljs-string"><span class="hljs-string">'{print $13}'</span></span></code> </pre><br>  Observation: we will use stderr for data transfer, so we don‚Äôt need to find a flood about problems with any kind of nuclear threads. <br><br><h2>  Part Three: LIB_LIST </h2><br><br>  It's simple: for each transferred file we need to use ldd, then brush the output. <br><br><pre> <code class="bash hljs">xargs -n 32 -P 4 ldd 2&gt;/dev/null|grep <span class="hljs-string"><span class="hljs-string">"/"</span></span>|awk <span class="hljs-string"><span class="hljs-string">'{print $3}'</span></span></code> </pre><br><br>  What's so interesting?  We limit ldd with a maximum of 32 files at a time, and run 4 queues of ldd in parallel (yes, this is how we get homebrew badup).  The -P option allows you to parallelize the execution of ldd, which will give us some speed increase on multi-core machines and good disks (fucking it, in this case, but if we do something more slower than ldd, then parallelism can be a salvation ... ). <br><br><h2>  Part Four: CALC </h2><br><br>  At the input files, at the output it is necessary to give the figure the total size of all files.  The size will be determined ... However, stop.  Who said that symlinks point to files?  Of course, symlinks point to symlinks that point to symlinks or files.  And those symlinks ... Well, they did it. <br><br>  Add readlink.  And he, the infection, wants one parameter at a time.  But there is an option -f, which will save us a lot of effort - it will show the name of the file, regardless of whether it is a symlink or just a file. <br><br>  | xargs -n 1 -P 16 readlink -f | sort -u <br><br>  ... so, the size will be determined using du.  Note, we could simply use the -C option here, which will add up the numbers and give the answer, but in the training course we are not looking for simple ways.  So without muhlezh. <br><br>  | xargs -n 32 -P 4 du -b | awk '{sum + = $ 1} END {printf "% i \ n", sum}' <br><br>  Why do we need sort -u?  The fact is that we will have a lot of repetitions.  We need to select unique values ‚Äã‚Äãfrom the list, that is, turn the list into a set (set).  This is done by a naive method: we sort the list and say throw out duplicate lines when sorting. <br><br><h1>  One-liner, terrifying </h1><br><br>  We write everything together: <br><br>  (find / proc / -name exe -ls 2&gt; / dev / null | awk '{print $ 13}' | tee / dev / stderr | xargs -n 32 -P 4 ldd 2&gt; / dev / null | grep / | awk '{print $ 3}') 2&gt; &amp; 1 | sort -u | xargs -n 1 -P 16 readlink -f | xargs -n 32 -P 4 du -b | awk '{sum + = $ 1} END {print sum}' <br><br>  (I didn‚Äôt put a raw tag in this horror, so that the line would be automatically transferred, so as not to tear your rss-reader tapes, love me.) <br><br>  Of course, THIS is no better than what was stated at the beginning.  Fear and horror, in one word.  Although, if you are a guru 98 leveled up and shake the 99th, then such one-line players may be the usual style of work ... <br><br>  However, back to the assault of the 10th left. <br><br><h1>  Decent look </h1><br>  We want to cut it.  On readable and debugged pieces of code.  Sane.  Commented. <br><br>  So back to the initial entry form: (EXE_LIST | tee / dev / stderr | LIB_LIST) 2&gt; &amp; 1 |  Calc <br><br>  Readable?  Maybe yes. <br><br>  It remains to figure out how to properly write EXE_LIST <br><br>  Option one: using functions: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EXE_LIST</span></span></span></span> (){ find /proc/ -name <span class="hljs-string"><span class="hljs-string">"exe"</span></span> -ls 2&gt;/dev/null|awk <span class="hljs-string"><span class="hljs-string">'{print $13}'</span></span> } <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LIB_LIST</span></span></span></span> (){ xargs -n 32 -P 4 ldd 2&gt;/dev/null|grep /|awk <span class="hljs-string"><span class="hljs-string">'{print $3}'</span></span> } <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CALC</span></span></span></span> (){ sort -u|xargs -n 1 -P 16 readlink -f|xargs -n 32 -P 4 du -b|awk <span class="hljs-string"><span class="hljs-string">'{sum+=$1}END{print sum}'</span></span> } (EXE_LIST |tee /dev/stderr|LIB_LIST) 2&gt;&amp;1 | CALC</code> </pre><br><br>  And a bit of functional nobility: <br><br><pre> <code class="bash hljs">EXE_LIST () ( find /proc/ -name <span class="hljs-string"><span class="hljs-string">"exe"</span></span> -ls 2&gt;/dev/null|awk <span class="hljs-string"><span class="hljs-string">'{print $13}'</span></span> ) LIB_LIST () ( xargs -n 32 -P 4 ldd 2&gt;/dev/null|grep / |awk <span class="hljs-string"><span class="hljs-string">'{print $3}'</span></span> ) CALC() ( sort -u|xargs -n 1 -P 16 readlink -f|xargs -n 32 -P 4 du -b|awk <span class="hljs-string"><span class="hljs-string">'{sum+=$1}END{print sum}'</span></span> ) (EXE_LIST |tee /dev/stderr|LIB_LIST) 2&gt;&amp;1 | CALC</code> </pre><br><br>  Of course, the FNP purists will say that there is no type inference, no control, no lazy computation, and in general it‚Äôs insane to treat this list processing - insanity and pornography. <br><br>  However, this is code, it works, it is easy to write.  It should not be a real product environment, but it can easily be a tool that, of three hours of monotonous work, will leave 5 minutes of interesting programming.  This is the specifics of the work of the system administrator. <br><br>  The main thing I wanted to show: a functional approach to the processing of sequences in a shell gives a more readable and less cumbersome code than direct iteration.  And it works faster, by the way (due to xargs parallelism). <br><br><h1>  scalabilty </h1><br>  A further development of the ‚Äúhadup on the shell‚Äù is the gnu parallels utility, which allows you to run code on several servers in parallel. </div><p>Source: <a href="https://habr.com/ru/post/153785/">https://habr.com/ru/post/153785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153775/index.html">New service from REG.RU - domain monitoring</a></li>
<li><a href="../153777/index.html">I do not like Windows Phone</a></li>
<li><a href="../153779/index.html">Google takes control of Android. Changes in the program Google Nexus</a></li>
<li><a href="../153781/index.html">The digest of interesting news and materials from the world of ayti for the last week No. 25 (September 29 - October 5, 2012)</a></li>
<li><a href="../153783/index.html">Mars rover Curiosity checked in on Foursquare from Mars</a></li>
<li><a href="../153787/index.html">Russian programmer ranked first on TopCoder Open</a></li>
<li><a href="../153789/index.html">Yes, I still want to do it when I turn 56</a></li>
<li><a href="../153793/index.html">Samsung will introduce something new on October 11</a></li>
<li><a href="../153797/index.html">Future trends: distributed work, gamification, sports internet</a></li>
<li><a href="../153799/index.html">Weapons in Russia will be equipped with biometric scanners</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>