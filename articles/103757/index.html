<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BAARD in Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Raymond Chen ‚Äôs story about how much Microsoft is trying to ensure compatibility of new versions of Windows with other people's programs caused an amb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BAARD in Windows</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/Old_New_Thing/103598/">Raymond Chen</a> ‚Äôs <a href="http://habrahabr.ru/blogs/Old_New_Thing/103598/">story</a> about how much Microsoft is trying to ensure compatibility of new versions of Windows with other people's programs caused an ambiguous reaction. <br><br>  The reverse case is also known: when Microsoft deliberately sought the incompatibility of Windows with the ‚Äúunreliable‚Äù clones of MS-DOS.  From the release of <i>Dr.</i>  <i>Dobb's Journal</i> for September 1993: <br><br><blockquote><h4>  <a href="http://fringe.davesource.com/Fringe/NonZen_Companies/Microsoft/Tactics/1993.09.01.Locks_Out_DrDOS.html">Windows AARD Detection Code</a> </h4><br>  If you participated in the beta test of Windows 3.1, and DR-DOS was on your computer, then you probably encountered this unusual error message: <br><pre> Non-Fatal error detected: error # 2726
 Please contact Windows 3.1 beta support
 Press ENTER to exit or C to continue
</pre><br>  Although this is a ‚Äúnon-fatal error,‚Äù and pressing C continues to start Windows, the ‚Äúdefault‚Äù action is to cancel the launch. <br>  Already suspicious: if the error is non-fatal, and Windows is able to work, despite it, why bother to report it to the user at all? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This message was issued by the programs <code>WIN.COM</code> , <code>SETUP.EXE</code> , <code>HIMEM.SYS</code> , <code>SMARTDRV.EXE</code> and <code>MSD.EXE</code> in several pre-release editions of Windows 3.1. <br>  The final version of Windows 3.1 still contains the code that displays this message.  This code is ‚Äúoff‚Äù, but it is enough to change one byte in <code>WIN.COM</code> to ‚Äúenable‚Äù it. <br><br>  The most interesting thing about this message is that it is displayed on all versions of DR-DOS, including the beta version of Novell DOS 7, but is not displayed on either MS-DOS or PC-DOS.  What does this message say? <br><a name="habracut"></a><br><h5>  Maybe this is an accident? </h5><br>  Microsoft competitors often whine about the fact that the ‚Äúevil empire‚Äù intentionally disrupts the work of their programs.  In fact, Microsoft usually makes unprecedented efforts to support backward compatibility, even when faced with errors in competitors' programs. <br><br>  Anyone who claims that Microsoft "does not allow" Windows to work on DR-DOS, I can point out the fact: Advanced Windows 3.1 mode works fine on DR-DOS.  Yes, Standard mode does not work, but Novell has confirmed that this is because of a bug in DR-DOS. <br><br>  One would assume that a strange error message is displayed due to another bug in Novell DOS.  It is not for the first time that bugs in N programs are attempting to pass off as ‚Äúintentional incompatibility‚Äù of M. <br><br><h5>  Debug protection </h5><br>  The first step in ascertaining the causes of a message is analyzing the <code>WIN.COM</code> code.  Immediately we encounter an obstacle course: the corresponding fragment of <code>WIN.COM</code> encrypted with XOR, self-modifying, deliberately confused, and in addition is stuffed with tricks for protection against step-by-step execution: for example, it installs <code>INT 1,2,3</code> debug interrupt vectors on non-existing addresses.  This has no effect on modern debuggers (I used Soft-ICE from Nu-Mega), but by themselves attempts to obstruct the research have already revealed that the matter is unclean. <br><br>  Despite the fact that the main part of the code is encrypted, a line with Microsoft copyright remained unencrypted, and a couple of lines ‚ÄúAARD‚Äù and ‚ÄúRSAA‚Äù - possibly, the initials of the programmer. <br><br>  <i>(The author guessed: AARD - the initials of Aaron Reynolds, who implemented this "protection".)</i> <br><br><h5>  A string of checks </h5><br>  In essence, the encrypted code checks whether the operating system is genuine MS / PC-DOS.  (Given that this code is part of Windows - an MS-DOS-independent product!) Various aspects of undocumented functions and internal DOS structures are checked.  For example, the AARD code checks some pointers in <code>SysVars</code> to ensure that they are initialized.  Interestingly, although the <code>SysVars</code> structure <code>SysVars</code> implemented in any quality DOS clone, the DR-DOS 5/6 version does not pass internal <code>HIMEM.SYS</code> testing: this driver loads before the initialization of the internal DR-DOS structures completes. <br><br>  Further more complicated tests follow.  First, the code checks if the network redirector is running.  If started, AARD checks whether the table of lowercase and capital letters of the current codepage is located in the same segment.  If the redirector is not running, AARD makes sure that the first file control block (FCB) is at offset 0. <br><br>  These tests pass all versions of MS-DOS, but not a single version of DR-DOS passes. <br><br><h5>  Stern guard </h5><br>  What is the relation of linguistic information to the network redirector?  What is the difference between Windows, in which segment the capitalization table is located, and by what offset - FCB?  What are these "mistakes"? <br><br>  In fact, the capitalization segment is not used anywhere in Windows: the AARD code has nothing to do with the work of those five unrelated programs.  It would be clear if Windows analyzes the internal structures of DOS and determines its version in order to check whether certain functions are implemented.  But neither <code>WIN.COM</code> , nor other programs with the AARD-code <i>in any way use the</i> result of the checks: the only thing they do is confuse the users of the ‚Äúextraneous‚Äù versions of DOS with a meaningless error message. <br><br>  This is definitely similar to "intentional incompatibility."  If the ‚Äúerror‚Äù is non-fatal, and Windows continues to work normally, then what is the error?  That the user chose the wrong version of DOS? <br><br>  I tried changing the pointers to the letter table and to the FCB in MS-DOS to point to the same data, but using a different pair (segment: offset).  Windows and all my programs continued to work as if nothing had happened;  the only change is that now I began to receive an AARD message at startup. <br>  It turns out that AARD is a test for absolute, finished MS-DOS compatibility. <br><br>  I reported a find to Microsoft, and received a response from a high-ranking employee: ‚ÄúWe don‚Äôt care about DR-DOS ... They [Novell] say they are 100% compatible, but DR-DOS is full of bugs.  If DR-DOS users have problems with Windows, let Novell understand. ‚Äù <br>  But apparently, they have to do with DR-DOS - since they implemented such a sophisticated check, and even so thoroughly confused it. <br><br>  Microsoft is not new to using undocumented interfaces for communication between its products.  For example, DOS clones, including DR-DOS, have to impersonate old versions of MS-DOS, for example, MS-DOS 3.31, so that Windows runs on them in Advanced mode.  This is due to the fact that the <code>DOSMGR</code> driver in <code>WIN386.EXE</code> uses an undocumented protocol for communication with MS-DOS 5/6, which has not yet been decrypted by other companies.  If the clones were posing as modern versions of DOS, then Windows would try to contact them using an unsupported protocol. <br>  But the transition from undocumented interfaces to purposely entangled and encrypted is a hitherto unseen technology of competition. <br><br></blockquote><hr><br>  <a href="http://techrights.org/comes-vs-microsoft/text/msg00185.html">The answer of the author of the AARD-code</a> , behind the Windows fathers visa is Bill Gates and Brad Silverberg, very muddy and watery.  In short, the Windows developers actually discovered during testing a number of problems with DOS clones, and decided not to waste extra forces on detecting and circumventing all incompatibilities, but simply to issue a message when running Windows not on MS-DOS, ‚Äúyour operating system is not supported;  continue at your own peril. ‚Äù <br><br>  Aaron is outraged even by the assumption that Microsoft should support Windows on foreign versions of DOS: ‚ÄúIt‚Äôs not the first year that they have been living offended by our developments;  we didn‚Äôt have enough to debug their crafts for them. ‚Äù <br><br>  At the time of beta testing, it was decided to make the message more vague, and to include the mention of an incomprehensible error, so that the user did not forget to report that a message appeared on his computer. <br>  It was important for the beta test organizers to know which users are working under MS-DOS (and report real bugs in Windows), and who are under DOS clones (and, perhaps, see bugs from these clones, and not Windows). <br>  The code was also encrypted so that Novell did not have time to figure it out and release the DR-DOS version that would run it before the end of the beta test of Windows ‚Äî that would confuse the test organizers with the results. <br><br>  After beta testing, but before the release, the project management changed plans, and at the last moment the DOS ‚Äúauthenticity‚Äù check was removed altogether.  The existing code, just in case, was left in place: the smaller the change volume, the less chance of inadvertently dropping something else. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/28f/cda/366/28fcda3660c187d5191a03708ac25c45.jpg"></div><br><br>  Unusual memories "on the other side of the barricades" <a href="http://blogs.msdn.com/b/larryosterman/archive/2004/08/12/213681.aspx">leads Larry Osterman</a> : <br><br><blockquote>  I don't know why the AARD code was confused;  I think this is nonsense.  But I must say that I absolutely agree with the idea of ‚Äã‚ÄãDOS authentication.  Windows developers have decided that they belong to all parts of the system, including undocumented OS structures.  They knew how to find them, they knew their size, and they did not hesitate for a minute, replacing these internal structures with their own.  Needless to say, from the MS-DOS developer‚Äôs point of view, Windows support was a nightmare. <br><br>  One example: when Windows was loading, it increased the size of the SFT ‚Äî the internal table of MS-DOS files (this is the same table that is set by the <code>FILES=</code> line <code>FILES=</code> in <code>config.sys</code> ).  It was necessary to increase it, so that at the same time it was possible to open more than 20 files: imagine a multitasking OS in which it would be impossible to open 20 files.  But for this, Windows programmers with an undocumented call received a pointer to the ‚Äúinteresting‚Äù MS-DOS structures, added a known offset, and replaced the system SFT with their own. <br><br>  When I was working on MS-DOS 4.0, and we needed to provide support for Windows, then leaving the pointer in the place where Windows expected to find it was easy.  The problem was that MS-DOS 4.0 SFT was two bytes more than MS-DOS 3.1.  In order for Windows to replace SFT, I added a DOS code to the bootloader that recognizes the launch of <code>WIN.COM</code> ;  finds in its code a <code>MOV</code> instruction with an operand equal to the size of the old SFT;  and directly in memory replaces this operand with a new SFT size. <br>  Exactly: we had to patch Windows code on the go in order for it to continue working. <br><br>  Now you understand why Windows did not want to run on DOS clones.  Besides the fact that she managed in undocumented structures, she actively used the features of concrete implementations of system functions: at what moments they can be called and at which it is impossible;  which ones are reentrant and which ones are not.  Imagine what might have happened on an incompletely compatible DOS: from unexplained freezes to data corruption on the disk. <br><br>  Considering what fine neurosurgery Windows did in the guts of MS-DOS, it is only natural that she was convinced that the patient was not replaced. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/103757/">https://habr.com/ru/post/103757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../103744/index.html">Google will launch a music store</a></li>
<li><a href="../103745/index.html">NASA has created a new robot, RoboThespian</a></li>
<li><a href="../103747/index.html">On the knowledge gained on the run</a></li>
<li><a href="../103748/index.html">Office Campaign Monitor</a></li>
<li><a href="../103755/index.html">10.62 RC2</a></li>
<li><a href="../103758/index.html">Google Scribe - Your Personal Scribe</a></li>
<li><a href="../103759/index.html">Model document-oriented database in a relational database</a></li>
<li><a href="../103760/index.html">Proper context capture in javascript</a></li>
<li><a href="../103761/index.html">Jumping Google logo on canvas</a></li>
<li><a href="../103762/index.html">ScrumTrek & AgileRussia, Season Opening - Jam Session with David Hassman 09/20/2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>