<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web scraping on Node.js and problem sites</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second article in a series about creating and using scripts for web-scraping on Node.js. 


1. Web scraping with Node.js 
2. Web scraping ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web scraping on Node.js and problem sites</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/aa6/c13/e2c/aa6c13e2c79e4aefb0fa46d896f7ed86.png" align="right">  This is the second article in a series about creating and using scripts for web-scraping on Node.js. </p><br><ol><li>  <a href="https://habrahabr.ru/post/301426/">Web scraping with Node.js</a> </li><li>  <strong>Web scraping on Node.js and problem sites</strong> </li><li>  <a href="https://habrahabr.ru/post/303726/">Node.js web scraping and bot protection</a> </li><li>  <a href="https://habrahabr.ru/post/304708/">Web scraping updated data with Node.js</a> </li></ol><br><p>  The first article dealt with the simplest problem from the world of web scraping.  In the overwhelming majority of cases, it is these tasks that get to web scraper - retrieving data from unprotected HTML pages of a stable website.  Fast site analysis, HTTP requests using a <a href="https://github.com/tomas/needle">needle</a> (organized with the help of <a href="https://github.com/astur/tress">tress</a> ), recursive passage through links, DOM parsing with the help of <a href="https://github.com/cheeriojs/cheerio">cheerio</a> - that‚Äôs all. </p><br><p>  This article deals with a more complicated case.  Not one of those when you have to give up an order taken with a fight, but one of those that can be disrupted by a beginner scraper.  By the way, this task was contained in a real order on one international freelance exchange, and the first performer failed it. </p><br><p>  The purpose of this article (like the previous one) is to show the whole process of creating and using a script from setting the task to obtaining the final result, but the topics already covered in the first article are covered briefly here, so I recommend starting with the first article.  Here the focus will be on analyzing the site from the point of view of web scraping, identifying pitfalls and ways to circumvent them. </p><a name="habracut"></a><br><h2>  Formulation of the problem </h2><br><p><a href=""><img src="https://habrastorage.org/files/ea1/07e/474/ea107e4749754f809f39aa03c062fb09.png" align="left"></a>  The customer wants a script that will receive data from the markers on the map in one of the sections of a certain site 'LIS Map' (link to the section is attached: ' <a href="http://www.puntolis.it/storelocator/defaultsearch.aspx%3Fidcustomer%3D111">http://www.puntolis.it/storelocator/defaultsearch.aspx?idcustomer=111</a> ') .  It is not necessary to delve into the meaning of the data (anyway, everything is in Italian).  It is enough if the script can take the lines from the markers and save them to a spreadsheet in the columns ' <code>Title</code> ', ' <code>Address</code> ' and ' <code>Place</code> '. </p><br><p>  There are a lot of markers on the site, so they are organized in portions by region and are selected from the drop-down lists in two or three levels.  Markers need everything.  The order is not important. </p><br><p>  It seems that the site has no convenient API.  At least the customer does not know about it and is not noticeable on the site.  So you have to scrap. </p><br><h2>  Site analysis </h2><br><p>  The first bad news is that the entire selection and display of data on the site occurs dynamically on the same page.  It looks like this: when updating, a drop-down list is shown, after selecting an item, another drop-down list (and sometimes another one after it), and then a map of the selected region appears. </p><br><p>  Finding words from markers in the source text of the page gives nothing.  Search for words from the drop-down lists - too.  Already at this stage it may seem that the site can only be scraped with tools like <a href="http://phantomjs.org/">PhantomJS</a> or <a href="http://www.seleniumhq.org/projects/webdriver/">Selenium WD</a> , but it‚Äôs too early to despair.  Most likely, the data is either contained in one of the connected scripts, or loaded dynamically.  In any case, they can be found on the Network tab in <a href="https://developer.chrome.com/devtools">Chrome DevTools</a> or in a similar tool in another browser. </p><br><p>  From the very beginning, along with the HTML of our landing page, static is loaded (images, CSS, a couple of scripts), and several requests are executed via XMLHttpRequest.  Almost all requests load additional scripts and only one - something else.  His address is: </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//www.puntolis.it/storelocator/buildMenuProv.ashx?CodSer=111</span></span></code> </pre> <br><p>  This is how it looks in the browser (screenshot is clickable): </p><br><p> <a href=""><img src="https://habrastorage.org/files/f37/56d/5c9/f3756d5c9a3b4dd694b02e76ef0a4c4f.png"></a> </p><br><p>  We look at it and see the data for the first drop-down list as a fragment of HTML.  Each item in the list (apparently it is called ' <em>Provincia</em> ') is represented by a fragment of this type: </p><br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">'AG'</span></span> id=<span class="hljs-string"><span class="hljs-string">'Agrigento'</span></span>&gt;Agrigento&lt;/<span class="hljs-keyword"><span class="hljs-keyword">option</span></span>&gt;</code> </pre> <br><p>  Clear the Network tab and select one of the list items.  Another XHR request is sent to the following address: </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//www.puntolis.it/storelocator/buildMenuLoc.ashx?CodSer=111&amp;ProvSel=AG</span></span></code> </pre> <br><p>  This is how it looks in the browser (screenshot is clickable): </p><br><p> <a href=""><img src="https://habrastorage.org/files/dc0/72d/373/dc072d3730e6472387547aa4560f0eb8.png"></a> </p><br><p>  The letters AG at the end of the address are the Agrigento province code from the previous list.  Just in case, you can try with other provinces and make sure that this is how it works.  In response to the request comes a fragment of HTML with the contents of the second drop-down list (it looks like this is called ' <em>Comune</em> ').  Each item is represented here by this fragment: </p><br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">'X084001Agrigento'</span></span> id=<span class="hljs-string"><span class="hljs-string">'084001'</span></span>&gt;Agrigento&lt;/<span class="hljs-keyword"><span class="hljs-keyword">option</span></span>&gt;</code> </pre> <br><p>  Select an item from the second list and a map appears on the page with markers whose data come in the form of XML in response to another XHR request here at this address: </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//www.puntolis.it/storelocator/Result.aspx?provincia=AG&amp;localita=084001&amp;cap=XXXXX&amp;Servizio=111</span></span></code> </pre> <br><p>  This is how it looks in the browser (screenshot is clickable): </p><br><p> <a href=""><img src="https://habrastorage.org/files/254/aa6/e8d/254aa6e8d4164f29865145110a167d6a.png"></a> </p><br><p>  Looking at this address, it is easy to notice in it the letter code of the province of Agrigento (AG) and the numerical identifier of the commune of Agrigento (084001).  Now we have all the address patterns to get a list of markers, each of which will be represented by this fragment: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">marker</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id_pv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PA1150"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">INSEGNA</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CASULA GERLANDA "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">INDIRIZZO</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"VIA DANTE ALIGHIERI 14"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CAP</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"92100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PROVINCIA</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AG"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">LOCALITA</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AGRIGENTO "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TELEFONO</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TELEFONO2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FAX</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">EMAIL</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"annacasula1970@libero.it"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"37.3088220"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"13.5788890"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CODSER</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"101,102,103,104,105,106,107,109,110,111,112,113,114,201,202,203,204,210,220,240,250,260,261,270,290,301,302,303,306,401,402"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  The fields we need are in the marker data, albeit in pieces. </p><br><p>  ( <em>It is worth mentioning that on some sites the data can be encrypted, and then it is almost impossible to find them by simply searching for characteristic words. Fortunately, this happens very rarely. Everything is simpler on our site.</em> ) </p><br><p>  Now we recall that for some provinces, the site does not give out two, but three levels of drop-down lists.  In the data request after the second list, not the digital identifier of the commune is substituted, but its name, address is slightly different, and the answer is not a list of markers, but items of the third list. </p><br><p>  This is how it looks in the browser (screenshot is clickable): </p><br><p> <a href=""><img src="https://habrastorage.org/files/af6/076/88c/af607688c04a4036a08be516077a35cd.png"></a> </p><br><p>  It may seem that we will have to handle different provinces in different ways, but before you get upset you should check everything out.  If we manually substitute the necessary data into the template, we get a list of all the markers, for example, for the Tivoli commune in the province of Roma: </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//www.puntolis.it/storelocator/Result.aspx?provincia=RM&amp;localita=058104&amp;cap=XXXXX&amp;Servizio=111</span></span></code> </pre> <br><p>  So you can forget about the third level.  Apparently, the webmaster of our site was also too lazy to process requests for different provinces in different ways and just screwed the third level over the original two-level interface.  Such crutches are often encountered, and if you check them, you can save time and cool the script. </p><br><h2>  Retrieving Pages </h2><br><p>  Using the http-client in the script in some detail versed in the first article.  Here it is worth staying at only one moment. </p><br><p>  The addresses we found can be opened in the browser and see their contents (HTML or XML, respectively), but only if the browser already has cookies installed from the main page of the section (link from the task).  In the case of curl and with the http-client in the script, the situation is the same.  This is the most primitive protection against bots, but it will have to take into account.  This is the second bad news.  At the very beginning, you must execute a request to the main page, save the received cookies and pass them along with each subsequent request. </p><br><h2>  Crawling </h2><br><p>  We have four types of URLs with which we will work: </p><br><ol><li>  Main page (only needed to get cookies) </li><li>  List of provinces (we will begin with it) </li><li>  Community List Template </li><li>  Marker list template </li></ol><br><p>  Addresses based on lists will be added to the queue, and the data from the markers will be stored in an array.  The whole crawling will look something like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tress = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'tress'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needle = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'needle'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   (  ): var sCookie = 'http://www.puntolis.it/storelocator/defaultsearch.aspx?idcustomer=111'; //  URL.  : var sProv = 'http://www.puntolis.it/storelocator/buildMenuProv.ashx?CodSer=111'; //       (    %s): var sLoc = 'http://www.puntolis.it/storelocator/buildMenuLoc.ashx?CodSer=111&amp;ProvSel=%s'; //    (      %s): var sMarker = 'http://www.puntolis.it/storelocator/Result.aspx?provincia=%s&amp;localita=%s&amp;cap=XXXXX&amp;Servizio=111'; var httpOptions = {}; var results = []; //    var q = tress(crawl); q.drain = function(){ fs.writeFileSync('./data.json', JSON.stringify(results, null, 4)); } //  needle.get(sCookie, function(err, res){ if (err || res.statusCode !== 200) throw err || res.statusCode; //   httpOptions.cookies = res.cookies; //   q.push(sProv); }); function crawl(url, callback){ needle.get(url, httpOptions, function(err, res){ if (err || res.statusCode !== 200) throw err || res.statusCode; //    callback(); }); }</span></span></code> </pre> <br><p>  In fact, everything looks like crawling from the previous article, only the installation of cookies is added by a separate request, the task handler is moved to a separate function, and the response code is checked in error handling. </p><br><div class="spoiler">  <b class="spoiler_title">A few words about saving to a spreadsheet</b> <div class="spoiler_text"><p>  Usually, if a customer asks to save data in Excel, <a href="https://ru.wikipedia.org/wiki/CSV">CSV</a> will be enough for him.  Sometimes you can even agree on JSON (the benefit of free online converters is enough).  But if the customer basically needs the xlsx file, you can use, for example, the <a href="https://github.com/astur/excelize">excelize</a> module or another similar wrapper.  For example: </p><br><pre> <code class="javascript hljs">q.drain = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'excelize'</span></span>)(results, <span class="hljs-string"><span class="hljs-string">'./'</span></span>, <span class="hljs-string"><span class="hljs-string">'ADDR.xlsx'</span></span>, <span class="hljs-string"><span class="hljs-string">'sheet'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(results.length + <span class="hljs-string"><span class="hljs-string">' adresses saved.'</span></span>); }); }</code> </pre> </div></div><br><h2>  Parsing </h2><br><p>  Parsing well-organized HTML / XML chunks is much easier than cluttered pages, so everyone who figured out the parsing in the previous article should have this obvious without explanation.  The block of parsing code will look like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $ = cheerio.load(res.body); $(<span class="hljs-string"><span class="hljs-string">'#TendinaProv option'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">1</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ q.push(sLoc.replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'value'</span></span>))); }); $(<span class="hljs-string"><span class="hljs-string">'select[onchange="onLocSelect()"] option'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">1</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ q.push(sMarker.replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, url.slice(<span class="hljs-number"><span class="hljs-number">-2</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'id'</span></span>))); }); $(<span class="hljs-string"><span class="hljs-string">'marker'</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ results.push({ <span class="hljs-attr"><span class="hljs-attr">Title</span></span>: $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'insegna'</span></span>).trim(), <span class="hljs-attr"><span class="hljs-attr">Address</span></span>: $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'indirizzo'</span></span>).trim(), <span class="hljs-attr"><span class="hljs-attr">Place</span></span>: [ $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'cap'</span></span>).trim(), $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'localita'</span></span>).trim(), $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'provincia'</span></span>).trim() ].join(<span class="hljs-string"><span class="hljs-string">' '</span></span>) }); });</code> </pre> <br><p>  Especially it is worth paying attention to the <code>slice</code> method from <code>cheerio</code> .  It works in exactly the same way as the same-name method for arrays.  Specifically, here it is used before <code>each</code> to remove from the selections of the list items the first item that does not carry any useful information.  But this is not something that makes the <code>slice</code> method worth knowing to every scraper using <code>cheerio</code> .  The main thing is that when testing the scraping of sites with large samples, you can call <code>slice(0,5)</code> (well, or <code>slice(1,5)</code> in our case) before calling the each method to reduce the sample to acceptable sizes.  Scrapping will work completely in combat mode, but not for so long. </p><br><p>  ( <strong>Important note</strong> : <em>if you try to scrap the LIS Map, be sure to use <code>slice</code> . Habraeffect kills.</em> ) </p><br><h2>  Indication </h2><br><p>  There are at least two reasons not to neglect the indication here, as it was done last time. </p><br><p>  Firstly, the LIS Map site is much less stable than Ferra.ru, so at the stage of the script‚Äôs launch launches it will be great to see what is happening. </p><br><p>  Secondly, this time the customer does not want ready data, but a workable script that he can manually launch as needed.  It is unlikely that the customer will like to be bored over and over again, looking at the frozen cursor in the terminal window and trying to guess how much time has passed, how much work has been completed during this time and is everything normal with this work.  But he doesn't want to dig into long log files either, so heaped-up loggers like <a href="https://github.com/ajsharp/bunyan">bunyan</a> or <a href="https://github.com/winstonjs/winston">winston</a> will be a redundant solution here.  He will need something simpler and more visual: a console indicator of progress, combined with an extremely laconic console logger reporting the most basic events. </p><br><p>  Since the final amount of work is almost never known when web-scrapping (for recursive passage through links and so on), the standard progress indicator in the form of a filling bar will not work here.  It is better to make a counter of completed tasks (a line with ‚Äúrunning‚Äù numbers).  You will also need to output various types of messages to the terminal, which will not overwrite the counter.  Messages would be well accompanied by automatic time stamps. </p><br><p>  It is for such tasks that the <a href="https://github.com/astur/cllc">cllc</a> module (Command line logger and counter) is created.  With it, you can display a line with counters, and display messages. </p><br><p><img src="https://habrastorage.org/files/fdf/7f8/feb/fdf7f8feb92444709727033f02fa535a.png"></p><br><p>  We need the following features of the <code>cllc</code> module: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cllc'</span></span>)(); log(<span class="hljs-string"><span class="hljs-string">'Message'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    log.e('Error message'); //       &lt;ERROR&gt; //     : log.start('  %s,   %s,   %s.'); log.step(); //     1. ( ,   log.step(1)) log.step(0, 1); //     1. log.step(0, 0, 1); //     1. log.finish(); //  .</span></span></code> </pre> <br><p>  Between calls to <code>log.start</code> and <code>log.finish</code> all messages will be displayed above the indicator without overwriting anything.  All messages are accompanied by timestamps. </p><br><div class="spoiler">  <b class="spoiler_title">Full script code with indication using `cllc`</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cllc'</span></span>)(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tress = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'tress'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> needle = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'needle'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cheerio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cheerio'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sCookie = <span class="hljs-string"><span class="hljs-string">'http://www.puntolis.it/storelocator/defaultsearch.aspx?idcustomer=111'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sProv = <span class="hljs-string"><span class="hljs-string">'http://www.puntolis.it/storelocator/buildMenuProv.ashx?CodSer=111'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sLoc = <span class="hljs-string"><span class="hljs-string">'http://www.puntolis.it/storelocator/buildMenuLoc.ashx?CodSer=111&amp;ProvSel=%s'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sMarker = <span class="hljs-string"><span class="hljs-string">'http://www.puntolis.it/storelocator/Result.aspx?provincia=%s&amp;localita=%s&amp;cap=XXXXX&amp;Servizio=111'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpOptions = {}; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = tress(crawl); q.drain = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ fs.writeFileSync(<span class="hljs-string"><span class="hljs-string">'./data.json'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(results, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)); log.finish(); log(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } needle.get(sCookie, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err || res.statusCode !== <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err || res.statusCode; httpOptions.cookies = res.cookies; log(<span class="hljs-string"><span class="hljs-string">' '</span></span>); log.start(<span class="hljs-string"><span class="hljs-string">'  %s,   %s,   %s.'</span></span>); q.push(sProv); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crawl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, callback</span></span></span><span class="hljs-function">)</span></span>{ needle.get(url, httpOptions, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err || res.statusCode !== <span class="hljs-number"><span class="hljs-number">200</span></span>) { log.e((err || res.statusCode) + <span class="hljs-string"><span class="hljs-string">' - '</span></span> + url); log.finish(); process.exit(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $ = cheerio.load(res.body); $(<span class="hljs-string"><span class="hljs-string">'#TendinaProv option'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">1</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ q.push(sLoc.replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'value'</span></span>))); log.step(); }); $(<span class="hljs-string"><span class="hljs-string">'select[onchange="onLocSelect()"] option'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">1</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ q.push(sMarker.replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, url.slice(<span class="hljs-number"><span class="hljs-number">-2</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'%s'</span></span>, $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'id'</span></span>))); log.step(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); }); $(<span class="hljs-string"><span class="hljs-string">'marker'</span></span>).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ results.push({ <span class="hljs-attr"><span class="hljs-attr">Title</span></span>: $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'insegna'</span></span>).trim(), <span class="hljs-attr"><span class="hljs-attr">Address</span></span>: $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'indirizzo'</span></span>).trim(), <span class="hljs-attr"><span class="hljs-attr">Place</span></span>: [ $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'cap'</span></span>).trim(), $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'localita'</span></span>).trim(), $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).attr(<span class="hljs-string"><span class="hljs-string">'provincia'</span></span>).trim() ].join(<span class="hljs-string"><span class="hljs-string">' '</span></span>) }); log.step(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); }); callback(); }); }</code> </pre> </div></div><br><p>  Run the script and see on the indicator that everything works.  The script finds 110 provinces and 5116 communes, and then begins to collect markers.  But it quickly crashes with a <code>socket hang up</code> error.  When restarting, the error comes out immediately, even at the initialization stage.  In the browser at this time, an error page is displayed with the code 500. </p><br><p><img src="https://habrastorage.org/files/a77/e36/d92/a77e36d92ca04aaa929daa6f591ee1bf.png"></p><br><p>  The error page states that a possible reason is that the allowed number of connections is exceeded.  This refers to connections to the database, and not via http.  Simply put, setting the <code>connection: 'Keep-Alive'</code> in the <code>needle</code> does not help us.  The same page is issued in a different browser and on a different IP (that is, it is not a lock and the proxy will not help).  Thus, the site is within about 20-30 minutes, as lucky.  Then the situation repeats.  As you probably guessed, this is the third bad news. </p><br><h2>  Error processing </h2><br><p>  The worst thing with such sites is that their scrapping is difficult to test.  It is necessary to run the script with the wrong parameter - and you will have to wait more than 20 minutes to try again.  Without indication, it would be quite sad, and in just a few launches we can determine that the site drops every time after three with a few saved markers.  After playing a little with the counters, it can be established that we are talking about about a hundred and fifty communes.  This means that if our script does not terminate after an error, but waits until the site rises and continues, it will stop more than 30 times.  That is, the work of the script will take 10-15 hours. </p><br><p>  Not the fact that this option will suit the customer.  Perhaps he would prefer to close the order by paying for the time already spent.  However, before you grieve the customer is to check another option. </p><br><p>  It is possible that we too often bomb the site with queries.  It is worth trying to establish a delay between requests and see what happens.  Technically, this is very easy to do, we don‚Äôt even have to write anything.  The <code>tress</code> module has a <code>concurrency</code> property, familiar to <a href="https://github.com/caolan/async">async.queue</a> users.  This property is set when creating the queue with the second parameter (by default, <code>concurrency</code> is 1) and indicates how many parallel threads the tasks will be processed.  Only <code>tress</code> <code>concurrency</code> can have negative values, meaning that there should be a delay between tasks in a single thread.  For example, if you set concurrency to -1000, this would mean a delay of 1000 milliseconds.  The <code>async.queue</code> interface is sacrificed for compatibility with <code>async.queue</code> , but if you know, everything is simple. </p><br><p>  It remains to decide what should be the delay.  Simple calculations show that with a delay of 10 seconds, our 5227 queries (1 list of provinces, 110 lists of communes and 5116 lists of markers) will take more than 14 hours.  That is, even if during this time the site does not fall - in time we won‚Äôt win anything.  On the other hand, even 100 milliseconds in the http world is quite a noticeable delay.  First, let's try to set a delay of 1 second. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = tress(crawl, <span class="hljs-number"><span class="hljs-number">-1000</span></span>);</code> </pre> <br><p>  Nothing has changed, the site is still falling after three with a little found markers.  To clear your conscience, try a delay of 3 seconds. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = tress(crawl, <span class="hljs-number"><span class="hljs-number">-3000</span></span>);</code> </pre> <br><p>  The site falls after the first seven hundred markers.  It would be possible to continue experimenting with more delays, but firstly there won't be any cardinal winnings anymore, and secondly, we cannot guarantee that the site will not fall down.  Thus, we have only one working option left - in case of an error, return the task to the queue, put the entire queue on pause, and then resume scrapping until the next error, and so - 10-20 hours. </p><br><p>  Here at this stage, you can ask the customer whether such a slow script will suit him, given that no one will do it much faster.  Here we will proceed from the assumption that the customer has agreed. </p><br><p>  So, we need to make sure that if the http request fails, the corresponding address is returned to the queue, and the queue itself is paused for the specified time.  All this is perfectly implemented by the standard features of the <code>tress</code> module, which distinguishes it from <code>async.queue</code> . </p><br><p>  In the tress queue, any task is in one of four states: </p><br><ol><li>  Awaiting execution </li><li>  Performed </li><li>  Successfully completed </li><li>  Recognized impracticable </li></ol><br><p>  All these tasks are presented to the developer in the form of four arrays that are accessible by the q.waiting, q.active, q.finished and q.failed properties.  During any debugging experiments, the contents of these arrays can even be changed live, but you shouldn‚Äôt do this in working scripts.  And there is no need for such hacking, because everything happens automatically.  When the task is passed to the handler, it is transferred from the waiting array to the active array, where it remains until the callback is called.  After calling the callback, the task is transferred from active to one of the three remaining arrays.  Which one depends on the parameters of the callback: </p><br><ul><li>  If the callback is called without parameters or if the first parameter is null, the task is considered completed and placed in the finished array. </li><li>  If the first callback parameter is of type boolean, then the task is returned for reprocessing and placed at the beginning of the queue (beginning of the waiting array), if the parameter is true, or at the end of the queue (end of the waiting array), if the parameter is false. </li><li>  If the first callback parameter is an error object (instanceof Error), then the task is moved to the failed array. </li><li>  For any other values ‚Äã‚Äãof the first callback parameter, the behavior of the module is undefined and may change in subsequent versions (so it is better not necessary). </li></ul><br><p>  After moving the task from active to another array, tress calls one of the three handlers: q.success, q.retry or q.error, respectively.  It is important that in single-threaded mode (concurrency &lt;= 1) the execution of the handler is completed before the next task starts.  This allows us to do the following: </p><br><p>  Handling an error request will do so: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crawl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, callback</span></span></span><span class="hljs-function">)</span></span>{ needle.get(url, httpOptions, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err || res.statusCode !== <span class="hljs-number"><span class="hljs-number">200</span></span>) { log.e((err || res.statusCode) + <span class="hljs-string"><span class="hljs-string">' - '</span></span> + url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  url    } //  callback(); }); }</span></span></code> </pre> <br><p>  And add, for example, such a q.retry handler: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = tress(crawl); q.retry = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ q.pause(); <span class="hljs-comment"><span class="hljs-comment">//  this     . log.i('Paused on:', this); setTimeout(function(){ q.resume(); log.i('Resumed'); }, 300000); // 5  }</span></span></code> </pre> <br><p>  This script successfully completes the scrapping in 14 hours, as expected. </p><br><p>  I put the delay on 5 minutes.  If the site has not yet woken up, the error just fell out again, and if you woke up, you will not have to wait in vain.     ,     ,                . </p><br><p>    ‚Äì      (  concurrency).   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = tress(crawl); q.success = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ q.concurrency = <span class="hljs-number"><span class="hljs-number">1</span></span>; } q.retry = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ q.concurrency = <span class="hljs-number"><span class="hljs-number">-300000</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 5  }</span></span></code> </pre> <br><h2>  Conclusion </h2><br><p>        (  <a href="https://gist.github.com/astur/72851127746c0570782e76dfc8a9e07c">    gist</a> ).          ,        node-  Windows,     . </p><br><p>  ,       ,         (.   )   .      ,      .       -            ,      http-  - . </p><br><p>   ,            (,  Ctrl-C,    ),           .   -        ,     ,  14  ‚Äì    ,        ‚Äì  .       ‚Äì   ,   .          . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302766/">https://habr.com/ru/post/302766/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302752/index.html">Humane VimScript: Editor Initialization</a></li>
<li><a href="../302754/index.html">SGI, HPE and Fujitsu super servers with 24-core Xeon E7 v4 processors ‚Äî and how do we curb this hardware?</a></li>
<li><a href="../302756/index.html">xfcRS - original laconic, nimble rendering of smoothed tiles, "expansion fast cell - Rounded Squares"</a></li>
<li><a href="../302760/index.html">As we did the centralized data storage for the retail network and optimized it step by step.</a></li>
<li><a href="../302764/index.html">What is mobile-first for? Mobile leaders meet</a></li>
<li><a href="../302768/index.html">Basic differences when working with MySQL and PostgreSQL databases Amateurish overview</a></li>
<li><a href="../302770/index.html">About the new features of SQL Server 2016</a></li>
<li><a href="../302772/index.html">Front-door VRF. Another practical example</a></li>
<li><a href="../302774/index.html">Will OpenStack be a ‚Äúnew LAMP‚Äù?</a></li>
<li><a href="../302776/index.html">C / C ++ compiler based on LLVM for multicellular processors: to be or not to be?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>