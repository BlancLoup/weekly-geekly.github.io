<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FlashMapper is an alternative to auto-mapper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do not even know what an auto-chopper is. Why do I need his alternative? 
 Imagine the situation, you have two classes for the same entity, one desc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FlashMapper is an alternative to auto-mapper</h1><div class="post__text post__text-html js-mediator-article"><h4>  I do not even know what an auto-chopper is.  Why do I need his alternative? </h4><br>  Imagine the situation, you have two classes for the same entity, one describes the data model from a custom form, the second database model.  The properties of these classes coincide by 95 percent, the differences can only be in some timestamps or other system fields in the database model.  When a user fills out a form, you get a model from that form, and then you need to convert it to a database model to save. <br><br>  <b>FlashMapper</b> , like AutoMapper, is a .net library that saves you from writing routine code during the conversion process.  It automatically matches all the same class properties, leaving you only to resolve differences. <br><br>  In addition to getting rid of routine work, this approach provides additional verification of the correctness of the code of your program.  Imagine that you have added some new properties to these classes, and forgot to link them.  At best, you will find out about this somewhere at the testing stage, at worst a month after the release, when you notice that you don‚Äôt have new data in the database that users diligently enter into a new field on the form.  FlashMapper will either bind new properties automatically if it can, or throw an exception during the next application launch. <br><a name="habracut"></a><br><h4>  If there is already an avtomapper, then why make another similar library? </h4><br>  In the auto-mapper, I never liked his monstrous syntax.  Just to connect two properties in different classes, you need to register three lambdas in the configuration in order to ignore the property - two.  Also, at the last job, I often began to have a need to 'grease' the data from two classes into one.  I did not find a simple solution to this problem by using standard auto-mapper tools, so I started writing an extension library for it that allows you to create mappings from two or more source classes into one, and even almost added it.  But then I suddenly had the idea of ‚Äã‚Äãa simpler syntax, and I decided to drop everything and write my library from scratch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Actually, FlashMapper has a simpler and more user-friendly syntax, provides the ability to 'map' from several objects to one, and also provides an API for making each separate separate mapping configuration into its own class, into which you can forward some logic as a dependency constructor  Also, according to the idea, it should have had better performance, but for some reasons, which are lower, the performance turned out to be at the level of the auto-amp. <br><br><h4>  Syntax </h4><br>  Imagine that we have two classes, one defines the data model that comes to the server from a custom form, the second defines the storage model in the database. <br><br><div class="spoiler">  <b class="spoiler_title">Model with custom form</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserForm</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid? Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Town { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime BirthDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Login { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Database model</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserDb</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Guid Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Town { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime BirthDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Login { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PasswordHash { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime RegistrationTime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] Timestamp { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsDeleted { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br></div></div><br>  Then this is how the mapping configuration will look from first class to second: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FlashMapperInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">IInitializer</span></span> <span class="hljs-comment"><span class="hljs-comment">//    FlashMapper' { private readonly IMappingConfiguration mappingConfiguration; //  ,       private readonly IPasswordHashCalculator passwordHashCalculator; public FlashMapperInitializer(IMappingConfiguration mappingConfiguration, IPasswordHashCalculator passwordHashCalculator) { this.mappingConfiguration = mappingConfiguration; } public void Init() // ,       { mappingConfiguration.CreateMapping&lt;UserForm, UserDb&gt;(u =&gt; new UserDb { Id = u.Id ?? Guid.NewGuid(), Login = u.Id.HasValue ? MappingOptions.Ignore() : u.Login, RegistrationTime = u.Id.HasValue ? MappingOptions.Ignore() : DateTime.Now, Timestamp = MappingOptions.Ignore&lt;byte[]&gt;(), IsDeleted = false, PasswordHash = passwordHashCalculator.Calculate(u.Password) }); //mappingConfiguration.CreateMapping &lt;...&gt; (...); //   } }</span></span></code> </pre><br>  The syntax resembles the creation of a new object and the initialization of its properties based on the source object.  In fact, the parameter of the CreateMapping method is a lambda expression, which is then supplemented by matching the remaining properties of the UserDb class with similar properties from the UserForm class.  Also, on the basis of this expression, another one is created that does not create a new object of type UserDb, but simply copies the data into an already existing object.  Both expressions are compiled and saved in mappingConfiguration for further use. <br><br>  Here's how you can then use the created mapping: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IMappingConfiguration mappingConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IRepository&lt;UserDb&gt; usersRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IMappingConfiguration mappingConfiguration, IRepository&lt;UserDb&gt; usersRepository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mappingConfiguration = mappingConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.usersRepository = usersRepository; } [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Edit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UserForm model</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ModelState.IsValid) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> existingUser = usersRepository.Find(model.Id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existingUser == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = mappingConfiguration.Convert(model).To&lt;UserDb&gt;(); usersRepository.Add(newUser); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mappingConfiguration.MapData(model, existingUser); usersRepository.Update(existingUser); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); } }</code> </pre><br><h4>  Mapping from multiple sources </h4><br>  FlashMapper allows you to create multi-source mappings (up to 15): <br><br><pre> <code class="cs hljs">mappingConfiguration.CreateMapping&lt;Source1, Source2, Source3, Destination&gt;((s1, s2, s3) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Destination { ... });</code> </pre><br>  In this case, when automatically matching properties, suitable ones will be searched for in each source.  If this property is found in several sources, FlashMapper will throw an exception that a collision has occurred.  To prevent this from happening, you must either manually specify from which source the property to be taken, or specify CollisionBehavior = ChooseAny in the mapping settings. <br><br><pre> <code class="cs hljs">mappingConfiguration.CreateMapping&lt;Source1, Source2, Source3, Destination&gt;((s1, s2, s3) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Destination { ... }, o =&gt; o.CollisionBehavior(SelectSourceCollisionBehavior.ChooseAny));</code> </pre><br>  Although this behavior is called ChooseAny, the appropriate property will not be chosen randomly, the priority depends on the source sequence number.  The first will have maximum priority, the second, third, and so on. <br><br><h4>  API for making each mapping in a separate service </h4><br>  FlashMapper provides a set of interfaces and base classes for the configuration of each mapping in a separate class.  This approach allows you to better structure the code, all configurations are not in the same method with initialization, but each in its own service.  In the service, you can forward dependencies through the constructor, and thanks to this, you can use complex business logic inside the mapping. <br><br>  Here is how the configuration of the mapping from the example above changes: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IUserDbBuilder</span></span> : <span class="hljs-title"><span class="hljs-title">IBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">UserForm</span></span>, <span class="hljs-title"><span class="hljs-title">UserDb</span></span>&gt; { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserDbBuilder</span></span> : <span class="hljs-title"><span class="hljs-title">FlashMapperBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">UserForm</span></span>, <span class="hljs-title"><span class="hljs-title">UserDb</span></span>, <span class="hljs-title"><span class="hljs-title">UserDbBuilder</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IUserDbBuilder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IPasswordHashCalculator passwordHashCalculator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserDbBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IMappingConfiguration mappingConfiguration, IPasswordHashCalculator passwordHashCalculator</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mappingConfiguration</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.passwordHashCalculator = passwordHashCalculator; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureMapping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IFlashMapperBuilderConfigurator&lt;UserForm, UserDb&gt; configurator</span></span></span><span class="hljs-function">)</span></span> { configurator.CreateMapping(u =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserDb { Id = u.Id ?? Guid.NewGuid(), Login = u.Id.HasValue ? MappingOptions.Ignore() : u.Login, RegistrationTime = u.Id.HasValue ? MappingOptions.Ignore() : DateTime.Now, Timestamp = MappingOptions.Ignore&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;(), IsDeleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, PasswordHash = passwordHashCalculator.Calculate(u.Password) }); } }</code> </pre><br>  The IUserDbBuilder interface has two methods - UserDb Build (UserForm source) and void MapData (UserForm source, UserDb destination).  The base class FlashMapperBuilder &lt;UserForm, UserDb, UserDbBuilder&gt; implements them, but leaves the void ConfigureMapping method for implementation (IFlashMapperBuilderConfigurator &lt;UserForm, UserDb&gt; configurator).  This method is called during initialization and creates a mapping in the passed mappingConfiguration.  Notice that the latest generic parameter of the abstract class FlashMapperBuilder should be its implementation, in this case UserDbBuilder. <br><br>  Consider the configuration process in more detail.  The base class FlashMapperBuilder &lt;&gt; also implements the IFlashMapperBuilder interface, which in turn provides the RegisterMapping method, which must be called during application initialization.  As a result, the UserDbBuilder implementation must be registered in the IoC container for two interfaces - IUserDbBuilder for future use, and IFlashMapperBuilder for registration of the mapping. <br><br><div class="spoiler">  <b class="spoiler_title">Something for Ninject</b> <div class="spoiler_text"><pre> <code class="cs hljs">Kernel.Bind&lt;IUserDbBuilder, IFlashMapperBuilder&gt;().To&lt;UserDbBuilder&gt;();</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">To simplify this syntax, I use a small extension-method.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IBindingWhenInNamedWithOrOnSyntax&lt;T&gt; AsFlashMapperBuilder&lt;T&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IBindingWhenInNamedWithOrOnSyntax&lt;T&gt; builder) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : IFlashMapperBuilder { builder.Kernel.AddBinding(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IFlashMapperBuilder), builder.BindingConfiguration)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder; }</code> </pre><br>  As a result, the registration of the builder in the container can be rewritten as: <br><pre> <code class="cs hljs">Kernel.Bind&lt;IUserDbBuilder&gt;().To&lt;UserDbBuilder&gt;().AsFlashMapperBuilder();</code> </pre><br></div></div><br>  The library has an IFlashMapperBuildersRegistrationService service, with the RegisterAllBuilders method; this method should be called during application initialization.  The service simply takes all the implementations of the IFlashMapperBuilder interface, which are passed to it to the constructor, and calls the RegisterMappings method. <br><br><div class="spoiler">  <b class="spoiler_title">Here is an example of using the service IUserDbBuilder</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IUserDbBuilder userDbBuilder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IRepository&lt;UserDb&gt; usersRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IUserDbBuilder userDbBuilder, IRepository&lt;UserDb&gt; usersRepository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userDbBuilder = userDbBuilder; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.usersRepository = usersRepository; } [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Edit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UserForm model</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ModelState.IsValid) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> existingUser = usersRepository.Find(model.Id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existingUser == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = userDbBuilder.Build(model); usersRepository.Add(newUser); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { userDbBuilder.MapData(model, existingUser); usersRepository.Update(existingUser); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); } }</code> </pre><br></div></div><br>  In theory, there should be one problem.  Let's look at the ConfigureMapping method from the configuration example.  The lambda expression that describes the mapping uses the class field - passwordHashCalculator.  In general, lambda expressions, like the methods resulting from their compilation, are always static.  But when inside an expression you refer to some non-static class member (field, property, method), the current instance of the class that creates the expression is passed to it as a constant, and then the value of the fields of this instance is used.  It turns out that the instance of the builder that was used to register the mapping will get into the mapping expression, and the values ‚Äã‚Äãof its fields will always be used. <br><br>  To prevent this from happening, the expression passed to the CreateMapping method is modified.  One more parameter is added to it - the builder itself, and all calls to the current instance of the builder are replaced with a call to this parameter.  The result is mapping from two parameters, the first is the data itself, the second is the builder.  When the build method is later called by the builder, it takes this mapping and passes the data and itself as parameters. <br><br>  It is because of this that the latest generic parameter of the FlashMapperBuilder class should be the builder itself.  Of course, it would be possible to calculate this type during runtime as well, but I wanted to avoid any late binding using ready-made compiled mappings. <br><br>  This approach also allows the use of multiple sources, a maximum of 14. <br><br><h4>  Performance </h4><br>  I was never particularly bothered by the performance of the auto-chopper, but from colleagues I heard that it runs 10 times slower than a similar manual mapping.  I then decided that it is smarter than everyone, and I‚Äôll have a performance comparable to manual mapping.  It would seem that when using a ready mapping, I already have a compiled method, the IL-code of which should coincide with the IL-code of the method that performs similar work, but written by hands, there is no late binding when using mapping, you only need to get a pointer to the method and call it.  But in fact, the performance of my mapper turned out to be comparable to the performance of the auto-chopper. <br><br>  I was very surprised, I began to profile the code, my code did not cause any brakes, the main execution time was the compiled mapping method.  I downloaded the dotnet symbols, and launched the profiler again.  It turned out that 72% of the CPU time is occupied by a call to some JIT_MethodAccessCheck method. <br><br>  I started googling what this method generally does.  In the search results, there was a certain jithelpers.h file from the data sheets on the gihab, as well as questions on stackoverflow from people who are also concerned about the performance of compiled lambda expressions.  From stackoverflow, I learned that this method is somehow related to CAS (code access security), and also found another way to compile lambda expressions.  I decided to just blindly use this method, see what the performance will turn out.  And, about a miracle, my method compiled from expression began to work with the same speed, as well as a similar manual method.  But, unfortunately, after that two tests fell through me. <br><br>  Tests on dependency injection broke.  Compressed expressions have no access to the private fields of the class in which they were created.  Moreover, they compiled without errors, the error popped up already at the time of conversion from one class to another.  To be honest, I didn‚Äôt even suspect until this moment that I‚Äôm checking at runtime each time whether a given piece of compiled code has access to one or another member of a class. <br><br>  I began to understand what was happening.  The way to compile lambda expressions that have been advised on stackoverflow uses the older and lower-level API of the dotnet to generate IL code.  These are the classes MethodBuilder, TypeBuilder and others.  It was necessary to create them manually, define the parameters, transfer the MethodBuilder instance to the lambda expression method CompileToMethod.  This method wrote down the IL-code directly of what was in the expression, so the resulting method worked quickly.  After that, it was necessary to create a dynamic type from an instance of a TypeBuilder class, and to pull out of it the necessary method by reflection.  It is clear that since I create a new type and the method is already defined in it, the method loses access to the private fields of the class in which the lambda expression was defined.  The standard way to compile lambda expressions is a simple call to the Compile method, this method appeared in later versions of the document, and uses a newer API.  This is the DynamicMethod class.  It does not require hands to create dynamic types and stuff, but simply provides methods for writing IL code into it and getting a result.  Although inside it also creates a new type in the same way, but it can somehow disable the checking of the availability of class members at runtime, it even has a special flag for this in the constructor.  And, apparently, he adds the JIT_ MethodAccessCheck call to the compiled method. <br><br>  I rummaged in the guts of the datnet, tried to circumvent the field availability check in various ways.  For example, I tried to make the class created by TypeBuilder be the nested class of which I need to get access to the fields, I also tried to get access to the fields through reflection, but other problems arose there.  In general, while I could not get to make money with stackoverflow, I rolled everything up to the standard compilation method. <br><br>  In principle, the results are not so bad, FlashMapper, like AutoMapper, works 4 times slower than the manual method.  A million conversions take 400 ms, versus 100 ms for the manual method.  A simple data transfer, when new instances of the resulting class are not created, works slightly faster. <br><br><img src="https://i.imgur.com/SiPeX0I.png" alt="image"><br><br>  Although it is a shame, of course, that the results do not correspond to the name of the library, so I dig out a little more, maybe something will turn out. <br><br><h4>  Conclusion </h4><br>  At the moment, FlashMapper has a certain basic functionality of the authopper, in addition it has a more compact configuration syntax, allows mappings from several objects and has an API for making configurations into separate services. <br><br>  <a href="https://www.nuget.org/packages/FlashMapper/">Main library build</a> <br><br>  <a href="https://www.nuget.org/packages/FlashMapper.MultiSource/">Build with extensions for mapping from multiple sources</a> <br><br>  <a href="https://www.nuget.org/packages/FlashMapper.DependancyInjection/">Building with API for making configurations in services</a> <br><br>  <a href="https://github.com/Birbone/FlashMapper">Github sources</a> <br><br>  <a href="https://github.com/Birbone/FlashMapper/wiki">Documentation</a> </div><p>Source: <a href="https://habr.com/ru/post/338968/">https://habr.com/ru/post/338968/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338952/index.html">Running regular tasks on a cluster or how to make friends with Apache Spark and Oozie</a></li>
<li><a href="../338954/index.html">NetApp ONTAP ‚îÄ we will break it down</a></li>
<li><a href="../338958/index.html">Event digest for HR specialists in the IT field for October 2017</a></li>
<li><a href="../338960/index.html">How I searched (and found!) The bugs in the kickico smartcontract</a></li>
<li><a href="../338966/index.html">Monitoring of engineering infrastructure in the data center. Part 3. Cooling system</a></li>
<li><a href="../338970/index.html">Changed the way to create chat bots in Viber</a></li>
<li><a href="../338974/index.html">National roaming in different countries of the world</a></li>
<li><a href="../338978/index.html">How the AI ‚Äã‚Äãsenses system was created in Thief: The Dark Project</a></li>
<li><a href="../338980/index.html">What is known about the attack on the supply chain CCleaner</a></li>
<li><a href="../338982/index.html">More Apple Surprises: Updated Posting Guidelines on the App Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>