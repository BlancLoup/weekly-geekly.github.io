<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How is the infrastructure of data processing Sports.ru and Tribuna.com?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first post about the analytic system Sports.ru and Tribuna.com, we talked about how we use our infrastructure in everyday life: we fill with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How is the infrastructure of data processing Sports.ru and Tribuna.com?</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/company/sports_ru/blog/212863/">first post</a> about the analytic system Sports.ru and Tribuna.com, we talked about how we use our infrastructure in everyday life: we fill with the content a recommendation system, monitor business metrics, look for diamonds among user content, find answers to the questions ‚ÄúHow does better? ‚Äùand‚Äú Why? ‚Äù, we cut users for mailing lists and build beautiful reports on the company's activities.  We modestly hid the entire technical part of the narration behind this scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/919/ab1/4cd/919ab14cd571aeda61d737690b39fe18.gif" alt="If you are using any other type of external service."><br><br>  Readers legitimately demanded to continue the story <a href="http://habrahabr.ru/company/sports_ru/blog/212863/">with funny cats</a> , and <a href="http://habrahabr.ru/users/olegbunin/" class="user_link">olegbunin</a> invited to tell about everything that was hidden in <a href="http://ritconf.ru/2014/abstracts/1320.html">RHS ++</a> .  Well, we will state some technical details - in the continuation of a fun post. <br><a name="habracut"></a><br><h4>  Storage </h4><br>  As <a href="http://www.sports.ru/">Sports.ru</a> evolved from a news site to a full-fledged social network, new data analysis services (similarweb, appanie, flurry, etc.) were added to familiar analytical tools like Google Analytics and Yandex.Metrica.  In order not to be torn between a dozen different applications and have a common coordinate system for measuring metrics, we decided to collect all traffic data from all our websites, mobile applications and social streams in one repository. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We needed to get a single service for working with different data, which would allow journalists to monitor the popularity of texts and authors, social editorial staff to quickly respond to emerging trends, product managers to evaluate user involvement in our services, to receive experimental results when launching new functionality etc.  We decided to store the collected data in such a way that it was easy to work with them, to be presented in a form convenient for various users: for journalists and for system administrators. <br><br>  What did we need to count?  Attendance of sites and mobile applications, the activity of registered users (comments, ratings, posts, subscriptions, registrations, etc.), the number of subscribers to our streams in social networks, the number of installations of mobile applications.  As the monthly traffic volume approached 250 million hits and continued to grow, we decided not to use conventional relational DBMS, but to choose a technology that could easily scale with the growth of data.  We wanted to have the simplest and most convenient access to the data, for example, in the form of SQL queries.  As a result, we stopped at Redshift SaaS-storage, which was launched in the ecosystem of Amazon Web Services in early 2013. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/020/34c/744/02034c744560a2a30e61629cb4df8708.png" alt="You can manage your Redshift cluster through the web interface.  There is simply no place" title="You can manage your Redshift cluster through the web interface.  There is simply no place"><br><blockquote>  You can manage your Redshift cluster through the web interface.  There is simply no place </blockquote><br>  <a href="http://aws.amazon.com/redshift/">Redshift</a> is a distributed column DBMS with some special features, such as the lack of integrity constraints such as foreign keys or unique field values.  Column DBMS stores records in such a way that queries with groupings and aggregate calculations for a large number of rows work as fast as possible.  In this case, the selection of all fields of a single record by key (select * from table where id = N), as well as the operations of changing or adding one record can take longer to work than in conventional databases.  More information about the device column DBMS can be read in <a href="http://habrahabr.ru/post/95181/">this post</a> . <br><br>  Redshift bribed us with ease of access to data (you can work with it as with ordinary PostgreSQL), ease of scaling (as data grows, new servers are added in a couple of clicks, all data is redistributed automatically) and low implementation costs (compared to, for example, Apache Hadoop + Hive).  At the very beginning, by the way, we thought about our Hadoop cluster, but we abandoned this idea, thus limiting ourselves and losing the possibility of creating personalized Realtime recommendations on our repository, using Apache Mahout, and generally launching some distributed algorithms that cannot describe in SQL.  <s>Not really wanted</s> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c4/0c9/684/0c40c9684ac59c699ca30e29709b91d8.png" alt="Any relational data from a canonical DBMS is easily transferred to the Redshift structure."><br><blockquote>  Any relational data from a canonical DBMS is easily transferred to the Redshift structure. </blockquote><br><h4>  Traffic data collection </h4><br>  To store data about views and events on the pages, we use the client part of the <a href="http://piwik.org/">Piwik</a> open-ended counter, consisting of a javascript tracker and backend on PHP / MySQL, which we threw out as unnecessary.  The counter asynchronously sends requests to servers with Nginx, where they are written to standard logs.  The counter code looks like this: <br><br><pre><code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _paq = _paq || []; _paq.push([<span class="hljs-string"><span class="hljs-string">"enableLinkTracking"</span></span>]); _paq.push([<span class="hljs-string"><span class="hljs-string">"setTrackerUrl"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://stat.sports.ru/p"</span></span>]); _paq.push([<span class="hljs-string"><span class="hljs-string">"setSiteId"</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>]); _paq.push([<span class="hljs-string"><span class="hljs-string">"trackPageView"</span></span>]); (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">w,d,s,u,e,p</span></span></span><span class="hljs-function">)</span></span>{ e=d.createElement(s); e.src=u;e.async=<span class="hljs-number"><span class="hljs-number">1</span></span>; p=d.getElementsByTagName(s)[<span class="hljs-number"><span class="hljs-number">0</span></span>]; p.parentNode.insertBefore(e,p);})(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>,<span class="hljs-string"><span class="hljs-string">'script'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://stat.sports.ru/piwik.js'</span></span>); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><blockquote>  Very similar to GA counter code, isn't it? </blockquote><br>  Requests from the counter contain all the necessary data such as the address of the page, the User-Agent, the Referer, the source of the transition, the dates of the previous visit, the unique visitor ID from the Cookie, and so on.  For each request, a user ID is added (if known), according to which we can combine data on views with data on user activity, which are accumulated in the site database (comments, posts, pros and cons).  In addition, nginx writes to the logs information about the geographic location of the visitor (maxmind + ngx_http_geoip_module). <br><br><pre> <code class="nginx hljs">77.0.155.47 - - [31/Mar/2014:13:00:02 +0400] "<span class="hljs-attribute"><span class="hljs-attribute">GET</span></span> /p?action_name=<span class="hljs-number"><span class="hljs-number">12</span></span>   Sports.ru     -   -  - Sports.ru&amp;idsite=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;rec=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;r=<span class="hljs-number"><span class="hljs-number">878036</span></span>&amp;h=<span class="hljs-number"><span class="hljs-number">13</span></span>&amp;m=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;s=<span class="hljs-number"><span class="hljs-number">54</span></span>&amp;url=http%3A%2F%2Fwww.sports.ru%2Ffootball%2F&amp;_id=4cfacf46947ecc9a&amp;_idts=<span class="hljs-number"><span class="hljs-number">1396089767</span></span>&amp;_idvc=<span class="hljs-number"><span class="hljs-number">7</span></span>&amp;_idn=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_refts=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_viewts=<span class="hljs-number"><span class="hljs-number">1396218890</span></span>&amp;suid=4582d0d1-0b34-<span class="hljs-number"><span class="hljs-number">4208</span></span>-b154-413de9cd40ee&amp;suida=JcHxFVM2AIp2Rdr1C6q0Ag&amp;tsl=<span class="hljs-number"><span class="hljs-number">1396256514</span></span>&amp;pdf=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;qt=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;realp=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;wma=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;dir=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;fla=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;java=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;gears=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;ag=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;cookie=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;res=1920x1080&gt;_ms=<span class="hljs-number"><span class="hljs-number">1072</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">" 200 35 "</span></span>http://www.sports.ru/football/" <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.154 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Grozny"</span></span> <span class="hljs-number"><span class="hljs-number">188.232.174.186</span></span> - - [<span class="hljs-number"><span class="hljs-number">31</span></span>/Mar/<span class="hljs-number"><span class="hljs-number">2014</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /p?action_name=_event&amp;idsite=1&amp;rec=1&amp;r=109951&amp;h=13&amp;m=1&amp;s=53&amp;url=http://www.sports.ru/football/4283301.html&amp;_id=45af8e84654389f1&amp;_idts=1392628066&amp;_idvc=2&amp;_idn=0&amp;_refts=1396256513&amp;_viewts=1392628066&amp;_ref=http://www.sports.ru/&amp;suida=JcHxFVMB0V0b91OfKBpEAg&amp;tsl=1396256513&amp;cvar=%7B%221%22%3A%5B%22Authors-News%22%2C%22%D0%AE%D1%80%D0%B8%D0%B9%20%D0%91%D0%BE%D0%B3%D0%B4%D0%B0%D0%BD%D0%BE%D0%B2%22%5D%7D&amp;pdf=0&amp;qt=0&amp;realp=0&amp;wma=0&amp;dir=0&amp;fla=0&amp;java=0&amp;gears=0&amp;ag=0&amp;cookie=1&amp;res=1280x800&gt;_ms=117 HTTP/1.1"</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.sports.ru/football/159071418.html?ext=yandex"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Zhukovskiy"</span></span></code> % 2Fwww.sports.ru% 2Ffootball% 2F &amp; _id = 4cfacf46947ecc9a &amp; _idts = <code class="nginx hljs">77.0.155.47 - - [31/Mar/2014:13:00:02 +0400] "<span class="hljs-attribute"><span class="hljs-attribute">GET</span></span> /p?action_name=<span class="hljs-number"><span class="hljs-number">12</span></span>   Sports.ru     -   -  - Sports.ru&amp;idsite=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;rec=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;r=<span class="hljs-number"><span class="hljs-number">878036</span></span>&amp;h=<span class="hljs-number"><span class="hljs-number">13</span></span>&amp;m=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;s=<span class="hljs-number"><span class="hljs-number">54</span></span>&amp;url=http%3A%2F%2Fwww.sports.ru%2Ffootball%2F&amp;_id=4cfacf46947ecc9a&amp;_idts=<span class="hljs-number"><span class="hljs-number">1396089767</span></span>&amp;_idvc=<span class="hljs-number"><span class="hljs-number">7</span></span>&amp;_idn=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_refts=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_viewts=<span class="hljs-number"><span class="hljs-number">1396218890</span></span>&amp;suid=4582d0d1-0b34-<span class="hljs-number"><span class="hljs-number">4208</span></span>-b154-413de9cd40ee&amp;suida=JcHxFVM2AIp2Rdr1C6q0Ag&amp;tsl=<span class="hljs-number"><span class="hljs-number">1396256514</span></span>&amp;pdf=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;qt=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;realp=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;wma=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;dir=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;fla=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;java=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;gears=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;ag=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;cookie=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;res=1920x1080&gt;_ms=<span class="hljs-number"><span class="hljs-number">1072</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">" 200 35 "</span></span>http://www.sports.ru/football/" <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.154 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Grozny"</span></span> <span class="hljs-number"><span class="hljs-number">188.232.174.186</span></span> - - [<span class="hljs-number"><span class="hljs-number">31</span></span>/Mar/<span class="hljs-number"><span class="hljs-number">2014</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /p?action_name=_event&amp;idsite=1&amp;rec=1&amp;r=109951&amp;h=13&amp;m=1&amp;s=53&amp;url=http://www.sports.ru/football/4283301.html&amp;_id=45af8e84654389f1&amp;_idts=1392628066&amp;_idvc=2&amp;_idn=0&amp;_refts=1396256513&amp;_viewts=1392628066&amp;_ref=http://www.sports.ru/&amp;suida=JcHxFVMB0V0b91OfKBpEAg&amp;tsl=1396256513&amp;cvar=%7B%221%22%3A%5B%22Authors-News%22%2C%22%D0%AE%D1%80%D0%B8%D0%B9%20%D0%91%D0%BE%D0%B3%D0%B4%D0%B0%D0%BD%D0%BE%D0%B2%22%5D%7D&amp;pdf=0&amp;qt=0&amp;realp=0&amp;wma=0&amp;dir=0&amp;fla=0&amp;java=0&amp;gears=0&amp;ag=0&amp;cookie=1&amp;res=1280x800&gt;_ms=117 HTTP/1.1"</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.sports.ru/football/159071418.html?ext=yandex"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Zhukovskiy"</span></span></code> = JcHxFVM2AIp2Rdr1C6q0Ag &amp; tsl = <code class="nginx hljs">77.0.155.47 - - [31/Mar/2014:13:00:02 +0400] "<span class="hljs-attribute"><span class="hljs-attribute">GET</span></span> /p?action_name=<span class="hljs-number"><span class="hljs-number">12</span></span>   Sports.ru     -   -  - Sports.ru&amp;idsite=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;rec=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;r=<span class="hljs-number"><span class="hljs-number">878036</span></span>&amp;h=<span class="hljs-number"><span class="hljs-number">13</span></span>&amp;m=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;s=<span class="hljs-number"><span class="hljs-number">54</span></span>&amp;url=http%3A%2F%2Fwww.sports.ru%2Ffootball%2F&amp;_id=4cfacf46947ecc9a&amp;_idts=<span class="hljs-number"><span class="hljs-number">1396089767</span></span>&amp;_idvc=<span class="hljs-number"><span class="hljs-number">7</span></span>&amp;_idn=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_refts=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;_viewts=<span class="hljs-number"><span class="hljs-number">1396218890</span></span>&amp;suid=4582d0d1-0b34-<span class="hljs-number"><span class="hljs-number">4208</span></span>-b154-413de9cd40ee&amp;suida=JcHxFVM2AIp2Rdr1C6q0Ag&amp;tsl=<span class="hljs-number"><span class="hljs-number">1396256514</span></span>&amp;pdf=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;qt=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;realp=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;wma=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;dir=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;fla=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;java=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;gears=<span class="hljs-number"><span class="hljs-number">0</span></span>&amp;ag=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;cookie=<span class="hljs-number"><span class="hljs-number">1</span></span>&amp;res=1920x1080&gt;_ms=<span class="hljs-number"><span class="hljs-number">1072</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">" 200 35 "</span></span>http://www.sports.ru/football/" <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.154 Safari/537.36"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Grozny"</span></span> <span class="hljs-number"><span class="hljs-number">188.232.174.186</span></span> - - [<span class="hljs-number"><span class="hljs-number">31</span></span>/Mar/<span class="hljs-number"><span class="hljs-number">2014</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> +<span class="hljs-number"><span class="hljs-number">0400</span></span>] <span class="hljs-string"><span class="hljs-string">"GET /p?action_name=_event&amp;idsite=1&amp;rec=1&amp;r=109951&amp;h=13&amp;m=1&amp;s=53&amp;url=http://www.sports.ru/football/4283301.html&amp;_id=45af8e84654389f1&amp;_idts=1392628066&amp;_idvc=2&amp;_idn=0&amp;_refts=1396256513&amp;_viewts=1392628066&amp;_ref=http://www.sports.ru/&amp;suida=JcHxFVMB0V0b91OfKBpEAg&amp;tsl=1396256513&amp;cvar=%7B%221%22%3A%5B%22Authors-News%22%2C%22%D0%AE%D1%80%D0%B8%D0%B9%20%D0%91%D0%BE%D0%B3%D0%B4%D0%B0%D0%BD%D0%BE%D0%B2%22%5D%7D&amp;pdf=0&amp;qt=0&amp;realp=0&amp;wma=0&amp;dir=0&amp;fla=0&amp;java=0&amp;gears=0&amp;ag=0&amp;cookie=1&amp;res=1280x800&gt;_ms=117 HTTP/1.1"</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.sports.ru/football/159071418.html?ext=yandex"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:27.0) Gecko/20100101 Firefox/27.0"</span></span> <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"RU"</span></span> <span class="hljs-string"><span class="hljs-string">"Zhukovskiy"</span></span></code> </pre><br><blockquote>  From the counter on the backend there are only entries in the nginx access-log </blockquote><br>  To write to Amazon Redshift, the data is converted to a CSV-like form, sent to <a href="http://aws.amazon.com/s3/">Amazon S3</a> , and, if desired, broken up into several parts for fast download.  Parsing the log is done by a simple script that selects the necessary data in one pass (see above) and makes simple transformations, such as translating the User-Agent into a Browser / OS pair. <br><br><pre> <code class="nginx hljs">77.0.155.47|2014-03-31 13:00:02|1|   ,  ,  ,  , , , ,  - Sports.ru|9cfacf46947ecc9a|8582d0d1-0b34-4208-b154-413de9cd40ee|JdHxFVM2AIp2Rdr1C6q0Ag|2014-03-29 14:42:47|7|0|||1970-01-01 04:00:00|2014-03-31 02:32:58|1970-01-01 04:00:00|||||13|1|54|0|0|RU|Grozny|Chrome|33.0.1750|Windows||Other|/football/|/football/ 233.91.249.44|2014-03-31 13:00:02|1| : ¬´      ¬ª -   - Sports.ru|a3e990633872eb74||JcHxFVKB2Z0nhRhOJHMEAg|2014-03-17 07:55:17|12|0|||2014-03-31 13:01:22|2014-03-31 11:08:01|1970-01-01 04:00:00|hideme.ru/||||13|1|52|2|159076870|RO|Bucharest|Firefox|27|<span class="hljs-attribute"><span class="hljs-attribute">Windows</span></span> XP||Other|/others/figure-skating/<span class="hljs-number"><span class="hljs-number">159076870</span></span>.html|/others/figure-skating/<span class="hljs-number"><span class="hljs-number">159076870</span></span>.html|http://alu5.ojf6lnoa.owl.e/others/</code> </pre><br><blockquote>  The data prepared for uploading to Redshift looks like this. </blockquote><br>  Since each request from the counter contains a unique visitor ID and the time of the last visit to the site, there is no need to calculate user sessions at the data preparation stage.  Moreover, data about page views from the same session can be recorded on different counter servers, therefore hits in the session are glued together already inside Redshift.  Thus, we collect basic metrics like volume of impressions (inventory) or the number of unique users (audience) for any sections: site section, source, browser, etc. in our storage. <br><table><tbody><tr><th>  timestamp </th><th>  uid </th><th>  url </th><th>  visits_count </th><th>  new_visitor </th><th>  last_visit_ts </th></tr><tr><td>  3/25/2014 17:42:00 </td><td>  108e36856acb1384 </td><td>  / </td><td>  0 </td><td>  one </td><td>  Null </td></tr><tr><td>  3/25/2014 17:43 </td><td>  108e36856acb1385 </td><td>  / football / </td><td>  0 </td><td>  one </td><td>  Null </td></tr><tr><td>  3/25/2014 23:42:00 </td><td>  108e36856acb1384 </td><td>  / cska / </td><td>  one </td><td>  0 </td><td>  3/25/2014 17:42:00 </td></tr></tbody></table><br><blockquote>  Raw data (clickstream) is added to Redshift into similar structures. </blockquote><br>  In most cases, when analyzing traffic, there is no need to learn something about a particular visitor or about one of his sessions, but it requires aggregate or averaged values ‚Äã‚Äãlike the number of unique visitors for a certain period or the average number of views per session.  Therefore, it makes no sense to analyze directly the raw clickstream, which takes up a lot of space, and requests for it are not very fast. <br><br>  We pack the collected data into aggregates suitable for further analysis, for example, we compose the entire user session, usually consisting of several hits, into one record, which reflects the main information about this visit: the duration and number of views per session, the source of the transition, and others visit data: <br><table><tbody><tr><th>  start </th><th>  end </th><th>  uid </th><th>  last_visit_ts </th><th>  pageviews </th></tr><tr><td>  3/25/2014 17:42:00 <br></td><td>  3/25/2014 17:43 <br></td><td>  108e36856acb1384 </td><td>  Null </td><td>  2 </td></tr><tr><td>  3/25/2014 23:42:00 <br></td><td>  3/25/2014 23:53:00 <br></td><td>  108e36856acb1385 </td><td>  3/25/2014 17:42:00 <br></td><td>  four </td></tr><tr><td>  3/26/2014 0:42:00 <br></td><td>  3/25/2014 0:43 <br></td><td>  108e36856acb1385 </td><td>  3/25/2014 23:42:00 <br></td><td>  2 </td></tr></tbody></table><br><blockquote>  In this form, aggregated data is presented for the sessions. </blockquote><br>  From this data, aggregators of the following level can be collected: <br><table><tbody><tr><th>  date </th><th>  uid </th><th>  pageviews </th><th>  sessions </th></tr><tr><td>  3/25/2014 </td><td>  108e36856acb1384 </td><td>  6 </td><td>  2 </td></tr><tr><td>  3/25/2014 </td><td>  108e36856acb1385 </td><td>  2 </td><td>  one </td></tr><tr><td>  3/25/2014 </td><td>  a3e990633872eb74 </td><td>  12 </td><td>  3 </td></tr></tbody></table><br><blockquote>  Aggregated Visitor Data </blockquote><br>  Working with final aggregates is much faster than with raw data: to obtain information about the inventory, you only need to take the total number of views of all sessions, and to assess the audience you will need to calculate the number of unique visitor IDs from a compressed 20 times (compared to the raw clickstream) array of data.  To measure coverage in a specific section of the site, we create a separate profile (if we speak in GA terminology) in the form of a table and predict only those sessions that correspond to the sample conditions in this profile: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sessions (uid,last_visit_ts, <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, pageviews) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> uid, last_visit_ts, <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(ts), <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(ts), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(uid) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> clickstream <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> &gt; date_trunc(<span class="hljs-string"><span class="hljs-string">'hour'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()) - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'24 hours'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> uid, last_visit_ts</code> </pre><br><br>  The grouping of clickstream hits in a session is done by a SQL query once a day and takes several seconds.  In addition to aggregating data on visits, we also consider information on user activity by day, week, and month, so that such data is instantly available for relevant reports.  We are storing the clickstream in Redshift over the last month so that you can make arbitrary requests for any cuts, as well as have fresh data for the last hour. <br><br>  We do not sample the source data: we collect information about each page display, so we always have the opportunity to count statistics on any page in any dimension, even if such a page collected only 10 hits per month.  We store the old data of the clickstream (older than a month) in backup files and can import them into Redshift at any time. <br><br><h4>  User data collection </h4><br>  In order to be able to work simultaneously with data about page views and user actions (pluses to blog posts, comments, management of teams in fantasy tournaments, etc.), we import part of user data from the site database into Redshift.  In this case, full texts of posts or news, as well as personal data (email, names, logins, passwords) are not transferred to Redshift. <br><br>  User activity data is aggregated by day, week, and month so that you can quickly build engagement reports.  For example, you can follow the number of new active users (who added, commented, started teams in fantasy tournaments or performed any other actions on the site) by day: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, new_users, new_active_users <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> user_activities_day <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre><br><pre> <code class="sql hljs">day new_users new_active_users 2014-02-15 2051 508 2014-02-16 1608 366 2014-02-17 1052 419 2014-02-18 2131 603 2014-02-19 2374 547 2014-02-20 1340 508 2014-02-21 966 340</code> </pre><br><br>  In order to receive a list of active fans of the Lesotho national team from Saratov for email, who have visited us at least twice in the last week and have visited the site for more than three weeks in a row, you can do this request: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ul.user_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> user_log ul <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> user_tags ut <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ut.user_id = ul.user_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ul.last_week_sessions &gt; <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">-- -    7  AND ul.weeks &gt; 3 -- -     AND ul.city = '' AND ut.tag = ' '</span></span></code> </pre><br><br>  As a result, we have the opportunity to observe the activity of users in different dimensions: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/06b/95c/b4d/06b95cb4d8fe59d7f0c1291eb5cbb068.png" alt="image"><br><br><h4>  Integration with social networking API </h4><br>  We collect data about our subscribers on Facebook, Twitter and Vkontakte once a day and, like all other statistics, add them to Redshift.  To obtain data on the number of subscribers in Facebook groups, use the Graph API: <br><br><pre> <code class="bash hljs">$ curl http://graph.facebook.com/sportsru?fields=likes { <span class="hljs-string"><span class="hljs-string">"likes"</span></span>: 238845, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"110179310119"</span></span> }</code> </pre><br><br>  The VKontakte API also allows you to get data about groups using the groups.getById method: <br><br><pre> <code class="bash hljs">$ curl https://api.vk.com/method/groups.getById?gid=sportsru&amp;fields=members_count { <span class="hljs-string"><span class="hljs-string">"response"</span></span>: [ { ... <span class="hljs-string"><span class="hljs-string">"screen_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"sportsru"</span></span>, <span class="hljs-string"><span class="hljs-string">"members_count"</span></span>: 280548, ... } ] }</code> </pre><br><br>  Twitter, after <a href="https://blog.twitter.com/2013/api-v1-is-retired">updating its API,</a> began to request authorization and tightened the limits on the frequency of requests, so data on our five hundred accounts began to be collected for too long, so we use several accounts and access token keys to get statistics on our threads on Twitter.  We use <a href="https://github.com/tweepy/tweepy">tweepy</a> to work with the Twitter API. <br><br>  After all the imports and conversions, we get a table in Redshift with the dynamics of changes in the number of subscribers by day: <br><br><table><tbody><tr><th>  date </th><th>  social network id </th><th>  tag </th><th>  followers </th></tr><tr><td>  2014-03-26 <br></td><td>  Twitter </td><td>  CSKA </td><td>  10315 </td></tr><tr><td>  2014-03-26 <br></td><td>  VK </td><td>  Premier League (England) </td><td>  133427 </td></tr></tbody></table><br><br>  Over these data, an interactive panel is built in Chart.io, which allows you to monitor all our streams in social networks: <br><img src="https://habrastorage.org/getpro/habr/post_images/d58/249/db4/d58249db403dbff53abc782c933cbd5a.png" alt="image"><br><br><h4>  Data visualization </h4><br>  In order not to waste time on developing a graphical interface, we decided to use a third-party service for drawing graphs and tables <a href="https://chartio.com/">Chart.io</a> .  It has ready connectors for Redshift, Google Analytics and other data sources, supports caching query results on its side.  Data for a chart can be queried by a SQL query or using a convenient interface where you can select metrics, dimensions, and filters. <br><br>  In order to connect Chartio to the database, simply specify the host, port and login with the password to connect to Redshift, and in the settings of Amazon Web Services you need to allow access to the data from the Chart.io servers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/079/871/c22/079871c225071e896f3681cc839f6bf6.png" alt="image"><br><br>  In order to build a graph with a division of the number of comments by types of commented content and dynamics by day, it is enough to indicate the fields by which data will be grouped, and the selection conditions: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/120/f77/6b8/120f776b80f3b10497d805ed60718dd0.png" alt="image"><br><br>  Simple mathematical functions can be applied to selected data: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa2/f6f/58f/fa2f6f58f8c6fb298a18af61da7d9394.png" alt="image"><br><br>  After that you need to select the type of graphics: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/793/0f9/d8d/7930f9d8da6cfbe9b86523e525a1b60f.png" alt="image"><br><br>  And the interactive panel is ready for use.  Actually, in this way we are overlaid with all sorts of graphs and tables on a large range of analytical data.  Having spent less than 3 months on development, we were able to make arbitrary requests to data from all the right sources, not limited to standard Google Analytics dashboards. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/089/b2a/2ef/089b2a2efb10fd5b62c7dba86127f2c6.png" alt="image"><br><br><h4>  What else? </h4><br>  In addition to the basic analytical tools of the company's employees, we began to build data-services for our users.  For example, we with a certain accuracy calculate the visitor's interest in a particular club, athlete, tournament and use this knowledge to form a personalized menu of the site and links to frequently visited pages.  We use information about the tags of materials that the visitor reads, sometimes we enrich this knowledge with other signals (transitions from the club's fan site or from the thematic ad of contextual advertising). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf4/373/16e/bf437316ef244a3d60808a1179928e5a.png" alt="image"><br><br>  Talk about our data processing infrastructure is endless.  We will continue a detailed conversation within <a href="http://ritconf.ru/2014/abstracts/1320.html">our section at RIT ++</a> , where we will talk more about the architecture, cost of implementation and ownership, discuss user campaigning for mailing lists, realtime content recommendations, monitoring business metrics, and also searching for bots among users and formation of client profiles. </div><p>Source: <a href="https://habr.com/ru/post/216229/">https://habr.com/ru/post/216229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216219/index.html">We expand the functionality of the exchange of orders between 1C-Bitrix and 1C Enterprise UT 11</a></li>
<li><a href="../216221/index.html">4 ways to turn "No" into "Yes"</a></li>
<li><a href="../216223/index.html">Add Cyrillic to Source Sans Pro Font for Lumen Bootstrap Theme</a></li>
<li><a href="../216225/index.html">Optimization of the geometric algorithm of learning ANN in the analysis of independent components</a></li>
<li><a href="../216227/index.html">Writing a parser with XPath and Yii</a></li>
<li><a href="../216231/index.html">Dorian / Satoshi Nakamoto made an official statement: ‚ÄúI have no relation to Bitcoin‚Äù</a></li>
<li><a href="../216233/index.html">The defeat of robots: the ups and downs of high-frequency trading (Part 1)</a></li>
<li><a href="../216235/index.html">The sacred cow, karma and mustache: how and why the Indians are not indifferent to IB</a></li>
<li><a href="../216237/index.html">Windows Pocket Concept</a></li>
<li><a href="../216239/index.html">As I was called paranoid and what came of it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>