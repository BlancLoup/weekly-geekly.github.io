<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Powershell Practice: Monitoring Windows Backup Backup</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the implementation of monitoring backup file storage created by Windows Backup using a Powershell script in order to control th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Powershell Practice: Monitoring Windows Backup Backup</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/bff/0f9/021/bff0f902108746ed872ae63dc6ea6a4c.png" alt="CPDV"><br><br>  This article discusses the implementation of monitoring backup file storage created by Windows Backup using a Powershell script in order to control the timeliness of the backup and the size of the generated data.  The article also aims to give examples of some useful programming techniques in Powershell. <br><a name="habracut"></a><br><h2>  Long intro </h2><br>  It is good to have a backup management system that works according to a schedule and notifies the administrator in time about the state of affairs in his sometimes difficult household.  Well and, at first glance - not too expensive: good, the choice of both commercial and free systems of this kind is now quite wide.  However, the level of complexity of both the deployment and maintenance of any such system in working condition, as well as the hardware costs for it, suggest some reasonable minimum of the complexity of the IT system itself, the data of which elements are expected to be backed up.  It seems that the deployment of, say, Bacula for the needs of a small office, the number of workstations under Windows in which is about a dozen is, say, two or three servers, represents an unproductive time and material resources in the context of the final product of the enterprise and the only positive result of such actions will be the practical experience gained by the system administrator.  Consideration of decentralized backup systems offering a good level of features and relatively high autonomy leads to commercial products like Veeam Endpoint Backup. <br><br>  Free editions of such programs, unfortunately, if they can boast of any advantages over the built-in Windows Backup, these advantages are not relevant to everyone and not in all cases and are not always obvious.  Yes, and "native" support for the mechanism of shadow copies, frankly, is its great advantage.  In a word, sometimes there is a feeling that all roads lead to this very Windows Backup.  In fact, the question of choosing and organizing a backup system is purely individual for each specific case and is decided against the background, including subjective factors.  However, in any case, I want to create a reliable and stable system, which, moreover, is easy to maintain.  But autonomous backup agents cannot boast of the functions of a generalized monitoring of the scale of an organization.  On this, I think, it is time to complete this preface so as not to get bored too soon. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our scene is as follows: there are a dozen computers running Windows 7 and Windows 10, as well as a server running Windows Server 2008. There is also a NAS, purchased for use as a backup storage of data.  There is a task: to provide backup of an uncomplicated but reliable enough kind without an additional budget.  It is not difficult, including because there is no full-time system administrator in the organization, and all IT problems are solved by a part-time administrator with the feasible help of some users.  It was decided to use Windows Backup tools, which will save data to a dedicated folder named ‚Äúnetbackup‚Äù on a remote machine with the network name ‚ÄúSA-NAS‚Äù in accordance with the local schedules of each computer.  This solution works, moreover, it is rather stable, and each computer regularly sends backup reports to the system administrator email (read from system logs by the script).  But the question of analyzing the volume and ‚Äúfreshness‚Äù of the created archives remains open, since Windows Backup is not inclined to share this information except as interactive.  The system administrator rolled up his sleeves and began to write another script, for which he had to first sort out the issue of the data backup structure created by Windows Backup.  So‚Ä¶ <br><br><h2>  What does Windows Backup create and how is it organized? </h2><br>  To answer this question, you will have to ask a counter-question, quite in Odessa: ‚ÄúWhat exactly do you mean?‚Äù For Windows Backup, as you know, can create (a) backup copies of selected elements of the computer's file system, i.e.  file archives (file backup), and (b) images of disk volumes (image backup).  We ourselves choose the type of backup for a specific computer when it is configured using the corresponding Control Panel applet and, as is known, we can specify both archiving of specific folders and files, and the formation of images of selected disk volumes, as well as a combination of these two methods.  I do not want to move away from the topic of the article, going into the description of this operation, which is trivial, so I dare to refer the reader to the relevant documentation and search engines of the Internet.  I will give the data of my own study of the Windows Backup data structures, which is somehow immodest to call the fashionable word ‚Äúreengineering‚Äù due to the relative simplicity of the problem.  I also note that later in the text for the file system directories I will use the term ‚Äúfolder‚Äù - so that there is no confusion with the term ‚Äúdirectory‚Äù, which will be used only in relation to Windows Backup catalog files. <br><br>  The data sets created by Windows Backup in each of the two archiving modes on the target media will differ in structure. <br><br><img src="https://habrastorage.org/files/e83/195/e09/e83195e09c6b49ac8e87d7917ded86b9.png" alt="Picture 1" align="left">  The first figure shows a typical example of the folder system structure of the file system created in the target network folder ‚Äúnetbackup‚Äù when backing up in file mode.  First of all, the service file <i>‚ÄúMediaID.bin‚Äù</i> appears in the root folder.  As is clearly seen, at the first level of the hierarchy (the level of computers) individual subfolders are created for each computer (‚ÄúPC-001‚Äù, ‚ÄúPC-002‚Äù, etc.).  These folders contain at least a couple of service files: <i>‚ÄúMediaID.bin‚Äù</i> and <i>‚ÄúDesktop.ini‚Äù</i> . <br><br>  In the individual folder of each computer, as Windows Backup works, subfolders of the second hierarchical level (archive level) appear with names like " <i>Backup Set &lt;date&gt; &lt;time&gt;"</i> , each of which contains one archive: the initial full backup of the selected data and the subsequent ones based on it, incremental backups.  Also, each folder of the archive level contains a subfolder with the name <i>‚ÄúCatalogs‚Äù</i> , which contains a file with the name <i>‚ÄúGlobalCatalog.wbcat‚Äù</i> (contains the catalog of this archive). <br><br>  This file is very useful for analyzing the data structure and its status: its very presence in the <i>‚ÄúCatalogs‚Äù</i> folder indicates that, firstly, this folder and its neighbors are located inside the archive level (at the volume level) and, secondly, the analysis the time of its last change allows you to know when the last backup operation that updated this archive was performed. <br><br>  Both the initial full copy and the subsequent incremental copies are located in separate subfolders of the volume level with names like <i>‚ÄúBackup Files &lt;date&gt; &lt;time&gt;‚Äù</i> .  Just as at the archives level, each volume-level folder contains the <i>‚ÄúCatalogs‚Äù</i> subfolder, but it ‚Äî unlike the namesake of the archives level ‚Äî contains quite a few files with the <i>".wbcat"</i> and <i>".wbverify" extensions</i> that make up the catalog of a specific archive volume .  In addition to the <i>‚ÄúCatalogs‚Äù</i> subfolders, each folder of this level contains only an arbitrary number of ZIP archives, which together contain data from a specific volume.  Everything is quite simple and - what is nice - the data can, as a last resort, be manually extracted by unpacking the ZIP archives. <br><br>  Since the configured and running Windows Backup can be affected to the same extent as the stone released from the slingshot, decisions about stopping the addition of the current archive with incremental volumes and initializing a new one are made somewhere deep in the code of this program and are not known to others. in the form of the appearance of a new folder at the level of archives.  The author of the article was unable to figure out the algorithm for making decisions of this kind by the program, but the logical (and reasonable in the context of existing experience) is the interconnection between the possibility of continuing the chain of incremental volumes and the successful completion of the last backup operation.  Moreover, Windows Backup, having spawned a new archive, completely forgets about its predecessor, silently entrusting its fate at the complete discretion of the system administrator.  Which, of course, immediately reflects on the amount of free disk space up to the moment when the administrator does not delete outdated archives folders in one way or another.  This probably provides for multiple backups of the same file (see the ‚ÄúPrevious Versions‚Äù tab of the file properties window in the Explorer).  Well, what it is - Windows Backup - that's what it is: it's hard to expect no limitations from a virtually free product. <br><br>  Assuming that sufficient clarity has been added to the question of the storage structure of file-type archives, we turn to the images of the disk volumes.  The directory structure in this case (see figure below) is quite similar to the directory structure of the Windows Backup file archives, but there are also significant differences: <br><br><img src="https://habrastorage.org/files/f4b/159/191/f4b159191179417d80ec7184fdb2325d.png" alt="image" align="left"><ol><li>  The first level of the folder hierarchy is formed by <i>the WindowsImageBackup</i> folder, which is created in the target folder (‚Äúnetbackup‚Äù) when backed up in disk mode.  Subfolders for individual computers are created inside the <i>‚ÄúWindowsImageBackup‚Äù</i> and form the level of computers. </li><li>  Inside the subfolders of each computer (at the archives level) there are only three folders.  Two of them have static names: <i>"Catalogs"</i> and <i>"SPPMetadataCache"</i> , and the third - the archive folder - has a name like <i>"Backup &lt;date&gt; &lt;time&gt;"</i> . </li></ol><br>  Each computer-level folder always contains, in addition to the three above-mentioned subfolders, the <i>MediaId</i> service file without an extension.  The subfolder <i>‚ÄúCatalog‚Äù</i> , in turn, always contains two files: <i>‚ÄúGlobalCatalog‚Äù</i> and <i>‚ÄúBackupGlobalCatalog‚Äù</i> . <br><br>  The archive folder (with the name of the form <i>‚ÄúBackup &lt;date&gt; &lt;time&gt;‚Äù</i> ) changes its name whenever the backup of this computer is performed in the mode of disk volume images.  This is logical, because every time a full, not incremental, backup of volumes is performed.  It remains a mystery, however, why in this mode the outdated archive is deleted automatically immediately, and the outdated archives of the file mode of archiving continue to lie in the same place.  Anyway, this folder contains a set of VHD files (virtual disk image) and a group of auxiliary XML files, among which we highlight <i>‚ÄúBackupSpecs.xml‚Äù</i> .  Apparently, it serves to save the parameters of a specific archive, and is formed after the actual creation of disk volume image files, thus making it possible to judge the time it takes to complete the archive operation. <br><br>  That, in fact, is all that can be considered essential information about the storage structure of Windows Backup archives.  I don‚Äôt see the point in examining the <i>‚ÄúDesktop.ini‚Äù</i> files that Windows is used to form in some folders, since they are not involved in our monitoring. <br><br><h2>  Our algorithms </h2><br>  We will determine the information that I would like to receive automatically.  Let it be the following set of attributes: <br><br><ul><li>  the list of machines for which Windows Backup archives exist, and their types; </li><li>  date / time of updating the most current archive; </li><li>  the size of the most current archive; </li><li>  folder name / path of the most current archive. </li></ul><br>  For Windows Backup archives created in file mode, the algorithm for collecting information will be as follows: <br><br><ol><li>  We perform a sequential enumeration of the subfolders of the first nesting level in the target folder and identifying those that contain the file <i>‚ÄúMediaID.bin‚Äù</i> , which is actually the flag of the root folder of the archives of a separate machine (hereinafter, for brevity, the CPAM). <br></li><li>  In each identified CPAM, we perform an analysis of the presence in its subfolders of the <i>‚ÄúCatalogs‚Äù</i> folder containing the <i>‚ÄúGlobalCatalog.wbcat‚Äù</i> file. </li><li>  Select the newest among <i>the GlobalCatalog.wbcat</i> files found in the previous step and take the folder containing its parent folder as the repository of the most current archive of the file mode (hereinafter referred to as CAA).  We take the time of the last modification of this file as the time of completion of the formation of the last volume of this archive. </li><li>  We summarize the size of the ZIP files in the subfolders of the CAA folder and take this value as the size of the CAA. </li><li>  We form and return a custom representation of the accumulated information: name (path), size and time of creation of the CAA for each vehicle from the list of CAMA. </li></ol><br>  For archives of the mode of disk volumes, the algorithm for collecting information will be as follows: <br><br><ol><li>  We perform a sequential enumeration of the subfolders of the first nesting level in the target folder and identifying those that contain <i>the MediaID</i> file, which is actually the flag of the root folder of the archives of an individual machine (hereinafter, for brevity, the MPAC). </li><li>  In each CPAM, we perform an analysis of the presence of a file in its subfolders with the name <i>‚ÄúBackupSpecs.xml‚Äù</i> .  Just in case, we proceed from the possibility of the existence of not one, but several archive folders. </li><li>  Select the newest one among the <i>‚ÄúBackupSpecs.xml‚Äù</i> files found in the previous step, and take the folder containing it as the repository of the most current archive of the disk volumes mode (hereinafter referred to as CAA).  We accept the time of the last modification of this file as the time of completion of the formation of this archive. </li><li>  We summarize the size of the VHD files in the subfolders of the CAA folder and take this value as the size of the CAA. </li><li>  We form and return a custom representation of the accumulated information: name (path), size and time of creation of the CAA for each vehicle from the list of CAMA. </li></ol><br>  So far, everything looks simple enough for implementation, incl.  and as a Powershell script, so let's get started. <br><br><h2>  Powershell Script </h2><br>  In this section, we will look at the key elements of the script, and for the implementation details omitted, we suggest referring to its source code, which is <a href="https://cloud.mail.ru/public/LijW/jbUekoj2U">attached</a> .  Immediately, I note that the text elements of the user interface in the code examples below are in Russian, but they are implemented in English in the script ‚Äî it was simply developed for use in an English-language environment and I would not want to spill code versions according to the language criterion, and the implementation of multilingual The interface is unnecessarily complicated for such a simple product. <br><br><h3>  Processing file mode archives </h3><br>  For a start, we get a list of QAMPs: <br><br><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MachineListFB</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $MachineRoots = @{} Get-ChildItem -Path $WinBackupRoot -Recurse -Depth <span class="hljs-number"><span class="hljs-number">1</span></span> -File -Filter <span class="hljs-string"><span class="hljs-string">"MediaID.bin"</span></span> | Where-Object {$_.Directory.FullName -ne $WinBackupRoot} | <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> { $MachineRoots[$_.Directory.Name]=$_.Directory.FullName } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $MachineRoots }</code> </pre> <br>  The <i>Get-MachineListFB function</i> takes one parameter: the full name of the root folder of the Windows Backup archive and, as you can see, there is nothing intricate in its code.  The <i>Get-ChildItem</i> cmdlet generates a list of <i>MediaID.bin</i> file descriptors located within the same nesting level with respect to a specified folder.  This list is passed to the <i>Where-Object</i> cmdlet by the pipeline, which passes to the next stage only those found files that are located outside the root of the specified folder, in its subfolders (as we remember, the root folder of the Windows Backup archives also contains the file <i>MediaID.bin "</i> ).  Next, the returned object is filled with the names and full paths of the folders containing the found files. <br><br>  Regarding the use of the <i>Get-ChildItem</i> cmdlet to select files and folders for a given criterion, I would like to make a comment.  As you can see, the criterion of the name in the cmdlet is expressed in the form of the parameter <i>"-Filter"</i> .  At the same time, <i>Get-ChildItem</i> also has another parameter that can perform the same function: <i>"-Include"</i> .  What is the difference and how to choose a way to describe the selection criteria?  When using the <i>"-Filter"</i> parameter <i>,</i> Powershell performs selection by <i>activating the</i> appropriate provider mechanisms that implement access to a specific data set (in our case, a disk file system).  Alternatively, Powershell has its own built-in selection mechanism enabled by the <i>"-Include"</i> parameter.  The difference for us, as for the user, manifests itself in: <br><br><ol><li>  Speed: the selection using the mechanisms of the provider can be (and in our case it is definitely) faster than the own PS functionality; </li><li>  Capabilities: when using the <i>"-Include"</i> parameter together with the <i>"-Recurse"</i> parameter, the hierarchy depth of the <i>"-Depth"</i> parameter does not work (at least in Powershell version 5 with respect to disk file system - this was established experimentally). </li></ol><br>  Further, we realize the function of CAA detection: <br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastFileBackupSet</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($MachineRoot)</span></span></span><span class="hljs-function"> </span></span>{ $objLB = $null <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $LastWbcat = Get-ChildItem -Path $MachineRoot -Recurse -Depth <span class="hljs-number"><span class="hljs-number">2</span></span> ` -File -Filter <span class="hljs-string"><span class="hljs-string">"GlobalCatalog.wbcat"</span></span> | Where-Object {$_.Directory.Name -eq <span class="hljs-string"><span class="hljs-string">"Catalogs"</span></span>} | Sort-Object LastWriteTime | Select-Object -Last <span class="hljs-number"><span class="hljs-number">1</span></span> LastWriteTime, Directory, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Machine"</span></span>;Expression={$_.Directory.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.Name.ToUpper()}}, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Path"</span></span>;Expression={$_.Directory.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.FullName}}, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Name"</span></span>;Expression={$_.Directory.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.Name}} $ZIPFiles = ( Get-ChildItem $LastWbcat.Directory.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.FullName -Recurse -Depth <span class="hljs-number"><span class="hljs-number">2</span></span> ` -File -Filter <span class="hljs-string"><span class="hljs-string">"*.zip"</span></span> | Select-Object Length | Measure-Object -Property Length -Sum ) } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($ZIPFiles) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($LastWbcat)) { $objLB = @{ Machine = $LastWbcat.Machine Path = $LastWbcat.Path Name = $LastWbcat.Name Updated = $LastWbcat.LastWriteTime Size = $ZIPFiles.Sum } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $objLB }</code> </pre><br>  Let me explain to newbies in Powershell: reverse single quotes at the ends of some lines are the standard symbol for the continuation of an expression on the next line in the PS script language.  Here they are used only to improve the readability of code examples within the article. <br><br>  Let us clarify the logic of the function.  There is only one parameter to call it ‚Äî just like the previous one: the full name of the root folder of the file mode archives for an individual machine (we determine these paths for all machines whose archives are found in advance using the <i>Get-MachineListFB function</i> ).  The call to <i>Get-ChildItem</i> returns a list of objects containing descriptions of the found files with the name <i>"GlobalCatalog.wbcat"</i> in the subfolders of the specified folder.  This list is passed to the processing of the <i>Where-Object cmdlet</i> , which selects among the found files only those whose parent folder name is the same as the one specified ( <i>"Catalogs"</i> ).  The next stage of our pipeline is the <i>Sort-Object cmdlet</i> , which orders the rest of the list in ascending order of the last file change time, and the <i>Select-Object cmdlet</i> selects the last element of the ordered list, narrowing the set of attributes in the returned object to <i>LastWriteTime</i> and <i>Directory</i> in order to economize on machine resources. <br><br>  That's all that can be accompanied by the adverb "just" ends: then the <i>Select-Object</i> cmdlet <i>attaches</i> additional user attributes to each returned object (it turns out, PS allows you to do such things on the fly).  As a result, the return value is an object with attributes composed of two ‚Äúbuilt-in‚Äù properties of the <i>Directory</i> and <i>LastWriteTime of the</i> source element, as well as from the dynamically calculated user properties of <i>Machine</i> , <i>Path</i> and <i>Name</i> defined by us (in hash table format).  The format for defining user attributes of this kind is as follows: <br><br><pre> <code class="hljs pgsql">@{<span class="hljs-type"><span class="hljs-type">Name</span></span> = "&lt;_&gt;"; Expression = {$_.&lt;&gt;}}</code> </pre> <br>  An expression that calculates the value of a property can be either arbitrary, not directly related to the data being processed (for example, <i>Get-Date</i> ), or including the properties and methods of the <i>$ _</i> iterator element ‚Äî as done in the code for this function.  As you can see from the example of the function code, constructions of this type are simply listed in the list of parameters returned by the <i>Select-Object cmdlet</i> . <br><br>  Returning the result of calculations in the form of a composite object is convenient because there is no need to do individual calculations for different parameters of the same set of input data.  In particular, the function just reviewed not only tells us the name of the CAA folder, but also its full path, the timestamp of the last update of the archive in it and its size. <br><br>  Further, in the text of the function, we calculate the total size of the ZIP files that make up this archive, selecting files with the .zip extension in all subfolders of the folder one level above the folder containing the parent folder of <i>the GlobalCatalog.wbcat</i> file (i.e. within the folder of this archive).  The call to <i>Get-ChildItem</i> returns a list of files that is sent to the <i>Select-Object cmdlet</i> , which only retrieves the <i>Length</i> property from the data (which is a synonym for size for file system objects), and it, in turn, gives the resulting sample to the <i>Measure-Object cmdlet</i> to summarize the sizes. <br><br>  The construction of the <code>($ZIPFiles) -and ($LastWbcat)</code> is used to check the existence of the <i>$ ZIPFiles</i> and <i>$ LastWbcat variables</i> for elementary detection of error situations.  This is a standard method in Powershell: since we did not initialize these variables beforehand, then if any of them remained uninitialized by the time of the test (does not have a valid value), the test will return a negative in a logical sense result.  Those.  something like the <code>If Not IsNull() ‚Ä¶</code> construct <code>If Not IsNull() ‚Ä¶</code> in Visual Basic. <br><br>  Then, as is probably understandable, the calculated values ‚Äã‚Äãare assigned to the fields of the object (such as a hash table) <i>$ objLB</i> , which will be returned by our function. <br><br>  The definition of the CAA parameters for a particular machine actually completes our computational algorithm, since now everything is known about the desired CAA and this ‚Äúeverything‚Äù is written into the fields of the object that the <i>Get-LastFileBackupSet</i> function returned: <br><br><ul><li>  <i>Machine</i> is the network name of the computer, </li><li>  <i>Path</i> - the full path of the CAA folder for this computer, </li><li>  <i>Name</i> is the name of the CAA folder (it has an identifiable value and can identify the archive), </li><li>  <i>Updated</i> - Last <i>Updated</i> Date, </li><li>  <i>Size</i> - the total size of the archive. </li></ul><br>  It remains to implement the presentation of the information received.  Since the system administrator acts as a consumer, we will not invent any visual stylistic delicacies and we will simply make two representations of the output data: plain text and HTML of a table type.  For each format, we will create two functions: the first will form a data line for an individual computer, and the second will assemble a table with a title from such lines.  In fact, in the script code they will follow in reverse order: the executive subsystem of Powershell is an interpreter, so the function declaration in the script code must precede its call and the PS does not support the mechanism of preliminary declaration of function prototypes. <br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastFileBackupSetSummaryTXTRow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($MachineRoot)</span></span></span><span class="hljs-function"> </span></span>{ $ret = <span class="hljs-string"><span class="hljs-string">""</span></span> $Now = Get-Date $LastBT = Get-LastFileBackupSet ($MachineRoot) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($LastBT) { $ret = <span class="hljs-string"><span class="hljs-string">": "</span></span> + $LastBT.Machine + <span class="hljs-string"><span class="hljs-string">"; : "</span></span> + $LastBT.Name + ` <span class="hljs-string"><span class="hljs-string">"; : "</span></span> + ($Now - $LastBT.Updated).Days + <span class="hljs-string"><span class="hljs-string">"  . ("</span></span> + ` $LastBT.Updated + <span class="hljs-string"><span class="hljs-string">"); : "</span></span> + (<span class="hljs-string"><span class="hljs-string">'{0:0} {1}'</span></span> -f ($LastBT.Size/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $ret = <span class="hljs-string"><span class="hljs-string">"  "</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ret } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastFileBackupDatesTXT</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $table=<span class="hljs-string"><span class="hljs-string">"  :`r`n"</span></span> $MachineRoots = Get-MachineListFB ($WinBackupRoot) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($machine in $MachineRoots.Keys) { $line = Get-LastFileBackupSetSummaryTXTRow($MachineRoots[$machine]) $table+= -join($line, <span class="hljs-string"><span class="hljs-string">"`r`n"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $table }</code> </pre><br>  The <i>Get-LastFileBackupDatesTXT</i> collector <i>function is</i> completely trivial: it simply builds a text string containing a table with a title in stages.  The rows of the table are generated by the <i>Get-LastFileBackupSetSummaryTXTRow function</i> , and they are <i>"glued together" by the</i> string concatenation operator <i>"-join"</i> .  In the literature, it is called differently: where is the operator, and where is the method, and there are several recording forms for it.  Here we use the ‚Äúfunction-like‚Äù form of the record, in which concatenation is done by default without a separating character.  The second operand is a string constant composed of the end-of-line and carriage esc characters ( <i>"` r "</i> and <i>" `n"</i> ), i.e.  standard for text files Windows line break. <br><br>  The <i>Get-LastFileBackupSetSummaryTXTRow function</i> gets the path to the CMAC and determines the CAA for the corresponding machine.  Since this value is composite, it extracts individual data elements from it and, supplying them with text labels, collects a readable string from them.  Powershell here again allows us to take advantage of the object-related charms of the values ‚Äã‚Äãit uses: the difference between two values ‚Äã‚Äãof the date / time object type is also an object and its value in days is calculated by a simple subtraction operator without invoking additional functions.  It is only necessary to clarify in which unit of measurement we want to get the result, which is achieved by pointing to the Days property of the resultant object - since it is the days that interest us. <br><br>  To form a representation of the size of the archive in megabytes, the following construction was used: <br><br><pre> <code class="hljs lisp">('{<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>} {<span class="hljs-number"><span class="hljs-number">1</span></span>}' -f ($LastBT.Size/1024/1024), <span class="hljs-string"><span class="hljs-string">""</span></span>)</code> </pre> <br>  This is a formatting operator and is analogous to the formatting function in many programming languages.  Inside the outer brackets (they are left here for readability) are sequentially arranged: the format string, the operator itself ( <i>"-f"</i> ), and the list of inline values.  Our format string contains two format specifiers (each specifier is enclosed in curly brackets): a number without a fractional part and a value without specifying formatting.  Since there is a space between the format specifiers - it will also be present in the result string between the values.  The operator, respectively, is followed by two values: an expression that calculates the size in megabytes and a unit string.  At the output, we get the string values ‚Äã‚Äãof the form "123 MB", i.e.  Powershell with the specified number formatting coerces a numeric value to the type corresponding to the specified format. <br><br>  If the CAA value is empty - <i>LastFileBackupSetSummaryTXTRow</i> returns a string indicating an error situation. <br><br>  Hypertext representations of information are formed in a similar way, differing, in essence, only by the fact that simple HTML tags are inserted into the generated lines.  We will not give this code here, because there is nothing radically new from the point of view of the algorithms of our problem, but we can familiarize ourselves with it by examining the source code of the script attached to the article.  We only note that the formatting of HTML-code includes color marking of lines with the age of CAA more than one day - to attract the attention of the administrator. <br><br><h3>  Processing archives mode images of disk volumes </h3><br>  We get the list of CAMAs as in the previous case, taking into account the specifics of storing archives of this mode: <br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MachineListIB</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $MachineRoots = @{} $ImageBackupRoot = $WinBackupRoot+<span class="hljs-string"><span class="hljs-string">"\WindowsImageBackup"</span></span> Get-ChildItem -Path $ImageBackupRoot -Recurse -Depth <span class="hljs-number"><span class="hljs-number">1</span></span> -File -Filter <span class="hljs-string"><span class="hljs-string">"MediaID"</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> { $MachineRoots[$_.Directory.Name]=$_.Directory.FullName } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $MachineRoots }</code> </pre><br>  Those.  we scan the subfolder with the name <i>‚ÄúWindowsImageBackup‚Äù</i> in the root folder of the repository to a depth of one level in the search for subfolders.  We are looking for signal files with the name <i>"MediaID"</i> , denoting a CPAM. <br><br>  Similar to the case with file mode archives, we define the CAA ‚Äî for which we describe the <i>Get-LastImageBackupSet</i> function <i>and create the start-up of the same-set-to-the-art-of-the-art-of-the-art-of-the-art-of-the-art-of-the-art-of-the-art-of-the-art-of-the-art-for-all-in-one-</i> and <i>-one-for-one-</i> and <i>-one-for-one-</i> and <i>-one-for-more-image-for-the-lastImageBackupSetSummaryHTMLRow</i> , <i>and the of all-the-lastImageBackupSetSummaryTXTRow</i> , <i>Get-LastImageBackupSetSummaryHTMLRow,</i> and the <i>Get-LastImageBackupSetSummaryTXTRow functions</i> .  Similar to the case of file mode archives, a pair of functions that generate the hypertext representation is not shown here (see the attached source code). <br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastImageBackupSet</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($MachineRoot)</span></span></span><span class="hljs-function"> </span></span>{ $objLB = $null <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $LastBSXML = Get-ChildItem -Path $MachineRoot -Recurse -Depth <span class="hljs-number"><span class="hljs-number">1</span></span> ` -File -Filter <span class="hljs-string"><span class="hljs-string">"BackupSpecs.xml"</span></span> | Sort-Object LastWriteTime | Select-Object -Last <span class="hljs-number"><span class="hljs-number">1</span></span> LastWriteTime, Directory, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Machine"</span></span>;Expression={$_.Directory.<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span>.Name.ToUpper()}}, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Path"</span></span>;Expression={$_.Directory.FullName}}, ` @{Name=<span class="hljs-string"><span class="hljs-string">"Name"</span></span>;Expression={$_.Directory.Name}} $VHDFiles = ( Get-ChildItem $LastBSXML.Directory.FullName -File -Filter <span class="hljs-string"><span class="hljs-string">"*.vhd"</span></span> | Select-Object Length | Measure-Object -property length -sum -ErrorAction SilentlyContinue) } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($VHDFiles) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($LastBSXML)) { $objLB = @{ Machine = $LastBSXML.Machine Path = $LastBSXML.Path Name = $LastBSXML.Name Updated = $LastBSXML.LastWriteTime Size = $VHDFiles.Sum } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $objLB } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastImageBackupSetSummaryTXTRow</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($MachineRoot)</span></span></span><span class="hljs-function"> </span></span>{ $ret = <span class="hljs-string"><span class="hljs-string">""</span></span> $Now = Get-Date $LastBT = Get-LastImageBackupSet ($MachineRoot) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($LastBT) { $ret = <span class="hljs-string"><span class="hljs-string">": "</span></span> + $LastBT.Machine + <span class="hljs-string"><span class="hljs-string">"; : "</span></span> + ` $LastBT.Name + <span class="hljs-string"><span class="hljs-string">"; : "</span></span> + ($Now - $LastBT.Updated).Days + ` <span class="hljs-string"><span class="hljs-string">"  . ("</span></span> + $LastBT.Updated + <span class="hljs-string"><span class="hljs-string">"); : "</span></span> + ` (<span class="hljs-string"><span class="hljs-string">'{0:0} {1}'</span></span> -f ($LastBT.Size/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>), <span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $ret = <span class="hljs-string"><span class="hljs-string">"  ."</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ret } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastImageBackupDatesTXT</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $table=<span class="hljs-string"><span class="hljs-string">"  :`r`n"</span></span> $MachineRoots = Get-MachineListIB ($WinBackupRoot) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($machine in $MachineRoots.Keys) { $line = Get-LastImageBackupSetSummaryTXTRow($MachineRoots[$machine]) $table+= -join($machine, <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span>, $line, <span class="hljs-string"><span class="hljs-string">"`r`n"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $table }</code> </pre><br>  This completes the analysis of the repository analysis code and proceeds to the general part of the script responsible for assembling and outputting the report as a whole. <br><br><h3>  Build and output report </h3><br>  Let us proceed from the fact that the script should be capable, as we have already agreed, to form a report in plain text format and in HTML format.  In addition, we set ourselves the task of ensuring that the report can be output in two ways: (a) as a test stream to a standard output device and (b) by sending via e-mail to a given address.  In this case, our script should accept the following command line parameters: <br><br><ul><li>  <i>root</i> - (string) path to the root folder of the Windows Backup storage. </li><li>  <i>txt</i> - (flag) use plain text format, and in the absence of this parameter, HTML. </li><li>  <i>mail</i> - (flag) send the report to e-mail, and in the absence of this parameter, output the contents of the report "as is" to stdout. </li><li>  <i>smtpsrv</i> - (string) The network name or IP address of the SMTP server for sending the report via email. </li><li>  <i>port</i> - (integer) TCP port number for sending the report via email. </li><li>  <i>to</i> - (string) The email address of the message recipient. </li><li>  <i>fm</i> - (string) The email address of the sender of the message (also known as the username of the SMTP server). </li><li>  <i>pwd</i> - (string) password of the SMTP server user (although this is not quite correct from a security point of view). </li><li>  <i>sub</i> - (string) subject of the message to be sent. </li></ul><br>  Create a script header at the beginning with a description of the command line parameters.  It is worth mentioning that the mechanism of working with them, which in its rudimentary form was implemented in the CMD.EXE scripts, was significantly improved in the Windows Script Host scripts, but it was still very inconvenient and required many additional actions to organize the system of typed parameters and their analysis.  In Powershell, it underwent radical transformations and became a full-fledged handy tool - the <i>Param</i> block, which allows you to implement the processing of parameters by the built-in PS tools based on their ads.  Let's apply it for our own purposes: <br><br><pre> <code class="hljs mel">Param( [Parameter(Mandatory)][<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $Root, [<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>] $txt=$false, [<span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>] $mail=$false, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $SmtpSrv, [<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>] $Port=<span class="hljs-number"><span class="hljs-number">25</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $To, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $Fm, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $Pwd, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $Sub )</code> </pre><br>  As can be seen from the above fragment, ace command line parameters are described by a single <i>Param</i> block.  Inside its brackets, comma-separated list, its attributes are listed - all of our parameters with indication of data types and binding.  In general, the simplest version of the description of a separate parameter consists of a simple identifier, starting with the "$" symbol.  The next most complex variant of a parameter declaration is the specification of the data type, which is described as the data type name in square brackets to the left of the parameter identifier.  You can also set a default value by simply adding an assignment statement and value to the identifier on the right.  The absence of an explicit default value causes the parameter to be initialized with an empty value of the specified type. <br><br>  The type of the switch parameter (i.e. ‚Äúswitch‚Äù) works as follows: if the script received this parameter by simple mentioning on the command line, it is assigned a true value.  If it was not on the command line, a false value will be assigned. <br><br>  If you need to specify additional attributes of the parameter - such as, for example, mandatory - you will have to add another block in square brackets to the left, which begins with the keyword <i>Parameter</i> , followed by a list of its attributes and, possibly, their values, enclosed in parentheses.  In particular, the binding nature of an individual parameter is given by its <i>Mandatory</i> attribute of a Boolean type.  Beginning with PS 3.0, explicitly specifying the value of <i>True to the</i> attributes of the parameters is not necessary: ‚Äã‚Äãif the value is omitted, the meaning is <i>True</i> . <br><br>  In our case, for example, the <i>Root</i> parameter is described as mandatory, of type <i>string</i> , with no default value.  The specified requirement of this parameter will lead to the fact that if the script is launched without it, the Powershell interpreter will prompt the console to enter its value and will not allow the execution of the script code without somehow specifying its value.  The absence of explicitly specified parameters, not declared as mandatory, is not an obstacle to the beginning of the execution of the script. <br><br>  It must be said that the use of the <i>Param</i> block in the Powershell scripting language is not limited only to command line parameters ‚Äî it can also be applied to function parameters.  Perhaps the more correct statement would be more true: it is applicable not only to the parameters of functions, but also to the command line parameters of the script, since<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the script body is an analogue of the top-level function of the program code hierarchy (as, for example, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">in C). With it, we could override our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get-LastImageBackupDatesTXT function</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as follows:</font></font><br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastImageBackupDatesTXT</span></span></span><span class="hljs-function"> </span></span>{ Param( [Parameter(Mandatory)][string] $WinBackupRoot ) $table=<span class="hljs-string"><span class="hljs-string">"  :`r`n"</span></span> $MachineRoots = Get-MachineListIB ($WinBackupRoot) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($machine in $MachineRoots.Keys) { $line = Get-LastImageBackupSetSummaryTXTRow($MachineRoots[$machine]) $table+= -join($machine, <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span>, $line, <span class="hljs-string"><span class="hljs-string">"`r`n"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $table }</code> </pre><br>              ,  , ,    . ,             . <br><br>             Powershell    ,         .     ,     <i>".PARAMETER"</i>  Comment-Based Help ,          <i>¬´Get-Help &lt;_&gt;¬ª</i> . <br><br>       .        ,      ,       :    ,           : <br><br><pre> <code class="hljs php"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastWinBackupDatesHTML</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $Now = Get-Date $table=<span class="hljs-string"><span class="hljs-string">'&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;'</span></span>+<span class="hljs-string"><span class="hljs-string">"`n"</span></span> $table+=<span class="hljs-string"><span class="hljs-string">'&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;&lt;head&gt;&lt;title&gt;   "'</span></span>+ `$WinBackupRoot+<span class="hljs-string"><span class="hljs-string">'"&lt;/title&gt;&lt;/head&gt;&lt;body&gt;'</span></span>+<span class="hljs-string"><span class="hljs-string">"`n"</span></span> $table+=<span class="hljs-string"><span class="hljs-string">'&lt;h3&gt;   "'</span></span>+$WinBackupRoot+<span class="hljs-string"><span class="hljs-string">'"'</span></span>+<span class="hljs-string"><span class="hljs-string">"&lt;/h3&gt;`n"</span></span> $table+=<span class="hljs-string"><span class="hljs-string">'&lt;h3&gt;  : '</span></span>+$Now+<span class="hljs-string"><span class="hljs-string">"&lt;/h3&gt;`n"</span></span> $table+= Get-LastFileBackupDatesHTML ($WinBackupRoot) $table+= Get-LastImageBackupDatesHTML ($WinBackupRoot) $table+= <span class="hljs-string"><span class="hljs-string">"&lt;/body&gt;`n&lt;/html&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $table } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastWinBackupDatesTXT</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($WinBackupRoot)</span></span></span><span class="hljs-function"> </span></span>{ $Now = Get-Date $table=<span class="hljs-string"><span class="hljs-string">'   "'</span></span>+$WinBackupRoot+<span class="hljs-string"><span class="hljs-string">'"'</span></span>+<span class="hljs-string"><span class="hljs-string">"`r`n"</span></span> $table+=<span class="hljs-string"><span class="hljs-string">'  : '</span></span>+$Now+<span class="hljs-string"><span class="hljs-string">"`r`n`r`n"</span></span> $table+= Get-LastFileBackupDatesTXT ($WinBackupRoot) $table+= <span class="hljs-string"><span class="hljs-string">"`r`n"</span></span> $table+= Get-LastImageBackupDatesTXT ($WinBackupRoot) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $table } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Email</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Report</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($SendInfo, $TXTonly=$false)</span></span></span></span>{ $Credential = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object -TypeName <span class="hljs-string"><span class="hljs-string">"System.Management.Automation.PSCredential"</span></span> ` -ArgumentList $SendInfo.Username, $SendInfo.SecurePassword <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($TXTonly) { Send-MailMessage -To $SendInfo.To -From $SendInfo.From ` -Subject $SendInfo.Subject -Body $SendInfo.MsgBody ` -SmtpServer $SendInfo.SmtpServer -Credential $Credential ` -Port $SendInfo.SmtpPort -Encoding UTF8 } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Send-MailMessage -To $SendInfo.To -From $SendInfo.From ` -Subject $SendInfo.Subject -BodyAsHtml $SendInfo.MsgBody ` -SmtpServer $SendInfo.SmtpServer -Credential $Credential ` -Port $SendInfo.SmtpPort } }</code> </pre><br> ,   Powershell, ,          CR/LF,   HTML ‚Äì  LF.       HTML-  MS Outlook. ,         ‚Äì    . <br><br>            ,     ,    ,   . <br><br>  <i>Send-Email-Report</i>  ¬´¬ª  <i>Send-MailMessage</i>    ,      ¬´ ¬ª   .       .NET   <i>¬´System.Management.Automation.PSCredential¬ª</i>        <i>Send-MailMessage</i> ,            .     (   )  ( <i>$Credential</i> )    ,       ¬´/¬ª.    ,      ,  ,                         <i>Get-Credential</i>        . ,      ,     ‚Äì        ‚Ä¶ <br><br>      .     ,    ,     ,    <i>$SendInfo</i> ,  -.       - <i>$TXTonly</i> ,         .            ‚Äì      . <br><br>       ,       . ,           ,    ‚Äì              . <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($txt) { $Ret = Get-LastWinBackupDatesTXT ($Root) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $Ret = Get-LastWinBackupDatesHTML ($Root) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($mail) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($SmtpSrv) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($Port) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($To) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($Fm) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($Pwd) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($Sub) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($Ret)) { $objArgs = @{ SmtpServer = $SmtpSrv SmtpPort = $Port To = $To.Split(<span class="hljs-string"><span class="hljs-string">','</span></span>) From = $Fm Username = $Fm SecurePassword = ConvertTo-SecureString -String $Pwd -AsPlainText -Force Subject = $Sub MsgBody = $Ret } Send-Email-Report ($objArgs, $txt) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Write-Host $Ret } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Write-Host $Ret }</code> </pre><br> , ,    ,   , :    ,        <i>$txt</i> ,       <i>Get-LastWinBackupDatesXXX</i> .   (,   )    <i>$Ret</i> .           ‚Äì   <i>Send-Email-Report</i> ,     -,       .       ,           ‚Äì       ()  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It remains to give examples of generated reports: </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hypertext format: </font></font></h4><hr><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup copies in "\\ sa-nas \ netbackup" </font></font></h4><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Date of report formation: 01/10/2017 09:00:01 </font></font></h4><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> File Mode Archives: </font></font></h4><br><table><tbody><tr><td><h4>  A machine </h4><br></td><td><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The most current archive </font></font></h4><br></td><td><h4>  Age </h4><br></td><td><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Was updated </font></font></h4><br></td><td><h4>  The size </h4><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-CHENG </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-10 040000 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10/01/2017 04:16:23 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6446 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-DOCTOR </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-10 080002 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10/01/2017 08:10:09 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2431 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-BAR </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2016-12-28 033001 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10/01/2017 02:36:35 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 248028 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-RECEPTION </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-10 060737 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10/01/2017 06:16:29 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1264 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-ECR </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-08 220005 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 01/09/2017 22:03:22 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2863 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-HOTELMGR </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-08 020003 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 01/09/2017 22:11:02 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 26788 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-ITO </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-06 230005 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 01/09/2017 23:08:48 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 17486 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-CHEF </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-05 230002 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 01/09/2017 23:02:11 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3791 MB </font></font><br></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SA-MASTER </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Backup Set 2017-01-09 102958 </font></font><br></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 days </font></font><br></td><td> 01/09/2017 23:12:51 <br></td><td> 8441  <br></td></tr><tr><td> SA-CONTROLLER <br></td><td> Backup Set 2017-01-09 000007 <br></td><td> 0  <br></td><td> 01/10/2017 00:17:04 <br></td><td> 9788  <br></td></tr></tbody></table><br><h4>   : </h4><br><table><tbody><tr><td><h4>  A machine </h4><br></td><td><h4>    </h4><br></td><td><h4>  Age </h4><br></td><td><h4>  </h4><br></td><td><h4>  The size </h4><br></td></tr><tr><td> SA-ITO <br></td><td> Backup 2017-01-10 020013 <br></td><td> 0  <br></td><td> 01/09/2017 23:12:44 <br></td><td> 47534  <br></td></tr><tr><td> POSSERVER <br></td><td> Backup 2017-01-10 020006 <br></td><td> 0  <br></td><td> 01/09/2017 23:07:36 <br></td><td> 23138  <br></td></tr></tbody></table><br><hr><br><h4>  : </h4><br><hr><br>    "\\sa-nas\netbackup" <br>   : 10.01.2017 09:00:01 <br><br>   : <br> : SA-CHENG;  : Backup Set 2017-01-10 040000; : 0  . (01/10/2017 04:16:23); : 6446  <br> : SA-DOCTOR;  : Backup Set 2017-01-10 080002; : 0  . (01/10/2017 08:10:09); : 2431  <br> : SA-BAR;  : Backup Set 2016-12-28 033001; : 0  . (01/10/2017 02:36:35); : 248028  <br> : SA-RECEPTION;  : Backup Set 2017-01-10 060737; : 0  . (01/10/2017 06:16:29); : 1264  <br> : SA-ECR;  : Backup Set 2017-01-08 220005; : 0  . (01/09/2017 22:03:22); : 2863  <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-HOTELMGR; Archive name: Backup Set 2017-01-08 020003; Updated: 0 days ago. (09/09/2017 22:11:02); Size: 26788 MB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-ITO; Archive name: Backup Set 2017-01-06 230005; Updated: 0 days ago. (09/09/2017 23:08:48); Size: 17486 MB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-CHEF; Archive name: Backup Set 2017-01-05 230002; Updated: 0 days ago. (09/09/2017 23:02:11); Size: 3791 MB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-MASTER; Archive name: Backup Set 2017-01-09 102958; Updated: 0 days ago. (09/09/2017 23:12:51); Size: 8441 MB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-CONTROLLER; Archive name: Backup Set 2017-01-09 000007; Updated: 0 days ago. (10/10/2017 00:17:04); Size: 9788 MB </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disk Volume Images:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: SA-ITO; Archive name: Backup 2017-01-10 020013; Updated: 0 days ago. (09/09/2017 23:12:44); Size: 47534 MB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine: POSSERVER; Archive name: Backup 2017-01-10 020006; Updated: 0 days ago. (09/09/2017 23:07:36); Size: 23138 MB</font></font><br><br><hr><br><h2>  Conclusion </h2><br>               ,       . ,         ‚Äì , , ,      ,   .          ,       . ,   ,             . ,   ,      ,     :      ,       . <br><br>        <a href="https://cloud.mail.ru/public/LijW/jbUekoj2U"></a> . <br><br>   ,   ,         -add-on'     ,  , ,   ,   ‚Äì NT Backup  ghettoVCB ( VMware ESXi). </div><p>Source: <a href="https://habr.com/ru/post/319378/">https://habr.com/ru/post/319378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319364/index.html">How IT professionals work. Alexander Matrosov, Cylance</a></li>
<li><a href="../319366/index.html">Information security on mobile devices - consumer view</a></li>
<li><a href="../319368/index.html">Using Node.js technology as a platform for optimizing server capacity</a></li>
<li><a href="../319370/index.html">Electronics development: from idea to device</a></li>
<li><a href="../319374/index.html">VPS-digest: 30 useful materials on Habr√© and not only</a></li>
<li><a href="../319380/index.html">Exploit Exercises or another site for VulnHub lovers</a></li>
<li><a href="../319382/index.html">How PVS-Studio looks for errors: methods and technologies</a></li>
<li><a href="../319384/index.html">Direct disk access from python (simhdd)</a></li>
<li><a href="../319386/index.html">Modal windows and notifications in Angular</a></li>
<li><a href="../319388/index.html">BLE under the microscope 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>