<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recognizing Android Things with ABBYY RTR SDK and django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Azat Kalmykov, I am a second year student of the ‚Äú Applied Mathematics and Computer Science ‚Äù faculty of the Faculty of Computer Sci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recognizing Android Things with ABBYY RTR SDK and django</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  My name is Azat Kalmykov, I am a second year student of the ‚Äú <a href="https://www.hse.ru/ba/ami/">Applied Mathematics and Computer Science</a> ‚Äù faculty of the Faculty of Computer Science of the National Research University Higher School of Economics and an intern at the mobile development department of ABBYY.  In this article I will tell you about my small project, completed as part of the summer internship. </p><br><img src="https://habrastorage.org/webt/xe/ck/gv/xeckgvbiddugjrh70y447trujkg.jpeg" align="left" width="800"><br><p>  Imagine a small conveyor.  It is driven by goods or some details on which it is important to recognize the text (perhaps this is some kind of unique identifier, or maybe something more interesting).  A good example would be the parcel.  The work of the conveyor is remotely controlled by the operator who monitors the problem and in which case solves the problem.  What can help him in this?  The device on the Android Things platform can be a good solution: it is mobile, easily configured and can work via Wi-Fi.  We decided to try to use <a href="https://www.abbyy.com/products/">ABBYY technologies</a> and find out how they are suitable for such situations - text recognition in the stream on ‚Äúnon-standard devices‚Äù from the Internet of Things category.  We will deliberately simplify many things, as we simply build a concept.  If it became interesting, welcome under cat. <a name="habracut"></a></p><br><h3 id="android-things">  Android Things </h3><br><p>  A great thing called <a href="https://www.youtube.com/watch%3Fv%3DrUfhg_nbdSk">Android Things Starter Kit</a> came to our office from the <a href="https://events.google.com/io/">Google I / O</a> conference at ABBYY.  Do not lose the good, and we wanted to play with it in the search for various scenarios for the use of our <a href="https://rtrsdk.com/">recognition libraries</a> .  First you need to assemble our device, and then run.  Make it easy, it is sufficient to strictly follow the instructions from the manufacturer. </p><br><p>  Read more about the platform <a href="https://developer.android.com/things/">here</a> and <a href="https://androidthings.withgoogle.com/">here</a> . </p><br><p>  <em>What came into my hands</em> <br><img src="https://habrastorage.org/webt/wf/jm/lo/wfjmlotr9yda08ipwalicle9dni.jpeg" alt="image"><br>  <em>And at the end of the post, I'll show you what the assembled device looks like.</em> </p><br><h3 id="chto-zhe-my-delaem">  What are we doing? </h3><br><p>  We will write an application for the Android Things platform, which will process the image from the camera, sending the recognized text and (periodically) frames to our server so that the conditional operator can understand what is happening on the pipeline.  The server will be written in django. </p><br><p>  I hasten to note that to carry out this project you will not need any investments, as well as registration and SMS (well, on AWS you will still need to register and get a free account). </p><br><h3 id="zapuskaem-raketu-v-kosmos-server">  Run <del>  rocket into space </del>  server </h3><br><p><img src="https://habrastorage.org/webt/wd/yn/dm/wdyndmafgjdclqwrxddq8cq2ej8.jpeg" align="right">  We assume that you already have a free AWS account.  We tie our card so that an evil Amazon, in the case of our rashness, writes off a couple of shekels from us.  Let's use AWS EC2 and create a virtual machine on Ubuntu Server 18.04 LTS (HVM) with SSD Volume Type.  For this OS and when using a free account, only one configuration is available, choose it (do not worry, one gigabyte of RAM is enough for us with a head).  Let's create an ssh-key (or use the one that is already ready) and try to connect to our machine.  We also create Elastic IP (something like static IP) and immediately link it to our machine.  Please note that Elastic IP, which is not tied to any virtual machine, will cost you money during development. </p><br><p>  Connect to the server.  Install the necessary toolkit on the machine. </p><br><p>  Python third version preinstalled.  The case is left for small. </p><br><pre><code class="bash hljs">$ sudo apt-get update $ sudo apt-get install python3-pip $ sudo pip3 install virtualenv</code> </pre> <br><p>  Install the docker, we will need it later. </p><br><pre> <code class="bash hljs">$ sudo apt-get install docker.io</code> </pre> <br><p>  You also need to open port 8000. We will contact him when using the web service.  Port 22 for ssh is open by default. </p><br><p>  Hooray!  Now we have a remote computer to run our applications.  We will write the code directly on the server. </p><br><h4 id="django--channels">  Django (+ channels) </h4><br><p>  I decided to use django, as this will allow you to quickly and easily create a small web service.  The additional library django channels will give us the opportunity to work with web sockets (namely, to make <del>  crutch </del>  broadcast through the transfer of pictures without updating the page). </p><br><p>  Create a directory in which we place the project.  Install django along with django channels, without deviating from the instructions in the <a href="https://channels.readthedocs.io/en/latest/installation.html">documentation</a> . </p><br><pre> <code class="bash hljs">$ mkdir Project $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Project $ virtualenv venv $ <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> venv/bin/activate $ pip install -U channels <span class="hljs-comment"><span class="hljs-comment">#       django $ pip install channels_redis #    Redis $ pip install djangorestframework $ django-admin startproject mysite $ cd mysite</span></span></code> </pre> <br><p>  Create a project.  We will have 3 subdirectories.  The main one will have the same name - mysite (automatically created), the other two - streaming and uploading.  The first will be responsible for displaying information on the web page, and the second - for downloading through the REST API. </p><br><pre> <code class="bash hljs">$ python3 manage.py startapp streaming $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> streaming $ rm -r migrations admin.py apps.py models.py tests.py $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. $ python3 manage.py startapp uploading $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> uploading $ rm -r migrations admin.py apps.py models.py tests.py</code> </pre> <br><p>  We configure django channels.  Comment out the line with WSGI_APPLICATION and add a new one with ASGI_APPLICATION.  Now our application will work asynchronously. </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/settings.py # ... # WSGI_APPLICATION = ... ASGI_APPLICATION = 'mysite.routing.application' # ...</span></span></code> </pre> <br><p>  Also update the value of the INSTALLED_APPS list. </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/settings.py # ... INSTALLED_APPS = [ 'channels', 'streaming', 'uploading', 'rest_framework', 'django.contrib.admin', 'django.contrib.auth', 'django.contrib.contenttypes', 'django.contrib.sessions', 'django.contrib.messages', 'django.contrib.staticfiles', ] # ...</span></span></code> </pre> <br><h4 id="arhitektura">  Architecture </h4><br><p>  We will write the code based on the <a href="https://channels.readthedocs.io/en/latest/tutorial/index.html">official</a> django channels <a href="https://channels.readthedocs.io/en/latest/tutorial/index.html">tutorial</a> .  The structure of our small service will look like this: </p><br><p>  MYIP: 8000 / frame - a web page that will show the result, conventionally, the page that the operator is looking at <br>  MYIP: 8000 / upload / upload_text / - address for the POST request, send the recognized text <br>  MYIP: 8000 / upload / upload_image / - address for a PUT request, send individual images </p><br><p>  It is necessary to register this logic in the urls.py files of the respective directories. </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/mysite/urls.py from django.contrib import admin from django.conf.urls import include, url urlpatterns = [ url(r'^frame/', include('streaming.urls')), url(r'^upload/', include('uploading.urls')), ]</span></span></code> </pre> <br><h4 id="rest-api">  REST API </h4><br><p>  We proceed to the description of the logic of our API. </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/uploading/urls.py from django.conf.urls import url from rest_framework.urlpatterns import format_suffix_patterns from . import views urlpatterns = [ url(r'^upload_text/$', views.UploadTextView.as_view()), url(r'^upload_image/$', views.UploadImageView.as_view()), ] urlpatterns = format_suffix_patterns(urlpatterns)</span></span></code> </pre> <br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/uploading/views.py from django.shortcuts import render from rest_framework.views import APIView from rest_framework.response import Response from channels.layers import get_channel_layer from rest_framework.parsers import FileUploadParser from asgiref.sync import async_to_sync import base64 # Create your views here. class UploadTextView(APIView): def post(self, request, format=None): message = request.query_params['message'] if not message: raise ParseError("Empty content") channel_layer = get_channel_layer() async_to_sync(channel_layer.group_send)("chat", { "type": "chat.message", "message": message, }) return Response({'status': 'ok'}) class UploadImageView(APIView): parser_class = (FileUploadParser,) def put(self, request, format=None): if 'file' not in request.data: raise ParseError("Empty content") f = request.data['file'] channel_layer = get_channel_layer() async_to_sync(channel_layer.group_send)("chat", { "type": "chat.message", "image64": base64.b64encode(f.read()).decode("ascii"), }) return Response({'status': 'ok'})</span></span></code> </pre> <br><h4 id="veb-stranichka">  Webpage </h4><br><p>  All information will fit on one page, so the logic will be simple. </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/streaming/urls.py from django.conf.urls import url from . import views urlpatterns = [ url(r'^', views.index, name='index'), ]</span></span></code> </pre> <br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/streaming/views.py from django.shortcuts import render from django.utils.safestring import mark_safe import json # Create your views here. def index(request): return render(request, 'index.html', {})</span></span></code> </pre> <br><p>  We need to write a small html document to display the results.  It will have a built-in script for connecting to a web socket and filling content. </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- mysite/streaming/templates/index.html --&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Live from Android Things<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat-log"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cols</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"frame"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> chatSocket = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> WebSocket( </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'ws://'</span></span></span><span class="javascript"> + </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.location.host + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'/ws/chat/'</span></span></span><span class="javascript">); chatSocket.onmessage = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">e</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> data = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">JSON</span></span></span><span class="javascript">.parse(e.data); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> message = data[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">]; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> image64 = data[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'image64'</span></span></span><span class="javascript">]; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (image64) { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.querySelector(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'#frame'</span></span></span><span class="javascript">).setAttribute( </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'src'</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'data:image/png;base64,'</span></span></span><span class="javascript"> + image64 ); } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (message) { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.querySelector(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'#chat-log'</span></span></span><span class="javascript">).value += (message + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'\n'</span></span></span><span class="javascript">); } }; chatSocket.onclose = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">e</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.error(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'Chat socket closed unexpectedly'</span></span></span><span class="javascript">); }; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h4 id="nastroyka-routing-soketov">  Setting up routing, sockets </h4><br><p>  How best to translate the word routing into Russian?  Let's try to get this question out of our mind and just tune it (or her). </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/mysite/settings.py # ... ALLOWED_HOSTS = ['*'] #  []  ['*'],    # ... CHANNEL_LAYERS = { 'default': { 'BACKEND': 'channels_redis.core.RedisChannelLayer', 'CONFIG': { "hosts": [('127.0.0.1', 6379)], }, }, }</span></span></code> </pre> <br><p>  Now you need to register the logic of ‚Äúforwarding‚Äù (the routing.py files are similar to the urls.py files, only now for web sockets). </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/mysite/routing.py from channels.auth import AuthMiddlewareStack from channels.routing import ProtocolTypeRouter, URLRouter import streaming.routing application = ProtocolTypeRouter({ # (http-&gt;django views is added by default) 'websocket': AuthMiddlewareStack( URLRouter( streaming.routing.websocket_urlpatterns ) ), })</span></span></code> </pre> <br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/streaming/routing.py from django.conf.urls import url from . import consumers websocket_urlpatterns = [ url(r'^ws/chat/$', consumers.FrameConsumer), ]</span></span></code> </pre> <br><p>  And now we are implementing FrameConsumer itself at consumers.py </p><br><pre> <code class="django hljs"><span class="xml"><span class="xml"># mysite/streaming/consumers.py from asgiref.sync import async_to_sync from channels.generic.websocket import WebsocketConsumer, JsonWebsocketConsumer import json class FrameConsumer(WebsocketConsumer): def connect(self): self.room_group_name = 'chat' # Join room group async_to_sync(self.channel_layer.group_add)( self.room_group_name, self.channel_name ) self.accept() def disconnect(self, close_code): # Leave room group async_to_sync(self.channel_layer.group_discard)( self.room_group_name, self.channel_name ) # Receive message from WebSocket def receive(self, text_data): text_data_json = json.loads(text_data) message = text_data_json['message'] # Send message to room group async_to_sync(self.channel_layer.group_send)( self.room_group_name, { 'type': 'chat_message', 'message': message } ) # Receive message from room group def chat_message(self, event): if 'message' in event: # Send message to WebSocket self.send(text_data=json.dumps({ 'message': event['message'] })) elif 'image64' in event: self.send(text_data=json.dumps({ 'image64': event['image64'] }))</span></span></code> </pre> <br><p>  And finally, with sweaty palms run. </p><br><pre> <code class="bash hljs">$ docker run -p 6379:6379 -d redis:2.8 $ python manage.py runserver 0.0.0.0:8000</code> </pre> <br><h3 id="a-teper-sobstvenno-pro-android">  And now actually about Android </h3><br><p><img src="https://habrastorage.org/webt/rj/ce/rz/rjcerzjdlgxfnn9puhl3cjg2seu.jpeg" align="right">  We will use the <a href="https://rtrsdk.com/">RTR SDK from ABBYY</a> for text recognition.  Ultimate pack RTR SDK for our purposes can be downloaded <a href="https://rtrsdk.com/licensing/">here</a> .  We implement a fairly simple interface for processing frames, our application will be based on a sample from the archive downloaded from the previous link (/ sample-textcapture).  We will remove extra parts from the application, we will slightly polish it to work with Android Things and implement communication with the server. </p><br><p>  The library file .aar is in the libs directory of the downloaded archive, we import.  Copy the contents of the assets folder of the archive (there are essentially files necessary for the recognition process itself) in the assets of our project.  There we copy the license file from the archive, without it the application will not start. </p><br><p>  In order to implement the ABBYY RTR SDK functionality we need, we need to create an object of type Engine, and with the help of it we need an object of type ITextCaptureService, which we will launch later. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mEngine = Engine.load(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, LICENSE_FILE_NAME); mTextCaptureService = mEngine.createTextCaptureService(textCaptureCallback); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  In this case, you need to pass an object of type ITextCaptureService.Callback, create it directly in our MainActivity class, it must implement 3 methods. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ITextCaptureService.Callback textCaptureCallback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ITextCaptureService.Callback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRequestLatestFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] buffer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,       . //    . mCamera.addCallbackBuffer(buffer); } @Override public void onFrameProcessed( ITextCaptureService.TextLine[] lines, ITextCaptureService.ResultStabilityStatus resultStatus, ITextCaptureService.Warning warning) { //      ,    if (resultStatus.ordinal() &gt;= 3) { //   ,     mSurfaceViewWithOverlay.setLines(lines, resultStatus); } else { //  ,     mSurfaceViewWithOverlay.setLines(null, ITextCaptureService.ResultStabilityStatus.NotReady); } //  warnings // ... } @Override public void onError(Exception e) { //    } };</span></span></code> </pre> <br><p>  We delegated the receipt of the frame to the camera object.  I'll show you what's going on inside. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Camera.PreviewCallback cameraPreviewCallback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Camera.PreviewCallback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPreviewFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, Camera camera)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     (    ) if (!mIsUploading) { mIsUploading = true; //    new UploadImageTask(mCameraPreviewSize.width, mCameraPreviewSize.height).execute(data); } //     mTextCaptureService.submitRequestedFrame(data); } };</span></span></code> </pre> <br><p>  To send messages, we will write a couple of classes, which in turn will delegate their work to the Uploader class object. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadTextTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... params)</span></span></span><span class="hljs-function"> </span></span>{ mUploader.uploadText(params[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadImageTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mCameraPreviewWidth; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mCameraPreviewHeight; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UploadImageTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height)</span></span></span><span class="hljs-function"> </span></span>{ mCameraPreviewWidth = width; mCameraPreviewHeight = height; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]... params)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] jpegBytes = convertToJpegBytes(params[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jpegBytes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mUploader.uploadImage(jpegBytes); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] convertToJpegBytes(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] rawBytes) { YuvImage yuvImage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YuvImage( rawBytes, ImageFormat.NV21, mCameraPreviewWidth, mCameraPreviewHeight, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (ByteArrayOutputStream os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream()) { yuvImage.compressToJpeg( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, mCameraPreviewWidth, mCameraPreviewHeight), <span class="hljs-number"><span class="hljs-number">40</span></span>, os ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> os.toByteArray(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"compress error"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Communication with the network in the Uploader class is implemented using the convenient OkHttp3 library.  It allows you to greatly simplify the interaction with the server. </p><br><h3 id="rezultat">  Result </h3><br><p>  We get a working client-server application with ABBYY recognizer built into the Internet of Things - isn‚Äôt it cool? </p><br><p>  <em>Assembled device and small native advertising of my employer</em> <br><img src="https://habrastorage.org/webt/7t/x1/hp/7tx1hpdekcwi6dwn7_mygnqxoqk.jpeg" alt="image"></p><br><p>  <em>Text recognized</em> <br><img src="https://habrastorage.org/webt/ow/d-/ha/owd-ha1je23vvghfz8ceupg9iks.jpeg" alt="image"></p><br><p>  <em>Selfie panorama with an overview of multiple devices</em> <br><img src="https://habrastorage.org/webt/b0/pk/em/b0pkemwybvudykjrient8vfknwa.jpeg" alt="image"></p><br><p>  <em>Vidos, how it may look like in real life</em> </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/cnzVXyWAYiQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Repositories on github: </p><br><p>  ‚Üí <a href="https://github.com/CookiesDeathCookies/AndroidThingsTextRecognition-Backend">AndroidThingsTextRecognition-Backend</a> <br>  ‚Üí <a href="https://github.com/CookiesDeathCookies/AndroidThingsTextRecognition-Android">AndroidThingsTextRecognition-Android</a> </p><br><p>  Take and use! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/432514/">https://habr.com/ru/post/432514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432502/index.html">The Internet can have serious problems due to languages ‚Äã‚Äãlike C and C ++ that contribute to the appearance of vulnerabilities.</a></li>
<li><a href="../432506/index.html">Microsoft Connect (); 2018: All Cloud Conference Announcements</a></li>
<li><a href="../432508/index.html">On the barriers to the use of sign systems in artificial intelligence</a></li>
<li><a href="../432510/index.html">The market share of plug-in electric vehicles in Norway has almost reached a new maximum.</a></li>
<li><a href="../432512/index.html">PostgreSQL: PipelineDB - aggregate queries in real time</a></li>
<li><a href="../432516/index.html">Broaden your horizons, Holmes! Or why physicists have a violin and culinary skills</a></li>
<li><a href="../432518/index.html">Electron and the decline of native applications</a></li>
<li><a href="../432520/index.html">How to change admin user password in Atlassian Jira and Confluence in embedded database (H2)</a></li>
<li><a href="../432524/index.html">Why you should never use Quora again</a></li>
<li><a href="../432526/index.html">Evaluation of new projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>