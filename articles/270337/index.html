<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MagOS in industrial application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In carrying out this work, the task was set of minimizing the time for servicing the network from a large number of Linux machines. 

 1. Basic descri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MagOS in industrial application</h1><div class="post__text post__text-html js-mediator-article">  <i>In carrying out this work, the task was set of minimizing the time for servicing the network from a large number of Linux machines.</i> <br><br>  <a href="https://habr.com/ru/post/270337/">1. Basic description of basic principles</a> <br>  <a href="https://habr.com/ru/post/270337/">1.1.</a>  <a href="https://habr.com/ru/post/270337/">MagOS application.</a> <br>  <a href="https://habr.com/ru/post/270337/">1.2.</a>  <a href="https://habr.com/ru/post/270337/">Technology.</a> <br>  <a href="https://habr.com/ru/post/270337/">1.3.</a>  <a href="https://habr.com/ru/post/270337/">The choice of basic distribution.</a> <br>  <a href="https://habr.com/ru/post/270337/">2. Network structure.</a> <br>  <a href="https://habr.com/ru/post/270337/">2.1.</a>  <a href="https://habr.com/ru/post/270337/">Magos-server.</a> <br>  <a href="https://habr.com/ru/post/270337/">3. Configure the bootloader.</a> <br>  <a href="https://habr.com/ru/post/270337/">3.1.</a>  <a href="https://habr.com/ru/post/270337/">Bootloader strings</a> <br>  <a href="https://habr.com/ru/post/270337/">3.2.</a>  <a href="https://habr.com/ru/post/270337/">Options that have been used.</a> <br>  <a href="https://habr.com/ru/post/270337/">3.3.</a>  <a href="https://habr.com/ru/post/270337/">Options that can be used.</a> <br>  <a href="https://habr.com/ru/post/270337/">3.4.</a>  <a href="https://habr.com/ru/post/270337/">Features network boot.</a> <br>  <a href="https://habr.com/ru/post/270337/">4. The order of system initialization.</a> <br>  <a href="https://habr.com/ru/post/270337/">4.1.</a>  <a href="https://habr.com/ru/post/270337/">The structure of the basecfg.ini configuration file by default.</a> <br>  <a href="https://habr.com/ru/post/270337/">4.2.</a>  <a href="https://habr.com/ru/post/270337/">The structure of the system directory.</a> <br>  <a href="https://habr.com/ru/post/270337/">4.3.</a>  <a href="https://habr.com/ru/post/270337/">Implementation.</a> <br>  <a href="https://habr.com/ru/post/270337/">5. MagOS server.</a> <br>  <a href="https://habr.com/ru/post/270337/">5.1.</a>  <a href="https://habr.com/ru/post/270337/">General information.</a> <br>  <a href="https://habr.com/ru/post/270337/">5.2.</a>  <a href="https://habr.com/ru/post/270337/">Network settings.</a> <br>  <a href="https://habr.com/ru/post/270337/">5.3.</a>  <a href="https://habr.com/ru/post/270337/">Configure services.</a> <br>  <a href="https://habr.com/ru/post/270337/">5.4.</a>  <a href="https://habr.com/ru/post/270337/">Repository of programs.</a> <br>  <a href="https://habr.com/ru/post/270337/">5.5.</a>  <a href="https://habr.com/ru/post/270337/">Additional server data</a> <br>  <a href="https://habr.com/ru/post/270337/">5.6.</a>  <a href="https://habr.com/ru/post/270337/">Monitoring</a> <br>  <a href="https://habr.com/ru/post/270337/">6. Custom modules.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.1.</a>  <a href="https://habr.com/ru/post/270337/">General principles for creating custom modules.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.2.</a>  <a href="https://habr.com/ru/post/270337/">How many modules do.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.3.</a>  <a href="https://habr.com/ru/post/270337/">Modules for special purposes.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.4.</a>  <a href="https://habr.com/ru/post/270337/">Restrictions for modules.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.5.</a>  <a href="https://habr.com/ru/post/270337/">Instructions for the creation of modules.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.6.</a>  <a href="https://habr.com/ru/post/270337/">System update module.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.7.</a>  <a href="https://habr.com/ru/post/270337/">Office software installation module.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.8.</a>  <a href="https://habr.com/ru/post/270337/">Module with utilities and servers.</a> <br>  <a href="https://habr.com/ru/post/270337/">6.9.</a>  <a href="https://habr.com/ru/post/270337/">System Settings Module.</a> <br>  <a href="https://habr.com/ru/post/270337/">7. Scripts.</a> <br>  <a href="https://habr.com/ru/post/270337/">7.1.</a>  <a href="https://habr.com/ru/post/270337/">Add-ons for magos-patches.</a> <br>  <a href="https://habr.com/ru/post/270337/">7.2.</a>  <a href="https://habr.com/ru/post/270337/">OS installation script.</a> <br>  <a href="https://habr.com/ru/post/270337/">7.3.</a>  <a href="https://habr.com/ru/post/270337/">Inclusion scripts in AD.</a> <br>  <a href="https://habr.com/ru/post/270337/">7.4.</a>  <a href="https://habr.com/ru/post/270337/">System management (/ root / bin).</a> <br>  <a href="https://habr.com/ru/post/270337/">7.5.</a>  <a href="https://habr.com/ru/post/270337/">Additional scripts that fix the work of the magos programs and the operating system.</a> <br>  <a href="https://habr.com/ru/post/270337/">8. Instructions for technicians.</a> <br><a name="habracut"></a><br><a name="1"></a><h4>  Basic description of the basic principles </h4><br><a name="1-1"></a><h5>  MagOS Application </h5><br>  MagOS is a specific build of a distribution kit selected from an extensive list.  Live distributions of Magea, Mandriva, Rosa, Ubuntu, Debian, Fedora, AltLinux, etc. can be used as the basis for building the build.  The specific elements of MagOS are a modified kernel (to support AUFS), a specially created initrd (using UIRD) and an additional set of scripts designed to manage MagOS. <br><br>  MagOS allows you to create a full-fledged operating system based on the Live builds of various distributions (builds designed for booting from CDs, DVDs).  The specific use of MagOS provides a whole range of additional benefits of this approach: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Very simple restoration of the system to its original state.  It can be compared with the technology of working with equipment, when the introduction of a special command allows you to reset all user-made settings and bring the system to its original state.  Here, the same effect is achieved by the destruction of data in the sections in which user data is stored.  Thus, this option of installing the distribution becomes simply indispensable when used in the educational process.  To the above, you need to add the ability to install the distribution on a flash drive, which allows the student or student to use it not only in the classroom, but also at home. <br><br>  The second most important advantage of the distribution is the ability to pre-configure the system.  It is achieved by including all the necessary configuration files with parameters in the immutable part of the distribution, the so-called modules.  Using this technology, we minimize the number of administrator actions after installing the system on a user's computer.  This opportunity can be used not only for the organization of computer classes, but also among industrial enterprises, reducing to the possible minimum labor costs for installation and configuration when working with a large number of users' computers. <br><br>  The third advantage is the ease of installation and updating of such an operating system assembly, which is reduced to partitioning the disk, creating file systems, copying a set of files to a computer and installing a bootloader.  In industrial applications, all specified operations can be performed automatically when the corresponding script is run.  Updating an installed distribution package also comes down to copying files, which can be done automatically, for example, when you turn off your computer. <br><br>  The separate advantages include the possibility of network download distribution, including from the Internet. <br><br>  The unrealized capabilities of MagOS include the inability to store user data on a secure distributed file system.  The implementation of such a distributed file system will ensure full reentrancy of users. <br><br>  Some background information about MagOS can be obtained from the article: <a href="http://habrahabr.ru/post/195710/">MagOS Linux (September release)</a> . <br><a name="1-2"></a><h5>  Technology </h5><br>  A modification of the Linux kernel included in MagOS is to enable the patch with the AUFS file system.  AUFS allows you to connect external file systems to the file system using the loopback interface, collecting the resulting file system like a layer cake.  Intermediate layers of such a resulting file system are connected, most often, in RO mode (read only), and the uppermost layer, as a rule, is connected in RW mode (read-write) and projected onto a disk file system, which can be placed as in RAM , on a physical disk, in a disk image, and stored during a shutdown operation in a special module that is connected using the SquashFS file system. <br><br>  The SquashFS file system allows you to perform compression using a block algorithm, preserving all file system attributes.  In MagOS, it is used to create loadable modules with images of layers of the AUFS file system.  The block compression algorithm allows you to not unpack the entire module files, if necessary, to extract data from them. <br><br>  In MagOS, an initrd disk image used to boot Linux on most distributions is used to organize the system.  There are scripts that create a "layered" file system distribution, processing configuration files, etc. <br><br>  The data required for setting up the system is transmitted through the kernel parameters of the operating system, which are written in the grub4dos / grub2 / syslinux bootloader, and using the special configuration file MagOS.ini.  Where and what parameters are transferred is described in the documentation.  Parameters related to the general configuration of the operating system are transferred using kernel parameters.  They are organized into a system of parameters Unified Init Ram Disk (uird). <br><br>  The description of the parameters is given on the project website: <a href="http://neobht.github.io/uird/">UIRD</a> .  Used distribution <a href="http://magos.sibsau.ru/repository/netlive/multi/">Magos multi</a> . <br><br>  In industrial applications, you cannot do without a server that contains a distribution kit and supports HTTP (for remote download), TFTP (remote boot by PXE), SSH (for file management) and RSYNC (for installing and updating the OS on users' computers).  The server can be implemented on any distribution, including MagOS.  In my case, a virtual container based on the CentOS 6 distribution was used. <br><br>  To manage the system, the necessary options and scripts that process them were added to MagOS. <br><br><a name="1-3"></a><h5>  Choosing a base distribution </h5><br>  The choice of the distribution kit on the basis of which the network is built is always a complex and ambiguous task.  Choosing one or another distribution kit has to take into account many factors, including many local problems.  We had the following factors: very unproductive users' computers, although they were acquired quite recently, they saved money on computers, therefore, in a typical machine, at which the user sits only 2 Gigabytes of RAM and a dual-core Celeron with not very high clock speeds.  Such a typical configuration of a user's computer imposes restrictions on the choice of a desktop manager, in particular, using KDE is no longer possible without losing the possibility of comfortable user experience. <br><br>  Secondly, this is a problem of unqualified personnel, the main function of which is, by no means, computer work.  It is necessary to remember about the long-term habit of one single operating system, with which people have had to work for many years - Windows XP, whose support has been discontinued, which is why the problem of replacing the OS in users' workstations has been a problem. <br><br>  Exploring the possibility of adapting the appearance of the desktop to the appearance of the good old XP, we decided to stop at Cinnamon.  Despite the fact that the development has not yet been released, in the standard configuration this desktop works quite stable and quite easily adapts to the appearance of XP by installing the appropriate theme.  An additional factor influencing the OS choice was the ‚Äúwish‚Äù of the State structures to see computers with a domestic operating system at workplaces.  So the whole choice, in our case, came down to the choice between the Rosa OS and the Alt Linux OS. <br><br>  Despite considerable experience with Rosa, comparing AltLinux and Rosa distributions was not in favor of Rosa.  First of all, due to the lack of Cinnamon in LiveDVD, and secondly, due to the decline in the quality of the distribution in recent times. <br><br>  Thus, the development of AltLinux was chosen as the basis for creating the assembly - one of the assemblies of the P7 starter kit, containing the <a href="http://mirror.yandex.ru/altlinux-starterkits/permalink/">Cinnamon</a> desktop.  The positive side of this choice is the minimum composition of the set, which allows you to expand it at your discretion. <br><br><a name="2"></a><h4>  <b>Network structure</b> </h4><br><a name="2-1"></a><h5>  <b>Magos-server</b> </h5><br>  In the enterprise network there is a virtualization server on which the Magos-server was deployed.  The server performs several functions. <br><br>  First, it serves as a remote boot server.  Remote download is implemented using TFTP and allows you to download MagOS in the same configuration that is used to work on workstations.  Using this boot, you can test the hardware, install the operating system on a workstation, and perform many other tasks.  In addition, using the remote boot server, Clonezilla and Memtest images are downloaded. <br><br>  Remote loading of the workstation under MagOS control is performed via the HTTP protocol, for which Lighttpd is installed on the server, whose DocumentRoot points to the MagOS repository. <br><br>  The distribution kit is installed on the workstation and the workstations are updated using the RSYNC protocol.  Therefore, rsyncd is installed on the server. <br><br>  The server is controlled by the SSH protocol.  According to the same protocol, on the server, changes of program modules are being prepared, prepared on a test computer. <br><br>  This computer is equipped with 4Gb of memory, because there were problems with the creation of modules with less memory. <br><br><h6>  <b><i>Network integration</i></b> </h6><br>  Deployed AD based on Windows 2008 SP2 and all computers on the network are included in AD.  No exception and computers running Linux. <br><br><a name="3"></a><h4>  <b>Bootloader configuration</b> </h4><br><a name="3-1"></a><h5>  <b>Bootloader strings</b> </h5><br><pre><code class="bash hljs">title AltLinux i586 cinamon save <span class="hljs-comment"><span class="hljs-comment">#find --set-root --ignore-floppies --ignore-cd /MagOS/MagOS.sgn kernel /AltLinux/kernel/i586/vmlinuz uird.ro=*.xzm,*/live uird.from=/AltLinux/iso/altlinux-p7-cinnamon-latest-i586.iso;/AltLinux/modules/i586/ uird.load=* root=uird rw findswap vga=788 quiet plymouth.enable=0 uird.home=/dev/sda3/AltLinux-Data/homes/ uird.changes=/dev/sda3/AltLinux-Data/changes/ users initrd /AltLinux/kernel/i586/uird.soft.cpio.xz /AltLinux/kernel/i586/uird.magos.cpio.xz</span></span></code> </pre> <br><a name="3-2"></a><h5>  <b>Options that have been used</b> </h5><br>  Due to the multiplicity of the kernel parameters, the prefix of the parameters 'uird' (Unified Init Ram Disk) was introduced to highlight the MagOS parameters. <br><br><pre> <code class="bash hljs">uird.ro=*.xzm,*/live</code> </pre><br>  <b>uird.ro</b> - <b>MagOS</b> Parameter.  Specifies a filter for modules that are mounted in RO mode.  As such, the modules themselves are MagOS and LiveDVD AltLinux itself. <br><br><pre> <code class="bash hljs">uird.from=/AltLinux/iso/altlinux-p7-cinnamon-latest-i586.iso;/AltLinux/modules/i586/</code> </pre><br>  <b>uird.from</b> - <b>MagOS</b> parameter.  List of sources on which the modules for the system are located.  This is an indication of the path for loading modules and the distribution itself. <br><br><pre> <code class="bash hljs">uird.load=*</code> </pre><br>  <b>uird.load</b> - <b>MagOS</b> Parameter.  Filter for modules that need to be connected at boot time. <br><br><pre> <code class="bash hljs">root=uird</code> </pre><br>  <b>root</b> - Kernel parameter.  Specify the root file system. <br><br><pre> <code class="bash hljs">rw</code> </pre><br>  <b>rw</b> - enable read / write mode. <br><br><pre> <code class="bash hljs">findswap</code> </pre><br>  <b>findswap</b> - <b>MagOS</b> Parameter.  Forces the system to automatically connect Swap.  If the system has a Linux Swap partition, then it connects.  Otherwise, the Windows swap file is searched. <br><br><pre> <code class="bash hljs">vga=788</code> </pre><br>  <b>vga</b> - Kernel parameter.  Enable graphics mode. <br><br><pre> <code class="bash hljs">quiet</code> </pre><br>  <b>quiet</b> - Kernel parameter, indicates the need to create a dmesg log. <br><br><pre> <code class="bash hljs">plymouth.enable=0</code> </pre><br>  <b>plymouth.enable</b> - Kernel parameter.  Manages the graphical display and logging at the time of loading the operating system. <br><br><pre> <code class="bash hljs">uird.home=/dev/sda3/AltLinux-Data/homes/</code> </pre><br>  <b>uird.home</b> - <b>MagOS</b> Parameter.  Specifies the source of user home directories.  Due to an error in the existing version of MagOS, a full path specification is required, including the indication of the device. <br><br><pre> <code class="bash hljs">uird.changes=/dev/sda3/AltLinux-Data/changes/</code> </pre><br>  <b>uird.changes</b> - <b>MagOS</b> Parameter.  Specifies the source on which persistent changes to the root file system will be stored. <br><br><pre> <code class="bash hljs">users</code> </pre><br>  <b>users</b> - Kernel parameter. <br><br><a name="3-3"></a><h5>  <b>Options that can be used</b> </h5><br>  It is possible to use encryption for data stored on the hard disk.  In this case, instead of saving data to partitions, you should use saving to disk images.  Images should take the following form: <br><br><pre> <code class="bash hljs"> *.RWM.ENC - RW   *.ROM.ENC - RO  </code> </pre><br>  <b>uird.copy2ram [+] =</b> - filter for modules that are copied to RAM.  It can be used to speed up work in the presence of a significant amount of RAM. <br>  <b>uird.copy2cache [+] =</b> - filter for modules that are copied to the cache. <br>  <b>uird.cache [+] =</b> - sources to which the modules should be synchronized. <br><br>  It is possible to use CASH instead of synchronizing MagOS files with the server when the computer is turned off.  The disadvantages of the method include the fact that the exchange with the server is performed via HTTP, which in itself significantly reduces speed.  The second disadvantage is that there is a difficulty in splitting the update objects - the MagOS.ini file, the boot partition and the OS partition itself.  It should be noted that the layer-cache cache level and the corresponding uird.cache parameter used to synchronize remote repositories to local or private (INTRANET) repositories, as well as to update the system, should be set as follows: <br><br><pre> <code class="bash hljs">uird.cache=/MagOS/cache;/MagOS-Data/cache;/MagOS-Data/netlive</code> </pre><br>  Here, each source is assigned its own directory. <br><br>  <b>uird.netfsopt [+] =</b> - additional options for mounting network file systems: sshfs, nfs, curlftpfs, cifs. <br><br>  Using the specified file systems, you can later connect network file systems with user data partitions. <br><br>  <b>uird.noload [+] =</b> - filter for modules that need to be skipped during loading <br>  You can selectively disable certain modules for individual computers or networks. <br>  <b>uird.homes [+] =</b> - sources that store user home directories (combined by AUFS). <br><br>  In essence, here you enter the layer-homes user's home directories and the corresponding parameter: uird.homes: <br><br><pre> <code class="bash hljs">uird.homes=/MagOS-Data/homes;/MagOS-Data/home.img;nfs://magos.sibsau.ru/homes/n/e/myuser</code> </pre><br>  All user directories from various sources are cascaded-combined by AUFS and mounted on / home.  The first source is of higher priority, then, in the order of listing, priority is reduced.  If the source is set by the parameter uird.home =, then the source is mounted in / home.  Thus, there is the possibility of a multiple connection of the home folder with the imposition of different file systems.  Can be used for network placement of users' home folders. <br><br>  <b>Types of sources:</b> <br>  <b><code>/path/dir</code></b> - directory on any available media; <br>  <b><code>/dev/[..]/path/dir</code></b> - directory on the specified media; <br>  <b><code>file-dvd.iso, file.img</code></b> - disk image (ISO, block device image); <br> <b><code><a href="http://server/path/"></a> server/path‚Ä¶</code></b>  <b><code><a href="http://server/path/"></a> server/path‚Ä¶</code></b> - source available via HTTP (using httpfs); <br>  <b><code>ssh://server/path/‚Ä¶</code></b> - source available via SSH (using sshfs); <br> <b><code><a href=""></a> server/path‚Ä¶</code></b>  <b><code><a href=""></a> server/path‚Ä¶</code></b> - source available via FTP (using curlftpfs); <br>  <b><code>nfs://server/path/‚Ä¶</code></b> - source accessible via NFS; <br>  <b><code>cifs://server/path/‚Ä¶</code></b> - source available via CIFS; <br>  <b><code>uird.machines=</code></b> - the source where machine-dependent persistent changes are stored. <br><br>  It is possible to use machine-dependent resources for changes, which is necessary to ensure user reentrancy. <br><br><a name="3-4"></a><h5>  <b>Network boot features</b> </h5><br>  The following parameters are used for network booting: <br><br><pre> <code class="bash hljs">kernel images/vmlinuz uird.ro=*.xzm,*/live uird.from=http://magos-server.mydomain.local/magos/AltLinux/iso/alt linux-p7-cinnamon-latest-i586.iso;http://magos-server.mydomain.local/magos/AltLinux/modules/i586/ uird.load=* root=uird rw findswap vga=788 quiet plymouth.enable=0 users</code> </pre><br>  These are the same parameters, but you should pay attention to the indication of the parameter uird.from: <br><br><pre> <code class="bash hljs">uird.from=http://magos-server.mydomain.local/magos/AltLinux/iso/altlinux-p7-cinnamon-latest-i586.iso;http://magos-server.mydomain.local/magos/AltLinux/modules/i586/</code> </pre><br>  Here you can see the full http url of the server from which the OS is being loaded.  The base layer-base level and the corresponding parameter uird.from can be set as follows: <br><br><pre> <code class="bash hljs">uird.from=/MagOS;/MagOS-Data;MagOS.iso;http://magos.sibsau.ru/repository/netlive/2014.64/MagOS</code> </pre><br><a name="4"></a><h4>  <b>System Initialization Order</b> </h4><br><ul><li>  The configuration file is searched for by the path specified in the uird.basecfg parameter. </li><li>  Parameters are set from the configuration file that are not yet set in the kernel parameters. </li><li>  Base-level sources are mounted in the order specified in the parameter uird.from. </li><li>  The cache level sources are mounted in the order specified in the uird.cache parameter. </li><li>  There is a mount of homes-level sources in the order specified in the parameter uird.homes. </li><li>  The connection to the highest level of AUFS of the source of persistent changes specified in the uird.changes parameter occurs. </li><li>  The base-level is synchronized to the cache-level, taking into account the uird.copy2cache parameter, as well as the matching sublevels.  If the cache-level sublevels are less than the base-level, then the remaining sublevels are synchronized into RAM. </li></ul><br><pre> <code class="hljs erlang-repl"> ‚îú‚îÄ‚îÄ layer-base ==&gt; ‚îú‚îÄ‚îÄ layer-cache ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span> --&gt; ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span> --&gt; ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span> ‚îÇ ‚îú‚îÄ‚îÄ ... --&gt; ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îÇ ‚îî‚îÄ‚îÄ ... --&gt; ‚îÇ RAM</code> </pre><br><ul><li>  Synchronization of base and cache levels in RAM is performed, taking into account the uird.copy2ram parameter. </li><li>  Modules are searched in RAM, cache-level, base-level and connected to the upper level of AUFS or copied to the root (taking into account the filters specified in the parameters uird.load, uird.noload, uird.ro, uird.rw, uird. cp). </li><li>  The cascade integration of homes-level sources and their connection to / home / is carried out </li><li>  Runs rc.preinit scripts. </li></ul><br><a name="4-1"></a><h5>  <b>The structure of the default basecfg.ini configuration file</b> </h5><br><pre> <code class="bash hljs">uird.config=MagOS.ini uird.ramsize=70% uird.ro=*.xzm;*.rom;*.rom.enc;*.pfs;*.sfs uird.rw=*.rwm;*.rwm.enc uird.cp=*.xzm.cp,*/rootcopy uird.load=/base/,/modules/,rootcopy uird.noload= uird.from=/MagOS;/MagOS-Data uird.changes=/MagOS-Data/changes uird.cache=/MagOS-Data/cache uird.machines=/MagOS-Data/machines uird.home=/MagOS-Data/homes</code> </pre><br>  If uird.basecfg is not set, then /uird_configs/basecfg.ini is used inside the initrd. <br><br><a name="4-2"></a><h5>  <b>System directory structure</b> </h5><br><pre> <code class="hljs 1c"> /memory/ ‚îú‚îÄ‚îÄ bundles -    ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">00</span></span>-kernel.xzm ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">01</span></span>-firmware.xzm ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">10</span></span>-core.xzm ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">80</span></span>-eepm-<span class="hljs-number"><span class="hljs-number">1.5</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.xzm ‚îÇ ‚îî‚îÄ‚îÄ ... -  .. ‚îú‚îÄ‚îÄ changes -   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   ‚îÇ ‚îú‚îÄ‚îÄ etc ‚îÇ ‚îú‚îÄ‚îÄ home ‚îÇ ‚îú‚îÄ‚îÄ memory ‚îÇ ‚îú‚îÄ‚îÄ run ‚îÇ ‚îú‚îÄ‚îÄ var ‚îÇ ‚îî‚îÄ‚îÄ ... -  .. ‚îú‚îÄ‚îÄ data -    ‚îÇ ‚îú‚îÄ‚îÄ cache -   ‚îÇ ‚îú‚îÄ‚îÄ homes - homes  ‚îÇ ‚îú‚îÄ‚îÄ machines - () ‚îÇ ‚îî‚îÄ‚îÄ from -   ‚îú‚îÄ‚îÄ layer-base -     ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span> -    ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span> -    (  <span class="hljs-built_in"><span class="hljs-built_in"></span></span>  uird.from=) ‚îÇ ‚îî‚îÄ‚îÄ ... -  .. ‚îú‚îÄ‚îÄ layer-cache -     ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span> -    ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span> -    (  <span class="hljs-built_in"><span class="hljs-built_in"></span></span>  uird.cache=) ‚îÇ ‚îî‚îÄ‚îÄ ... -  .. ‚îú‚îÄ‚îÄ layer-homes -   homes  ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">0</span></span> -    ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-number"><span class="hljs-number">1</span></span> -    (  <span class="hljs-built_in"><span class="hljs-built_in"></span></span>  uird.homes=) ‚îÇ ‚îî‚îÄ‚îÄ ... -  .. ‚îú‚îÄ‚îÄ cmdline -  <span class="hljs-type"><span class="hljs-type"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>      ‚îî‚îÄ‚îÄ MagOS.ini.gz -  <span class="hljs-type"><span class="hljs-type"></span></span> <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   </code> </pre><br><a name="4-3"></a><h5>  <b>Implementation</b> </h5><br>  The implementation is based on a set of <i>dracut</i> initialization <i>scripts</i> (base, busybox modules) and <i>uird</i> scripts (livekitlib + uird-init): <br><br><ul><li>  cmdline-hook: parse-root-uird.sh (checks the root parameter = uird); </li><li>  mount-hook: mount-uird.sh (executes the uird-init script); </li><li>  livekitlib - contains a library of initialization system functions; </li><li>  uird-init - sequentially executes a set of functions from livekitlib and performs cascade-block mounting of system modules into a single root AUFS in the directory specified in the dracut $ NEWROOT variable. </li></ul><br><a name="5"></a><h4>  <b>MagOS server</b> </h4><br><a name="5-1"></a><h5>  <b>General information</b> </h5><br>  In our case, the magos-server is deployed as an openvz container.  The implementation is not critical. <br><br><ul><li>  It serves as a remote boot server.  Remote boot is implemented using TFTP / PXE and allows you to load MagOS in the same configuration that is used to work on workstations.  Using this boot, you can test the hardware, install the operating system on a workstation, and perform many other tasks. </li><li>  Remote loading of the workstation under MagOS control is carried out via the HTTP protocol, for which Lighttpd is installed on the server, the documentroot of which points to the MagOS repository. </li><li>  The distribution kit is installed on the workstation and the workstations are updated using the rsync protocol.  Therefore, rsyncd is installed on the server. </li><li>  The server is controlled by the ssh protocol.  According to the same protocol, on the server, changes of program modules are being prepared, prepared on a test computer. </li></ul><br><h6>  <b><i>Server implementation</i></b> </h6><br>  Centos v6 operating system.  The following resources are allocated for a virtual container: CPU - 2, RAM - 512Mb, swap - 1Gb, virtual disk size 40Gb. <br><br><a name="5-2"></a><h5>  <b>Network settings</b> </h5><br><div class="spoiler">  <b class="spoiler_title">Setup in ifcfg-eth0</b> <div class="spoiler_text"><pre> <code class="bash hljs">DEVICE=eth0 IPADDR=192.168.1.xxx NETMASK=255.255.255.0 NETWORK=192.168.1.0 GATEWAY=192.168.1.1 DNS1=192.168.1.xxx BROADCAST=192.168.1.255 TYPE=Ethernet ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=static</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Network Services (netstat -tunlp)</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -tunlp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:873 0.0.0.0:* LISTEN 494/xinetd tcp 0 0 192.168.1.xxx:80 0.0.0.0:* LISTEN 551/lighttpd tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 484/sshd udp 0 0 0.0.0.0:69 0.0.0.0:* 494/xinetd</span></span></code> </pre><br></div></div><br><a name="5-3"></a><h5>  <b>Configure Services</b> </h5><br><h6>  <b><i>Lighthttpd</i></b> </h6><br><div class="spoiler">  <b class="spoiler_title">Run:</b> <div class="spoiler_text"><pre> <code class="bash hljs">chkconfig --list lighttpd lighttpd 0:off 1:off 2:on 3:on 4:off 5:on 6:off</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration file lighttpd.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">var.log_root = <span class="hljs-string"><span class="hljs-string">"/var/log/lighttpd"</span></span> var.server_root = <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span> var.state_dir = <span class="hljs-string"><span class="hljs-string">"/var/run"</span></span> var.home_dir = <span class="hljs-string"><span class="hljs-string">"/var/lib/lighttpd"</span></span> var.conf_dir = <span class="hljs-string"><span class="hljs-string">"/etc/lighttpd"</span></span> var.vhosts_dir = server_root + <span class="hljs-string"><span class="hljs-string">"/vhosts"</span></span> var.cache_dir = <span class="hljs-string"><span class="hljs-string">"/var/cache/lighttpd"</span></span> var.socket_dir = home_dir + <span class="hljs-string"><span class="hljs-string">"/sockets"</span></span> include <span class="hljs-string"><span class="hljs-string">"modules.conf"</span></span> server.port = 80 server.use-ipv6 = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> server.bind = <span class="hljs-string"><span class="hljs-string">"192.168.1.xxx"</span></span> server.username = <span class="hljs-string"><span class="hljs-string">"lighttpd"</span></span> server.groupname = <span class="hljs-string"><span class="hljs-string">"lighttpd"</span></span> server.document-root = server_root + <span class="hljs-string"><span class="hljs-string">"/"</span></span> server.pid-file = state_dir + <span class="hljs-string"><span class="hljs-string">"/lighttpd.pid"</span></span> server.errorlog = log_root + <span class="hljs-string"><span class="hljs-string">"/error.log"</span></span> include <span class="hljs-string"><span class="hljs-string">"conf.d/access_log.conf"</span></span> include <span class="hljs-string"><span class="hljs-string">"conf.d/debug.conf"</span></span> server.event-handler = <span class="hljs-string"><span class="hljs-string">"linux-sysepoll"</span></span> server.network-backend = <span class="hljs-string"><span class="hljs-string">"linux-sendfile"</span></span> server.stat-cache-engine = <span class="hljs-string"><span class="hljs-string">"simple"</span></span> server.max-connections = 1024 index-file.names += ( <span class="hljs-string"><span class="hljs-string">"index.xhtml"</span></span>, <span class="hljs-string"><span class="hljs-string">"index.html"</span></span>, <span class="hljs-string"><span class="hljs-string">"index.htm"</span></span>, <span class="hljs-string"><span class="hljs-string">"default.htm"</span></span>, <span class="hljs-string"><span class="hljs-string">"index.php"</span></span> ) url.access-deny = ( <span class="hljs-string"><span class="hljs-string">"~"</span></span>, <span class="hljs-string"><span class="hljs-string">".inc"</span></span> ) <span class="hljs-variable"><span class="hljs-variable">$HTTP</span></span>[<span class="hljs-string"><span class="hljs-string">"url"</span></span>] =~ <span class="hljs-string"><span class="hljs-string">"\.pdf$"</span></span> { server.range-requests = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> } static-file.exclude-extensions = ( <span class="hljs-string"><span class="hljs-string">".php"</span></span>, <span class="hljs-string"><span class="hljs-string">".pl"</span></span>, <span class="hljs-string"><span class="hljs-string">".fcgi"</span></span>, <span class="hljs-string"><span class="hljs-string">".scgi"</span></span> ) include <span class="hljs-string"><span class="hljs-string">"conf.d/mime.conf"</span></span> include <span class="hljs-string"><span class="hljs-string">"conf.d/dirlisting.conf"</span></span> server.follow-symlink = <span class="hljs-string"><span class="hljs-string">"enable"</span></span> server.upload-dirs = ( <span class="hljs-string"><span class="hljs-string">"/var/tmp"</span></span> )</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Vhosts.d / magos.conf configuration file</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$HTTP</span></span>[<span class="hljs-string"><span class="hljs-string">"host"</span></span>] == <span class="hljs-string"><span class="hljs-string">"magos-server.mydomain.local"</span></span> { var.server_name = <span class="hljs-string"><span class="hljs-string">"magos-server.mydomain.local"</span></span> server.name = server_name include <span class="hljs-string"><span class="hljs-string">"conf.d/trigger_b4_dl.conf"</span></span> server.document-root = vhosts_dir + <span class="hljs-string"><span class="hljs-string">"/magos/"</span></span> accesslog.filename = log_root + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + server_name <span class="hljs-string"><span class="hljs-string">"/access.log"</span></span> }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Conf.d / dirlisting.conf configuration file</b> <div class="spoiler_text"><pre> <code class="bash hljs">dir-listing.activate = <span class="hljs-string"><span class="hljs-string">"enable"</span></span> dir-listing.hide-dotfiles = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> dir-listing.exclude = ( <span class="hljs-string"><span class="hljs-string">"~$"</span></span> ) dir-listing.encoding = <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span> dir-listing.hide-header-file = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> dir-listing.show-header = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> dir-listing.hide-readme-file = <span class="hljs-string"><span class="hljs-string">"disable"</span></span> dir-listing.show-readme = <span class="hljs-string"><span class="hljs-string">"disable"</span></span></code> </pre><br></div></div><br><h6>  <b><i>Tftpd</i></b> </h6><br><div class="spoiler">  <b class="spoiler_title">Run (/etc/xinetd.d/tftp :)</b> <div class="spoiler_text"><pre> <code class="bash hljs">service tftp { socket_type = dgram protocol = udp <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = yes user = root server = /usr/sbin/in.tftpd server_args = -s /var/lib/tftpboot <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> = no per_source = 11 cps = 100 2 flags = IPv4 }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration file /var/lib/tftpboot/pxelinux.cfg/default</b> <div class="spoiler_text"><pre> <code class="bash hljs">default menu.c32 prompt 0 timeout 300 ONTIMEOUT <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> MENU TITLE PXE Menu <span class="hljs-comment"><span class="hljs-comment">#    ‚Äì   HD LABEL Boot from hard disk localboot 0x80 LABEL AltLinux-net MENU LABEL AltLinux-net kernel images/vmlinuz uird.ro=*.xzm,*/live uird.from=http://magos-server.mydomain.local/magos/AltLinux x/iso/altlinux-p7-cinnamon-latest-i586.iso;http://magos-server.mydomain.local/magos/AltLinux/modules/i586/ ui rd.load=* root=uird rw findswap vga=788 quiet plymouth.enable=0 users append initrd=images/uird.magos.cpio.xz LABEL AltLinux-net testing MENU LABEL AltLinux-net testing kernel images/vmlinuz uird.ro=*.xzm,*/live uird.from=http://magos-server.mydomain.local/testing/AltLinux /iso/altlinux-p7-cinnamon-latest-i586.iso;http://magos-server.mydomain.local/testing/AltLinux/modules/i586 / uird.load=* root=uird rw findswap vga=788 quiet plymouth.enable=0 users append initrd=images/uird.magos.cpio.xz</span></span></code> </pre><br></div></div><br>  The repository consists of two parts: a worker with the name magos and a test with the name testing.  The working repository is designed to install and update software for user workstations.  Preliminary testing of the installed software is performed on the testing repository.  The boot menu allows you to load the operating system from both the working repository and the test one. <br><br><h6>  <b><i>Rsync</i></b> </h6><br><div class="spoiler">  <b class="spoiler_title">Run (/etc/xinetd.d/rsync):</b> <div class="spoiler_text"><pre> <code class="bash hljs">service rsync { <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> = no flags = IPv4 socket_type = stream <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = no user = root server = /usr/bin/rsync server_args = --daemon log_on_failure += USERID }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration file /etc/rsyncd.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">use chroot = yes max connections = 100 syslog facility = local5 pid file = /var/run/rsyncd.pid [magos] path = /var/www/magos comment = whole MagOS boot [testing] path = /var/www/testing comment = whole MagOS boot</code> </pre><br></div></div><br><h6>  <b><i>sshd</i></b> </h6><br><div class="spoiler">  <b class="spoiler_title">Run:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chkconfig ‚Äìlist sshd sshd 0:off 1:off 2:on 3:on 4:on 5:on 6:off</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration file / etc / ssh / sshd_config</b> <div class="spoiler_text"><pre> <code class="bash hljs">Protocol 2 SyslogFacility AUTHPRIV PasswordAuthentication yes ChallengeResponseAuthentication no GSSAPIAuthentication yes GSSAPICleanupCredentials yes UsePAM yes AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE AcceptEnv XMODIFIERS X11Forwarding no Subsystem sftp /usr/libexec/openssh/sftp-server</code> </pre><br></div></div><br><a name="5-4"></a><h5>  <b>Software repository</b> </h5><br>  Only relevant files and directories are shown in the program repository structure. <br><br>  <b>magos</b> <br><br><pre> <code class="hljs css">‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">AltLinux</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">iso</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">altlinux-p7-cinnamon-latest-i586</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.iso</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">i586</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">uird</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.magos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cpio</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xz</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">uird</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.soft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cpio</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xz</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">vmlinuz</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">modules</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">i586</span></span> ‚îÇ ‚îú‚îÄ‚îÄ00<span class="hljs-selector-tag"><span class="hljs-selector-tag">-kernel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ01<span class="hljs-selector-tag"><span class="hljs-selector-tag">-firmware</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ03<span class="hljs-selector-tag"><span class="hljs-selector-tag">-1-nvidia-current</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ03<span class="hljs-selector-tag"><span class="hljs-selector-tag">-2-nvidia304</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ03<span class="hljs-selector-tag"><span class="hljs-selector-tag">-9-fglrx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ80<span class="hljs-selector-tag"><span class="hljs-selector-tag">-eepm-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ80<span class="hljs-selector-tag"><span class="hljs-selector-tag">-uird</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.soft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ90<span class="hljs-selector-tag"><span class="hljs-selector-tag">-magos-patches</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ99<span class="hljs-selector-tag"><span class="hljs-selector-tag">-squashfs-tools</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.32</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ99<span class="hljs-selector-tag"><span class="hljs-selector-tag">-u10-update</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ99<span class="hljs-selector-tag"><span class="hljs-selector-tag">-u40-office4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ99<span class="hljs-selector-tag"><span class="hljs-selector-tag">-u50-utils</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ99<span class="hljs-selector-tag"><span class="hljs-selector-tag">-u99-default</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xzm</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">MagOS</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ini</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">update</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.txt</span></span> ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">AltLinux-Data</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">cache</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">changes</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">homes</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">machines</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">MagOS-Data</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sgn</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">modules</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">optional</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">rootcopy</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">boot</span></span> ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">grub4dos</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lin</span></span> ‚îÇ ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.win</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">local</span></span> ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">menu</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lst</span></span> ‚îú‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">syslinux</span></span> ‚îî‚îÄ‚îÄ<span class="hljs-selector-tag"><span class="hljs-selector-tag">tools</span></span></code> </pre><br>  <b>testing</b> <br><br><pre> <code class="bash hljs">‚îú‚îÄ‚îÄAltLinux ‚îÇ ‚îú‚îÄ‚îÄiso ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄaltlinux-p7-cinnamon-latest-i586.iso ‚îÇ ‚îú‚îÄ‚îÄkernel ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄi586 ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄuird.magos.cpio.xz ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄuird.soft.cpio.xz ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄvmlinuz ‚îÇ ‚îî‚îÄ‚îÄmodules ‚îÇ ‚îî‚îÄ‚îÄi586 ‚îÇ ‚îú‚îÄ‚îÄ00-kernel.xzm ‚îÇ ‚îú‚îÄ‚îÄ01-firmware.xzm ‚îÇ ‚îú‚îÄ‚îÄ03-1-nvidia-current.xzm ‚îÇ ‚îú‚îÄ‚îÄ03-2-nvidia304.xzm ‚îÇ ‚îú‚îÄ‚îÄ03-9-fglrx.xzm ‚îÇ ‚îú‚îÄ‚îÄ80-eepm-1.5.2.xzm ‚îÇ ‚îú‚îÄ‚îÄ80-uird.soft.xzm ‚îÇ ‚îú‚îÄ‚îÄ90-magos-patches.xzm ‚îÇ ‚îú‚îÄ‚îÄ99-squashfs-tools.32.xzm ‚îÇ ‚îú‚îÄ‚îÄ99-u10-update.xzm ‚îÇ ‚îú‚îÄ‚îÄ99-u40-office4.xzm ‚îÇ ‚îú‚îÄ‚îÄ99-u50-utils.xzm ‚îÇ ‚îú‚îÄ‚îÄ99-u99-default.xzm ‚îÇ ‚îú‚îÄ‚îÄMagOS.ini ‚îÇ ‚îî‚îÄ‚îÄupdate.txt ‚îú‚îÄ‚îÄAltLinux-Data ‚îÇ ‚îú‚îÄ‚îÄcache ‚îÇ ‚îú‚îÄ‚îÄchanges ‚îÇ ‚îú‚îÄ‚îÄhomes ‚îÇ ‚îú‚îÄ‚îÄmachines ‚îÇ ‚îú‚îÄ‚îÄMagOS-Data.sgn ‚îÇ ‚îú‚îÄ‚îÄmodules ‚îÇ ‚îú‚îÄ‚îÄoptional ‚îÇ ‚îî‚îÄ‚îÄrootcopy ‚îú‚îÄ‚îÄboot ‚îÇ ‚îú‚îÄ‚îÄgrub4dos ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄinstall.lin ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄinstall.win ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄmenu.lst ‚îÇ ‚îú‚îÄ‚îÄsyslinux ‚îÇ ‚îî‚îÄ‚îÄtools ‚îî‚îÄ‚îÄupdate.tar.gz</code> </pre><br>  Since writing to the repository is carried out with the system user rights, you must create groups responsible for writing to the appropriate repository: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># groupadd magos # groupadd testing</span></span></code> </pre><br>  Set permissions on all repository directories: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /var/www # find magos -type f -exec chmod 664 {} + # find magos -type d -exec chmod 775 {} + # find testing -type f -exec chmod 664 {} + # find testing -type d -exec chmod 775 {} +</span></span></code> </pre><br>  Set repository owner groups: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chown -R :magos magos # chown -R :testing testing</span></span></code> </pre><br>  Set SGID to repository directories: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod g+s magos # chmod g+s testing</span></span></code> </pre><br><a name="5-5"></a><h5>  <b>Additional server data</b> </h5><br><pre> <code class="bash hljs">yum.repos.d CentOS-Base.repo CentOS-Debuginfo.repo CentOS-fasttrack.repo CentOS-Media.repo CentOS-Vault.repo epel.repo epel-testing.repo vz.repo</code> </pre><br><h6>  <b><i>Management scripts</i></b> </h6><br>  The scripts were created for current use and do not pretend to the "boxing" of use, therefore, when applying them, please be careful! <br><br><a name="5-6"></a><h5>  <b>Monitoring</b> </h5><br>  The update-txt.sh script, which runs daily according to a schedule, writes the update.txt file containing the current date to the modules directory.  After synchronizing the data to the user's computer, it makes it easy to check when the computer was last updated.  This is a necessary moment for tracking computers that do not overload for a long time (the user does not turn off the computer). <br><br><div class="spoiler">  <b class="spoiler_title">Script /etc/cron.daily/update-txt.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo "magos $(date)" &gt; /var/www/magos/AltLinux/modules/i586/update.txt echo "testing $(date)" &gt; /var/www/testing/AltLinux/modules/i586/update.txt</span></span></code> </pre><br></div></div><br><h6>  <b><i>Update</i></b> </h6><br>  The testig2magos_kern.sh, testig2magos_mod.sh and testig2magos_all.sh scripts are designed to update the working repository from the testing repository and are executed only in manual mode. <br><br>  <i>testig2magos_kern.sh</i> - updates only system modules and the kernel directory. <br>  <i>testig2magos_mod.sh</i> - updates only user modules. <br>  <i>testig2magos_all.sh</i> - performs a full update including the kernel, iso and modules folders. <br><br>  <u>None of the scripts are updating the MagOS.ini file!</u> <br><br>  Changes to this file are made only manually. <br><br><div class="spoiler">  <b class="spoiler_title">Script /root/bin/testig2magos_kern.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #      MagOS   magos #   testing MAGOS="/var/www/magos" TESTING="/var/www/testing" MAGOSGROUP="magos" echo "!!! UPDATE KERNEL AND MAGOS MODULES TO magos REPOSITORY FROM testing REPOSITORY" echo " =====" echo echo "Pres Rnter to continue, or Ctrl+C to abort..." read junk clear cp -ruv $TESTING/AltLinux/kernel/i586/*.xzm $MAGOS/AltLinux/kernel/i586/ cp -ruv $TESTING/AltLinux/modules/i586/[0-9]?-*.xzm $MAGOS/AltLinux/modules/i586/ find $MAGOS -type f -exec chmod 664 {} + find $MAGOS -type d -exec chmod 775 {} + chown -R :$MAGOSGROUP $MAGOS/* echo "UPDATE KERNEL AND MAGOS MODULES FROM magos REPOSITORY IT IS EXECUTED"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script /root/bin/testig2magos_mod.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #    MagOS   magos #   testing MAGOS="/var/www/magos" TESTING="/var/www/testing" MAGOSGROUP="magos" echo "!!! UPDATE MODULES TO magos REPOSITORY FROM testing REPOSITORY" echo " =====" echo echo "Pres Rnter to continue, or Ctrl+C to abort..." read junk clear cp -ruv $TESTING/AltLinux/modules/i586/[0-9]??-*.xzm $MAGOS/AltLinux/modules/i586/ find $MAGOS -type f -exec chmod 664 {} + find $MAGOS -type d -exec chmod 775 {} + chown -R :$MAGOSGROUP $MAGOS/* echo "UPDATE MODULES FROM magos REPOSITORY IT IS EXECUTED"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script /root/bin/testig2magos_all.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #     magos #   testing,      iso MAGOS="/var/www/magos" TESTING="/var/www/testing" MAGOSGROUP="magos" echo "!!! UPDATE ALL MAGOS REPOSITORY magos FROM testing REPOSITORY" echo " =====" echo echo "Pres Rnter to continue, or Ctrl+C to abort..." read junk clear cp -ruv $TESTING/AltLinux/iso/ $MAGOS/AltLinux/iso/ cp -ruv $TESTING/AltLinux/kernel/i586/*.xzm $MAGOS/AltLinux/kernel/i586/ cp -ruv $TESTING/AltLinux/modules/i586/*.xzm $MAGOS/AltLinux/modules/i586/ find $MAGOS -type f -exec chmod 664 {} + find $MAGOS -type d -exec chmod 775 {} + chown -R :$MAGOSGROUP $MAGOS/* echo "UPDATE magos REPOSITORY IT IS EXECUTED"</span></span></code> </pre><br></div></div><br><a name="6"></a><h4>  <b>Custom modules</b> </h4><br><a name="6-1"></a><h5>  <b>General principles for creating custom modules</b> </h5><br><h6>  <b><i>What you need to know</i></b> </h6><br>  When creating modules in MagOS, you have to take into account one important feature related to the creation of users and groups.  When a module is created, the modified passwd, group, shadow, etc. files are saved in it  But, in order for the next generated module to be ‚Äúseen‚Äù by the epm2xzm script, you need the module name to match the ‚ÄúNN-‚Äù pattern.  If the names of the modules do not match this pattern, then each subsequent module being created, just like the first, will be created on the basis of only the basic MagOS modules.  Most of all, this will hit the authentication files: programs that create system users and are installed in different modules receive the same UID and GID, and passwd files created in different modules are overwritten by subsequent layers.  As a result, the programs installed in the underlying modules turn out to be inoperable. <br><br>  There are two ways to eliminate this problem: group programs that create system accounts within one module or specify module names according to the template above. <br><br>  The scripts creating modules are written in such a way that their own name is used as the name of the module.  A script named 99-u30-example.sh will create a module called 99-u30-example.xzm. <br><br><a name="6-2"></a><h5>  <b>How many modules do</b> </h5><br>       ,         .       .         ,      MagOS   AltLinux   ,        aufs    .    ,    ,      .         ¬´99-¬ª,     ,    ¬´99?-¬ª  ,           . <br><br><a name="6-3"></a><h5> <b>  </b> </h5><br>       : ,       .    ,     ¬´99-u10-update¬ª.  ,         .    .         : <br><br><ul><li>      . </li><li>       ,     (passwd, group  ..) </li></ul><br>                      . <br><br><a name="6-4"></a><h5> <b>  </b> </h5><br>       (     127),          .  ,         ,    .            ,          .       .      ,       . <br><br>  ,     ,     ,     .        , -,    ,           . ,   Libreoffice ,      3    .  ,                . <br><br>     ,       3,    4 . <br><br><a name="6-5"></a><h5> <b>   </b> </h5><br>      : <br><br><ol><li>    /root/bin/loadupdate.sh. </li><li>      :   /etc/sysconfig/MagOS  /mnt/livemedia/MagOS.ini   AUTOUPDATE=No. </li><li>      ,   .bak (   ). </li><li>   .        magos-server. </li><li>  ,  ,      . </li><li>   3-5    . </li></ol><br><h6> <b><i>   </i></b> </h6><br>  ,       : <br><br><ul><li>     clean. </li><li>      . </li><li>      ,  acc   .  . </li><li>     ,     . </li><li>                . </li><li>          . </li><li>  .           .     .           ..       .    . </li><li>      . </li></ul><br><a name="6-6"></a><h5> <b>  </b> </h5><br>        .     ,     .     ,      iso  .      ,             . <br><br><div class="spoiler"> <b class="spoiler_title"> 99-u10-update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . conf/devel.conf NAME=`echo $0 | sed 's/\.\///'| sed 's/\..*//'` . lib/mv.sh $NAME epm2xzm $NAME upgrade $NAME.xzm rm -rf $NAME mkdir $NAME xzm2dir $NAME.xzm $NAME . lib/delhlam.sh $NAME dir2xzm $NAME $NAME.xzm . lib/update.sh $NAME</span></span></code> </pre><br></div></div><br><a name="6-7"></a><h5> <b>   </b> </h5><br>        ,     .     ,      ,      . <br><br><div class="spoiler"> <b class="spoiler_title"> 99-u10-office4.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . conf/devel.conf NAME=`echo $0 | sed 's/\.\///'| sed 's/\..*//'` . lib/mv.sh $NAME epm2xzm $NAME -i 'java-1.7.0-openjdk LibreOffice4-langpack-ru LibreOffice4-integrated file-roller LibreOffice4 LibreOffice4-gnome foomatic-db lsof foo2zjs foo2zjs-apps foo2zjs-fwdownloader mozilla-plugin-adobe-flash mozilla-plugin-mozplugger mozilla-plugin-totem totem-plugins fonts-ttf-ms' rm -rf $NAME mkdir $NAME xzm2dir $NAME.xzm $NAME rm -rf $NAME/etc/urpmi $NAME/etc/.java . lib/delhlam.sh $NAME dir2xzm $NAME $NAME.xzm . lib/update.sh $NAME</span></span></code> </pre><br></div></div><br><a name="6-8"></a><h5> <b>    </b> </h5><br>        ,          .           office,      ,            3 . <br><br>                 . <br><br>         ,         ,     /    .        ,           .                  . <br><br>       .          .       .         ¬´ ¬ª. <br><br><div class="spoiler"> <b class="spoiler_title"> 99-u20-utils.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . conf/devel.conf NAME=`echo $0 | sed 's/\.\///'| sed 's/\..*//'` . lib/mv.sh $NAME epm2xzm $NAME -i 'samba samba-winbind alterator-auth cups-windows samba-client ntpdate ntp-utils zabbix-agent zabbix-agent-sudo perl-FusionInventory-Agent perl-FusionInventory-Agent-scripts perl-Task-FusionInventory perl-Pod-Text-Ansi alterator-fbi alterator-net-iptables italc2-client installer-feature-init-italc rsync tcpdump nmap netcat telnet sane sane-server xsane xsane-gimp2 sane-frontends yagf cuneiform cuneiform-data fonts-otf-gdouros-akkadian aspell-ru-lebedev aspell-ru-rk iperf whois rdesktop xfreerdp remmina-plugins sshpass pssh' rm -rf $NAME mkdir $NAME xzm2dir $NAME.xzm $NAME cp /usr/share/zoneinfo/Asia/Krasnoyarsk $NAME/etc/localtime cp /etc/nsswitch.conf $NAME/etc/nsswitch.conf sed -is/'^hosts: files mdns4_minimal \[NOTFOUND=return\]*'/'hosts: files dns mdns4_minimal \[NOTFOUND=return\] myhostname fallback'/ $NAME/etc/nsswitch.conf sed -is/'^# PidFile=\/var'/'PidFile=\/var'/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'^# EnableRemoteCommands=0'/'EnableRemoteCommands=1'/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'^LogFileSize='/'# LogFileSize='/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'127.0.0.1'/'192.168.0.XXX'/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'^# LogRemoteCommands=0'/'LogRemoteCommands=1'/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'^Hostname='/'# Hostname='/ $NAME/etc/zabbix/zabbix_agentd.conf sed -is/'^# Timeout=3'/'Timeout=30'/ $NAME/etc/zabbix/zabbix_agentd.conf mkdir $NAME/etc/fusioninventory echo "server = http://glpi.kompany.local/glpi/plugins/fusioninventory/" &gt; $NAME/etc/fusioninventory/agent.cfg echo "delaytime = 3600" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg echo "timeout = 180" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg echo "logger = File" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg echo "logfile = /var/log/fusioninventory.log" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg echo "logfacility = LOG_USER" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg echo "debug = 3" &gt;&gt; $NAME/etc/fusioninventory/agent.cfg mkdir $NAME/etc/cron.daily echo "#!/bin/sh" &gt; $NAME/etc/cron.daily/fusioninventory-agent echo "" &gt;&gt; $NAME/etc/cron.daily/fusioninventory-agent echo "/usr/bin/fusioninventory-agent --conf-file=/etc/fusioninventory/agent.cfg" &gt;&gt; $NAME/etc/cron.daily/fusioninventory-agent chmod +x $NAME/etc/cron.daily/fusioninventory-agent . lib/delhlam.sh $NAME dir2xzm $NAME $NAME.xzm . lib/update.sh $NAME</span></span></code> </pre><br></div></div><br>   ,       timezone,         ,      MagOS,       (cp /usr/share/zoneinfo/Asia/Krasnoyarsk $NAME/etc/localtime). <br><br>   -      AltLinux,        ,        local (cp /etc/nsswitch.conf $NAME/etc/nsswitch.conf sed -is/'^hosts: files mdns4_minimal \[NOTFOUND=return\]*'/'hosts: files dns mdns4_minimal \[NOTFOUND=return\] myhostname fallback'/ $NAME/etc/nsswitch.conf). <br><br>     zabbix_agentd,        ,       . <br><br>     fusioninventory-agent, ,        GLPI         . <br><br><a name="6-9"></a><h5> <b>  </b> </h5><br>                 ,     . <br><br><div class="spoiler"> <b class="spoiler_title"> 99-u99-default.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . conf/devel.conf NAME=`echo $0 | sed 's/\.\///'| sed 's/\..*//'` . lib/mv.sh $NAME dir2xzm $NAME $NAME.xzm . lib/update.sh $NAME</span></span></code> </pre></div></div><br>   etc/       : <br><br><div class="spoiler"> <b class="spoiler_title">sudoers</b> <div class="spoiler_text"><pre> <code class="bash hljs">-r-------- 1 root root 730 Aug 20 15:42 ./sudoers</code> </pre><br></div></div><br>      sudo    (       ssh). <br><br><div class="spoiler"> <b class="spoiler_title">X11</b> <div class="spoiler_text"><pre> <code class="bash hljs">./X11: total 8 drwxr-xr-x 2 root root 4096 Aug 21 12:42 xinit drwxr-xr-x 2 root root 4096 Aug 21 12:42 xorg.conf.d</code> </pre><br></div></div><br>     : <br><br><div class="spoiler"> <b class="spoiler_title">etc/X11/xinit/Xkbmap</b> <div class="spoiler_text"><pre> <code class="bash hljs">option grp:alt_shift_toggle -variant , -layout us,ru -model pc104</code> </pre><br></div></div><br>   : <br><br><div class="spoiler"> <b class="spoiler_title">etc/X11/xorg.conf.d/00-keyboard.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Read and parsed by systemd-localed. It's probably wise not to edit this file # manually too freely. Section "InputClass" Identifier "system-keyboard" MatchIsKeyboard "on" Option "XkbLayout" "us,ru" EndSection</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">./apt</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 8 drwxr-xr-x 2 root root 4096 Jun 9 09:45 sources.list.d drwxr-xr-x 2 root root 4096 Jun 9 09:42 vendors.list.d</code> </pre><br></div></div><br>   autoimports    fusioninventory-agent. <br><br><div class="spoiler"> <b class="spoiler_title">etc/apt/sources.list.d/autoimports-p7.list</b> <div class="spoiler_text"><pre> <code class="bash hljs">rpm [cronbuild] ftp://ftp.altlinux.ru/pub/distributions/ALTLinux/autoimports/Sisyphus/ noarch autoimports /etc/apt/vendors.list.d/autoimports-p7.list simple-key <span class="hljs-string"><span class="hljs-string">"cronbuild"</span></span> { Fingerprint <span class="hljs-string"><span class="hljs-string">"DE73F3444C163CCD751AC483B584C633278EB305"</span></span>; Name <span class="hljs-string"><span class="hljs-string">"Cronbuild Service &lt;cronbuild@altlinux.org&gt;"</span></span>; } simple-key <span class="hljs-string"><span class="hljs-string">"cronport"</span></span> { Fingerprint <span class="hljs-string"><span class="hljs-string">"F3DBF34AB0CC0CE638DF7D509F61FBE7E2C322D8"</span></span>; Name <span class="hljs-string"><span class="hljs-string">"Cronport Service &lt;cronport@altlinux.org&gt;"</span></span>; }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">./italc</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 4 drwxr-xr-x 3 root root 4096 Jul 17 18:19 keys</code> </pre><br></div></div><br>    italc. <br><br><div class="spoiler"> <b class="spoiler_title">./lightdm</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 12 -rw-r--r-- 1 root root 909 Jun 8 13:03 lightdm-gtk-greeter.conf -rw-r--r-- 1 root root 4536 Jun 8 13:18 lightdm.conf</code> </pre><br></div></div><br>   autologin    . <br><br><div class="spoiler"> <b class="spoiler_title">etc/lightdm/lightdm-gtk-greeter.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[greeter] logo=/usr/share/design/current/icons/large/altlinux.png background=/usr/share/design/current/backgrounds/default.png icon-theme-name=gnome show-language-selector=<span class="hljs-literal"><span class="hljs-literal">false</span></span> show-indicators=a11y;power</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">etc/lightdm/lightdm.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[LightDM] minimum-vt=7 user-authority-in-system-dir=<span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-directory=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/lightdm run-directory=/var/run/lightdm cache-directory=/var/cache/lightdm xsessions-directory=/etc/lightdm/sessions [SeatDefaults] xserver-command=/usr/bin/X greeter-hide-users=<span class="hljs-literal"><span class="hljs-literal">true</span></span> session-wrapper=/etc/X11/Xsession [XDMCPServer] [VNCServer]</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">./net</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 8 drwxr-xr-x 3 root root 4096 Jul 16 12:35 ifaces -rw-r--r-- 1 root root 1987 Jul 16 12:44 sysctl.conf</code> </pre><br></div></div><br>       . <br><br><div class="spoiler"> <b class="spoiler_title">./pam.d</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 4 -rw-r----- 1 root root 237 Aug 24 11:28 reboot</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">etc/pam.d/reboot</b> <div class="spoiler_text"><pre> <code class="bash hljs">auth required pam_nologin.so auth sufficient pam_rootok.so auth sufficient pam_console.so <span class="hljs-comment"><span class="hljs-comment">#auth required pam_deny.so auth required pam_permit.so account required pam_permit.so password required pam_deny.so</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">./skel</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 16 drwxr-xr-x 8 root root 4096 Jun 8 16:17  drwxr-xr-x 2 root root 4096 Jun 8 16:17  drwxr-xr-x 2 root root 4096 Jun 8 16:17  drwxr-xr-x 2 root root 4096 Jun 8 16:17  </code> </pre><br></div></div><br>   skel  ,       . <br><br><div class="spoiler"> <b class="spoiler_title">./sysconfig:</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 8 -rw-r‚Äìr‚Äì 1 root root 75 Jun 8 13:11 i18n</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">etc/sysconfig/i18n</b> <div class="spoiler_text"><pre> <code class="bash hljs">SYSFONT=UniCyr_8x16 LANG=ru_RU.utf8</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">./systemd</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 8 drwxr-xr-x 5 root root 4096 Aug 20 18:52 system drwxr-xr-x 2 root root 4096 Aug 20 18:51 user</code> </pre><br></div></div><br>   ,       . <br><br><div class="spoiler"> <b class="spoiler_title">./xdg</b> <div class="spoiler_text"><pre> <code class="bash hljs">total 4 drwxr-xr-x 2 root root 4096 Jul 17 17:59 iTALC Solutions</code> </pre><br></div></div><br>  Italc   ,   .       ,        default. <br><br><div class="spoiler"> <b class="spoiler_title">/etc/xdg/iTALC Solutions/iTALC.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[Authentication] KeyAuthenticationEnabled=1 LogonAuthenticationEnabled=0 LogonGroups=<span class="hljs-string"><span class="hljs-string">"italc-admins,italc-supporters,italc-teachers,italc-students"</span></span> PermissionRequiredWithKeyAuthentication=0 PermissionRequiredWithLogonAuthentication=0 PrivateKeyBaseDir=<span class="hljs-variable"><span class="hljs-variable">$GLOBALAPPDATA</span></span>/keys/private PublicKeyBaseDir=<span class="hljs-variable"><span class="hljs-variable">$GLOBALAPPDATA</span></span>/keys/public SameUserConfirmationDisabled=0 [DemoServer] Backend=0 Multithreaded=1 [Logging] LimittedLogFileSize=0 LogFileDirectory=<span class="hljs-variable"><span class="hljs-variable">$TEMP</span></span> LogFileSizeLimit=-1 LogLevel=4 LogToStdErr=1 LogToWindowsEventLog=0 [Network] CoreServerPort=11100 DemoServerPort=11400 FirewallExceptionEnabled=1 HttpServerEnabled=0 HttpServerPort=5800 [Paths] GlobalConfiguration=<span class="hljs-variable"><span class="hljs-variable">$APPDATA</span></span>/GlobalConfig.xml PersonalConfiguration=<span class="hljs-variable"><span class="hljs-variable">$APPDATA</span></span>/PersonalConfig.xml SnapshotDirectory=<span class="hljs-variable"><span class="hljs-variable">$APPDATA</span></span>/Snapshots [Service] Arguments= Autostart=1 HideTrayIcon=0 LockWithDesktopSwitching=1 [VNC] CaptureLayeredWindows=1 LowAccuracy=1 PollFullScreen=1</code> </pre><br></div></div><br><a name="7"></a><h4> <b></b> </h4><br>         ,         .        ,       :           .        ,   ¬´ ¬ª    ,    . <br><br><a name="7-1"></a><h5> <b>  magos-patches</b> </h5><br>             MagOS,          MagOS.    ,  ,    MagOS-patches,      . <br><br><h6> <b><i> </i></b> </h6><br>  /usr/lib/magos/rc.halt/05-update.sh           .       MagOS.ini   : <br><br><div class="spoiler"> <b class="spoiler_title">/usr/lib/magos/rc.halt/05-update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     : Yes, No AUTOUPDATE=Yes #     : boot - UPDATE=AltLinux,boot #        rsync SRCUPDATE=192.168.1.XXX/magos</span></span></code> </pre><br></div></div><br> :  AUTOUPDATE ,        . UPDATE ‚Äî  ,     . <br><br> SRCUPDATE ‚Äî    ,    .     IP-,    DNS . <br>           . <br><br>   : <br><br><div class="spoiler"> <b class="spoiler_title">/usr/lib/magos/rc.halt/05-update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # Initial script for MagOS-Linux Live operating system # This script are launching before starting init from linux-live script. # Current dir always must be set to root (/) # All system path must be relative, except initrd dirs export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin ENABLED=yes . /mnt/live/liblinuxlive [ -f /etc/sysconfig/MagOS ] &amp;&amp; . /etc/sysconfig/MagOS #. etc/sysconfig/MagOS [ "$ENABLED" != "yes" ] &amp;&amp; exit 0 [ "$AUTOUPDATE" != "Yes" or "$AUTOUPDATE" != "yes" ] &amp;&amp; exit 0 [ -z "$UPDATE" -a -z "$SRCUPDATE" ] &amp;&amp; exit 0 [ -z "$(grep changes /memory/cmdline)" ] &amp;&amp; exit 0 [ -n "$(grep 'from=http:' /memory/cmdline)" ] &amp;&amp; exit 0 if ! [ -z "$UPDATE" ] ;then for dirs in $(echo $UPDATE | tr ',;' ' ') ;do rsync -azr --delete --exclude=MagOS.ini rsync://$SRCUPDATE/$dirs/ /mnt/livemedia/$dirs/ done fi</span></span></code> </pre><br></div></div><br>     /usr/lib/magos/rc.preinit.d/21-ntp,   NTP .           AltLinux,      . <br><br><div class="spoiler"> <b class="spoiler_title">/usr/lib/magos/rc.preinit.d/21-ntp</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # Initial script for MagOS-Linux Live operating system # This script are launching before starting init from linux-live script. # Current dir always must be set to root (/) # All system path must be relative, except initrd dirs export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin ENABLED=yes [ "$ENABLED" != "yes" ] &amp;&amp; exit 0 DEBUGMODE=no . /liblinuxlive 2&gt;/dev/null || . /mnt/live/liblinuxlive . /livekitlib 2&gt;/dev/null debug_mode "$0" "$@" . etc/sysconfig/MagOS if ! [ -z "$NTPSERVERS" ] ;then sed -is/'^server'/'#server'/ etc/ntp.conf sed -is/'^server'/'#server'/ etc/ntpd.conf for a in $(echo $NTPSERVERS | tr ',;' ' ') ;do sed -i '/^driftfile/ s/^/server '"$a"\\n/ etc/ntp.conf grep -q "restrict $a" etc/ntp.conf || echo "restrict $a noquerry notrap" &gt;&gt; etc/ntp.conf sed -is/'^#listen on 127.0.0.1'/'listen on 127.0.0.1'/ etc/ntpd.conf echo "server $a" &gt;&gt; etc/ntpd.conf done fi</span></span></code> </pre><br></div></div><br><a name="7-2"></a><h5> <b>  </b> </h5><br>            ,   ,        . <br><br>  /usr/share/magos/install/magosinstall.sh  .       .       magos-server        . <br><br><div class="spoiler"> <b class="spoiler_title">/usr/share/magos/install/magosinstall.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # #Usage: # $1 - source catalog: magos testing # Default is magos SRC="magos" . /etc/sysconfig/MagOS SRCINI=$(echo $SRCUPDATE | cut -d "/" -f 2) if ! [ -z "$SRCINI" ];then SRC=$SRCINI fi if ! [ -z "$1" ] ;then SRC=$1 fi echo "-------------------------------------------------------" echo "INSTALL MagOS Altlinux FROM HARD DISK from $SRC !!!" echo " =========" echo echo "Press Enter to continue, or Ctrl+C to abort..." read junk clear swapoff -a echo "=======================================================" echo "Create parition table." parted -s /dev/sda mklabel msdos parted -s /dev/sda mkpart primary ext3 1 30000 parted -s /dev/sda mkpart primary linux-swap 30000 36000 parted -s /dev/sda mkpart primary ext3 36000 100% parted -s /dev/sda toggle 1 boot echo "-------------------------------------------------------" echo "=======================================================" echo "Make file systems on /dev/sda1." mkfs.ext3 -L system /dev/sda1 echo "Make file systems on /dev/sda2." mkswap /dev/sda2 echo "Make file systems on /dev/sda3." mkfs.ext3 -L data /dev/sda3 echo "-------------------------------------------------------" echo "=======================================================" mkdir /media/system &amp;&amp; mount /dev/sda1 /media/system mkdir /media/data &amp;&amp; mount /dev/sda3 /media/data echo "Syncing instalation data." for dirs in $(echo $UPDATE | tr ',;' ' ') ;do srv=$(echo $SRCUPDATE | cut -d '/' -f 1) if [ "$dirs" != "boot" ] ;then mkdir /media/system/$dirs rsync -azr --delete rsync://$srv/$SRC/$dirs/ /media/system/$dirs/ mkdir /media/data/$dirs-Data rsync -azr --delete rsync://$srv/$SRC/$dirs-Data/ /media/data/$dirs-Data/ else mkdir /media/system/$dirs rsync -azr --delete rsync://$srv/$SRC/$dirs/ /media/system/$dirs/ fi done rm -rf /media/system/lost+found /media/data/lost+found cd /media/system/boot/ bash ./Install_MagOS.bat $(sync) umount /dev/sda1 &amp;&amp; rmdir /media/system umount /dev/sda3 &amp;&amp; rmdir /media/data echo "-------------------------------------------------------" echo "Instalation is OK." echo "please reboot computer."</span></span></code> </pre><br></div></div><br>     ,    ,    ,  30Gb,  swap ‚Äì 6 Gb,       ,  Changes  Home.    ,        ,  ,   . <br><br>       ,      . <br><br><a name="7-3"></a><h5> <b>   AD</b> </h5><br>    ADS       . AltLinux,    ,   .               .  ,      ,    TCL     .    ,     . <br><br>       hostname=MagOS.      ,  ,     AD.      :       AD. <br><br>  :       MagOS.ini,          /etc/sysconfig/magos.    MagOS,           /etc/sysconfig/magos. <br><br><div class="spoiler"> <b class="spoiler_title">/usr/share/magos/ad_join/ad_join.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -w # MagOS-linux.ru # Author M.Fiskov use strict; #use Glib qw/TRUE FALSE/; #use Gtk3 '-init'; my $hostname=''; my $username=''; my $password=''; my $domain='mydomain'; my $realm='mydomain.local'; for (my $i=0;$i&lt;=$#ARGV;$i++){ $_=$ARGV[$i]; (/^--help$/) &amp;&amp; do {&amp;usage(); exit 0}; (/^--hostname=/) &amp;&amp; do { ($hostname=$ARGV[$i])=~s/^--hostname=//; }; (/^-h$/) &amp;&amp; do {$hostname=$ARGV[$i+1];$i++;}; (/^--password=/) &amp;&amp; do { ($password=$ARGV[$i]) =~s/^--password=//; }; (/^-p$/) &amp;&amp; do {$password=$ARGV[$i+1];$i++;}; (/^--username=/) &amp;&amp; do { ($username=$ARGV[$i]) =~s/^--username=//; }; (/^-u$/) &amp;&amp; do {$username=$ARGV[$i+1];$i++;}; } if (open (F1,"&lt;/etc/altlinux-release") ) { close F1; &amp;addname($hostname) &amp;&amp; system("system-auth write ad $realm $hostname $domain $username $password") &amp;&amp; system("systemctl restart nm b") &amp;&amp; system("systemctl restart winbind") &amp;&amp; system("systemctl restart smb"); &amp;wins(); &amp;winbind(); }else{ &amp;addname($hostname) &amp;&amp; system("net join -U \"".$username.'%'.$password."\"") &amp;&amp; system("systemctl restart nmb") &amp;&amp; system("systemct l restart winbind") &amp;&amp; system("systemctl restart smb"); &amp;wins(); &amp;winbind(); }; #system("/sbin/reboot"); exit; sub usage(){ print "Join this computer from MagOS to Active Directory Service (ADS) -h or --hostname= Computer name -u or --username= ADS administrator user name -p or --password= ADS administrator password --help This usage " } sub wins(){ my @wins=split("\"",`/usr/bin/wbinfo -P`); system ("sed -i '/wins server = /d' /etc/samba/smb.conf"); my $wsed=sprintf("sed -i \'/\\[global\\]/ s/\$/\\nwins server = ".$wins[1]."\'/ /etc/samba/smb.conf"); system ($wsed); my $wgroup=sprintf("net groupmap add ntgroup=\" \" unixgroup=wheel rid=512 type=d"); system ($wgroup); $wgroup=sprintf("net groupmap add ntgroup=\" \" unixgroup=wheel rid=513 type=d"); system ($wgroup); $wgroup=sprintf("net groupmap add ntgroup=\" \" unixgroup=wheel rid=514 type=d"); system ($wgroup); } sub addname (){ my ($hostname)=@_; system ("sed -i '/netbios name =/d' /etc/samba/smb.conf"); my $ssed=sprintf("sed -i \'/\\[global\\]/ s/\$/\\n netbios name = ".$hostname."\'/ /etc/samba/smb.conf"); system ($ssed); system ("sed -i '/HOSTNAME/d' /etc/sysconfig/MagOS"); $ssed=sprintf("echo \"HOSTNAME=$hostname\" &gt;&gt;/etc/sysconfig/MagOS"); system ($ssed); system("hostnamectl set-hostname $hostname"); return 1; } sub winbind(){ system ("sed -is/'server string ='/';server string ='/ /etc/samba/smb.conf"); system ("sed -i '/idmap backend = /d' /etc/samba/smb.conf"); my $wsed=sprintf("sed -i \'/\\[global\\]/ s/\$/\\nidmap config $domain : backend = ad\'/ /etc/samba/smb.conf"); system ($wsed); system ("sed -i '/winbind cache time /d' /etc/samba/smb.conf"); $wsed=sprintf("sed -i \'/\\[global\\]/ s/\$/\\nwinbind cache time = 1440\'/ /etc/samba/smb.conf"); system ($wsed); }</span></span></code> </pre><br></div></div><br>   ,     realm       $domain  $realm. ,     ‚Ä¶ <br><br><div class="spoiler"> <b class="spoiler_title">/usr/share/magos/ad_join/ad_join_x.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -w # MagOS-linux.ru # Author M.Zaripov # No testing use strict; use Glib qw/TRUE FALSE/; use Gtk3 '-init'; #standard window creation, placement, and signal connecting my $window = Gtk3::Window-&gt;new('toplevel'); $window-&gt;signal_connect('delete_event' =&gt; sub { Gtk3-&gt;main_quit; }); $window-&gt;set_border_width(5); $window-&gt;set_position('center_always'); #this vbox will geturn the bulk of the gui my $vbox = &amp;ret_vbox(); #add and show the vbox $window-&gt;add($vbox); $window-&gt;show(); #our main event-loop Gtk3-&gt;main(); sub ret_vbox { my $vbox = Gtk3::VBox-&gt;new(FALSE,5); $vbox-&gt;pack_start ("Gtk3::Label"-&gt;new (" Please input password to join into domain "), 0, 0, 0); # create table with 2 entries my $table1 = Gtk3::Table-&gt;new (5, 2, FALSE); my $t1l0 = Gtk3::Label-&gt;new_with_mnemonic("Domain: "); $t1l0-&gt;set_alignment (0, 0); $table1-&gt;attach_defaults ($t1l0, 0, 1, 0, 1); my $t1e0 = Gtk3::Entry-&gt;new(); $table1-&gt;attach_defaults ($t1e0, 1, 2, 0, 1); my $t1l0 = Gtk3::Label-&gt;new_with_mnemonic("workgroup: "); $t1l0-&gt;set_alignment (0, 0); $table1-&gt;attach_defaults ($t1l0, 0, 1, 1, 2); my $t1e1 = Gtk3::Entry-&gt;new(); $table1-&gt;attach_defaults ($t1e0, 1, 2, 1, 2); my $t1l0 = Gtk3::Label-&gt;new_with_mnemonic("computer name: "); $t1l0-&gt;set_alignment (0, 0); $table1-&gt;attach_defaults ($t1l0, 0, 1, 2, 3); my $t1e2 = Gtk3::Entry-&gt;new(); $table1-&gt;attach_defaults ($t1e0, 1, 2, 2, 3); my $t1l1 = Gtk3::Label-&gt;new_with_mnemonic("Domain Admin User Name: "); $t1l1-&gt;set_alignment (0, 0); $table1-&gt;attach_defaults ($t1l1, 0, 1, 3, 4); my $t1e3 = Gtk3::Entry-&gt;new(); $table1-&gt;attach_defaults ($t1e1, 1, 2, 3, 4); my $t1l2 = Gtk3::Label-&gt;new_with_mnemonic("Domain Admin Password: "); $t1l2-&gt;set_alignment (0, 0); $table1-&gt;attach_defaults ($t1l2, 0, 1, 4, 5); my $t1e4 = Gtk3::Entry-&gt;new(); $t1e2-&gt;set_visibility (FALSE); $table1-&gt;attach_defaults ($t1e2, 1, 2, 4, 5); $vbox-&gt;pack_start($table1, 0, 0 ,0); #$vbox-&gt;pack_end(Gtk3::HSeparator-&gt;new(),0, 0 ,0); # create table with 2 buttons my $table2 = Gtk3::Table-&gt;new (1, 2, FALSE); my $t2b1 = Gtk3::Button-&gt;new ('Join'); $table2-&gt;attach_defaults ($t2b1, 0, 1, 0, 1); my $t2b2 = Gtk3::Button-&gt;new ('Cancel'); $table2-&gt;attach_defaults ($t2b2, 1, 2, 0, 1); $t2b2-&gt;signal_connect (clicked =&gt; sub { Gtk3-&gt;main_quit; }); if (open (F1,"&lt;/etc/altlinux-release") ) { close F1; $t2b1-&gt;signal_connect (clicked =&gt; sub { &amp;addname($t1e2-&gt;get_text()) || system("system-auth write ad ".$t1e0-&gt;get_text().'%'.$t1e0-&gt;get_text()." ".#domain $t1e2-&gt;get_text().'%'.$t1e2-&gt;get_text()." ".# hostname $t1e1-&gt;get_text().'%'.$t1e1-&gt;get_text()." ".# workgroup $t1e3-&gt;get_text().'%'.$t1e3-&gt;get_text()." ".# username $t1e4-&gt;get_text().'%'.$t1e4-&gt;get_text()."\"") # password || system("systemctl restart nmb") || system("systemctl restart winbind") || system("systemctl restart smb") || exit (1); }); }else{ $t2b1-&gt;signal_connect (clicked =&gt; sub { &amp;addname($t1e2-&gt;get_text()) #hostname || system("net join -U \"". $t1e3-&gt;get_text().'%'. # username $t1e4-&gt;get_text()."\"") # password || system("systemctl restart nmb") || system("systemctl restart winbind") || system("systemctl restart smb") || exit (1); }); } $vbox-&gt;pack_start($table2, 0, 0 ,0); $vbox-&gt;show_all(); return $vbox; } sub addname (){ my ($hostname)=@_; system ("sed -i '/netbios name =/d' /etc/samba/smb.conf"); my $ssed=sprintf("sed -i \'/\\[global\\]/ s/\$/\\n netbios name = ".$hostname."\'/ /etc/samba/smb.conf"); system ($ssed); system ("sed -i '/HOSTNAME/d' /etc/sysconfig/MagOS"); $ssed=sprintf("echo \"HOSTNAME=$hostname\" &gt;&gt;/etc/sysconfig/MagOS"); system ($ssed); system("hostnamectl set-hostname $hostname"); return 1; }</span></span></code> </pre><br></div></div><br>       ,        .    MagOS    ,          Changes. <br><br><h6> <b><i>  AD</i></b> </h6><br>       ADS   :    winbind         AD,     .           ,        ‚Äî  .         AD,        .  ,      AD   .               ¬´¬ª. <br><br>    ,      winbind     AD.          systemd,   winbind ,     winbind   .    ,   ,  1 ‚Äî 2 .          ,  , ,     . <br><br>         ‚Äî       AD,    magos-patches       ,   MagOS.ini ‚Äî  ,        .                 /etc/skel      .  ,                winbind-restart.             . <br><br> ,  ,   ,         . <br><br><div class="spoiler"> <b class="spoiler_title">/usr/sbin/winbind-restart</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin while [ "$(wbinfo --online-status | grep -i mydomain | cut -d ":" -f 2)" != " online" ] do $(sleep 1) done $(systemctl restart winbind) . etc/sysconfig/MagOS # update home folders from domain users if [ "$UPDATEHOME" = "yes" ] ;then DOMAIN=$(wbinfo --own-domain) if [ -d home/$DOMAIN ] ;then for LISTUSER in $(ls -1 home/$DOMAIN/); do $(cp -rHun etc/skel/.[a-zA-Z0-9]* home/$DOMAIN/$LISTUSER/) $(chown -R $LISTUSER:\  home/$DOMAIN/$LISTUSER/) done fi fi</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">/etc/systemd/user/winbindrestart.service</b> <div class="spoiler_text"><pre> <code class="bash hljs">[Unit] Description=Samba Winbind Daemon restart from mydomain After=winbind.target [Service] Type=oneshot RemainAfterExit=yes ExecStart=/usr/sbin/winbind-restart [Install] WantedBy=multi-user.target</code> </pre><br></div></div><br><a name="7-4"></a><h5> <b>  (/root/bin)</b> </h5><br>       MagOS    AltLinux   . <br>   -     ,     .       ,     MagOS.ini. <br><br>      /root/bin/updatemagos.sh.        . <br><br><div class="spoiler"> <b class="spoiler_title">/root/bin/updatemagos.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo "Update MagOS from Hard Disk to this computer!!!" echo echo "Press Enter to continue, or Ctrl+C to abort..." read junk clear export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin SRC=192.168.1.XXX/magos DEFAULT="AltLinux,boot" . /mnt/live/liblinuxlive [ -f /etc/sysconfig/MagOS ] &amp;&amp; . /etc/sysconfig/MagOS [ -z "$UPDATE" -a -z "$SRCUPDATE" ] &amp;&amp; UPDATE=$(echo "$DEFAULT") &amp;&amp; SRCUPDATE="$SRC" if ! [ -z "$UPDATE" ] ;then for dirs in $(echo $UPDATE | tr ',;' ' ') ;do rsync -azr --delete rsync://$SRCUPDATE/$dirs/ /mnt/livemedia/$dirs/ done fi reboot</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">/root/bin/updateini.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # This script getting file MagOS.ini from magos server to this computer SRCI="magos-server/magos" SRC="magos" srv="magos-server" . /etc/sysconfig/MagOS export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin echo "Update MagOS.ini from Hard Disk!!!" [ -z "$SRCUPDATE" ] &amp;&amp; SRCUPDATE="$SRCI" SRCINI=$(echo $SRCUPDATE | cut -d "/" -f 2) [ -n "$SRCUPDATE" ] &amp;&amp; srv=$(echo $SRCUPDATE | cut -d '/' -f 1) if ! [ -z "$SRCINI" ];then SRC=$SRCINI fi if ! [ -z "$1" ] ;then SRC=$1 fi rsync -az rsync://$srv/$SRC/AltLinux/modules/i586/MagOS.ini /mnt/livemedia/AltLinux/modules/i586/MagOS.ini</span></span></code> </pre><br></div></div><br> /root/bin/mnt.sh ‚Äî             . <br><br><div class="spoiler"> <b class="spoiler_title">/root/bin/mnt.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # mount data disk from /srv mount /dev/sda3 /srv #groupadd -g 501 magos #groupadd -g 502 testing</span></span></code> </pre><br></div></div><br>  loadupdate  saveupdate               MagOS             . <br><br><div class="spoiler"> <b class="spoiler_title">/root/bin/saveupdate.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # This script save update folder from this computer to magos server # Fiskov MM export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin ENABLED=yes [ "$ENABLED" != "yes" ] &amp;&amp; exit 0 . /usr/lib/magos/scripts/liblinuxlive . /etc/sysconfig/MagOS . /mnt/livemedia/update/conf/devel.conf PWD=$(echo $(pwd)) cd /mnt/livemedia/update mkdir /root/tmp/update cp -r /mnt/livemedia/update/{*.sh,lib,conf} /root/tmp/update/ for files in $(echo $(ls 9*.sh| cut -d '.' -f 1)) ;do cp /mnt/livemedia/$DISTNAME/modules/$ARCH/$files.xzm /root/tmp/update/ done cd /root/tmp tar -czf /mnt/livemedia/update.tar.gz ./update cd /mnt/livemedia/ scp /mnt/livemedia/update.tar.gz $USER@$SERVER:/var/www/$DISTTYPE/ rm -rf /root/tmp/update cd $PWD</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">/root/bin/loadupdate.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # This script load update folder from magos server to this computer # export PATH=.:/:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/magos/scripts ENABLED=yes [ "$ENABLED" != "yes" ] &amp;&amp; exit 0 PWD=$(echo $(pwd)) . /etc/sysconfig/MagOS rsync -az rsync://$SRCUPDATE/update.tar.gz /mnt/livemedia/update.tar.gz cd /mnt/livemedia/ tar -xzf update.tar.gz cd /mnt/livemedia/update for files in $(echo $(ls 9*.sh| cut -d '.' -f 1)) ;do mkdir $files xzm2dir $files.xzm $files done cd $PWD</span></span></code> </pre><br></div></div><br><h6> <b><i>  </i></b> </h6><br>          ,       .       ‚Äî       ssh     .  hostalt-create.sh   ,      ,    MagOS    AltLinux.       ,   ¬´-a¬ª.    ,     . <br><br>       ,        .  ,     sudo     . <br><br>    ,           ,   AltLinux     alttlinux. <br><br><div class="spoiler"> <b class="spoiler_title">/root/bin/hostalt-create.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # create list from hostalt file from programm pssh $(nmap 192.168.1.0/24 -p T:8080 2&gt;&amp;1 | grep "mydomain" | grep '\-a' | cut -d " " -f 5 &gt;&gt; /tmp/hostalt1) $(sort -u /tmp/hostalt1 &gt; hostalt)</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">/root/bin/parallelssh.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # parallelssh.sh sudo /root/bin/updateini.sh &lt;password&gt; echo "parallelssh.sh &lt;\"command\"&gt; &lt;password&gt;" echo "parallelssh.sh sudo \"/root/bin/updateini.sh\" &lt;password&gt;" echo [ -z "$2" ] &amp;&amp; exit sshpass -p $2 pssh -x "-o StrictHostKeyChecking=no" -h hostalt -l altlinux -A -i $1 2&gt;&amp;1 &gt; /tmp/ssherr.txt cat /tmp/ssherr.txt</span></span></code> </pre><br></div></div><br><h6> <b><i>   </i></b> </h6><br>               magos-server. <br>     ,     libexec  ,   , ,  ,   ,         . <br><br>         ,       .   ‚Äî  ,       Unix ACL, . .   Posix . <br><br>      /update/conf/devel.conf. <br><br><pre> <code class="bash hljs">DISTTYPE=<span class="hljs-string"><span class="hljs-string">"testing"</span></span> DISTNAME=<span class="hljs-string"><span class="hljs-string">"AltLinux"</span></span> ARCH=<span class="hljs-string"><span class="hljs-string">"i586"</span></span> UPDETESRV=yes SERVER=192.168.0.3 USER=altlinux</code> </pre><br>  Here: <br><br> <b>DISTTYPE</b> ‚Äî     magos-server. <br> <b>DISTNAME</b> ‚Äî   . <br> <b>ARCH</b> ‚Äî  . <br>                   . <br> <b>UPDETESRV</b> ‚Äî       . SERVER ‚Äî   URL  magos-server. <br> <b>USER</b> ‚Äî   magos-server,      .             . <br><br>    : <br><br><div class="spoiler"> <b class="spoiler_title">/update/99-u50-example.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh . conf/devel.conf NAME=`echo $0 | sed 's/\.\///'| sed 's/\..*//'` . lib/mv.sh $NAME epm2xzm $NAME -i 'ntpdata samba' rm -rf $NAME mkdir $NAME xzm2dir $NAME.xzm $NAME #------------------------------------------- #    cp /usr/share/zoneinfo/Asia/Krasnoyarsk $NAME/etc/localtime cp /etc/nsswitch.conf $NAME/etc/nsswitch.conf sed -is/'^hosts: files mdns4_minimal \[NOTFOUND=return\]*'/'hosts: files dns mdns4_minimal \[NOTFOUND=return\] myhostname f #-------------------------------------------- . lib/delhlam.sh $NAME dir2xzm $NAME $NAME.xzm . lib/update.sh $NAME</span></span></code> </pre><br></div></div><br> ,      ,   ,      epm2xzm. <br><br><div class="spoiler"> <b class="spoiler_title">/update/lib/delhlam.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh NAME=$1 rm -rf $NAME/etc/urpmi $NAME/var/cach/ldconfig $NAME/var/cach/ldconfig/ $NAME/var/cache/ldconfig/ $NAME/var/lib/apt $NAME/var/log/rpmpk gs rm -f $NAME/etc/ld.so.cache $NAME/etc/resolv.conf rm -f $NAME/etc/xinetd.conf $NAME/etc/group- $NAME/etc/gshadow- $NAME/etc/passwd-</span></span></code> </pre><br></div></div><br>    c       . <br><br>    :    ,   ,   .bak.          ,   .            .old.        . <br><br><div class="spoiler"> <b class="spoiler_title">/update/lib/mv.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh NAME=$1 . conf/devel.conf if [ $NAME != "99-u99-default" ] ;then $(sh /usr/lib/magos/scripts/deactivate $NAME.xzm) fi if [ -f /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm.bak ] &amp;&amp; [ -f /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm ] ;then $(mv -nf /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm $NAME.xzm.old) fi</span></span></code> </pre><br></div></div><br>      modules      .       . <br><br><div class="spoiler"> <b class="spoiler_title">/update/lib/update.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash NAME=$1 . conf/devel.conf if [ ! -f /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm.bak ] ;then $(mv /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm.bak) fi $(mv $NAME.xzm /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm) $(chmod 664 /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm) $(chown :root /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm) if [ $NAME != "99-u99-default" ] ;then $(sh /usr/lib/magos/scripts/activate $NAME.xzm) else $(sh /usr/lib/magos/scripts/deactivate $NAME.xzm) $(sh /usr/lib/magos/scripts/activate $NAME.xzm) fi [ "$UPDETESRV" != "yes" ] &amp;&amp; exit 0 $(scp /mnt/livemedia/$DISTNAME/modules/$ARCH/$NAME.xzm $USER@$SERVER:~/$DISTTYPE/$DISTNAME/modules/$ARCH/)</span></span></code> </pre><br></div></div><br><a name="7-5"></a><h5> <b> ,    magos   </b> </h5><br>  MagOS        /tmp  /var/tmp    tmpfs.  Unit systemd   /tmp    tmpfs,    .          /etc/systemd/system/local-fs.target.wants: <br><br><pre> <code class="bash hljs">tmp.mount -&gt; /lib/systemd/system/tmp.mount var-tmp.mount -&gt; ../var-tmp.mount</code> </pre><br> Unit var-tmp.mount   . MagOS     VARTMPFS    /var/tmp ‚Üí /tmp.    CUPS   ,   unit   . <br><br><div class="spoiler"> <b class="spoiler_title">/etc/systemd/system/var-tmp.mount</b> <div class="spoiler_text"><pre> <code class="bash hljs">[Unit] Description=Temporary Directory Documentation=man:hier(7) Documentation=http://www.freedesktop.org/wiki/Software/systemd/APIFileSystems DefaultDependencies=no Conflicts=umount.target Before=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-fs.target umount.target [Mount] What=tmpfs Where=/var/tmp Type=tmpfs Options=mode=1777,strictatime</code> </pre><br></div></div><br> Unit    /var/tmp    tmpfs. <br><br><div class="spoiler"> <b class="spoiler_title">/etc/systemd/system/ntp-units.d/ntpd.service</b> <div class="spoiler_text"><pre> <code class="bash hljs">[Unit] Description=Network Time Service After=syslog.target network.target [Service] EnvironmentFile=/etc/sysconfig/ntpd ExecStart=/usr/sbin/ntpd -d <span class="hljs-variable"><span class="hljs-variable">$NTPD_ARGS</span></span> [Install] WantedBy=multi-user.target</code> </pre><br></div></div><br><a name="8"></a><h4> <b>  </b> </h4><br>  Alt Linux   MagOS: <br><br><ul><li>   bios   . </li><li>  AltLinux. </li><li>   ¬´altlinux¬ª    . </li><li>     ,         .       ! </li><li>  . </li><li>   : </li></ul><br><pre> <code class="bash hljs">$ su - Password:</code> </pre><br>      .  This is normal.  ,      mydomain: <br><br><ul><li>  : </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /usr/share/magos/install/magosinstall.sh</span></span></code> </pre><br><ul><li>        ¬´Enter¬ª.        ,  ^C. </li><li>  .    ,    . </li><li>       altlinux. </li><li>  . </li><li>   ,    . </li><li>       : </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /usr/share/magos/ad_join/ad_join.pl -h &lt;hostname&gt; -u &lt;username&gt; -p &lt;password&gt;</span></span></code> </pre><br>  Where: <br><br> <b>hostname</b> ‚Äî  .    . <br> <b>username</b> ‚Äî    mydomain.local. <br> <b>password</b> ‚Äî    mydomain.local. <br><br>      : <br><br><pre> <code class="bash hljs">Joined <span class="hljs-string"><span class="hljs-string">' '</span></span> to dns domain <span class="hljs-string"><span class="hljs-string">'mydomain.local'</span></span></code> </pre><br>       . <br><br><ul><li>     : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># wbinfo -u</span></span></code> </pre><br>        ,             .     . <br><br>          . </li><li>  . </li><li>         . </li><li>   ,     ,     ,  ¬´_¬ª   .   . <br>   ¬´ ¬ª.             . </li><li>     . </li><li>     bios . </li></ul><br><h6> <b><i>    </i></b> </h6><br>       .     .         . <br><br> <b><i>:   ,   .</i></b> </div><p>Source: <a href="https://habr.com/ru/post/270337/">https://habr.com/ru/post/270337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270327/index.html">Call Tracking Paying Lead, Not Numbers</a></li>
<li><a href="../270329/index.html">Correctly parsim logs from 3CX</a></li>
<li><a href="../270331/index.html">How to do almost no exceptions, replacing them with notifications</a></li>
<li><a href="../270333/index.html">Unofficial Firebird 3.0 Release Candidate 1 Installer</a></li>
<li><a href="../270335/index.html">SAP ERP / ABAP useful resources</a></li>
<li><a href="../270339/index.html">Observer vs Pub-Sub</a></li>
<li><a href="../270343/index.html">Building native applications in ExtJS 6</a></li>
<li><a href="../270347/index.html">How is the profession "Data Scientist"</a></li>
<li><a href="../270351/index.html">Pure architecture in a go app. Part 2</a></li>
<li><a href="../270353/index.html">Overview of ES6 at 350 points. Part one</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>