<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our malware. Part 1: Learn to write a completely ‚Äúundetectable‚Äù keylogger</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The hacker world can be divided into three groups of attackers: 


 1) "Skids" (script kiddies) - kids, novice hackers who collect well-known pieces o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our malware. Part 1: Learn to write a completely ‚Äúundetectable‚Äù keylogger</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/33f/774/e3b/33f774e3b6ad4b42a11616d133a5ab2f.jpeg" alt="image"><br><p>  The hacker world can be divided into three groups of attackers: </p><br><p>  1) "Skids" (script kiddies) - kids, novice hackers who collect well-known pieces of code and utilities and use them to create some simple malware. </p><br><p>  2) ‚ÄúByuers‚Äù are not good businessmen, teenagers and other thrill-seekers.  They buy services for writing such software on the Internet, collect various private information with its help, and, possibly, resell it. </p><br><p>  3) ‚ÄúBlack Hat oders‚Äù - programming gurus and architecture experts.  They write code in a notebook and develop new exploits from scratch. </p><br><p>  Can someone with good programming skills be the last?  I don‚Äôt think that you will start creating something like regin (link) after visiting several DEFCON sessions.  On the other hand, I believe that an information security officer should master some of the concepts on which malware is built. </p><br><p>  <b>Why do IB staff need these dubious skills?</b> <b><br></b> </p><a name="habracut"></a><br><p>  Know your enemy.  As we discussed on the Inside Out blog, you need to think like an intruder to stop him.  I am an information security specialist in Varonis and in my experience you will be stronger in this craft if you understand what moves the intruder will make.  Therefore, I decided to start a series of posts about the details that underlie the malware and various families of hacking tools.  Once you understand how easy it is to create non-detectable software, you may want to review the security policies in your enterprise.  Now in more detail. </p><br><p>  For this informal class ‚Äúhacking 101‚Äù, you need a little programming knowledge (C # and java) and a basic understanding of the Windows architecture.  Keep in mind that in reality, the malware is written in C / C ++ / Delphi, so as not to depend on frameworks. </p><br><p>  <b>Keylogger</b> </p><br><p>  A keylogger is software or some kind of physical device that can intercept and memorize keystrokes on a compromised machine.  This can be represented as a digital trap for each keystroke. <br>  Often, this function is implemented in other, more complex software, for example, Trojans (Remote Access Trojans RATS), which ensure the delivery of intercepted data back to the attacker.  There are also hardware keyloger, but they are less common, because  require direct physical access to the machine. </p><br><p>  Nevertheless, it is fairly easy to program to create basic functions of keylogger.  A WARNING.  If you want to try one of the following, make sure that you have permissions, and you are not harming the existing environment, and the best thing is to do it all on an isolated VM.  Further, this code will not be optimized, I will only show you lines of code that can complete the task, this is not the most elegant or optimal way.  Finally, I will not tell you how to make the keyloger resistant to reboots or try to make it completely undetectable thanks to special programming techniques, as well as protection against deletion, even if it was discovered. </p><br><p>  Let's start. </p><br><p>  To connect to the keyboard you just need to use 2 lines in C #: </p><br><pre><code class="hljs cs"><span class="hljs-number"><span class="hljs-number">1.</span></span> [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] <span class="hljs-number"><span class="hljs-number">2.</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAsyncKeyState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Int32 i</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><p>  You can learn more about GetAsyncKeyState on <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms633505%2528v%3Dvs.85%2529.aspx">MSDN</a> : </p><br><p>  To understand: this function determines whether the key was pressed or released at the time of the call and whether it was pressed after the previous call.  Now we constantly call this function to receive data from the keyboard: </p><br><pre> <code class="hljs matlab"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">true</span></span>) <span class="hljs-number"><span class="hljs-number">2.</span></span> { <span class="hljs-number"><span class="hljs-number">3.</span></span> Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Int32 <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) <span class="hljs-number"><span class="hljs-number">5.</span></span> { <span class="hljs-number"><span class="hljs-number">6.</span></span> int state = GetAsyncKeyState(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); <span class="hljs-number"><span class="hljs-number">7.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == <span class="hljs-number"><span class="hljs-number">1</span></span> || state == <span class="hljs-number"><span class="hljs-number">-32767</span></span>) <span class="hljs-number"><span class="hljs-number">8.</span></span> { <span class="hljs-number"><span class="hljs-number">9.</span></span> Console.WriteLine((Keys)<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); <span class="hljs-number"><span class="hljs-number">10.</span></span> <span class="hljs-number"><span class="hljs-number">11.</span></span> } <span class="hljs-number"><span class="hljs-number">12.</span></span> } <span class="hljs-number"><span class="hljs-number">13.</span></span> }</code> </pre> <br><p>  What's going on here?  This cycle will poll every 100 ms each key to determine its state.  If one of them is pressed (or pressed), a message will be displayed on the console.  In real life, this data is buffered and sent to the attacker. </p><br><p>  <b>Smart keylogger</b> <b><br></b> <br>  Wait a minute, is there any point in trying to shoot all the information in a row from all applications? <br>  The code above draws raw keyboard input from any window and input field that is now in focus.  If your goal is credit card numbers and passwords, then this approach is not very effective.  For scenarios from the real world, when such keyloggers are executed on hundreds or thousands of machines, the subsequent data parsing can become very long and eventually lose meaning, because  information valuable to the cracker may become obsolete by that time. </p><br><p>  Let's assume that I want to get hold of my Facebook or Gmail credentials for the subsequent sale of likes.  Then a new idea is to activate keylogging only when the browser window is active and the word Gmail or facebook is in the title of the page.  Using this method, I increase the chances of getting credentials. </p><br><p>  The second version of the code: </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) <span class="hljs-number"><span class="hljs-number">2.</span></span> { <span class="hljs-number"><span class="hljs-number">3.</span></span> IntPtr handle = GetForegroundWindow(); <span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetWindowText(handle, buff, chars) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">5.</span></span> { <span class="hljs-number"><span class="hljs-number">6.</span></span> string <span class="hljs-type"><span class="hljs-type">line</span></span> = buff.ToString(); <span class="hljs-number"><span class="hljs-number">7.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-type"><span class="hljs-type">line</span></span>.Contains("Gmail")|| <span class="hljs-type"><span class="hljs-type">line</span></span>.Contains("Facebook - Log In or Sign Up ")) <span class="hljs-number"><span class="hljs-number">8.</span></span> { <span class="hljs-number"><span class="hljs-number">9.</span></span> //  <span class="hljs-number"><span class="hljs-number">10.</span></span> } <span class="hljs-number"><span class="hljs-number">11.</span></span> } <span class="hljs-number"><span class="hljs-number">12.</span></span> Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-number"><span class="hljs-number">13.</span></span> }</code> </pre> <br><p>  This fragment will detect the active window every 100ms.  This is done using the GetForegroundWindow function (more information on MSDN).  The page title is stored in the buff variable, if it contains gmail or facebook, then a keyboard scan fragment is called. </p><br><p>  By this we have provided a keyboard scan only when the browser window is open on facebook and gmail sites. </p><br><p>  <b>Even more intelligent keylogger</b> </p><br><p>  Let's assume that the attacker was able to get the data in a code similar to ours.  We also assume that he is quite ambitious and was able to infect dozens or hundreds of thousands of cars.  Result: a huge file with gigabytes of text in which the necessary information still needs to be found.  It's time to get acquainted with regular expressions or regex.  This is something like a mini language for drawing up certain templates and scanning text for compliance with specified templates.  You can find out more here. </p><br><p>  To simplify, I will immediately provide ready-made expressions that correspond to login names and passwords: </p><br><pre> <code class="hljs tex">1. //   2. ^[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>!#<span class="hljs-formula"><span class="hljs-formula">$%&amp;'*+</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span></span><span class="hljs-formula">/=?</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">^</span></span></span></span></span><span class="hljs-formula">_`{|}~]+(</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[\w!#$%&amp;'*+\-/=?\^_`{|}~]</span></span></span></span></span><span class="hljs-formula">+)*@((([</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span></span><span class="hljs-formula">]+</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-formula">)+[a-zA-Z]{2,4})|(([0-9]{1,3}</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-formula">){3}[0-9]{1,3}))$</span></span> 3. 4. 5. //  6. (?=^.{6,}<span class="hljs-formula"><span class="hljs-formula">$)(?=.*</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span></span><span class="hljs-formula">)(?=.*[a-zA-Z])</span></span></code> </pre> <br><p>  These expressions here are a clue to what can be done using them.  Using regular expressions, you can search (t find!) Any constructions that have a specific and unchanging format, for example, passport numbers, credit card numbers, accounts, and even passwords. <br>  Indeed, regular expressions are not the most readable kind of code, but they are one of the programmer‚Äôs best friends if there are text parsing tasks.  In Java, C #, JavaScript and other popular languages, there are already ready-made functions to which you can transfer regular regular expressions. </p><br><p>  For C #, it looks like this: </p><br><pre> <code class="hljs tex">1. Regex re = new Regex(@"^[<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span>!#<span class="hljs-formula"><span class="hljs-formula">$%&amp;amp;'*+</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span></span><span class="hljs-formula">/=?</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">^</span></span></span></span></span><span class="hljs-formula">_`{|}~]+(</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[\w!#$%&amp;amp;'*+\-/=?\^_`{|}~]</span></span></span></span></span><span class="hljs-formula">+)*@((([</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">-</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">w</span></span></span></span></span><span class="hljs-formula">]+</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-formula">)+[a-zA-Z]{2,4})|(([0-9]{1,3}</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span></span><span class="hljs-formula">){3}[0-9]{1,3}))$</span></span>"); 2. Regex re2 = new Regex(@"(?=^.{6,}<span class="hljs-formula"><span class="hljs-formula">$)(?=.*</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">d</span></span></span></span></span><span class="hljs-formula">)(?=.*[a-zA-Z])"); 3. string email = "Oded.awask@gmail.com"; 4. string pass = "abcde3FG"; 5. Match result = re.Match(email); 6. Match result2 = re2.Match(pass);</span></span></code> </pre> <br><p>  Where the first expression (re) will correspond to any e-mail, and the second (re2) any alphanumeric construction is more than 6 characters. </p><br><p>  <b>Free and not fully detectable</b> </p><br><p>  In my example, I used Visual Studio ‚Äî you can use your favorite environment ‚Äî to create such a keylogger in 30 minutes. <br>  If I were a real attacker, then I would aim at some real goal (banking sites, social networks, etc.) and modified the code to match these goals.  Of course, also, I would launch a phishing campaign with emails with our program, under the guise of a regular account or other attachment. </p><br><p>  One question remains: will such software really be undetectable for security programs? </p><br><p>  I compiled my code and checked the exe file on the site Virustotal.  This is a web tool that calculates the hash of the file that you downloaded and searches it in a database of known viruses.  Surprise!  Naturally nothing was found. </p><br><p><img src="https://habrastorage.org/files/622/cb4/f55/622cb4f554354418bc6d5471d9e42469.jpg" alt="image"></p><br><p>  This is the main feature!  You can always change the code and develop, being always a few steps before the threat scanner.  If you are able to write your own code, it is almost guaranteed to be undetectable.  On <a href="https://www.virustotal.com/en/file/86beb2fe5cc228e68b25cad9014435e0105705a07b12cf46cf01f9867ab6ed38/analysis/1459752882/">this</a> page you can find a complete analysis. </p><br><p>  The main purpose of this article is to show that using only antiviruses alone you cannot fully ensure security in an enterprise.  We need a deeper <a href="https://www.varonis.com/ru">assessment of the actions of all users and even services</a> in order to identify potentially harmful actions. </p><br><p>  In the following article, I will show how to make a truly undetectable version of such software. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302458/">https://habr.com/ru/post/302458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302432/index.html">We use HTML and WebBrowser control as a UI for ordinary windows applications in C #</a></li>
<li><a href="../302438/index.html">Creating a blog on symfony 2.8 lts [Part 3]</a></li>
<li><a href="../302442/index.html">Deployer - convenient and flexible application deployment</a></li>
<li><a href="../302448/index.html">‚ÄúNo longer means better‚Äù: counterintuitive case from Google</a></li>
<li><a href="../302456/index.html">Haordic Organization Visa (Part 3)</a></li>
<li><a href="../302460/index.html">Migrating HipChat Server data from self-hosted VM to Amazon EC2</a></li>
<li><a href="../302462/index.html">Year with Runkeeper: Analysis and visualization of geodata about your travels</a></li>
<li><a href="../302464/index.html">Cooperative network virtualization in industrial server applications on Linux - a report by Vasily Tolstoy at SECR 2015</a></li>
<li><a href="../302466/index.html">Conference OS DAY 2016. Own system - its processor</a></li>
<li><a href="../302472/index.html">How to move the development center from Russia to the Czech Republic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>