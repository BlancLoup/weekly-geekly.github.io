<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>High availability cluster on postgresql 9.6 + repmgr + pgbouncer + haproxy + keepalived + control via telegram</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To date, the implementation procedure for ‚Äúfailover‚Äù in Postgresql is one of the most simple and intuitive. To implement it, you need to decide on fil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>High availability cluster on postgresql 9.6 + repmgr + pgbouncer + haproxy + keepalived + control via telegram</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/a17/d60/054/a17d600549ef46759aa32c7c22b4a2fc.png" alt="image"></div><br>  To date, the implementation procedure for <b>‚Äúfailover‚Äù</b> in Postgresql is one of the most simple and intuitive.  To implement it, you need to decide on file server scripts - this is the key to successful cluster operation, to test its operation.  In a nutshell - replication is configured, usually asynchronous, and in case of failure of the current master, the other node (standby) becomes the current ‚Äúmaster‚Äù, the other standby nodes begin to follow the new master. <br><br>  Today, repmgr supports the automatic Failover - autofailover script, which allows you to maintain the cluster in working condition after a master node fails without an immediate employee intervention, which is important, since there is no big UPTIME crash.  For notifications we use telegram. <br><br>  There is a need in connection with the development of internal services to implement the database storage system on Postgresql + replication + balancing + failover.  As always, the Internet seems to be something, but everything is outdated or not practical in practice in the form in which it is presented.  It was decided to present this solution so that in the future specialists who decided to implement such a scheme had an idea of ‚Äã‚Äãhow this is done, and that it was easy for newcomers to follow this instruction.  We tried to describe everything as detailed as possible, to grasp all the nuances and peculiarities. <br><a name="habracut"></a><br>  So, what we have: 5 VM with debian 8, Postgresql 9.6 + repmgr (for cluster management), balancing and HA based on HAPROXY (software for balancing and high availability of web applications and databases) and lightweight connection manager Pgbouncer, keepalived for ip address migration (VIP) between nodes, the 5th witness node to control the cluster and prevent the ‚Äúsplit brain‚Äù situations when the next master node could not be determined after the failure of the current master.  Notifications via telegram (without it as without hands). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's write the nodes / etc / hosts - for convenience, since everything will operate with domain names in the future. <br><br><div class="spoiler">  <b class="spoiler_title">file / etc / hosts</b> <div class="spoiler_text"><pre><code class="bash hljs">10.1.1.195 - pghost195 10.1.1.196 - pghost196 10.1.1.197 - pghost197 10.1.1.198 - pghost198 10.1.1.205 - pghost205</code> </pre> <br></div></div><br>  VIP 10.1.1.192 - write, 10.1.1.202 - roundrobin (balancing / read only). <br><br><h1>  Installing Postgresql 9.6 pgbouncer haproxy repmgr </h1><br>  We put on all nodes <br><br><div class="spoiler">  <b class="spoiler_title">Installing Postgresql-9.6 and repmgr debian 8</b> <div class="spoiler_text"><pre> <code class="bash hljs">touch /etc/apt/sources.list.d/pgdg.list <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ‚Äúdeb http://apt.postgresql.org/pub/repos/apt/ jessie-pgdg main‚Äù &gt; /etc/apt/sources.list.d/pgdg.list wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - apt-get update wget http://ftp.ru.debian.org/debian/pool/main/p/pkg-config/pkg-config_0.28-1_amd64.deb dpkg -i pkg-config_0.28-1_amd64.deb apt-get install postgresql-9.6-repmgr libevent-dev -y</code> </pre><br></div></div><br>  Turning off Postgresql autorun at system startup - all processes will be controlled by the postgres user.  It is also necessary in order to avoid situations where we can have two master nodes, after restoring one after a power failure, for example. <br><div class="spoiler">  <b class="spoiler_title">How to disable autorun</b> <div class="spoiler_text"><pre> <code class="bash hljs">nano /etc/postgresql/9.6/main/start.conf  auto  manual</code> </pre><br></div></div><br>  We will also use chkconfig to control and manage autorun. <br><div class="spoiler">  <b class="spoiler_title">Install chkconfig</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install chkconfig -y</code> </pre><br></div></div><br>  Watch autorun <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">/sbin/chkconfig --list</code> </pre><br></div></div><br>  Disable <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">update-rc.d postgresql <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span></code> </pre><br></div></div><br>  We look postgresql now <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">/sbin/chkconfig --list postgresql</code> </pre><br></div></div><br>  Is done.  We go further. <br><br>  <b>Configuring ssh connection without password - between all nodes (we do on all servers)</b> <br>  Set up connections between all servers and to yourself through the postgres user (repmgr is also connected via the postgres user). <br><br>  Install the packages that we need to work (immediately set) <br><br><div class="spoiler">  <b class="spoiler_title">We put ssh and rsync</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install openssh-server rsync -y</code> </pre><br></div></div><br>  To begin with we will install to it the local password for postgres (we will immediately do it on all nodes). <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">passwd postgres</code> </pre><br></div></div><br>  We introduce a new password. <br>  OK. <br>  Next, configure the ssh connection <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ ssh-keygen</code> </pre><br></div></div><br>  We generate a key - without a password. <br>  Put the key to other nodes <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@pghost195 ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@pghost196 ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@pghost197 ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@pghost198 ssh-copy-id -i ~/.ssh/id_rsa.pub postgres@pghost205</code> </pre><br></div></div><br>  In order for ssh not to ask whether you trust the host and do not issue other warnings and restrictions regarding security policy, we can add to the file <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">nano /etc/ssh/ssh_config StrictHostKeyChecking no UserKnownHostsFile=/dev/null</code> </pre><br></div></div><br>  Restart ssh.  This option is convenient when you do not care too much about security, for example, to test the cluster. <br><br>  Let's go to node 2,3,4 and repeat everything.  Now we can walk without passwords between the nodes to switch their status (assignment of a new master and standby). <br><br>  <b>We put pgbouncer from git</b> <br>  Install the necessary packages for assembly <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install libpq-dev checkinstall build-essential libpam0g-dev libssl-dev libpcre++-dev libtool automake checkinstall gcc+ git -y <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/pgbouncer/pgbouncer.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> pgbouncer git submodule init git submodule update ./autogen.sh wget https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz tar -xvf libevent-2.0.22-stable.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libevent* ./configure checkinstall <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br></div></div><br>  If you want postgresql with PAM authorization, then we put the module still at home and with configure we set --with-pam <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> ./configure --prefix=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> --with-libevent=libevent-prefix --with-pam make -j4 mkdir -p /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/doc; mkdir -p /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/man; checkinstall</code> </pre><br></div></div><br>  We put the version - 1.7.2 (as of November 2016). <br>  Is done.  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> Done. The new package has been installed and saved to /tmp/pgbouncer/pgbouncer_1.7.2-1_amd64.deb You can remove it from your system anytime using: dpkg -r pgbouncer_1.7.2-1_amd64.deb</code> </pre><br></div></div><br>  Be sure to configure the environment - add the variable PATH = / usr / lib / postgresql / 9.6 / bin: $ PATH (on each node). <br>  Add to ~ / .bashrc <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ nano .bashrc</code> </pre><br></div></div><br>  Paste the code <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">PATH=<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span>:/usr/lib/postgresql/9.6/bin <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PGDATA=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME</span></span></span><span class="hljs-string">/9.6/main"</span></span></code> </pre><br></div></div><br>  Keep it up <br>  Copy the file to .bashrc other nodes <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ scp .bashrc postgres@pghost195:/var/lib/postgresql scp .bashrc postgres@pghost196:/var/lib/postgresql scp .bashrc postgres@pghost197:/var/lib/postgresql scp .bashrc postgres@pghost198:/var/lib/postgresql scp .bashrc postgres@pghost205:/var/lib/postgresql</code> </pre><br></div></div><br><h2>  Setting up a server as a wizard (pghost195) </h2><br>  Let's edit the config /etc/postgresql/9.6/main/postgresql.conf - Make the necessary options appear (just add to the end of the file). <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">listen_addresses=<span class="hljs-string"><span class="hljs-string">'*'</span></span> wal_level = <span class="hljs-string"><span class="hljs-string">'hot_standby'</span></span> archive_mode = on wal_log_hints = on wal_keep_segments = 0 archive_command = <span class="hljs-string"><span class="hljs-string">'cd .'</span></span> max_replication_slots = 5 <span class="hljs-comment"><span class="hljs-comment">#   standby ,   . hot_standby = on shared_preload_libraries = 'repmgr_funcs, pg_stat_statements' ####  repmgr   postgres max_connections = 800 max_wal_senders = 10#            port = 5433 pg_stat_statements.max = 10000 pg_stat_statements.track = all</span></span></code> </pre><br></div></div><br>  As we can see, we will run postgresql on port 5433, because we will use the default port for applications for other purposes - namely, for balancing, proxying, and failover.  You can use any port as you wish. <br><br>  Configure the connection file <br><br>  nano /etc/postgresql/9.6/main/pg_hba.conf <br><br>  Let's bring to mind <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># IPv6 local connections: host all all ::1/128 md5 local all postgres peer local all all peer host all all 127.0.0.1/32 md5 #######################################           (MASTER, STAND BY). local replication repmgr trust host replication repmgr 127.0.0.1/32 trust host replication repmgr 10.1.1.0/24 trust local repmgr repmgr trust host repmgr repmgr 127.0.0.1/32 trust host repmgr repmgr 10.1.1.0/24 trust ###################################### host all all 0.0.0.0/32 md5 #######     #####################################</span></span></code> </pre><br></div></div><br>  Let's apply the rights to the configs, otherwise it will swear at pg_hba.conf <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">chown -R -v postgres /etc/postgresql</code> </pre><br></div></div><br>  We start postgres (from postgres user). <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">pg_ctl -D /etc/postgresql/9.6/main --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/postgres_screen.log start</code> </pre><br></div></div><br>  Setting up users and databases on the master server (pghost195). <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~</code> </pre><br></div></div><br>  Create a user repmgr. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">psql <span class="hljs-comment"><span class="hljs-comment"># create role repmgr with superuser noinherit; # ALTER ROLE repmgr WITH LOGIN; # create database repmgr; # GRANT ALL PRIVILEGES on DATABASE repmgr to repmgr; # ALTER USER repmgr SET search_path TO repmgr_test, "$user", public;</span></span></code> </pre><br></div></div><br><br>  Create user test_user with password 1234 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">create user test_user; ALTER USER test_user WITH PASSWORD <span class="hljs-string"><span class="hljs-string">'1234'</span></span>;</code> </pre><br></div></div><br>  Configuring repmgr on master <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">nano /etc/repmgr.conf</code> </pre><br></div></div><br>  Content <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_test node=1 node_name=node1 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost195 port=5433 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin</code> </pre><br></div></div><br>  Persist. <br>  Register the server as a master. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf master register</code> </pre><br></div></div><br>  See our status <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -f /etc/repmgr.conf cluster show</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">Role | Name | Upstream | Connection String ----------+-------|----------|-------------------------------------------------- * master | node1 | | host=pghost195 port=5433 user=repmgr dbname=repmgr</code> </pre><br></div></div><br>  Go ahead. <br><h2>  Setting up slaves (standby) - pghost196, pghost197, pghost198 </h2><br>  Configuring repmgr on slave1 (pghost197) <br>  nano /etc/repmgr.conf - create a config <br>  Content <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_test node=2 node_name=node2 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost196 port=5433 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin</code> </pre><br></div></div><br>  Persist. <br>  Register server as standby <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/9.6/ rm -rf main/* repmgr -h pghost1 -p 5433 -U repmgr -d repmgr -D main -f /etc/repmgr.conf --copy-external-config-files=pgdata --verbose standby <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> pg_ctl -D /var/lib/postgresql/9.6/main --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/postgres_screen.log start</code> </pre><br></div></div><br>  Configs will be copied based on which there will be a switching of the master and standby state of the servers. <br><br>  Let's browse the files that are in the root of the /var/lib/postgresql/9.6/main folder - these files must be included. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">PG_VERSION backup_label pg_hba.conf pg_ident.conf postgresql.auto.conf postgresql.conf recovery.conf</code> </pre><br></div></div><br>  Register server in cluster <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby register; repmgr -f /etc/repmgr.conf cluster show    repmgr -f /etc/repmgr.conf cluster show  &lt;spoiler title=<span class="hljs-string"><span class="hljs-string">""</span></span>&gt; &lt;<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> lang=<span class="hljs-string"><span class="hljs-string">"bash"</span></span>&gt; Role | Name | Upstream | Connection String ----------+-------|----------|-------------------------------------------------- * master | node195 | | host=pghost195 port=5433 user=repmgr dbname=repmgr standby | node196 | node1 | host=pghost196 port=5433 user=repmgr dbname=repmgr</code> </pre><br></div></div><br>  <b>Setting up a second stand-by - pghost197</b> Configuring repmgr on pghost197 <br>  nano /etc/repmgr.conf - create a config <br>  Content <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_test node=3 node_name=node3 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost197 port=5433 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin</code> </pre><br></div></div><br>  Persist. <br>  Register server as standby <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/9.6/ rm -rf main/* repmgr -h pghost195 -p 5433 -U repmgr -d repmgr -D main -f /etc/repmgr.conf --copy-external-config-files=pgdata --verbose standby <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span></code> </pre><br></div></div><br>  or <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -D /var/lib/postgresql/9.6/main -f /etc/repmgr.conf -d repmgr -p 5433 -U repmgr -R postgres --verbose --force --rsync-only --copy-external-config-files=pgdata standby <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -h pghost195</code> </pre><br></div></div><br>  This command with the -r / - rsync-only option is used in some cases, for example, when the data directory being copied is the data directory of the failed server with the active replication node. <br>  Configs will also be copied based on which the switching of the master and standby state of the servers will occur. <br>  Let's browse the files that are in the root of the /var/lib/postgresql/9.6/main folder - the following files must be present: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">PG_VERSION backup_label pg_hba.conf pg_ident.conf postgresql.auto.conf postgresql.conf recovery.conf</code> </pre><br></div></div><br>  Starting postgres (from postgres) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">pg_ctl -D /var/lib/postgresql/9.6/main --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/postgres_screen.log start</code> </pre><br></div></div><br>  Register server in cluster <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby register</code> </pre><br></div></div><br>  View Cluster Status <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -f /etc/repmgr.conf cluster show</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">Role | Name | Upstream | Connection String ----------+-------|----------|-------------------------------------------------- * master | node1 | | host=pghost1 port=5433 user=repmgr dbname=repmgr standby | node2 | node1 | host=pghost2 port=5433 user=repmgr dbname=repmgr standby | node3 | node1 | host=pghost2 port=5433 user=repmgr dbname=re</code> </pre><br></div></div><br><br><h2>  Configure cascade replication. </h2><br>  You can also customize cascading replication.  Consider an example.  Configuring repmgr on pghost198 from pghost197 <br>  nano /etc/repmgr.conf - create a config.  Content <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_test node=4 node_name=node4 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost198 port=5433 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin upstream_node=3</code> </pre><br></div></div><br>  Persist.  As we can see, in upstream_node we specified node3, which is pghost197. <br>  We register the server as standby from standby <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/9.6/ rm -rf main/* repmgr -h pghost197 -p 5433 -U repmgr -d repmgr -D main -f /etc/repmgr.conf --copy-external-config-files=pgdata --verbose standby <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span></code> </pre><br></div></div><br>  Starting postgres (from postgres) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">pg_ctl -D /var/lib/postgresql/9.6/main --<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/postgres_screen.log start</code> </pre><br></div></div><br>  Register server in cluster <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby register</code> </pre><br></div></div><br>  View Cluster Status <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -f /etc/repmgr.conf cluster show</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">Role | Name | Upstream | Connection String ----------+-------|----------|-------------------------------------------------- * master | node1 | | host=pghost195 port=5433 user=repmgr dbname=repmgr standby | node2 | node1 | host=pghost196 port=5433 user=repmgr dbname=repmgr standby | node3 | node1 | host=pghost197 port=5433 user=repmgr dbname=repmgr standby | node4 | node3 | host=pghost198 port=5433 user=repmgr dbname=repmgr</code> </pre><br></div></div><br><h2>  Configure Automatic Failover. </h2><br><img src="https://habrastorage.org/files/d2f/f3f/f7d/d2ff3ff7de0f43fb8b8b19bcfaf73474.png" alt="image"><br><br>  So, we‚Äôve finished streaming replication setup.  Now let's proceed to setting up auto-switching - activating a new wizard from the stand-by server.  To do this, you need to add new sections to the /etc/repmgr.conf file on stand-by servers.  On the master of this should not be! <br><br>  !  Configs on standby (slave's) should be different - as in the example below.  Let's set a different time (master_responce_timeout)! <br><br>  Add lines to pghost196 in /etc/repmgr.conf <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">####### FAILOVER#######  STAND BY################## master_response_timeout=20 reconnect_attempts=5 reconnect_interval=5 failover=automatic promote_command='sh /etc/postgresql/failover_promote.sh' follow_command='sh /etc/postgresql/failover_follow.sh' #loglevel=NOTICE #logfacility=STDERR #logfile='/var/log/postgresql/repmgr-9.6.log' priority=90 # a value of zero or less prevents the node being promoted to master</span></span></code> </pre><br></div></div><br>  Add lines to pghost197 in /etc/repmgr.conf <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">####### FAILOVER#######  STAND BY################## master_response_timeout=20 reconnect_attempts=5 reconnect_interval=5 failover=automatic promote_command='sh /etc/postgresql/failover_promote.sh' follow_command='sh /etc/postgresql/failover_follow.sh' #loglevel=NOTICE #logfacility=STDERR #logfile='/var/log/postgresql/repmgr-9.6.log' priority=70 # a value of zero or less prevents the node being promoted to master</span></span></code> </pre><br></div></div><br>  Add lines to pghost198 in /etc/repmgr.conf <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">####### FAILOVER#######  STAND BY################## master_response_timeout=20 reconnect_attempts=5 reconnect_interval=5 failover=automatic promote_command='sh /etc/postgresql/failover_promote.sh' follow_command='sh /etc/postgresql/failover_follow.sh' #loglevel=NOTICE #logfacility=STDERR #logfile='/var/log/postgresql/repmgr-9.6.log' priority=50 # a value of zero or less prevents the node being promoted to master</span></span></code> </pre><br></div></div><br>  As we can see, all auto-fixer settings are identical, the only difference is in priority.  If 0, then this Standby will never become a Master.  This parameter will determine the order of failover operation, i.e.  a smaller number indicates a higher priority, then after the master server fails, pghost197 will take over its function. <br><br>  It is also necessary to add the following lines to the /etc/postgresql/9.6/main/postgresql.conf file (only on the stand-by server !!!!!!) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'repmgr_funcs'</span></span></code> </pre><br></div></div><br>  To start the auto-switching daemon, you must: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/repmgr.log 2&gt;&amp;1</code> </pre><br></div></div><br>  The repmgrd process will run as a daemon.  We look <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">ps aux | grep repmgrd</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">postgres 2921 0.0 0.0 59760 5000 ? S 16:54 0:00 /usr/lib/postgresql/9.6/bin/repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v postgres 3059 0.0 0.0 12752 2044 pts/1 S+ 16:54 0:00 grep repmgrd</code> </pre><br></div></div><br>  All OK.  Go ahead. <br><br>  Check the work auto-file <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres psql repmgr repmgr <span class="hljs-comment"><span class="hljs-comment"># SELECT * FROM repmgr_etagi_test.repl_nodes ORDER BY id; id | type | upstream_node_id | cluster | name | conninfo | slot_name | priority | active ----+---------+------------------+------------+-------+---------------------------------------------------+---------------+----------+-------- 1 | master | | etagi_test | node1 | host=pghost195 port=5433 user=repmgr dbname=repmgr | repmgr_slot_1 | 100 | t 2 | standby | 1 | etagi_test | node2 | host=pghost196 port=5433 user=repmgr dbname=repmgr | repmgr_slot_2 | 100 | t 3 | standby | 1 | etagi_test | node3 | host=pghost197 port=5433 user=repmgr dbname=repmgr | repmgr_slot_3 | 100 | t</span></span></code> </pre><br></div></div><br>  So far so good - now we will test.  Stop Master - pghost195 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres pg_ctl -D /etc/postgresql/9.6/main -m immediate stop</code> </pre><br></div></div><br>  In the logs on pghost196 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/*</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">[2016-10-21 16:58:34] [NOTICE] promoting standby [2016-10-21 16:58:34] [NOTICE] promoting server using <span class="hljs-string"><span class="hljs-string">'/usr/lib/postgresql/9.6/bin/pg_ctl -D /var/lib/postgresql/9.6/main promote'</span></span> [2016-10-21 16:58:36] [NOTICE] STANDBY PROMOTE successful</code> </pre><br></div></div><br><br>  In the logs on pghost197 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/*</code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">2016-10-21 16:58:39] [NOTICE] node 2 is the best candidate <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> new master, attempting to follow... [2016-10-21 16:58:40] [ERROR] connection to database failed: could not connect to server: Connection refused Is the server running on host <span class="hljs-string"><span class="hljs-string">"pghost195"</span></span> (10.1.1.195) and accepting TCP/IP connections on port 5433? [2016-10-21 16:58:40] [NOTICE] restarting server using <span class="hljs-string"><span class="hljs-string">'/usr/lib/postgresql/9.6/bin/pg_ctl -w -D /var/lib/postgresql/9.6/main -m fast restart'</span></span> [2016-10-21 16:58:42] [NOTICE] node 3 now following new upstream node 2</code> </pre><br></div></div><br>  Everything is working.  We have a new master - pghost196, pghost197, pghost198 - now listens to stream from pghost2. <br><br><h2>  Return fallen master in build! </h2><br><img src="https://habrastorage.org/files/9e1/462/b34/9e1462b341eb4b478d04681399263e36.png" alt="image"><br><br>  You can not just take and return the fallen master in the system.  But he will return as a slave. <br><br>  Postgres must be stopped before returning.  On the node that failed create a script.  In this script, telegram notification has already been set up, and trigger check is set up - if the / etc / postgresql / disabled file is created, then recovery will not occur.  We will also create the file /etc/postgresql/current_master.list with the contents - the name of the current master. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/postgresql/current_master.list</b> <div class="spoiler_text"><pre> <code class="bash hljs">pghost196</code> </pre><br></div></div><br>  Let's call the script "register.sh" and place it in the / etc / postgresql directory <br>  Script recovery nodes in the cluster as a standby <br><br><div class="spoiler">  <b class="spoiler_title">/etc/postgresql/register.sh.</b> <div class="spoiler_text"><pre> <code class="bash hljs">trigger=<span class="hljs-string"><span class="hljs-string">"/etc/postgresql/disabled"</span></span> TEXT=<span class="hljs-string"><span class="hljs-string">"'`hostname -f`_postgresql_disabled_and_don't_be_started.You_must_delete_file_/etc/postgresql/disabled'"</span></span> TEXT <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$trigger</span></span></span><span class="hljs-string">"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Current server is disabled"</span></span> sh /etc/postgresql/telegram.sh <span class="hljs-variable"><span class="hljs-variable">$TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> pkill repmgrd pg_ctl stop rm -rf /var/lib/postgresql/9.6/main/*; mkdir /var/run/postgresql/9.6-main.pg_stat_tmp; <span class="hljs-comment"><span class="hljs-comment">#repmgr -D /var/lib/postgresql/9.6/main -f /etc/repmgr.conf -d repmgr -p 5433 -U repmgr -R postgres --verbose --force --rsync-only --copy-external-config-files=pgdata standby clone -h $(cat /etc/postgresql/current_master.list); repmgr -h $(cat /etc/postgresql/current_master.list) -p 5433 -U repmgr -d repmgr -D /var/lib/postgresql/9.6/main -f /etc/repmgr.conf --copy-external-config-files=pgdata --verbose standby clone /usr/lib/postgresql/9.6/bin/pg_ctl -D /var/lib/postgresql/9.6/main --log=/var/log/postgresql/postgres_screen.log start; /bin/sleep 5; repmgr -f /etc/repmgr.conf --force standby register; echo "  "; repmgr -f /etc/repmgr.conf cluster show; sh /etc/postgresql/telegram.sh $TEXT sh /etc/postgresql/repmgrd.sh; ps aux | grep repmgrd; fi</span></span></code> </pre><br></div></div><br>  As you can see, we also have in the script a file repmgrd.sh and telegram.sh.  They should also be located in the / etc / postgresql directory. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/postgresql/repmgrd.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash pkill repmgrd rm /var/run/postgresql/repmgrd.pid; repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v &gt;&gt; /var/log/postgresql/repmgr.log 2&gt;&amp;1; ps aux | grep repmgrd;</span></span></code> </pre><br></div></div><br>  Script to send to telegrams. <br><br><div class="spoiler">  <b class="spoiler_title">telegram.sh.</b> <div class="spoiler_text"><pre> <code class="bash hljs">USERID=<span class="hljs-string"><span class="hljs-string">"_____"</span></span> CLUSTERNAME=<span class="hljs-string"><span class="hljs-string">"PGCLUSTER_RIES"</span></span> KEY=<span class="hljs-string"><span class="hljs-string">"__"</span></span> TIMEOUT=<span class="hljs-string"><span class="hljs-string">"10"</span></span> EXEPT_USER=<span class="hljs-string"><span class="hljs-string">"root"</span></span> URL=<span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/bot</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$KEY</span></span></span><span class="hljs-string">/sendMessage"</span></span> DATE_EXEC=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(date "+%d %b %Y %H:%M")</span></span></span><span class="hljs-string">"</span></span> TMPFILE=<span class="hljs-string"><span class="hljs-string">'/etc/postgresql/ipinfo-$DATE_EXEC.txt'</span></span> IP=$(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$SSH_CLIENT</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>) PORT=$(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$SSH_CLIENT</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $3}'</span></span>) HOSTNAME=$(hostname -f) IPADDR=$(hostname -I | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>) curl http://ipinfo.io/<span class="hljs-variable"><span class="hljs-variable">$IP</span></span> -s -o <span class="hljs-variable"><span class="hljs-variable">$TMPFILE</span></span> <span class="hljs-comment"><span class="hljs-comment">#ORG=$(cat $TMPFILE | jq '.org' | sed 's/"//g') TEXT=$1 for IDTELEGRAM in $USERID do curl -s --max-time $TIMEOUT -d "chat_id=$IDTELEGRAM&amp;disable_web_page_preview=1&amp;text=$TEXT" $URL &gt; /dev/null done rm $TMPFILE</span></span></code> </pre><br></div></div><br>  Edit the repmgr config on the fallen master <br><br><div class="spoiler">  <b class="spoiler_title">/etc/repmgr.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_cluster1 node=1 node_name=node195 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost195 port=5433 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin <span class="hljs-comment"><span class="hljs-comment">####### FAILOVER#######  STAND BY################## master_response_timeout=20 reconnect_attempts=5 reconnect_interval=5 failover=automatic promote_command='sh /etc/postgresql/failover_promote.sh' follow_command='sh /etc/postgresql/failover_follow.sh' #loglevel=NOTICE #logfacility=STDERR #logfile='/var/log/postgresql/repmgr-9.6.log' priority=95 # a value of zero or less prevents the node being promoted to master</span></span></code> </pre><br></div></div><br>  Keep it up  Now run our script on the failed node.  Do not forget about the rights (postgres) for files. <br><br>  sh /etc/postgresq/register.sh <br><br>  Will see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">[2016-10-31 15:19:53] [NOTICE] notifying master about backup completion... :  pg_stop_backup ,    WAL  [2016-10-31 15:19:54] [NOTICE] standby <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> (using rsync) complete [2016-10-31 15:19:54] [NOTICE] you can now start your PostgreSQL server [2016-10-31 15:19:54] [HINT] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> example : pg_ctl -D /var/lib/postgresql/9.6/main start [2016-10-31 15:19:54] [HINT] After starting the server, you need to register this standby with <span class="hljs-string"><span class="hljs-string">"repmgr standby register"</span></span>   [2016-10-31 15:19:59] [NOTICE] standby node correctly registered <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> cluster etagi_cluster1 with id 2 (conninfo: host=pghost196 port=5433 user=repmgr dbname=repmgr)    Role | Name | Upstream | Connection String ----------+---------|----------|---------------------------------------------------- * standby | node195 | | host=pghost195 port=5433 user=repmgr dbname=repmgr master | node196 | node195 | host=pghost197 port=5433 user=repmgr dbname=repmgr standby | node197 | node195 | host=pghost198 port=5433 user=repmgr dbname=repmgr standby | node198 | node195 | host=pghost196 port=5433 user=repmgr dbname=repmgr postgres 11317 0.0 0.0 4336 716 pts/0 S+ 15:19 0:00 sh /etc/postgresql/repmgrd.sh postgres 11322 0.0 0.0 59548 3632 ? R 15:19 0:00 /usr/lib/postgresql/9.6/bin/repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v postgres 11324 0.0 0.0 12752 2140 pts/0 S+ 15:19 0:00 grep repmgrd postgres 11322 0.0 0.0 59548 4860 ? S 15:19 0:00 /usr/lib/postgresql/9.6/bin/repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v postgres 11327 0.0 0.0 12752 2084 pts/0 S+ 15:19 0:00 grep repmgrd</code> </pre><br></div></div><br>  As we can see the script worked, we received notifications and saw the status of the cluster. <br><br><h2>  Implementing the Switchover procedure (manual wizard shifts). </h2><br>  Suppose there is such a situation when you need to swap the master and a certain standby.  Suppose we want to make the master pghost195 instead of the pghost196 that has become on the filer, after it has been restored as a slave.  Our steps. <br>  On pghost195 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby switchover  [2016-10-26 15:29:42] [NOTICE] replication slot <span class="hljs-string"><span class="hljs-string">"repmgr_slot_1"</span></span> deleted on former master [2016-10-26 15:29:42] [NOTICE] switchover was successful</code> </pre><br></div></div><br>  Now we need to give the command to the replicas, except the old master, to give the command to transfer to the new master. <br>  On pghost197 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby follow repmgr -f /etc/repmgr.conf cluster show;</code> </pre><br></div></div><br>  We see that we are following the new master. <br>  Pghost198 is the same <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby follow repmgr -f /etc/repmgr.conf cluster show;</code> </pre><br></div></div><br>  We see that we are following the new master. <br>  On pghost196 - he was a previous master, from whom we took away the rights <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres repmgr -f /etc/repmgr.conf standby follow</code> </pre><br></div></div><br>  We see an error <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">[2016-10-26 15:35:51] [ERROR] Slot <span class="hljs-string"><span class="hljs-string">'repmgr_slot_2'</span></span> already exists as an active slot</code> </pre><br></div></div><br>  We pghost196 <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">pg_ctl stop</code> </pre><br></div></div><br>  To fix it, go to the phgost195 (new master) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres psql repmgr <span class="hljs-comment"><span class="hljs-comment">#select pg_drop_replication_slot('repmgr_slot_2');</span></span></code> </pre><br></div></div><br>  We see <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> pg_drop_replication_slot -------------------------- (1 row)</code> </pre><br></div></div><br>  Go to pghost196, and do everything by analogy with the paragraph. <br><br><h2>  Creating and using witness nodes </h2><br><img src="https://habrastorage.org/files/981/b52/b7b/981b52b7beff496cbb92c915f0f4909a.png" alt="image"><br><br>  Witness node is used to manage the cluster, in the event of a filer and acts as a kind of arbiter, makes sure that no conflict occurs when choosing a new master.  It is not an active node in terms of using it as a standby server; it can be installed on the same node as postgres or on a separate node. <br><br>  Add another pghost205 node to manage the cluster (the setting is absolutely the same as the slave setting), the copying method will be different: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -h pghost195 -p 5433 -U repmgr -d repmgr -D main -f /etc/repmgr.conf --force --copy-external-config-files=pgdata --verbose witness create;  repmgr -D /var/lib/postgresql/9.6/main -f /etc/repmgr.conf -d repmgr -p 5433 -U repmgr -R postgres --verbose --force --rsync-only --copy-external-config-files=pgdata witness create -h pghost195;</code> </pre><br></div></div><br>  See the output <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">2016-10-26 17:27:06] [WARNING] --copy-external-config-files can only be used when executing STANDBY CLONE [2016-10-26 17:27:06] [NOTICE] using configuration file <span class="hljs-string"><span class="hljs-string">"/etc/repmgr.conf"</span></span> ,    ,    <span class="hljs-string"><span class="hljs-string">"postgres"</span></span>.        .        <span class="hljs-string"><span class="hljs-string">"ru_RU.UTF-8"</span></span>.    ,     : <span class="hljs-string"><span class="hljs-string">"UTF8"</span></span>.       <span class="hljs-string"><span class="hljs-string">"russian"</span></span>.     .      main...   ...    max_connections... 100   shared_buffers... 128MB      ... posix   ...     ...     ...     ...  :    <span class="hljs-string"><span class="hljs-string">"trust"</span></span>   .    ,  pg_hba.conf    -A, --auth-local  --auth-host    initdb. .       : /usr/lib/postgresql/9.6/bin/pg_ctl -D main -l logfile start   ....:    : 2016-10-26 17:27:07 YEKT :       :      :        Warning: Permanently added <span class="hljs-string"><span class="hljs-string">'pghost1,10.1.9.1'</span></span> (ECDSA) to the list of known hosts. receiving incremental file list pg_hba.conf 1,174 100% 1.12MB/s 0:00:00 (xfr<span class="hljs-comment"><span class="hljs-comment">#1, to-chk=0/1) :  SIGHUP,       [2016-10-26 17:27:10] [NOTICE] configuration has been successfully copied to the witness /usr/lib/postgresql/9.6/bin/pg_ctl -D /var/lib/postgresql/9.6/main -l logfile start</span></span></code> </pre><br></div></div><br>  Is done.  We go further.  Manage repmgr.conf file for witness nodes <br>  Disable the automatic filer on the witness node. <br><br><div class="spoiler">  <b class="spoiler_title">nano /etc/repmgr.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">cluster=etagi_test node=5 node_name=node5 use_replication_slots=1 conninfo=<span class="hljs-string"><span class="hljs-string">'host=pghost205 port=5499 user=repmgr dbname=repmgr'</span></span> pg_bindir=/usr/lib/postgresql/9.6/bin <span class="hljs-comment"><span class="hljs-comment">#######FAILOVER#######  WITNESS NODE####### master_response_timeout=50 reconnect_attempts=3 reconnect_interval=5 failover=manual promote_command='repmgr standby promote -f /etc/repmgr.conf' follow_command='repmgr standby follow -f /etc/repmgr.conf'</span></span></code> </pre><br></div></div><br>  On the witness node, be sure to change the port to 5499 in conninfo. <br><br>  Be sure to (re) run the repmgrd on all nodes except the master <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres pkill repmgr repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/repmgr.log 2&gt;&amp;1 ps aux | grep repmgr</code> </pre><br></div></div><br><h2>  Configure the Pgbouncer connection manager and balancing via Haproxy.  Fault tolerance through keepalived. </h2><br><img src="https://habrastorage.org/files/62b/ea1/e49/62bea1e49275499bb90100f7935c0b1d.png" alt="image"><br><h3>  Pgbouncer setup </h3><br>  Pgbouncer we have already installed in advance.  What is it for ... <br><br><div class="spoiler">  <b class="spoiler_title">Why pgbouncer</b> <div class="spoiler_text"><pre> <code class="bash hljs">  .      Postgres,             .      PgBouncer       .</code> </pre><br></div></div><br>  Let's move on to setting it up. <br>  Copy the installed pgbouncer to the / etc / folder (for convenience) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">cp -r /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/doc/pgbouncer /etc <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/pgbouncer</code> </pre><br></div></div><br>  We bring to mind the file in <br><br><div class="spoiler">  <b class="spoiler_title">nano /etc/pgbouncer/pgbouncer.ini</b> <div class="spoiler_text"><pre> <code class="bash hljs">[databases] <span class="hljs-comment"><span class="hljs-comment">################################  ########### web1 = host = localhost port=5433 dbname=web1 web2 = host = localhost port=5433 dbname=web2 ####################################################### [pgbouncer] logfile = /var/log/postgresql/pgbouncer.log pidfile = /var/run/postgresql/pgbouncer.pid listen_addr = * listen_port = 6432 auth_type = trust auth_file = /etc/pgbouncer/userlist.txt ;;; Pooler personality questions ; When server connection is released back to pool: ; session - after client disconnects ; transaction - after transaction finishes ; statement - after statement finishes pool_mode = session server_reset_query = DISCARD ALL max_client_conn = 500 default_pool_size = 30</span></span></code> </pre><br></div></div><br>   <br><br><div class="spoiler"> <b class="spoiler_title">/etc/pgbouncer/userlist.txt</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"test_user"</span></span> <span class="hljs-string"><span class="hljs-string">"passworduser"</span></span> <span class="hljs-string"><span class="hljs-string">"postgres"</span></span> <span class="hljs-string"><span class="hljs-string">"passwordpostgres"</span></span> <span class="hljs-string"><span class="hljs-string">"pgbouncer"</span></span> <span class="hljs-string"><span class="hljs-string">"fake"</span></span></code> </pre><br></div></div><br>   <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">chown -R postgres /etc/pgbouncer</code> </pre><br></div></div><br>       (-d) <br><br><div class="spoiler"> <b class="spoiler_title"> pgbouncer</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres pkill pgbouncer pgbouncer -d --verbose /etc/pgbouncer/pgbouncer.ini</code> </pre><br></div></div><br>   <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> netstat -4ln | grep 6432</code> </pre><br></div></div><br>   <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/pgbouncer.log</code> </pre><br></div></div><br>  .      . <br><br><h2>    Haproxy. </h2><br><img src="https://habrastorage.org/files/b5f/562/caa/b5f562caa1a14965a7eea3f3c9c3bfab.png" alt="image"><br>  Xinetd  Haproxy <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install xinetd haproxy -y</code> </pre><br></div></div><br>      <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">nano /etc/services pgsqlchk 23267/tcp <span class="hljs-comment"><span class="hljs-comment"># pgsqlchk</span></span></code> </pre><br></div></div><br>      postgres ‚Äî pgsqlcheck <br><br><div class="spoiler"> <b class="spoiler_title">nano /opt/pgsqlchk</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # /opt/pgsqlchk # This script checks if a postgres server is healthy running on localhost. It will # return: # # "HTTP/1.x 200 OK\r" (if postgres is running smoothly) # # - OR - # # "HTTP/1.x 500 Internal Server Error\r" (else) # # The purpose of this script is make haproxy capable of monitoring postgres properly # # # It is recommended that a low-privileged postgres user is created to be used by # this script. # For eg. create user pgsqlchkusr login password 'pg321'; # PGSQL_HOST="localhost" PGSQL_PORT="5433" PGSQL_DATABASE="template1" PGSQL_USERNAME="pgsqlchkusr" export PGPASSWORD="pg321" TMP_FILE="/tmp/pgsqlchk.out" ERR_FILE="/tmp/pgsqlchk.err" # # We perform a simple query that should return a few results :-p # psql -h $PGSQL_HOST -p $PGSQL_PORT -U $PGSQL_USERNAME \ $PGSQL_DATABASE -c "show port;" &gt; $TMP_FILE 2&gt; $ERR_FILE # # Check the output. If it is not empty then everything is fine and we return # something. Else, we just do not return anything. # if [ "$(/bin/cat $TMP_FILE)" != "" ] then # Postgres is fine, return http 200 /bin/echo -e "HTTP/1.1 200 OK\r\n" /bin/echo -e "Content-Type: Content-Type: text/plain\r\n" /bin/echo -e "\r\n" /bin/echo -e "Postgres is running.\r\n" /bin/echo -e "\r\n" else # Postgres is down, return http 503 /bin/echo -e "HTTP/1.1 503 Service Unavailable\r\n" /bin/echo -e "Content-Type: Content-Type: text/plain\r\n" /bin/echo -e "\r\n" /bin/echo -e "Postgres is *down*.\r\n" /bin/echo -e "\r\n" fi</span></span></code> </pre><br></div></div><br><br>      pgsqlchkusr    postgres <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">plsq <span class="hljs-comment"><span class="hljs-comment">#create user pgsqlchkusr; #ALTER ROLE pgsqlchkusr WITH LOGIN; #ALTER USER pgsqlchkusr WITH PASSWORD 'pg321'; #\q</span></span></code> </pre><br></div></div><br>         ‚Äî  check  . <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">chmod +x /opt/pgsqlchk;touch /tmp/pgsqlchk.out; touch /tmp/pgsqlchk.err; chmod 777 /tmp/pgsqlchk.out; chmod 777 /tmp/pgsqlchk.err;</code> </pre><br></div></div><br>    xinetd  pgsqlchk <br><br><div class="spoiler"> <b class="spoiler_title">nano /etc/xinetd.d/pgsqlchk</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/xinetd.d/pgsqlchk # # default: on # # description: pqsqlchk service pgsqlchk { flags = REUSE socket_type = stream port = 23267 wait = no user = nobody server = /opt/pgsqlchk log_on_failure += USERID disable = no only_from = 0.0.0.0/0 per_source = UNLIMITED }</span></span></code> </pre><br></div></div><br> . <br><br> <b> haproxy.</b> <br><br>   ‚Äî      .     ,    ,    ,   pghost195.           - ,    6432( pgbouncer). <br><br><div class="spoiler"> <b class="spoiler_title">nano /etc/haproxy/haproxy.cfg</b> <div class="spoiler_text"><pre> <code class="bash hljs">global <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 127.0.0.1 local0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 127.0.0.1 local1 notice <span class="hljs-comment"><span class="hljs-comment">#chroot /usr/share/haproxy chroot /var/lib/haproxy pidfile /var/run/haproxy.pid user postgres group postgres daemon maxconn 20000 defaults log global mode http option tcplog option dontlognull retries 3 option redispatch timeout connect 30000ms timeout client 30000ms timeout server 30000ms frontend stats-front bind *:8080 mode http default_backend stats-back frontend pxc-onenode-front bind *:5432 mode tcp default_backend pxc-onenode-back backend stats-back mode http stats uri / stats auth admin:adminpassword backend pxc-onenode-back mode tcp balance leastconn option httpchk default-server port 6432 inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxqueue 128 weight 100 server pghost195 10.1.1.195:6432 check port 23267</span></span></code> </pre><br></div></div><br><br>   haproxy        5432.     8080.  admin   adminpassword. <br>   <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/init.d/xinetd restart; /etc/init.d/haproxy restart;</code> </pre><br></div></div><br>       .   ,     ,  pghost198(       )  haproxy    . <br><br><div class="spoiler"> <b class="spoiler_title">nano /etc/haproxy/haproxy.cfg</b> <div class="spoiler_text"><pre> <code class="bash hljs">global <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 127.0.0.1 local0 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 127.0.0.1 local1 notice <span class="hljs-comment"><span class="hljs-comment">#chroot /usr/share/haproxy chroot /var/lib/haproxy pidfile /var/run/haproxy.pid user postgres group postgres daemon maxconn 20000 defaults log global mode http option tcplog option dontlognull retries 3 option redispatch timeout connect 30000ms timeout client 30000ms timeout server 30000ms frontend stats-front bind *:8080 mode http default_backend stats-back frontend pxc-onenode-front bind *:5432 mode tcp default_backend pxc-onenode-back backend stats-back mode http stats uri / stats auth admin:adminpassword backend pxc-onenode-back mode tcp balance roundrobin option httpchk default-server port 6432 inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxqueue 128 weight 100 server pghost196 10.1.1.196:6432 check port 23267 server pghost197 10.1.1.196:6432 check port 23267 server pghost198 10.1.1.196:6432 check port 23267</span></span></code> </pre><br></div></div><br>    <a href="http://hostip/">hostip</a> :8080 <br><br><h2>  keepalived. </h2><br> Keepalived    ip  (VIP)         (    ) ip     .     VIP 10.1.1.192   pghost195,pghost196,pghost197.       pghost195  pghost196    ip addr 10.1.1.192                    haproxy  pgbouncer ‚Äî      .    ‚Äî  Haproxy. <br>  keepalived <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install keepalived -y</code> </pre><br></div></div><br>  keepalived.     /etc/sysctl.conf  <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">net.ipv4.ip_forward=1</code> </pre><br></div></div><br>  Then <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">sysctl -p</code> </pre><br></div></div><br>  1- (pghost195) <br><div class="spoiler"> <b class="spoiler_title">nano /etc/keepalived/keepalived.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"> ! this is who emails will go to on alerts notification_email { admin@domain.com ! add a few more email addresses here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you would like } notification_email_from servers@domain.com ! I use the <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> machine to relay mail smtp_server smt.local.domain smtp_connect_timeout 30 ! each load balancer should have a different ID ! this will be used <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> SMTP alerts, so you should make ! each router easily identifiable lvs_id LVS_HAPROXY-pghost195 } } vrrp_instance haproxy-pghost195 { interface eth0 state MASTER virtual_router_id 192 priority 150 ! send an alert when this instance changes state from MASTER to BACKUP smtp_alert authentication { auth_type PASS auth_pass passwordforcluster } track_script { chk_http_port } virtual_ipaddress { 10.1.1.192/32 dev eth0 } notify_master <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'MASTER pghost195.etagi.com  VIP'"</span></span> notify_backup <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'BACKUP pghost195.etagi.com  VIP'"</span></span> notify_fault <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'FAULT pghost195.etagi.com  VIP'"</span></span> }</code> </pre><br></div></div><br>  <br> /etc/init.d/keepalived restart <br><br>  keepalived  2- (pghost196) <br><br><div class="spoiler"> <b class="spoiler_title">nano /etc/keepalived/keepalived.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"> ! this is who emails will go to on alerts notification_email { admin@domain.com ! add a few more email addresses here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you would like } notification_email_from servers@domain.com ! I use the <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> machine to relay mail smtp_server smt.local.domain smtp_connect_timeout 30 ! each load balancer should have a different ID ! this will be used <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> SMTP alerts, so you should make ! each router easily identifiable lvs_id LVS_HAPROXY-pghost196 } } vrrp_instance haproxy-pghost196 { interface eth0 state MASTER virtual_router_id 192 priority 80 ! send an alert when this instance changes state from MASTER to BACKUP smtp_alert authentication { auth_type PASS auth_pass passwordforcluster } track_script { chk_http_port } virtual_ipaddress { 10.1.1.192/32 dev eth0 } notify_master <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'MASTER pghost196.etagi.com  VIP'"</span></span> notify_backup <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'BACKUP pghost196.etagi.com  VIP'"</span></span> notify_fault <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'FAULT pghost196.etagi.com  VIP'"</span></span> }</code> </pre><br></div></div><br>  keepalived  3- (pghost197) <br><br><div class="spoiler"> <b class="spoiler_title">nano /etc/keepalived/keepalived.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"> ! this is who emails will go to on alerts notification_email { admin@domain.com ! add a few more email addresses here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you would like } notification_email_from servers@domain.com ! I use the <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> machine to relay mail smtp_server smt.local.domain smtp_connect_timeout 30 ! each load balancer should have a different ID ! this will be used <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> SMTP alerts, so you should make ! each router easily identifiable lvs_id LVS_HAPROXY-pghost197 } } vrrp_instance haproxy-pghost197 { interface eth0 state MASTER virtual_router_id 192 priority 50 ! send an alert when this instance changes state from MASTER to BACKUP smtp_alert authentication { auth_type PASS auth_pass passwordforcluster } track_script { chk_http_port } virtual_ipaddress { 10.1.1.192/32 dev eth0 } notify_master <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'MASTER pghost197.etagi.com  VIP'"</span></span> notify_backup <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'BACKUP pghost197.etagi.com  VIP'"</span></span> notify_fault <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'FAULT pghost197.etagi.com  VIP'"</span></span> }</code> </pre><br></div></div><br>  <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">/etc/init.d/keepalived restart</code> </pre><br></div></div><br>   ,     ,      .    <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> notify_master <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'MASTER pghost195.etagi.com  VIP'"</span></span> notify_backup <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'BACKUP pghost195.etagi.com  VIP'"</span></span> notify_fault <span class="hljs-string"><span class="hljs-string">"sh /etc/postgresql/telegram.sh 'FAULT pghost195.etagi.com  VIP'"</span></span></code> </pre><br></div></div><br>         VIP  10.1.8.111     eth0.     pghost195    pghost196, ..        IP 10.1.1.192.     pghost197,   vrrp_instance  lvs_id LVS_. <br><br>   pghost196,pghost197  keepalived.       failover promote,    .   <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">promote_command=<span class="hljs-string"><span class="hljs-string">'sh /etc/postgresql/failover_promote.sh'</span></span> follow_command=<span class="hljs-string"><span class="hljs-string">'sh /etc/postgresql/failover_follow.sh'</span></span></code> </pre><br></div></div><br>   /etc/repmgr.conf (.   ). <br>       failover  - . <br> promote_command='sh /etc/postgresql/failover_promote.sh ‚Äî    master host, <br> follow_command='sh /etc/postgresql/failover_follow.sh' ‚Äî  ,    . <br>  <br><br><div class="spoiler"> <b class="spoiler_title">promote_command='sh /etc/postgresql/failover_promote.sh'</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash CLHOSTS="pghost195 pghost196 pghost197 pghost198 pghost205 " repmgr standby promote -f /etc/repmgr.conf; echo " "; sh /etc/postgresql/failover_notify_master.sh; echo "     " repmgr -f /etc/repmgr.conf cluster show | grep node | awk ' {print $7} ' | sed "s/host=//g" | sed '/port/d' &gt; /etc/postgresql/cluster_hosts.list repmgr -f /etc/repmgr.conf cluster show | grep FAILED | awk ' {print $6} ' | sed "s/host=//g" | sed "s/&gt;//g" &gt; /etc/postgresql/failed_host.list repmgr -f /etc/repmgr.conf cluster show | grep master | awk ' {print $7} ' | sed "s/host=//g" | sed "s/&gt;//g" &gt; /etc/postgresql/current_master.list repmgr -f /etc/repmgr.conf cluster show | grep standby | awk ' {print $7} ' | sed "s/host=//g" | sed '/port/d' &gt; /etc/postgresql/standby_host.list ####    -    ##################### for CLHOST in $CLHOSTS do rsync -arvzSH --include "*.list" --exclude "*" /etc/\postgresql/ postgres@$CLHOST:/etc/postgresql/ done echo "    ,   /etc/postgresql/disabled" for FH in $(cat /etc/postgresql/failed_host.list) do ssh postgres@$FH &lt;&lt;OFF sh /etc/postgresql/register.sh; echo " repmgrd   " sh /etc/postgresql/repmgrd.sh; sh /etc/postgresql/failover_notify_restoring_ended.sh; OFF done echo " repmgrd  ,  " pkill repmgrd echo "  Keepalived"</span></span></code> </pre><br></div></div><br><br><div class="spoiler"> <b class="spoiler_title">follow_command='sh /etc/postgresql/failover_follow.sh'</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr standby follow -f /etc/repmgr.conf; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>; sh /etc/postgresql/failover_notify_standby.sh; pkill repmgrd; repmgrd -f /etc/repmgr.conf -p /var/run/postgresql/repmgrd.pid -m -d -v &gt;&gt; /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/postgresql/repmgr.log 2&gt;&amp;1;</code> </pre><br></div></div><br>    ‚Äî  failover,      ¬´¬ª  . <br><br><br><br><div class="spoiler"> <b class="spoiler_title">follow_command='sh /etc/postgresql/stop_master.sh'</b> <div class="spoiler_text">  #! / bin / bash <br> repmgr -f /etc/repmgr.conf cluster show | grep master | awk ' {print $7} ' | sed ¬´s/host=//g¬ª | sed ¬´s/&gt;//g¬ª &gt; /etc/postgresql/current_master.list <br> for CURMASTER in $(cat /etc/postgresql/current_master.list) <br>  do <br> ssh postgres@$CURMASTER &lt;&lt;OFF <br> cd ~/9.6; <br> /usr/lib/postgresql/9.6/bin/pg_ctl -D /etc/postgresql/9.6/main -m immediate stop; <br> touch /etc/postgresql/disabled; <br>  OFF <br> sh /etc/postgresql/telegram.sh ¬´  ¬ª <br>  done <br></div></div><br><br>            .     ,      root    postgres.      ‚Äî  . <br><br><div class="spoiler"> <b class="spoiler_title">  root  postgres</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres ssh-copy-id -i ~/.ssh/id_rsa.pub root@pghost195 ssh-copy-id -i ~/.ssh/id_rsa.pub root@pghost196 ssh-copy-id -i ~/.ssh/id_rsa.pub root@pghost197 ssh-copy-id -i ~/.ssh/id_rsa.pub root@pghost198 ssh-copy-id -i ~/.ssh/id_rsa.pub root@pghost205</code> </pre><br></div></div><br>    .   ,              2 .    ,        . <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"> repmgr -f /etc/repmgr.conf cluster show | grep node | awk <span class="hljs-string"><span class="hljs-string">' {print $7} '</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/host=//g"</span></span> | sed <span class="hljs-string"><span class="hljs-string">'/port/d'</span></span> &gt; /etc/postgresql/cluster_hosts.list repmgr -f /etc/repmgr.conf cluster show | grep FAILED | awk <span class="hljs-string"><span class="hljs-string">' {print $6} '</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/host=//g"</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/&gt;//g"</span></span> &gt; /etc/postgresql/failed_host.list repmgr -f /etc/repmgr.conf cluster show | grep master | awk <span class="hljs-string"><span class="hljs-string">' {print $7} '</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/host=//g"</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/&gt;//g"</span></span> &gt; /etc/postgresql/current_master.list repmgr -f /etc/repmgr.conf cluster show | grep standby | awk <span class="hljs-string"><span class="hljs-string">' {print $7} '</span></span> | sed <span class="hljs-string"><span class="hljs-string">"s/host=//g"</span></span> | sed <span class="hljs-string"><span class="hljs-string">'/port/d'</span></span> &gt; /etc/postgresql/standby_host.list</code> </pre><br></div></div><br><h1>    . </h1><br><h3>      </h3><br>    pg_stat_statements(   ) <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ pg_ctl restart;</code> </pre><br></div></div><br>   : <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># CREATE EXTENSION pg_stat_statements;</span></span></code> </pre><br></div></div><br>   : <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SELECT query, calls, total_time, rows, 100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;</span></span></code> </pre><br></div></div><br>      pg_stat_statements_reset: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># SELECT pg_stat_statements_reset();</span></span></code> </pre><br></div></div><br><h3>       'FAILED' </h3><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">DELETE FROM repmgr_etagi_test.repl_nodes WHERE name = <span class="hljs-string"><span class="hljs-string">'node1'</span></span>;</code> </pre><br></div></div><br>  ‚Äî etagi_test ‚Äî  ; <br> node1 ‚Äî     <br><br><h3>    </h3><br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">plsq <span class="hljs-comment"><span class="hljs-comment">#SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))::INT; 00:00:31.445829 (1 )</span></span></code> </pre><br></div></div><br>       Insert' ‚Äî     .  hiload       . <br><br><h3>   Slot 'repmgr_slot_ ' already exists as an active slot </h3><br>  postgresql   ,     <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres pg_ctl stop;</code> </pre><br></div></div><br>   master'e <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres psql repmgr <span class="hljs-comment"><span class="hljs-comment">#select pg_drop_replication_slot('repmgr_slot_4');</span></span></code> </pre><br></div></div><br><br><h3>   :   ¬´dbname¬ª    </h3><br>            ,       . <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">plsq <span class="hljs-comment"><span class="hljs-comment"># SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'dbname'; # DROP DATABASE dbname;</span></span></code> </pre><br></div></div><br><br><h3>   INSERT  UPDATE   ¬´repl_nodes¬ª     : INSERT  UPDATE   ¬´repl_nodes¬ª     ¬´repl_nodes_upstream_node_id_fkey¬ª. DETAIL:  (upstream_node_id)=(-1)    ¬´repl_nodes¬ª. </h3><br>                   switchover    (standby) <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -f /etc/repmgr.conf standby switchover</code> </pre><br></div></div><br> Standby  .  ‚Äú ‚Äù  standby <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">repmgr -f /etc/repmgr.conf standby follow</code> </pre><br></div></div><br><h3>  :     "/var/run/postgresql/9.6-main.pg_stat_tmp": </h3><br>    <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="bash hljs">su postgres mkdir -p /var/run/postgresql/9.6-main.pg_stat_tmp</code> </pre><br></div></div><br><h3>      no password supplied. </h3><br>               <br> ‚Äúno password supplied‚Äù.      ,  ,  -     . <br><h3> Backup  </h3><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><pre> <code class="bash hljs">pg_dumpall | gzip -c &gt; filename.gz</code> </pre><br></div></div><br><h3>     Postgres </h3><br><div class="spoiler"> <b class="spoiler_title">backup_pg.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash DBNAMES="db1 db2 db3" DATE_Y=`/bin/date '+%y'` DATE_M=`/bin/date '+%m'` DATE_D=`/bin/date '+%d'` SERVICE="pgdump" #DB_NAME="repmgr"; #`psql -l | awk '{print $1}' ` for DB_NAME in $DBNAMES do echo "CREATING DIR /Backup/20${DATE_Y}/${DATE_M}/${DATE_D}/${DB_NAME} " BACKUP_DIR="/Backup/20${DATE_Y}/${DATE_M}/${DATE_D}/${DB_NAME}" mkdir -p $BACKUP_DIR; pg_dump -Fc --verbose ${DB_NAME} | gzip &gt; $BACKUP_DIR/${DB_NAME}.gz #  dump   ,         pg_dump -Fc -s -f $BACKUP_DIR/${DB_NAME}_only_shema ${DB_NAME} /bin/sleep 2; #    pg_restore -l $BACKUP_DIR/${DB_NAME}_only_shema | grep FUNCTION &gt; $BACKUP_DIR/function_list done ##   ######################### #pg_restore -h localhost -U username -d _ -L function_list db_dump ######################## ###      ,   payment. #pg_restore --dbname db1 --table=table1  ####        ,      ###pg_restore --dbname ldb1 _only_shema</span></span></code> </pre><br></div></div><br><h1>  Conclusion </h1><br> ,     : <br><br> ‚Äî  master-standby   ; <br> ‚Äî  failover    (  repmgr'a); <br> ‚Äî  ( )  haproxy  pgbouncer( ); <br> ‚Äî     ‚Äî keepalived  ip    ,    ‚Äú‚Äù     ; <br> ‚Äî  (    )    ‚Äî  ); <br> ‚Äî   ‚Äî repmgr            bash ; <br> ‚Äî    ‚Äú ‚Äù. <br>          ,   ,            HA    Postgresql       Failover. </div><p>Source: <a href="https://habr.com/ru/post/314000/">https://habr.com/ru/post/314000/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313986/index.html">How to fill a bunch of cones and release the game</a></li>
<li><a href="../313988/index.html">Interview with Pavel R√§ikkonen, Executive Director of Nevosoft</a></li>
<li><a href="../313992/index.html">Happy Halloween! Hello ada</a></li>
<li><a href="../313996/index.html">Github for windows users</a></li>
<li><a href="../313998/index.html">The problem with intermittently long-running queries in MS SQL Server</a></li>
<li><a href="../314002/index.html">Hackers Shadow Brokers have published a new piece of data grouping Equation Group</a></li>
<li><a href="../314004/index.html">My Ragnarok</a></li>
<li><a href="../314008/index.html">Automation again: Python crawled to routers</a></li>
<li><a href="../314012/index.html">Backing up a standalone blog on Wordpress in the Google Drive cloud</a></li>
<li><a href="../314014/index.html">Parsing JSON is a minefield</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>