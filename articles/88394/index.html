<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>LINQ to SQL and concurrent access conflicts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article, we studied how to find a parallel access conflict and possible ways to solve them. 
 The second part of the article ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>LINQ to SQL and concurrent access conflicts</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/blogs/sql/86302/">first part of the</a> article, we studied how to find a parallel access conflict and possible ways to solve them. <br>  The second part of the article is devoted to solving this conflict, when using LINQ to SQL. <br><br>  The second part of the article describes how to resolve conflicts of parallel access in LINQ to SQL, and the reasons for the appearance of a ChangeConflictException when trying to update records, methods of solving. <br><a name="habracut"></a><br><h2>  Conflict detection </h2><br>  As mentioned in Part 1 of the article, we can use a special version field in which the version or date of the change is stored, or indicate previous field values ‚Äã‚Äãin the WHERE clause to ensure that they have not been changed. <br><br>  To use the version field, it is necessary in the entity class (* .designer.cs) described by the table, mark this field with the IsVersion property in the Column attribute.  In this case, only this field will be involved to determine if a concurrent access conflict occurs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If none of the fields is marked as IsVersion, then LINQ to SQL allows us to control which fields will be involved in conflict detection.  For this, in the entity class, you must set the corresponding value of the UpdateCheck property of the Column attribute.  It can be 3 possible values: <br><ul><li>  Never - indicates that this field will not participate in the detection of a conflict. </li><li>  Always (default) - indicates that this field will always participate in the detection of a conflict, regardless of whether its value has been updated since it was first loaded into the cache of the DataContext object. </li><li>  WhenChanged - this field will participate if you update it and try to save the new value. </li></ul><br><br>  And so, we proceed to the practical part.  First, create a test table: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> Customers ([CustomerID][nvarchar](5) <font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> , [CompanyName][nvarchar](40), [ContactName][nvarchar](30), [ContactTitle][nvarchar](30))</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Then go to our project in Visual Studio and add our table to the project (Add New Item - Linq to Sql Classes). <br><br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/b4/41/b441aa11b4ae8034ff6c0216b5ca29b9.png" width="640" height="480"></a> <br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/25/3c/253c507ca382fd38e413a03182550650.png" width="640" height="480"></a> <br><br><br>  Now open the file MyTestDB.designer.cs and proceed to the description of the class <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[global::System.Data.Linq.Mapping.TableAttribute(Name= <font color="#A31515">"dbo.Customers"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> Customer : INotifyPropertyChanging, INotifyPropertyChanged <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  It describes all the fields and their properties. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_CustomerID"</font> , DbType= <font color="#A31515">"NVarChar(5) NOT NULL"</font> , CanBeNull= <font color="#0000ff">false</font> , IsPrimaryKey= <font color="#0000ff">true</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> CustomerID ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_CompanyName"</font> , DbType= <font color="#A31515">"NVarChar(40)"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> CompanyName ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_ContactName"</font> , DbType= <font color="#A31515">"NVarChar(30)"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ContactName ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_ContactTitle"</font> , DbType= <font color="#A31515">"NVarChar(30)"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ContactTitle‚Ä¶ <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As I already wrote, the UpdateCheck property, although not specified, has a default value of Always.  This means that all fields are validated.  Let's see this.  Write the following code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">MyTestDBDataContext db = <font color="#0000ff">new</font> MyTestDBDataContext(); <br> db.Log = <font color="#2B91AF">Console</font> .Out; <br> Customer cust = db.Customers.Where(c =&gt; c.CustomerID == <font color="#A31515">"LONEP"</font> ).SingleOrDefault(); <br> cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> db.SubmitChanges(); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  After it is launched, the following will be displayed in the console window: <br> <code>SELECT [t0].[CustomerID], [t0].[CompanyName], [t0].[ContactName], [t0].[ContactTitle] <br> FROM [dbo].[Customers] AS [t0] <br> WHERE [t0].[CustomerID] = @p0 <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br> UPDATE [dbo].[Customers] <br> SET [ContactName] = @p4 <br> WHERE ([CustomerID] = @p0) AND ([CompanyName] = @p1) AND ([ContactName] = @p2) AND ([ContactTitle] = @p3) <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- @p1: Input NVarChar (Size = 24; Prec = 0; Scale = 0) [Lonesome Pine Restaurant] <br> -- @p2: Input NVarChar (Size = 11; Prec = 0; Scale = 0) [Fran Wilson] <br> -- @p3: Input NVarChar (Size = 13; Prec = 0; Scale = 0) [Sales Manager] <br> -- @p4: Input NVarChar (Size = 12; Prec = 0; Scale = 0) [Neo Anderson] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br></code> <br><br>  Those.  here we see how LINQ to SQL converted our query and executed it.  Update clearly shows that during the update, all the fields involved in the detection of conflicts.  If we do not need this, then we can manually set the values ‚Äã‚Äãof the UpdateCheck properties to control.  For example, we can establish that CompanyName will always be involved in the detection of a conflict, ContactName only when it changes, and ContactTitle will never be.  Then it will look like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_CustomerID"</font> , DbType= <font color="#A31515">"NVarChar(5) NOT NULL"</font> , CanBeNull= <font color="#0000ff">false</font> , IsPrimaryKey= <font color="#0000ff">true</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> CustomerID ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_CompanyName"</font> , DbType= <font color="#A31515">"NVarChar(40)"</font> , UpdateCheck = UpdateCheck.WhenChanged)] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> CompanyName ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_ContactName"</font> , DbType= <font color="#A31515">"NVarChar(30) "</font> , UpdateCheck = UpdateCheck.Always)] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ContactName ‚Ä¶ <br> [global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_ContactTitle"</font> , DbType= <font color="#A31515">"NVarChar(30)"</font> , UpdateCheck = UpdateCheck.Never)] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ContactTitle‚Ä¶ <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And if we rerun our code, the Linq to Sql request will be different: <br> <code>SELECT [t0].[CustomerID], [t0].[CompanyName], [t0].[ContactName], [t0].[ContactTitle] <br> FROM [dbo].[Customers] AS [t0] <br> WHERE [t0].[CustomerID] = @p0 <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br> UPDATE [dbo].[Customers] <br> SET [ContactName] = @p3 <br> WHERE ([CustomerID] = @p0) AND ([CompanyName] = @p1) AND ([ContactName] = @p2) <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- @p1: Input NVarChar (Size = 24; Prec = 0; Scale = 0) [Lonesome Pine Restaurant] <br> -- @p2: Input NVarChar (Size = 11; Prec = 0; Scale = 0) [Fran Wilson] <br> -- @p3: Input NVarChar (Size = 12; Prec = 0; Scale = 0) [Neo Anderson] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br></code> <br><br>  As you can see, there is a difference!  The CompanyName field did not participate, and ContactName participated because it was changed. <br><br>  And so, conflict conflict detection occurs when you call SubmitChanges (), and if a conflict occurs, then you can manage the conflict resolution process.  You can indicate whether further updates should be interrupted during the first conflict, or you can try to make all the changes accumulating conflicts.  For this, you need to pass ConflictMode when you call SubmitChanges.  If you pass ConflictMode.FailOnFirstConflict, then the process will be interrupted at the first conflict, another value is ConflictMode.ContinueOnConflict.  By default, if you do not specify it, then ConflictMode.FailOnFirstConflict is used. <br><br>  Regardless of whether you specified a transaction or not (in which case it will be created for all attempts to change the database), when an exception is thrown, the transaction will be canceled.  This means that if a part of the changes were successfully updated, they will be canceled in case of an error. <br><br><h3>  ChangeConflictException Exception </h3><br>  Regardless of whether ConflictMode is set to FailOnFirstException or ContinueOnConflict, a ChangeConflictException exception will still be thrown. <br><br>  By catching this exception, you can detect the occurrence of a conflict. <br><br><h2>  Conflict resolution </h2><br>  As soon as you find a conflict, catch the ChangeConflictException exception, your next step will most likely be to resolve it.  In LINQ to SQL there are two methods ResolveAll and two methods Resolve. <br><br><h3>  Refreshmode </h3><br>  When we want to resolve a conflict using the built-in LINQ to SQL functionality by calling the ResolveAll or Resolve method, we control the way the conflict is resolved by specifying the RefreshMode mode.  There are three valid values: <br><ol><li>  KeepChanges tells the ResolveAll or Resolve method to update the property values ‚Äã‚Äãof the entity class from the database, but if the user changes the property, its value is saved (i.e. your changes will not be lost) </li><li>  KeepCurrentValues ‚Äã‚Äãindicates that your user‚Äôs changes should be used, rejecting all changes made in the database (values ‚Äã‚Äãin the database will be overwritten by yours, which were read during the initial load) </li><li>  OverwriteCurrentValues, indicates that you need to discard your changes and load values ‚Äã‚Äãfrom the database </li></ol><br><br><h3>  Conflict Resolution Approaches </h3><br>  There are three approaches to conflict resolution: the simplest, easy and manual.  The simplest is to simply call the ResolveAll method on the DataContext.ChangeConflicts collection with a RefreshMode pass and an optional Boolean value indicating whether to automatically enable remote records <em>(in this case, LINQ to SQL represents that the records to be deleted were successfully deleted because who has already deleted them before us)</em> <br><br>  An easy approach is to enumerate all objectChangeConflict from the DataContext.ChangeConflicts collection with a call to the Resolve method on each of them. <br><br>  In the manual mode, you enumerate the ChangeConflicts elements of the DataContext object, and then enumerate all the MemberConflicts elements of the ObjectChangeConflicts object, calling a Resolve on each MemberChangeConflict object from this collection. <br><br><h3>  DataContext.ChangeConflicts.ResolveAll () </h3><br>  Conflict resolution is not difficult.  You simply catch the ChangeConflictException exception and call the ResolveAll () method on the DataContext.ChangeConflicts collection.  All that is required of you is to decide which RefreshMode mode to use, and whether you want to automatically resolve conflicts of deleted records.  The use of this approach will cause the same resolution of all conflicts. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> db.ChangeConflicts.ResolveAll(RefreshMode.KeepChanges); <br> { <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" , ."</font> ); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In this example, we first call ResolveAll, and then call the SubmitChanges method again.  If it causes an error, then we roll back. <br><br><h3>  ObjectChangeConflict.Resolve () </h3><br>  If the resolution of conflicts with the same RefreshMode or autoResolveDeletes does not work for you, you can choose an approach with enumerating all the conflicts from the DataContext.ChangeConflicts collection and process them individually. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> <font color="#0000ff">foreach</font> (ObjectChangeConflict conflict <font color="#0000ff">in</font> db.ChangeConflicts) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"   {0}"</font> , ((Customer)conflict.Object).CustomerID); <br> conflict.Resolve(RefreshMode.KeepChanges); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" . {0}"</font> , System.Environment.NewLine); <br> } <br> <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" , ."</font> ); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Here, similar to the ResolveAll method, you enumerate the ChangeConflicts collection and call Resolve on each ObjectChangeConflict object. <br><br><h3>  MemberChangeConflict.Resolve () </h3><br>  For an example of manual conflict resolution, suppose that there is a requirement that if there is a conflict with the ContactName columns in the database, the code should leave the base value as it is, but any other columns in the record can be updated. <br><br>  To implement this, we use the same basic approach, but instead of calling Resolve on an ObjectChangeConflict object, we enumerate the members of the MemberConflicts collection of each object.  Then for each MemberConflict object from this collection, if the property of the entity object that caused the conflict is ContactName, then we will leave the value in the database, passing RefreshMode.OverwriteCurrentValues, to the Resolve method.  If the conflicting property is not ContactName, then we will update it on ours by passing the RefreshMode.KeepChanges value to the Resolve method. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> cust.CompanyName = <font color="#A31515">"Lonesome &amp; Pine Restaurant"</font> ; <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> <font color="#0000ff">foreach</font> (ObjectChangeConflict conflict <font color="#0000ff">in</font> db.ChangeConflicts) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"   {0}"</font> , ((Customer)conflict.Object).CustomerID); <br> <font color="#0000ff">foreach</font> (MemberChangeConflict memberConflict <font color="#0000ff">in</font> conflict.MemberConflicts) <br> { <br> <font color="#0000ff">if</font> (memberConflict.Member.Name.Equals( <font color="#A31515">"ContactName"</font> )) <br> memberConflict.Resolve(RefreshMode.OverwriteCurrentValues); <br> <font color="#0000ff">else</font> <br> memberConflict.Resolve(RefreshMode.KeepChanges); <br> } <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" . {0}"</font> , System.Environment.NewLine); <br> } <br> <font color="#0000ff">try</font> <br> { <br> db.SubmitChanges(); <br> } <br> <font color="#0000ff">catch</font> (ChangeConflictException) <br> { <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">" , ."</font> ); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  A valid code that handles the resolution of a conflict manually is not so bad.  But of course, all these efforts are justified only for specialized conflict resolution. <br><br><h2>  UPDATE: using the Version column </h2><br>  For the Version column, you can use the timestamp or int.  For example, let's add a column to our table that will track the version of a record. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">alter</font> <font color="#0000ff">table</font> Customers <font color="#0000ff">ADD</font> [Version][rowversion] <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  <b>rowversion</b> is an automatically updated field when a record is updated; the timestamp is used internally.  Those.  no matter how we update, via LINQ to SQL, or whatever, the field value will automatically increase.  Of course, you can use a different way to maintain the version number, for example, as a number and update it with a trigger.  In this case, for example, I used the rowversion type <br><br>  Now you will need to update the MyTestDB.dbml view so that this new field appears in our project.  After the update, our field will look like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[global::System.Data.Linq.Mapping.ColumnAttribute(Storage= <font color="#A31515">"_Version"</font> , AutoSync=AutoSync.Always, DbType= <font color="#A31515">"rowversion NOT NULL"</font> , CanBeNull= <font color="#0000ff">false</font> , IsDbGenerated= <font color="#0000ff">true</font> , IsVersion= <font color="#0000ff">true</font> , UpdateCheck=UpdateCheck.Never)] <br> <font color="#0000ff">public</font> System.Data.Linq.Binary Version <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  When using IsVersion = true, you can forget about UpdateCheck, it will not be applied !!!  The version field will always be used to search for conflicts.  Other properties: IsDbGenerated - indicates that this field is generated by the database, cannot be changed, CanBeNull does not allow an empty value.  The IsVersion field assumes immediate synchronization after inserting or updating a record. <br><br>  And now let's check how LINQ to SQL queries have changed, after implementing the version field, on the following code: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">MyTestDBDataContext db = <font color="#0000ff">new</font> MyTestDBDataContext(); <br> db.Log = <font color="#2B91AF">Console</font> .Out; <br> Customer cust = db.Customers.Where(c =&gt; c.CustomerID == <font color="#A31515">"LONEP"</font> ).SingleOrDefault(); <br> <font color="#0000ff">string</font> name = cust.ContactName; <br> cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"    - {0} {1}"</font> , BitConverter.ToString(cust.Version.ToArray()), System.Environment.NewLine); <br> db.SubmitChanges(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"    - {0} {1}"</font> , BitConverter.ToString(cust.Version.ToArray()), System.Environment.NewLine); <br> cust.ContactName = name; <br> db.SubmitChanges(); <br> <font color="#2B91AF">Console</font> .ReadKey(); <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Here I added a couple of lines so that you can run the example several times (in the previous examples above, I did not add them to the example, although I used it myself).  This will allow you to perform an example several times and always see the result.  Because, as if the data did not change after caching, they will not be sent to the database for updating! <br><br>  And so, I also added a version number mapping to make sure the version is actually updated.  Result below: <br> <code>SELECT [t0].[CustomerID], [t0].[CompanyName], [t0].[ContactName], [t0].[ContactTitle], [t0].[Version] <br> FROM [dbo].[Customers] AS [t0] <br> WHERE [t0].[CustomerID] = @p0 <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br>     - 00-00-00-00-00-00-07-E9 <br> UPDATE [dbo].[Customers] <br> SET [ContactName] = @p2 <br> WHERE ([CustomerID] = @p0) AND ([Version] = @p1) <br> <br> SELECT [t1].[Version] <br> FROM [dbo].[Customers] AS [t1] <br> WHERE ((@@ROWCOUNT) &gt; 0) AND ([t1].[CustomerID] = @p3) <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- @p1: Input Timestamp (Size = 8; Prec = 0; Scale = 0) [SqlBinary(8)] <br> -- @p2: Input NVarChar (Size = 12; Prec = 0; Scale = 0) [Neo Anderson] <br> -- @p3: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br>     - 00-00-00-00-00-00-07-EA <br> <br> UPDATE [dbo].[Customers] <br> SET [ContactName] = @p2 <br> WHERE ([CustomerID] = @p0) AND ([Version] = @p1) <br> <br> SELECT [t1].[Version] <br> FROM [dbo].[Customers] AS [t1] <br> WHERE ((@@ROWCOUNT) &gt; 0) AND ([t1].[CustomerID] = @p3) <br> -- @p0: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- @p1: Input Timestamp (Size = 8; Prec = 0; Scale = 0) [SqlBinary(8)] <br> -- @p2: Input NVarChar (Size = 11; Prec = 0; Scale = 0) [Fran Wilson] <br> -- @p3: Input NVarChar (Size = 5; Prec = 0; Scale = 0) [LONEP] <br> -- Context: SqlProvider(Sql2008) Model: AttributedMetaModel Build: 3.5.30729.4926 <br></code> <br><br>  As you can see, only the version field is used to find a conflict.  In addition, after the update, it is immediately synchronized with the database, getting the current value. <br><br>  Intercepting exceptions and working with them will be exactly the same as the examples above. <br><br>  <em>The last UPDATE and SELECT appeared due to the fact that we restore the original value.</em> <br><br><h2>  Pessimistic approach </h2><br>  With a pessimistic approach to concurrency, there are no conflicts that need to be resolved, because the database is locked by your transaction, so no one else can modify it behind you. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> (System.Transactions.TransactionScope tranaction = <font color="#0000ff">new</font> System.Transactions.TransactionScope()) <br> { <br> Customer cust = db.Customers.Where(c =&gt; c.CustomerID == <font color="#A31515">"LONEP"</font> ).SingleOrDefault(); <br> cust.ContactName = <font color="#A31515">"Neo Anderson"</font> ; <br> cust.CompanyName = <font color="#A31515">"Lonesome &amp; Pine Restaurant"</font> ; <br> db.SubmitChanges(); <br> tranaction.Complete(); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  With this approach, you should always evaluate how much work you do inside the TransactionScope context, because the database will be blocked for all this time. <br><br>  LINQ to SQL: Learn more about Joseph Rattz Jr.  "LINQ Integrated Query Language in C # 2008 for Professionals" <br><br>  <b>UPD</b> : added an example for the version field </div><p>Source: <a href="https://habr.com/ru/post/88394/">https://habr.com/ru/post/88394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88385/index.html">Linux Data Encryption</a></li>
<li><a href="../88386/index.html">twitter2vk - from Twitter to VKontakte</a></li>
<li><a href="../88389/index.html">elFinder - file manager for the site. New taste</a></li>
<li><a href="../88392/index.html">Wow Mobile and other news from U'tel</a></li>
<li><a href="../88393/index.html">Design pattern "Fitter" / "Flyweight"</a></li>
<li><a href="../88396/index.html">Use SQLCLR to improve performance</a></li>
<li><a href="../88398/index.html">Is placing SSH on a port other than 22 justified?</a></li>
<li><a href="../88399/index.html">Soyuz-Telecom mobile WiMAX will appear in forty-two settlements of the Moscow region. (Terms not yet named.)</a></li>
<li><a href="../88403/index.html">The epic of personal data continues</a></li>
<li><a href="../88404/index.html">Startup: compilation of tourist routes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>