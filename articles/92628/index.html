<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a driver for a USB device. Pipe 0: what is usb?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It so happened that I had to write from scratch a driver for usb display under windows. Having the opportunity - I will tell about the details of such...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a driver for a USB device. Pipe 0: what is usb?</h1><div class="post__text post__text-html js-mediator-article">  It so happened that I had to write from scratch a driver for usb display under windows.  Having the opportunity - I will tell about the details of such an entertaining process. <br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/f04/8da/0b4f048da74aeb691b6042ad38eb7455.jpg" alt="image"><br><br><h4>  USB is simple </h4>  Despite the fact that writing drivers is considered quite difficult compared to application programming - and in this low-level world programmers were not deprived of attention, the development of the usb bus was a big step in simplifying driver creation. <br>  So, why is the usb bus so convenient, and that hides behind the word Universal in decoding the abbreviation. <br><a name="habracut"></a><br>  Previously, when the programmer had to write a driver to communicate with the device, he worked directly at the bus level, roughly speaking, if the device was connected with a 9-wire cable, because  two of them are usually diverted under power - then the programmer was manually forced to control up to 7 cores.  Each device had its own idea of ‚Äã‚Äãhow to use the port provided to it.  For example, one device could transfer data to a computer through 1, 2 and 5 conductors, use 3 and 7 for control, and 4 and 6 would be used to write data to a device, another device could have 2 conductors for data transfer in both directions and 5 for control signals. <br><br>  All this was necessary to control in time, waiting for the reaction or readiness of the device.  If the device performed more than one type of activity, it was necessary to know what functionality we are working with at the moment and, proceeding from this, to change the methods of work.  In such conditions, debugging was hard, and the programmer needed to learn his own protocol for communication on this port for each device.  All this could not go on forever, and the usb bus was invented. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Bus structure </h4>  The first thing you can see when working with usb devices in modern operating systems is that you no longer need to work physically with the data port.  So, let's see what an arbitrary usb device is in the first approximation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bfd/d86/176/bfdd86176b881f37516d3b2955fe6371.png" alt="image"><br>  On the first line of defense we are waiting for the interface level, this is a logical separation of the device according to the tasks it performs, for example, if we have an external display equipped in addition with an audible warning system - our device may well have a couple of interfaces, one to work with the display, the other for work with sound, and, for example, the third - for flashing the device itself. <br>  If we consider writing a driver under windows using the latest driver framework (WDF), then we can find out the number of interfaces and access them using a couple of lines of code. <br>  The interface is not the only level of separation existing in USB; each interface is divided into a set of so-called endpoints. <br><br>  Suppose that we can both record a picture on the display - and read the current picture from the display; in this case, one end point will be used for reading, the other - for writing.  In addition to the direction of data transmission (In / Out), the endpoint has another quite useful property, it is a type of transmission that has one of the following values: <br><br>  ‚Ä¢ control transfers ‚Äî used by the host to configure the device during connection, to control the device, and to receive status information during operation.  The protocol provides guaranteed delivery of such parcels; <br>  ‚Ä¢ Bulk Data Transfers - they are applied when it is necessary to ensure guaranteed delivery of data from the host to the function or from the function to the host, but the delivery time is not limited; <br>  ‚Ä¢ interrupt transmissions ‚Äî used when small, single data packets need to be transmitted.  Each packet is required to transfer for a limited time.  Transmission operations are spontaneous and must be serviced no slower than the device requires; <br>  ‚Ä¢ isochronous transmissions - are used for data exchange in ‚Äúreal time‚Äù when a strictly defined amount of data is required to be transmitted at each time interval, but information delivery is not guaranteed (data transmission is carried out without repetition in case of failures, packet loss is allowed). <br><br>  In addition to the end points defined directly by the device logic, one (zero) end point is determined directly by the protocol, any usb device must have a zero end point.  Due to this, as soon as you connect the device to the computer - the operating system immediately recognizes the name of this device, and tries to find a driver for it, without this standard endpoint, it would be impossible to obtain information about the device in the absence of a driver. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/478/160/cfc/478160cfc87b8afa2ecd28272022f627.png" alt="image"><br><h4>  Conclusion </h4>  All data is transmitted via two conductors inside the usb cable (another 2 are recharged to power), this allows the use of a single connector for all usb devices. <br>  This is all you need to know about the bus in order to write your first driver, which we will do in the next article. <br>  Driver Development Kit for Windows XP, Vista, 7 Operating Systems - can be downloaded here: <a href="http://www.microsoft.com/downloads/details.aspx%3Fdisplaylang%3Den%26FamilyID%3D36a2630f-5d56-43b5-b996-7633f2ec14ff">developer kit.</a> <br><br>  In the next part: handling of events related to the device, working with the backlight from the application, and a little reverse engineering. <br><br>  Photo of the future patient: <br><img src="https://habrastorage.org/getpro/habr/post_images/18c/a2a/caa/18ca2acaad99d4202289abaf7c01550b.jpg" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/92628/">https://habr.com/ru/post/92628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../92622/index.html">Budget "photobox" for soap cases and mobile phones</a></li>
<li><a href="../92623/index.html">IPhone Keyboard Secrets</a></li>
<li><a href="../92625/index.html">New Russian translation of Creative Commons licenses</a></li>
<li><a href="../92626/index.html">Google Web Elements: four new elements</a></li>
<li><a href="../92627/index.html">Open channels in Loudtalks</a></li>
<li><a href="../92629/index.html">Wonderful about bugs</a></li>
<li><a href="../92631/index.html">How much do you need beautiful (and all sorts of other thingies) in the JavaME application on your phone?</a></li>
<li><a href="../92634/index.html">Installing Guitar Pro 6 on x64 Linux</a></li>
<li><a href="../92635/index.html">I resent! Unlimited 3G from Ukrtelecom</a></li>
<li><a href="../92637/index.html">Ubuntu 10.04 BUGFIX (Fix slow window deployment and plymouth resolution after installing ATI Catalyst drivers)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>