<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use web application downtime for background tasks.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I love it when my apps run at 60 fps, even on mobile devices. And I also like to save the state of my application, for example, open windows or entere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use web application downtime for background tasks.</h1><div class="post__text post__text-html js-mediator-article">  I love it when my apps run at 60 fps, even on mobile devices.  And I also like to save the state of my application, for example, open windows or entered text in localstorage and user metadata (if it is registered), so that by closing it, you can continue working with it later from the same place, including other device. <br><br>  This is all great, only today I ran into one problem.  The fact is that I have one side menu, offcanvas, and I would also like to save its state (open / closed) in the browser and user account.  That's just an entry in the localstorage and AJAX request for updating to the database is asynchronous and they always strive to run right during a complex animation, stealing from me a couple of frames, which is especially noticeable on mobile devices.  Obviously, I would like the data to be saved after the animation ends, and not at the critical moment of my application, but how? <br><a name="habracut"></a><br>  Adding to the up stack by <i>setTimeout (doPostponedStuff)</i> does not help, since the animation itself is asynchronous, and the call to <i>doPostponedStuff is</i> mixed with the animation frame calls.  Can the duration of the animation be cached as the second parameter of <i>setTimeout</i> , that is, <i>setTimeout (doPostponedStuff, 680)</i> ?  No, thank you, I do not want to burn in a programmer hell.  Wait, this reminds me of something.  Two resource-intensive tasks, of which one is minor, and it should not interfere with the paramount ... Oh, yes!  Very similar to the calculation of the coordinates of an element with <i>position: absolute</i> or <i>position: fixed</i> when resizing the browser window or scrolling.  If we approach this task trivially, we will have something like: <br><br><pre><code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).resize(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ $target.css(<span class="hljs-string"><span class="hljs-string">'top'</span></span>, x).css(<span class="hljs-string"><span class="hljs-string">'left'</span></span>, y).css(<span class="hljs-string"><span class="hljs-string">'width'</span></span>, z) });</code> </pre> <br>  But with this method, we will be disappointed: when scrolling, the browser will start dropping frames very quickly, because onScroll events are thrown almost at every scrolled pixel, well, maybe not at every, but very often, a couple of dozen times per second, that's for sure , and the operations themselves with DOM and redrawing are quite expensive.  Fortunately, the solution to this problem has long been invented. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Debauser </h2><br>  So, as mentioned above, the solution was invented long ago, the name of his debouncer (English <i>debouce</i> ), and it consists in calling the Coleck not at every event, but when the action generating the event is completed, that is, in the case of scrolling, the handler is called on completion of scrolling, but not on every scrolled pixel.  If it is even more specific, the debouncer causes a callback if a specified amount of time has passed since the last event.  The Debunser code itself is very simple, and easily fits into several lines: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">debounce</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ms, cb</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(timeout) clearTimeout(timeout); timeout = setTimeout(cb, ms); } }</code> </pre><br><br>  and you can use it as follows: <br><br><pre> <code class="javascript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).scroll(debounce(<span class="hljs-number"><span class="hljs-number">100</span></span>, repositionElement);</code> </pre><br><br>  Now the <i>repositionElement</i> will be called up within a hundred milliseconds since the end of the scroll, which in the most positive way will affect fps. <br><br><h2>  Debouncing critical application code </h2><br>  This is all fine, but how will it help us identify the application downtime and use this time to perform background background tasks?  To do this, we first wrap our code for such tasks into a function, and pass it through a debouncer, for example, like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saveAppStateWhenIdle = debounce(<span class="hljs-number"><span class="hljs-number">1000</span></span>, saveAppState);</code> </pre><br><br>  and in critical places of our application we will call <br><br><pre> <code class="javascript hljs">saveAppStateWhenIdle ();</code> </pre><br><br>  thus, we will <i>postpone the</i> execution of <i>saveAppState</i> until the application is ‚Äúfixed‚Äù, and critical resources become free, and this will work even in asynchronous code.  In my particular case, I call saveAppStateWhenIdle on every frame of the offcanvas animation, as well as in other places where the state of the application needs to be saved, and the account goes into frames. <br><br><h2>  Debouncing recurring code </h2><br>  As another example, we can assume that we have a very ordinary (micro) blog, in which new posts are loaded with AJAX, and also beautifully animated, but if the update interval coincides with the scrolling time, the application crawls a little .  Trifle, but unpleasant.  To solve this problem, you can write the following solution: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loadPostsWhenIdle = debounce(<span class="hljs-number"><span class="hljs-number">1000</span></span>, loadMorePosts); setInterval(loadPostsWhenIdle, <span class="hljs-number"><span class="hljs-number">10000</span></span>); $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).scroll(loadPostsWhenIdle);</code> </pre><br>  Thus, if the application is idle, new posts will be loaded approximately every 11 seconds, if the user just at that time scrolls the page, then the upload will be postponed until the user finishes scrolling. <br><br>  Unfortunately, this method has one drawback, namely, <i>loadPostsWhenIdle</i> will be called after each completion of scrolling, even if less than 11 seconds passed between them, that is, the principle ‚Äúno more than once every 11 seconds‚Äù is not respected.  To solve this problem, you can use a boolean switch, in which ‚Äútrue‚Äù means that the application is busy, and ‚Äúfalse‚Äù, that it is idle, and you can perform a secondary task: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> appIsBusy = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onAppIsIdle = debounce(<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ appIsBusy = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doingPerformanceHeavyStuff = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ appIsBusy = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; onAppIsIdle(); } setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!appIsBusy) loadMorePosts(); }, <span class="hljs-number"><span class="hljs-number">10000</span></span>); $<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.scroll(doingPerformanceHeavyStuff);</code> </pre><br><br>  Now new posts will be loaded no more than once every 10 seconds, but not during scrolling. <br><br>  In principle, <i>doingPerformanceHeavyStuff</i> can be inserted into any critical part of the application, as well as using the <i>appIsBusy</i> switch in any background or periodic task to find out if this is the right time for that task. </div><p>Source: <a href="https://habr.com/ru/post/251939/">https://habr.com/ru/post/251939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251929/index.html">Detection of mobile malware in the wild</a></li>
<li><a href="../251931/index.html">We test content distribution in GlusterFS</a></li>
<li><a href="../251933/index.html">The magic of one div. Masterclass from the creator of a.singlediv.com</a></li>
<li><a href="../251935/index.html">Ciklum Dnepropetrovsk C ++ Saturday: The first subbotnik of the year for C ++ fans is happy to meet everyone</a></li>
<li><a href="../251937/index.html">Reading GATT-characteristics of a Bluetooth device</a></li>
<li><a href="../251941/index.html">If Seagate was dusty ...</a></li>
<li><a href="../251943/index.html">Localization of Android applications using Google Sheets</a></li>
<li><a href="../251945/index.html">Combat use of the C # compiler for WEB Forms</a></li>
<li><a href="../251947/index.html">Introducing a series of technical webinars</a></li>
<li><a href="../251949/index.html">Dell PowerEdge Solutions for Movie Content Provider</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>