<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Safely speeding up the Erlang application using NIF on Rust</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article addresses the issue of integration of Erlang and Rust on the example of the implementation of the Burton Bloom probabilistic data structur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Safely speeding up the Erlang application using NIF on Rust</h1><div class="post__text post__text-html js-mediator-article"><p>  The article addresses the issue of integration of Erlang and Rust on the example of the implementation of the Burton Bloom probabilistic data structure, which allows to check the belonging of an element to a set with the necessary accuracy. </p><a name="habracut"></a><br><h2 id="vybor-yazyka">  Language selection </h2><br><p>  Performance tests based on computational problems make it clear in which league Erlang is playing. <br></p><br><img src="https://habrastorage.org/webt/aj/nt/qb/ajntqb6ulygigbiermle8rr6s4i.png"><br><br>  Since Erlang does not have ultrafast arithmetic, solving complex computational problems on it seems strange.  However, it is well suited for questions arising in the development and operation of queuing systems.  Erlang, having an excellent scheduler and garbage collector, coupled with a fast network and processing of binary data, copes with a highly competitive distributed environment.  Thus, for myself, I assigned Erlang the role of system glue in the architecture of distributed server applications. <br><p>  In real systems, local computational problems arise that inhibit the system and degrade the overall UX.  It often happens that it slows down 1% of the code, and negatively affects the remaining 99% of the system.  To solve this problem in Erlang, starting with version R13B03, there is a mechanism Native Implemented Functions (NIFs). </p><br><p>  In the list of myths about Erlang in paragraph 2.7, developers warn that using the NIF interface should be the last measure, since using NIF is dangerous because of possible VM crashes caused by defects in the implementation of your NIF and does not always guarantee an increase in speed. </p><br><p>  Official examples of NIF implementations are available for C. Code in C and C ++ is fairly easy to make unsafe, for example, by going beyond the memory structure or array, or by skipping the operation to release allocated resources.  In my opinion, the problem is exacerbated by a context switching factor: when a programmer who mainly develops code for Erlang switches to low-level C, the likelihood of the problems described above increases, especially within the framework of burning deadlines. </p><br><p>  Thus, I would like to get a solution as fast as in C / C ++, but safe and easily supported.  Let's look at the most productive languages ‚Äã‚Äãin terms of computation. <br></p><br><img src="https://habrastorage.org/webt/cj/uy/zf/cjuyzfidkxoo3bauk1jhlfbut30.png"><br><br>  In terms of language requirements, it is worth noting: <br><ol><li>  Security.  Solution should not under any circumstances break the Erlang VM </li><li>  Performance.  Be comparable in performance with C ++ </li><li>  Ability to use in NIF mode </li><li>  Development speed  A good standard library and a large collection of third-party libraries are needed, providing a convenient language ecosystem. </li></ol><br><p>  Of the cohort of productive languages, Rust seems most appropriate.  It offers good performance and a secure development model, as well as an active community.  An additional advantage of Rust is data immunity and transparent multithreading model. </p><br><p>  It should be noted that there is another optimization option.  If we can neglect the time and overhead of an additional call through EPMD, then we can choose the way of writing Erlang Node, instead of NIF.  To solve this problem, Java, Go, Rust, Ocaml (from personal experience) is suitable.  Erlang Node can be run on the same machine or even on the other end of the earth. </p><br><h2 id="implementaciya">  Implementation </h2><br><h3 id="obzor-suschestvuyuschih-resheniy-na-rust">  Review of existing solutions on Rust </h3><br><p>  After a quick search, there are several libraries for writing NIF on rust.  Consider them: </p><br><ol><li>  <a href="https://github.com/hansihe/rustler">rustler</a> .  Perhaps the most popular and functional library, but the authors have concentrated their efforts on supporting Elixir.  In <a href="https://github.com/hansihe/rustler/issues/127">https://github.com/hansihe/rustler/issues/127 they</a> suggest dragging a mix into an erlang project.  There is no documentation for use in Erlang. </li><li>  <a href="https://github.com/erszcz/erlang-rust-nif">erlang-rust-nif</a> .  This is a low-level implementation of NIF and an approach to building an extension.  The code looks like a simple translation from C. The assembly has boundary conditions and is not universal. </li><li>  <a href="https://github.com/goertzenator/erlang_nif-sys">erlang_nif-sys</a> .  Low-level and full-featured bundle.  Is the basis for Rustler.  It takes time and effort to write an NIF. </li><li>  <a href="https://github.com/tatsuya6502/bitwise_rust">bitwise_rust</a>  Demonstrates working with the scheduler.  It is also a wrapper without syntactic sugar over C api. </li></ol><br><p>  Since one of the requirements points is the speed of development, Rustler looks the most attractive.  However, I don‚Äôt want to add an extra dependency to the project in the form of Elixir and mix collector. </p><br><h3 id="rustler">  Rustler </h3><br><p>  Answering the question ‚Äúwhy bother dragging the elixir project in erlang?‚Äù And following the KISS principle, it was decided to use a rustler, but without additional dependencies.  As build system rebar3 is used.  The easiest and quickest step is to define pre_hooks to compile our rust code. </p><br><p>  To do this, we add in the hook test profile: </p><br><pre><code class="hljs pgsql">{pre_hooks, [ {"(linux|darwin|solaris|freebsd)", compile, "sh -c \"cd crates/bloom &amp;&amp; cargo build &amp;&amp; cp target/<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>/libbloom.so ../../priv/\""} ]}</code> </pre> <br><p>  In the battle environment, add the option <code>--release</code> , so in the battle profile add: </p><br><pre> <code class="hljs pgsql">{pre_hooks, [ {"(linux|darwin|solaris|freebsd)", compile, "sh -c \"cd crates/bloom &amp;&amp; cargo build <span class="hljs-comment"><span class="hljs-comment">--release &amp;&amp; cp target/release/libbloom.so ../../priv/\""} ]}</span></span></code> </pre> <br><p>  After these manipulations, the <code>priv/libbloom.so</code> dynamic library <code>priv/libbloom.so</code> , completely ready for loading into the Erlang VM. <br>  Details and an example of using rustler in an erlang project can be found in the project repository <a href="https://github.com/Vonmo/erbloom">https://github.com/Vonmo/erbloom</a> </p><br><h3 id="filtr-bluma">  Bloom filter </h3><br><p>  Since the rust ecosystem provides ready-made bloom filter implementations, we select the appropriate one and add it to <code>cargo.toml</code> .  This project uses <code>bloomfilter = "0.0.12"</code> </p><br><p>  The extension implements the following functions: </p><br><ol><li>  <code>new(bitmap_size, items_count)</code> - filter initialization.  <code>bitmap_size</code> and <code>items_count</code> are calculated values, there is a mass of ready-made calculators. </li><li>  <code>serialize()</code> - filter packing, for example, for later saving to disk or transmission over the network. </li><li>  <code>deserialize()</code> - restoration of the filter from the saved state. </li><li>  <code>set(key)</code> - adds an element to the set. </li><li>  <code>check(key)</code> - checks whether the element belongs to the set. </li><li>  <code>clear()</code> - clears the filter. </li></ol><br><h3 id="erlang">  Erlang </h3><br><p>  It should be noted that loading an extension into Erlang is an absolute transparent process.  After loading your module, on_load is called, in which you need to implement loading nif through erlang: load_nif / 2.  At the same time, call processing will be transparent in Rust. </p><br><p>  The rule of good tone is to generate an erlang error: nif_error / 1 in case NIF is not loaded. </p><br><p>  A detailed description of the environment for assembling a project can be found in <a href="https://habrahabr.ru/post/346254/">this article</a> . </p><br><h2 id="itogi">  Results </h2><br><p>  As a result of the work done, we received a productive and safe extension.  In our projects, this extension allows us to reduce the volume of calls to the data storage in some cases up to 10 times and serve the flow of calls of more than 500k RPS per machine. </p><br><p>  The source code for the extension is available <a href="https://github.com/Vonmo/erbloom">on github</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/349398/">https://habr.com/ru/post/349398/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349386/index.html">Team Leader. To be or not to be, that is the question</a></li>
<li><a href="../349388/index.html">We forward Steam API calls from Wine to GNU / Linux and back with Nim</a></li>
<li><a href="../349392/index.html">Sublime Text 3 is alive. (Setup and operation)</a></li>
<li><a href="../349394/index.html">The release of the first beta cross-platform XAML UI-toolkit Avalonia</a></li>
<li><a href="../349396/index.html">Configuring VoIP GSM Gateway Yeastar Neogate TGXXX Series for 3CX</a></li>
<li><a href="../349400/index.html">FastTrack Training. "Network Basics". "Basics of switching or switches." Part one. Eddie Martin December 2012</a></li>
<li><a href="../349402/index.html">UWP game: Where to start</a></li>
<li><a href="../349404/index.html">Search under the hood. Cloud indexing</a></li>
<li><a href="../349406/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ302 (February 12 - 18, 2018)</a></li>
<li><a href="../349408/index.html">Yii 2.0.14</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>