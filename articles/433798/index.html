<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HomeKit and ioBroker Let's be friends houses</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Without a doubt, Apple iOS remains one of the most popular mobile operating systems, which means that modern automation systems must be able to integr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HomeKit and ioBroker Let's be friends houses</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/r6/5c/kp/r65ckpg2b-xatrgqefbyo7lflxa.png"></p><br><p>  Without a doubt, Apple iOS remains one of the most popular mobile operating systems, which means that modern automation systems must be able to integrate into this ecosystem and provide interoperability.  This is the purpose of the Homekit framework, which allows you to work with smart devices from the iPhone / iPad / iWatch screen, and more recently from the Mac (macOS Mojave). </p><br><p>  Most automation systems (I don‚Äôt like the marketing name "smart home") have long contain integration modules with Homekit, but even a trained user is not always easy to figure out how to make his device accessible in the Home application (or Eve). </p><br><p>  Today I will tell you how to do these manipulations in the ioBroker system (this is an open and free automation system).  But in order not to stupidly cite all the many examples of devices, I want to explain some principles and show approaches, knowing that, you can easily implement the other examples. </p><br><p>  <em>"Knowledge of some principles easily compensates for ignorance of some facts"</em> <em><br></em>  <em>Claude Adrian Helvetius</em> </p><a name="habracut"></a><br><h3 id="iobroker-drayvery-ustroystva-i-sostoyaniya">  ioBroker.  Drivers, devices and states </h3><br><p>  First of all I want to explain what a device is in the ioBroker system, and how it is presented. </p><br><p>  Let me remind you that the ioBroker system is modular, and extension modules are called drivers (or adapters).  A driver is an integration module with a device or a group of devices united by a common functionality, protocol or manufacturer, and therefore it can drag one to several devices into the ioBroker system.  Another feature is the ability to create multiple instances of the same driver, differing in any settings. </p><br><p>  But each device is unique and unique, has different characteristics and capabilities.  Based on this, in ioBroker, they are primarily oriented not on the device itself, but on its characteristics, which are represented by states.  <strong>A state</strong> is an internal ioBroker object that accepts and stores any value.  Synonyms of the state can be considered: signs, attributes, characteristics, properties, events.  Examples of states: "temperature", "brightness level", "battery level", "switch on indicator", "error sign", "click sign", "double click sign", etc.  Thus, each device is represented by many different states. </p><br><p><img src="https://habrastorage.org/webt/oc/mn/q_/ocmnq_d-zdyhjj7bflfxaa3dxb8.png" alt="Object structure" title="Object structure"></p><br><p>  States can be divided into informative - display information from the device, and modifiable - can be changed by the user or the script and send these changes to the device.  Accordingly, when something changes on the device ‚Äî this data is displayed in states, and when ioBroker changes state (by user or script), the device receives a signal about the change and must respond accordingly (this depends on the device itself and the driver that is with it works). </p><br><p>  All device states are combined into a single tree (registry) of states.  They are grouped first by device (in some cases, grouping by channel is also applied), and then by driver instances. </p><br><p>  The concept of topics of the MQTT protocol easily falls into such a state tree.  In this way, you can connect additional equipment or third-party systems that support the MQTT-protocol.  Just put the MQTT driver - the corresponding branch will appear in the state tree. </p><br><p>  And then there are all sorts of online services that can provide useful information and / or give the ability to control other equipment (car alarms, for example).  The result of interaction with these services is also represented as a set of states. </p><br><p><img src="https://habrastorage.org/webt/xi/qk/ay/xiqkay8bgotkcb7qjhouj5-zln4.png" alt="State tree" title="State tree"></p><br><p>  Thus, a device in ioBroker is represented as a set of states characterizing the device and allowing it to interact with it. </p><br><h3 id="homekit-aksessuary-servisy-i-harakteristiki">  Homekit.  Accessories, services and specifications </h3><br><p>  Now turn to Homekit.  Here, a classification of devices, their functionality and characteristics is applied. </p><br><p><img src="https://habrastorage.org/webt/xk/ch/8m/xkch8mdj6gv4zxw5g-kapazvuyy.png" alt="Homekit Device Categories" title="Homekit Device Categories"></p><br><p>  <strong>Accessories</strong> are the equivalent of a physical device.  The accessory has a <a href="https://developer.apple.com/documentation/homekit/hmaccessorycategory/accessory_category_types">category</a> for assigning it to a specific group. </p><br><p>  <strong>Services (Services)</strong> is the equivalent of the functionality that the accessory has.  One accessory may have several services. </p><br><p>  Services indicate the capabilities of the device: lamp, battery, button, air quality sensor, door, air cleaner, camera .. </p><br><p>  It is the service that determines the display, behavior of the device and a set of characteristics. </p><br><p>  <strong>Characteristics</strong> is the equivalent of the attributes / properties that characterize the service.  It is the characteristics that determine whether the device is on, the brightness level of the lamp, or how many times a button is pressed.  One service can have many characteristics. </p><br><p><img src="https://habrastorage.org/webt/2f/rl/io/2frliotkqesh2zanlhpfiaskmaq.png" alt="Object structure" title="Object structure"></p><br><p>  Applications that work with Homekit read the services and features of the accessories, and then display and let them change the values ‚Äã‚Äãin the characteristics through the user interface.  The modified values ‚Äã‚Äãare sent to the Homekit devices to apply them, and from the Homekit devices, respectively, the values ‚Äã‚Äãof the characteristics are also sent with some changes from the device side. </p><br><p>  Total, the device in HomeKit is an accessory with a set of services and features. </p><br><h3 id="yahka-stykuem-koncepcii">  Yahka  Dock concept </h3><br><p> IoBroker uses the <a href="https://github.com/jensweigele/ioBroker.yahka">Yahka</a> driver to work with Homekit ( <a href="https://github.com/jensweigele/ioBroker.yahka/wiki/Installation-and-Troubleshooting">additional modules</a> must be <a href="https://github.com/jensweigele/ioBroker.yahka/wiki/Installation-and-Troubleshooting">installed</a> before installation) - add-on above the well-known library <a href="https://github.com/KhaosT/HAP-NodeJS"></a>  <a href="https://github.com/KhaosT/HAP-NodeJS">https://github.com/KhaosT/HAP-NodeJS</a> , on which the popular HomeBridge project is also built.  This library is designed to create a virtual gateway / bridge that provides a set of virtual devices in HomeKit.  Configuring the virtual devices and services accordingly, setting the values ‚Äã‚Äãof the characteristics - we will get the finished device in Homekit and the Home application, and we can also ask Siri to manage it. </p><br><p>  The Yahka driver is precisely designed to set up accessories, add services to them, and indicate compliance of characteristics (HomeKit) and states (ioBroker). </p><br><p>  But first, after installation, you need to configure the gateway and bring it into the Home application.  After configuration, all devices added to the gateway will be automatically added to Home.  To do this, you must specify the "Device Name" (it is desirable to specify only Latin letters) and remember the pin code (or specify your own). </p><br><p><img src="https://habrastorage.org/webt/mj/b9/lf/mjb9lfsfvknvbjjmec9x0nexnns.png" alt="Gateway Setup" title="Gateway setup"></p><br><div class="spoiler">  <b class="spoiler_title">Go to the application Home and add a new accessory.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5k/m1/hr/5km1hrkrxh6whzmb8dn5zcvqtm4.png"><br><img src="https://habrastorage.org/webt/fo/p-/oz/fop-oz-o99nnegmciq7drkxjdyu.png"></p></div></div><br><p>  Now we will deal with devices.  Everything would be fine if the state set for the device in ioBroker uniquely corresponded to the set of services and features in HomeKit.  And it would be even better if the values ‚Äã‚Äãin the states were suitable for the values ‚Äã‚Äãof the characteristics.  But often this is not the case, and you have to invent unusual ways of docking.  I will tell about some of them below, and you will have to implement all other options yourself, ‚Äúin the image and likeness‚Äù. </p><br><p>  For convenience, I <a href="https://docs.google.com/spreadsheets/d/11C2TOoe8W3hP-j7BmZgdFmoSLJA5rt-MqdukpkRj3kw/edit%3Fusp%3Dsharing">created a document</a> with the translation of services and types, as well as possible values ‚Äã‚Äãof characteristics.  All types and services used correspond to the <a href="">HAP-NodeJS library</a> . </p><br><h3 id="datchik-temperatury">  temperature sensor </h3><br>  This is the simplest example - you just have one state that contains a numerical value of temperature.  It can be obtained from anywhere: from sensors or from Internet services (weather). <br><p>  You need to add a device of the Sensor category, and add a TemperatureSensor service to the device, and give a name to this service.  This service has 5 characteristics, of which the most important for us is CurrentTemperature (Current Temperature). </p><br><p><img src="https://habrastorage.org/webt/xn/yr/k7/xnyrk7hwwcmtwhiy_kcbub-nlms.png" alt="Accessory thermometer" title="Accessory thermometer"></p><br><p><img src="https://habrastorage.org/webt/j4/bj/bn/j4bjbnuijam7qadtoq9r9eh16ns.png" alt="TemperatureSensor service" title="TemperatureSensor service"></p><br><p>  It is enough to indicate in the characteristic CurrentTemperature the name of the state corresponding to the temperature. </p><br><p>  We‚Äôll also add the Humidity Sensor humidity service here, and a separate accessory icon will be created in Homekit. </p><br><p><img src="https://habrastorage.org/webt/ag/na/90/agna90qhvaz84v3qutrvu4dltei.png" alt="HumiditySensor service" title="HumiditySensor service"></p><br><p>  Save, and everything is ready.  Now you can contact Siri and ask her about the temperature and humidity. </p><br><p><img src="https://habrastorage.org/webt/s4/cx/kg/s4cxkg72-7ycfuaentktjrhpdjy.png"></p><br><div class="spoiler">  <b class="spoiler_title">Conversation with Siri</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ff/p9/tt/ffp9ttfpcj3_wcbt4ztgisnwxzi.png"><br><img src="https://habrastorage.org/webt/ax/7z/1i/ax7z1ioiynurem96c3gof_2gnha.png"></p></div></div><br><h3 id="batareyka">  Battery </h3><br><p>  Another simple service.  Its feature is that it can be added to almost any accessory.  We add the BatteryService service and indicate in the BatteryLevel characteristic a state containing the battery charge percentage.  After that, the data on the charge will appear in the additional data about the device. </p><br><p><img src="https://habrastorage.org/webt/pd/4p/ib/pd4pibwilwjymthk2g30ldqneey.png" alt="BatteryService service" title="BatteryService service"></p><br><p>  You can also set the ‚Äúlow charge‚Äù feature (the StatusLowBattery characteristic), if the value of the specified state is 1, then the corresponding icon will be displayed on the device image. </p><br><p>  But what to do if you do not have such a state, and you want to see the low charge icon?  You need to create this state manually or by a script, and specify the created state in the characteristics. </p><br><p>  Now it remains only to correctly set the value true in this state.  For this we will use the script - it will set the value to true when the battery reaches 30 percent. </p><br><pre><code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">""</span></span>); on({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"zigbee.0.00158d0001f41725.battery"</span></span>, <span class="hljs-attr"><span class="hljs-attr">change</span></span>: <span class="hljs-string"><span class="hljs-string">"ne"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = obj.state.val; setState(<span class="hljs-string"><span class="hljs-string">"javascript.0."</span></span>, (value &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>)); });</code> </pre> <br><p>  After the first launch, the script will create a state, and it can be selected in the characteristics. </p><br><p><img src="https://habrastorage.org/webt/tx/2z/6r/tx2z6r4deofbbram-k_muwaxut0.png"></p><br><p>  This sign will be displayed on the images of accessories. </p><br><p><img src="https://habrastorage.org/webt/9o/nu/it/9onuitzmxs8exjofr7cfkwtwrqi.png"></p><br><div class="spoiler">  <b class="spoiler_title">and in the device details</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fx/jg/av/fxjgavhu-spu27lskbzkmvb_dh8.png"></p></div></div><br><h3 id="lampy">  Lamps </h3><br><p>  Light bulbs are different - bright, warm, red.  There are 4 cases: </p><br><ul><li>  Simple - controlled by "on" and "off" </li><li>  Dimmable - also controlled by the brightness level </li><li>  With temperature - it is possible to control the temperature of the glow </li><li>  Colored - it is possible to control the color of the glow </li></ul><br><p>  For each of these cases, there is a corresponding characteristic in the Lightbulb service: </p><br><ul><li>  On - on / off </li><li>  Brightness - brightness level </li><li>  Hue - shade </li><li>  Saturation - saturation </li><li>  ColorTemperature - color temperature </li></ul><br><p>  In the simple case, in the "On" characteristic, we indicate the state responsible for switching on and off. </p><br><p><img src="https://habrastorage.org/webt/7p/2j/l2/7p2jl2cqi7q8rbw98d_ytedxwke.png"></p><br><p>  If the lamp is dimmable, then additionally indicate the state with the level of brightness. </p><br><p><img src="https://habrastorage.org/webt/b6/da/n1/b6dan1fjltcn8sry8doex2hl6ck.png"></p><br><p>  In addition to the assignment of correct states, it is important to observe the interval of acceptable values! </p><br><p>  Example: in some cases, the state responsible for the brightness of the lamp can take values ‚Äã‚Äãfrom 0 to 255, but in Homekit these values ‚Äã‚Äãare limited to an interval from 0 to 100. For this case, you can use <a href="https://github.com/jensweigele/ioBroker.yahka/wiki/Configuration,-InOut-Functions-and-Conversion-Functions">the transformation functions of</a> the Yahka driver.  The function "level255" just converts the interval of values ‚Äã‚Äã0..255 into the interval 0..100 (and vice versa). </p><br><p>  The following difficulties may arise if your lamp is colored, but the color is RGB.  These can be either three different states or one number (or a string).  In this case, you will need to do a conversion from one RGB color space to another XYB space (this space is used by HomeKit), or to the XY plane. </p><br><p>  To do this, you need to make 2 new states (Hue and Saturation), into which we will convert the values ‚Äã‚Äãfrom the RGB state and back. </p><br><div class="spoiler">  <b class="spoiler_title">The final script for the color is such</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       createState("Hue"); createState("Sat"); //      RGB- on({id: "Hue", ack: false, change: 'any'}, function (obj) {  var hue = parseInt(obj.state.val);  var sat = parseInt(getState('Sat').val);  var res = hsvToRgb(hue, sat, 100);  setRGB(parseInt(res[0]), parseInt(res[1]), parseInt(res[2])); }); //    RGB- function setRGB(r, g, b){  var val = ('00'+r.toString(16)).slice(-2)+('00'+g.toString(16)).slice(-2)+('00'+b.toString(16)).slice(-2);  // RGB-   setState('zigbee.0.00124b0014d016ab.color', val, false); } //   HSV   RGB function hsvToRgb(h, s, v) {  var r, g, b;  var i;  var f, p, q, t;   h = Math.max(0, Math.min(360, h));  s = Math.max(0, Math.min(100, s));  v = Math.max(0, Math.min(100, v));  s /= 100;  v /= 100;   if(s == 0) {      r = g = b = v;      return [          Math.round(r * 255),          Math.round(g * 255),          Math.round(b * 255)      ];  }   h /= 60;  i = Math.floor(h);  f = h - i;  p = v * (1 - s);  q = v * (1 - s * f);  t = v * (1 - s * (1 - f));   switch(i) {      case 0:          r = v;          g = t;          b = p;          break;       case 1:          r = q;          g = v;          b = p;          break;       case 2:          r = p;          g = v;          b = t;          break;       case 3:          r = p;          g = q;          b = v;          break;       case 4:          r = t;          g = p;          b = v;          break;       default: // case 5:          r = v;          g = p;          b = q;  }   return [      Math.round(r * 255),      Math.round(g * 255),      Math.round(b * 255)  ]; }</span></span></code> </pre> </div></div><br><p>  You can do more easily with the color temperature - if you know the range of available values ‚Äã‚Äãfor your lamp, then you can convert it to the range available for HomeKit (via the <a href="https://github.com/jensweigele/ioBroker.yahka/wiki/Configuration,-InOut-Functions-and-Conversion-Functions">scaleInt</a> function). </p><br><p><img src="https://habrastorage.org/webt/f0/vm/xh/f0vmxhpcndendf_efjf9xrmjxke.png" alt="Lightbulb service" title="Lightbulb service"></p><br><p><img src="https://habrastorage.org/webt/et/sp/fg/etspfg0idwn5v-cun2hh2y9xmm0.png"></p><br><div class="spoiler">  <b class="spoiler_title">Deeper in the lamp</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w_/q8/8p/w_q88pboeca8hl0fygtssrjegim.png"><br><img src="https://habrastorage.org/webt/bt/5c/bc/bt5cbc59jttu8ibjev1hfnnwkdm.png"></p></div></div><br><h3 id="termostat">  Thermostat </h3><br><p>  Thermostat - a device for maintaining the set temperature (service Thermostat).  Accordingly, the main characteristic of the thermostat is the desired temperature (TargetTemperature).  In addition to the set temperature, the current temperature (CurrentTemperature) can be indicated, which is informational (as the device only reads it from the sensors). </p><br><p>  From the House application in the thermostat, the target temperature is set and the current temperature is monitored.  In my thermostat (Zont) there were just these two states - they were accessible through the service cloud api. </p><br><p>  For the beauty of the device display in HomeKit, we had to add a couple of constants: the current state of heating is active (1), the target state of heating is automatic (3). </p><br><p><img src="https://habrastorage.org/webt/vn/dd/ey/vnddeyypjlofn2jkxrqwe5ybwuw.png" alt="Thermostat service" title="Thermostat service"></p><br><p><img src="https://habrastorage.org/webt/pk/9u/k3/pk9uk3vfurepl1kfgow5lrp66dc.png"></p><br><div class="spoiler">  <b class="spoiler_title">Temperature selection</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/_4/g8/co/_4g8coln1rlsodscr8sah8p_h9o.png"></p></div></div><br><h3 id="vorota">  Goal </h3><br><p>  With garage doors (GarageDoorOpener service) everything is trickier than with a thermostat. </p><br><p>  Of the available characteristics, the gate has a target state (TargetDoorState), which indicates our desire for the gate to be ‚Äúopen‚Äù or ‚Äúclosed‚Äù.  But you also need to correctly display the current state of the gate (CurrentDoorState): are they open or closed, or maybe they open or close? </p><br><p>  In my case, the gate was opened through mqtt in ioBroker by several information states: </p><br><ul><li>  sign of openness of the gate </li><li>  sign of the movement of the gate (DV) </li></ul><br><p><img src="https://habrastorage.org/webt/aw/b3/ip/awb3ipo5vz8qrn8jawhcfunuouc.png" alt="Garage door control states" title="Garage door control states"></p><br><p>  Thanks to these states, you can calculate the current status of the gate: </p><br><ul><li>  if there is no OB and there is no DV, then the gate is closed </li><li>  if there is no OB and there is DV, then the gate opens </li><li>  if there is an agent and there is no DV, then the gate is open </li><li>  if there is an agent and there is a Far East, then the gate is closed </li></ul><br><p>  To send a signal for opening and closing the gate, I have two separate states (I could manage with one state, but I have two), which send a message via mqtt to the gate control controller: </p><br><ul><li>  opening signal </li><li>  close signal </li></ul><br><p>  To send a signal, you need to simulate the "pressing" of the button: set the value to true, and after a while reset it to false.  In this regard, for integration with HomeKit, we had to create another state - the ‚Äútarget state of the gate‚Äù, which, if changed, would send the corresponding signal. </p><br><p>  A sign of the openness of the gate can be replaced with a target state (i.e., what the gate will strive for): </p><br><ul><li>  if the CA is "closed" and there is no Far East, then the gate is closed </li><li>  if the CA is "closed" and is LW, then the gate opens </li><li>  if CA is ‚Äúopen‚Äù and there is no Far East, then the gate is open </li><li>  if the CA is "open" and is LW, then the gate is closed </li></ul><br><p>  We will also create a separate state ‚Äúthe current state of the gate‚Äù, and we will fill it in the script depending on the value of the signs and on the target state. </p><br><div class="spoiler">  <b class="spoiler_title">Script state changes for garage doors</b> <div class="spoiler_text"><pre> <code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">"gate_0.current"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   createState("gate_0.target"); //   //    0,   300 on({id: "mqtt.0.gate.gpio.13", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.13", 0,  300); }); on({id: "mqtt.0.gate.gpio.12", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.12", 0,  300); }); //     on({id: "mqtt.0.gate.is_open", ack: false, val: 1}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 0, true); }); on({id: "mqtt.0.gate.is_open", ack: false, val: 0}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 1, true); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 0}, function (obj) {  setState("mqtt.0.gate.gpio.12", 1); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 1}, function (obj) {  setState("mqtt.0.gate.gpio.13", 1); }); on({id: "mqtt.0.gate.in_progress", ack: true, change: 'any'}, function (obj) {  //    " ",      if (obj.state.val === 1) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 2, true);      } else {          // ""          setState("javascript.0.gate_0.current", 3, true);      }  }  //    " ",      if (obj.state.val === 0) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 0, true);      } else {          // ""          setState("javascript.0.gate_0.current", 1, true);      }  } });</span></span></code> </pre> </div></div><br><p>  After running the script, you can configure the characteristics of the service of garage doors: </p><br><p><img src="https://habrastorage.org/webt/lb/cm/t5/lbcmt51du7vnivrjbj2o_h_u28u.png" alt="GarageDoorOpener service" title="GarageDoorOpener service"></p><br><p><img src="https://habrastorage.org/webt/pg/rh/ey/pgrhey_qs-cxm8rg6yj_lufgmgs.png"></p><br><h3 id="kamera">  Camera </h3><br><p>  To add a camera to HomeKit, the "classic" method will be used.  An image broadcast from the camera is organized via the ffmpeg module.  Through it, the input stream will be encoded, encrypted and sent to Homekit. </p><br><p>  First you need to install ffmpeg on the server where ioBroker is located. </p><br><p>  For each platform, it is placed differently, you can build it from source, or you can search for a ready-made assembly, for example, here: <a href="https://www.johnvansickle.com/ffmpeg/"></a>  <a href="https://www.johnvansickle.com/ffmpeg/">https://www.johnvansickle.com/ffmpeg/</a> A libx264 encoder is required.  You can check the presence of an encoder after installing ffmpeg with the command: </p><br><pre> <code class="plaintext hljs">ffmpeg -codecs | grep 264</code> </pre> <br><p>  The results should contain a string like: </p><br><pre> <code class="plaintext hljs">DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_vdpau ) (encoders: libx264 libx264rgb h264_v4l2m2m )</code> </pre> <br><p>  For Raspberry Pi 3, you can use a <a href="">ready-made assembly</a> , in which there is a codec with support for hardware encoding of the GPU (h264_omx, consumes less resources).  Put so: </p><br><pre> <code class="plaintext hljs">wget https://github.com/legotheboss/YouTube-files/raw/master/ffmpeg_3.1.4-1_armhf.deb sudo dpkg -i ffmpeg_3.1.4-1_armhf.deb</code> </pre> <br><p>  Both codecs are present in this build: libx264 and h264_omx </p><br><p>  Next, you need to get the address of the camera stream, which must be translated (this step is beyond the scope of this article).  For example, you can take a <a href="http://rtsp//studiosystem.co.in:1935/v4news/livestream">ready-made public stream</a> . </p><br><p>  Now we add the camera to Yahka, specify the stream address, and if necessary, change the codec parameters, image size, frame rate. </p><br><p>  <strong>Important: Parameter combinations are very important for correct display of the camera in Homekit and depend on the camera and the stream.</strong>  <strong>It also affects system performance, because</strong>  <strong>running ffmpeg process takes a lot of resources.</strong> </p><br><p><img src="https://habrastorage.org/webt/zh/uj/6g/zhuj6gv7alolh2nfvmpyxgmnoju.png" alt="Add camera" title="Add camera"></p><br><p><img src="https://habrastorage.org/webt/w7/_z/pl/w7_zplfretbtbw0v66nb9ip9ira.png" alt="Stream setting" title="Stream setting"></p><br><div class="spoiler">  <b class="spoiler_title">Cameras are added as separate devices outside the gateway, and they need to be added as well as the gateway</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ib/8v/s9/ib8vs9ksuw5mk4ese_-gg6rnrv4.png"></p></div></div><br><p><img src="https://habrastorage.org/webt/0d/hp/qd/0dhpqdbfe_hgez4u7x2edcu92za.png" alt=" " title="Camera thumbnail"></p><br><p><img src="https://habrastorage.org/webt/ue/tj/o4/uetjo4rqvi-fsae2rlkt56cmaji.png" alt="  " title="Broadcast from the camera"></p><br><h3 id="bonus">  Bonus </h3><br><p>  As a bonus, I will talk about the unusual use of camera broadcast. </p><br><p>  Using the very same ffmpeg, instead of the camera, you can try to broadcast an image, any picture.  These pictures can also be merged with the video stream.  The image can display text, graphics and other information. </p><br><p><img src="https://habrastorage.org/webt/sg/cl/f7/sgclf7ssws1pkm_rlf3qy_avmhi.png" alt="   " title="Text Overlay"></p><br><p>  As a result, you can get an interesting dashboard.  And if you update the picture periodically, you get dynamic data. </p><br><p>  As an example, I displayed a graph of changes in some indicators in the form of a picture (file on disk).  This schedule is updated once per minute and overwrites the image in the file. </p><br><div class="spoiler">  <b class="spoiler_title">(functions createImage1, createImage2, the formation of graphics and the imposition of text on the picture are beyond the scope of this article, but I will give a hint).</b> <div class="spoiler_text"><p>  I'll tell you how you can get a graph in the form of a picture. </p><br><p>  IoBroker has a standard graphing method - the Flot driver.  This driver is paired with the Web driver and displays the result in a browser.  But in order to get the created graph on the server (in the script) in the form of a picture, an additional PhantomJS driver is needed, which makes a ‚Äúscreenshot‚Äù of the page (on which we will draw a Flot graph). </p><br><p>  But I will talk about an alternative way of plotting graphs on a server in a script. </p><br><p>  There is such a library Chart.js <a href="http://www.chartjs.org/">http://www.chartjs.org/</a> which allows you to draw nice-looking graphics in the browser (examples <a href="http://www.chartjs.org/samples/latest/">http://www.chartjs.org/samples/latest/</a> ). </p><br><p>  For drawing it uses the ‚Äúcanvas‚Äù (canvas, canvas) of the browser.  Therefore, to draw using this library on the server, you need to use the ‚Äúserver‚Äù version of the ‚Äúcanvas‚Äù and DOM objects.  This is what the chartjs-node package does ( <a href="https://github.com/vmpowerio/chartjs-node">https://github.com/vmpowerio/chartjs-node</a> ). </p><br><p>  The main dependency for this package is the canvas package ( <a href="https://github.com/Automattic/node-canvas">https://github.com/Automattic/node-canvas</a> ), which should be installed globally (or in the iobroker folder).  It is important to install all the dependencies for the platform where you put <a href="https://github.com/Automattic/node-canvas">https://github.com/Automattic/node-canvas#compiling</a> . </p><br><p>  After that, in the javascript driver settings, add the modules chart.js, chartjs-node.  They should be installed correctly, without errors.  Otherwise, deal with errors and solve them. </p><br><p>  And then, you can write a script. </p><br><p>  Below is a script for an example, since  it includes the use of the History driver and uses specific state names. </p><br><p>  Attention!  The script has a complex for beginners design - Promise.  This is a convenient way to not write functions with callback, but to make chains of steps.  For example, it is convenient to do this to obtain data from the history of states. </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ChartjsNode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chartjs-node'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *  sendTo  Promise,      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter, cmd, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendTo(adapter, cmd, params, (result) =&gt; { resolve(result); }); }); } <span class="hljs-comment"><span class="hljs-comment">//    const chartColors = { black: 'rgb(0, 0, 0)', red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)', grey: 'rgb(201, 203, 207)' }; /** *        * : * @param config -     * @param filename -     * : * @param Promise -    */ function doDraw(config, filename) { //     640x480  var chartNode = new ChartjsNode(640, 480); return chartNode.drawChart(config) .then(() =&gt; { //     return chartNode.writeImageToFile('image/png', filename); }); } /** *     ChartJS. * : * @param Promise -    */ function prepareDraw0(){ // ,    var ; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       ,      .then(()=&gt;{ //  ,   ,      = [ {"val":3,"ack":1,"ts":1539063874301}, {"val":5,"ack":1,"ts":1539063884299}, {"val":5.3,"ack":1,"ts":1539063894299}, {"val":3.39,"ack":1,"ts":1539063904301}, {"val":5.6,"ack":1,"ts":1539063914300}, {"val":-1.3,"ack":1,"ts":1539063924300}, {"val":-6.3,"ack":1,"ts":1539063934302}, {"val":1.23,"ack":1,"ts":1539063944301}, ]; }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //   label: '', //  backgroundColor: chartColors.black, borderColor: chartColors.black, //   pointRadius: 3, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, }] } } }; return chartJsOptions; }); } /** *     ChartJS. *         , *     . * * : * @param hours -  ,     * : * @param Promise -    */ function prepareDraw1(hours){ //   ,      const end = new Date().getTime(), start = end - 3600000*(hours || 1); // 1 =   //  ,       //   var , 2, 1, 2, 2; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       'mqtt.0.ESP_Easy..Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'mqtt.0.ESP_Easy..Temperature', options: { start: start, end: end, aggregate: 'onchange' } } ).then((result) =&gt; { //     ''  = result.result; }); }) //       'sonoff.0.chicken2.DS18B20_Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ //     '2' 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.sonoff_chicken_vent.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 1 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER1', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER2', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //           label: ' ('+[.length - 1].val+')', //  backgroundColor: chartColors.blue, borderColor: chartColors.blue, //  . 0 -   pointRadius: 0, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, //   Y yAxisID: 'y-axis-1', },{ label: ' 1 ('+1[1.length - 1].val+')', backgroundColor: chartColors.green, borderColor: chartColors.green, pointRadius: 0, borderWidth: 3, data: 1.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2 ('+2[2.length - 1].val+')', backgroundColor: chartColors.red, borderColor: chartColors.red, pointRadius: 0, borderWidth: 3, data: 2.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.yellow, borderColor: chartColors.yellow, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? 1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.grey, borderColor: chartColors.grey, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? -1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, //    () time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, //   -  position: 'left', //   id: 'y-axis-1', },{ type: 'linear', display: true, scaleLabel: { display: true, labelString: '  ' }, ticks: { min: -4, max: 2 }, //   -  position: 'right', id: 'y-axis-2', }] } } }; return chartJsOptions; }); } function createImage(filename, callback){ // filename -  ,       //    prepareDraw1(2) //     .then((result) =&gt; { //        return doDraw(result, filename); }) .then(()=&gt;{ if (callback) callback(); }) .catch((err)=&gt;{ console.error(err); }); }</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/webt/4c/d5/bs/4cd5bslfzniznrd16qfmqu0tuly.png" alt="   " title="Broadcast pictures instead of stream"></p><br><p>  The thumbnail image is updated about once per minute, so let's set the update to be done once every 10 seconds: </p><br><pre> <code class="plaintext hljs">var fs = require('fs'); //  10    schedule("*/10 * * * * *", () =&gt; {  createImage1('/tmp/1_new.jpg', ()=&gt; {      fs.renameSync('/tmp/1_new.jpg', '/tmp/1.jpg');  });  createImage2('/tmp/2_new.jpg', ()=&gt; {      fs.renameSync('/tmp/2_new.jpg', '/tmp/2.jpg');  }); });</code> </pre> <br><p>  The peculiarity is that in the process of image broadcasting, it is necessary to replace the image quickly enough so that ffmpeg does not collapse :) Therefore, the image is first formed into one file, and then the file is renamed to the one used for translation. </p><br><p>  Now in the camera settings, we specify the name of the file being formed instead of the stream address, and add the settings that the image is "updated" (the "-loop 1" parameter).  This is configured in the advanced properties of the camera.  These properties are nothing more than command line options for running ffmpeg.  Therefore, combinations of parameters should be sought in the ffmpeg documentation and examples. </p><br><p>  Properties are divided into 2 types: for getting a "preview" (small image of the camera) and for broadcasting.  Therefore, you can specify different image source files, for example, with different details. </p><br><p><img src="https://habrastorage.org/webt/zy/30/b4/zy30b4wc2zud54wr-px_ezovdgu.png" alt="  ffmpeg" title="Ffmpeg startup options"></p><br><p><img src="https://habrastorage.org/webt/mk/l5/qi/mkl5qizqb41if_youa62qrgm9hc.png" alt="  " title="Live image broadcast"></p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>         ioBroker     .       ,       . ,   ,        . </p><br><p>  ,    Yahka       ,      Material.           ,            HomeKit. </p><br><p>       Yahka,    HomeKit     ‚Äî  Ham,     HomeBridge         .       . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/433798/">https://habr.com/ru/post/433798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433728/index.html">Google closed the project of the Chinese search engine with censorship due to disagreements within the company</a></li>
<li><a href="../433730/index.html">Optimization of relational databases without downtime on the example of the most loaded database in Badoo</a></li>
<li><a href="../433790/index.html">Advanced multi-stage build templates</a></li>
<li><a href="../433792/index.html">Shell scripts in Ansible</a></li>
<li><a href="../433796/index.html">How Homo Sapiens conquered the world. Communication and Negotiation Skills</a></li>
<li><a href="../433800/index.html">Using Cypress UDB PSoC Controllers to Reduce the Number of Interrupts in a 3D Printer</a></li>
<li><a href="../433802/index.html">How and why we won the Big Data track at the Urban Tech Challenge</a></li>
<li><a href="../433804/index.html">Mixture Density Networks</a></li>
<li><a href="../433806/index.html">When an online archive forgets</a></li>
<li><a href="../433808/index.html">5 most frequent mistakes that programmers make at the interview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>