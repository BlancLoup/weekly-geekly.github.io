<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using quadtree when calculating 2GIS traffic jams</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Even without being a navigator, 2GIS collects and displays information about traffic jams. Firstly, it is necessary to build optimal routes, and secon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using quadtree when calculating 2GIS traffic jams</h1><div class="post__text post__text-html js-mediator-article">  Even without being a navigator, 2GIS collects and displays information about traffic jams.  Firstly, it is necessary to build optimal routes, and secondly, such data is very necessary for users in large cities. <br><br>  In 2GIS service of traffic jams appeared in September 2011 and today works in five cities ( <a href="http://2gis.ru/">Novosibirsk</a> , <a href="http://2gis.ru/">St. Petersburg</a> , <a href="http://2gis.ru/">Krasnoyarsk</a> , <a href="http://2gis.ru/">Ufa</a> , <a href="http://2gis.ru/">Kazan</a> ).  Plans for the near future - to run traffic jams in all cities with a population of one million. <br><br>  Under the cut a story about what problems we faced and how they were solved. <br><img src="https://habrastorage.org/getpro/habr/post_images/467/df6/1a6/467df61a63f0afdb5dd1faea6fb8aa67.png"><br><a name="habracut"></a><br>  The basis of traffic jams is data, namely points.  A single point carries the following basic information: <br><ul><li>  project identifier (city); </li><li>  registration time; </li><li>  coordinates; </li><li>  instant speed; </li><li>  driving direction at the time of registration. </li></ul><br>  We receive such points from our data providers, as well as users of the mobile version of 2GIS.  Before participating in the calculation, the data gets into the raw data storage, based on <a href="http://en.wikipedia.org/wiki/MongoDB">MongoDB</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What is the "draw points" and why it is needed:</b> <br>  Traffic jam does not exist by itself, but is usually located on some road.  The points themselves do not carry information on which section the device was passing at the time of registration, therefore they need to be superimposed on the road network. <br><br>  Thus, the <b>draw points</b> - the process of correlating each point of the road segment on which it was registered, taking into account its speed and direction of movement. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/586/e3b/729/586e3b7295cbef23a7337837e0c2cbcd.png"><br><br>  Let's take one point (figure a), and try to determine on which part of the road it was registered. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4d/ca2/d0b/c4dca2d0bb96a0ade951ad4e4c397a74.png"><br><br>  It is clear that the desired section of the road is somewhere near the point, so the task immediately becomes to find the nearest segment of the road network in a certain radius (for example, 20 meters). <br><br>  In this case, the forward and reverse directions of the nearest segment (Figure b) are very different from the direction that the device recorded at the time of registration of the point (indicated by the arrow), therefore this segment is not what we were looking for.  From the figure it is clear that the correct answer was nearby.  Such situations may arise, for example, due to the substantial error of the devices (trackers).  At more complex (perhaps multilevel) interchanges, they occur constantly, so this search will not work. <br>  Modify it as follows: we will not search for the nearest segment, but all segments within a radius.  As a result of such a search, we will receive several segments at once, and already, taking into account their direction, distance to them, and other attributes, we will be able to choose the correct segment more correctly. <br><br>  Everything is good, but the network in some cities is very large, hundreds of thousands of segments are getting expensive, and the points that need to be pulled are millions in a few minutes, so the quality of the search raises the same level as the solution quality. <br><br><h3>  What was before </h3><br>  Initially, there was no task to read online traffic jams, but the task was to process the data for the month so that in our offline products we set average monthly speeds on the roads and more realistic to show the travel time. <br>  Data from suppliers aggregated in a central repository. <br><br>  Since the central data warehouse uses <a href="http://www.postgresql.org/">PostgreSQL</a> , this problem was also solved at the early stages using the <a href="http://postgis.net/">PostGIS</a> extension. <br>  Simplistically, the algorithm was about the following: <br><ul><li>  At the preparation stage, polygons were built around all the edges of the graph (the <a href="http://www.postgis.org/docs/ST_Buffer.html">ST_Buffer</a> function), the width (different for different classes of roads) of which determined the tolerance. </li><li>  The point was checked for hit in these polygons and admissible edges were selected. </li><li>  A projection of a point was built on all admissible edges (the <a href="http://www.postgis.org/docs/ST_ClosestPoint.html">ST_ClosestPoint</a> function) and we obtained the sorting of admissible edges by distance. </li><li>  Using sorting by distance, checking the azimuth of the point and the azimuth of the edge segment, the class and width of the road and the previous drawn points from this device, we determined the probable edge of the graph and the projection of the point on this edge was considered a drawn point and recorded in the base. </li></ul><br>  The whole kitchen worked on stored procedures, although not very quickly, but there was no urgency in these data, since the problem was solved for offline products. <br><br>  On an average server, the speed was about 2,000 points per second. <br><br>  With the advent of the ‚ÄúOnline‚Äù mode, this solution was not enough: the data is updated every five minutes, so the full data processing cycle should fit into this time.  With the increase in the amount of data, this stage began to be performed so long that it was difficult to enter the whole cycle in five minutes even on a very powerful hardware. <br><br>  The time has come to implement an idea that has long been brewing up - the implementation of calculations in C ++. <br><br><h3>  Finding quick fixes </h3><br>  In parallel, we began to develop 2 solutions - one based on the GEOS library, and the second on a completely from scratch based on quadtrees. <br><br><h4>  About geos </h4><br>  This solution appeared first because it used the ready-made <a href="http://trac.osgeo.org/geos/">GEOS</a> library, which, by the way, uses PostGIS. <br><br>  <a href="http://geos.refractions.net/ro/doxygen_docs/html/classgeos_1_1index_1_1quadtree_1_1Quadtree.html">Quadtree</a> indexes from this library were used to search for the nearest segments. <br><br>  To do this, all segments of the road graph are loaded into the tree, the hit area is indicated around a point and at the output we have a set of segments that cross the hit area, then the segments are sorted by distance from the point and the closest one is selected. <br><br><h4>  Own implementation of quadtrees </h4><br>  This implementation appeared second, but (running a little ahead) turned out to be a little more successful. <br><br>  First, a few general definitions to add clarity. <br><br>  <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE_%25D0%25BA%25D0%25B2%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B0%25D0%25BD%25D1%2582%25D0%25BE%25D0%25B2">A quad</a> <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE_(%25D1%2581%25D1%2582%25D1%2580%25D1%2583%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585)">tree</a> is a <a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE_(%25D1%2581%25D1%2582%25D1%2580%25D1%2583%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585)">tree</a> in which each internal node has four children. <br>  The quadtree allows recursively split two-dimensional space into four quadrants (regions). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9eb/6aa/428/9eb6aa42867b102b2761d2c2ae02ce09.png"><br><br>  Quad-trees are able to store information about different types of data, but we are interested in storing segments (segments), since the road network can be simply represented using segments. <br><br>  For this, we used the PM Quadtree version - Polygonal Map Random Quadtree optimized for segment storage. <br><br>  PMR Quadtree: <br><ul><li>  Uses probabilistic splitting rule; </li><li>  Each node contains a variable number of segments; </li><li>  Each segment is inserted into all nodes that it intersects; </li><li>  If a node contains a number of segments that exceeds the limit, then splitting occurs (only once) into 4 child nodes; </li><li>  Well suited for the task of finding the nearest segment. </li></ul><br>  Minuses: <br><ul><li>  Possible unbalance wood. </li></ul><br>  Each tree node represents a certain area (for example, square) and contains the following information: <br><ul><li>  Depth; </li><li>  Area coordinates; </li><li>  Four children, if the node is internal; </li><li>  Segments, if the node is external. </li></ul><br>  The node stores only those segments that intersect its area.  The number of segments in a node is variable. <br><br><h3>  Building </h3><br>  Building a data structure is the process of sequentially inserting segments into a tree.  Initially, the tree is empty. <br>  Similar to the algorithms for building many other hierarchical data structures, the PMR Quadtree algorithm is based on <i>top-down traversal</i> .  In other words, starting from the root node, we visit all the child nodes intersecting the segment, and add this segment to all external nodes encountered. <br><br>  A key aspect of PMR Quadtree is the partitioning rule, that is, the condition under which a node is divided.  For this purpose, some parameter <i>t is used</i> , which limits the number of segments that can be contained in a node. <br>  If the number of segments that intersects with a region exceeds <i>t</i> and if the maximum depth level is not reached, then this region is divided into four subsidiaries, and all segments that intersect with it are inserted into new subsidiary nodes.  It is worth noting that immediately after splitting the child nodes are not split again, even if the number of segments in the node exceeds <i>t</i> .  This avoids excessive partitioning and leads to probabilistic behavior in the sense that the order in which objects are inserted affects the structure of the resulting tree. <br><br><h4>  Visualization </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/90f/ccf/07c/90fccf07c4cf942a5dfd2d434a884078.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f48/cf0/18a/f48cf018afd8657527900b7b7371c7d9.png"><br><br><h3>  Search in the tree </h3><br>  For the search we will use the <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D1%2587%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B4%25D1%258C_%25D1%2581_%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25B5%25D1%2582%25D0%25BE%25D0%25BC_%2528%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5%2529">queue with priority</a> . <br>  In the queue we will put objects of three types: <br><ul><li>  internal nodes; </li><li>  external nodes; </li><li>  segments. </li></ul><br>  The key in the queue is the distance to the starting point.  Initially, the queue contains only the root node. <br><br>  Now at each step we will take from the queue an object with a minimum distance and, depending on its type, carry out the corresponding operations: <br><ul><li>  Internal node  We add to the queue each of the four children, if the distance from it to the point does not exceed R </li><li>  External node  Add to the queue all segments contained in it, the distance to which from the point does not exceed R </li><li>  Segment.  Found the answer to the problem. </li></ul><br>  Similarly, you can solve the problem of several nearest segments in the radius. <br><br><h3>  Comparison </h3><br>  Comparing the implementation on GEOS and our own, we were pleasantly surprised: <br>  On the same gland for 300,000 segments: <br><table><tbody><tr><th></th><th>  Geos </th><th>  PMR Quadtree </th></tr><tr><td>  Building a tree </td><td>  2 seconds </td><td>  0.2 seconds </td></tr><tr><td>  Memory consumption </td><td>  200 MB </td><td>  50 MB </td></tr><tr><td>  Draw points </td><td>  35 500 points per second </td><td>  383,500 points per second </td></tr></tbody></table><br>  As a result, the own decision laid the foundation for the new draw service of points, and allows you to draw points from all suppliers throughout Russia on an average server. <br><br><h3>  Conclusion </h3><br>  As a result, moving from PostGIS to a highly specialized solution in C ++, we received an acceleration from 2k to 380k (190 times). <br><br>  Write highly specialized bikes! <br><br>  How the traffic jams service works can be viewed <a href="http://2gis.ru/">right now</a> , or by installing 2GIS on <a href="https://itunes.apple.com/ru/app/2gis-offlajn-karty-i-spravocniki/id481627348%3Fmt%3D8">iOS</a> , or <a href="https://play.google.com/store/apps/details%3Fid%3Dru.dublgis.dgismobile">Android</a> . </div><p>Source: <a href="https://habr.com/ru/post/205742/">https://habr.com/ru/post/205742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205730/index.html">Deploying node.js applications</a></li>
<li><a href="../205734/index.html">Writing spaces with a capital letter in Yii 2.0</a></li>
<li><a href="../205736/index.html">yo n - a quick start for a new project node.js</a></li>
<li><a href="../205738/index.html">OpenVZ for Debian Wheezy</a></li>
<li><a href="../205740/index.html">2,000 people, 3K projects per year: what is PPM, and why do you need it</a></li>
<li><a href="../205746/index.html">How Mosfilm Milks Soviet Copyright Cows</a></li>
<li><a href="../205754/index.html">The best resources to get started with Drupal 8</a></li>
<li><a href="../205756/index.html">Russian AI Cup: technical details</a></li>
<li><a href="../205758/index.html">Dell VRTX is coming to us!</a></li>
<li><a href="../205762/index.html">Launch Ubuntu and watch Torrent and Torrent-TV straight on Samsung SmartTV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>