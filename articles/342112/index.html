<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do not touch the logs with your hands. Part 2: How we implemented Unified Logfile Analyzer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, we talked about the system we created under the name ULA (Unified Logfile Analyzer) ‚Äîanalyzer, the main functions of which are co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do not touch the logs with your hands. Part 2: How we implemented Unified Logfile Analyzer</h1><div class="post__text post__text-html js-mediator-article">  In the last article, we talked about the system we created under the name <a href="https://habrahabr.ru/company/efs/blog/338164/">ULA</a> (Unified Logfile Analyzer) ‚Äîanalyzer, the main functions of which are collecting and aggregating incoming error messages using the shingles algorithm, making decisions on them and automatic notification for problems with the test environment.  Today we will share the practice of detecting / resolving bugs rolling out this system and our plans. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mx/gz/gm/mxgzgmowehpnx89vcolpn7o8zp4.jpeg"></div><br><a name="habracut"></a><br>  At the moment we have connected to the system a little less than half of the planned projects.  Why not everything?  Maybe the employees received insufficient information, maybe they simply did not believe in the product - as it turned out, it was not enough just to tell managers about the product and arrange a few presentations.  In the project environment, where the developers from among the creators of the ULA participated, the success was greater, and the implementation at the beginning was carried out without much effort. <br><br>  Implemented ULA through meetings with management and testers.  They told about the system on presentations, demonstrated the main functions.  After several such sessions, ESF autotest developers gradually began to receive connection requests.  Perhaps, it would be possible to start better if we announced the tool in advance so that users would wait for the release. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Standard questions that were asked to us: <br><br>  <i>- Does your system compete with HP ALM?</i> <br>  Perhaps in the future, in terms of collecting metrics for automated testing. <br><br>  <i>- Does your system know how to aggregate the logs of the ESF systems themselves?</i> <br>  Not at the moment, but in the future we will implement the log analysis of the systems themselves.  While this data is collected and attached to the tests in the form of additional information. <br><br>  <i>- Why not the ELK stack (Elastic Search, Log Stash, Kibana)?</i> <br>  We need more complex processing logic, decision-making functionality, integration with HP SM, HP ALM, the ability to work with the source data purposefully on the right request, i.e.  do not need a constant stream of data from the system logs. <br><br>  <i>- And who will use the system?</i> <br>  Here everything is ambiguous.  The implication was that a team of engineers, which conducts mostly manual testing and analyzes autotests, should analyze the errors.  But this is not always the case: in completely new projects, autotest developers or other engineers are often involved in parsing.  Therefore, now it is important for us to clearly understand the situation for each project, to identify those who need to be trained to work with the system. <br><br>  Now about the problems that we faced after connecting several ESF projects. <br><br><h2>  Quality AutoTest logs </h2><br>  The main problem that required a change in the basic algorithm is the presence of the same type of trace trace in the logs that write auto-tests.  For a series of tests, TestNG is used, and in case of an error, the guys write a full trace to the log, which the framework generates.  As a result, up to 80% of the length of the error message becomes similar.  It was necessary to do something with it.  And quite urgently.  To cut off part of the log and not to process it at all would be completely wrong.  Therefore, it was decided to introduce weight shingles, i.e.  introduce weights canonized, cleared of "garbage" phrases.  There is no such approach in the classical algorithm. <br><br>  In the future, when enough statistical data is gathered, we derive the necessary polynomial for determining weights.  So far, when viewing several hundred messages, it was decided to use the slightly corrected arc-tangent function.  The main significance is taken by the first 20 to 30 words of the message, then a slight decline begins (the beginning of the stack trace).  The tail trace has the least significance.  It may be necessary in the future to introduce the dependence of the parameters of the algorithm on the subsystem under test and the framework used. <br><br><h2>  Performance </h2><br>  Although during the development of the system load testing was carried out at each sprint, it did not help us to avoid a number of performance problems when connecting real projects.  We are faced with the fact that: <br><br><ul><li>  the load is distributed very unevenly; <br></li><li>  Real error messages sometimes have such a large volume that their analysis on the DBMS server can occupy them for almost 1 second. <br></li></ul><br>  It happens that the queue gets up to 200 messages per second, and they begin to accumulate.  As a result, everything, of course, is processed without critical situations, but a 100% busy processor affects the operation of WEB services.  Here is what we have done so far to solve performance problems: <br><br><ul><li>  added several CPUs to the database server to enable parallelization of error handling; <br></li><li>  did shingles processing through a separate Oracle AQ subscriber with their own procedure, which will deal only with error handling and nothing else.  Inserting information about autotest steps will occur independently of this function, and data synchronization will occur at the end of the launch; <br></li><li>  worked through the changes in the message loading algorithm: switching from batch mode to online without delay; <br></li></ul><br>  However, the issue of performance is not fully resolved, the team continues to work. <br><br><h2>  Synchronization of flows in a DBMS </h2><br>  Oracle AQ queue parsing occurs through a procedure that is associated with a subscriber.  The DBMS manages multithreading, but with a heavy load, we are faced with a problem. <br><br>  The fact is that it is necessary to keep logs of incoming messages in the system (one message for us is a record of the test step).  Counters are grouped by unique launch IDs.  This is necessary in order to compare the number of incoming messages with the expected ones and to understand whether the launch is complete, build a test tree and display an aggregated error table.  Without elements of synchronization of threads such a counter can not be entered.  First, we invented the ‚Äúbicycle‚Äù and made the MUTEX table, which was blocked for a fraction of a second during the calculation of the counter value.  Under heavy load, they began to catch the dead block.  Then they used the DBMS_LOCK package and created a lock on the piece of code that worked with the counter.  For a long time, they could not understand why sometimes the counter showed an incorrect value, but in the end they decided to have a synchronization problem.  For those interested, we recommend reading this <a href="http://bluefrog-oracle.blogspot.ru/2013/12/user-defined-locking-with-dbmslock.html">article</a> about the pitfalls of locks. <br><br><h2>  Versatility </h2><br>  We position the system as universal: it is enough to write our own autotest report parser for it.  But in fact, for the same Allure it turned out to be quite difficult to do.  The fact is that the same can be recorded in the report in different ways, we do not have general rules.  As a result, for two weeks constantly had to carry out improvements and, most likely, this is not the end.  We even got into the code of Allure itself, but more on that later. <br><br><h2>  System limitations and design errors </h2><br><ul><li>  There is a restriction for the similarity algorithm: the system works only with errors consisting of more than 4 words.  Although we have not yet met such short texts in the EFS, now we are choosing a new algorithm just in case. <br></li><li>  The aggregation of the logs of the ESF subsystems does not occur yet, because the logging rules in the ESF are not worked out until the end.  Now we can not always extract useful information from text log files, for example, to which session the recording belongs.  At first, the system will only enrich with this information the data about errors found by autotests. <br></li><li>  When designing the system, we focused on HP ALM and the dimensions of the fields: test ID, test name, step name.  But besides the GUI and API tests of the EFS, we begin to work with autotests for mobile applications, information about which is transmitted to Jira, where the dimension of the fields is significantly greater than in ALM.  In addition, the test ID field is text.  But at the time of this writing, we have already prepared a patch that fixes the problem, affecting the productive data. <br></li></ul><br><h2>  Allure </h2><br>  The first Allure problem we encountered is the difference in adapters for different frameworks.  This is not the specifics of our autotests, but a common practice.  The testClass and testMethod labels with which the test was defined belonged to the testNG feature adapter, and other adapters did not provide them by default.  Adding 2 labels turned out to be easy, since the model (AllureModelUtils) had these methods: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Label </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createTestClassLabel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String testClass)</span></span></span><span class="hljs-function"> </span></span>{        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createLabel(LabelName.TEST_CLASS, testClass);    }    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Label </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createTestMethodLabel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String testMethod)</span></span></span><span class="hljs-function"> </span></span>{        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createLabel(LabelName.TEST_METHOD, testMethod);    }</code> </pre> <br>  It was decided not to rewrite the logic of the parser, but to create your own listener in which these two labels would be added. <br><br>  The second problem we encountered is testNG.  The adapter creates separate tests for the <a href="https://habrahabr.ru/users/before/" class="user_link">before</a> methods if an error occurred during their execution.  The tests themselves go to the status of canceled.  Thus, we received duplicate tests in our system. <br><br>  The fix for this Allure feature was flagged in RoadMap Allure 2.0, but most projects still used version 1.5 or even lower.  Our parser was primarily written for these versions.  We could not wait, so again we went by correcting the listener. <br><br><h2>  Multi-browning </h2><br>  When designing, we chose React JS and focused on working in Google Chrome.  They showed it to the management, started testing it on other browsers and it turned out that nothing really works.  In the future, it will be necessary to devote more time to the problem of multi-browser compatibility.  At the moment, the WEB part of the system works in Google Chrome, Mozilla Firefox, MS IE latest versions. <br><br><h2>  Shoemaker without shoes </h2><br>  We are so carried away by other logs that we forgot about our own.  Of course, they were, but the detailing turned out to be insufficient.  When the real operation began and problems started to fall down, we had to spend several days walking through all the functionality and making normal logging in the system itself.  Logs are written for errors in the analysis of queues, in the called procedures and in the system services themselves.  Logs every user action. <br><br><h2>  Rush </h2><br>  In order to accelerate the output of the system to productive operation, the usual bash was used to search for the necessary pieces of logs in the file system on the ESA test environment.  They wrote a script that goes through the directories, unpacks the necessary files, searches for entries for the input session and writes intermediate results into a temporary file (rather large).  The last action was a mistake.  This solution was single-ended and unacceptable for us.  At the moment we rewrote almost all the functionality in Java, and the intermediate results are stored entirely in memory. <br><br><h2>  Future plans </h2><br>  In the near future we plan: <br><br><ul><li>  Deploy the system online to test mobile devices; <br></li><li>  to integrate with Jira for the establishment of defects in mobile applications there; <br></li><li>  implement automatic notification of open blocking defects so that the user can correct the list of tests at the next launch; <br></li><li>  develop an algorithm for pre-filling the fields, which will give a gain in time when new defects are introduced; <br></li><li>  develop an algorithm for automatically placing requests for servicing the test environment by administrators, which will streamline the work; <br></li><li>  refine the search algorithm for fuzzy matches, making it more flexible, so that the system is less mistaken in error aggregation; <br></li><li>  make autocategorization of errors.  The system, based on previously made decisions and on the basis of manually entered rules, will immediately break the error messages into categories, which will allow the user to pay attention primarily to important problems: <br></li><li>  Enrich the network traffic requests and responses for API tests; <br></li><li>  create automatic scan functionality for the entire launch: scanning all system logs for errors during the session.  The user will be able to click on the successful launch from the point of view of the autotest developer and carry out an automatic analysis for errors in the system itself. <br></li></ul><br>  Despite all the bugs, we are optimistic and believe that the development will help engineers to significantly reduce the time to analyze the results and improve the quality of analysis.  At the moment, we have accumulated volume backlog, the implementation of which will give us a new interesting experience and make the product better.  We will be happy to answer your questions on the topic, learn about your practice and cases. </div><p>Source: <a href="https://habr.com/ru/post/342112/">https://habr.com/ru/post/342112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342102/index.html">Technical features of the ICO. Start</a></li>
<li><a href="../342104/index.html">In five days I was interviewed at five Silicon Valley companies and received five job offers</a></li>
<li><a href="../342106/index.html">Just about D3.js</a></li>
<li><a href="../342108/index.html">Guide to creating your own cohort recurrence report</a></li>
<li><a href="../342110/index.html">4 words</a></li>
<li><a href="../342114/index.html">Agile Turkey Summit 2017, and such controversial "internationalism" of the event</a></li>
<li><a href="../342116/index.html">Git in practice</a></li>
<li><a href="../342118/index.html">‚ÄúOur application as a TARDIS: more inside than it seems from the outside‚Äù - Avito about mobile development</a></li>
<li><a href="../342124/index.html">Java EE 8: A brief and very optimistic overview of new features.</a></li>
<li><a href="../342126/index.html">Centralized continuous deployment for the year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>