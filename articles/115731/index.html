<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>100 thousand visits per day (debriefing and new experiment)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my last article about the speed of working with GAE data, a graphic counter of impressions was embedded. Everyone could see the value of the counte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>100 thousand visits per day (debriefing and new experiment)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f7a/10e/7a4/f7a10e7a4b13ac90ed31f759c3962cdd.png" alt="couner" align="left">  In my last <a href="http://habrahabr.ru/blogs/gae/115517/">article</a> about the speed of working with GAE data, a graphic counter of impressions was embedded.  Everyone could see the value of the counter and consumed CPU resources.  As I already said, the counter was quite ‚Äúheavy‚Äù: the load it creates is equivalent to displaying 1000 records from a database on a page without using caching. <br><br>  The experiment with the counter turned out to be very useful, and its results are somewhat unexpected for me (different from requests from a single IP address).  I want to share the results of the experiment and set up a new experiment, taking into account the errors that have been passed.  By the way, the source code of the new graphical counter is available for all and is given in the article. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Query schedule</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de2/d70/09c/de2d7009c7dc20e7273a8420467c30c0.png" alt="image"><br><br>  Maximum 7 requests per second (so many open the main page of Habr in the evening).  In the daytime, I think this figure rises to 10 requests per second. <br><br>  <b>CPU consumption graph</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/26b/564/e30/26b564e3097a5897749cf55c1e75b8cc.png" alt="image"><br><br>  The graph captures such an unpleasant moment as a lack of activity.  At this point, the article was on the main page, but the pictures were not displayed, since the free resource limit was over.  In the morning the situation was corrected. <br><br>  <b>Resource consumption for the first day</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff4/985/377/ff4985377dccae5413e695f063ac0720.png" alt="image"><br><br>  There is no resource consumption on the graph until 10 am MCK (since at 10 o'clock the resource counters are reset).  Till 10 o'clock about the same amount was spent.  In total, about 150 thousand requests and 500 MB of traffic (some requests for a static image, but they are much smaller). <br><br>  <b>Number of running instances</b> <br><br>  Unfortunately, by mistake I deleted the screen with the running instances.  With 6 visitors per second, 16 instances were launched (this is the maximum I recorded). <br><br>  <b>Inhibited requests ???</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce8/b8e/13f/ce8b8e13f41a255fc3eb4aeb011e0f02.png" alt="image"><br><br>  And here is the most interesting.  After a while, a problem arose: approximately every 5th request started to be executed 5-10 times longer than the average (on average, the counter was loaded for 0.5 seconds).  Initially, even with many visits, this was not observed.  The situation has not changed until now, when there were very few visits. <br><br>  <b>How to explain these errors?</b>  <b>Options:</b> <br><br>  1. <i>Warm up request.</i>  No, since not enough time has passed for the instance to unload (for example, on this chart, the time between 3 erroneous requests is less than a minute). <br>  2. <i>Simultaneous modification of the record in the repository with the same key.</i>  No, since it took more than 10 seconds between requests. <br>  3. The application has been limited as ineffective. <br><br>  Remains the last.  This is despite the fact that, on average, the request was executed in less than 1 second (about 0.5 seconds).  The algorithm for determining the inefficiency of applications has not been disclosed, so it is quite difficult to say something definite ... <br><br>  Honestly, for me these mistakes remain a mystery. <br><br>  <b>Solution to the problem</b> <br><br>  If the problem is really that the application has been limited as ineffective, then the problem will not recur with the new counter code (org.toyz.litetext was previously used), which runs about 7 times faster.  The formation of the picture is made very simple, but quite effectively (the code is shown below - you can use it on your website). <br><br>  Second edition: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> final <font color="#0000ff">class</font> DynamicImage <br> { <br> <font color="#008000">//   </font> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#2B91AF">String</font> FOLDER = <font color="#A31515">"resources"</font> ; <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> Image backgroundImage; <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final Map&lt; <font color="#2B91AF">String</font> , Image&gt; imageTable = <font color="#0000ff">new</font> <font color="#2B91AF">Hashtable</font> &lt; <font color="#2B91AF">String</font> , Image&gt;(); <br> <br> <font color="#0000ff">static</font> <br> { <br> <font color="#0000ff">try</font> <br> { <br> backgroundImage = makeImage( <font color="#A31515">"appengine.png"</font> ); <br> <br> imageTable.put( <font color="#A31515">"1"</font> , <br> makeImage( <font color="#A31515">"1.png"</font> )); <br> imageTable.put( <font color="#A31515">"2"</font> , <br> makeImage( <font color="#A31515">"2.png"</font> )); <br> imageTable.put( <font color="#A31515">"3"</font> , <br> makeImage( <font color="#A31515">"3.png"</font> )); <br> imageTable.put( <font color="#A31515">"4"</font> , <br> makeImage( <font color="#A31515">"4.png"</font> )); <br> imageTable.put( <font color="#A31515">"5"</font> , <br> makeImage( <font color="#A31515">"5.png"</font> )); <br> imageTable.put( <font color="#A31515">"6"</font> , <br> makeImage( <font color="#A31515">"6.png"</font> )); <br> imageTable.put( <font color="#A31515">"7"</font> , <br> makeImage( <font color="#A31515">"7.png"</font> )); <br> imageTable.put( <font color="#A31515">"8"</font> , <br> makeImage( <font color="#A31515">"8.png"</font> )); <br> imageTable.put( <font color="#A31515">"9"</font> , <br> makeImage( <font color="#A31515">"9.png"</font> )); <br> imageTable.put( <font color="#A31515">"0"</font> , <br> makeImage( <font color="#A31515">"0.png"</font> )); <br> <br> imageTable.put( <font color="#A31515">"("</font> , <br> makeImage( <font color="#A31515">"leftBracket.png"</font> )); <br> imageTable.put( <font color="#A31515">")"</font> , <br> makeImage( <font color="#A31515">"rightBracket.png"</font> )); <br> } <br> <font color="#0000ff">catch</font> (IOException exception) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> RuntimeException(exception); <br> } <br> } <br> <br> <font color="#0000ff">public</font> Image drawText( <font color="#2B91AF">String</font> text, <br> Anchor anchor, <br> <font color="#0000ff">long</font> backgroundColor) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> == text) <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ArgumentNullException( <font color="#A31515">"text"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> == anchor) <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ArgumentNullException( <font color="#A31515">"anchor"</font> ); <br> <br> Collection&lt;Composite&gt; compositeCollection = <font color="#0000ff">new</font> <font color="#2B91AF">ArrayList</font> &lt;Composite&gt;(); <br> <br> <font color="#008000">// background</font> <br> compositeCollection.add(ImagesServiceFactory.makeComposite(backgroundImage, <br> 0, <br> 0, <br> 1f, <br> Anchor.TOP_LEFT)); <br> <br> <font color="#0000ff">int</font> xOffset = 0; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> pos = 0; pos &lt; text.length(); pos++) <br> { <br> <font color="#2B91AF">String</font> symbol = Character.toString(text.charAt(pos)); <br> <br> <font color="#0000ff">if</font> (!imageTable.containsKey(symbol)) <br> <font color="#0000ff">continue</font> ; <br> <br> Image image = imageTable. <font color="#0000ff">get</font> (symbol); <br> <br> compositeCollection.add(ImagesServiceFactory.makeComposite(image, <br> xOffset, <br> 0, <br> 1f, <br> anchor)); <br> <br> xOffset += image.getWidth(); <br> } <br> <br> <font color="#0000ff">return</font> ImagesServiceFactory.getImagesService().composite(compositeCollection, <br> backgroundImage.getWidth(), <br> backgroundImage.getHeight(), <br> backgroundColor); <br> } <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> Image makeImage( <font color="#2B91AF">String</font> imageName) <br> throws IOException <br> { <br> InputStream inputStream = <font color="#0000ff">null</font> ; <br> ByteArrayOutputStream outputStream = <font color="#0000ff">null</font> ; <br> <br> <font color="#0000ff">try</font> <br> { <br> <font color="#2B91AF">String</font> filePath = FOLDER + <font color="#2B91AF">File</font> .separatorChar + imageName; <br> inputStream = DynamicImage. <font color="#0000ff">class</font> .getResourceAsStream(filePath); <br> <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> == inputStream) <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> IllegalStateException( <font color="#A31515">"filePath="</font> + filePath); <br> <br> outputStream = <font color="#0000ff">new</font> ByteArrayOutputStream(); <br> <br> <font color="#0000ff">int</font> length; <br> <font color="#0000ff">byte</font> [] buffer = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [1024]; <br> <br> <font color="#0000ff">while</font> ((length = inputStream.read(buffer, <br> 0, <br> buffer.length)) &gt; 0) <br> { <br> outputStream.write(buffer, <br> 0, <br> length); <br> } <br> <br> outputStream.flush(); <br> <br> <font color="#0000ff">return</font> ImagesServiceFactory.makeImage(outputStream.toByteArray()); <br> } <br> <font color="#0000ff">finally</font> <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> != inputStream) <br> inputStream.close(); <br> <br> <font color="#0000ff">if</font> ( <font color="#0000ff">null</font> != outputStream) <br> outputStream.close(); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  I ask the community to participate in the experiment.  <s>The results will definitely report in this article.</s> <br><br>  The results of the experiment made me happy!  For half a day the counter was opened by about 100 thousand people (as expected).  At the same time, 1 GB of traffic was spent (well, at least the picture was reduced, otherwise it would not fit into the 3 GB limit): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc4/c1a/457/bc4c1a457ba6d891d2b001cd19797c43.png" alt="image"><br><br>  The maximum number of running instances was 9 pcs.  (at 8 requests per second): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44b/c32/e9b/44bc32e9b3ee4bebe5ea7ff2f7ce5d0b.png" alt="image"><br><br>  And requests at this moment were executed without delay.  Here is an excerpt from the log: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1b6/a0c/9e8/1b6a0c9e8a5f2911468683b919328911.png" alt="image"><br><br>  At the same time, each request performed a record in the database and checking the uniqueness of the IP address.  It turned out for FREE!  Enough free resources! <br><br>  <b>Conclusion</b> <br><br>  With proper use, GAE is able to withstand a tremendous burden.  Google really did what many dreamed about: paying only for actually used resources (all honest: if you don‚Äôt use it, you don‚Äôt need to pay anything).  It remains for us to only create services that would attract such a number of visitors. </div><p>Source: <a href="https://habr.com/ru/post/115731/">https://habr.com/ru/post/115731/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115726/index.html">Experience contacting Sony support</a></li>
<li><a href="../115727/index.html">F #: What your code turns into after compilation</a></li>
<li><a href="../115728/index.html">Internet Explorer 9 launched in Russia with Mail.Ru, Yandex and a new game.</a></li>
<li><a href="../115729/index.html">Effective presentation skills</a></li>
<li><a href="../115730/index.html">Windows: the ability to end the session if the screen is locked</a></li>
<li><a href="../115738/index.html">What is website design and why should it be done?</a></li>
<li><a href="../115739/index.html">Analysis of the simplest captcha (C #)</a></li>
<li><a href="../115740/index.html">Turn the tablet into a netbook with a cover</a></li>
<li><a href="../115741/index.html">Door bell boom</a></li>
<li><a href="../115742/index.html">How to tame clouds: examples of practical use. Start</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>