<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>String collections are read-only: we save on matches</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It often happens that the program loads some data into memory and leaves it there for a long time (or even until the end of work) in an unchanged form...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>String collections are read-only: we save on matches</h1><div class="post__text post__text-html js-mediator-article">  It often happens that the program loads some data into memory and leaves it there for a long time (or even until the end of work) in an unchanged form.  It uses data structures that are optimized for both reading and writing.  For example, you subtract from <a href="http://www.ensembl.org/">Ensembl a</a> list of identifiers of all human genes (including all sorts of miRNAs, etc. - just a little more than 50,000).  If you read them in the standard ArrayList, then on a 32-bit HotSpot you will spend a little more than 4 megabytes.  Is it possible to save memory, knowing that the collection will no longer change? <br><a name="habracut"></a><br>  We will not deal with the possibility of reading data from the database in parts: this is a topic for another conversation.  In addition, reading in parts is quite possible to combine with the approaches described here, achieving additional memory savings.  Also, we will not use, for example, the -XX virtual machine option: + UseCompressedStrings: it saves memory not only in our case and can also be combined with our methods. <br><br>  Before you optimize something, you need to measure it.  In our case, we are talking about the amount of memory occupied by the list.  And, of course, we are not interested in the shallow size (the size of the ArrayList object itself), but in the retained size (the size of the ArrayList and all the objects to which it refers directly or indirectly).  Measurement will be made using <a href="http://www.eclipse.org/mat/">Eclipse Memory Analyzer</a> .  Find the desired object in the heap (for example, by the name of the class) and use the Show retained set option.  We get this picture: <br><br><img src="https://habrastorage.org/storage2/386/bad/08a/386bad08a40576b84c2ec201435678f8.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As expected, ArrayList itself weighs quite a bit - 24 bytes.  The Object [] array of string references, defined inside the ArrayList, weighs decently, but still more than 90% of the space is eaten by the string objects themselves and the associated char [] arrays. <br><br>  A small improvement can be achieved if you trim the Object [] array to the actual number of elements.  As you know, ArrayList allocates space with a margin so as not to re-allocate each time an element is added.  Once we know that the elements will no longer be added, this supply is useless.  You can do this simply and effectively: <br><br><pre><code class="java hljs">List&lt;String&gt; genes = readGenes(); genes = Arrays.asList(genes.toArray(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[genes.size()]));</code> </pre> <br><br>  Here the result is no longer an ArrayList (or rather, an ArrayList, but different).  We first create a copy of the array of the required length, and then we make a wrapper over the copy.  Now the retained set looks like this: <br><br><img src="https://habrastorage.org/storage2/d66/6fb/b3f/d666fbb3f52cb11d154745bb41c361dc.png"><br><br>  The array became a bit smaller, but in the end we saved 0.44% of the space.  Well, nothing, we just warm up. <br><br>  Let's look at these char [] arrays.  They contain identifiers of genes like ‚ÄúENSG00000121410‚Äù (15 characters - 30 bytes), another 8 bytes of system information about the object and 4 bytes of length each.  And these 42 bytes are aligned by 8, that is, 6 unused bytes are added.  Thus, out of 48 bytes, only 30 carry useful information (with + UseCompressedStrings they can be reduced to 15, then the share of ‚Äúextra‚Äù information will increase).  What can be done with this? <br><br>  Recall how String.substring works.  The string that is obtained as a result divides the common char [] buffer with the parent string: in the child string, the values ‚Äã‚Äãof offset and count are set accordingly.  In this case, the child string is no different from the user‚Äôs point of view, but if the parent line was deleted, the full buffer is still stored, even if you cut off one character from the megabyte line.  Sometimes it is annoying, you have to look for such places in the code and sign the new String, but now we, on the contrary, will help.  We put all the rows in the array on one char [] buffer.  To do this, we write an auxiliary method in some utility class: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compactify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;String&gt; list)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( String item : list ) sb.append(item); String data = sb.toString(); List&lt;String&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;String&gt;(list.size()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( String item : list ) { result.add(data.substring(index, index + item.length())); index += item.length(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br><br>  The method first sticks together all the strings of the original collection into one long string, and then cuts it into substrings using the substring.  Run our list of genes through this seemingly useless operation and look at the retained set: <br><br><img src="https://habrastorage.org/storage2/b01/017/656/b01017656afa85832b77ac29af4e9c4a.png"><br><br>  Yeah, already significant.  Saved almost all of those extra bytes, as mentioned above, in the amount of winning 24% of the original size.  If the strings in your array are shorter than 15 characters, then the savings will be even greater.  Note, by the way, that when creating an ArrayList, we explicitly specified its length, so Object [] does not contain redundant elements, that is, we did not lose the first optimization. <br><br>  The resulting array can be safely used for writing, you just have to keep in mind that any line drags all the others along with it, so if we try to delete the lines, we will not release all of the memory.  But since we agreed that the array is read-only, everything is fine.  Be careful if there are duplicate lines in the input array: the function does not check this, and you may lose more than get on it. <br><br>  Still, 24% is small.  The eye is cut by String objects, which in fact have no benefit (the data itself is in char []).  Maybe you can not store them, and cut the string on demand?  To do this, we have to write our own implementation of the List and store the starting line offsets: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompactStringList</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractList</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RandomAccess</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String data; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] offsets; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompactStringList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;String&gt; list)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); offsets = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[list.size()]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = <span class="hljs-number"><span class="hljs-number">0</span></span>, i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( String item : list ) { sb.append(item); offsets[i++] = offset; offset+=item.length(); } data = sb.toString(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> index == offsets.length - <span class="hljs-number"><span class="hljs-number">1</span></span> ? data.substring(offsets[index]) : data.substring(offsets[index], offsets[index + <span class="hljs-number"><span class="hljs-number">1</span></span>]); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> offsets.length; } }</code> </pre><br><br>  In the constructor, we again glued all the input lines into one, remembering the offset of the beginnings of the lines in the array.  Upon receipt of the element (for simplicity, I do not check the correctness of the parameter), we cut the desired piece from the string.  In this case, only a new String object is created, and the data itself is not copied.  Take a look at the retained set of such an object: <br><br><img src="https://habrastorage.org/storage2/4f2/0f7/360/4f20f736028215d231f640afeecff19b.png"><br><br>  Now we have saved 55.5% compared to the original version, here you can start dancing. <br><br>  Of course, the latest optimization is the most controversial and depends on further usage scenarios.  For example, if you often get the same element get and store the resulting strings in other collections, you will have String objects.  Although they point to a common buffer, you will lose 40 bytes per line (in 32-bit HotSpot).  Do not get carried away with optimizations for the sake of optimizations: it can only get worse.  However, in many applications this method may be useful.  Well, or at the very least, expand the understanding of Java features to some readers. </div><p>Source: <a href="https://habr.com/ru/post/145145/">https://habr.com/ru/post/145145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145139/index.html">3D printing: nylon, ice, chocolate and others</a></li>
<li><a href="../145140/index.html">Windows Sockets, IOCP and Delphi</a></li>
<li><a href="../145141/index.html">Work with isometric matrices. Part 1</a></li>
<li><a href="../145142/index.html">Sergey Brin showed Google Glass in a TV interview</a></li>
<li><a href="../145143/index.html">Twitter Bootstrap 2.0.4 Release</a></li>
<li><a href="../145147/index.html">3D printers: even cheaper, more original</a></li>
<li><a href="../145148/index.html">Level Table for System Administrator</a></li>
<li><a href="../145151/index.html">IPTV monitoring</a></li>
<li><a href="../145152/index.html">gmaps.js is the easiest way to use the Google Maps API</a></li>
<li><a href="../145153/index.html">[How-To] Sync multiple calendars to Google, Thunderbird and WP7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>