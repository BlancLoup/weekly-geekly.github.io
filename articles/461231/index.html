<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>And what difference does Collation choose?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was prepared for students of the course "MS SQL Server Developer" 
 I want to share a story from one of the previous projects, which illu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>And what difference does Collation choose?</h1><div class="post__text post__text-html js-mediator-article"><p>  This article was prepared for students of the course <a href="https://otus.pw/Etzl/">"MS SQL Server Developer"</a> <br>  I want to share a story from one of the previous projects, which illustrates that Collation must be chosen very thoughtfully.  And about what happens if this parameter is nevertheless chosen incorrectly, and what options exist for solving the problem. </p><br><p>  First, a small introduction on what Collation is.  In SQL Server, the Collation parameter tells the server how to sort and compare rows.  For example, the lines ‚ÄúApple‚Äù and ‚Äúapple‚Äù.  Are they different or not?  It depends on the specified Collation.  If the register is becoming less or less clear, then what to do with the example of ‚ÄúChristmas tree‚Äù and ‚ÄúChristmas tree‚Äù?  Count them as the same or as different?  This is all in Collation too. </p><br><p>  The story happened in a project whose functionality is very similar to DropBox or Google Drive.  It provides the ability to manage their synchronized folders and files on different machines, as well as the ability for other users to have access to this synchronized folder. </p><br><p><img src="https://habrastorage.org/webt/zb/r_/ix/zbr_ixoq-dgwur4uwz_izd9myta.png" alt="image"></p><a name="habracut"></a><br><p>  So, the story began with the fact that on Prod servers there were 75-90% of errors in the logs (see the screenshot below), and it is not clear where they came from, and what was their reason.  The error was: ‚ÄúReadWrtLst is not complete‚Äù.  Next came the user's details and their folders. </p><br><p><img src="https://habrastorage.org/webt/i5/jz/lt/i5jzltkaco2jt9du8opn4ywi1du.png" alt="image"></p><br><p>  The code quickly found a place that generated an error, but we couldn‚Äôt understand why it occurred and how to reproduce it. It was only clear that the error was somehow related to the fact that the user somehow managed to make another folder with the same name in your OS. </p><br><p>  We have collected information on users for whom this error is issued.  And here the first surprise was waiting for us: out of millions of users of the system, only 50 had this error. And these 50 users generate 90% of the error logs.  Since the situation could not be reproduced, we decided to contact one of the users and find out why one of the folders was not synchronized with it.  The folder looked the same to us as the others, the only difference was that it was called in the user's language using hieroglyphs.  And the user was Japanese.  By the way, among these 50 users, the Japanese were the majority. </p><br><p>  Thanks to one of the developers of the team, we were able to reproduce the error.  The error was that the operating system considered the folder names different, and SQL Server considered them the same because of the selected Collation. </p><br><p>  Collation used in the project: <br>  SQL_Latin1_General_CP1_CI_AS </p><br><p>  A small digression on how to read Collation.  (If you are familiar with it, feel free to skip it.) </p><br><p>  So, there are several parts to Collation: </p><br><ul><li>  SQL - sorting options by SQL Server (SQL at the beginning of Collation) or Windows (then it would be just Latin1_ ...); </li><li>  Latin1_General - locale or language used; </li><li>  CP1 - code page - code page; </li><li>  CI - Case Insensitive - case insensitive; </li><li>  AS - Accent Sensitive - taking into account axons or diacritics, in other words, 'a' is not considered equal to '·∫•'. </li></ul><br><p>  This Collation was once the default Collation when installing SQL Server. </p><br><p>  What options are there? </p><br><ul><li>  _KS - taking into account the Japanese characters of hiragana and katakana, if the option is not selected, then SQL Server will interpret the hieroglyphs of hiragana and katakana as the same. </li><li>  _WS - taking into account the width of characters, if the parameter is not selected, then ‚ÄúText‚Äù and ‚ÄúT ext‚Äù are considered the same lines. </li><li>  _VSS - taking into account the characters for choosing the spelling option in Japanese, appeared from version 2017. </li><li>  _UTF8 - allows you to store data in UTF8. </li></ul><br><p>  All text fields in the database used type NVARCHAR. <br>  It turns out that, since the current Collation ignored the difference in the spelling of Japanese characters and the difference in character widths, SQL Server did not compare strings in the same way as the operating system did, which caused the problem, i.e.  the user could create folders, could not add them to the system for synchronization.  The same thing would happen later when comparing file names. </p><br><p>  We began to think about how to solve this problem and change Collation. </p><br><p>  Collation can be set at several levels: </p><br><ul><li>  SQL Server Instance </li><li>  Database </li><li>  Table </li><li>  Field </li></ul><br><p>  At the same time, it is not recommended to have different Collation inside the database, because each time when comparing rows with different Collation, you will need to do the conversion using COLLATE, indicating to the server which comparison order it should use. </p><br><p>  What options are there in a situation where it is clear that Collation is not selected very well? </p><br><ol><li>  Change Collation at DB level; </li><li>  Change Collation at the field level (in our case there was no point in changing for the entire table); </li><li>  Add the Varbinary field, into which to write a duplicate from the field with the name of the folder, and use it for comparison; </li><li>  Tell users that there are restrictions on the support of characters in directory names. </li></ol><br><p>  The first option - changing Collation at the database level - is the most difficult.  In the case of the database, it would be necessary to recreate the database and reload the data there.  Since the system worked 24/7, this option was rejected immediately. </p><br><p>  The second option about changing the field: the easiest option to implement it is to add a field with the desired Collation and transfer the data there.  But then it will be necessary to change the code in the database that works with this field, and there was a lot of code in the database. </p><br><p>  We liked the third option the most, since in theory it made the least changes, since the main field would continue to exist with the current Collation, and we would not have problems with its conversion, while all the necessary functionality in the form of accounting for the Japanese alphabet or wide characters would work.  The downside is that it was necessary to make changes to the software part, but since this server part, this could be done. </p><br><p>  The fourth option was the simplest in this case, because the total number of users was several million, and only 50 had a problem. However, if the application was actively used in Japan, this solution would be of little use. </p><br><p>  After presenting the data to the management, it was decided to notify users that the software does not support a number of characters, and when used in the name of synchronized files and folders, the software may not work correctly.  This is a temporary solution, because with further distribution, the number of users facing a similar problem will increase, and it will be necessary to change something using the first three options. </p><br><p>  The best option for choosing Collation is based on your application requirements.  If you want SQL Server to compare strings in the same way as the OS, then Collation is definitely incorrect by default.  Unfortunately, such nuances are rarely visible at the start of a project when designing a system, but I hope that after reading the article you will remember the situation described and do not step on such a rake yourself. </p><br><p>  Useful Collation Resources: <br>  <a href="https://docs.microsoft.com/en-us/sql/relational-databases/collations/collation-and-unicode-support%3Fview%3Dsql-server-2017">https://docs.microsoft.com/en-us/sql/relational-databases/collations/collation-and-unicode-support?view=sql-server-2017</a> <br>  <a href="https://www.red-gate.com/simple-talk/sql/sql-development/questions-sql-server-collations-shy-ask/">https://www.red-gate.com/simple-talk/sql/sql-development/questions-sql-server-collations-shy-ask/</a> <br>  <a href="https://www.virtual-dba.com/sql-server-collation/">https://www.virtual-dba.com/sql-server-collation/</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/461231/">https://habr.com/ru/post/461231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461223/index.html">IaaS digest: high performance, data storage and new technologies for data centers</a></li>
<li><a href="../461225/index.html">How to get to the North Pole from the drifting base of Barneo</a></li>
<li><a href="../461227/index.html">Embarcadero RAD Studio 10.3.2 came out or what‚Äôs dead ... died</a></li>
<li><a href="../461229/index.html">Helsinki. How to find a job in the Finnish gaming industry, start working without permission and not violate Russian laws</a></li>
<li><a href="../46123/index.html">I'm testing Google friend connect</a></li>
<li><a href="../461235/index.html">The future of content marketing: trends, tactics and tools</a></li>
<li><a href="../461241/index.html">Wolfram Mathematica in Geophysics</a></li>
<li><a href="../461243/index.html">Do not go to Africa for a walk: how are things going with Internet censorship on the Black Continent</a></li>
<li><a href="../461249/index.html">Writing an Android App for Movie Fans - Part 2 (Design)</a></li>
<li><a href="../461251/index.html">A selection of useful slides from Julia Evans</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>