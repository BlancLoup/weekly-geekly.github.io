<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Anti-rootkit hypervisor: how it works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, our company has been developing a rootkit detector based on hardware virtualization. The project was conceived in order to figure out how to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Anti-rootkit hypervisor: how it works</h1><div class="post__text post__text-html js-mediator-article">  Recently, our company has been developing a rootkit detector based on hardware virtualization.  The project was conceived in order to figure out how to use the new features of Intel and AMD processors for information security.  After several iterations, we stopped at a fully functional method of detecting rootkits.  About him and will be discussed. <br><a name="habracut"></a><br>  The method is based on the technology of hardware memory virtualization (nested paging or hardware assisted paging, there is no generally accepted Russian-language term).  This technology has appeared in the latest models of Intel and AMD processors.  The Intel version is called <a href="http://en.wikipedia.org/wiki/Extended_Page_Table">Intel Extended Page Table</a> (EPT) and is supported by processors starting with the Nehalem family (Intel Core i3, i5, i7).  AMD is called <a href="http://en.wikipedia.org/wiki/Rapid_Virtualization_Indexing">AMD Rapid Virtualization Indexing</a> (RVI) and has been present on processors since the AMD K10 generation.  The technologies are similar, so everything that is described further on Intel EPT is applicable to AMD RVI. <br><br><h4>  Theory </h4><br>  So, we have a hypervisor and a guest operating system (guest) under its control. <br><br><img src="https://habrastorage.org/storage1/a5135b2c/7ef4c5fa/dcb57253/c55308c8.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The transition control from the hypervisor to the guest OS is called VM Entry, the reverse transition is VM Exit.  All work is a sequence of VM Entry and VM Exit, replacing each other.  The hypervisor works in an isolated address space and is ‚Äúinvisible‚Äù by the guest OS.  At the same time, it can change the state of the guest OS (virtual processor, memory, virtual hardware, etc.). <br><br>  It makes sense for the reader to get acquainted with <a href="http://habrahabr.ru/blogs/virus/113519/">our previous article</a> , where it was a question of a method based on a shadow paging table of pages.  The method described here is its further logical development. <br><br>  Hardware memory virtualization, as opposed to software virtualization in shadow paging, dramatically simplifies the hypervisor and, as a result, makes it more reliable.  In addition, performance is greatly increased and memory consumption is reduced. <br><br>  Under normal processor operation, any access to a physical address immediately leads to its setting on the processor‚Äôs address bus (except in such cases as access to APIC, but we omit them for simplicity).  In the case of nested paging, any guest addressing to a physical address (it is called ‚Äúguest physical address‚Äù) is first transmitted through a special page table.  The physical address obtained from the guest physical address is set on the address bus, after which the memory is accessed. <br><br>  The transformation of guest physical addresses for Intel EPT is similar to the usual page conversion: <br><br><img src="https://habrastorage.org/storage1/a6be1df4/24a2c170/17155f3d/2a4fe4c2.png"><br><br>  The page table is four-level and resembles a page table for converting virtual addresses in Intel 64 64-bit mode. The main difference is the structure of the table entries.  The figure shows the entry structure for the lower level of the table (PTE): <br><br><img src="https://habrastorage.org/storage1/2d92eb69/82730f1f/2363ea75/0af2da82.png"><br><br>  We are interested in the three lower bits of records that define access to physical memory.  If the R, W, X bits (bits 0 ... 2) are cleared, then access to the described PTE memory, respectively, for reading, writing and execution causes an output to the hypervisor (EPT Violation in Intel terminology). <br><br>  This makes it possible to control the execution of the code on the processor and writing to the memory with the code. <br><br><h4>  The essence of the method </h4><br>  Full virtualization is not a goal in our case.  To control the execution and modification of the code, we just need to virtualize the memory and the processor. <br><br>  To virtualize the memory, we need to build an EPT page table with the mapping of guest physical addresses to real physical addresses ‚Äúidentity mapping‚Äù.  At the same time, in the records at the lower level of the table (PTE), we reset the W and X bits. Each such record describes access to a 4 KB memory page. <br><br>  Further, there are two possible exits to the hypervisor (VM Exit) with EPT Violation: <br><ol><li>  Access to the memory page to write.  When this occurs, the hypervisor exits, after which it enables writing to the page (sets the W bit), but prohibits execution (clears the X bit). </li><li>  Access to the memory page for execution.  In this case, the hypervisor permits execution on the page (sets X), but prohibits writing to it (resets W). </li></ol><br><img src="https://habrastorage.org/storage1/adaf6248/f19727bf/85376c2c/f0d8169d.png"><br><br>  Thus, a memory page can be either only executable or only recordable.  Recording and execution, respectively, entails going out to the hypervisor (VM Exit) and translating the page from one state to another. <br><br>  By processing these events, the hypervisor can intercept writing to non-paged code, as well as executing outside the limits of system modules.  When each of the events occurs, you can analyze the code that caused it. <br><br><h4>  Practical implementation </h4><br>  We implemented the Hypersight Rootkit Detector rootkit detector using the method described above.  It is designed so that it can be loaded and unloaded at the user's request.  This allows it to be used in conjunction with virtualization programs such as VMware and VirtualBox. <br><br>  Our rootkit detector can detect the following core activity: <br><ul><li>  Attempts to switch to hypervisor mode. </li><li>  Modification of control registers with non-kernel code and HAL. </li><li>  Modifications of non-paged kernel code, HAL and drivers in memory, modifications of SSDT.  Including modification by displaying virtual memory. </li><li>  Executing code outside of the executable sections of the driver, kernel, and HAL.  The so-called ‚Äúhidden code‚Äù, the trump card of rootkits, is now easily detected. </li></ul><br>  The drop in performance when monitoring is on is within one percent and almost imperceptibly "by eye".  Memory consumption by the hypervisor is about 40 MB for a quad-core processor.  This makes it possible to use the method on computers with memory from 1 GB intended for office tasks and development. <br><br><h4>  Further work </h4><br>  The capabilities of the hypervisor are not limited to the detection of rootkits.  It is also possible to block malicious activity.  We are conducting research in this area and we hope to present the results in the near future.  Also on the agenda is porting to the 64-bit architecture and AMD RVI processors. <br><br><h4>  Conclusion </h4><br>  Recently, antivirus companies have paid attention to hypervisors and began to hire their developers.  However, it is worth noting that the development of a hypervisor from scratch is quite a laborious and expensive process, despite its apparent external simplicity.  <a href="http://northsecuritylabs.com/">Our company</a> can offer its experience in this area, as well as a working solution. <br><br><h4>  Literature </h4><br>  Intel Processor Documentation: <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html</a> <br><br>  AMD processor documentation: <a href="http://developer.amd.com/documentation/guides/Pages/default.aspx">developer.amd.com/documentation/guides/Pages/default.aspx</a> <br></div><p>Source: <a href="https://habr.com/ru/post/133906/">https://habr.com/ru/post/133906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133895/index.html">GTV Channel: Steve Jobs Documentary and NEXT. 1986 (Russian translation)</a></li>
<li><a href="../133896/index.html">Kaspersky vs SOPA</a></li>
<li><a href="../133897/index.html">Cross platform is cool</a></li>
<li><a href="../133900/index.html">Symbian Web Runtime: easy mobile application development</a></li>
<li><a href="../133903/index.html">Optimization of code execution speed</a></li>
<li><a href="../133907/index.html">Binary compatibility in the examples and not only</a></li>
<li><a href="../133909/index.html">Upgrade viola jones</a></li>
<li><a href="../133910/index.html">Combat rebuilding cache with RED</a></li>
<li><a href="../133911/index.html">Model-oriented design, or continue taming the Cortex M3 with Matlab / Simulink</a></li>
<li><a href="../133912/index.html">How to make a combined user script for the site?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>