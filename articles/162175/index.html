<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does cellular operator billing work?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The platform processes InitialDP 37 ms; the subscriber listened to beeps for 10 seconds; conversation duration is a little more than 5 minutes. 

 Bil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does cellular operator billing work?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/cc6/0aa/d47/cc60aad47602b26bbb49228f42274296.png"><br>  <sup>The platform processes InitialDP 37 ms;</sup>  <sup>the subscriber listened to beeps for 10 seconds;</sup>  <sup>conversation duration is a little more than 5 minutes.</sup> <br><br>  <b>Billing</b> collects information on the use of telecommunications services, their pricing, is responsible for billing subscribers and processing payments. <br><br>  There are 2 main types of calculation: <ul><li>  <b>Postpay</b> - invoicing for the period following its results (postpaid) </li><li>  <b>And the advance system</b> (prepaid), when the money is deposited in advance. </li></ul><br>  Post-payment appeared historically earlier, but the prepayment turned out to be more convenient for customers (controllable - just something is wrong, there is a shutdown, and not a big bill). <br><a name="habracut"></a><br><h4>  Postpaid system </h4><br>  When the subscriber of the post-roll payment system uses the services of an operator, special CDR (Charging Data Record) files are generated on the switches.  In fact, these are ordinary logs, in which the subscriber number, date, conversation time / volume of downloaded traffic, etc. are indicated.  Billing at a certain time (for example, once a day) connects to the switchboard, downloads CDRs for itself, calculates the cost of services and stores everything in the database (usually Oracle).  Then at the end of the month the subscriber is issued a total bill. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/974/d2e/84f/974d2e84f629bc35cf76ba224921fcd6.png"><br>  <i>The interaction scheme of the Postpaid platform with the core network of the operator.</i> <i><br></i>  <i><b>CSN</b> - circuit switching network;</i>  <i>Presented by channel switches (MSC).</i> <i><br></i>  <i><b>PSN</b> - packet switching network;</i>  <i>Presented by packet switches and gateways (SGSN and GGSN, respectively).</i> <i><br></i> <br>  The principle of operation of the postpaid system is relatively simple, because it does not require a platform response in real time: the subscriber does not need to be warned about reaching zero (and, accordingly, there is no need to change the nature of network interaction with it). <br><br><h4>  Advance system </h4><br>  In the case of an advance billing of the telecom operator, in addition to accounting for the scope of services provided, it is required to solve the task of tracking the subscriber‚Äôs current account and, if it reaches zero, inform the subscriber on / off the service provision.  Therefore, such systems are also called Online Charging System (OCS). <br><br>  Since the operator provides different types of services and different types of networks are used (channel / packet switching system), billing has to use different billing protocols to solve the subscriber invoice monitoring task, for example: <br><br><img src="https://habrastorage.org/storage2/4b8/5aa/99c/4b85aa99c2a63abf1a2f7cc15aa4f5c3.png"><br>  <i>The interaction scheme of the prepaid platform with the operator‚Äôs network.</i> <br><br>  Let us consider these protocols in more detail. <br><br><h4>  Cap </h4><br>  <b>CAP</b> (CAMEL Application Part) is an application layer protocol of the SS7 stack that implements intelligent services in GSM / UMTS networks (for example, prepaid). <br><br><img src="https://habrastorage.org/storage2/661/ad3/e1c/661ad3e1cd55d62dd4f8b822cdd6d188.png"><br>  <i>Place the protocol on the <a href="http://habrahabr.ru/post/101213">SS7</a> stack.</i>  <i>The figure also shows a popular version using SIGTRAN technology (SS7 extension, which allows using the G7 protocols over an IP network).</i> <br><br>  OCS communicates with a circuit switching network using this protocol.  Here is an example of charging for an outgoing voice call: <br><br><img src="https://habrastorage.org/storage2/12c/d4d/0cc/12cd4d0cc75698ef1b7f58fb2b472bf3.png"><br>  <i>Dialogue charging according to CAP protocol, ISUP messages are shown by dashed lines.</i> <br><ol><li>  First, a message (Initial Detection Point) arrives in the billing from the switch MSC1, in which the subscriber's parameters are transmitted.  These are incoming and outgoing numbers, cell address of the called subscriber and others.  Based on this, it is possible to start a call analysis.  Billing creates a certain Detection Point - that is, the state of the call.  OCS determines whether the subscriber can make a voice call (if there are funds in the account), if possible, for what maximum time. </li><li>  After that, the OCS responds to the Request Report BCSM Event switchboard (‚ÄúI initialized the Detection Point, waiting for further information about the call status from you‚Äù).  And sends Apply Charging (‚Äúthe subscriber has funds on the account, I allow the call‚Äù).  The maximum time that the subscriber can use is also sent there. </li><li>  The switch, having received permission from OCS, initializes the voice connection between subscribers via the ISUP protocol, sending an IAM (Initial Address Message) message to the MSC2. </li><li>  MSC2 responds to MSC1 with ACM (Address Complete Message), in this case it means ‚Äúyes, my subscriber, he is now on the network, starting to call him‚Äù.  Having received this message, MSC1 includes long beeps to subscriber A. </li><li>  Subscriber B picks up the phone, MSC2 sends an ANM (Answer Message) to MSC1 - ‚Äúmy subscriber picked up the phone, connect them‚Äù. </li><li>  MSC1 connects subscriber A and B, the conversation begins.  MSC1 sends an Event Report BCSM (O_Answer) message to OCS.  OCS changes the call status for the subscriber.  From this moment the charging begins (taking into account that the first 3 seconds are free). </li><li>  While subscribers are talking, MSC1 keeps track of the time for a call.  If time is short, the MSC alerts the subscriber with a beep. </li><li>  In our case, subscriber B is the first to hang up, MSC1 and MSC2 make a friendly handshake using REL (Release Message) and RLC (Release Complete Message) messages. </li><li>  MSC1 sends Event Report BCSM (O_Disconnect - ‚Äúsubscribers have successfully disconnected‚Äù) and Apply Charging Report to OCS (how many seconds the conversation lasted). </li><li>  OCS accepts this data and responds that it is now possible to close the session. </li></ol><br><br><pre> --- INVOKE ---
  A1 TAG: A1h [1]
  1B LEN: 27
       --- INVOKE ID ---
  02 TAG: 02h INTEGER
  01 LEN: 1
  02 INVOKE ID: 2
        === CAP ===
          --- INVOKE ---
          --- OPERATION ---
  02 TAG: 02h INTEGER
  01 LEN: 1
  23 OPERATION: 35 = applyCharging
        --- APPL CHARG ---
  30 TAG: 30h SEQUENCE
  13 LEN: 19
          --- ACH BCC ---
  80 TAG: 80h [0]
  0C LEN: 12
        --- TDC ---
  A0 TAG: A0h [0]
  0A LEN: 10
          --- MAX CPD ---
  80 TAG: 80h [0]
  03 LEN: 3
  01 19 40 MAX CPD: 4370 </pre><br><br>  This is part of the trace.  We see that the applyCharging message is sent via CAP, the maximum talk time (MAX CPD - Maximum Call Period Duration) is 437.0 seconds. <br><br><img src="https://habrastorage.org/storage2/cc6/0aa/d47/cc60aad47602b26bbb49228f42274296.png"><br>  <i>I duplicate the picture to kata: this is an example of communication using the CAP protocol.</i>  <i>You can estimate the timestamps: the platform handles InitialDP 37 ms;</i>  <i>the subscriber listened to beeps for 10 seconds;</i>  <i>conversation duration is a little more than 5 minutes.</i> <br><br><img src="https://habrastorage.org/storage2/257/5e9/f98/2575e9f980997767d222394b27163746.png"><br>  <i>And here the call is long and you can see how the system itself requests the status of the call (activityTest) from MSC every 6 minutes.</i>  <i>This was done in order that, in the event of any error, the conversation did not last for days (until the subscriber writes all the money).</i> <br><br>  The CAP protocol can charge not only voice calls - it can also charge Internet connections, SMS, MMS and so on.  Although in practice, most often for these needs apply specially sharpened protocols (DIAMETER / OSA). <br><br><h4>  OSA </h4><br>  <b>OSA</b> (Open Service Access) is an open programming interface developed by the 3GPP and ETSI consortium, often used for charging VAS services and the mobile Internet. <br><br>  Consider the operation of this protocol on the example of mobile Internet service pricing: <br><br><img src="https://habrastorage.org/storage2/994/220/b97/994220b97d5daab552faf1def5cf1eb2.png"><br><br><ol><li>  When an attempt is made to activate the PDP Context (the phone receives an IP address in the mobile operator‚Äôs network), the GGSN asks the platform if this subscriber can activate the charging session (CreateChargingSessionReq). </li><li>  In our case, everything is good (the subscriber is in the database, there are funds), the platform creates a billing session and allows you to activate the <abbr title="PDP Context - a set of data about the subscriber who performed the GPRS Attach procedure, which is stored both on the SGSN side and on the side of the subscriber terminal, in particular, this data set includes a profile that provides a certain level of subscriber quality of service - QoS, address assigned the subscriber in the network, the capabilities of the terminal of the subscriber, data on the tariffing of the subscriber, etc.">PDP Context</abbr> (CreateChargingSessionResp). </li><li>  Now the subscriber wants to start downloading data.  To allow him to do this, GGSN requests the platform to reserve funds (ReserveUnitReq).  In general, a unit is an abstract thing, it can be anything - a kilobyte of data, text messages, a second conversation, a ruble, pizza, a barrel, and so on.  In our case, the unit is 100 KB. </li><li> The platform checks whether there are funds for 100 kB of traffic for this subscriber, in accordance with its tariff, and responds with a ReserveUnitResp message (‚Äúfunds are reserved‚Äù).  By accepting this message from the platform, the GGSN allows the subscriber to download traffic. </li><li>  When the subscriber downloaded the reserved portion of traffic, GGSN accesses the platform with the message DebitUnitReq (‚Äúyou can write off reserved funds‚Äù). </li><li>  The platform debits funds and responds with a DebitUnitResp message (‚Äúfunds successfully withdrawn‚Äù). </li><li>  The ReserveUnitReq-DebitUnitResp cycle is repeated until the subscriber <s>downloads the entire Internet and</s> closes the Internet session. </li><li>  When the PDP Context is deactivated, the GGSN sends a message on the completion of the billing session to the platform;  the memory allocated for this session is released. </li></ol><br><br><img src="https://habrastorage.org/storage2/830/165/0c4/8301650c4ce712e9ef5081ed67f33da4.png"><br>  <i>Request debitUnitReq;</i>  <i>OSA commands are wrapped in a SOAP protocol, which in turn is encapsulated by the HTTP protocol.</i> <br><br><h4>  Conclusion </h4><br>  Changes in customer needs (including an increase in the amount of transmitted data), the creation of new types of services, entails the evolution of the mobile operator's network, primarily in the field of <abbr title="Value Added Services - services provided not by the network core, but by additional platforms">VAS platforms</abbr> and billing systems. <br><br>  If the subject of the <abbr title="Authentication, Authorization, Accounting - authentication, authorization, accounting">AAA</abbr> family of protocols is interesting to you, then I will tell you later about RADIUS, DIAMETER and other interesting things. <br><br><h4>  Links </h4><br>  3GPP: <a href="http://www.3gpp.org/index.php">www.3gpp.org/index.php</a> <br>  ETSI: <a href="http://www.etsi.org/">www.etsi.org</a> <br>  OSA: <a href="http://www.3gpp.org/ftp/Specs/html-info/29198-01.htm">www.3gpp.org/ftp/Specs/html-info/29198-01.htm</a> <br>  ISUP: <a href="http://www.asknumbers.com/SS7ISUPMessages.aspx">www.asknumbers.com/SS7ISUPMessages.aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/162175/">https://habr.com/ru/post/162175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162161/index.html">Free book ‚ÄúHTML5. Developer's Guide ¬ª</a></li>
<li><a href="../162163/index.html">OSPF Area Types</a></li>
<li><a href="../162169/index.html">AWS Insight: RDS Parameter Groups - what it is and why</a></li>
<li><a href="../162171/index.html">Cross-compiling and debugging C ++ Windows applications for Linux</a></li>
<li><a href="../162173/index.html">Christmas sales Samurai-s!</a></li>
<li><a href="../162177/index.html">Megaphone launched the UMS service (Unified Messaging Solution), and the beta version of the client on Google Play. New competitor Whatsapp, Joyn, and IMO.IM?</a></li>
<li><a href="../162179/index.html">A billion-dollar high-tech software company is created in the USA every 3 months.</a></li>
<li><a href="../162181/index.html">Monitoring messages and calls to Android</a></li>
<li><a href="../162183/index.html">New Samsung NX lenses are on sale</a></li>
<li><a href="../162185/index.html">Library for working with QIWI through SOAP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>