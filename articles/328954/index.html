<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a Web API application using. NET Core + MongoDB. NET Driver</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you already know, MongoDB is one of the most developed, open-source NoSQL solutions, which is a document-oriented database, is cross-platform, and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a Web API application using. NET Core + MongoDB. NET Driver</h1><div class="post__text post__text-html js-mediator-article">  As you already know, MongoDB is one of the most developed, open-source NoSQL solutions, which is a document-oriented database, is cross-platform, and also provides high performance, availability and ease of scaling. <br><br>  In modern open-source web applications, the use of NoSQL solutions has gained popularity due to their non-relational behavior.  In this article, step by step, we will implement a simple ASP.NET Core Web API ‚Äúnotebook‚Äù application that will support CRUD operations applicable to the collection in MongoDB. <a name="habracut"></a><br><br><h2>  Why MongoDB </h2><br>  The choice of DBMS depends primarily on which application you want to create.  Those.  The DB is chosen not by the developers, but by the product itself.  MongoDB is an excellent choice for working with documents.  A striking example of such an application would be a blog or social network, where each author can create entries, add images, videos and music to them.  Other users can comment on these entries, as well as evaluate them using, for example, like or star ratings.  But how will you store this data?  If you are familiar with relational DBMS, you can imagine what a similar scheme will look like: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/web/90f/d7d/e53/90fd7de53a3f43889d2d972cc54e4fa5.png" alt="image"></div><br>  Let's imagine the structure of a separate record, as well as the way it is displayed.  In order to get a record and its associated data (images, audio, video, comments, ratings, user information, etc.), we need to perform a query on about eight table joints.  Now imagine what stream of records (dynamically loaded and transmitted to thousands of clients) to process, and you will understand that thousands of queries to a large number of table joints are needed to accomplish this task.  Of course, we can use a relational database, such as SQL Server, for storing data.  SQL supports <a href="https://msdn.microsoft.com/library/dn921897.aspx">dynamic JSON data</a> .  But there is an option that simplifies the approach in this particular scenario - this is the NoSQL database.  When you use one document, as shown below, storing it in MongoDB, you can improve the performance of your application and get the entire record with a single query without joining tables.  This is a simpler and more efficient way. <br><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-string"><span class="hljs-string">"ew12-res2-234e-544f"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"post title"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-01-01"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>:<span class="hljs-string"><span class="hljs-string">"this is an awesome post stored on NoSQL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"createdBy"</span></span>:<span class="hljs-string"><span class="hljs-string">"User"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"images"</span></span>:[<span class="hljs-string"><span class="hljs-string">"http://example.com/myfirstimage.png"</span></span>,<span class="hljs-string"><span class="hljs-string">"http://example.com/mysecondimage.png"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"videos"</span></span>:[ {<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://example.com/myfirstvideo.mp4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"The first video"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://example.com/mysecondvideo.mp4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"The second video"</span></span>} ], <span class="hljs-attr"><span class="hljs-attr">"audios"</span></span>:[ {<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://example.com/myfirstaudio.mp3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"The first audio"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"url"</span></span>:<span class="hljs-string"><span class="hljs-string">"http://example.com/mysecondaudio.mp3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"The second audio"</span></span>} ] }</code> </pre> <br>  In addition, the use of MongoDB allows developers to reduce consistency by creating applications with high availability and low latency. <br><br>  Please note that it is not entirely correct to call MongoDB a replacement for relational databases, this is rather an alternative.  This tool can do the same thing that many others can do - something is better, but something is not. <br><br>  The structureless collection architecture in MongoDB does not oblige developers to define and maintain schemas at the data level, providing fast iteration when developing a product.  Do you need to save the object?  Serialize it into BSON and send it to MongoDB.  There is no mapping of properties or types. <br><br>  This simplicity can definitely suit you as the ultimate developer. <br><br>  Prior to version 1.8, MongoDB was considered unreliable in terms of storage, but this version added a journaling mechanism, which is already enabled by default, but it can be disabled in the configuration file.  Despite a slight increase in performance, with the journaling mechanism disabled, there is a certain risk of data loss. <br><br><h2>  Technology stack </h2><br>  MongoDB uses BSON (Binary JavaScript Object Notation) documents and database schema for storing data, which is a superset of the JSON format, including optional regular expressions, binary data and dates.  The schema in MongoDB is called a <b>collection</b> , and the entry in this schema is called a <b>document</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/a71/140/df5/a71140df51234ac9a89bcc9420f07981.png" alt="image"></div><br>  ASP.NET Core Web API has a great advantage because it can be used as an HTTP service and can be used by any client application, starting from desktop computers, ending with mobile phones, and can also be installed on Windows, MacOS and Linux. <br><br>  <b>Note</b> : Currently, MongoDB is not supported in EF Core.  There is little chance that the upcoming EF Core versions will support MongoDB (based on <a href="https://blogs.msdn.microsoft.com/dotnet/2016/06/27/entity-framework-core-1-0-0-available/">comments from</a> Rowan Miller), but this functionality can be implemented in the future. <br><br>  Below are all the necessary components to work: <br><br><ul><li>  <a href="https://www.visualstudio.com/ru/free-developer-offers/">Visual Studio Community 2017</a> , including .NET Core </li><li>  <a href="https://www.mongodb.com/download-center">MongoDB</a> , version 3.4 </li><li>  <a href="https://robomongo.org/">Robomongo</a> - MongoDB native control </li><li>  <a href="https://www.getpostman.com/">Postman</a> - Web API Testing Tool </li></ul><br><h2>  MongoDB configuration </h2><br>  After we installed <a href="https://www.mongodb.com/download-center">MongoDB</a> , we need to configure access to the database, and also specify where the data is located.  To do this, create the file <b>mongod.cfg</b> .  This file will contain the path to the folder with the MongoDB server data, as well as the MongoDB log file, initially without any authentication. <br><br><pre> <code class="hljs tex">systemLog: destination: file path: "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>data<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>db<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>log<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>mongo.log" logAppend: true storage: dbPath: "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>data<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>db"</code> </pre> <br>  <b>Note:</b> by default, MongoDB tries to initialize the database directory at the address <code>"C:\\data\\db"</code> and gives an error if it cannot determine this address. <br><br>  Then we run the following command on the command line (it is necessary to update the addresses according to the location of the configuration file and the location of the folder where MongoDB is installed). <br> <code>"C:\Program Files\MongoDB\Server\3.4\bin\mongod.exe" --config C:\Dev\mongod.cfg</code> <br>  This command will launch the MongoDB server, pointing to the configuration file already created. <br><br>  <b>Note:</b> Specifying the absolute path to a binary file is not a very good tone.  For intensive use of this address, it is proposed to add the path to the directory to the PATH system variable. <br><br>  After the server is started (you can see the details in the log file), run the <b>mongo.exe</b> client from the command line: <br><br><img src="https://habrastorage.org/web/175/ef6/e48/175ef6e482674e82a24d67ca080827b8.png" alt="image"><br>  <b>Note: the</b> client may issue a warning that access control is not configured (we will fix it later): <br><br><img src="https://habrastorage.org/web/155/f84/9aa/155f849aafd64c058dd0251b16193c2d.png" alt="image"><br><br>  Create an administrator account by running the following commands in the console client: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> db.createUser( { <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, pwd: <span class="hljs-string"><span class="hljs-string">"abc123!"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: [ { <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, db: <span class="hljs-string"><span class="hljs-string">"admin"</span></span> } ] } ); exit;</code> </pre><br>  Then we stop the server and update the mongod.cfg configuration file, including the security setting: <br><br><pre> <code class="hljs pgsql">systemLog: destination: file <span class="hljs-type"><span class="hljs-type">path</span></span>: "C:\\data\\db\\log\\mongo.log" logAppend: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: dbPath: "C:\\data\\db" <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span>: enabled</code> </pre> <br>  From now on, we connect to MongoDB using the <i>admin</i> user. <br><br>  <b>Note</b> : It is recommended not to use the superuser role (in our case, the administrator) for normal operations, but in order to keep it simple, we will still use only one user. <br><br><h2>  Creating an ASP.NET Web API Project </h2><br>  The finished implementation can be downloaded from <a href="https://github.com/artholy/WebApiMongoDB/">GitHub</a> . <br><br>  Launch Visual Studio, File ‚Üí New Project ‚Üí .Net Core ‚Üí ASP.NET Core Web Application. <br><br><img src="https://habrastorage.org/web/f25/628/97b/f2562897b7e04855a8fddd5d2a41c2eb.png" alt="image"><br><br>  Then select the Web API template, OK. <br><br><img src="https://habrastorage.org/web/e69/aff/5b2/e69aff5b21d84d098532c936a312d97a.png" alt="image"><br><br><h3>  Project configuration </h3><br>  There are several supported configuration file formats (JSON, XML or ini), and by default the Web API project template is deployed with a JSON format file.  Update the file AppSettings.json, adding to it information about connecting to the database. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"Logging"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"IncludeScopes"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"LogLevel"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Default"</span></span>: <span class="hljs-string"><span class="hljs-string">"Debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Microsoft"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"System"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"MongoConnection"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ConnectionString"</span></span>: <span class="hljs-string"><span class="hljs-string">"mongodb://admin:abc123!@localhost"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Database"</span></span>: <span class="hljs-string"><span class="hljs-string">"NotesDb"</span></span> } }</code> </pre> <br><h3>  Dependency injection and parameter model </h3><br>  Implementing a constructor (Constructor Injection) is one of the most common approaches to implementing dependency (Dependency Injection).  ASP.NET Core uses the constructor implementation in its solution, so we will also use it.  To dump the database connection parameters, we will add a new class of settings. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NotebookAppApi.Model</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Settings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Database; } }</code> </pre> <br>  We modify the ConfigureSettings method in the Startup.cs file to add our settings to the access model to the parameters.  In the future, we will use the IOptions interface to access the settings. <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> ConfigureServices(IServiceCollection services) { // <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> framework services. services.AddMvc(); services.Configure&lt;Settings&gt;(<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.ConnectionString = <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>.GetSection("MongoConnection:ConnectionString").<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>.GetSection("MongoConnection:Database").<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; }); }</code> </pre> <br><h3>  MongoDB .NET Driver </h3><br>  In order to connect to MongoDB, let's add a package called MongoDB.Driver to the Nuget project.  This is the official .NET driver with full support for ASP.NET Core applications. <br><br><img src="https://habrastorage.org/web/5a5/150/546/5a51505465214868a24b480ee972db16.png" alt="image"><br><br><h3>  Model </h3><br>  The class model (POCO) that describes each note in our address book is shown below. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> MongoDB.Bson.Serialization.Attributes; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NotebookAppApi.Model</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Note</span></span> { [BsonId] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Body { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime UpdatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = DateTime.Now; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime CreatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = DateTime.Now; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br><h3>  Database context </h3><br>  Implement the Unit of Work pattern in the NoteContext class: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NoteContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IMongoDatabase _database = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NoteContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IOptions settings</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MongoClient(settings.Value.ConnectionString); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) _database = client.GetDatabase(settings.Value.Database); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IMongoCollection Notes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _database.GetCollection(<span class="hljs-string"><span class="hljs-string">"Note"</span></span>); } } }</code> </pre><br><h3>  Repository </h3><br>  Using the repository interface, we implement the functionality necessary to manage our notes.  They will also use dependency injection (DI) for easy access to the application (for example, a controller partition). <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">INoteRepository</span></span> { Task&lt;IEnumerable&lt;Note&gt;&gt; GetAllNotes(); <span class="hljs-function"><span class="hljs-function">Task&lt;Note&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Note item</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">Task&lt;DeleteResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   (body)  Task&lt;UpdateResult&gt; UpdateNote(string id, string body); }</span></span></code> </pre><br>  Access to the database will be asynchronous.  We use a driver not lower than version 2.0, in which the full asynchronous stack was added.  As an example: to get all the notes, we make an asynchronous request: <br><br><pre> <code class="hljs javascript">public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IEnumerable&lt;Note&gt;&gt; GetAllNotes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.Find(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToListAsync(); }</code> </pre> <br>  Below is the complete implementation for basic CRUD operations: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">NotebookAppApi.Data</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NoteRepository</span></span> : <span class="hljs-title"><span class="hljs-title">INoteRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> NoteContext _context = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NoteRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IOptions&lt;Settings&gt; settings</span></span></span><span class="hljs-function">)</span></span> { _context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NoteContext(settings); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IEnumerable&lt;Note&gt;&gt; GetAllNotes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.Find(_ =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToListAsync(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;Note&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter = Builders&lt;Note&gt;.Filter.Eq(<span class="hljs-string"><span class="hljs-string">"Id"</span></span>, id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes .Find(filter) .FirstOrDefaultAsync(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Note item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.InsertOneAsync(item); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;DeleteResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.DeleteOneAsync( Builders&lt;Note&gt;.Filter.Eq(<span class="hljs-string"><span class="hljs-string">"Id"</span></span>, id)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;UpdateResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> body</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter = Builders&lt;Note&gt;.Filter.Eq(s =&gt; s.Id, id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> update = Builders&lt;Note&gt;.Update .Set(s =&gt; s.Body, body) .CurrentDate(s =&gt; s.UpdatedOn); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.UpdateOneAsync(filter, update); } } }</code> </pre> <br>  To access the NoteRepository using the DI model, add a line to the ConfigureServices: <br><br><pre> <code class="hljs xml">services.AddTransient<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">INoteRepository,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NoteRepository</span></span></span><span class="hljs-tag">&gt;</span></span>();</code> </pre> <br>  Where: <br><ul><li>  AddTransient means that the repository is recreated every time. </li><li>  AddScoped - only once per request. </li><li>  AddSingleton - once at the first request.  Each subsequent request uses an instance that was created for the first time. </li></ul><br><h3>  Main controller </h3><br>  Below is the code of the main controller of our Web API application, where all CRUD methods that are available to third-party applications are implemented. <br><br>  <b>Note</b> : the Get method is marked with the NoCache attribute to ensure that web clients always make a request to the server. <br><br><pre> <code class="hljs pgsql">namespace NotebookAppApi.Controllers { [Produces("application/json")] [Route("api/[controller]")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NotesController : Controller { private readonly INoteRepository _noteRepository; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> NotesController(INoteRepository noteRepository) { _noteRepository = noteRepository; } [NoCache] [HttpGet] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task&lt;IEnumerable&lt;Note&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetNoteInternal(); } private async Task&lt;IEnumerable&lt;Note&gt;&gt; GetNoteInternal() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await _noteRepository.GetAllNotes(); } // <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> api/notes/<span class="hljs-number"><span class="hljs-number">5</span></span> [HttpGet("{id}")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Task&lt;Note&gt; <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string id) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetNoteByIdInternal(id); } private async Task&lt;Note&gt; GetNoteByIdInternal(string id) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await _noteRepository.GetNote(id) ?? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note(); } // POST api/notes [HttpPost] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Post([FromBody]string <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { _noteRepository.AddNote(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note() { Body = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, CreatedOn = DateTime.Now, UpdatedOn = DateTime.Now }); } // PUT api/notes/<span class="hljs-number"><span class="hljs-number">5</span></span> [HttpPut("{id}")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Put(string id, [FromBody]string <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { _noteRepository.UpdateNoteDocument(id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } // <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> api/notes/<span class="hljs-number"><span class="hljs-number">23243423</span></span> [HttpDelete("{id}")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span>(string id) { _noteRepository.RemoveNote(id); } } }</code> </pre><br><h3>  Data initialization </h3><br>  In this part, we implement a controller designed to perform administrative tasks solely for the purpose of demonstration (we use it to initialize the database with some dummy data). <br><br>  We implement one Init method, which will create and fill the database with all the necessary test data.  The method will be available at <a href="http://localhost:5000/api/system/init">http: // localhost: 5000 / api / system / init</a> or <a href="http://localhost:53617/api/system/init">http: // localhost: 53617 / api / system / init</a> (in case we use IIS).  In practice, such a controller could evolve into a full "admin". <br><br><pre> <code class="hljs pgsql">[Route("api/[controller]")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SystemController : Controller { private readonly INoteRepository _noteRepository; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> SystemController(INoteRepository noteRepository) { _noteRepository = noteRepository; } // <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> an initialization - api/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/init [HttpGet("{setting}")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>(string setting) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setting == "init") { _noteRepository.RemoveAllNotes(); _noteRepository.AddNote(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note() { Id = "1", Body = "Test note 1", CreatedOn = DateTime.Now, UpdatedOn = DateTime.Now, UserId = <span class="hljs-number"><span class="hljs-number">1</span></span> }); _noteRepository.AddNote(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note() { Id = "2", Body = "Test note 2", CreatedOn = DateTime.Now, UpdatedOn = DateTime.Now, UserId = <span class="hljs-number"><span class="hljs-number">1</span></span> }); _noteRepository.AddNote(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note() { Id = "3", Body = "Test note 3", CreatedOn = DateTime.Now, UpdatedOn = DateTime.Now, UserId = <span class="hljs-number"><span class="hljs-number">2</span></span> }); _noteRepository.AddNote(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Note() { Id = "4", Body = "Test note 4", CreatedOn = DateTime.Now, UpdatedOn = DateTime.Now, UserId = <span class="hljs-number"><span class="hljs-number">2</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "Done"; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "Unknown"; } }</code> </pre><br><h3>  Launch settings </h3><br>  In order to display the results of queries to the server when the project is launched, we will update the file LaunchSettings.json <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/dda/e4b/04d/ddae4b04d26345bfaa0c2214932db876.png" alt="image"></div><br>  The following is an example of a setting in which the default URL is run with all notes displayed (api / notes). <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:53617/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"profiles"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"IIS Express"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"commandName"</span></span>: <span class="hljs-string"><span class="hljs-string">"IISExpress"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"launchBrowser"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"launchUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"api/notes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"environmentVariables"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ASPNETCORE_ENVIRONMENT"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"NotebookAppApi"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"commandName"</span></span>: <span class="hljs-string"><span class="hljs-string">"Project"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"launchBrowser"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"launchUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:5000/api/notes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"environmentVariables"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"ASPNETCORE_ENVIRONMENT"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } } } }</code> </pre> <br><h3>  Launch of the project </h3><br>  Before starting the project, make sure that MongoDB is running (as a Windows service, or from the command line, as was done above). <br><br>  When you first start the application, we will be redirected to the page with all the records, but since  we have not yet started the initialization process, this page will display an empty set. <br><br><img src="https://habrastorage.org/web/97a/f6f/323/97af6f3230cc4aacb976d6733fdfc059.png" alt="image"><br><br>  Run the command to initialize the database and fill it with test data by going to the <a href="http://localhost:53617/api/system/init">address</a> . <br><br><img src="https://habrastorage.org/web/778/06e/51b/77806e51b55f4c83a2ccd8c83ad03a2a.png" alt="image"><br><br>  Then, go back to the application's start page and see that the data has appeared: <br><br><img src="https://habrastorage.org/web/6ad/475/83c/6ad47583cc85470285ae89015c37347e.png" alt="image"><br><br><h3>  Using Robomongo </h3><br>  Using Robomongo, you can check for database entries.  Having connected to the database using credentials, we can see all 4 records. <br><br><img src="https://habrastorage.org/web/27e/69d/876/27e69d8769a54103b65260c902c85cfd.png" alt="image"><br><br><h2>  Exception Handling </h2><br>  In C # 5.0, the async and await keywords were introduced that simplify the use of the TPL (Task Parallel Library).  We can simply use a try / catch block to catch exceptions. Public async Task &lt;IEnumerable&gt; GetAllNotes () <br><br><pre> <code class="hljs javascript">{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes.Find(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToListAsync(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-comment"><span class="hljs-comment">// log or manage the exception throw; } }</span></span></code> </pre> <br>  So we can handle errors in asynchronous Task instances, and you can throw an exception above for further processing. <br><br><h2>  Full MongoDB document update </h2><br>  Initially, in the sample project, the update function worked on the principle of selective property update. <br><br>  Using the ReplaceOneAsync method, we can update the document completely.  The IsUpsert parameter indicates that if there is no document in the database, it must be created. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ReplaceOneResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateNote</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, Note item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Notes .ReplaceOneAsync(n =&gt; n.Id.Equals(id) , item , <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UpdateOptions { IsUpsert = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); }</code> </pre> <br><h2>  Setting cross-domain queries (CORS) </h2><br>  To work with applications running on different domains, our solution on the ASP.NET Web API needs to allow the processing of cross-domain requests (CORS).  For example, <a href="https://angular.io/">Angular 2,</a> before the main request, first performs a pre-check request, which checks whether cross-domain requests are allowed.  First, let's register the CORS functionality in the Startup.cs file's ConfigureServices method: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Add service and create Policy with options services.AddCors(options =&gt; { options.AddPolicy("CorsPolicy", builder =&gt; builder.AllowAnyOrigin() .AllowAnyMethod() .AllowAnyHeader() .AllowCredentials()); }); // .... services.AddMvc(); }</span></span></code> </pre> <br>  Then enable the policy globally for each request in the application, by calling the app.useCors method in the Configure method: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseCors(<span class="hljs-string"><span class="hljs-string">"CorsPolicy"</span></span>); app.UseMvc(); }</code> </pre> <br><h2>  Work with files </h2><br>  A MongoDB document can also store binary files, but the maximum document size in MongoDB 2.x is 16 MB (in earlier versions, only 4 MB).  Therefore, to store large amounts of information, in particular large files, MongoDB uses the GridFS system.  GridFS is an arbitrary file storage agreement in MongoDB, supported by all official drivers.  Files in the database are stored in two collections, commonly called ‚Äúfs.files‚Äù and ‚Äúfs.chunks‚Äù.  Each downloaded file has one document in the ‚Äúfs.files‚Äù collection, containing information about the file and many document pieces (chunks) in the ‚Äúfs.chunks‚Äù collection, which stores the contents of the file in parts. <br><br>  First we need to add GridFS components for the driver via NuGet. <br><br><img src="https://habrastorage.org/web/01c/a26/50b/01ca2650b08d422eae482ee62f264a60.png" alt="image"><br><br>  Then we need to add an object of class <b>GridFSBucket</b> to our context.  <b>GridFSBucket</b> is a key object for working with GridFS, which is a kind of combination of the fs.files and fs.chunks collections and is a ‚Äúbucket‚Äù (Bucket) in which all our files can be stored. <br><br><pre> <code class="hljs pgsql">_database = client.GetDatabase(settings.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>); _bucket = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GridFSBucket(_database);</code> </pre> <br>  You can also specify additional parameters.  For example, the name of the collection (instead of the prefix ‚Äúfs‚Äù will be your name) and the size of one chunk. <br><br><pre> <code class="hljs pgsql"> _database = client.GetDatabase(settings.<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>); var gridFSBucketOptions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GridFSBucketOptions() { BucketName = "images", ChunkSizeBytes = <span class="hljs-number"><span class="hljs-number">1048576</span></span>, // <span class="hljs-number"><span class="hljs-number">1</span></span> }; _bucket = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GridFSBucket(_database, gridFSBucketOptions);</code> </pre> <br>  And add the ability to use our <b>GridFSBucket</b> instance: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GridFSBucket Bucket { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _bucket; } }</code> </pre> <br>  Or you can use a shorter entry: <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GridFSBucket Bucket =&gt; _bucket;</code> </pre> <br>  Now we will update our functionality.  Add a method to add a file to the database in NoteRepository.cs <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ObjectId&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UploadFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IFormFile file</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = file.OpenReadStream(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filename = file.FileName; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Bucket.UploadFromStreamAsync(filename, stream); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectId(ex.ToString()); } }</code> </pre> <br>  <b>Note: You</b> should always use the GridFSBucket object to interact with the GridFS collections ("fs.chunks" and "fs.files") instead of directly accessing these collections. <br><br>  Add a method signature to INoteRepository.cs: <br><br><pre> <code class="hljs lisp">Task&lt;ObjectId&gt; UploadFile(<span class="hljs-name"><span class="hljs-name">IFormFile</span></span> file)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  Update NotesController.cs to add the POST method itself: <br><br><pre> <code class="hljs cmake">// POST api/notes/uploadFile [HttpPost(<span class="hljs-string"><span class="hljs-string">"uploadFile"</span></span>)] public async Task&lt;ObjectId&gt; UploadFile(IFormFile <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> await _noteRepository.UploadFile(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>); }</code> </pre> <br>  <b>Note:</b> For correct processing of data transmitted with the header Content-Type: multipart / form-data (so we will transfer files) you need to add support for this type of data.  To do this, we add the corresponding Consumes attribute for the NotesController controller class: <br><br><pre> <code class="hljs kotlin">[Consumes(<span class="hljs-string"><span class="hljs-string">"application/json"</span></span>, <span class="hljs-string"><span class="hljs-string">"multipart/form-data"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotesController</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Controller</span></span></span></span></code> </pre> <br>  Obtaining information about the file, we consider the example of a simple method, which by file Id will return its name: <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFileInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { GridFSFileInfo info = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectId = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectId(id); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _context.Bucket.OpenDownloadStreamAsync(objectId)) { info = stream.FileInfo; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.Filename; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Not Found"</span></span>; } }</code> </pre> <br><h2>  Check our API </h2><br>  To test the Web API will use <a href="https://www.getpostman.com/">Postman</a> .  For example, check the receipt of the record by Id (api / notes / 2) Select the type of GET request, then enter the URL (http: // localhost: 53617 / api / notes / 2) and add a header (Content-Type: application / json).  After sending the request, we get a response in the form of information about the record with Id = 2. <br><img src="https://habrastorage.org/web/b18/d60/bce/b18d60bce48545838afa99feac7f2cb9.png" alt="image"><br><br>  Change the contents of this record.  To do this, change the type of the request to PUT, then go to the Body&gt; Raw tab and set the new content of the record. <br><img src="https://habrastorage.org/web/a68/5ae/620/a685ae6207c3454090e7061408a4783f.png" alt="image"><br><br>  After that, go to RoboMongo and make sure that the value of the record is updated. <br><br><img src="https://habrastorage.org/web/8c3/f53/b7a/8c3f53b7a808459cb3d7ca8900d9ba62.png" alt="image"><br><br>  Check the operation of the GridFS mechanism.  To do this, change the Content-Type to multipart / form-data, set the URL as <a href="http://localhost/">localhost</a> : 53617 / api / notes / uploadFile and in the Body&gt; form-data section add and send the file.  In response, we received information about this file: <br><img src="https://habrastorage.org/web/6f2/c4c/f75/6f2c4cf756624dd780d0212baefa5ecf.png" alt="image"><br><br>  After that, the corresponding entries were created for this file in the collections ‚Äúimages.files‚Äù and ‚Äúimages.chunks‚Äù. <br><br><img src="https://habrastorage.org/web/196/610/617/196610617dec4c06a65fa27391ebc191.png" alt="image"><br><br>  Let's check our simple method of getting the file name by its ID.  To do this, we make an ordinary GET request with the transfer of the file ID in the address bar. <br><br><img src="https://habrastorage.org/web/082/6d6/127/0826d612709a43489f2265097d30c3e8.png" alt="image"><br><br><h2>  Conclusion </h2><br>  The fact that the MongoDB team pays enough attention to the convenience and usefulness of the developers, conducting <a href="https://university.mongodb.com/">training courses</a> , <a href="https://university.mongodb.com/">taking an</a> active interest in <a href="https://www.mongodb.com/presentations/">community</a> opinion and promptly solving emerging <a href="https://jira.mongodb.org/secure/Dashboard.jspa">problems</a> (the project is written not only by volunteers, but also by a company of full-time people), makes it possible to say that MongoDB and will continue to maintain an excellent rate of introduction of new opportunities and improve. <br><br>  And the fact that MongoDB can be deployed not only on Windows, together with a sufficient driver maturity and Microsoft‚Äôs course on .NET Core support on Linux and MacOS, is a tangible advantage, for example, if you want to deploy your solution completely on Linux.  However, not to mention the <a href="https://www.microsoft.com/ru-ru/sql-server/sql-server-vnext-including-linux">open testing of</a> SQL Server 2017, this solution can also be deployed on Linux.  And the choice of the approach that you need to use when developing a project: NoSQL or RDBMS - depends mainly on the specifics of your application.  MongoDB is ideal where all data manipulation scenarios fit in and will fit in the future with key samples and receiving the entire collection.  If there is no such confidence, then it is better to take RDBMS immediately. <br><br>  <b>Sources:</b> <br><br><ol><li>  <a href="http://www.qappdesign.com/using-mongodb-with-net-core-webapi/">http://www.qappdesign.com/using-mongodb-with-net-core-webapi/</a> </li><li>  <a href="http://jsman.ru/mongo-book/Vvedenie.html">http://jsman.ru/mongo-book/Vvedenie.html</a> </li><li>  <a href="http://mongodb.github.io/mongo-csharp-driver/2.4/reference/">http://mongodb.github.io/mongo-csharp-driver/2.4/reference/</a> </li><li>  <a href="https://docs.microsoft.com/ru-ru/azure/documentdb/documentdb-nosql-vs-sql">https://docs.microsoft.com/ru-ru/azure/documentdb/documentdb-nosql-vs-sql</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/328954/">https://habr.com/ru/post/328954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328938/index.html">GitLab PostgreSQL postmortem</a></li>
<li><a href="../328940/index.html">Neuroculture part 2: about the bot that posts photos</a></li>
<li><a href="../328942/index.html">Ruby on Rails agreement. Part 2</a></li>
<li><a href="../328946/index.html">Kotlin is the official development language for Android. We understand the intricacies of the language on Stepik</a></li>
<li><a href="../328952/index.html">Implementing drag & drop functionality in an iOS application</a></li>
<li><a href="../328956/index.html">Register for the webinar "From WannaCry to WannaSaveU". Attack visibility and recovery</a></li>
<li><a href="../328958/index.html">Network microsegmentation in examples: how this cleverly twisted thing reacts to different attacks</a></li>
<li><a href="../328960/index.html">Ionic 2 vs React Native: a comparison of frameworks for creating corporate mobile applications</a></li>
<li><a href="../328962/index.html">Android and architecture</a></li>
<li><a href="../328964/index.html">Analysis of errors in the seller</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>