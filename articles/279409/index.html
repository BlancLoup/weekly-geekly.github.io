<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsers to all! Analyzing and testing existing HTML parsers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 After the publication of the previous article, not a few letters arrived to the post with a request to show and prove how one solution is be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsers to all! Analyzing and testing existing HTML parsers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/745/c9a/91a/745c9a91a0e94cb58424eb5e39564bba.png"><br><br>  Hello! <br><br>  After the publication of the <a href="https://habrahabr.ru/post/277031/">previous article,</a> not a few letters arrived to the post with a request to show and prove how one solution is better than another. <br>  I enthusiastically began to compare, but everything, as usual, is a little more complicated than it seems at first glance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Yes, in this article I propose to put all the parsers on the table and measure! <br><br><a name="habracut"></a>  <b>Let's get started!</b> <br><br>  Before comparing something, we need to understand: what do we really want to compare ?!  And we want to compare html parsers, but what is html parser? <br><br>  Html parser is: <br><ol><li>  Tokenizer (Tokenizer) - breakdown of text into tokens </li><li>  Building a Tree (Tree Builder) - placing tokens "in the right position" in the tree </li><li>  Further work with wood </li></ol><br>  A person "from the cold" can say: - "It is not necessary to build a tree for parsing html, it is enough to get tokens".  And unfortunately, will be wrong. <br>  The fact is that for proper tokenization of html we need to have a tree at hand.  Point 1 and 2 are inseparable. <br><br>  I will give two examples: <br><br>  The first: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">desc</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">math</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  The result of the correct processing: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg:svg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">desc:svg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">math:math</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style:math</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a:math</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Second: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">desc</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  The result of the correct processing: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">svg:svg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">desc:svg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">-text</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">: </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  After the ":" is the namespace, if not specified then html. <br><br>  From the two examples it is clear that the STYLE element behaves differently depending on where it is located.  In the first variant, there is an element A, and in the second, this is already a text element. <br>  Here you can give an example with frameset, script, title ... and their different behavior, but I think the general meaning is clear. <br><br>  Now, we can definitely conclude that the token splitting cannot be correctly implemented without building the html tree.  Consequently, HTML parsing cannot be done without at least two stages: tokenization and tree building. <br>  As for the terms: "strict", "does not meet the specifications", "light", "html 4" and the like ... I am sure that all these terms can be safely replaced with one: "does not handle correctly."  All this is absurd. <br><br><br>  <b>How and what will we compare?</b> <br><br>  And here is the most interesting.  Far from everyone can bear the proud title of html parser; moreover, even those who call themselves html identifiers are, in fact, not so. <br>  Having put all the parsers on the table, I immediately had a question - who should I compare with whom? <br><br>  And we will compare the correct parsers: myhtml, html5lib, html5ever, gumbo. <br><br>  They correspond to the latest specification, and their result will coincide with what we can see in modern browsers. <br>  Wrong parsers (do not meet the specifications) can vary greatly in speed / memory, but more than that, they simply handle the document incorrectly. <br>  No excuses, like "parser for html 4", will not be taken into account.  The world is constantly changing, and you have to keep up with it. <br><br>  It is worth noting that html5ever is not quite the right parser.  The authors write that he does not pass all html5lin-test-tree-builder tests, that is, tests for the correctness of tree construction.  He got into the correct parsers for trying to be correct. <br>  Also, at the time of writing this article, html5lib does not correctly build a tree for some HTML format.  But these are all the bugs that I hope the authors will fix. <br><br>  Let's measure time / memory for 466 html files - TOP500 alexa.  466, not 500 because not all sites work and not all give away their content. <br><br>  For each page, a fork with stages will be created: <br><ol><li>  Full parser initialization </li><li>  Single page parsing </li><li>  Resource Release </li></ol><br>  Tech will also be a test "from life" - to drive away all the pages, if possible, one object.  It will all happen consistently. <br><br>  <b>To the tests!</b> <br><br>  We have reached the tests: myhtml, html5ever, gumbo. <br><br>  Unfortunately, html5lib took off from testing.  The preliminary run showed that it was noticeably slower than the others.  It makes no sense to compare it, it is written in python and it is slow, very slow. <br><br>  MyHTML and Gumbo are written in C. html5ever - this is Rust.  Growing up I am not strong, not yet strong, and therefore I asked Alexey Voznyuk to help me.  Alexey agreed (respect and respect) and made a wrapper for testing the parser. <br><br>  The overall result of the runtime tests: <br> <a href=""><img src="https://habrastorage.org/files/dd6/058/ef6/dd6058ef62d044699bc342a970df0754.png"></a> <br><br>  The total result of tests of occupied resources: <br> <a href=""><img src="https://habrastorage.org/files/eba/016/4f2/eba0164f22f649dcb8d2f433deb256d4.png"><br></a> <br><br><div class="spoiler">  <b class="spoiler_title">Runtime test results broken down by 100</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/3ba/bee/8ca/3babee8ca9a14965a55d3d2385503104.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/6f6/2ac/e2a/6f62ace2a2974611ab1a924c812a0341.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/fa9/010/3e9/fa90103e93484c969950df1fbfa6110a.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/df2/297/c9f/df2297c9f2a6405fbc3958b31d1e519a.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/4cd/51d/637/4cd51d637a62408a9a0ea6a12d0efcb9.png"><br></a> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">The results of tests of occupied resources divided by 100</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/d56/fdc/2b3/d56fdc2b36504344823ca878660d9ce3.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/c5f/013/f0d/c5f013f0d42047cb80e68faf56453e92.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/191/ecd/3b6/191ecd3b6681410aa5222d4451cc5780.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/90d/9c0/330/90d9c03304ab4779bdf0f97e3030d2e8.png"><br></a> <br> <a href=""><img src="https://habrastorage.org/files/121/95b/804/12195b80420945bba51e5909802b5bc7.png"><br></a> <br></div></div><br>  The result of tests "from life."  Run all (466) pages in one process: <br>  <i>myhtml</i> : <br><pre> <code class="hljs css">  : 0<span class="hljs-selector-class"><span class="hljs-selector-class">.50890</span></span>;   : 1052672;   : 32120832</code> </pre><br>  <i>gumbo</i> : <br><pre> <code class="hljs css">  : 6<span class="hljs-selector-class"><span class="hljs-selector-class">.12951</span></span>;   : 1052672;   : 29319168</code> </pre><br>  <i>html5ever</i> : <br><pre> <code class="hljs css">  : 4<span class="hljs-selector-class"><span class="hljs-selector-class">.50536</span></span>;   : 1052672;   : 30715904</code> </pre><br><br>  <b>Results</b> <br><br>  The undisputed leader in speed is myhtml.  gumbo is the memory leader, which is not surprising.  html5ever showed itself, to put it mildly, no way.  It is not fast and didn‚Äôt express itself in memory, and it can only be used from Rust. <br><br>  The ‚Äúlife‚Äù test showed that the differences in the memory are not significant, but in terms of speed, I would not hesitate to say that it is colossal. <br><br>  <b>What was used</b> <br><br>  Equipment: <br>  Intel¬Æ Core (TM) i7-3615QM CPU @ 2.30GHz <br>  8 GB 1600 MHz DDR3 <br><br>  Software: <br>  Darwin MBP-Alexander 15.3.0 Darwin Kernel Version 15.3.0: Thu Dec 10 18:40:58 PST 2015;  root: xnu-3248.30.4 ~ 1 / RELEASE_X86_64 x86_64 <br>  Apple LLVM version 7.0.2 (clang-700.1.81) <br>  Target: x86_64-apple-darwin15.3.0 <br>  Thread model: posix <br><br>  <b>Links</b> <br><br>  <a href="https://github.com/lexborisov/benchmark-html-persers">Benchmark code</a> <br>  <a href="https://github.com/lexborisov/benchmark-html-persers/tree/master/Results">Pictures and CSV</a> <br>  <a href="https://github.com/lexborisov/myhtml">myhtml</a> , <a href="https://github.com/google/gumbo-parser">gumbo</a> , <a href="https://github.com/servo/html5ever">html5ever</a> <br>  <a href="https://github.com/swizard0/html2html_lib">Strapping for html5event</a> from Alexey <br><br>  <b><i>Thanks for attention!</i></b> <br><br>  <b>PS by myhtml</b> <br><br>  Being the author of myhtml, it was morally difficult for me to do such testing.  But I tried to approach this matter with the utmost responsibility, and to work with each parser as with my own. </div><p>Source: <a href="https://habr.com/ru/post/279409/">https://habr.com/ru/post/279409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279395/index.html">Windows 2008 R2 on HP DL380 G4p</a></li>
<li><a href="../279397/index.html">Anatomy of document editors: a common code for online and offline versions of ONLYOFFICE editors</a></li>
<li><a href="../279403/index.html">Update KB3035583 can automatically update Windows 7 to Windows 10</a></li>
<li><a href="../279405/index.html">Register for the ‚ÄúEasy Cloud Protection of Corporate Network with Low Total Cost of Ownership‚Äù webinar</a></li>
<li><a href="../279407/index.html">Is Grounded in a 2D Platform: How to find out if a character is worth it?</a></li>
<li><a href="../279411/index.html">Sports betting fraud</a></li>
<li><a href="../279413/index.html">DI plugins in Magento 2</a></li>
<li><a href="../279417/index.html">JPoint Witnesses: What Makes a Programmer Special?</a></li>
<li><a href="../279419/index.html">Why I write my algorithms in 95% of cases, and I will continue to develop code bikes</a></li>
<li><a href="../279421/index.html">ECMA-262 standard (JavaScript) in pictures, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>