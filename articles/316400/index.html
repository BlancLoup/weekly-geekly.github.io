<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy OpenSource Puppet 4 with multiple puppet masters. Part I. Preparatory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Deploying OpenSource Puppet 4 with multiple Puppet masters. Part II. Puppet Masters Setup 
 ‚Üí Deploying OpenSource Puppet 4 with multiple Puppet mas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy OpenSource Puppet 4 with multiple puppet masters. Part I. Preparatory</h1><div class="post__text post__text-html js-mediator-article">  ‚Üí <a href="https://habrahabr.ru/post/316482/">Deploying OpenSource Puppet 4 with multiple Puppet masters.</a>  <a href="https://habrahabr.ru/post/316482/">Part II.</a>  <a href="https://habrahabr.ru/post/316482/">Puppet Masters Setup</a> <br>  ‚Üí <a href="https://habrahabr.ru/post/316486/">Deploying OpenSource Puppet 4 with multiple Puppet masters.</a>  <a href="https://habrahabr.ru/post/316486/">Part III.</a>  <a href="https://habrahabr.ru/post/316486/">Setting up puppet-db with Puppet</a> <br><br><h2>  Foreword </h2><br>  My experience using puppet.  Before writing this article, I worked with Open Source Puppet version 3 in a stand alone configuration, and used it to manage several hundred hosts.  But the time has come to grow: the number of managed hosts has gone beyond a thousand, and threatens to pass several thousand in the near future.  It was decided to distribute the load and increase resiliency to deploy Open Source Puppet version 4 with multiple Puppet Master servers and a separate PuppetDB server with postgresql.  And also use a git repository on a git server for storing environments with configurations of end hosts. <br><br><h2>  Overview of articles on habrahabr on puppet deployment </h2><br>  At first, I would like to offer a brief overview of existing articles on habrahabr. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://habrahabr.ru/post/229867/">Setting up a modern Puppet server from scratch</a> <br>  The translation of the article ‚ÄúSetup of modern Puppet of the server from scratch‚Äù made by <a href="https://habrahabr.ru/users/grundic/" class="user_link">grundic</a> , the original of which I managed to find only in the Google cache.  This article was taken by me as a basis for the preparation of the publication.  The details described in the original article ‚ÄúSetup of the server from scratch‚Äù, as well as the additions of the translator in its translation, have already become a little out of date.  This, as well as the desire to share a description of additional subtleties, prompted me to write my own article. <br><a name="habracut"></a><br>  <a href="https://habrahabr.ru/post/278163/">Deployment Option for Linux Systems Based on Puppet 4. Part III: Installing Puppet Server (cfpuppetserver)</a> <br>  The article is part of a cycle where the author <a href="https://habrahabr.ru/users/andvgal/" class="user_link">andvgal</a> describes the deployment of an entire infrastructure.  In the article, the author proposes to automate the installation of puppet using the cfpuppetserver package developed by the author of the article.  Very interesting, but difficult for the novice puppeteer. <br><br>  <a href="https://habrahabr.ru/company/badoo/blog/157023/">Puppet under load</a> <br>  An interesting article from the company <a href="https://habrahabr.ru/users/badoo/" class="user_link">Badoo</a> , containing a large number of schemes that reveal the mechanisms of Puppet 3. <br><br>  <a href="https://habrahabr.ru/post/163811/">How to become a puppeteer or Puppet for beginners</a> <br>  The article starts well, gives basic concepts about Puppet.  At the end of the article, the author <a href="https://habrahabr.ru/users/aecktann/" class="user_link">Aecktann</a> promises to continue, which, unfortunately, has not appeared in 4 years. <br><br>  Puppet, configuration management system.  Article in two parts: <a href="https://habrahabr.ru/post/67471/">Part I</a> , <a href="https://habrahabr.ru/post/68532/">Part II</a> <br>  The author of <a href="https://habrahabr.ru/users/spanasik/" class="user_link">spanasik</a> gives basic concepts about Puppet, and also describes the installation of stand alone puppet master without other components. <br><br><h1>  Introduction </h1><br>  General information about Puppet.  Puppet agents are installed on managed nodes, which are called nodes.  At certain time intervals (the default is 30 minutes), puppet agents connect to Puppet servers, transmit data about the nodes (facts) on which they are installed;  receive configuration descriptions for managed nodes, as well as the necessary data and tools for configuring configurations from servers. <br><br>  Configurations for managed nodes are stored on the puppet servers as text files.  Such files are called manifests.  Manifestos unite in environments.  Each <a href="https://docs.puppet.com/puppet/4.8/reference/environments.html">puppet environment</a> contains its own set of manifests.  The default environment is called production.  For testing, a developmement environment is usually used.  Each managed node can only be in one environment at a time. <br><br>  Environments containing text files with puppet manifests are usually stored in a git repository that can be hosted on a git server.  Each environment will correspond to a branch (branch) in the git-repository. <br><br>  To synchronize the environments on each puppet server, the R10k robot is used, which is launched using a post-receive hook in the git repository.  Read more about this robot <a href="http://somethingsinistral.net/blog/rethinking-puppet-deployment/">in its creator's blog</a> . <br><br>  The data transferred by puppet agents to puppet servers can be stored locally on servers as text files, or in the PuppetDB database.  PuppetDB allows you to use the advanced features of puppet, and can also be used in third-party applications. <br><br>  To extend the basic capabilities of Puppet, various <a href="https://docs.puppet.com/puppet/4.8/reference/modules_fundamentals.html">modules</a> are used that can be downloaded from <a href="https://forge.puppet.com/">Puppet Forge</a> , GitHub, or another source, and also create them yourself. <br><br><h2>  Server names </h2><br>  <b>puppetmaster.example.com</b> is the name of the cluster. <br>  <b>puppet-master01.example.com</b> - Puppet Master node 1, also the <a href="https://docs.puppet.com/puppetserver/latest/services_master_puppetserver.html">Certificate Authority Service</a> will work on it. <br>  <b>puppet-master02.example.com</b> - Puppet Master node 2. <br>  Accordingly, you can continue puppet-masterN.example.com - Puppet Master node N. All settings made for puppet-master02.example.com are suitable for subsequent nodes. <br>  <b>puppet-db.example.com</b> - PuppetDB server, postgresql server. <br>  <b>sgl-git.example.com</b> is a git server for storing a git repository that contains environments with puppet manifests. <br><br><h2>  About OS on servers </h2><br>  Ubuntu 16.04 OS is installed on all servers. <br><br><h2>  Users </h2><br>  <b>aspetrenko</b> is an <b>admin</b> user with permissions to execute sudo (present on all servers). <br>  <b>gitolite3</b> is a user on whose behalf the gitolite3 git server is running (on the sgl-git server). <br>  <b>r10k</b> is a user on whose behalf the r10k robot is running (on puppet-master servers). <br><br><h1>  DNS setup </h1><br>  Options for configuring DNS servers are described <a href="https://docs.puppet.com/guides/scaling_multiple_masters.html">in the corresponding Puppet section of the documentation</a> .  In my case, the approach described <a href="https://docs.puppet.com/guides/scaling_multiple_masters.html">in the section on Round-Robin DNS is used</a> .  Although it does not matter. <br><br><h1>  Ssh authorization using keys </h1><br>  <b>aspetrenko, aspetrenko.pub</b> - private and public administrator key. <br>  <b>gitolite3, gitolite3.pub</b> - user keys gitolite3.  The public key of gitolite3.pub needs to be placed in the list of authorized keys (~ / ssh / authorized_keys) of the user r10k on each puppet-master server so that the user gitolite3 can log in and start updating the environments. <br>  <b>r10k, r10k.pub</b> - user r10k keys.  The public key r10k.pub must be placed in the gitolite3 administrative repository (the keydir directory in the gitolite-admin repository) so that the r10k robot can log in to the git server and pick up the environments from the git repository to update the environments on the local file system.  Keys can be created on any computer with ssh-keygen.  Keys must be created without password protection so that authorization can occur without human intervention.  Create administrator keys, and copy the public key to sgl-git: <br><br><pre><code class="bash hljs">aspetrenko@aspetrenko-pc:~$ ssh-keygen -t rsa -f ~/.ssh/aspetrenko aspetrenko@aspetrenko-pc:~$ scp ~/.ssh/aspetrenko.pub aspetrenko@sgl-git:/home/aspetrenko/.ssh/</code> </pre> <br>  It will play the role of the gitolite3 admin key.  Create a user for r10k on puppet-master01 and puppet-master02 servers: <br><br><pre> <code class="bash hljs">sudo useradd -m -s /bin/bash r10k</code> </pre> <br>  And give the user r10k a password: <br><br><pre> <code class="bash hljs">sudo passwd r10k</code> </pre> <br>  The password will be more convenient during the installation process.  Then the password entry can be disabled, and leave authorization only by key. <br><br>  Create the user r10k keys on puppet-master01, and copy the private key to the puppet-master02 server: <br><br><pre> <code class="bash hljs">aspetrenko@puppet-master01:~$ sudo su - r10k r10k@puppet-master01:~$ ssh-keygen -t rsa -f ~/.ssh/r10k r10k@puppet-master01:~$ scp /home/r10k/.ssh/r10k r10k@puppet-master02:/home/r10k/.ssh/</code> </pre> <br>  During the installation of the gitolite3 git server, a user with the same name gitolite3 will be automatically created.  You will need to add this user's public key to the list of trusted keys of user r10k on puppet-master01 and puppet-master02 servers, so that gitolite3 can use post-receive hook in the puppet-environments repository to launch R10k robot. <br><br>  More information about the automation with the use of keys can be found, for example, <a href="https://habrahabr.ru/post/122445/">here</a> .  As a result, it should turn out as in the diagram below. <br><br> <a href=""><img src="https://habrastorage.org/files/697/2be/afc/6972beafc6b740059b5913cf858350ec.png"></a> <br><br><h1>  Installing and configuring the git-server </h1><br>  More information about gitolite can be read <a href="http://gitolite.com/gitolite/gitolite.html">in the official documentation</a> or <a href="https://habrahabr.ru/post/136815/">on the habr</a> . <br><br><h2>  Install gitolite3 on sgl-git </h2><br>  Install git and perl: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo apt install git perl</code> </pre> <br>  Run the gitolite installation from the Ubuntu repository: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo apt install gitolite3</code> </pre> <br>  During the installation, we specify the absolute path to the public key of the administrator aspetrenko.pub.  If you make a mistake, you can specify the path to the administrator key as follows from the system user gitolite3: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo su - gitolite3 gitolite3@sgl-git:~$ <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/bin/gitolite setup -pk /home/aspetrenko/.ssh/aspetrenko.pub</code> </pre> <br>  The key will be saved in the gitolite-admin administrative repository in the keydir directory as admin.pub. <br><br>  Gitolite3 stores repositories in its home directory / var / lib / gitolite3 / repositories /.  If you want to store repositories in another place, like me, you can transfer them as follows: <br>  Add to the /etc/gitolite3/gitolite.rc file in the "% RC = (" <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Custom path for repos GL_REPO_BASE =&gt; "/media/data/repositories",</span></span></code> </pre> <br>  And move the repositories to a new location: <br><br><pre> <code class="bash hljs">sudo mv /var/lib/gitolite3/repositories /media/data/</code> </pre> <br><h2>  Configure gitolite3 </h2><br>  You cannot directly edit git repositories in the / var / lib / gitolite3 / repositories directory.  On the aspetrenko-pc computer, from where we will work with repositories on our server, we specify the ssh authorization settings for sgl-git in the ~ / .ssh / config file: <br><br><pre> <code class="bash hljs">host sgl-git.example.com HostName sgl-git.example.com IdentityFile ~/.ssh/aspetrenko User gitolite3</code> </pre> <br>  where aspetrenko is the private admin key.  We clone the administrative repository into our home directory: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~$ mkdir sgl-git aspetrenko@aspetrenko-pc:~$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> sgl-git aspetrenko@aspetrenko-pc:~/sgl-git$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> gitolite3@sgl-git.example.com:gitolite-admin</code> </pre> <br>  If the server asks for a password, then access using ssh keys was configured incorrectly.  As a result, we get: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/gitolite-admin$ tree . ‚îú‚îÄ‚îÄ conf ‚îÇ  ‚îî‚îÄ‚îÄ gitolite.conf ‚îî‚îÄ‚îÄ keydir ‚îî‚îÄ‚îÄ admin.pub 2 directories, 2 files</code> </pre> <br>  Repository access settings are located in gitolite-admin / conf / gitolite.conf <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/gitolite-admin$ cat conf/gitolite.conf repo gitolite-admin RW+ = admin repo testing RW+ = @all</code> </pre> <br>  admin is the user whose key was specified when setting up gitolite3: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git$ cat gitolite-admin/keydir/admin.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIFC/2v1S4WvvITHAXCuVle7dLZz0zL7z4dAWXvmMcqCLepfGI1suDBby6PW04tVwHvniAW5B/5HbZ2Fr7zCoeMrhGE5Z76/DBfidhO15CZbAMPOcs3X7aP4aZFK2GfiXCt7/yunP6f3zp3i6KbsZhcSeeUmmkeQFwccJsstVJbj9ciWHrLN/UDHwT5OTBVFKBpRZGM5pT6xzvWaPNN4IRlk5AN4ClrhWf13 aspetrenko@aspetrenko-pc</code> </pre> <br>  Put the public key of user r10k in the gitolite3 administrative repository: <br><br><pre> <code class="bash hljs">r10k@puppet-master01:~$ scp /home/r10k/.ssh/r10k.pub aspetrenko@aspetrenko-pc:/home/aspetrenko/sgl-git/gitolite-admin/keydir</code> </pre> <br>  Add the r10k.pub key to git: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/gitolite-admin$ git add keydir/r10k.pub</code> </pre> <br>  Create a repository for storing puppet environments. To do this, add the following lines to gitolite-admin / conf / gitolite.conf on aspetrenko-pc: <br><br><pre> <code class="bash hljs">repo puppet-environments RW+ = admin R = r10k</code> </pre> <br>  Fix the changes in git: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/gitolite-admin$ git commit -a -m <span class="hljs-string"><span class="hljs-string">"Add puppet-environments repo"</span></span> [master 585326d] Add puppet-environments repo 1 file changed, 3 insertions(+)</code> </pre> <br>  And send it all to sgl-git: <br><br><pre> <code class="bash hljs">aspetrenko@aspetrenko-pc:~/sgl-git/gitolite-admin$ git push Counting objects: 7, <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Delta compression using up to 2 threads. Compressing objects: 100% (3/3), <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Writing objects: 100% (4/4), 411 bytes | 0 bytes/s, <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Total 4 (delta 0), reused 0 (delta 0) remote: Initialized empty Git repository <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /media/data/repositories/puppet-environments.git/ To gitolite3@sgl-git:gitolite-admin 7946dea..585326d master -&gt; master</code> </pre> <br>  Gitolite3 using hooks will create a new empty sgl-git repository: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo ls /media/data/repositories/puppet-environments.git branches config gl-conf HEAD hooks info objects refs</code> </pre> <br>  Do not forget to create keys for the user gitolite3, and add the public key to the list of trusted keys of the user r10k on each server puppet-master01 and puppet-master02: <br><br><pre> <code class="bash hljs">aspetrenko@sgl-git:~$ sudo su - gitolite3 gitolite3@sgl-git:~$ ssh-keygen -t rsa -f ~/.ssh/gitolite3 gitolite3@sgl-git:~$ ssh-copy-id -i ~/.ssh/gitolite3.pub r10k@puppet-master01 gitolite3@sgl-git:~$ ssh-copy-id -i ~/.ssh/gitolite3.pub r10k@puppet-master02</code> </pre> <br>  The private key gitolite3 should appear in the /var/lib/gitolite3/.ssh directory. <br><br>  <a href="https://habrahabr.ru/post/316482/">Deploy OpenSource Puppet 4 with multiple puppet masters.</a>  <a href="https://habrahabr.ru/post/316482/">Part II.</a>  <a href="https://habrahabr.ru/post/316482/">Puppet Masters Setup</a> </div><p>Source: <a href="https://habr.com/ru/post/316400/">https://habr.com/ru/post/316400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316386/index.html">Increase attack costs with Immutable Infrastructure</a></li>
<li><a href="../316388/index.html">Never take a counter offer</a></li>
<li><a href="../316392/index.html">Why not Assets Pipeline?</a></li>
<li><a href="../316394/index.html">5 reasons not to use your personal account in freelance</a></li>
<li><a href="../316396/index.html">Ukrainian company has developed a private cloud for Silicon Valley startups</a></li>
<li><a href="../316402/index.html">The best way to leave the market is not to try to enter other markets.</a></li>
<li><a href="../316404/index.html">How to write notes if you are a programmer</a></li>
<li><a href="../316406/index.html">"Great leveler" or a way to solve the problem of leveling</a></li>
<li><a href="../316408/index.html">As I recalled the school geometry course</a></li>
<li><a href="../316412/index.html">Remote backup of VMware cloud resources via self-service portal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>